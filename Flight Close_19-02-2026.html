<html lang="en"><head>
    <meta charset="UTF-8">
   <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Flight Tracker 2026</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    <!-- html2pdf.js for iPad PDF generation -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <script id="embedded-data-script">
    const EMBEDDED_DATA = {"flights":[{"id":1771399212973,"flightNumber":"JQ719","destination":"HBA","departureTime":"06:00","originalDepartureTime":"06:00","isDelayed":false,"isTurnaround":false,"inboundFlight":"","pax":222,"manualStatus":null,"cancelReason":null,"extensionStartTime":null,"extensionDuration":null,"isAdhoc":false,"isReadOnly":false},{"id":1771399221205,"flightNumber":"JQ501","destination":"MEL","departureTime":"06:00","originalDepartureTime":"06:00","isDelayed":false,"isTurnaround":false,"inboundFlight":"","pax":179,"manualStatus":null,"cancelReason":null,"extensionStartTime":null,"extensionDuration":null,"isAdhoc":false,"isReadOnly":false},{"id":1771399214173,"flightNumber":"JQ603","destination":"AVV","departureTime":"06:00","originalDepartureTime":"06:00","isDelayed":false,"isTurnaround":false,"inboundFlight":"","pax":177,"manualStatus":null,"cancelReason":null,"extensionStartTime":null,"extensionDuration":null,"isAdhoc":false,"isReadOnly":false},{"id":1771399218883,"flightNumber":"JQ400","destination":"OOL","departureTime":"06:10","originalDepartureTime":"06:10","isDelayed":false,"isTurnaround":false,"inboundFlight":"","pax":184,"manualStatus":null,"cancelReason":null,"extensionStartTime":null,"extensionDuration":null,"isAdhoc":false,"isReadOnly":false},{"id":1771399212626,"flightNumber":"JQ810","destination":"BNE","departureTime":"06:20","originalDepartureTime":"06:20","isDelayed":false,"isTurnaround":false,"inboundFlight":"","pax":183,"manualStatus":null,"cancelReason":null,"extensionStartTime":null,"extensionDuration":null,"isAdhoc":false,"isReadOnly":false},{"id":1771399216860,"flightNumber":"JQ950","destination":"CNS","departureTime":"06:20","originalDepartureTime":"06:20","isDelayed":false,"isTurnaround":false,"inboundFlight":"","pax":209,"manualStatus":null,"cancelReason":null,"extensionStartTime":null,"extensionDuration":null,"isAdhoc":false,"isReadOnly":false},{"id":1771399215475,"flightNumber":"JQ912","destination":"TSV","departureTime":"06:40","originalDepartureTime":"06:40","isDelayed":false,"isTurnaround":false,"inboundFlight":"","pax":144,"manualStatus":null,"cancelReason":null,"extensionStartTime":null,"extensionDuration":null,"isAdhoc":false,"isReadOnly":false},{"id":1771399221965,"flightNumber":"JQ760","destination":"ADL","departureTime":"07:00","originalDepartureTime":"07:00","isDelayed":false,"isTurnaround":true,"inboundFlight":"JQ671","pax":205,"manualStatus":null,"cancelReason":null,"extensionStartTime":null,"extensionDuration":null,"isAdhoc":false,"isReadOnly":false},{"id":1771399217691,"flightNumber":"JQ505","destination":"MEL","departureTime":"07:00","originalDepartureTime":"07:00","isDelayed":false,"isTurnaround":false,"inboundFlight":"","pax":220,"manualStatus":null,"cancelReason":null,"extensionStartTime":null,"extensionDuration":null,"isAdhoc":false,"isReadOnly":false},{"id":1771399215368,"flightNumber":"JQ784","destination":"MCY","departureTime":"07:05","originalDepartureTime":"07:05","isDelayed":false,"isTurnaround":false,"inboundFlight":"","pax":217,"manualStatus":null,"cancelReason":null,"extensionStartTime":null,"extensionDuration":null,"isAdhoc":false,"isReadOnly":false},{"id":1771399219947,"flightNumber":"JQ402","destination":"OOL","departureTime":"07:20","originalDepartureTime":"07:20","isDelayed":false,"isTurnaround":false,"inboundFlight":"","pax":194,"manualStatus":null,"cancelReason":null,"extensionStartTime":null,"extensionDuration":null,"isAdhoc":false,"isReadOnly":false},{"id":1771399214401,"flightNumber":"JQ456","destination":"BNK","departureTime":"07:20","originalDepartureTime":"07:20","isDelayed":false,"isTurnaround":true,"inboundFlight":"JQ989","pax":180,"manualStatus":null,"cancelReason":null,"extensionStartTime":null,"extensionDuration":null,"isAdhoc":false,"isReadOnly":false},{"id":1771399218759,"flightNumber":"JQ507","destination":"MEL","departureTime":"08:10","originalDepartureTime":"08:10","isDelayed":false,"isTurnaround":false,"inboundFlight":"","pax":174,"manualStatus":null,"cancelReason":null,"extensionStartTime":null,"extensionDuration":null,"isAdhoc":false,"isReadOnly":false},{"id":1771399221903,"flightNumber":"JQ605","destination":"AVV","departureTime":"08:10","originalDepartureTime":"08:10","isDelayed":false,"isTurnaround":true,"inboundFlight":"JQ602","pax":175,"manualStatus":null,"cancelReason":null,"extensionStartTime":null,"extensionDuration":null,"isAdhoc":false,"isReadOnly":false},{"id":1771399213882,"flightNumber":"JQ404","destination":"OOL","departureTime":"09:10","originalDepartureTime":"09:10","isDelayed":false,"isTurnaround":true,"inboundFlight":"JQ401","pax":181,"manualStatus":null,"cancelReason":null,"extensionStartTime":null,"extensionDuration":null,"isAdhoc":false,"isReadOnly":false},{"id":1771399214549,"flightNumber":"JQ509","destination":"MEL","departureTime":"09:15","originalDepartureTime":"09:15","isDelayed":false,"isTurnaround":true,"inboundFlight":"JQ502","pax":168,"manualStatus":null,"cancelReason":null,"extensionStartTime":null,"extensionDuration":null,"isAdhoc":false,"isReadOnly":false},{"id":1771399220677,"flightNumber":"JQ812","destination":"BNE","departureTime":"09:35","originalDepartureTime":"09:35","isDelayed":false,"isTurnaround":true,"inboundFlight":"JQ811","pax":178,"manualStatus":null,"cancelReason":null,"extensionStartTime":null,"extensionDuration":null,"isAdhoc":false,"isReadOnly":false},{"id":1771399216498,"flightNumber":"JQ511","destination":"MEL","departureTime":"09:40","originalDepartureTime":"09:40","isDelayed":false,"isTurnaround":true,"inboundFlight":"JQ504","pax":169,"manualStatus":null,"cancelReason":null,"extensionStartTime":null,"extensionDuration":null,"isAdhoc":false,"isReadOnly":false},{"id":1771399219988,"flightNumber":"JQ406","destination":"OOL","departureTime":"10:15","originalDepartureTime":"10:15","isDelayed":false,"isTurnaround":true,"inboundFlight":"JQ403","pax":180,"manualStatus":null,"cancelReason":null,"extensionStartTime":null,"extensionDuration":null,"isAdhoc":false,"isReadOnly":false},{"id":1771399214267,"flightNumber":"JQ458","destination":"BNK","departureTime":"10:20","originalDepartureTime":"10:20","isDelayed":false,"isTurnaround":true,"inboundFlight":"JQ604","pax":176,"manualStatus":null,"cancelReason":null,"extensionStartTime":null,"extensionDuration":null,"isAdhoc":false,"isReadOnly":false},{"id":1771399221851,"flightNumber":"JQ786","destination":"MCY","departureTime":"10:50","originalDepartureTime":"10:50","isDelayed":false,"isTurnaround":true,"inboundFlight":"JQ813","pax":178,"manualStatus":null,"cancelReason":null,"extensionStartTime":null,"extensionDuration":null,"isAdhoc":false,"isReadOnly":false},{"id":1771399214168,"flightNumber":"JQ513","destination":"MEL","departureTime":"10:50","originalDepartureTime":"10:50","isDelayed":false,"isTurnaround":false,"inboundFlight":"","pax":214,"manualStatus":null,"cancelReason":null,"extensionStartTime":null,"extensionDuration":null,"isAdhoc":false,"isReadOnly":false},{"id":1771399221556,"flightNumber":"JQ762","destination":"ADL","departureTime":"11:00","originalDepartureTime":"11:00","isDelayed":false,"isTurnaround":true,"inboundFlight":"JQ759","pax":190,"manualStatus":null,"cancelReason":null,"extensionStartTime":null,"extensionDuration":null,"isAdhoc":false,"isReadOnly":false},{"id":1771399220056,"flightNumber":"JQ840","destination":"PPP","departureTime":"11:40","originalDepartureTime":"11:40","isDelayed":false,"isTurnaround":true,"inboundFlight":"JQ510","pax":231,"manualStatus":null,"cancelReason":null,"extensionStartTime":null,"extensionDuration":null,"isAdhoc":false,"isReadOnly":false},{"id":1771399214423,"flightNumber":"JQ721","destination":"HBA","departureTime":"11:45","originalDepartureTime":"11:45","isDelayed":false,"isTurnaround":true,"inboundFlight":"JQ785","pax":188,"manualStatus":null,"cancelReason":null,"extensionStartTime":null,"extensionDuration":null,"isAdhoc":false,"isReadOnly":false},{"id":1771399220160,"flightNumber":"JQ952","destination":"CNS","departureTime":"11:45","originalDepartureTime":"11:45","isDelayed":false,"isTurnaround":true,"inboundFlight":"JQ951","pax":176,"manualStatus":null,"cancelReason":null,"extensionStartTime":null,"extensionDuration":null,"isAdhoc":false,"isReadOnly":false},{"id":1771399217051,"flightNumber":"JQ898","destination":"BQB","departureTime":"11:50","originalDepartureTime":"11:50","isDelayed":false,"isTurnaround":true,"inboundFlight":"JQ7990","pax":175,"manualStatus":null,"cancelReason":null,"extensionStartTime":null,"extensionDuration":null,"isAdhoc":false,"isReadOnly":false},{"id":1771399218245,"flightNumber":"JQ986","destination":"PER","departureTime":"11:55","originalDepartureTime":"11:55","isDelayed":false,"isTurnaround":true,"inboundFlight":"JQ718","pax":217,"manualStatus":null,"cancelReason":null,"extensionStartTime":null,"extensionDuration":null,"isAdhoc":false,"isReadOnly":false},{"id":1771399217366,"flightNumber":"JQ515","destination":"MEL","departureTime":"12:30","originalDepartureTime":"12:30","isDelayed":false,"isTurnaround":true,"inboundFlight":"JQ761","pax":215,"manualStatus":null,"cancelReason":null,"extensionStartTime":null,"extensionDuration":null,"isAdhoc":false,"isReadOnly":false},{"id":1771399218454,"flightNumber":"JQ890","destination":"HVB","departureTime":"12:35","originalDepartureTime":"12:35","isDelayed":false,"isTurnaround":true,"inboundFlight":"JQ608","pax":161,"manualStatus":null,"cancelReason":null,"extensionStartTime":null,"extensionDuration":null,"isAdhoc":false,"isReadOnly":false},{"id":1771399215788,"flightNumber":"JQ609","destination":"AVV","departureTime":"12:35","originalDepartureTime":"12:35","isDelayed":false,"isTurnaround":false,"inboundFlight":"","pax":164,"manualStatus":null,"cancelReason":null,"extensionStartTime":null,"extensionDuration":null,"isAdhoc":false,"isReadOnly":false},{"id":1771399218793,"flightNumber":"JQ517","destination":"MEL","departureTime":"13:15","originalDepartureTime":"13:15","isDelayed":false,"isTurnaround":true,"inboundFlight":"JQ512","pax":168,"manualStatus":null,"cancelReason":null,"extensionStartTime":null,"extensionDuration":null,"isAdhoc":false,"isReadOnly":false},{"id":1771399216534,"flightNumber":"JQ788","destination":"MCY","departureTime":"13:20","originalDepartureTime":"13:20","isDelayed":false,"isTurnaround":true,"inboundFlight":"JQ913","pax":161,"manualStatus":null,"cancelReason":null,"extensionStartTime":null,"extensionDuration":null,"isAdhoc":false,"isReadOnly":false},{"id":1771399220609,"flightNumber":"JQ816","destination":"BNE","departureTime":"13:50","originalDepartureTime":"13:50","isDelayed":false,"isTurnaround":true,"inboundFlight":"JQ953","pax":229,"manualStatus":null,"cancelReason":null,"extensionStartTime":null,"extensionDuration":null,"isAdhoc":false,"isReadOnly":false},{"id":1771399213366,"flightNumber":"JQ460","destination":"BNK","departureTime":"14:40","originalDepartureTime":"14:40","isDelayed":false,"isTurnaround":true,"inboundFlight":"JQ459","pax":178,"manualStatus":null,"cancelReason":null,"extensionStartTime":null,"extensionDuration":null,"isAdhoc":false,"isReadOnly":false},{"id":1771399215146,"flightNumber":"JQ412","destination":"OOL","departureTime":"14:50","originalDepartureTime":"14:50","isDelayed":false,"isTurnaround":true,"inboundFlight":"JQ409","pax":174,"manualStatus":null,"cancelReason":null,"extensionStartTime":null,"extensionDuration":null,"isAdhoc":false,"isReadOnly":false},{"id":1771399213079,"flightNumber":"JQ521","destination":"MEL","departureTime":"15:10","originalDepartureTime":"15:10","isDelayed":false,"isTurnaround":false,"inboundFlight":"","pax":173,"manualStatus":null,"cancelReason":null,"extensionStartTime":null,"extensionDuration":null,"isAdhoc":false,"isReadOnly":false},{"id":1771399213790,"flightNumber":"JQ954","destination":"CNS","departureTime":"15:25","originalDepartureTime":"15:25","isDelayed":false,"isTurnaround":true,"inboundFlight":"JQ787","pax":167,"manualStatus":null,"cancelReason":null,"extensionStartTime":null,"extensionDuration":null,"isAdhoc":false,"isReadOnly":false},{"id":1771399219331,"flightNumber":"JQ525","destination":"MEL","departureTime":"16:25","originalDepartureTime":"16:25","isDelayed":false,"isTurnaround":true,"inboundFlight":"JQ518","pax":175,"manualStatus":null,"cancelReason":null,"extensionStartTime":null,"extensionDuration":null,"isAdhoc":false,"isReadOnly":false},{"id":1771399215718,"flightNumber":"JQ820","destination":"BNE","departureTime":"17:00","originalDepartureTime":"17:00","isDelayed":false,"isTurnaround":true,"inboundFlight":"JQ819","pax":217,"manualStatus":null,"cancelReason":null,"extensionStartTime":null,"extensionDuration":null,"isAdhoc":false,"isReadOnly":false},{"id":1771399217865,"flightNumber":"JQ527","destination":"MEL","departureTime":"17:00","originalDepartureTime":"17:00","isDelayed":false,"isTurnaround":true,"inboundFlight":"JQ610","pax":167,"manualStatus":null,"cancelReason":null,"extensionStartTime":null,"extensionDuration":null,"isAdhoc":false,"isReadOnly":false},{"id":1771399217154,"flightNumber":"JQ766","destination":"ADL","departureTime":"17:25","originalDepartureTime":"17:25","isDelayed":false,"isTurnaround":true,"inboundFlight":"JQ720","pax":210,"manualStatus":null,"cancelReason":null,"extensionStartTime":null,"extensionDuration":null,"isAdhoc":false,"isReadOnly":false},{"id":1771399217792,"flightNumber":"JQ529","destination":"MEL","departureTime":"17:30","originalDepartureTime":"17:30","isDelayed":false,"isTurnaround":true,"inboundFlight":"JQ522","pax":171,"manualStatus":null,"cancelReason":null,"extensionStartTime":null,"extensionDuration":null,"isAdhoc":false,"isReadOnly":false},{"id":1771399218986,"flightNumber":"JQ531","destination":"MEL","departureTime":"18:00","originalDepartureTime":"18:00","isDelayed":false,"isTurnaround":true,"inboundFlight":"JQ841","pax":206,"manualStatus":null,"cancelReason":null,"extensionStartTime":null,"extensionDuration":null,"isAdhoc":false,"isReadOnly":false},{"id":1771399215266,"flightNumber":"JQ749","destination":"LST","departureTime":"18:05","originalDepartureTime":"18:05","isDelayed":false,"isTurnaround":true,"inboundFlight":"JQ789","pax":178,"manualStatus":null,"cancelReason":null,"extensionStartTime":null,"extensionDuration":null,"isAdhoc":false,"isReadOnly":false},{"id":1771399221976,"flightNumber":"JQ822","destination":"BNE","departureTime":"18:25","originalDepartureTime":"18:25","isDelayed":false,"isTurnaround":true,"inboundFlight":"JQ821","pax":215,"manualStatus":null,"cancelReason":null,"extensionStartTime":null,"extensionDuration":null,"isAdhoc":false,"isReadOnly":false},{"id":1771399218372,"flightNumber":"JQ533","destination":"MEL","departureTime":"18:30","originalDepartureTime":"18:30","isDelayed":false,"isTurnaround":false,"inboundFlight":"","pax":169,"manualStatus":null,"cancelReason":null,"extensionStartTime":null,"extensionDuration":null,"isAdhoc":false,"isReadOnly":false},{"id":1771399215873,"flightNumber":"JQ611","destination":"AVV","departureTime":"18:45","originalDepartureTime":"18:45","isDelayed":false,"isTurnaround":true,"inboundFlight":"JQ461","pax":186,"manualStatus":null,"cancelReason":null,"extensionStartTime":null,"extensionDuration":null,"isAdhoc":false,"isReadOnly":false},{"id":1771399220789,"flightNumber":"JQ416","destination":"OOL","departureTime":"19:00","originalDepartureTime":"19:00","isDelayed":false,"isTurnaround":true,"inboundFlight":"JQ415","pax":186,"manualStatus":null,"cancelReason":null,"extensionStartTime":null,"extensionDuration":null,"isAdhoc":false,"isReadOnly":false},{"id":1771399214649,"flightNumber":"JQ824","destination":"BNE","departureTime":"19:25","originalDepartureTime":"19:25","isDelayed":false,"isTurnaround":true,"inboundFlight":"JQ823","pax":181,"manualStatus":null,"cancelReason":null,"extensionStartTime":null,"extensionDuration":null,"isAdhoc":false,"isReadOnly":false},{"id":1771399214283,"flightNumber":"JQ988","destination":"PER","departureTime":"19:50","originalDepartureTime":"19:50","isDelayed":false,"isTurnaround":false,"inboundFlight":"","pax":170,"manualStatus":null,"cancelReason":null,"extensionStartTime":null,"extensionDuration":null,"isAdhoc":false,"isReadOnly":false},{"id":1771399218716,"flightNumber":"JQ768","destination":"ADL","departureTime":"20:20","originalDepartureTime":"20:20","isDelayed":false,"isTurnaround":true,"inboundFlight":"JQ767","pax":159,"manualStatus":null,"cancelReason":null,"extensionStartTime":null,"extensionDuration":null,"isAdhoc":false,"isReadOnly":false},{"id":1771399217115,"flightNumber":"JQ535","destination":"MEL","departureTime":"20:25","originalDepartureTime":"20:25","isDelayed":false,"isTurnaround":true,"inboundFlight":"JQ528","pax":175,"manualStatus":null,"cancelReason":null,"extensionStartTime":null,"extensionDuration":null,"isAdhoc":false,"isReadOnly":false},{"id":1771399217921,"flightNumber":"JQ537","destination":"MEL","departureTime":"21:20","originalDepartureTime":"21:20","isDelayed":false,"isTurnaround":true,"inboundFlight":"JQ530","pax":222,"manualStatus":null,"cancelReason":null,"extensionStartTime":null,"extensionDuration":null,"isAdhoc":false,"isReadOnly":false},{"id":1771399217504,"flightNumber":"JQ826","destination":"BNE","departureTime":"21:30","originalDepartureTime":"21:30","isDelayed":false,"isTurnaround":true,"inboundFlight":"JQ825","pax":171,"manualStatus":null,"cancelReason":null,"extensionStartTime":null,"extensionDuration":null,"isAdhoc":false,"isReadOnly":false},{"id":1771399216770,"flightNumber":"JQ418","destination":"OOL","departureTime":"21:45","originalDepartureTime":"21:45","isDelayed":false,"isTurnaround":true,"inboundFlight":"JQ417","pax":174,"manualStatus":null,"cancelReason":null,"extensionStartTime":null,"extensionDuration":null,"isAdhoc":false,"isReadOnly":false},{"id":1771399214732,"flightNumber":"JQ613","destination":"AVV","departureTime":"21:45","originalDepartureTime":"21:45","isDelayed":false,"isTurnaround":true,"inboundFlight":"JQ532","pax":169,"manualStatus":null,"cancelReason":null,"extensionStartTime":null,"extensionDuration":null,"isAdhoc":false,"isReadOnly":false}],"comments":[],"zoneEComments":[],"deletedFlights":[],"earlyOpenMode":null,"earlyOpenFlightNumber":null,"earlyOpenHours":3,"flightDate":"2026-02-19","leadershipData":{},"savedTimestamp":1771399220532};
</script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            background: white;
            min-height: 100vh;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            color: #1f2937;
        }
        .container { max-width: 1400px; margin: 0 auto; padding: 1rem; }
        .header { text-align: center; padding: 1.5rem 0; margin-bottom: 1rem; position: relative; }
        .header h1 { font-size: 2.5rem; margin-bottom: 0.5rem; color: #000345; }
        .header p { color: #6b7280; font-size: 0.9rem; }
        .clock { font-size: 3.5rem; color: #FA5115; font-family: monospace; margin: 0.5rem 0; font-weight: bold; }
        /* ============================================
   CANCELLATION NOTIFICATION MODAL STYLES
   ============================================ */
.cancellation-notification-overlay {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0, 3, 69, 0.95);
    backdrop-filter: blur(10px);
    -webkit-backdrop-filter: blur(10px);
    z-index: 10003;
    display: flex;
    align-items: center;
    justify-content: center;
}

.cancellation-notification {
    position: relative;
    background: rgba(255, 255, 255, 0.98);
    backdrop-filter: blur(30px);
    -webkit-backdrop-filter: blur(30px);
    border: 3px solid #dc2626;
    border-radius: 1rem;
    box-shadow: 0 20px 60px rgba(220, 38, 38, 0.5);
    padding: 2rem;
    max-width: 500px;
    width: 90%;
    /* REMOVED: animation: slideDown 0.4s ease-out; */
}


.cancellation-notification-header {
    display: flex;
    align-items: center;
    justify-content: center;
    margin-bottom: 1.5rem;
    padding-bottom: 1rem;
    border-bottom: 2px solid rgba(220, 38, 38, 0.3);
}

.cancellation-notification-icon {
    font-size: 3.5rem;
    margin-right: 1rem;
    animation: warningPulse 1.5s ease-in-out infinite;
}

@keyframes warningPulse {
    0%, 100% { 
        transform: scale(1);
        filter: drop-shadow(0 0 10px rgba(220, 38, 38, 0.5));
    }
    50% { 
        transform: scale(1.1);
        filter: drop-shadow(0 0 20px rgba(220, 38, 38, 0.8));
    }
}

.cancellation-notification-title {
    font-size: 1.8rem;
    font-weight: bold;
    color: #dc2626;
}

.cancellation-notification-body {
    margin-bottom: 1.5rem;
}

.cancellation-detail {
    display: flex;
    justify-content: space-between;
    padding: 0.75rem 0;
    border-bottom: 1px solid rgba(0, 3, 69, 0.1);
}

.cancellation-detail:last-child {
    border-bottom: none;
}

.cancellation-label {
    font-weight: 600;
    color: #6b7280;
}

.cancellation-value {
    font-weight: bold;
    color: #000345;
    text-align: right;
}

.cancellation-reason {
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
    margin-top: 1rem;
    padding: 1rem;
    background: rgba(220, 38, 38, 0.05);
    border-radius: 0.5rem;
    border: 1px solid rgba(220, 38, 38, 0.2);
}

.cancellation-value-reason {
    font-weight: bold;
    color: #dc2626;
    font-size: 1.1rem;
}

.cancellation-acknowledge-btn {
    width: 100%;
    background: #dc2626;
    color: white;
    padding: 1rem 2rem;
    border-radius: 0.75rem;
    border: none;
    font-size: 1.1rem;
    cursor: pointer;
    font-weight: bold;
    transition: all 0.3s;
    box-shadow: 0 4px 12px rgba(220, 38, 38, 0.3);
}

.cancellation-acknowledge-btn:hover {
    background: #b91c1c;
    transform: translateY(-2px);
    box-shadow: 0 6px 16px rgba(220, 38, 38, 0.5);
}

.cancellation-acknowledge-btn:active {
    transform: translateY(0);
}

/* Mobile responsive */
@media (max-width: 768px) {
    .cancellation-notification {
        padding: 1.5rem;
        max-width: 95%;
    }
    
    .cancellation-notification-icon {
        font-size: 2.5rem;
    }
    
    .cancellation-notification-title {
        font-size: 1.4rem;
    }
}
/* ============================================
   COMMENT NOTIFICATION POPUP (NEW)
   ========================================== */
.comment-notification-popup {
    position: fixed;
    right: 2rem;
    bottom: 2rem;
    background: rgba(255, 255, 255, 0.98);
    backdrop-filter: blur(30px);
    -webkit-backdrop-filter: blur(30px);
    border: 2px solid rgba(59, 130, 246, 0.5);
    border-radius: 1rem;
    box-shadow: 0 12px 40px rgba(59, 130, 246, 0.3);
    z-index: 9999;
    padding: 1.5rem;
    max-width: 350px;
    width: 90%;
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    animation: slideInFromRight 0.4s ease-out;
}

@keyframes slideInFromRight {
    from {
        opacity: 0;
        transform: translateX(100%);
    }
    to {
        opacity: 1;
        transform: translateX(0);
    }
}

.comment-notification-popup.fade-out {
    opacity: 0;
    transform: translateX(50px);
}

.comment-notification-header {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    margin-bottom: 1rem;
    padding-bottom: 0.75rem;
    border-bottom: 2px solid rgba(59, 130, 246, 0.2);
}

.comment-notification-icon {
    font-size: 1.8rem;
    animation: gentlePulse 2s ease-in-out infinite;
}

@keyframes gentlePulse {
    0%, 100% { transform: scale(1); opacity: 1; }
    50% { transform: scale(1.1); opacity: 0.8; }
}

.comment-notification-title {
    font-size: 1.1rem;
    font-weight: bold;
    color: #3b82f6;
}

.comment-notification-body {
    margin-bottom: 1rem;
}

.comment-notification-time {
    font-size: 0.85rem;
    color: #6b7280;
    margin-bottom: 0.5rem;
    font-weight: 600;
}

.comment-notification-preview {
    color: #1f2937;
    font-size: 0.95rem;
    line-height: 1.5;
    padding: 0.75rem;
    background: rgba(59, 130, 246, 0.05);
    border-radius: 0.5rem;
    border-left: 3px solid #3b82f6;
    max-height: 100px;
    overflow-y: auto;
}

.comment-notification-acknowledge {
    width: 100%;
    background: #3b82f6;
    color: white;
    padding: 0.75rem 1.5rem;
    border-radius: 0.5rem;
    border: none;
    font-size: 0.95rem;
    cursor: pointer;
    font-weight: 600;
    transition: all 0.3s;
    box-shadow: 0 2px 8px rgba(59, 130, 246, 0.3);
}

.comment-notification-acknowledge:hover {
    background: #2563eb;
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(59, 130, 246, 0.4);
}

@media (max-width: 768px) {
    .comment-notification-popup {
        right: 1rem;
        bottom: 1rem;
        max-width: calc(100% - 2rem);
    }
}

/* ============================================
   ZONE E COMMENT NOTIFICATION POPUP (ORANGE)
   ============================================ */
.zone-e-notification-popup {
    position: fixed;
    right: 2rem;
    bottom: 2rem;
    background: rgba(255, 255, 255, 0.98);
    backdrop-filter: blur(30px);
    -webkit-backdrop-filter: blur(30px);
    border: 2px solid rgba(250, 81, 21, 0.5);
    border-radius: 1rem;
    box-shadow: 0 12px 40px rgba(250, 81, 21, 0.3);
    z-index: 9999;
    padding: 1.5rem;
    max-width: 350px;
    width: 90%;
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    animation: slideInFromRight 0.4s ease-out;
}

.zone-e-notification-popup.fade-out {
    opacity: 0;
    transform: translateX(50px);
}

.zone-e-notification-header {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    margin-bottom: 1rem;
    padding-bottom: 0.75rem;
    border-bottom: 2px solid rgba(250, 81, 21, 0.2);
}

.zone-e-notification-icon {
    font-size: 1.8rem;
    animation: gentlePulse 2s ease-in-out infinite;
}

.zone-e-notification-title {
    font-size: 1.1rem;
    font-weight: bold;
    color: #FA5115;
}

.zone-e-notification-body {
    margin-bottom: 1rem;
}

.zone-e-notification-time {
    font-size: 0.85rem;
    color: #6b7280;
    margin-bottom: 0.5rem;
    font-weight: 600;
}

.zone-e-notification-preview {
    color: #1f2937;
    font-size: 0.95rem;
    line-height: 1.5;
    padding: 0.75rem;
    background: rgba(250, 81, 21, 0.05);
    border-radius: 0.5rem;
    border-left: 3px solid #FA5115;
    max-height: 100px;
    overflow-y: auto;
}

.zone-e-notification-acknowledge {
    width: 100%;
    background: #FA5115;
    color: white;
    padding: 0.75rem 1.5rem;
    border-radius: 0.5rem;
    border: none;
    font-size: 0.95rem;
    cursor: pointer;
    font-weight: 600;
    transition: all 0.3s;
    box-shadow: 0 2px 8px rgba(250, 81, 21, 0.3);
}

.zone-e-notification-acknowledge:hover {
    background: #e04510;
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(250, 81, 21, 0.4);
}

@media (max-width: 768px) {
    .zone-e-notification-popup {
        right: 1rem;
        bottom: 1rem;
        max-width: calc(100% - 2rem);
    }
}

/* ============================================
   COMMENT SELECTION MODAL
   ============================================ */
.comment-selection-modal {
    position: fixed;
    left: 50%;
    top: 50%;
    transform: translate(-50%, -50%);
    background: rgba(255, 255, 255, 0.98);
    backdrop-filter: blur(30px);
    -webkit-backdrop-filter: blur(30px);
    border: 2px solid #000345;
    border-radius: 1rem;
    box-shadow: 0 12px 40px rgba(0, 3, 69, 0.3);
    z-index: 10000;
    padding: 2rem;
    max-width: 450px;
    width: 90%;
}

.comment-selection-title {
    font-size: 1.4rem;
    font-weight: bold;
    color: #000345;
    text-align: center;
    margin-bottom: 0.5rem;
}

.comment-selection-subtitle {
    color: #6b7280;
    text-align: center;
    margin-bottom: 1.5rem;
    font-size: 0.95rem;
}

.comment-type-btn {
    width: 100%;
    padding: 1.25rem 1.5rem;
    border-radius: 0.75rem;
    border: 2px solid;
    cursor: pointer;
    font-size: 1.1rem;
    font-weight: bold;
    display: flex;
    align-items: center;
    gap: 1rem;
    margin-bottom: 1rem;
    transition: all 0.3s;
    text-align: left;
}

.comment-type-btn.zone-e {
    background: rgba(250, 81, 21, 0.1);
    border-color: #FA5115;
    color: #FA5115;
}

.comment-type-btn.zone-e:hover {
    background: #FA5115;
    color: white;
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(250, 81, 21, 0.4);
}

.comment-type-btn.general {
    background: rgba(59, 130, 246, 0.1);
    border-color: #3b82f6;
    color: #3b82f6;
}

.comment-type-btn.general:hover {
    background: #3b82f6;
    color: white;
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(59, 130, 246, 0.4);
}

.comment-type-icon {
    font-size: 1.5rem;
    flex-shrink: 0;
}

.comment-type-text {
    flex: 1;
}

.comment-type-desc {
    font-size: 0.8rem;
    font-weight: normal;
    opacity: 0.8;
    margin-top: 0.25rem;
}

.comment-selection-cancel {
    width: 100%;
    padding: 0.75rem;
    background: #6b7280;
    color: white;
    border: none;
    border-radius: 0.5rem;
    font-size: 1rem;
    cursor: pointer;
    margin-top: 0.5rem;
    font-weight: 600;
    transition: all 0.3s;
}

.comment-selection-cancel:hover {
    background: #4b5563;
}

/* ============================================
   ZONE E COMMENTS SECTION (ORANGE THEMED)
   ============================================ */
.zone-e-comments-section {
    background: rgba(250, 81, 21, 0.08);
    backdrop-filter: blur(40px) saturate(180%);
    -webkit-backdrop-filter: blur(40px) saturate(180%);
    border: 2px solid rgba(250, 81, 21, 0.3);
    border-radius: 1.5rem;
    padding: 1.5rem;
    margin-bottom: 2rem;
    box-shadow: 
        0 8px 32px rgba(250, 81, 21, 0.1),
        inset 0 1px 0 rgba(255, 255, 255, 0.8);
}

.zone-e-comments-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 1rem;
    padding-bottom: 0.75rem;
    border-bottom: 2px solid rgba(250, 81, 21, 0.2);
}

.zone-e-comments-title {
    font-size: 1.3rem;
    font-weight: bold;
    color: #FA5115;
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

.zone-e-comment-card {
    background: rgba(255, 255, 255, 0.6);
    backdrop-filter: none;
    -webkit-backdrop-filter: none;
    border: 1px solid rgba(250, 81, 21, 0.3);
    border-radius: 0.75rem;
    padding: 1rem;
    margin-bottom: 0.75rem;
    position: relative;
    transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
    box-shadow: 
        0 4px 16px rgba(250, 81, 21, 0.08),
        inset 0 1px 0 rgba(255, 255, 255, 0.6);
}

.zone-e-comment-card:hover {
    transform: translateY(-3px) scale(1.01);
    box-shadow: 
        0 8px 24px rgba(250, 81, 21, 0.15),
        inset 0 1px 0 rgba(255, 255, 255, 0.8);
}

.zone-e-badge {
    background: #FA5115;
    color: white;
    padding: 0.15rem 0.5rem;
    border-radius: 0.25rem;
    font-size: 0.7rem;
    font-weight: bold;
    margin-left: 0.5rem;
}

.zone-e-delete-all-btn {
    background: #dc2626;
    color: white;
    padding: 0.5rem 1rem;
    border-radius: 0.5rem;
    border: none;
    font-size: 0.9rem;
    cursor: pointer;
    font-weight: bold;
    transition: all 0.3s;
}

.zone-e-delete-all-btn:hover {
    background: #b91c1c;
    transform: translateY(-1px);
}

/* ============================================
   SUMMARY REPORT BUTTON
   ============================================ */
.summary-report-btn {
    background: linear-gradient(135deg, #000345 0%, #001078 100%);
    color: white;
    padding: 0.75rem 1.25rem;
    border-radius: 0.5rem;
    border: none;
    font-size: 0.95rem;
    cursor: pointer;
    font-weight: bold;
    display: inline-flex;
    align-items: center;
    gap: 0.5rem;
    transition: all 0.3s;
    box-shadow: 0 4px 12px rgba(0, 3, 69, 0.3);
}

.summary-report-btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 6px 16px rgba(0, 3, 69, 0.4);
}

.leadership-team-btn {
    background: #FA5115;
    color: white;
    padding: 0.75rem 1.25rem;
    border-radius: 0.5rem;
    border: none;
    font-size: 0.95rem;
    cursor: pointer;
    font-weight: bold;
    display: inline-flex;
    align-items: center;
    gap: 0.5rem;
    transition: all 0.3s;
    box-shadow: 0 4px 12px rgba(250, 81, 21, 0.3);
}

.leadership-team-btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 6px 16px rgba(250, 81, 21, 0.4);
    background: #e04810;
}

.pax-loads-btn {
    background: linear-gradient(135deg, #000345 0%, #001078 100%);
    color: white;
    padding: 0.75rem 1.25rem;
    border-radius: 0.5rem;
    border: none;
    font-size: 0.95rem;
    cursor: pointer;
    font-weight: bold;
    display: inline-flex;
    align-items: center;
    gap: 0.5rem;
    transition: all 0.3s;
    box-shadow: 0 4px 12px rgba(0, 3, 69, 0.3);
}

.pax-loads-btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 6px 16px rgba(0, 3, 69, 0.4);
}

/* Pax Loads Modal */
.pax-loads-overlay {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0, 3, 69, 0.6);
    backdrop-filter: blur(5px);
    -webkit-backdrop-filter: blur(5px);
    z-index: 10002;
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 1rem;
}

.pax-loads-modal {
    background: white;
    border-radius: 1rem;
    width: 100%;
    max-width: 600px;
    max-height: 90vh;
    overflow-y: auto;
    box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
}

.pax-loads-header {
    background: linear-gradient(135deg, #000345 0%, #001078 100%);
    color: white;
    padding: 1.25rem 1.5rem;
    border-radius: 1rem 1rem 0 0;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.pax-loads-title {
    font-size: 1.25rem;
    font-weight: bold;
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

.pax-loads-date {
    font-size: 0.9rem;
    opacity: 0.9;
}

.pax-loads-close {
    background: rgba(255,255,255,0.2);
    border: none;
    color: white;
    width: 36px;
    height: 36px;
    border-radius: 50%;
    cursor: pointer;
    font-size: 1.25rem;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: background 0.2s;
}

.pax-loads-close:hover {
    background: rgba(255,255,255,0.3);
}

.pax-loads-content {
    padding: 1.5rem;
}

.pax-loads-table {
    width: 100%;
    border-collapse: collapse;
    font-size: 0.95rem;
}

.pax-loads-table th {
    background: #000345;
    color: white;
    padding: 0.75rem;
    text-align: left;
    font-weight: 600;
}

.pax-loads-table th:first-child {
    border-radius: 0.5rem 0 0 0;
    width: 40px;
}

.pax-loads-table th:last-child {
    border-radius: 0 0.5rem 0 0;
}

.pax-loads-table td {
    padding: 0.75rem;
    border-bottom: 1px solid #eee;
}

.pax-loads-table tr:nth-child(even) {
    background: #f8f9fa;
}

.pax-loads-table tr.selected {
    background: #FFF5F2 !important;
}

.pax-loads-table tr.peak-row {
    background: linear-gradient(135deg, #FA5116 0%, #e04810 100%) !important;
    color: white;
}

.pax-loads-table tr.peak-row td {
    border-bottom-color: #e04810;
}

.pax-loads-table tr.total-row {
    background: #000345 !important;
    color: white;
    font-weight: bold;
}

.pax-loads-table tr.total-row td {
    border-bottom: none;
}

.pax-loads-table tr.merged-row {
    background: #e8f4f8 !important;
}

.pax-bar-container {
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

.pax-bar {
    height: 20px;
    background: linear-gradient(90deg, #FA5116 0%, #ff7849 100%);
    border-radius: 4px;
    transition: width 0.3s ease;
}

.pax-bar.peak {
    background: linear-gradient(90deg, #ffffff 0%, #ffe4d9 100%);
    box-shadow: 0 2px 8px rgba(255, 255, 255, 0.5);
    border: 1px solid rgba(255, 255, 255, 0.8);
}

.peak-badge {
    background: white;
    color: #FA5116;
    font-size: 0.7rem;
    border: 1px solid rgba(255,255,255,0.5);
    font-weight: bold;
    padding: 2px 6px;
    border-radius: 4px;
    font-weight: bold;
    white-space: nowrap;
}

.unmerge-btn {
    background: #FA5116;
    color: white;
    border: none;
    width: 24px;
    height: 24px;
    border-radius: 50%;
    cursor: pointer;
    font-size: 0.9rem;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    margin-left: 8px;
    transition: all 0.2s;
}

.unmerge-btn:hover {
    background: #e04810;
    transform: scale(1.1);
}

.pax-loads-actions {
    display: flex;
    gap: 0.75rem;
    margin-top: 1.25rem;
    justify-content: center;
    flex-wrap: wrap;
}

.pax-action-btn {
    padding: 0.75rem 1.5rem;
    border-radius: 0.5rem;
    border: none;
    font-size: 0.95rem;
    font-weight: bold;
    cursor: pointer;
    transition: all 0.2s;
}

.pax-action-btn.merge {
    background: #FA5116;
    color: white;
}

.pax-action-btn.merge:hover:not(:disabled) {
    background: #e04810;
}

.pax-action-btn.merge:disabled {
    background: #ccc;
    cursor: not-allowed;
}

.pax-action-btn.reset {
    background: #f0f0f0;
    color: #333;
}

.pax-action-btn.reset:hover {
    background: #e0e0e0;
}

.pax-action-btn.close-btn {
    background: #000345;
    color: white;
}

.pax-action-btn.close-btn:hover {
    background: #001078;
}

.pax-checkbox {
    width: 18px;
    height: 18px;
    cursor: pointer;
    accent-color: #FA5116;
}

/* ============================================
   LEADERSHIP TEAM MODAL STYLES
   ============================================ */
.leadership-modal-overlay {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0, 3, 69, 0.5);
    backdrop-filter: blur(5px);
    z-index: 10000;
    display: flex;
    align-items: center;
    justify-content: center;
}

.leadership-password-overlay {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0, 3, 69, 0.7);
    backdrop-filter: blur(8px);
    z-index: 10001;
    display: flex;
    align-items: center;
    justify-content: center;
}

.leadership-password-modal {
    background: white;
    border-radius: 0.75rem;
    box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
    width: 90%;
    max-width: 400px;
    overflow: hidden;
}

.leadership-password-header {
    background: #000345;
    color: white;
    padding: 1.25rem 1.5rem;
    font-size: 1.25rem;
    font-weight: bold;
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

.leadership-password-body {
    padding: 1.5rem;
}

.leadership-password-body label {
    display: block;
    font-weight: 500;
    color: #374151;
    margin-bottom: 0.75rem;
}

.leadership-password-input {
    width: 100%;
    padding: 0.875rem 1rem;
    border: 2px solid #e5e7eb;
    border-radius: 0.5rem;
    font-size: 1rem;
    transition: all 0.2s;
}

.leadership-password-input:focus {
    outline: none;
    border-color: #FA5115;
    box-shadow: 0 0 0 3px rgba(250, 81, 21, 0.1);
}

.leadership-password-error {
    color: #dc2626;
    font-size: 0.875rem;
    margin-top: 0.75rem;
    padding: 0.5rem;
    background: #fef2f2;
    border-radius: 0.375rem;
}

.leadership-password-footer {
    padding: 1rem 1.5rem;
    border-top: 1px solid #e5e7eb;
    display: flex;
    gap: 0.75rem;
    justify-content: flex-end;
}

.leadership-password-btn {
    padding: 0.75rem 1.5rem;
    border-radius: 0.5rem;
    font-size: 1rem;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.2s;
    border: none;
}

.leadership-password-btn.cancel {
    background: #f3f4f6;
    color: #374151;
}

.leadership-password-btn.cancel:hover {
    background: #e5e7eb;
}

.leadership-password-btn.submit {
    background: #FA5115;
    color: white;
}

.leadership-password-btn.submit:hover {
    background: #e04510;
}

/* Supervisor Password Modal */
.supervisor-password-overlay {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0, 3, 69, 0.7);
    backdrop-filter: blur(8px);
    z-index: 10001;
    display: flex;
    align-items: center;
    justify-content: center;
}

.supervisor-password-modal {
    background: white;
    border-radius: 0.75rem;
    box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
    width: 90%;
    max-width: 400px;
    overflow: hidden;
}

.supervisor-password-header {
    background: #000345;
    color: white;
    padding: 1.25rem 1.5rem;
    font-size: 1.25rem;
    font-weight: bold;
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

.supervisor-password-body {
    padding: 1.5rem;
}

.supervisor-password-info {
    color: #6b7280;
    font-size: 0.9rem;
    margin-bottom: 1rem;
}

.supervisor-password-body label {
    display: block;
    font-weight: 500;
    color: #374151;
    margin-bottom: 0.75rem;
}

.supervisor-password-input {
    width: 100%;
    padding: 0.875rem 1rem;
    border: 2px solid #e5e7eb;
    border-radius: 0.5rem;
    font-size: 1rem;
    transition: all 0.2s;
}

.supervisor-password-input:focus {
    outline: none;
    border-color: #FA5115;
    box-shadow: 0 0 0 3px rgba(250, 81, 21, 0.1);
}

.supervisor-password-error {
    color: #dc2626;
    font-size: 0.875rem;
    margin-top: 0.75rem;
    padding: 0.5rem;
    background: #fef2f2;
    border-radius: 0.375rem;
}

.supervisor-password-footer {
    padding: 1rem 1.5rem;
    border-top: 1px solid #e5e7eb;
    display: flex;
    gap: 0.75rem;
    justify-content: flex-end;
}

.supervisor-password-btn {
    padding: 0.75rem 1.5rem;
    border-radius: 0.5rem;
    font-size: 1rem;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.2s;
    border: none;
}

.supervisor-password-btn.cancel {
    background: #f3f4f6;
    color: #374151;
}

.supervisor-password-btn.cancel:hover {
    background: #e5e7eb;
}

.supervisor-password-btn.submit {
    background: #FA5115;
    color: white;
}

.supervisor-password-btn.submit:hover {
    background: #e04510;
}

.leadership-modal {
    background: white;
    border-radius: 0.75rem;
    box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
    width: 90%;
    max-width: 600px;
    max-height: 85vh;
    display: flex;
    flex-direction: column;
    position: relative;
}

.leadership-modal-header {
    background: #000345;
    color: white;
    padding: 1.25rem 1.5rem;
    border-radius: 0.75rem 0.75rem 0 0;
    display: flex;
    align-items: center;
    justify-content: space-between;
}

.leadership-modal-title {
    font-size: 1.5rem;
    font-weight: bold;
    display: flex;
    align-items: center;
    gap: 0.5rem;
    flex-wrap: wrap;
}

.edit-mode-badge {
    font-size: 0.7rem;
    background: #FA5115;
    padding: 0.25rem 0.5rem;
    border-radius: 0.25rem;
    font-weight: 600;
    letter-spacing: 0.5px;
}

.leadership-close-btn {
    background: #dc2626;
    color: white;
    border: none;
    width: 28px;
    height: 28px;
    border-radius: 4px;
    font-size: 1rem;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.2s;
    line-height: 1;
    padding: 0;
    font-weight: bold;
}

.leadership-close-btn:hover {
    background: #b91c1c;
    transform: scale(1.1);
}

.leadership-modal-content {
    padding: 1rem;
    overflow-y: auto;
    flex: 1;
    max-height: 60vh;
}

/* Option B: Public View Styles - Grouped by Role Type */
.leadership-group {
    margin-bottom: 0.75rem;
}

.leadership-group:last-child {
    margin-bottom: 0;
}

.leadership-group-header {
    font-size: 0.8rem;
    font-weight: 700;
    color: #000345;
    padding: 0.5rem 0.75rem;
    background: #f3f4f6;
    border-radius: 0.375rem 0.375rem 0 0;
    letter-spacing: 0.5px;
}

.leadership-group-list {
    background: white;
    border-radius: 0 0 0.375rem 0.375rem;
    overflow: hidden;
}

.leadership-public-row {
    display: flex;
    align-items: stretch;
    background: white;
    border-bottom: 1px solid #e5e7eb;
}

.leadership-public-row:last-child {
    border-bottom: none;
    border-radius: 0 0 0.375rem 0.375rem;
}

.leadership-color-bar {
    width: 4px;
    background: #FA5115;
    flex-shrink: 0;
}

.leadership-public-position {
    flex: 1;
    padding: 0.625rem 0.75rem;
    font-size: 0.85rem;
    color: #374151;
    font-weight: 500;
    max-width: 60%;
}

.leadership-public-name {
    padding: 0.625rem 0.75rem;
    font-size: 0.95rem;
    color: #000345;
    font-weight: 700;
    min-width: 90px;
    max-width: 40%;
}

/* Leadership no data message */
.leadership-no-data {
    padding: 2rem;
    text-align: center;
    color: #6b7280;
    font-style: italic;
}

.leadership-position-row {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 0.75rem;
    border-bottom: 1px solid #e5e7eb;
    gap: 1rem;
}

.leadership-position-row:last-child {
    border-bottom: none;
}

.leadership-position-row-grid {
    padding: 0.75rem;
    border-bottom: 1px solid #e5e7eb;
}

.leadership-position-row-grid:last-child {
    border-bottom: none;
}

.leadership-position-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-bottom: 0.5rem;
}

.leadership-position-label {
    flex: 1;
    font-weight: 500;
    color: #1f2937;
    font-size: 0.95rem;
}

.leadership-position-name {
    flex: 1;
    color: #000345;
    font-weight: 600;
    font-size: 1rem;
    text-align: right;
}

.leadership-name-grid {
    display: flex;
    flex-wrap: wrap;
    gap: 0.35rem;
}

.name-btn {
    padding: 0.35rem 0.6rem;
    border: 2px solid #e5e7eb;
    border-radius: 0.375rem;
    font-size: 0.8rem;
    cursor: pointer;
    transition: all 0.15s;
    background: white;
    color: #374151;
}

.name-btn:hover {
    border-color: #000345;
    background: #f3f4f6;
}

.name-btn.selected {
    background: #FA5115;
    color: white;
    border-color: #FA5115;
    font-weight: 600;
}

.name-btn.other-btn {
    background: #f0f9ff;
    border-color: #0ea5e9;
    color: #0369a1;
}

.name-btn.other-btn:hover {
    background: #e0f2fe;
    border-color: #0284c7;
}

.name-btn.other-btn.selected {
    background: #0ea5e9;
    color: white;
    border-color: #0ea5e9;
}

.custom-name-input-container {
    display: flex;
    gap: 0.5rem;
    margin-top: 0.5rem;
    align-items: center;
}

.custom-name-input {
    flex: 1;
    padding: 0.5rem 0.75rem;
    border: 2px solid #0ea5e9;
    border-radius: 0.375rem;
    font-size: 0.9rem;
    outline: none;
}

.custom-name-input:focus {
    border-color: #0284c7;
    box-shadow: 0 0 0 3px rgba(14, 165, 233, 0.2);
}

.custom-name-save-btn {
    padding: 0.5rem 0.75rem;
    background: #10b981;
    color: white;
    border: none;
    border-radius: 0.375rem;
    cursor: pointer;
    font-size: 1rem;
    font-weight: bold;
}

.custom-name-save-btn:hover {
    background: #059669;
}

.custom-name-cancel-btn {
    padding: 0.5rem 0.75rem;
    background: #6b7280;
    color: white;
    border: none;
    border-radius: 0.375rem;
    cursor: pointer;
    font-size: 1rem;
    font-weight: bold;
}

.custom-name-cancel-btn:hover {
    background: #4b5563;
}

.visibility-toggle {
    width: 50px;
    height: 28px;
    background: #9ca3af;
    border-radius: 14px;
    position: relative;
    cursor: pointer;
    transition: all 0.3s;
    flex-shrink: 0;
}

.visibility-toggle.visible {
    background: #059669;
}

.visibility-toggle.disabled {
    cursor: not-allowed;
    opacity: 0.5;
}

.visibility-toggle-slider {
    width: 24px;
    height: 24px;
    background: white;
    border-radius: 50%;
    position: absolute;
    top: 2px;
    left: 2px;
    transition: all 0.3s;
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
}

.visibility-toggle.visible .visibility-toggle-slider {
    left: 24px;
}

.leadership-modal-footer {
    padding: 1rem 1.5rem;
    border-top: 2px solid #e5e7eb;
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: 1rem;
}

.leadership-last-published {
    font-size: 0.85rem;
    color: #6b7280;
}

.leadership-actions {
    display: flex;
    gap: 0.75rem;
}

.leadership-btn {
    padding: 0.75rem 1.5rem;
    border: none;
    border-radius: 0.5rem;
    font-weight: bold;
    cursor: pointer;
    transition: all 0.2s;
    font-size: 0.95rem;
}

.leadership-btn.unlock {
    background: #000345;
    color: white;
}

.leadership-btn.unlock:hover {
    background: #001078;
}

.leadership-btn.publish {
    background: #FA5115;
    color: white;
    display: none;
}

.leadership-btn.publish:hover {
    background: #e04810;
}

.leadership-btn.publish.visible {
    display: inline-block;
}

.leadership-btn.clear-all {
    background: #6b7280;
    color: white;
}

.leadership-btn.clear-all:hover {
    background: #4b5563;
}

.leadership-btn.exit-edit {
    background: #000345;
    color: white;
}

.leadership-btn.exit-edit:hover {
    background: #001078;
}

.leadership-btn.edit-mode {
    background: #000345;
    color: white;
}

.leadership-btn.edit-mode:hover {
    background: #001078;
}

/* ============================================
   CANCELLATION APPROVAL MODAL (NEW)
   ========================================== */
.cancellation-approval-modal {
    position: fixed;
    left: 50%;
    top: 50%;
    transform: translate(-50%, -50%);
    background: rgba(255, 255, 255, 0.98);
    backdrop-filter: blur(30px);
    -webkit-backdrop-filter: blur(30px);
    border: 3px solid #dc2626;
    border-radius: 1rem;
    box-shadow: 0 20px 60px rgba(220, 38, 38, 0.4);
    z-index: 10002;
    padding: 2rem;
    max-width: 550px;
    width: 90%;
    max-height: 85vh;
    overflow-y: auto;
}

.cancellation-approval-header {
    display: flex;
    align-items: center;
    justify-content: center;
    margin-bottom: 1.5rem;
    padding-bottom: 1rem;
    border-bottom: 2px solid rgba(220, 38, 38, 0.3);
}

.cancellation-approval-icon {
    font-size: 3rem;
    margin-right: 1rem;
}

.cancellation-approval-title {
    font-size: 1.5rem;
    font-weight: bold;
    color: #dc2626;
}

.cancellation-approval-flight-info {
    background: rgba(220, 38, 38, 0.05);
    border: 1px solid rgba(220, 38, 38, 0.2);
    border-radius: 0.75rem;
    padding: 1rem;
    margin-bottom: 1.5rem;
}

.cancellation-approval-flight-detail {
    display: flex;
    justify-content: space-between;
    padding: 0.5rem 0;
    border-bottom: 1px solid rgba(220, 38, 38, 0.1);
}

.cancellation-approval-flight-detail:last-child {
    border-bottom: none;
}

.cancellation-approval-label {
    font-weight: 600;
    color: #6b7280;
}

.cancellation-approval-value {
    font-weight: bold;
    color: #000345;
}

.cancellation-approval-warning {
    background: rgba(245, 158, 11, 0.1);
    border: 2px solid rgba(245, 158, 11, 0.4);
    border-radius: 0.5rem;
    padding: 1rem;
    margin-bottom: 1.5rem;
    color: #92400e;
    font-weight: 600;
    text-align: center;
}

.cancellation-approval-form {
    display: flex;
    flex-direction: column;
    gap: 1.25rem;
}

.cancellation-approval-field {
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
}

.cancellation-approval-field-label {
    font-weight: 600;
    color: #000345;
    font-size: 0.95rem;
}

.cancellation-approval-field-label.required::after {
    content: ' *';
    color: #dc2626;
}

.cancellation-approval-input,
.cancellation-approval-select {
    padding: 0.75rem;
    border: 2px solid #000345;
    border-radius: 0.5rem;
    font-family: inherit;
    font-size: 0.95rem;
    background: rgba(255, 255, 255, 0.9);
    transition: border-color 0.3s;
}

.cancellation-approval-input:focus,
.cancellation-approval-select:focus {
    outline: none;
    border-color: #FA5115;
    box-shadow: 0 0 0 3px rgba(250, 81, 21, 0.1);
}

.cancellation-approval-input.error,
.cancellation-approval-select.error {
    border-color: #dc2626;
    box-shadow: 0 0 0 3px rgba(220, 38, 38, 0.1);
}

.cancellation-approval-error-msg {
    color: #dc2626;
    font-size: 0.85rem;
    font-weight: 600;
    margin-top: 0.25rem;
    display: none;
}

.cancellation-approval-error-msg.show {
    display: block;
}

.cancellation-approval-actions {
    display: flex;
    gap: 1rem;
    margin-top: 1.5rem;
}

.cancellation-approval-submit,
.cancellation-approval-cancel {
    flex: 1;
    padding: 0.875rem 1.5rem;
    border-radius: 0.5rem;
    border: none;
    font-size: 1rem;
    cursor: pointer;
    font-weight: bold;
    transition: all 0.3s;
}

.cancellation-approval-submit {
    background: #dc2626;
    color: white;
    box-shadow: 0 4px 12px rgba(220, 38, 38, 0.3);
}

.cancellation-approval-submit:hover {
    background: #b91c1c;
    transform: translateY(-2px);
    box-shadow: 0 6px 16px rgba(220, 38, 38, 0.4);
}

.cancellation-approval-submit:disabled {
    background: #9ca3af;
    cursor: not-allowed;
    transform: none;
}

.cancellation-approval-cancel {
    background: #6b7280;
    color: white;
}

.cancellation-approval-cancel:hover {
    background: #4b5563;
}

@media (max-width: 768px) {
    .cancellation-approval-modal {
        max-width: 95%;
        padding: 1.5rem;
    }
    
    .cancellation-approval-title {
        font-size: 1.3rem;
    }
    
    .cancellation-approval-actions {
        flex-direction: column;
    }
}
        /* Sticky time reference - appears when scrolling */
.scroll-time-reference {
    position: fixed;
    top: 20px;
    right: 20px;
    background: rgba(0, 3, 69, 0.95);
    backdrop-filter: blur(20px);
    -webkit-backdrop-filter: blur(20px);
    border: 2px solid rgba(255, 255, 255, 0.3);
    border-radius: 1rem;
    padding: 0.75rem 1.5rem;
    color: white;
    font-family: monospace;
    font-size: 1.3rem;
    font-weight: bold;
    box-shadow: 0 8px 24px rgba(0, 3, 69, 0.4);
    z-index: 9997;
    opacity: 0;
    transform: translateY(-10px);
    transition: opacity 0.3s ease, transform 0.3s ease;
    pointer-events: none;
}

.scroll-time-reference.visible {
    opacity: 1;
    transform: translateY(0);
}

.scroll-time-reference::before {
    content: ' ';
    margin-right: 0.5rem;
    font-size: 1.1rem;
}

/* Mobile adjustments */
@media (max-width: 768px) {
    .scroll-time-reference {
        top: 10px;
        right: 10px;
        font-size: 1.1rem;
        padding: 0.6rem 1.2rem;
    }
}
        .date-badge { 
            display: inline-block;
            background: rgba(250, 81, 21, 0.1);
            backdrop-filter: none;
            -webkit-backdrop-filter: none;
            border: 1px solid rgba(250, 81, 21, 0.3);
            padding: 0.5rem 1rem;
            border-radius: 1rem;
            font-size: 0.9rem;
            color: #FA5115;
            font-weight: 600;
            margin: 0.5rem 0;
        }
        
       .date-validation-badge {
    position: absolute;
    top: 1rem;
    right: 1rem;
    background: rgba(16, 185, 129, 0.1);
    backdrop-filter: none;
    -webkit-backdrop-filter: none;
    border: 1px solid rgba(16, 185, 129, 0.3);
    padding: 0.5rem 1rem;
    border-radius: 0.75rem;
    font-size: 0.85rem;
    color: #10b981;
    font-weight: 600;
    display: none;
}

.date-validation-badge.warning {
    background: rgba(245, 158, 11, 0.1);
    border-color: rgba(245, 158, 11, 0.3);
    color: #f59e0b;
}

.date-validation-badge.success-tick {
    background: rgba(16, 185, 129, 0.15);
    border-color: rgba(16, 185, 129, 0.4);
    color: #10b981;
    font-size: 1.5rem;
    padding: 0.5rem 0.75rem;
    width: 48px;
    height: 48px;
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: 50%;
}

/* Hide date validation badge in saved HTML files */
body.saved-html .date-validation-badge {
    display: none !important;
}

@media (max-width: 743px) {
    .header {
        padding-top: 3.5rem;
    }
    
    .date-validation-badge {
        top: 0.5rem;
        right: 0.5rem;
        font-size: 0.75rem;
        padding: 0.4rem 0.8rem;
    }
    
    .date-validation-badge.success-tick {
        width: 40px;
        height: 40px;
        font-size: 1.2rem;
    }
}

@media (max-width: 480px) {
    .header h1 {
        font-size: 1.8rem;
        padding-right: 60px;
    }
    
    .date-validation-badge {
        top: 0.25rem;
        right: 0.25rem;
    }
}
        
    .upload-btn-container {
    text-align: center;
    margin-bottom: 2rem;
    display: flex;
    gap: 0.75rem;
    justify-content: center;
    align-items: center;
    flex-wrap: wrap;
}
        
        .search-container {
            position: relative;
            width: 100%;
            max-width: 500px;
            margin: 0 auto 1.5rem;
        }
        
        .search-input {
            width: 100%;
            padding: 0.75rem 3rem 0.75rem 1rem;
            border: 2px solid rgba(0, 3, 69, 0.3);
            border-radius: 0.75rem;
            font-size: 1rem;
            font-family: inherit;
            background: rgba(255, 255, 255, 0.8);
            backdrop-filter: none;
            -webkit-backdrop-filter: none;
            transition: all 0.3s;
            box-shadow: 0 4px 12px rgba(0, 3, 69, 0.1);
        }
        
        .search-input:focus {
            outline: none;
            border-color: #FA5115;
            box-shadow: 0 4px 16px rgba(250, 81, 21, 0.3);
        }
        
        .search-input::placeholder {
            color: #9ca3af;
        }
        
        .search-clear-btn {
            position: absolute;
            right: 0.75rem;
            top: 50%;
            transform: translateY(-50%);
            background: #6b7280;
            color: white;
            border: none;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            font-size: 0.9rem;
            cursor: pointer;
            font-weight: bold;
            display: flex;
            align-items: center;
            justify-content: center;
            display: none;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
            font-weight: bold;
        }
        
        .search-clear-btn:hover {
            background: #4b5563;
            transform: translateY(-50%) scale(1.1);
        }
        
        .search-results-modal {
            position: fixed;
            left: 50%;
            top: 50%;
            transform: translate(-50%, -50%);
            background: rgba(255, 255, 255, 0.98);
            backdrop-filter: none;
            -webkit-backdrop-filter: none;
            border: 2px solid #000345;
            border-radius: 1rem;
            box-shadow: 0 12px 48px rgba(0, 3, 69, 0.3);
            z-index: 10002;
            padding: 2rem;
            max-width: 90%;
            width: 1200px;
            max-height: 85vh;
            overflow-y: auto;
        }
        
        .search-results-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
            padding-bottom: 1rem;
            border-bottom: 2px solid rgba(0, 3, 69, 0.2);
        }
        
        .search-results-title {
            font-size: 1.5rem;
            font-weight: bold;
            color: #000345;
        }
        
        .search-results-close {
            background: #dc2626;
            color: white;
            border: none;
            border-radius: 50%;
            width: 28px;
            height: 28px;
            font-size: 1rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
            font-weight: bold;
            font-weight: bold;
        }
        
        .search-results-close:hover {
            background: #b91c1c;
            transform: scale(1.1);
        }
        
        .search-results-content {
            margin-top: 1rem;
        }
        
        .no-results {
            text-align: center;
            padding: 3rem;
            color: #6b7280;
            font-size: 1.1rem;
        }
        
        .search-highlight {
            background: rgba(250, 81, 21, 0.2);
            padding: 0.1rem 0.3rem;
            border-radius: 0.25rem;
            font-weight: bold;
        }
        
      .upload-btn, .save-btn, .add-flight-btn, .add-comment-main-btn, .early-open-btn, .refresh-all-btn {
    /* ALL BUTTONS SAME BASE STYLE */
    padding: 0.75rem 1.75rem;
    border-radius: 0.5rem;
    border: 1px solid rgba(255, 255, 255, 0.3);
    font-size: 1rem;
    cursor: pointer;
    font-weight: bold;
    transition: all 0.3s;
    color: white;
    min-width: 180px;
    height: 44px;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    gap: 0.5rem;
}

/* Individual button colors */
.upload-btn, .save-btn {
    background: #FA5115;
    box-shadow: 0 4px 12px rgba(250, 81, 21, 0.3);
}
        
        .save-btn {
            background: #10b981;
            box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3);
        }
        
        .upload-btn:hover { 
            background: #e04510;
            transform: translateY(-2px);
            box-shadow: 0 6px 16px rgba(250, 81, 21, 0.5);
        }
        
        .save-btn:hover { 
            background: #059669;
            transform: translateY(-2px);
            box-shadow: 0 6px 16px rgba(16, 185, 129, 0.5);
        }
        .save-html-btn {
    background: linear-gradient(135deg, rgba(0, 3, 69, 0.9), rgba(0, 3, 69, 0.95));
    box-shadow: 0 4px 12px rgba(0, 3, 69, 0.3),
                inset 0 1px 0 rgba(255, 255, 255, 0.3);
    position: relative;
    overflow: hidden;
}

.save-html-btn::before {
    content: '';
    position: absolute;
    top: 0;
    left: -100%;
    width: 100%;
    height: 100%;
    background: linear-gradient(
        90deg,
        transparent,
        rgba(255, 255, 255, 0.3),
        transparent
    );
    transition: left 0.5s;
}

.save-html-btn:hover::before {
    left: 100%;
}

.save-html-btn:hover { 
    background: linear-gradient(135deg, rgba(0, 3, 69, 0.95), rgba(0, 3, 69, 1));
    transform: translateY(-2px);
    box-shadow: 0 6px 16px rgba(0, 3, 69, 0.5),
                inset 0 1px 0 rgba(255, 255, 255, 0.4);
}
.add-flight-btn {
    background: linear-gradient(135deg, rgba(0, 3, 69, 0.9), rgba(0, 3, 69, 0.95));
    box-shadow: 0 4px 12px rgba(0, 3, 69, 0.3),
                inset 0 1px 0 rgba(255, 255, 255, 0.3);
    position: relative;
    overflow: hidden;
}
.add-comment-main-btn {
    background: linear-gradient(135deg, rgba(0, 3, 69, 0.9), rgba(0, 3, 69, 0.95));
    box-shadow: 0 4px 12px rgba(0, 3, 69, 0.3),
                inset 0 1px 0 rgba(255, 255, 255, 0.3);
    position: relative;
    overflow: hidden;
}
.add-comment-main-btn::before {
    content: '';
    position: absolute;
    top: 0;
    left: -100%;
    width: 100%;
    height: 100%;
    background: linear-gradient(
        90deg,
        transparent,
        rgba(255, 255, 255, 0.3),
        transparent
    );
    transition: left 0.5s;
}

.add-comment-main-btn:hover::before {
    left: 100%;
}

.add-comment-main-btn:hover { 
    background: linear-gradient(135deg, rgba(0, 3, 69, 0.95), rgba(0, 3, 69, 1));
    transform: translateY(-2px);
    box-shadow: 0 6px 16px rgba(0, 3, 69, 0.5),
                inset 0 1px 0 rgba(255, 255, 255, 0.4);
}
.refresh-all-btn {
    background: linear-gradient(135deg, #FA5115, #e04510);
    box-shadow: 0 4px 12px rgba(250, 81, 21, 0.3),
                inset 0 1px 0 rgba(255, 255, 255, 0.3);
    position: relative;
    overflow: hidden;
}

.refresh-all-btn::before {
    content: '';
    position: absolute;
    top: 0;
    left: -100%;
    width: 100%;
    height: 100%;
    background: linear-gradient(
        90deg,
        transparent,
        rgba(255, 255, 255, 0.3),
        transparent
    );
    transition: left 0.5s;
}

.refresh-all-btn:hover::before {
    left: 100%;
}

.refresh-all-btn:hover { 
    background: linear-gradient(135deg, #e04510, #FA5115);
    transform: translateY(-2px);
    box-shadow: 0 6px 16px rgba(250, 81, 21, 0.5),
                inset 0 1px 0 rgba(255, 255, 255, 0.4);
}

.refresh-all-btn:active {
    transform: translateY(0px) scale(0.98);
}
.add-flight-btn::before {
    content: '';
    position: absolute;
    top: 0;
    left: -100%;
    width: 100%;
    height: 100%;
    background: linear-gradient(
        90deg,
        transparent,
        rgba(255, 255, 255, 0.3),
        transparent
    );
    transition: left 0.5s;
}

.add-flight-btn:hover::before {
    left: 100%;
}

.add-flight-btn:hover { 
    background: linear-gradient(135deg, rgba(0, 3, 69, 0.95), rgba(0, 3, 69, 1));
    transform: translateY(-2px);
    box-shadow: 0 6px 16px rgba(0, 3, 69, 0.5),
                inset 0 1px 0 rgba(255, 255, 255, 0.4);
}

.add-flight-modal {
    position: fixed;
    left: 50%;
    top: 50%;
    transform: translate(-50%, -50%);
    background: rgba(255, 255, 255, 0.98);
    backdrop-filter: none;
    -webkit-backdrop-filter: none;
    border: 2px solid #000345;
    border-radius: 0.75rem;
    box-shadow: 0 8px 32px rgba(0, 3, 69, 0.3);
    z-index: 10000;
    width: 90%;
    max-width: 500px;
    padding: 1.5rem;
}

.add-flight-title {
    font-size: 1.3rem;
    font-weight: bold;
    color: #000345;
    margin-bottom: 1.5rem;
    text-align: center;
}

.add-flight-form {
    display: flex;
    flex-direction: column;
    gap: 1rem;
}

.form-group {
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
}

.form-label {
    font-weight: 600;
    color: #000345;
    font-size: 0.95rem;
}

.form-input {
    padding: 0.75rem;
    border: 2px solid #000345;
    border-radius: 0.5rem;
    font-family: inherit;
    font-size: 0.95rem;
    background: rgba(255, 255, 255, 0.9);
}

.form-input:focus {
    outline: none;
    border-color: #FA5115;
}

.form-actions {
    display: flex;
    gap: 0.5rem;
    justify-content: flex-end;
    margin-top: 0.5rem;
}

.form-save-btn, .form-cancel-btn {
    padding: 0.75rem 1.5rem;
    border-radius: 0.5rem;
    border: none;
    font-size: 0.95rem;
    cursor: pointer;
    font-weight: bold;
    transition: all 0.3s;
}

.form-save-btn {
    background: #3b82f6;
    color: white;
}

.form-cancel-btn {
    background: #6b7280;
    color: white;
}

.form-save-btn:hover {
    background: #2563eb;
}

.form-cancel-btn:hover {
    background: #4b5563;
}

.form-note {
    font-size: 0.85rem;
    color: #6b7280;
    font-style: italic;
}
.flight-card {
    background: rgba(255, 255, 255, 0.85);
    border: 2px solid rgba(255, 255, 255, 0.9);
    border-radius: 1rem;
    padding: 1.25rem;
    margin-bottom: 1rem;
    position: relative;
    display: grid;
    grid-template-columns: 1fr 2fr 1fr;
    grid-template-rows: auto 1fr auto;
    gap: 1rem;
    box-shadow: 0 4px 16px rgba(0, 3, 69, 0.1);
    transition: transform 0.2s ease, box-shadow 0.2s ease;
    overflow: hidden;
}

.flight-card > * {
    position: relative;
    z-index: 1;
}

.search-results-modal .flight-card {
    background: rgba(255, 255, 255, 0.95) !important;
    border: 2px solid rgba(0, 3, 69, 0.2) !important;
}

.search-results-modal .flight-card::before {
    display: none;
}
.flight-card::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    border-radius: 1rem;
    background: linear-gradient(
        135deg,
        rgba(255, 255, 255, 0.4) 0%,
        rgba(255, 255, 255, 0.05) 50%,
        rgba(255, 255, 255, 0.2) 100%
    );
    pointer-events: none;
    z-index: 0;
}

.flight-card > * {
    position: relative;
    z-index: 1;
}

.flight-card:hover {
    transform: translateY(-5px) scale(1.015);
    box-shadow: 
        0 20px 60px rgba(0, 3, 69, 0.18),
        0 8px 24px rgba(0, 3, 69, 0.12),
        inset 0 3px 8px rgba(255, 255, 255, 1),
        inset 0 -3px 8px rgba(0, 3, 69, 0.08),
        inset 3px 0 10px rgba(255, 255, 255, 0.9),
        inset -3px 0 10px rgba(0, 3, 69, 0.05);
}
.flight-card:hover::before {
    opacity: 1;
}
.flight-card:hover::after {
    animation-duration: 4s;
}    
     
      .flight-card.critical { 
    background: rgba(239, 68, 68, 0.12);
    backdrop-filter: none;
    -webkit-backdrop-filter: none;
    border: 2px solid rgba(239, 68, 68, 0.5);
    box-shadow: 
        0 12px 40px rgba(239, 68, 68, 0.3),
        inset 0 2px 0 rgba(255, 255, 255, 0.6),
        inset 0 -2px 0 rgba(239, 68, 68, 0.15),
        0 0 60px rgba(239, 68, 68, 0.25);
}

.flight-card.critical::before {
    background: linear-gradient(
        135deg,
        rgba(239, 68, 68, 0.25) 0%,
        rgba(255, 255, 255, 0.15) 50%,
        rgba(239, 68, 68, 0.2) 100%
    );
}

.flight-card.critical.pulsing {
    animation: pulse 1.5s infinite;
}

.flight-card.critical:hover {
    transform: translateY(-5px) scale(1.015);
    box-shadow: 
        0 20px 64px rgba(239, 68, 68, 0.4),
        inset 0 2px 0 rgba(255, 255, 255, 0.8),
        inset 0 -2px 0 rgba(239, 68, 68, 0.2),
        0 0 80px rgba(239, 68, 68, 0.35);
}
        
       .flight-card.urgent { 
    background: rgba(239, 68, 68, 0.08);
    backdrop-filter: none;
    -webkit-backdrop-filter: none;
    border: 1px solid rgba(239, 68, 68, 0.35);
    box-shadow: 
        0 10px 35px rgba(239, 68, 68, 0.25),
        inset 0 1px 0 rgba(255, 255, 255, 0.7),
        inset 0 -1px 0 rgba(239, 68, 68, 0.1);
}

.flight-card.urgent::before {
    background: linear-gradient(
        135deg,
        rgba(239, 68, 68, 0.18) 0%,
        rgba(255, 255, 255, 0.12) 50%,
        rgba(239, 68, 68, 0.12) 100%
    );
}

.flight-card.urgent:hover {
    transform: translateY(-4px) scale(1.01);
    box-shadow: 
        0 16px 50px rgba(239, 68, 68, 0.35),
        inset 0 1px 0 rgba(255, 255, 255, 0.85),
        inset 0 -1px 0 rgba(239, 68, 68, 0.15);
}
        
       .flight-card.closing { 
    background: rgba(245, 158, 11, 0.08);
    backdrop-filter: none;
    -webkit-backdrop-filter: none;
    border: 1px solid rgba(245, 158, 11, 0.35);
    box-shadow: 
        0 10px 35px rgba(245, 158, 11, 0.25),
        inset 0 1px 0 rgba(255, 255, 255, 0.7),
        inset 0 -1px 0 rgba(245, 158, 11, 0.1);
}

.flight-card.closing::before {
    background: linear-gradient(
        135deg,
        rgba(245, 158, 11, 0.18) 0%,
        rgba(255, 255, 255, 0.12) 50%,
        rgba(245, 158, 11, 0.12) 100%
    );
}

.flight-card.closing:hover {
    transform: translateY(-4px) scale(1.01);
    box-shadow: 
        0 16px 50px rgba(245, 158, 11, 0.35),
        inset 0 1px 0 rgba(255, 255, 255, 0.85),
        inset 0 -1px 0 rgba(245, 158, 11, 0.15);
}
        
       .flight-card.open { 
    background: rgba(16, 185, 129, 0.06);
    backdrop-filter: none;
    -webkit-backdrop-filter: none;
    border: 1px solid rgba(16, 185, 129, 0.3);
    box-shadow: 
        0 8px 32px rgba(16, 185, 129, 0.18),
        inset 0 1px 0 rgba(255, 255, 255, 0.7),
        inset 0 -1px 0 rgba(16, 185, 129, 0.08);
}

.flight-card.open::before {
    background: linear-gradient(
        135deg,
        rgba(16, 185, 129, 0.15) 0%,
        rgba(255, 255, 255, 0.12) 50%,
        rgba(16, 185, 129, 0.1) 100%
    );
}

.flight-card.open:hover {
    transform: translateY(-3px) scale(1.01);
    box-shadow: 
        0 14px 45px rgba(16, 185, 129, 0.25),
        inset 0 1px 0 rgba(255, 255, 255, 0.85),
        inset 0 -1px 0 rgba(16, 185, 129, 0.12);
}
        .flight-card.not-open { 
    background: rgba(156, 163, 175, 0.08);
    backdrop-filter: none;
    -webkit-backdrop-filter: none;
    border: 1px solid rgba(156, 163, 175, 0.3);
    box-shadow: 
        0 8px 32px rgba(156, 163, 175, 0.15),
        inset 0 1px 0 rgba(255, 255, 255, 0.6),
        inset 0 -1px 0 rgba(0, 0, 0, 0.05);
    opacity: 0.75;
}

.flight-card.not-open::before {
    background: linear-gradient(
        135deg,
        rgba(156, 163, 175, 0.15) 0%,
        rgba(255, 255, 255, 0.1) 50%,
        rgba(156, 163, 175, 0.1) 100%
    );
}

.flight-card.not-open:hover {
    transform: translateY(-2px) scale(1.005);
    opacity: 0.85;
}
        
       .flight-card.closed { 
    background: rgba(107, 114, 128, 0.08);
    backdrop-filter: none;
    -webkit-backdrop-filter: none;
    border: 1px solid rgba(107, 114, 128, 0.3);
    box-shadow: 
        0 8px 32px rgba(107, 114, 128, 0.15),
        inset 0 1px 0 rgba(255, 255, 255, 0.5),
        inset 0 -1px 0 rgba(0, 0, 0, 0.05);
    opacity: 0.65;
}

.flight-card.closed::before {
    background: linear-gradient(
        135deg,
        rgba(107, 114, 128, 0.15) 0%,
        rgba(255, 255, 255, 0.08) 50%,
        rgba(107, 114, 128, 0.1) 100%
    );
}

.flight-card.closed:hover {
    transform: translateY(-2px) scale(1.005);
    opacity: 0.75;
}
.flight-card.extended {
    background: rgba(59, 130, 246, 0.12);
    backdrop-filter: none;
    -webkit-backdrop-filter: none;
    border: 2px solid rgba(59, 130, 246, 0.5);
    box-shadow: 
        0 12px 40px rgba(59, 130, 246, 0.3),
        inset 0 2px 0 rgba(255, 255, 255, 0.6),
        inset 0 -2px 0 rgba(59, 130, 246, 0.15),
        0 0 60px rgba(59, 130, 246, 0.25);
}

.flight-card.extended::before {
    background: linear-gradient(
        135deg,
        rgba(59, 130, 246, 0.25) 0%,
        rgba(255, 255, 255, 0.15) 50%,
        rgba(59, 130, 246, 0.2) 100%
    );
}

.flight-card.extended:hover {
    transform: translateY(-5px) scale(1.015);
    box-shadow: 
        0 20px 64px rgba(59, 130, 246, 0.4),
        inset 0 2px 0 rgba(255, 255, 255, 0.8),
        inset 0 -2px 0 rgba(59, 130, 246, 0.2),
        0 0 80px rgba(59, 130, 246, 0.35);
}
        
       .flight-card.cancelled { 
    background: rgba(255, 255, 255, 0.15);
    backdrop-filter: none;
    -webkit-backdrop-filter: none;
    border: 3px solid #dc2626;
    box-shadow: 
        0 12px 45px rgba(220, 38, 38, 0.35),
        inset 0 2px 0 rgba(255, 255, 255, 0.8),
        inset 0 -2px 0 rgba(220, 38, 38, 0.15),
        0 0 60px rgba(220, 38, 38, 0.3);
}

.flight-card.cancelled::before {
    background: linear-gradient(
        135deg,
        rgba(220, 38, 38, 0.2) 0%,
        rgba(255, 255, 255, 0.15) 50%,
        rgba(220, 38, 38, 0.15) 100%
    );
}

.flight-card.cancelled:hover {
    transform: translateY(-4px) scale(1.01);
    box-shadow: 
        0 16px 60px rgba(220, 38, 38, 0.45),
        inset 0 2px 0 rgba(255, 255, 255, 0.9),
        inset 0 -2px 0 rgba(220, 38, 38, 0.2),
        0 0 80px rgba(220, 38, 38, 0.4);
}

/* ==========================================
   DESTINATION WRAPPER & TIMER WRAPPER
   ========================================== */
.destination-glass-wrapper {
    display: flex;
    justify-content: center;
    align-items: center;
    width: 100%;
    flex-shrink: 0;
    margin-bottom: 0.5rem;
}

.timer-content-wrapper {
    width: 100%;
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 0.5rem;
}


/* ACTIVE/OPEN SECTION */
.active-section-card .section-left {
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
}

.active-section-card .flight-number {
    margin-bottom: 0.25rem;
}

.active-section-card .flight-number-glass {
    padding: 0.85rem 1.5rem;  /* <-- Match the global settings we set earlier */
}

.active-section-card .destination-glass {
    font-size: 2.0rem;  /*  Match desktop default */
    padding: 0.85rem 1.5rem;  /*  Match flight-number-glass */
}

/* Align destination and status with flight number height */
.active-section-card .destination-glass-wrapper {
    margin-bottom: 0;
    margin-top: 0;
}

.active-section-card .section-center {
    justify-content: center;  /* <-- Changed from flex-start to center */
    padding-top: 0;
}
/*  FORCE ALL SECTIONS TO CENTER LIKE ACTIVE */
.urgent-section-card .section-center,
.closed-section-card .section-center,
.notopen-section-card .section-center,
.cancelled-section-card .section-center {
    justify-content: center !important;
    padding-top: 0 !important;
}

.urgent-section-card .destination-glass-wrapper,
.closed-section-card .destination-glass-wrapper,
.notopen-section-card .destination-glass-wrapper,
.cancelled-section-card .destination-glass-wrapper {
    margin-bottom: 0 !important;
    margin-top: 0 !important;
}
.active-section-card .section-right {
    display: flex;
    flex-direction: column;
    justify-content: flex-start;
    padding-top: 0;
}

.active-section-card .status-badge-wrapper {
    margin-top: 0;
}

        @keyframes pulse {
            0%, 100% { 
                opacity: 1; 
                box-shadow: 
                    0 8px 32px rgba(239, 68, 68, 0.25),
                    inset 0 1px 0 rgba(255, 255, 255, 0.6),
                    inset 0 -1px 0 rgba(239, 68, 68, 0.1),
                    0 0 40px rgba(239, 68, 68, 0.3);
            }
            50% { 
                opacity: 0.9; 
                box-shadow: 
                    0 12px 48px rgba(239, 68, 68, 0.35),
                    inset 0 1px 0 rgba(255, 255, 255, 0.7),
                    inset 0 -1px 0 rgba(239, 68, 68, 0.15),
                    0 0 50px rgba(239, 68, 68, 0.5);
            }
        }
        
/* Top row - bubbles */
.section-left { 
    grid-column: 1;
    grid-row: 1;
    display: flex;
    align-items: flex-start;
    justify-content: flex-start;
}

.section-center { 
    grid-column: 2;
    grid-row: 1;
    display: flex;
    align-items: flex-start;
    justify-content: center;
}

.section-right-top {
    grid-column: 3;
    grid-row: 1;
    display: flex;
    align-items: flex-start;
    justify-content: flex-end;
}

/* Middle row - timer and info */
.section-timer {
    grid-column: 1 / -1;
    grid-row: 2;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    padding: 1rem 0;
}

/* Bottom row - status and delete */
.section-bottom {
    grid-column: 1 / -1;
    grid-row: 3;
    display: flex;
    justify-content: space-between;
    align-items: center;
    gap: 1rem;
}
        .active-section-card .section-right {
    display: flex;
    flex-direction: column;
    align-items: flex-end;
}

.active-section-card .section-right .permanent-delete-btn {
    width: auto;
    max-width: 100%;
    display: inline-block;
}
        .turnaround-icon {
    font-size: 1.2rem;
    margin-left: 0.5rem;
    letter-spacing: 0.3rem;
    display: inline-block;
}
        
    .flight-number { 
    font-size: 2.0rem;      /*  Match destination */
    font-weight: 900;       /*  Match destination */
    margin-bottom: 0.25rem;
    display: flex;
    align-items: center;
    color: #000345;
}
        .flight-number-glass {
    background: linear-gradient(135deg,
        rgba(255, 255, 255, 0.8) 0%,
        rgba(255, 255, 255, 0.6) 50%,
        rgba(255, 255, 255, 0.8) 100%);
    backdrop-filter: none;
    -webkit-backdrop-filter: none;
    border: 2px solid rgba(255, 255, 255, 0.95);
    border-radius: 0.75rem;
    font-size: 1.8rem;
    font-weight: 900;
    color: #000345;
    padding: 0.85rem 1.5rem;
    box-shadow: 
        0 4px 16px rgba(0, 3, 69, 0.08),
        inset 0 2px 4px rgba(255, 255, 255, 1),
        inset 0 -1px 3px rgba(0, 3, 69, 0.04),
        inset 1px 0 4px rgba(255, 255, 255, 0.9),
        inset -1px 0 4px rgba(0, 3, 69, 0.03);
    position: relative;
    overflow: hidden;
}
.flight-number-glass::before {
    content: '';
    position: absolute;
    top: 0;
    left: -100%;
    width: 100%;
    height: 100%;
    background: linear-gradient(90deg,
        transparent,
        rgba(255, 255, 255, 0.6),
        transparent);
    animation: shimmer 3s ease-in-out infinite;
}

@keyframes shimmer {
    0% { left: -100%; }
    50%, 100% { left: 200%; }
}
.destination-glass {
    background: linear-gradient(135deg,
        rgba(255, 255, 255, 0.85) 0%,
        rgba(255, 255, 255, 0.65) 50%,
        rgba(255, 255, 255, 0.85) 100%);
    backdrop-filter: none;
    -webkit-backdrop-filter: none;
    border: 2px solid rgba(255, 255, 255, 0.95);
    border-radius: 0.75rem;
    padding: 0.85rem 1.5rem;  /*  MATCHED to flight-number-glass */
    box-shadow: 
        0 4px 16px rgba(0, 3, 69, 0.08),
        inset 0 2px 4px rgba(255, 255, 255, 1),
        inset 0 -1px 3px rgba(0, 3, 69, 0.04),
        inset 1px 0 4px rgba(255, 255, 255, 0.9),
        inset -1px 0 4px rgba(0, 3, 69, 0.03);
    position: relative;
    overflow: hidden;
    display: inline-flex;  /*  Changed from inline-block */
    align-items: center;   /*  Added */
    justify-content: center;  /*  Added */
    font-size: 2.0rem;
    font-weight: 900;  /*  Changed from bold to 900 to match flight number */
    color: #000345;
    flex-shrink: 0;
    white-space: nowrap;  /*  Added */
}
.destination-glass::before {
    content: '';
    position: absolute;
    top: 0;
    left: -100%;
    width: 100%;
    height: 100%;
    background: linear-gradient(90deg,
        transparent,
        rgba(255, 255, 255, 0.7),
        transparent);
    animation: shimmer 3s ease-in-out infinite;
    animation-delay: 1s;
}
/* Close Time Bubble - matches flight number and destination style */
.close-time-glass {
    background: linear-gradient(135deg,
        rgba(255, 255, 255, 0.85) 0%,
        rgba(255, 255, 255, 0.65) 50%,
        rgba(255, 255, 255, 0.85) 100%);
    backdrop-filter: none;
    -webkit-backdrop-filter: none;
    border: 2px solid rgba(255, 255, 255, 0.95);
    border-radius: 0.75rem;
    padding: 1.1rem 1.5rem;
    box-shadow: 
        0 4px 16px rgba(0, 3, 69, 0.08),
        inset 0 2px 4px rgba(255, 255, 255, 1),
        inset 0 -1px 3px rgba(0, 3, 69, 0.04),
        inset 1px 0 4px rgba(255, 255, 255, 0.9),
        inset -1px 0 4px rgba(0, 3, 69, 0.03);
    position: relative;
    overflow: hidden;
    display: inline-flex;
    align-items: center;
    gap: 0.5rem;
    font-size: 1.3rem;
    font-weight: bold;
    color: #000345;
    white-space: nowrap;
}

.close-time-glass::before {
    content: '';
    position: absolute;
    top: 0;
    left: -100%;
    width: 100%;
    height: 100%;
    background: linear-gradient(90deg,
        transparent,
        rgba(255, 255, 255, 0.7),
        transparent);
    animation: shimmer 3s ease-in-out infinite;
    animation-delay: 1.5s;
}

.close-time-label {
    font-size: 1.5rem;
    opacity: 0.8;
    font-weight: 600;
}

.close-time-value {
    font-size: 1.55rem;
    font-weight: bold;
    font-family: monospace;
}
      .destination-glass-wrapper {
    display: flex;
    justify-content: center;
    align-items: center;
    width: 100%;
    margin-bottom: 0.5rem;
}
        
     .destination { 
    font-size: 0.9rem; 
    color: #6b7280; 
    margin-top: 0.25rem;
}


        .times { 
    font-size: 1rem; 
    color: #000345; 
    font-weight: bold; 
    margin: 0.4rem 0;
}
        .times-label { font-size: 0.85rem; color: #6b7280; }
        
        .timer-label { font-size: 1rem; color: #6b7280; margin-bottom: 0.5rem; margin-top: 0.5rem; font-weight: 600; }
.timer { font-size: 4.5rem; font-weight: bold; font-family: monospace; line-height: 1; color: #000345; }
        .progress-bar {
            width: 100%;
            height: 0.5rem;
            background: rgba(0,0,0,0.1);
            border-radius: 9999px;
            overflow: hidden;
            margin-top: 0.5rem;
        }
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #10b981, #14b8a6);
            transition: width 1s;
        }
        .progress-fill.urgent { background: linear-gradient(90deg, #ef4444, #ec4899); }
        .progress-fill.closing { background: linear-gradient(90deg, #eab308, #f97316); }
        
        .status-badge { font-size: 1.5rem; font-weight: bold; padding: 0.5rem 1rem; border-radius: 0.5rem; display: inline-block; position: relative; cursor: pointer; transition: all 0.2s; min-height: 44px; min-width: 44px; display: inline-flex; align-items: center; justify-content: center; }
        .status-badge:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }
        .status-open { background: #10b981; color: white; }
        .status-closing { background: #f59e0b; color: white; }
        .status-urgent { background: #ef4444; color: white; }
        .status-closed { background: #6b7280; color: white; }
        .status-not-open { background: #9ca3af; color: white; }
        .status-cancelled { background: #dc2626; color: white; }
        .status-extended { background: #3b82f6; color: white; }
        
        .status-dropdown {
    position: fixed;
    background: rgba(255, 255, 255, 0.98);
    backdrop-filter: none;
    -webkit-backdrop-filter: none;
    border: 2px solid #000345;
    border-radius: 0.75rem;
    box-shadow: 0 8px 32px rgba(0, 3, 69, 0.3);
    z-index: 10001;
    min-width: 250px;
    /*  Add smooth animation */
    transition: opacity 0.2s ease, transform 0.2s ease;
}

/*  Tablet-specific dropdown styles */
@media only screen and (min-width: 600px) and (max-width: 1024px) {
    .status-dropdown {
        /* Ensure dropdown is properly sized on tablets */
        min-width: 250px;
        max-width: 250px;
        
        /* Add extra shadow for better visibility */
        box-shadow: 0 12px 40px rgba(0, 3, 69, 0.4);
        
        /* Add subtle animation when appearing */
        animation: dropdownFadeIn 0.2s ease;
    }
    
    @keyframes dropdownFadeIn {
        from {
            opacity: 0;
            transform: translateY(10px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }
}

/*  Mobile-specific dropdown styles */
@media only screen and (max-width: 599px) {
    .status-dropdown {
        min-width: 220px;
        max-width: 220px;
        box-shadow: 0 12px 40px rgba(0, 3, 69, 0.4);
    }
}
/*  Add arrow pointing to button (tablet/mobile only) */
@media only screen and (max-width: 1024px) {
    .status-dropdown::after {
        content: '';
        position: absolute;
        bottom: -10px; /* Below the dropdown */
        left: 50%;
        transform: translateX(-50%);
        width: 0;
        height: 0;
        border-left: 10px solid transparent;
        border-right: 10px solid transparent;
        border-top: 10px solid #000345; /* Match dropdown border color */
    }
    
    .status-dropdown::before {
        content: '';
        position: absolute;
        bottom: -8px;
        left: 50%;
        transform: translateX(-50%);
        width: 0;
        height: 0;
        border-left: 8px solid transparent;
        border-right: 8px solid transparent;
        border-top: 8px solid rgba(255, 255, 255, 0.98); /* Match dropdown background */
        z-index: 1;
    }
}
        .status-option {
    padding: 0.75rem 1rem;
    cursor: pointer;
    transition: all 0.2s;
    color: #000345;
    border-bottom: 1px solid rgba(0, 3, 69, 0.1);
    font-weight: 500;
    user-select: none;
}

/*  Tablet: Bigger touch targets */
@media only screen and (min-width: 600px) and (max-width: 1024px) {
    .status-option {
        padding: 1rem 1.25rem; /* Bigger padding for easier tapping */
        font-size: 1rem; /* Slightly larger text */
        min-height: 48px; /* Apple's recommended minimum touch target */
        display: flex;
        align-items: center;
    }
    
    .status-option:active {
        background: rgba(250, 81, 21, 0.25); /* Stronger feedback on tap */
        transform: scale(0.98); /* Subtle press effect */
    }
}

/*  Mobile: Even bigger touch targets */
@media only screen and (max-width: 599px) {
    .status-option {
        padding: 1.1rem 1rem;
        font-size: 0.95rem;
        min-height: 52px;
        display: flex;
        align-items: center;
    }
}
        .status-option:last-child {
            border-bottom: none;
        }
        .status-option:hover {
            background: rgba(250, 81, 21, 0.15);
            color: #FA5115;
        }
        
        .status-badge-wrapper {
            position: relative;
            display: inline-block;
        }
        
        .cancel-reason-dropdown {
            position: fixed;
            left: 50%;
            top: 50%;
            transform: translate(-50%, -50%);
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: none;
            -webkit-backdrop-filter: none;
            border: 2px solid #000345;
            border-radius: 0.75rem;
            box-shadow: 0 8px 32px rgba(0, 3, 69, 0.2);
            z-index: 10000;
            min-width: 300px;
            padding: 1.5rem;
        }
        .cancel-reason-option {
            padding: 0.75rem 1rem;
            cursor: pointer;
            transition: all 0.2s;
            border-radius: 0.5rem;
            margin-bottom: 0.5rem;
            color: #000345;
            background: rgba(0, 3, 69, 0.03);
        }
        .cancel-reason-option:hover {
            background: rgba(250, 81, 21, 0.1);
            color: #FA5115;
        }
        .custom-reason-input {
            width: 100%;
            padding: 0.75rem;
            border: 2px solid #000345;
            border-radius: 0.5rem;
            margin-top: 0.5rem;
            font-family: inherit;
            background: rgba(255, 255, 255, 0.9);
        }
        .custom-reason-input:focus {
            outline: none;
            border-color: #FA5115;
        }
        
        .editable {
            cursor: text;
            padding: 0.1rem 0.3rem;
            border-radius: 0.25rem;
            transition: background 0.2s;
        }
        .editable:hover {
            background: rgba(250, 81, 21, 0.1);
        }
        .editable:focus {
            outline: 2px solid #FA5115;
            background: white;
        }
        
       .cancel-reason-display { 
    font-size: 1.2rem; 
    color: #dc2626; 
    margin-top: 0.5rem;
    font-weight: 600;
    text-align: center; /* ADD THIS */
}
        
        #loading { text-align: center; padding: 3rem; color: #6b7280; }
        
        .section-title {
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            color: #000345;
        }
        
        .overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 3, 69, 0.3);
            backdrop-filter: blur(4px);
            -webkit-backdrop-filter: blur(4px);
            z-index: 9999;
        }
        
       .comments-section {
    display: none;
    background: rgba(255, 255, 255, 0.15);
    backdrop-filter: none;
    -webkit-backdrop-filter: none;
    border: 1px solid rgba(255, 255, 255, 0.4);
    border-radius: 1.5rem;
    padding: 1.5rem;
    margin-bottom: 2rem;
    box-shadow: 
        0 8px 32px rgba(0, 3, 69, 0.15),
        inset 0 1px 0 rgba(255, 255, 255, 0.8),
        inset 0 -1px 0 rgba(0, 0, 0, 0.05);
    position: relative;
    overflow: hidden;
    transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
}

.comments-section::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    border-radius: 1.5rem;
    background: linear-gradient(
        135deg,
        rgba(255, 255, 255, 0.4) 0%,
        rgba(255, 255, 255, 0.05) 50%,
        rgba(255, 255, 255, 0.2) 100%
    );
    pointer-events: none;
    z-index: 0;
}

.comments-section > * {
    position: relative;
    z-index: 1;
}

.comments-section:hover {
    transform: translateY(-2px) scale(1.005);
    box-shadow: 
        0 16px 48px rgba(0, 3, 69, 0.2),
        inset 0 1px 0 rgba(255, 255, 255, 0.9),
        inset 0 -1px 0 rgba(0, 0, 0, 0.08);
    backdrop-filter: none;
    -webkit-backdrop-filter: none;
}

.comments-section::after {
    content: '';
    position: absolute;
    top: -50%;
    left: -50%;
    width: 200%;
    height: 200%;
    background: radial-gradient(
        circle,
        rgba(255, 255, 255, 0.3) 0%,
        transparent 70%
    );
    opacity: 0;
    transition: opacity 0.4s, transform 0.4s;
    pointer-events: none;
    z-index: 0;
}

.comments-section:hover::after {
    opacity: 1;
    animation: liquidDistortion 3s ease-in-out infinite;
}

@keyframes liquidDistortion {
    0%, 100% { 
        transform: translate(0, 0) scale(1);
    }
    25% { 
        transform: translate(10px, -10px) scale(1.05);
    }
    50% { 
        transform: translate(-5px, 10px) scale(0.98);
    }
    75% { 
        transform: translate(15px, 5px) scale(1.03);
    }
}
        
        .comments-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }
        
        .comments-title {
            font-size: 1.5rem;
            font-weight: bold;
            color: #000345;
        }
        
        .comments-actions {
            display: flex;
            gap: 0.5rem;
        }
        
        .add-comment-btn, .delete-all-btn {
            background: #FA5115;
            color: white;
            padding: 0.5rem 1rem;
            border-radius: 0.5rem;
            border: none;
            font-size: 0.9rem;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s;
        }
        
        .delete-all-btn {
            background: #dc2626;
        }
        
        .add-comment-btn:hover {
            background: #e04510;
            transform: translateY(-1px);
        }
        
        .delete-all-btn:hover {
            background: #b91c1c;
            transform: translateY(-1px);
        }
        
        .comment-card {
    background: rgba(255, 255, 255, 0.25);
    backdrop-filter: none;
    -webkit-backdrop-filter: none;
    border: 1px solid rgba(255, 255, 255, 0.5);
    border-radius: 0.75rem;
    padding: 1rem;
    margin-bottom: 0.75rem;
    position: relative;
    transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
    box-shadow: 
        0 4px 16px rgba(0, 3, 69, 0.08),
        inset 0 1px 0 rgba(255, 255, 255, 0.6);
    overflow: hidden;
}

.comment-card:hover {
    transform: translateY(-3px) scale(1.01);
    box-shadow: 
        0 8px 24px rgba(0, 3, 69, 0.15),
        inset 0 1px 0 rgba(255, 255, 255, 0.8);
    backdrop-filter: none;
    -webkit-backdrop-filter:none;
}
        
        .comment-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.5rem;
        }
        
        .comment-timestamp {
            font-size: 0.8rem;
            color: #6b7280;
            font-weight: 600;
        }
        
      .comment-delete { background: #dc2626; color: white; border: none; border-radius: 50%; width: 32px; height: 32px; font-size: 1.1rem; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: all 0.2s; font-weight: bold; }
        
        .comment-delete:hover {
            background: #b91c1c;
            transform: scale(1.1);
        }
        
        .comment-text {
            color: #1f2937;
            font-size: 0.95rem;
            line-height: 1.5;
            cursor: pointer;
            padding: 0.25rem;
            border-radius: 0.25rem;
            transition: background 0.2s;
        }
        
        .comment-text:hover {
            background: rgba(250, 81, 21, 0.05);
        }
        
        .comment-text[contenteditable="true"] {
            background: white;
            border: 2px solid #FA5115;
            padding: 0.5rem;
        }
        
        .comment-input-modal {
            position: fixed;
            left: 50%;
            top: 50%;
            transform: translate(-50%, -50%);
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: none;
            -webkit-backdrop-filter: none;
            border: 2px solid #000345;
            border-radius: 0.75rem;
            box-shadow: 0 8px 32px rgba(0, 3, 69, 0.2);
            z-index: 10000;
            width: 90%;
            max-width: 500px;
            padding: 1.5rem;
        }
        
        .comment-input-title {
            font-size: 1.2rem;
            font-weight: bold;
            color: #000345;
            margin-bottom: 1rem;
        }
        
        .comment-textarea {
            width: 100%;
            min-height: 100px;
            padding: 0.75rem;
            border: 2px solid #000345;
            border-radius: 0.5rem;
            font-family: inherit;
            font-size: 0.95rem;
            resize: vertical;
            margin-bottom: 1rem;
        }
        
        .comment-textarea:focus {
            outline: none;
            border-color: #FA5115;
        }
        
        .comment-input-actions {
            display: flex;
            gap: 0.5rem;
            justify-content: flex-end;
        }
        
        .comment-save-btn, .comment-cancel-btn {
            padding: 0.5rem 1.5rem;
            border-radius: 0.5rem;
            border: none;
            font-size: 0.9rem;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s;
        }
        
        .comment-save-btn {
            background: #FA5115;
            color: white;
        }
        
        .comment-cancel-btn {
            background: #6b7280;
            color: white;
        }
        
        .comment-save-btn:hover {
            background: #e04510;
        }
        
        .comment-cancel-btn:hover {
            background: #4b5563;
        }
        
        .no-comments {
            text-align: center;
            color: #6b7280;
            padding: 2rem;
            font-style: italic;
        }
        .editing-warning-modal {
            position: fixed;
            left: 50%;
            top: 50%;
            transform: translate(-50%, -50%);
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: none;
            -webkit-backdrop-filter: none;
            border: 2px solid #f59e0b;
            border-radius: 0.75rem;
            box-shadow: 0 8px 32px rgba(245, 158, 11, 0.3);
            z-index: 10001;
            padding: 2rem;
            max-width: 400px;
            text-align: center;
        }
        
        .editing-warning-title {
            font-size: 1.3rem;
            font-weight: bold;
            color: #f59e0b;
            margin-bottom: 1rem;
        }
        
        .editing-warning-text {
            color: #000345;
            margin-bottom: 1.5rem;
            line-height: 1.5;
        }
        
        .editing-warning-btn {
            background: #f59e0b;
            color: white;
            padding: 0.5rem 1.5rem;
            border-radius: 0.5rem;
            border: none;
            font-size: 0.9rem;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s;
        }
        
        .editing-warning-btn:hover {
            background: #d97706;
        }
        
        .date-mismatch-modal {
            position: fixed;
            left: 50%;
            top: 50%;
            transform: translate(-50%, -50%);
            background: rgba(255, 255, 255, 0.98);
            backdrop-filter: none;
            -webkit-backdrop-filter: none;
            border: 3px solid #f59e0b;
            border-radius: 1rem;
            box-shadow: 0 12px 48px rgba(245, 158, 11, 0.4);
            z-index: 10002;
            padding: 2.5rem;
            max-width: 500px;
            width: 90%;
        }
        
        .date-mismatch-title {
            font-size: 1.5rem;
            font-weight: bold;
            color: #f59e0b;
            margin-bottom: 1rem;
            text-align: center;
        }
        
        .date-mismatch-text {
            color: #000345;
            margin-bottom: 1.5rem;
            line-height: 1.6;
            font-size: 1rem;
        }
        
        .date-mismatch-actions {
            display: flex;
            gap: 1rem;
            justify-content: center;
        }
        
        .date-mismatch-btn {
            padding: 0.75rem 2rem;
            border-radius: 0.5rem;
            border: none;
            font-size: 1rem;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s;
        }
        
        .date-mismatch-btn.continue {
            background: #10b981;
            color: white;
        }
        
        .date-mismatch-btn.cancel {
            background: #6b7280;
            color: white;
        }
        
        .date-mismatch-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
        }
        .section-container {
    margin-bottom: 2rem;
}

.section-header {
    background: rgba(0, 3, 69, 0.9);
    backdrop-filter: blur(30px);
    -webkit-backdrop-filter: blur(30px);
    border: 1px solid rgba(255, 255, 255, 0.3);
    border-radius: 0.75rem;
    padding: 1rem 1.5rem;
    cursor: pointer;
    display: flex;
    justify-content: space-between;
    align-items: center;
    transition: all 0.3s;
    margin-bottom: 0.5rem;
    box-shadow: 0 4px 12px rgba(0, 3, 69, 0.3);
}

.section-header:hover {
    background: rgba(0, 3, 69, 0.95);
    transform: translateY(-2px);
    box-shadow: 0 6px 16px rgba(0, 3, 69, 0.4);
}

.section-header-left {
    display: flex;
    align-items: center;
    gap: 0.75rem;
}

.section-header-title {
    font-size: 1.3rem;
    font-weight: bold;
    color: white;
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

.section-header-count {
    background: rgba(250, 81, 21, 0.9);
    color: white;
    padding: 0.25rem 0.75rem;
    border-radius: 9999px;
    font-size: 0.875rem;
    font-weight: 600;
}

.section-toggle {
    background: rgba(255, 255, 255, 0.2);
    color: white;
    border: none;
    border-radius: 50%;
    width: 28px;
    height: 28px;
    font-size: 0.9rem;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.3s ease;
    font-weight: bold;
    transform: rotate(0deg);
}

.section-toggle:hover {
    background: rgba(255, 255, 255, 0.3);
    transform: scale(1.1);
}

.section-content {
    overflow: visible;
    transition: max-height 0.4s ease-out, opacity 0.3s ease-out;
    max-height: 0;
    opacity: 0;
}

.section-content.expanded {
    max-height: 50000px;
    opacity: 1;
    padding-top: 0.5rem;
}

.turnaround-icon {
    font-size: 0.85rem;
    margin-left: 0.5rem;
    display: inline-flex;
    align-items: center;
    white-space: nowrap;
}
.deleted-flights-section {
    background: rgba(220, 38, 38, 0.1);
    backdrop-filter: blur(40px) saturate(180%);
    -webkit-backdrop-filter: blur(40px) saturate(180%);
    border: 2px solid rgba(220, 38, 38, 0.4);
    border-radius: 1.5rem;
    padding: 1.5rem;
    margin-bottom: 2rem;
    box-shadow: 
        0 8px 32px rgba(220, 38, 38, 0.15),
        inset 0 1px 0 rgba(255, 255, 255, 0.8);
}

.deleted-flights-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 1rem;
}

.deleted-flights-title {
    font-size: 1.5rem;
    font-weight: bold;
    color: #dc2626;
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

.deleted-flight-card {
    background: rgba(255, 255, 255, 0.5);
    backdrop-filter: none;
    -webkit-backdrop-filter: none;
    border: 1px solid rgba(220, 38, 38, 0.3);
    border-radius: 0.75rem;
    padding: 1rem;
    margin-bottom: 0.75rem;
    display: grid;
    grid-template-columns: 2fr 1fr 1fr;
    gap: 1rem;
    align-items: center;
}

.deleted-flight-info {
    display: flex;
    flex-direction: column;
    gap: 0.25rem;
}

.deleted-flight-number {
    font-size: 1.2rem;
    font-weight: bold;
    color: #dc2626;
}

.deleted-flight-details {
    font-size: 0.9rem;
    color: #6b7280;
}

.deleted-flight-timestamp {
    font-size: 0.85rem;
    color: #9ca3af;
    font-style: italic;
}

.restore-btn {
    background: #10b981;
    color: white;
    padding: 0.5rem 1rem;
    border-radius: 0.5rem;
    border: none;
    font-size: 0.9rem;
    cursor: pointer;
    font-weight: bold;
    transition: all 0.3s;
}

.restore-btn:hover {
    background: #059669;
    transform: translateY(-1px);
}

.permanent-delete-btn {
    background: #dc2626;
    color: white;
    padding: 0.75rem 1.5rem;
    border-radius: 0.5rem;
    border: none;
    font-size: 1.0rem;
    cursor: pointer;
    font-weight: bold;
    transition: all 0.3s;
}

.permanent-delete-btn:hover {
    background: #b91c1c;
    transform: translateY(-1px);
}

.restore-modal {
    position: fixed;
    left: 50%;
    top: 50%;
    transform: translate(-50%, -50%);
    background: rgba(255, 255, 255, 0.98);
    backdrop-filter: none;
    -webkit-backdrop-filter: none;
    border: 2px solid #000345;
    border-radius: 0.75rem;
    box-shadow: 0 8px 32px rgba(0, 3, 69, 0.3);
    z-index: 10000;
    min-width: 300px;
    padding: 1.5rem;
}

.restore-modal-title {
    font-size: 1.2rem;
    font-weight: bold;
    color: #000345;
    margin-bottom: 1rem;
    text-align: center;
}

.restore-option {
    padding: 0.75rem 1rem;
    cursor: pointer;
    transition: all 0.2s;
    border-radius: 0.5rem;
    margin-bottom: 0.5rem;
    color: #000345;
    background: rgba(0, 3, 69, 0.03);
    border: 1px solid rgba(0, 3, 69, 0.1);
}

.restore-option:hover {
    background: rgba(16, 185, 129, 0.15);
    border-color: #10b981;
    color: #10b981;
}

.no-deleted-flights {
    text-align: center;
    color: #6b7280;
    padding: 2rem;
    font-style: italic;
}

.clear-all-deleted-btn {
    background: #6b7280;
    color: white;
    padding: 0.5rem 1rem;
    border-radius: 0.5rem;
    border: none;
    font-size: 0.9rem;
    cursor: pointer;
    font-weight: bold;
    transition: all 0.3s;
}

.clear-all-deleted-btn:hover {
    background: #4b5563;
    transform: translateY(-1px);
}

.cancellation-notification {
    position: fixed;
    left: 50%;
    top: 50%;
    transform: translate(-50%, -50%);
    background: rgba(255, 255, 255, 0.98);
    backdrop-filter: blur(30px);
    -webkit-backdrop-filter: blur(30px);
    border: 3px solid #dc2626;
    border-radius: 1rem;
    box-shadow: 0 20px 60px rgba(220, 38, 38, 0.5);
    z-index: 10004;
    padding: 2rem;
    max-width: 500px;
    width: 90%;
}

.cancellation-notification-header {
    display: flex;
    align-items: center;
    justify-content: center;
    margin-bottom: 1.5rem;
    padding-bottom: 1rem;
    border-bottom: 2px solid rgba(220, 38, 38, 0.3);
}

.cancellation-notification-body {
    margin-bottom: 1.5rem;
}

.cancellation-detail {
    display: flex;
    justify-content: space-between;
    padding: 0.75rem 0;
    border-bottom: 1px solid rgba(0, 3, 69, 0.1);
}

.cancellation-label {
    font-weight: 600;
    color: #6b7280;
}

.cancellation-value {
    font-weight: bold;
    color: #000345;
}

.cancellation-reason {
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
    margin-top: 1rem;
    padding: 1rem;
    background: rgba(220, 38, 38, 0.05);
    border-radius: 0.5rem;
    border: 1px solid rgba(220, 38, 38, 0.2);
}

.cancellation-value-reason {
    font-weight: bold;
    color: #dc2626;
    font-size: 1.1rem;
}

.cancellation-acknowledge-btn {
    width: 100%;
    background: #dc2626;
    color: white;
    padding: 1rem 2rem;
    border-radius: 0.75rem;
    border: none;
    font-size: 1.1rem;
    cursor: pointer;
    font-weight: bold;
    transition: all 0.3s;
    box-shadow: 0 4px 12px rgba(220, 38, 38, 0.3);
}

.cancellation-acknowledge-btn:hover {
    background: #b91c1c;
    transform: translateY(-2px);
    box-shadow: 0 6px 16px rgba(220, 38, 38, 0.5);
}

.comment-notification-popup {
    position: fixed;
    right: 2rem;
    bottom: 2rem;
    background: rgba(255, 255, 255, 0.98);
    backdrop-filter: blur(30px);
    -webkit-backdrop-filter: blur(30px);
    border: 2px solid rgba(59, 130, 246, 0.5);
    border-radius: 1rem;
    box-shadow: 0 12px 40px rgba(59, 130, 246, 0.3);
    z-index: 9999;
    padding: 1.5rem;
    max-width: 350px;
    width: 90%;
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
}

.comment-notification-header {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    margin-bottom: 1rem;
    padding-bottom: 0.75rem;
    border-bottom: 2px solid rgba(59, 130, 246, 0.2);
}

.comment-notification-icon {
    font-size: 1.8rem;
    animation: gentlePulse 2s ease-in-out infinite;
}

@keyframes gentlePulse {
    0%, 100% { transform: scale(1); opacity: 1; }
    50% { transform: scale(1.1); opacity: 0.8; }
}

.comment-notification-title {
    font-size: 1.1rem;
    font-weight: bold;
    color: #3b82f6;
}

.comment-notification-body {
    margin-bottom: 1rem;
}

.comment-notification-time {
    font-size: 0.85rem;
    color: #6b7280;
    margin-bottom: 0.5rem;
    font-weight: 600;
}

.comment-notification-preview {
    color: #1f2937;
    font-size: 0.95rem;
    line-height: 1.5;
    padding: 0.75rem;
    background: rgba(59, 130, 246, 0.05);
    border-radius: 0.5rem;
    border-left: 3px solid #3b82f6;
}

.comment-notification-acknowledge {
    width: 100%;
    background: #3b82f6;
    color: white;
    padding: 0.75rem 1.5rem;
    border-radius: 0.5rem;
    border: none;
    font-size: 0.95rem;
    cursor: pointer;
    font-weight: 600;
    transition: all 0.3s;
    box-shadow: 0 2px 8px rgba(59, 130, 246, 0.3);
}

.comment-notification-acknowledge:hover {
    background: #2563eb;
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(59, 130, 246, 0.4);
}

@media (max-width: 768px) {
    .comment-notification-popup {
        right: 1rem;
        bottom: 1rem;
        max-width: calc(100% - 2rem);
    }
}
.early-open-btn {
    background: linear-gradient(135deg, #000345, #001a6e);
    box-shadow: 0 4px 12px rgba(0, 3, 69, 0.3);
}

.early-open-btn:hover {
    background: linear-gradient(135deg, #001a6e, #000345);
    transform: translateY(-2px);
    box-shadow: 0 6px 16px rgba(0, 3, 69, 0.5);
}
.early-open-indicator {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    background: #fbbf24;
    color: #000345;
    width: 24px;
    height: 24px;
    border-radius: 50%;
    font-size: 0.9rem;
    margin-left: 0.5rem;
    animation: indicatorPulse 2s ease-in-out infinite;
    cursor: pointer;
    transition: all 0.3s;
}

.early-open-indicator:hover {
    background: #f59e0b;
    transform: scale(1.2);
}

@keyframes indicatorPulse {
    0%, 100% { 
        box-shadow: 0 0 0 0 rgba(251, 191, 36, 0.7);
    }
    50% { 
        box-shadow: 0 0 0 8px rgba(251, 191, 36, 0);
    }
}

.early-open-status-popup {
    position: fixed;
    left: 50%;
    top: 50%;
    transform: translate(-50%, -50%);
    background: rgba(255, 255, 255, 0.98);
    backdrop-filter: none;
    -webkit-backdrop-filter: none;
    border: 2px solid #fbbf24;
    border-radius: 0.75rem;
    box-shadow: 0 8px 32px rgba(251, 191, 36, 0.3);
    z-index: 10000;
    padding: 2rem;
    max-width: 400px;
    width: 90%;
    text-align: center;
}

.early-open-status-title {
    font-size: 1.3rem;
    font-weight: bold;
    color: #000345;
    margin-bottom: 1rem;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 0.5rem;
}

.early-open-status-message {
    font-size: 1.1rem;
    color: #1f2937;
    margin-bottom: 1.5rem;
    line-height: 1.6;
}

.early-open-status-close {
    background: #fbbf24;
    color: #000345;
    padding: 0.75rem 2rem;
    border-radius: 0.5rem;
    border: none;
    font-size: 1rem;
    cursor: pointer;
    font-weight: bold;
    transition: all 0.3s;
}

.early-open-status-close:hover {
    background: #f59e0b;
    transform: translateY(-2px);
}
.early-open-modal {
    position: fixed;
    left: 50%;
    top: 50%;
    transform: translate(-50%, -50%);
    background: rgba(255, 255, 255, 0.98);
    backdrop-filter: none;
    -webkit-backdrop-filter: none;
    border: 2px solid #000345;
    border-radius: 0.75rem;
    box-shadow: 0 8px 32px rgba(0, 3, 69, 0.3);
    z-index: 10000;
    width: 90%;
    max-width: 500px;
    padding: 2rem;
}

.early-open-title {
    font-size: 1.3rem;
    font-weight: bold;
    color: #000345;
    margin-bottom: 1.5rem;
    text-align: center;
}

.early-open-option {
    padding: 1rem;
    margin-bottom: 1rem;
    border: 2px solid #e0e7ff;
    border-radius: 0.5rem;
    cursor: pointer;
    transition: all 0.3s;
    background: rgba(0, 3, 69, 0.03);
}

.early-open-option:hover {
    border-color: #000345;
    background: rgba(0, 3, 69, 0.1);
    transform: translateY(-2px);
}

.early-open-option-title {
    font-weight: bold;
    color: #000345;
    margin-bottom: 0.5rem;
}

.early-open-option-desc {
    font-size: 0.9rem;
    color: #6b7280;
}

.early-open-input-modal {
    position: fixed;
    left: 50%;
    top: 50%;
    transform: translate(-50%, -50%);
    background: rgba(255, 255, 255, 0.98);
    backdrop-filter: none;
    -webkit-backdrop-filter: none;
    border: 2px solid #000345;
    border-radius: 0.75rem;
    box-shadow: 0 8px 32px rgba(0, 3, 69, 0.3);
    z-index: 10001;
    width: 90%;
    max-width: 400px;
    padding: 2rem;
}

.early-open-input-title {
    font-size: 1.2rem;
    font-weight: bold;
    color: #000345;
    margin-bottom: 1rem;
    text-align: center;
}

.early-open-input {
    width: 100%;
    padding: 0.75rem;
    border: 2px solid #000345;
    border-radius: 0.5rem;
    font-family: inherit;
    font-size: 1rem;
    margin-bottom: 1rem;
    text-transform: uppercase;
}

.early-open-input:focus {
    outline: none;
    border-color: #FA5115;
    box-shadow: 0 0 0 3px rgba(250, 81, 21, 0.1);
}

.early-open-actions {
    display: flex;
    gap: 0.5rem;
    justify-content: flex-end;
}

.early-open-confirm, .early-open-cancel {
    padding: 0.75rem 1.5rem;
    border-radius: 0.5rem;
    border: none;
    font-size: 0.95rem;
    cursor: pointer;
    font-weight: bold;
    transition: all 0.3s;
}

.early-open-confirm {
    background: #000345;
    color: white;
}

.early-open-cancel {
    background: #6b7280;
    color: white;
}

.early-open-confirm:hover {
    background: #001a6e;
}

.early-open-cancel:hover {
    background: #4b5563;
}

.early-open-status {
    background: rgba(0, 3, 69, 0.1);
    border: 1px solid #000345;
    border-radius: 0.5rem;
    padding: 0.75rem;
    margin-top: 0.5rem;
    text-align: center;
    font-size: 0.9rem;
    color: #000345;
    font-weight: 600;
}

.stop-extension-btn {
    background: #3b82f6;
    color: white;
    border: none;
    border-radius: 50%;
    width: 48px;
    height: 48px;
    font-size: 1.5rem;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.3s;
    box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
    margin: 1rem auto 0;
}

.stop-extension-btn:hover {
    background: #2563eb;
    transform: scale(1.1);
    box-shadow: 0 6px 16px rgba(59, 130, 246, 0.5);
}

.extension-info-icon {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    background: #3b82f6;
    color: white;
    width: 28px;
    height: 28px;
    border-radius: 50%;
    font-size: 1rem;
    font-weight: bold;
    cursor: pointer;
    transition: all 0.3s;
    margin-left: 0.5rem;
}

.extension-info-icon:hover {
    background: #2563eb;
    transform: scale(1.15);
}

.extension-notification {
    position: fixed;
    top: 2rem;
    right: 2rem;
    background: rgba(255, 255, 255, 0.98);
    backdrop-filter: blur(30px);
    -webkit-backdrop-filter: blur(30px);
    border: 2px solid rgba(59, 130, 246, 0.5);
    border-radius: 1rem;
    box-shadow: 0 12px 40px rgba(59, 130, 246, 0.3);
    z-index: 9999;
    padding: 1.5rem;
    max-width: 350px;
    width: 90%;
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
}

.extension-notification-header {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    margin-bottom: 0.5rem;
}

.extension-notification-icon {
    font-size: 1.8rem;
}

.extension-notification-title {
    font-size: 1.1rem;
    font-weight: bold;
    color: #3b82f6;
}

.extension-notification-body {
    color: #1f2937;
    font-size: 0.95rem;
    line-height: 1.5;
}

.extension-notification-close {
    position: absolute;
    top: 0.75rem;
    right: 0.75rem;
    background: #dc2626;
    color: white;
    border: none;
    border-radius: 50%;
    width: 24px;
    height: 24px;
    font-size: 1rem;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.2s;
    font-weight: bold;
}

.extension-notification-close:hover {
    background: #b91c1c;
    transform: scale(1.1);
}

.extension-info-modal {
    position: fixed;
    left: 50%;
    top: 50%;
    transform: translate(-50%, -50%);
    background: rgba(255, 255, 255, 0.98);
    backdrop-filter: none;
    -webkit-backdrop-filter: none;
    border: 2px solid #3b82f6;
    border-radius: 0.75rem;
    box-shadow: 0 8px 32px rgba(59, 130, 246, 0.3);
    z-index: 10000;
    padding: 2rem;
    max-width: 400px;
    width: 90%;
}

.extension-info-title {
    font-size: 1.3rem;
    font-weight: bold;
    color: #3b82f6;
    margin-bottom: 1rem;
    text-align: center;
}

.extension-info-detail {
    display: flex;
    justify-content: space-between;
    padding: 0.75rem 0;
    border-bottom: 1px solid rgba(0, 3, 69, 0.1);
}

.extension-info-label {
    font-weight: 600;
    color: #6b7280;
}

.extension-info-value {
    font-weight: bold;
    color: #000345;
}

.extension-info-close-btn {
    width: 100%;
    background: #3b82f6;
    color: white;
    padding: 0.75rem 2rem;
    border-radius: 0.5rem;
    border: none;
    font-size: 1rem;
    cursor: pointer;
    font-weight: bold;
    transition: all 0.3s;
    margin-top: 1rem;
}

.extension-info-close-btn:hover {
    background: #2563eb;
    transform: translateY(-2px);
}
#flight-selection-area {
    max-height: 300px;
    overflow-y: auto;
    margin-bottom: 1rem;
}

#flight-selection-area .early-open-option {
    margin-bottom: 0.5rem;
    transition: all 0.2s;
}

#flight-selection-area .early-open-option:hover {
    transform: translateX(5px);
}
/* iPad Mini 8.3" Optimizations */ 
/* iPad Mini 8.3" Optimizations */ 
@media only screen and (min-width: 744px) and (max-width: 834px) and (-webkit-min-device-pixel-ratio: 2) {
    /* Header adjustments */
    .header h1 { 
        font-size: 2.2rem; 
        padding-right: 0; 
    }
    .clock { 
        font-size: 1.3rem; 
    }
    
    /* Flight cards - keep 3 column layout but optimize spacing */
    .flight-card { 
        grid-template-columns: 1fr 1.8fr 1fr; 
        gap: 0.75rem; 
        padding: 1rem; 
        font-size: 0.95rem; 
    }
    
    /*  PERFECT MATCHING: All three bubbles use IDENTICAL styling */
    .flight-number-glass,
    .destination-glass,
    .close-time-glass {
        /* IDENTICAL font sizes */
        font-size: 1.8rem !important;
        font-weight: 900 !important;
        
        /* IDENTICAL padding (vertical and horizontal) */
        padding: 0.85rem 1.5rem !important;
        
        /* IDENTICAL display properties */
        display: inline-flex !important;
        align-items: center !important;
        justify-content: center !important;
        
        /* IDENTICAL heights */
        min-height: 60px !important;
        
        /* Ensure they're all the same color */
        color: #000345 !important;
    }
    
    /*  FIX: Make close time label and value same size as bubble text */
    .close-time-label {
        font-size: 0.9rem !important;
        opacity: 0.8;
        font-weight: 600 !important;
    }
    
    .close-time-value {
        font-size: 1.8rem !important;
        font-weight: 900 !important;
        font-family: monospace;
    }
    
    /*  NEW: Force section-center (middle column) to be perfectly centered */
    .section-center {
        display: flex !important;
        flex-direction: column !important;
        justify-content: center !important;
        align-items: center !important;
        padding: 0 !important;
        text-align: center !important;  /*  Added */
        width: 100% !important;  /*  Added */
    }
    
    /*  NEW: Force destination wrapper to use full width of center column */
    .destination-glass-wrapper {
        display: flex !important;
        justify-content: center !important;
        align-items: center !important;
        width: 100% !important;  /*  Key: Use FULL width */
        margin: 0 !important;
        padding: 0 !important;
        text-align: center !important;  /*  Added */
    }
    
    /*  NEW: Ensure destination bubble itself is centered */
    .destination-glass {
        margin-left: auto !important;  /*  Added */
        margin-right: auto !important;  /*  Added */
    }
    
    /*  FIX: Turnaround icon - centered and not pushing things */
    .turnaround-icon {
        font-size: 2rem !important;
        letter-spacing: 0.3rem !important;
        margin: 0.5rem auto !important;  /*  Changed 0 to auto */
        display: block !important;
        text-align: center !important;
        width: 100% !important;
    }
    
    /*  NEW: Apply centering to ALL flight card section types */
    .urgent-section-card .section-center,
    .closed-section-card .section-center,
    .notopen-section-card .section-center,
    .cancelled-section-card .section-center,
    .active-section-card .section-center,
    .extended-section-card .section-center {
        justify-content: center !important;
        align-items: center !important;
        padding: 0 !important;
        text-align: center !important;  /*  Added */
        width: 100% !important;  /*  Added */
    }
    
    /*  NEW: Force destination wrapper centering in ALL section types */
    .urgent-section-card .destination-glass-wrapper,
    .closed-section-card .destination-glass-wrapper,
    .notopen-section-card .destination-glass-wrapper,
    .cancelled-section-card .destination-glass-wrapper,
    .active-section-card .destination-glass-wrapper,
    .extended-section-card .destination-glass-wrapper {
        margin: 0 auto !important;  /*  Changed to auto */
        padding: 0 !important;
        width: 100% !important;  /*  Added */
        display: flex !important;  /*  Added */
        justify-content: center !important;  /*  Added */
    }
    
    /*  NEW: Ensure destination glass in all section types is centered */
    .urgent-section-card .destination-glass,
    .closed-section-card .destination-glass,
    .notopen-section-card .destination-glass,
    .cancelled-section-card .destination-glass,
    .active-section-card .destination-glass,
    .extended-section-card .destination-glass {
        margin-left: auto !important;
        margin-right: auto !important;
    }
    
    .timer { 
        font-size: 3.5rem; 
    }
    .timer-label { 
        font-size: 0.9rem; 
    }
    
    /* Button optimizations */
    .upload-btn, .save-btn, .add-flight-btn, .early-open-btn { 
        padding: 0.65rem 1.5rem; 
        font-size: 1rem; 
    }
    
    /* Status badge - bigger for touch */
    .status-badge { 
        font-size: 0.95rem; 
        padding: 0.6rem 1.2rem; 
        min-height: 44px; 
    }
    
    /* Section headers */
    .section-header-title { 
        font-size: 1.2rem; 
    }
    
    /* Search input */
    .search-input { 
        padding: 0.7rem 3rem 0.7rem 1rem; 
        font-size: 0.95rem; 
    }
    
    /* Comments section */
    .comments-title { 
        font-size: 1.3rem; 
    }
    .comment-text { 
        font-size: 0.9rem; 
    }
    
    /* Modal adjustments */
    .cancellation-notification { 
        max-width: 600px; 
        width: 85%; 
    }
    .search-results-modal { 
        max-width: 700px; 
        width: 85%; 
    }
    .add-flight-modal, .early-open-modal, .early-open-input-modal { 
        max-width: 500px; 
        width: 80%; 
    }
    
    /* Notification popups */
    .comment-notification-popup { 
        max-width: 320px; 
        right: 1.5rem; 
        bottom: 1.5rem; 
    }
    .extension-notification { 
        max-width: 320px; 
        top: 1.5rem; 
        right: 1.5rem; 
    }
    
    /* Date validation badge */
    .date-validation-badge { 
        top: 1rem; 
        right: 1rem; 
        font-size: 0.8rem; 
        padding: 0.45rem 0.9rem; 
    }
    .date-validation-badge.success-tick { 
        width: 44px; 
        height: 44px; 
        font-size: 1.4rem; 
    }
}
/* Android Tablets (7-11 inch) */
@media only screen and (min-width: 600px) and (max-width: 1024px) and (orientation: portrait) {
    .destination-glass {
        font-size: 1.8rem !important;
        padding: 0.85rem 1.5rem !important;
        display: inline-flex !important;
        align-items: center !important;
        justify-content: center !important;
    }
    
    .destination-glass-wrapper {
        display: flex !important;
        justify-content: center !important;
        align-items: center !important;
    }
    
    .section-center {
        justify-content: center !important;
    }
}
   /* ==========================================
   PHONE OPTIMIZATIONS (iPhone & Samsung)
   ========================================== */

@media (max-width: 599px) {
    
    /* Container & Layout */
    .container {
        padding: 0.5rem;
    }
    
    body {
        padding: 0;
    }
    
    /* Header */
    .header {
        padding: 1rem;
        margin-bottom: 0.75rem;
        padding-top: 3.5rem;
    }
    
    .header h1 {
        font-size: 1.5rem;
        margin-bottom: 0.25rem;
        padding-right: 60px;
    }
    
    .header p {
        font-size: 0.8rem;
    }
    
    .clock {
        font-size: 1.1rem;
        margin: 0.25rem 0;
    }
    
    .date-badge {
        font-size: 0.75rem;
        padding: 0.4rem 0.8rem;
    }
    
    .date-validation-badge {
        top: 0.25rem;
        right: 0.25rem;
        font-size: 0.75rem;
        padding: 0.4rem 0.8rem;
    }
    
    .date-validation-badge.success-tick {
        width: 40px;
        height: 40px;
        font-size: 1.2rem;
    }
    
    /* Buttons - Stack vertically on phones */
    .upload-btn-container {
        flex-direction: column;
        gap: 0.5rem;
        margin-bottom: 1rem;
    }
    
    .upload-btn, .save-btn, .add-flight-btn, .early-open-btn {
        width: 100%;
        padding: 0.75rem;
        font-size: 0.95rem;
    }
    
    /* Search */
    .search-container {
        margin-bottom: 1rem;
    }
    
    .search-input {
        padding: 0.65rem 2.5rem 0.65rem 0.75rem;
        font-size: 0.9rem;
    }
    
    /* FLIGHT CARDS - Stack vertically on phones */
   .flight-card {
        grid-template-columns: 1fr !important;
        grid-template-rows: auto auto auto !important;
        gap: 1rem;
        padding: 1rem;
        margin-bottom: 1rem;
    }
    
    /* Stack bubbles vertically on mobile */
    .section-left,
    .section-center,
    .section-right-top {
        grid-column: 1 !important;
        justify-content: center !important;
    }
    
    .section-left {
        grid-row: 1 !important;
    }
    
    .section-center {
        grid-row: 2 !important;
    }
    
    .section-right-top {
        grid-row: 3 !important;
    }
    
    .section-timer {
        grid-column: 1 !important;
        grid-row: 4 !important;
        padding: 0.5rem 0;
    }
    
    .section-bottom {
        grid-column: 1 !important;
        grid-row: 5 !important;
        flex-direction: column;
        gap: 0.5rem;
    }
    
    /* Rearrange sections for vertical layout */
    .section-left,
    .section-center,
    .section-right {
        text-align: center;
        width: 100%;
    }
    
    .section-left {
        padding-bottom: 1rem;
        border-bottom: 2px solid rgba(0, 3, 69, 0.1);
        margin-bottom: 1rem;
    }
    
    .section-center {
        padding: 1rem 0;
        min-height: auto;
        border-bottom: 2px solid rgba(0, 3, 69, 0.1);
        margin-bottom: 1rem;
    }
    
    .section-right {
        padding-top: 0.5rem;
    }
    
    /* Flight number */
.flight-number {
    font-size: 1.6rem;
    justify-content: center !important;
    margin-bottom: 0.75rem;
    width: 100% !important;
    display: flex !important;
    align-items: center !important;
}

.flight-number-glass {
    padding: 0.6rem 1.5rem;
    display: inline-flex !important;
    margin-left: auto !important;
    margin-right: auto !important;
}
    
    /* Destination */
    .destination-glass {
        font-size: 1.6rem;
        padding: 0.6rem 1.5rem;
        display: inline-block;
    }
    
    .destination-glass-wrapper {
        margin-bottom: 0;
    }
    
    .destination {
        font-size: 0.85rem;
        text-align: center;
        margin-top: 0.5rem;
    }
    
    .turnaround-icon {
    font-size: 2.4rem;
    letter-spacing: 0.5rem;
    display: block;
    text-align: center;
    margin: 0.75rem 0;
    width: 100%;
}
    
    /* Times */
    .times {
        font-size: 0.95rem;
        margin: 0.4rem 0;
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 0.25rem;
    }
    
    .times-label {
        font-size: 0.8rem;
    }
    
    .editable-dep,
    .close-time {
        font-size: 1.1rem;
        font-weight: 700;
    }
    
    /* Timer - Large and centered */
    .timer {
        font-size: 3.5rem;
        line-height: 1.1;
        margin: 0.5rem 0;
    }
    
    .timer-label {
        font-size: 0.9rem;
        margin: 0.5rem 0;
        font-weight: 600;
    }
    
    /* Cancel reason display */
    .cancel-reason-display {
        font-size: 1.1rem;
        line-height: 1.4;
        padding: 0.5rem;
    }
    
    /* Status badge */
    .status-badge {
        font-size: 1rem;
        padding: 0.75rem 1.5rem;
        margin: 0.75rem auto 0.5rem;
        width: 100%;
        max-width: 300px;
        min-height: 48px;
        display: inline-flex !important;
    }
    
    /* Delete button - center it */
    .permanent-delete-btn {
        width: 100%;
        max-width: 200px;
        margin: 0.5rem auto;
        display: block;
    }
    
    /* Progress bar */
    .progress-bar {
        margin-top: 0.75rem;
    }
    
    /* Section Headers */
    .section-header {
        padding: 0.75rem 1rem;
        flex-direction: row;
        align-items: center;
        gap: 0.5rem;
    }
    
    .section-header-left {
        flex: 1;
    }
    
    .section-header-title {
        font-size: 1rem;
        flex-direction: column;
        gap: 0.25rem;
    }
    
    .section-header-title span:first-child {
        font-size: 1.3rem;
    }
    
    .section-header-count {
        font-size: 0.75rem;
        padding: 0.2rem 0.6rem;
    }
    
    .section-toggle {
        position: static;
        transform: none;
    }
    
    /* Comments Section */
    .comments-section {
        padding: 1rem;
        margin-bottom: 1.5rem;
    }
    
    .comments-title {
        font-size: 1.2rem;
    }
    
    .comments-actions {
        flex-direction: column;
        gap: 0.5rem;
        width: 100%;
    }
    
    .add-comment-btn,
    .delete-all-btn {
        width: 100%;
    }
    
    .comment-card {
        padding: 0.75rem;
        margin-bottom: 0.5rem;
    }
    
    .comment-text {
        font-size: 0.85rem;
    }
    
    /* MODALS - Full screen on phones */
    .add-flight-modal,
    .early-open-modal,
    .early-open-input-modal,
    .restore-modal,
    .comment-input-modal,
    .editing-warning-modal,
    .date-mismatch-modal,
    .extension-info-modal {
        width: 95% !important;
        max-width: 95% !important;
        padding: 1.25rem;
        max-height: 90vh;
        overflow-y: auto;
    }
    
    .cancellation-notification {
        width: 95% !important;
        max-width: 95% !important;
        padding: 1.25rem;
    }
    
    .search-results-modal {
        width: 98% !important;
        max-width: 98% !important;
        padding: 1rem;
        max-height: 90vh;
    }
    
    /* Modal titles */
    .add-flight-title,
    .early-open-title,
    .early-open-input-title,
    .restore-modal-title,
    .comment-input-title,
    .editing-warning-title,
    .date-mismatch-title,
    .extension-info-title,
    .cancellation-notification-header span {
        font-size: 1.1rem;
    }
    
    /* Form inputs */
    .form-input,
    .early-open-input,
    .custom-reason-input,
    .comment-textarea {
        padding: 0.65rem;
        font-size: 0.9rem;
    }
    
    /* Form buttons */
    .form-actions,
    .early-open-actions,
    .comment-input-actions,
    .date-mismatch-actions {
        flex-direction: column;
        gap: 0.5rem;
    }
    
    .form-save-btn,
    .form-cancel-btn,
    .early-open-confirm,
    .early-open-cancel,
    .comment-save-btn,
    .comment-cancel-btn,
    .date-mismatch-btn {
        width: 100%;
    }
    
    /* Status dropdown - full width */
    .status-dropdown {
        left: 5% !important;
        right: 5% !important;
        width: 90% !important;
        max-width: 90% !important;
    }
    
    /* Cancel reason dropdown */
    .cancel-reason-dropdown {
        width: 90%;
        max-width: 90%;
    }
    
    /* Notifications - adjust position */
    .comment-notification-popup {
        right: 0.5rem;
        bottom: 0.5rem;
        left: 0.5rem;
        max-width: calc(100% - 1rem);
    }
    
    .extension-notification {
        top: 0.5rem;
        right: 0.5rem;
        left: 0.5rem;
        max-width: calc(100% - 1rem);
    }
    
    /* Deleted flights section */
    .deleted-flights-section {
        padding: 1rem;
    }
    
    .deleted-flight-card {
        grid-template-columns: 1fr;
        gap: 0.5rem;
        padding: 0.75rem;
    }
    
    .restore-btn,
    .permanent-delete-btn {
        width: 100%;
        margin-top: 0.5rem;
    }
    
    /* Extension button */
    .stop-extension-btn {
        width: 40px;
        height: 40px;
        font-size: 1.2rem;
    }
    
    /* Early open indicator */
    .early-open-indicator {
        width: 20px;
        height: 20px;
        font-size: 0.75rem;
    }
    /* CRITICAL: Force center alignment for flight number on ALL mobile devices */
.flight-card .section-left {
    display: flex !important;
    justify-content: center !important;
    align-items: center !important;
    width: 100% !important;
}

.flight-card .section-left .flight-number {
    width: 100% !important;
    display: flex !important;
    justify-content: center !important;
}

.flight-card .section-left .flight-number-glass {
    margin-left: auto !important;
    margin-right: auto !important;
    display: inline-flex !important;
}

/* Also ensure editable span inside is centered */
.flight-card .section-left .flight-number-glass .editable-flight-num {
    text-align: center !important;
    display: block !important;
    width: 100% !important;
}
}

/* Extra small phones (iPhone SE, small Androids) */
@media (max-width: 375px) {
    .header h1 {
        font-size: 1.3rem;
    }
    
    .timer {
        font-size: 2.5rem;
    }
    
    .flight-number {
        font-size: 1.5rem;
    }
    
    .destination-glass {
        font-size: 1.3rem;
    }
}

/* Phone Landscape Mode - Keep it compact */
@media (max-width: 915px) and (max-height: 450px) and (orientation: landscape) {
    .header {
        padding: 0.5rem 1rem;
    }
    
    .header h1 {
        font-size: 1.2rem;
    }
    
    .clock {
        font-size: 0.9rem;
    }
    
    .flight-card {
        grid-template-columns: 1fr 2fr 1fr !important;
        padding: 0.75rem;
    }
    
    .section-left,
    .section-center,
    .section-right {
        text-align: left;
        border-bottom: none;
        padding-bottom: 0;
        margin-bottom: 0;
    }
    
    .section-center {
        text-align: center;
    }
    
    .section-right {
        text-align: right;
    }
    
    .timer {
        font-size: 2.5rem;
    }
    
    .section-container {
        margin-bottom: 0.75rem;
    }
    
    .section-header {
        padding: 0.5rem 1rem;
    }
}
.connection-indicator {
    position: fixed;
    bottom: 1rem;
    left: 1rem;
    background: rgba(255, 255, 255, 0.95);
    border: 2px solid #10b981;
    border-radius: 2rem;
    padding: 0.5rem 1rem;
    display: flex;
    align-items: center;
    gap: 0.5rem;
    font-size: 0.85rem;
    font-weight: 600;
    color: #10b981;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    z-index: 9998;
}
/* ==========================================
   MULTI-TAB WARNING MODAL - ORIGINAL DESIGN
   ========================================== */

.multi-tab-warning-modal {
    position: fixed;
    left: 50%;
    top: 10%;
    transform: translate(-50%, 0);
    background: rgba(0, 3, 69, 0.98);
    backdrop-filter: blur(30px);
    -webkit-backdrop-filter: blur(30px);
    border: 3px solid rgba(255, 255, 255, 0.3);
    border-radius: 2.5rem;
    box-shadow: 
        0 30px 90px rgba(0, 0, 0, 0.5),
        inset 0 1px 0 rgba(255, 255, 255, 0.2);
    z-index: 10005;
    padding: 2rem 2.5rem;
    max-width: 550px;
    width: 90%;
    text-align: center;
    overflow: visible;
}

.multi-tab-warning-modal::before {
    content: '';
    position: absolute;
    top: -2px;
    left: -2px;
    right: -2px;
    bottom: -2px;
    border-radius: 2.5rem;
    background: linear-gradient(135deg, 
        transparent 0%, 
        transparent 30%,
        rgba(255, 255, 255, 0.1) 45%, 
        rgba(255, 255, 255, 0.2) 50%, 
        rgba(255, 255, 255, 0.1) 55%,
        transparent 70%,
        transparent 100%);
    pointer-events: none;
    animation: shimmer 8s linear infinite;
    z-index: -1;
    opacity: 0.6;
}

@keyframes shimmer {
    0% { 
        transform: translateX(-100%) translateY(-100%) rotate(0deg);
    }
    100% { 
        transform: translateX(100%) translateY(100%) rotate(360deg);
    }
}

.multi-tab-warning-modal > * {
    position: relative;
    z-index: 1;
}

.multi-tab-warning-icon {
    font-size: 3.5rem;
    margin-bottom: 1rem;
    display: block;
    animation: warningFloat 3s ease-in-out infinite;
    filter: drop-shadow(0 15px 30px rgba(250, 81, 21, 0.5));
}

@keyframes warningFloat {
    0%, 100% { transform: translateY(0px) scale(1); }
    50% { transform: translateY(-15px) scale(1.1); }
}

.multi-tab-warning-title {
    font-size: 1.75rem;
    font-weight: bold;
    color: white;
    margin-bottom: 1.5rem;
    text-shadow: 0 4px 10px rgba(0, 0, 0, 0.5);
    letter-spacing: 1px;
}

.multi-tab-warning-text {
    color: rgba(255, 255, 255, 0.9);
    margin-bottom: 2rem;
    line-height: 1.8;
    font-size: 1.05rem;
}

.multi-tab-warning-text strong {
    color: #FA5115;
    font-weight: 700;
}

.multi-tab-countdown-container {
    margin: 1.5rem 0;
    padding: 1.25rem;
    background: rgba(255, 255, 255, 0.1);
    border: 2px solid rgba(255, 255, 255, 0.3);
    border-radius: 1.5rem;
    box-shadow: 0 8px 24px rgba(0, 0, 0, 0.2);
}

.multi-tab-countdown-label {
    font-size: 0.9rem;
    color: rgba(255, 255, 255, 0.7);
    margin-bottom: 0.5rem;
    text-transform: uppercase;
    letter-spacing: 1px;
}

.multi-tab-countdown {
    font-size: 3rem;
    font-weight: bold;
    color: white;
    margin: 0.5rem 0;
    font-family: monospace;
    text-shadow: 0 4px 10px rgba(250, 81, 21, 0.5);
    animation: countdownPulse 1s ease-in-out infinite;
}
/* ==========================================
   STALE DATE WARNING MODAL
   ========================================== */
.stale-date-warning-overlay {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(245, 158, 11, 0.95);
    backdrop-filter: blur(10px);
    -webkit-backdrop-filter: blur(10px);
    z-index: 10006;
    display: flex;
    align-items: center;
    justify-content: center;
}

.stale-date-warning-modal {
    position: relative;
    background: rgba(255, 255, 255, 0.98);
    backdrop-filter: blur(30px);
    -webkit-backdrop-filter: blur(30px);
    border: 3px solid #f59e0b;
    border-radius: 2rem;
    box-shadow: 
        0 30px 90px rgba(245, 158, 11, 0.5),
        inset 0 1px 0 rgba(255, 255, 255, 0.2);
    padding: 2.5rem;
    max-width: 600px;
    width: 90%;
    text-align: center;
}

.stale-date-warning-icon {
    font-size: 5rem;
    margin-bottom: 1.5rem;
    display: block;
    animation: warningPulse 2s ease-in-out infinite;
}

.stale-date-warning-title {
    font-size: 2rem;
    font-weight: bold;
    color: #f59e0b;
    margin-bottom: 1.5rem;
    text-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
}

.stale-date-warning-text {
    color: #000345;
    margin-bottom: 1.5rem;
    line-height: 1.8;
    font-size: 1.1rem;
}

.stale-date-warning-text strong {
    color: #dc2626;
    font-weight: 700;
}

.stale-date-info-box {
    background: rgba(245, 158, 11, 0.1);
    border: 2px solid rgba(245, 158, 11, 0.3);
    border-radius: 1rem;
    padding: 1.5rem;
    margin: 1.5rem 0;
}

.stale-date-info-row {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 0.75rem 0;
    border-bottom: 1px solid rgba(245, 158, 11, 0.2);
}

.stale-date-info-row:last-child {
    border-bottom: none;
}

.stale-date-info-label {
    font-weight: 600;
    color: #6b7280;
}

.stale-date-info-value {
    font-weight: bold;
    color: #000345;
    font-size: 1.1rem;
}

.stale-date-warning-actions {
    display: flex;
    gap: 1rem;
    justify-content: center;
    margin-top: 2rem;
    flex-direction: column;
    align-items: center;
}

.stale-date-close-btn {
    padding: 1rem 2rem;
    border-radius: 0.75rem;
    border: none;
    font-size: 1.1rem;
    cursor: pointer;
    font-weight: bold;
    transition: all 0.3s;
    min-width: 280px;
    background: #dc2626;
    color: white;
    box-shadow: 0 4px 12px rgba(220, 38, 38, 0.3);
}

.stale-date-close-btn:hover {
    background: #b91c1c;
    transform: translateY(-2px);
    box-shadow: 0 6px 16px rgba(220, 38, 38, 0.5);
}

@media (max-width: 768px) {
    .stale-date-warning-modal {
        padding: 2rem;
        max-width: 95%;
    }
    
    .stale-date-warning-icon {
        font-size: 3.5rem;
    }
    
    .stale-date-warning-title {
        font-size: 1.5rem;
    }
    
    .stale-date-warning-actions {
        flex-direction: column;
    }
    
    .stale-date-close-btn {
        width: 100%;
    }
}

@keyframes countdownPulse {
    0%, 100% { transform: scale(1); opacity: 1; }
    50% { transform: scale(1.1); opacity: 0.8; }
}

.multi-tab-status-bar-container {
    margin: 1.5rem 0;
}

.multi-tab-status-label {
    font-size: 0.85rem;
    color: rgba(255, 255, 255, 0.7);
    margin-bottom: 0.75rem;
    text-align: left;
}

.multi-tab-status-bar {
    width: 100%;
    height: 1rem;
    background: rgba(255, 255, 255, 0.1);
    border: 2px solid rgba(255, 255, 255, 0.3);
    border-radius: 1rem;
    overflow: hidden;
    box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.3);
}

.multi-tab-status-fill {
    height: 100%;
    width: 100%;
    background: linear-gradient(90deg, #FA5115 0%, #e04510 100%);
    border-radius: 1rem;
    transition: width 1s linear;
    box-shadow: 0 0 20px rgba(250, 81, 21, 0.6);
    position: relative;
    overflow: hidden;
}

.multi-tab-status-fill::before {
    content: '';
    position: absolute;
    top: 0;
    left: -100%;
    width: 100%;
    height: 100%;
    background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.4), transparent);
    animation: statusShimmer 2s infinite;
}

@keyframes statusShimmer {
    0% { left: -100%; }
    100% { left: 200%; }
}

.multi-tab-info {
    background: rgba(250, 81, 21, 0.15);
    border: 2px solid rgba(250, 81, 21, 0.4);
    border-radius: 1rem;
    padding: 0.875rem;
    margin: 1.25rem 0;
    font-size: 0.9rem;
    color: rgba(255, 255, 255, 0.9);
    box-shadow: 0 8px 20px rgba(250, 81, 21, 0.2);
}

.multi-tab-footer {
    color: rgba(255, 255, 255, 0.6);
    font-size: 0.85rem;
    margin-top: 1.5rem;
    font-style: italic;
}

/* Overlay for multi-tab warning */
.overlay.multi-tab-overlay {
    background: rgba(0, 3, 69, 0.85);
    backdrop-filter: blur(10px);
    -webkit-backdrop-filter: blur(10px);
}

/* Responsive adjustments */
@media (max-width: 768px) {
    .multi-tab-warning-modal {
        padding: 2rem 1.5rem;
        max-width: 95%;
        top: 10%;
    }
    
    .multi-tab-warning-icon {
        font-size: 3rem;
    }
    
    .multi-tab-warning-title {
        font-size: 1.5rem;
    }
    
    .multi-tab-countdown {
        font-size: 2.5rem;
    }
}

/* iPad specific */
@media (min-width: 744px) and (max-width: 1024px) {
    .multi-tab-warning-modal {
        top: 15%;
        max-width: 80%;
    }
}

/* Very small screens */
@media (max-width: 480px) {
    .multi-tab-warning-modal {
        top: 5%;
        padding: 1.5rem 1rem;
    }
    
    .multi-tab-warning-title {
        font-size: 1.3rem;
    }
    
    .multi-tab-warning-text {
        font-size: 0.95rem;
    }
    
    .multi-tab-countdown {
        font-size: 2rem;
    }
}
.connection-indicator.syncing {
    border-color: #f59e0b;
    color: #f59e0b;
}

.connection-indicator.error {
    border-color: #ef4444;
    color: #ef4444;
}

.connection-dot {
    width: 8px;
    height: 8px;
    border-radius: 50%;
    background: currentColor;
    animation: connectionPulse 2s ease-in-out infinite;
}

@keyframes connectionPulse {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.5; }
}

/* ============================================
   ACTIVE USER LOGIN SYSTEM STYLES
   ============================================ */

/* Login Overlay - Blocks everything */
.user-login-overlay {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: linear-gradient(135deg, #000345 0%, #1a1a4e 50%, #000345 100%);
    z-index: 20000;
    display: flex;
    align-items: center;
    justify-content: center;
    animation: fadeIn 0.3s ease-out;
}

@keyframes fadeIn {
    from { opacity: 0; }
    to { opacity: 1; }
}

.user-login-modal {
    background: rgba(255, 255, 255, 0.98);
    backdrop-filter: blur(30px);
    -webkit-backdrop-filter: blur(30px);
    border: 3px solid #FA5115;
    border-radius: 2rem;
    box-shadow: 0 30px 90px rgba(250, 81, 21, 0.4);
    padding: 2.5rem;
    max-width: 450px;
    width: 90%;
    text-align: center;
}

.user-login-icon {
    font-size: 4rem;
    margin-bottom: 1rem;
}

.user-login-title {
    font-size: 1.8rem;
    font-weight: bold;
    color: #000345;
    margin-bottom: 0.5rem;
}

.user-login-subtitle {
    color: #6b7280;
    font-size: 0.95rem;
    margin-bottom: 2rem;
}

.user-login-form {
    text-align: left;
}

.login-form-group {
    margin-bottom: 1.25rem;
}

.login-form-label {
    display: block;
    font-weight: 600;
    color: #000345;
    margin-bottom: 0.5rem;
    font-size: 0.95rem;
}

.login-form-input,
.login-form-select {
    width: 100%;
    padding: 0.875rem 1rem;
    border: 2px solid rgba(0, 3, 69, 0.2);
    border-radius: 0.75rem;
    font-size: 1rem;
    color: #000345;
    background: white;
    transition: all 0.3s;
}

.login-form-input:focus,
.login-form-select:focus {
    outline: none;
    border-color: #FA5115;
    box-shadow: 0 0 0 3px rgba(250, 81, 21, 0.2);
}

.login-form-input::placeholder {
    color: #9ca3af;
}

.login-pin-container {
    display: flex;
    gap: 0.75rem;
    justify-content: center;
}

.login-pin-input {
    width: 60px;
    height: 60px;
    text-align: center;
    font-size: 1.5rem;
    font-weight: bold;
    border: 2px solid rgba(0, 3, 69, 0.2);
    border-radius: 0.75rem;
    color: #000345;
    transition: all 0.3s;
}

.login-pin-input:focus {
    outline: none;
    border-color: #FA5115;
    box-shadow: 0 0 0 3px rgba(250, 81, 21, 0.2);
}

.login-pin-note {
    text-align: center;
    font-size: 0.85rem;
    color: #6b7280;
    margin-top: 0.5rem;
}

.user-login-btn {
    width: 100%;
    background: linear-gradient(135deg, #FA5115 0%, #e04510 100%);
    color: white;
    padding: 1rem 2rem;
    border-radius: 0.75rem;
    border: none;
    font-size: 1.1rem;
    cursor: pointer;
    font-weight: bold;
    transition: all 0.3s;
    box-shadow: 0 4px 12px rgba(250, 81, 21, 0.3);
    margin-top: 1rem;
}

.user-login-btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 6px 16px rgba(250, 81, 21, 0.5);
}

.user-login-btn:disabled {
    background: #9ca3af;
    cursor: not-allowed;
    transform: none;
    box-shadow: none;
}

/* Still There Prompt */
.still-there-overlay {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0, 3, 69, 0.95);
    backdrop-filter: blur(10px);
    -webkit-backdrop-filter: blur(10px);
    z-index: 25000;
    display: flex;
    align-items: center;
    justify-content: center;
}

.still-there-modal {
    background: rgba(255, 255, 255, 0.98);
    border: 3px solid #f59e0b;
    border-radius: 2rem;
    box-shadow: 0 30px 90px rgba(245, 158, 11, 0.5);
    padding: 2.5rem;
    max-width: 400px;
    width: 90%;
    text-align: center;
}

.still-there-icon {
    font-size: 4rem;
    margin-bottom: 1rem;
    animation: gentlePulse 2s ease-in-out infinite;
}

.still-there-title {
    font-size: 1.5rem;
    font-weight: bold;
    color: #000345;
    margin-bottom: 1rem;
}

.still-there-countdown {
    font-size: 3rem;
    font-weight: bold;
    color: #f59e0b;
    margin: 1rem 0;
    font-family: monospace;
}

.still-there-btn {
    padding: 1rem 2rem;
    border-radius: 0.75rem;
    border: none;
    font-size: 1rem;
    cursor: pointer;
    font-weight: bold;
    transition: all 0.3s;
    margin: 0.5rem;
}

.still-there-yes {
    background: #10b981;
    color: white;
}

.still-there-no {
    background: #6b7280;
    color: white;
}

/* PIN Verification Modal */
.pin-verify-modal {
    background: rgba(255, 255, 255, 0.98);
    border: 3px solid #3b82f6;
    border-radius: 2rem;
    box-shadow: 0 30px 90px rgba(59, 130, 246, 0.5);
    padding: 2.5rem;
    max-width: 400px;
    width: 90%;
    text-align: center;
}

.pin-verify-title {
    font-size: 1.5rem;
    font-weight: bold;
    color: #000345;
    margin-bottom: 1.5rem;
}

.pin-verify-btn {
    width: 100%;
    background: #3b82f6;
    color: white;
    padding: 1rem;
    border-radius: 0.75rem;
    border: none;
    font-size: 1rem;
    cursor: pointer;
    font-weight: bold;
    margin-top: 1rem;
}

/* ============================================
   ACTIVE USER DASHBOARD STYLES
   ============================================ */

.active-users-dashboard {
    background: rgba(255, 255, 255, 0.95);
    backdrop-filter: blur(20px);
    -webkit-backdrop-filter: blur(20px);
    border: 2px solid rgba(0, 3, 69, 0.2);
    border-radius: 1.5rem;
    margin-bottom: 1.5rem;
    box-shadow: 0 8px 32px rgba(0, 3, 69, 0.1);
    overflow: hidden;
}

.active-users-header {
    background: linear-gradient(135deg, #000345 0%, #1a1a4e 100%);
    color: white;
    padding: 1rem 1.5rem;
    display: flex;
    justify-content: space-between;
    align-items: center;
    cursor: pointer;
    transition: all 0.3s;
}

.active-users-header:hover {
    background: linear-gradient(135deg, #0a0a5e 0%, #2a2a6e 100%);
}

.active-users-title {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    font-size: 1.1rem;
    font-weight: bold;
}

.active-users-count {
    background: #FA5115;
    color: white;
    padding: 0.25rem 0.75rem;
    border-radius: 9999px;
    font-size: 0.9rem;
}

.active-users-toggle {
    background: rgba(255, 255, 255, 0.2);
    border: none;
    color: white;
    width: 32px;
    height: 32px;
    border-radius: 50%;
    font-size: 1.2rem;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.3s;
}

.active-users-toggle:hover {
    background: rgba(255, 255, 255, 0.3);
}

.active-users-content {
    padding: 1.5rem;
    display: none;
}

.active-users-content.expanded {
    display: block;
}

.active-users-location-group {
    margin-bottom: 1.25rem;
}

.active-users-location-group:last-child {
    margin-bottom: 0;
}

.location-header {
    font-weight: bold;
    color: #000345;
    padding: 0.5rem 0;
    border-bottom: 2px solid rgba(0, 3, 69, 0.1);
    margin-bottom: 0.75rem;
    font-size: 0.95rem;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

.location-header.zone-e {
    color: #f97316;
    border-bottom-color: rgba(249, 115, 22, 0.3);
}

.user-card {
    display: flex;
    align-items: center;
    gap: 1rem;
    padding: 0.75rem 1rem;
    background: rgba(0, 3, 69, 0.03);
    border-radius: 0.75rem;
    margin-bottom: 0.5rem;
    border: 1px solid rgba(0, 3, 69, 0.08);
}

.user-card.zone-e {
    background: rgba(249, 115, 22, 0.08);
    border-color: rgba(249, 115, 22, 0.2);
}

.user-card.current-user {
    background: rgba(16, 185, 129, 0.1);
    border-color: rgba(16, 185, 129, 0.3);
}

.user-avatar {
    font-size: 1.5rem;
}

.user-info {
    flex: 1;
}

.user-name {
    font-weight: 600;
    color: #000345;
    font-size: 0.95rem;
}

.user-name.zone-e {
    color: #f97316;
}

.user-details {
    font-size: 0.85rem;
    color: #6b7280;
    display: flex;
    gap: 1rem;
    margin-top: 0.25rem;
}

.user-device {
    display: flex;
    align-items: center;
    gap: 0.25rem;
}

.user-time {
    display: flex;
    align-items: center;
    gap: 0.25rem;
}

/* Current User Location Changer */
.current-user-bar {
    background: linear-gradient(135deg, #10b981 0%, #059669 100%);
    color: white;
    padding: 0.75rem 1.5rem;
    display: flex;
    justify-content: space-between;
    align-items: center;
    flex-wrap: wrap;
    gap: 0.75rem;
}

.current-user-info {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    font-weight: 600;
}

.location-change-container {
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

.location-change-label {
    font-size: 0.9rem;
    opacity: 0.9;
}

.location-change-select {
    padding: 0.5rem 1rem;
    border-radius: 0.5rem;
    border: 2px solid rgba(255, 255, 255, 0.3);
    background: rgba(255, 255, 255, 0.2);
    color: white;
    font-weight: 600;
    font-size: 0.9rem;
    cursor: pointer;
}

.location-change-select option {
    color: #000345;
    background: white;
}

.logout-btn {
    background: rgba(255, 255, 255, 0.2);
    border: 2px solid rgba(255, 255, 255, 0.3);
    color: white;
    padding: 0.5rem 1rem;
    border-radius: 0.5rem;
    font-weight: 600;
    cursor: pointer;
    font-size: 0.85rem;
    transition: all 0.3s;
}

.logout-btn:hover {
    background: rgba(255, 255, 255, 0.3);
}

.no-users-message {
    text-align: center;
    color: #6b7280;
    padding: 2rem;
    font-style: italic;
}

/* Mobile responsive for dashboard */
@media (max-width: 768px) {
    .active-users-header {
        padding: 0.875rem 1rem;
    }
    
    .active-users-title {
        font-size: 1rem;
    }
    
    .active-users-content {
        padding: 1rem;
    }
    
    .user-card {
        padding: 0.625rem 0.75rem;
    }
    
    .current-user-bar {
        flex-direction: column;
        align-items: flex-start;
        padding: 1rem;
    }
    
    .location-change-container {
        width: 100%;
        justify-content: space-between;
    }
    
    .location-change-select {
        flex: 1;
    }
    
    .user-login-modal {
        padding: 1.5rem;
        max-width: 95%;
    }
    
    .login-pin-input {
        width: 50px;
        height: 50px;
        font-size: 1.25rem;
    }
}

/* ============================================
   SUMMARY REPORT EDITOR MODAL STYLES
   ============================================ */

/* ============================================
   PASSWORD MODAL STYLES
   ============================================ */
.password-modal-overlay {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0, 3, 69, 0.95);
    backdrop-filter: blur(10px);
    -webkit-backdrop-filter: blur(10px);
    z-index: 35000;
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 1rem;
}

.password-modal {
    background: white;
    border-radius: 1rem;
    padding: 2rem;
    max-width: 400px;
    width: 90%;
    text-align: center;
    box-shadow: 0 20px 60px rgba(0, 0, 0, 0.4);
}

.password-modal-icon {
    font-size: 3rem;
    margin-bottom: 1rem;
}

.password-modal-title {
    font-size: 1.4rem;
    font-weight: bold;
    color: #000345;
    margin-bottom: 0.5rem;
}

.password-modal-subtitle {
    font-size: 0.9rem;
    color: #6b7280;
    margin-bottom: 1.5rem;
}

.password-input-container {
    margin-bottom: 1.5rem;
}

.password-input {
    width: 100%;
    padding: 0.875rem 1rem;
    border: 2px solid rgba(0, 3, 69, 0.2);
    border-radius: 0.5rem;
    font-size: 1rem;
    text-align: center;
    letter-spacing: 0.1rem;
    transition: border-color 0.3s;
}

.password-input:focus {
    outline: none;
    border-color: #000345;
}

.password-input.error {
    border-color: #dc2626;
    animation: shake 0.5s ease-in-out;
}

@keyframes shake {
    0%, 100% { transform: translateX(0); }
    10%, 30%, 50%, 70%, 90% { transform: translateX(-5px); }
    20%, 40%, 60%, 80% { transform: translateX(5px); }
}

.password-error-msg {
    color: #dc2626;
    font-size: 0.85rem;
    margin-top: 0.5rem;
    display: none;
}

.password-error-msg.visible {
    display: block;
}

.password-modal-buttons {
    display: flex;
    gap: 0.75rem;
}

.password-btn {
    flex: 1;
    padding: 0.875rem 1rem;
    border-radius: 0.5rem;
    font-size: 1rem;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s;
    border: none;
}

.password-btn.cancel {
    background: #6b7280;
    color: white;
}

.password-btn.cancel:hover {
    background: #4b5563;
}

.password-btn.submit {
    background: #000345;
    color: white;
}

.password-btn.submit:hover {
    background: #0a0a5e;
}

/* ============================================
   HANDOVER SAVE/CLEAR BUTTONS & TIMESTAMP STYLES
   ============================================ */
.handover-action-buttons {
    display: flex;
    gap: 0.75rem;
    margin-top: 0.75rem;
}

.handover-action-btn {
    padding: 0.5rem 1.25rem;
    border-radius: 0.5rem;
    font-size: 0.9rem;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s;
    border: none;
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

.handover-action-btn.save {
    background: #059669;
    color: white;
}

.handover-action-btn.save:hover {
    background: #047857;
}

.handover-action-btn.clear {
    background: #dc2626;
    color: white;
}

.handover-action-btn.clear:hover {
    background: #b91c1c;
}

.handover-timestamp-info {
    margin-top: 0.75rem;
    padding: 0.5rem 0.75rem;
    background: rgba(0, 3, 69, 0.05);
    border-radius: 0.375rem;
    font-size: 0.8rem;
    color: #6b7280;
}

.handover-timestamp-info .saved-info {
    color: #059669;
}

.handover-timestamp-info .cleared-info {
    color: #dc2626;
}

/* ============================================
   EXPANDED GRAPH VIEW STYLES (MAGNIFYING GLASS)
   ============================================ */
.magnify-graph-btn {
    background: rgba(0, 3, 69, 0.1);
    border: 1px solid rgba(0, 3, 69, 0.2);
    border-radius: 0.375rem;
    padding: 0.25rem 0.5rem;
    font-size: 0.85rem;
    cursor: pointer;
    transition: all 0.2s;
    margin-left: 0.5rem;
}

.magnify-graph-btn:hover {
    background: rgba(0, 3, 69, 0.2);
    transform: scale(1.05);
}

.expanded-graph-overlay {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0, 3, 69, 0.95);
    backdrop-filter: blur(10px);
    -webkit-backdrop-filter: blur(10px);
    z-index: 40000;
    display: flex;
    flex-direction: column;
    padding: 1rem;
}

.expanded-graph-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 1rem;
    color: white;
}

.expanded-graph-title {
    font-size: 1.5rem;
    font-weight: bold;
}

.expanded-graph-close-btn {
    background: #dc2626;
    color: white;
    border: none;
    padding: 0.75rem 1.5rem;
    border-radius: 0.5rem;
    font-size: 1rem;
    font-weight: bold;
    cursor: pointer;
    transition: all 0.3s;
}

.expanded-graph-close-btn:hover {
    background: #b91c1c;
}

.expanded-graph-container {
    flex: 1;
    background: white;
    border-radius: 1rem;
    margin: 0.5rem;
    padding: 1rem;
    overflow: auto;
    display: flex;
    flex-direction: column;
}

.expanded-graph-wrapper {
    flex: 1;
    overflow: auto;
    display: flex;
    align-items: center;
    justify-content: center;
    touch-action: manipulation;
}

.expanded-graph-svg {
    transition: transform 0.2s ease-out;
}

.expanded-graph-controls {
    display: flex;
    justify-content: center;
    gap: 1rem;
    padding: 1rem;
    background: #f8fafc;
    border-radius: 0.5rem;
    margin-top: 1rem;
}

.zoom-btn {
    background: #000345;
    color: white;
    border: none;
    padding: 0.75rem 1.25rem;
    border-radius: 0.5rem;
    font-size: 0.95rem;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.2s;
}

.zoom-btn:hover {
    background: #0a0a5e;
    transform: scale(1.05);
}

.zoom-btn.reset {
    background: #6b7280;
}

.zoom-btn.reset:hover {
    background: #4b5563;
}

.expanded-graph-hint {
    text-align: center;
    color: #6b7280;
    font-size: 0.85rem;
    margin-top: 0.5rem;
}

/* Bar info popup in expanded view */
.bar-info-popup {
    position: fixed;
    background: white;
    border-radius: 0.75rem;
    box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
    padding: 1rem;
    z-index: 50000;
    min-width: 200px;
}

.bar-info-popup-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 0.75rem;
    padding-bottom: 0.5rem;
    border-bottom: 1px solid #e5e7eb;
}

.bar-info-popup-title {
    font-weight: bold;
    color: #000345;
}

.bar-info-popup-close {
    background: none;
    border: none;
    font-size: 1rem;
    cursor: pointer;
    color: #6b7280;
    font-weight: bold;
}

.bar-info-item {
    display: flex;
    justify-content: space-between;
    padding: 0.375rem 0;
    font-size: 0.9rem;
}

.bar-info-label {
    color: #6b7280;
}

.bar-info-value {
    font-weight: 600;
    color: #000345;
}

/* ============================================
   AI GENERATED SUMMARY PARAGRAPH STYLES
   ============================================ */
.ai-summary-paragraph {
    background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%);
    border-left: 4px solid #0284c7;
    padding: 0.75rem 1rem;
    margin-top: 0.75rem;
    border-radius: 0 0.5rem 0.5rem 0;
    font-size: 0.85rem;
    color: #0c4a6e;
    line-height: 1.5;
}

.ai-summary-label {
    font-weight: 600;
    color: #0369a1;
    margin-bottom: 0.25rem;
    display: block;
    font-size: 0.75rem;
    text-transform: uppercase;
    letter-spacing: 0.05em;
}

/* ============================================
   LEADERSHIP SECTION IN SUMMARY REPORT
   ============================================ */
.leadership-summary-section {
    margin-bottom: 1.25rem;
}

.leadership-summary-table {
    width: 100%;
    border-collapse: collapse;
    font-size: 0.9rem;
}

.leadership-summary-table th {
    background: #f3f4f6;
    padding: 0.5rem 0.75rem;
    text-align: left;
    font-weight: 600;
    color: #374151;
    border: 1px solid #e5e7eb;
}

.leadership-summary-table td {
    padding: 0.5rem 0.75rem;
    border: 1px solid #e5e7eb;
}

.leadership-summary-table td:last-child {
    font-weight: 600;
    color: #000345;
}

.summary-report-overlay {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0, 3, 69, 0.95);
    backdrop-filter: blur(10px);
    -webkit-backdrop-filter: blur(10px);
    z-index: 30000;
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 1rem;
    overflow-y: auto;
}

.summary-report-editor-modal {
    background: white;
    border-radius: 1.5rem;
    box-shadow: 0 30px 90px rgba(0, 0, 0, 0.5);
    max-width: 800px;
    width: 100%;
    max-height: 90vh;
    display: flex;
    flex-direction: column;
    overflow: hidden;
}

.summary-editor-header {
    background: linear-gradient(135deg, #000345 0%, #1a1a4e 100%);
    color: white;
    padding: 1.5rem;
    position: relative;
}

.summary-editor-title {
    font-size: 1.5rem;
    font-weight: bold;
    margin-bottom: 0.25rem;
}

.summary-editor-subtitle {
    font-size: 0.9rem;
    opacity: 0.8;
}

.summary-editor-close {
    position: absolute;
    top: 1rem;
    right: 1rem;
    background: rgba(255, 255, 255, 0.2);
    border: none;
    color: white;
    width: 30px;
    height: 30px;
    border-radius: 50%;
    font-size: 1rem;
    cursor: pointer;
    display: flex;
    font-weight: bold;
    align-items: center;
    justify-content: center;
    transition: all 0.3s;
}

.summary-editor-close:hover {
    background: rgba(255, 255, 255, 0.3);
}

.summary-editor-content {
    padding: 1.5rem;
    overflow-y: auto;
    flex: 1;
}

.summary-editor-section {
    margin-bottom: 0.75rem;
}

.summary-editor-section-title {
    font-weight: bold;
    color: #000345;
    font-size: 1rem;
    margin-bottom: 0.5rem;
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

.summary-editor-help {
    font-size: 0.85rem;
    color: #6b7280;
    margin-bottom: 0.5rem;
}

.summary-editor-textarea {
    width: 100%;
    padding: 0.75rem;
    border: 2px solid rgba(0, 3, 69, 0.2);
    border-radius: 0.5rem;
    font-family: inherit;
    font-size: 0.9rem;
    resize: vertical;
    min-height: 60px;
    transition: border-color 0.3s;
}

.summary-editor-textarea:focus {
    outline: none;
    border-color: #000345;
}

.summary-editor-stats {
    display: flex;
    flex-wrap: wrap;
    justify-content: space-evenly;
    gap: 1rem;
    margin-bottom: 1.25rem;
    padding: 0 1rem;
}

.summary-editor-stats-content {
    display: flex;
    flex-direction: row;
    flex-wrap: wrap;
    justify-content: center;
    gap: 1rem;
    padding: 0.75rem 1.5rem;
}

.summary-stat-box {
    background: #f8fafc;
    border: 1px solid #e5e7eb;
    border-radius: 0.5rem;
    padding: 0.75rem 1rem;
    text-align: center;
    min-width: 100px;
    box-shadow: 0 1px 3px rgba(0,0,0,0.08);
    border-left: 3px solid #d1d5db;
}

.summary-stat-number {
    font-size: 1.75rem;
    font-weight: bold;
    color: #000345;
}

.summary-stat-number.green { color: #059669; }
.summary-stat-number.orange { color: #FA5115; }
.summary-stat-number.red { color: #dc2626; }

.summary-stat-label {
    font-size: 0.75rem;
    color: #6b7280;
    text-transform: uppercase;
}

/* ============================================ */
/* PERFORMANCE & STAFFING SECTION */
/* ============================================ */

.performance-staffing-section {
    margin-bottom: 0.75rem;
}

.performance-staffing-title {
    background: #000345;
    color: white;
    padding: 0.75rem 1rem;
    font-size: 0.85rem;
    font-weight: bold;
    border-radius: 0.5rem 0.5rem 0 0;
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

.performance-staffing-content {
    background: white;
    padding: 0.75rem 1.5rem;
    border-radius: 0 0 0.5rem 0.5rem;
    border: 1px solid #e5e7eb;
    border-top: none;
}

.performance-boxes {
    display: flex;
    flex-direction: row;
    gap: 1.5rem;
    flex-wrap: wrap;
    justify-content: center;
}

.perf-box {
    background: white;
    border-radius: 0.5rem;
    box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    padding: 0.875rem 1rem;
    min-width: 160px;
    border: 1px solid #e5e7eb;
    border-left: 4px solid #6b7280;
    text-align: center;
}

.perf-box.good {
    border-left-color: #22c55e;
    background: #f0fdf4;
}

.perf-box.bad {
    border-left-color: #dc2626;
    background: #fef2f2;
}

.perf-box.neutral {
    border-left-color: #6b7280;
    background: #f9fafb;
}

.perf-box-label {
    font-size: 0.65rem;
    font-weight: 600;
    color: #6b7280;
    text-transform: uppercase;
    letter-spacing: 0.3px;
    margin-bottom: 0.375rem;
}

.perf-box-value {
    font-size: 1.75rem;
    font-weight: bold;
    margin-bottom: 0.125rem;
    display: flex;
    align-items: baseline;
    justify-content: center;
    gap: 2px;
}

.perf-box.good .perf-box-value { color: #059669; }
.perf-box.bad .perf-box-value { color: #dc2626; }
.perf-box.neutral .perf-box-value { color: #374151; }

.perf-box-input {
    width: 50px;
    font-size: 1.75rem;
    font-weight: bold;
    background: transparent;
    border: none;
    border-bottom: 2px dashed currentColor;
    text-align: center;
    color: inherit;
    outline: none;
    padding: 0;
    -moz-appearance: textfield;
}

.perf-box-input::-webkit-outer-spin-button,
.perf-box-input::-webkit-inner-spin-button {
    -webkit-appearance: none;
    margin: 0;
}

.perf-box-input:focus {
    border-bottom-style: solid;
}

.perf-box-meta {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-top: 0.5rem;
    padding-top: 0.5rem;
    border-top: 1px solid #e5e7eb;
    font-size: 0.6rem;
}

.perf-target-label {
    color: #9ca3af;
}

.perf-diff-badge {
    display: inline-flex;
    align-items: center;
    gap: 3px;
    padding: 2px 6px;
    border-radius: 10px;
    font-weight: 600;
    font-size: 0.65rem;
}

.perf-diff-badge.good {
    background: #dcfce7;
    color: #166534;
}

.perf-diff-badge.bad {
    background: #fee2e2;
    color: #dc2626;
}

.perf-diff-badge.on-target {
    background: #dbeafe;
    color: #1e40af;
}

/* CSS Triangle Arrows */
.perf-arrow-up {
    width: 0;
    height: 0;
    border-left: 4px solid transparent;
    border-right: 4px solid transparent;
    border-bottom: 6px solid #166534;
    display: inline-block;
}

.perf-arrow-down {
    width: 0;
    height: 0;
    border-left: 4px solid transparent;
    border-right: 4px solid transparent;
    border-top: 6px solid #dc2626;
    display: inline-block;
}

/* ============================================ */
/* IMPORTANT EVENT MARKER (STAR TOGGLE) */
/* ============================================ */

.event-log-entry-row {
    display: flex;
    align-items: flex-start;
    gap: 0.5rem;
}

.event-star-toggle {
    cursor: pointer;
    font-size: 1.25rem;
    color: #d1d5db;
    transition: all 0.2s;
    padding: 0.25rem;
    background: none;
    border: none;
    line-height: 1;
    flex-shrink: 0;
}

.event-star-toggle:hover {
    color: #fbbf24;
    transform: scale(1.1);
}

.event-star-toggle.active {
    color: #f59e0b;
}

.event-log-entry.important {
    border-left: 4px solid #f59e0b !important;
    background: #fffbeb !important;
}

.event-log-entry.important .event-log-entry-header {
    background: #fef3c7;
}

.important-badge {
    display: inline-block;
    font-size: 0.6rem;
    padding: 2px 6px;
    border-radius: 10px;
    background: #fef3c7;
    color: #92400e;
    font-weight: 600;
    margin-left: 0.25rem;
    vertical-align: middle;
}

/* Weather category badge color */
.event-log-category-badge.weather {
    background: #e0e7ff;
    color: #3730a3;
}

.handover-section {
    background: #ecfdf5;
    border: 2px solid #059669;
    border-radius: 0.75rem;
    padding: 1rem;
}

.handover-question {
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: 1rem;
}

.handover-buttons {
    display: flex;
    gap: 0.5rem;
}

.handover-btn {
    padding: 0.5rem 1.5rem;
    border-radius: 0.5rem;
    border: none;
    font-weight: bold;
    cursor: pointer;
    transition: all 0.3s;
}

.handover-btn.yes {
    background: #059669;
    color: white;
}

.handover-btn.yes:hover {
    background: #047857;
}

.handover-btn.no {
    background: #6b7280;
    color: white;
}

.handover-btn.no:hover {
    background: #4b5563;
}

.handover-input-container {
    margin-top: 0.75rem;
}

/* Firebase Usage Info (Preview Only) */
.firebase-usage-info {
    margin-top: 1.5rem;
    padding: 1rem;
    background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%);
    border: 1px solid #bae6fd;
    border-radius: 0.5rem;
}

.firebase-usage-title {
    font-size: 0.8rem;
    font-weight: 600;
    color: #0369a1;
    margin-bottom: 0.75rem;
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

.firebase-usage-note {
    font-size: 0.7rem;
    color: #64748b;
    margin-top: 0.5rem;
    font-style: italic;
}

.firebase-usage-grid {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 0.75rem;
}

.firebase-usage-item {
    background: white;
    padding: 0.6rem;
    border-radius: 0.375rem;
    text-align: center;
}

.firebase-usage-label {
    font-size: 0.65rem;
    color: #64748b;
    text-transform: uppercase;
    margin-bottom: 0.25rem;
}

.firebase-usage-value {
    font-size: 1rem;
    font-weight: 700;
    color: #0369a1;
}

.firebase-usage-value.warning {
    color: #f59e0b;
}

.firebase-usage-value.danger {
    color: #ef4444;
}

.firebase-usage-bar {
    height: 6px;
    background: #e5e7eb;
    border-radius: 3px;
    margin-top: 0.25rem;
    overflow: hidden;
}

.firebase-usage-bar-fill {
    height: 100%;
    border-radius: 3px;
    background: #22c55e;
    transition: width 0.3s;
}

.firebase-usage-bar-fill.warning {
    background: #f59e0b;
}

.firebase-usage-bar-fill.danger {
    background: #ef4444;
}

.firebase-centralized-badge {
    background: #dcfce7;
    color: #166534;
    font-size: 0.65rem;
    padding: 2px 8px;
    border-radius: 10px;
    margin-left: auto;
    font-weight: 500;
}

.firebase-local-badge {
    background: #fef3c7;
    color: #92400e;
    font-size: 0.65rem;
    padding: 2px 8px;
    border-radius: 10px;
    margin-left: auto;
    font-weight: 500;
}

.firebase-active-devices {
    text-align: center;
    font-size: 0.85rem;
    color: #0369a1;
    margin-top: 0.75rem;
    padding: 0.5rem;
    background: white;
    border-radius: 0.375rem;
}

.firebase-active-devices strong {
    font-size: 1.1rem;
}

/* ============================================
   EVENT LOG SECTION STYLES
   ============================================ */
.event-log-section {
    background: #f8fafc;
    border: 2px solid #000345;
    border-radius: 0.75rem;
    padding: 1rem;
    margin-top: 1rem;
}

.event-log-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 1rem;
    padding-bottom: 0.75rem;
    border-bottom: 2px solid rgba(0, 3, 69, 0.3);
}

.event-log-title {
    font-size: 1.1rem;
    font-weight: bold;
    color: #000345;
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

.event-log-add-btn {
    background: #059669;
    color: white;
    border: none;
    padding: 0.5rem 1rem;
    border-radius: 0.5rem;
    font-weight: bold;
    cursor: pointer;
    display: flex;
    align-items: center;
    gap: 0.5rem;
    transition: all 0.3s;
}

.event-log-add-btn:hover {
    background: #047857;
    transform: translateY(-2px);
}

.event-log-clear-btn {
    background: transparent;
    color: #dc2626;
    border: 2px solid #dc2626;
    padding: 0.5rem 1rem;
    border-radius: 0.5rem;
    font-weight: bold;
    cursor: pointer;
    display: flex;
    align-items: center;
    gap: 0.5rem;
    transition: all 0.3s;
}

.event-log-clear-btn:hover {
    background: #dc2626;
    color: white;
    transform: translateY(-2px);
}

.event-log-header-buttons {
    display: flex;
    gap: 0.5rem;
    align-items: center;
    flex-wrap: wrap;
}

/* Mobile Optimizations for iPhone & Samsung */
@media (max-width: 480px) {
    .event-log-header {
        flex-direction: column;
        align-items: flex-start;
        gap: 0.75rem;
    }
    
    .event-log-header-buttons {
        width: 100%;
        justify-content: flex-start;
        flex-wrap: wrap;
    }
    
    .event-log-add-btn,
    .event-log-clear-btn {
        padding: 0.4rem 0.75rem;
        font-size: 0.85rem;
        min-height: 44px; /* iOS touch target */
        flex-shrink: 0;
    }
    
    .event-log-title {
        font-size: 1rem;
    }
    
    /* International cancellations - prevent overflow */
    .intl-cancel-section,
    .intl-event-log-section {
        overflow-x: hidden;
    }
    
    .intl-cancel-entry {
        flex-wrap: wrap;
        gap: 0.5rem;
    }
    
    .intl-cancel-input {
        min-width: 0;
        flex: 1 1 100%;
    }
    
    .intl-cancel-input.flight {
        flex: 1 1 45%;
    }
    
    .intl-cancel-input.route {
        flex: 1 1 45%;
    }
    
    .intl-cancel-input.reason {
        flex: 1 1 100%;
    }
    
    .intl-cancel-remove-btn {
        flex-shrink: 0;
    }
    
    /* Summary sections prevent overflow */
    .summary-editor-section {
        overflow-x: hidden;
    }
    
    /* Pax Loads modal mobile */
    .pax-loads-modal {
        max-width: 100%;
        margin: 0.5rem;
        border-radius: 0.75rem;
    }
    
    .pax-loads-table th,
    .pax-loads-table td {
        padding: 0.5rem 0.4rem;
        font-size: 0.85rem;
    }
    
    .pax-bar {
        height: 16px;
    }
    
    .peak-badge {
        font-size: 0.6rem;
        padding: 1px 4px;
    }
    
    /* Busyness panel mobile */
    .busyness-panel {
        max-height: 85vh;
    }
    
    .busyness-clear-firebase-btn,
    .busyness-clear-btn {
        padding: 0.4rem 0.6rem;
        font-size: 0.75rem;
    }
    
    /* Summary report sections */
    .summary-section {
        padding: 0.75rem;
    }
    
    /* Leadership modal mobile */
    .leadership-modal-content {
        max-height: 80vh;
        padding: 1rem;
    }
    
    .name-btn {
        padding: 0.5rem 0.75rem;
        font-size: 0.85rem;
        min-height: 44px;
    }
}

/* iPhone specific (375px width) */
@media (max-width: 375px) {
    .event-log-add-btn,
    .event-log-clear-btn {
        padding: 0.35rem 0.6rem;
        font-size: 0.8rem;
    }
    
    .pax-loads-table th:first-child,
    .pax-loads-table td:first-child {
        width: 30px;
        padding: 0.4rem 0.25rem;
    }
    
    .pax-checkbox {
        width: 16px;
        height: 16px;
    }
    
    .pax-action-btn {
        padding: 0.6rem 1rem;
        font-size: 0.85rem;
    }
    
    .busyness-header-actions {
        flex-wrap: wrap;
        gap: 0.25rem;
    }
    
    .busyness-clear-firebase-btn,
    .busyness-clear-btn {
        padding: 0.3rem 0.5rem;
        font-size: 0.7rem;
    }
}

/* Samsung/Android (360px width) */
@media (max-width: 360px) {
    .container {
        padding: 0.5rem;
    }
    
    .event-log-header-buttons {
        gap: 0.25rem;
    }
    
    .event-log-add-btn span:not(.event-log-add-icon),
    .event-log-clear-btn span:not(:first-child) {
        display: none;
    }
    
    .pax-loads-header {
        padding: 1rem;
    }
    
    .pax-loads-title {
        font-size: 1.1rem;
    }
}

/* Touch-friendly targets for all mobile */
@media (hover: none) and (pointer: coarse) {
    button, 
    .name-btn,
    .busyness-btn,
    .pax-checkbox,
    input[type="checkbox"] {
        min-height: 44px;
        min-width: 44px;
    }
    
    .flight-card {
        padding: 1rem;
    }
    
    .status-badge {
        min-height: 48px;
        min-width: 48px;
    }
}

.event-log-entries {
    display: flex;
    flex-direction: column;
    gap: 0.75rem;
    max-height: 400px;
    overflow-y: auto;
}

.event-log-entry {
    background: white;
    border: 1px solid #e5e7eb;
    border-radius: 0.5rem;
    padding: 0.75rem;
    position: relative;
}

.event-log-entry-header {
    display: flex;
    gap: 0.75rem;
    align-items: center;
    margin-bottom: 0.5rem;
    flex-wrap: wrap;
}

.event-log-time-input {
    width: 80px;
    padding: 0.4rem 0.5rem;
    border: 1px solid #d1d5db;
    border-radius: 0.375rem;
    font-size: 0.9rem;
    font-family: monospace;
}

.event-log-time-input:focus {
    outline: none;
    border-color: #000345;
    box-shadow: 0 0 0 2px rgba(0, 3, 69, 0.2);
}

.event-log-user {
    background: #f3f4f6;
    padding: 0.4rem 0.75rem;
    border-radius: 0.375rem;
    font-size: 0.85rem;
    color: #374151;
    font-weight: 500;
}

.event-log-user-input {
    width: 120px;
    padding: 0.4rem 0.5rem;
    border: 1px solid #d1d5db;
    border-radius: 0.375rem;
    font-size: 0.85rem;
    background: #f8fafc;
    color: #374151;
    font-weight: 500;
}

.event-log-user-input:focus {
    outline: none;
    border-color: #000345;
    box-shadow: 0 0 0 2px rgba(0, 3, 69, 0.2);
    background: white;
}

.event-log-category-select {
    padding: 0.4rem 0.5rem;
    border: 1px solid #d1d5db;
    border-radius: 0.375rem;
    font-size: 0.85rem;
    background: white;
    min-width: 150px;
}

.event-log-category-select:focus {
    outline: none;
    border-color: #000345;
}

.event-log-remove-btn {
    background: transparent;
    border: 2px solid #dc2626;
    color: #dc2626;
    padding: 0.25rem 0.5rem;
    border-radius: 0.375rem;
    cursor: pointer;
    font-weight: bold;
    font-size: 0.8rem;
    transition: all 0.2s;
    margin-left: auto;
}

.event-log-remove-btn:hover {
    background: #dc2626;
    color: white;
}

.event-log-textarea {
    width: 100%;
    padding: 0.5rem;
    border: 1px solid #d1d5db;
    border-radius: 0.375rem;
    font-size: 0.9rem;
    resize: vertical;
    min-height: 60px;
    font-family: inherit;
}

.event-log-textarea:focus {
    outline: none;
    border-color: #000345;
    box-shadow: 0 0 0 2px rgba(0, 3, 69, 0.2);
}

.event-log-actions {
    display: flex;
    gap: 0.75rem;
    margin-top: 1rem;
    padding-top: 0.75rem;
    border-top: 1px dashed #d1d5db;
}

.event-log-save-btn {
    background: #000345;
    color: white;
    border: none;
    padding: 0.6rem 1.25rem;
    border-radius: 0.5rem;
    font-weight: bold;
    cursor: pointer;
    display: flex;
    align-items: center;
    gap: 0.5rem;
    transition: all 0.3s;
}

.event-log-save-btn:hover {
    background: #001078;
}

.event-log-sync-btn {
    background: #059669;
    color: white;
    border: none;
    padding: 0.6rem 1.25rem;
    border-radius: 0.5rem;
    font-weight: bold;
    cursor: pointer;
    display: flex;
    align-items: center;
    gap: 0.5rem;
    transition: all 0.3s;
}

.event-log-sync-btn:hover {
    background: #047857;
}

.event-log-status {
    font-size: 0.8rem;
    color: #6b7280;
    margin-top: 0.5rem;
    font-style: italic;
}

.event-log-empty {
    text-align: center;
    padding: 2rem;
    color: #9ca3af;
    font-style: italic;
}

.event-log-category-badge {
    display: inline-block;
    padding: 0.2rem 0.5rem;
    border-radius: 0.25rem;
    font-size: 0.75rem;
    font-weight: 600;
    text-transform: uppercase;
}

.event-log-category-badge.medical {
    background: #fef2f2;
    color: #dc2626;
    border: 1px solid #fecaca;
}

.event-log-category-badge.afp {
    background: #eff6ff;
    color: #2563eb;
    border: 1px solid #bfdbfe;
}

.event-log-category-badge.injury {
    background: #fefce8;
    color: #ca8a04;
    border: 1px solid #fef08a;
}

.event-log-category-badge.escalation {
    background: #fdf4ff;
    color: #a855f7;
    border: 1px solid #e9d5ff;
}

.event-log-category-badge.general {
    background: #f0fdf4;
    color: #16a34a;
    border: 1px solid #bbf7d0;
}

.event-log-category-badge.other {
    background: #f8fafc;
    color: #64748b;
    border: 1px solid #e2e8f0;
}

/* New category badges */
.event-log-category-badge.damp {
    background: #f8fafc;
    color: #64748b;
    border: 1px solid #e2e8f0;
}

.event-log-category-badge.security {
    background: #f8fafc;
    color: #64748b;
    border: 1px solid #e2e8f0;
}

.event-log-category-badge.safety {
    background: #f8fafc;
    color: #64748b;
    border: 1px solid #e2e8f0;
}

.event-log-category-badge.sop {
    background: #f8fafc;
    color: #64748b;
    border: 1px solid #e2e8f0;
}

/* Category Summary Bar */
.event-log-category-summary {
    background: white;
    border: 1px solid #e5e7eb;
    border-radius: 0.5rem;
    padding: 0.75rem 1rem;
    margin-bottom: 1rem;
    display: flex;
    flex-wrap: wrap;
    gap: 0.75rem;
    align-items: center;
}

.category-summary-title {
    font-weight: bold;
    color: #000345;
    font-size: 0.85rem;
}

.category-summary-stat {
    display: inline-flex;
    align-items: center;
    gap: 0.25rem;
    font-size: 0.8rem;
    padding: 0.25rem 0.5rem;
    border-radius: 0.25rem;
    background: #f8fafc;
    border: 1px solid #e5e7eb;
}

.category-summary-stat .count {
    font-weight: bold;
    color: #000345;
}

/* International Event Log Section */
.intl-event-log-section {
    border-left: 5px solid #FA5115;
}

.intl-event-log-section .event-log-header.intl-header {
    border-bottom: 2px solid rgba(250, 81, 21, 0.3);
}

.intl-badge {
    background: #FA5115;
    color: white;
    padding: 0.2rem 0.5rem;
    font-size: 0.7rem;
    font-weight: bold;
    border-radius: 0.25rem;
    margin-left: 0.5rem;
}

/* International Cancellations Section */
.intl-cancel-section {
    border-left: 5px solid #FA5115;
}

.intl-cancel-entries {
    display: flex;
    flex-direction: column;
    gap: 0.75rem;
    max-height: 300px;
    overflow-y: auto;
}

.intl-cancel-entry {
    background: white;
    border: 1px solid #e5e7eb;
    border-radius: 0.5rem;
    padding: 0.75rem;
    display: flex;
    gap: 0.75rem;
    align-items: center;
    flex-wrap: wrap;
}

.intl-cancel-label {
    font-size: 0.8rem;
    color: #6b7280;
    font-weight: 500;
}

.intl-cancel-input {
    padding: 0.4rem 0.5rem;
    border: 1px solid #d1d5db;
    border-radius: 0.375rem;
    font-size: 0.85rem;
}

.intl-cancel-input:focus {
    outline: none;
    border-color: #FA5115;
    box-shadow: 0 0 0 2px rgba(250, 81, 21, 0.2);
}

.intl-cancel-input.flight {
    width: 80px;
    text-transform: uppercase;
}

.intl-cancel-input.route {
    width: 100px;
    text-transform: uppercase;
}

.intl-cancel-input.reason {
    flex: 1;
    min-width: 150px;
}

.intl-cancel-remove-btn {
    background: transparent;
    border: 2px solid #dc2626;
    color: #dc2626;
    padding: 0.25rem 0.5rem;
    border-radius: 0.375rem;
    cursor: pointer;
    font-weight: bold;
    font-size: 0.8rem;
    transition: all 0.2s;
}

.intl-cancel-remove-btn:hover {
    background: #dc2626;
    color: white;
}

.intl-cancel-note {
    font-size: 0.75rem;
    color: #6b7280;
    margin-top: 0.75rem;
    font-style: italic;
    padding: 0.5rem;
    background: rgba(250, 81, 21, 0.05);
    border-radius: 0.25rem;
}

.intl-cancel-empty {
    text-align: center;
    padding: 1.5rem;
    color: #9ca3af;
    font-style: italic;
}

.summary-editor-footer {
    padding: 1rem 1.5rem;
    background: #f8fafc;
    border-top: 1px solid #e5e7eb;
    display: flex;
    justify-content: flex-end;
    gap: 1rem;
}

.summary-editor-btn {
    padding: 0.75rem 1.5rem;
    border-radius: 0.5rem;
    border: none;
    font-weight: bold;
    cursor: pointer;
    transition: all 0.3s;
    font-size: 1rem;
}

.summary-editor-btn.cancel {
    background: #6b7280;
    color: white;
}

.summary-editor-btn.cancel:hover {
    background: #4b5563;
}

.summary-editor-btn.generate {
    background: #000345;
    color: white;
}

.summary-editor-btn.generate:hover {
    background: #0a0a5e;
}

@media (max-width: 768px) {
    .summary-report-editor-modal {
        max-height: 95vh;
        border-radius: 1rem;
    }
    
    .summary-editor-header {
        padding: 1rem;
    }
    
    .summary-editor-title {
        font-size: 1.25rem;
    }
    
    .summary-editor-content {
        padding: 1rem;
    }
    
    .summary-editor-stats {
        justify-content: center;
        gap: 0.75rem;
    }
    
    .handover-question {
        flex-direction: column;
        align-items: flex-start;
    }
    
    .summary-editor-footer {
        flex-direction: column;
    }
    
    .summary-editor-btn {
        width: 100%;
    }
}

/* ============================================
   LOCATION CHANGE MODAL FOR OTHER USERS
   ============================================ */

.location-change-modal-overlay {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0, 3, 69, 0.9);
    backdrop-filter: blur(8px);
    -webkit-backdrop-filter: blur(8px);
    z-index: 26000;
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 1rem;
}

.location-change-modal {
    background: white;
    border-radius: 1.5rem;
    box-shadow: 0 20px 60px rgba(0, 0, 0, 0.4);
    max-width: 400px;
    width: 100%;
    overflow: hidden;
}

.location-change-modal-header {
    background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%);
    color: white;
    padding: 1.25rem;
    text-align: center;
}

.location-change-modal-title {
    font-size: 1.25rem;
    font-weight: bold;
}

.location-change-modal-user {
    font-size: 0.9rem;
    opacity: 0.9;
    margin-top: 0.25rem;
}

.location-change-modal-content {
    padding: 1.5rem;
}

.location-change-modal-label {
    font-weight: 600;
    color: #000345;
    margin-bottom: 0.5rem;
    display: block;
}

.location-change-modal-select {
    width: 100%;
    padding: 0.75rem;
    border: 2px solid rgba(0, 3, 69, 0.2);
    border-radius: 0.5rem;
    font-size: 1rem;
    cursor: pointer;
    margin-bottom: 1rem;
}

.location-change-modal-select:focus {
    outline: none;
    border-color: #3b82f6;
}

.location-change-modal-actions {
    display: flex;
    gap: 0.75rem;
}

.location-change-modal-btn {
    flex: 1;
    padding: 0.75rem;
    border-radius: 0.5rem;
    border: none;
    font-weight: bold;
    cursor: pointer;
    transition: all 0.3s;
}

.location-change-modal-btn.cancel {
    background: #6b7280;
    color: white;
}

.location-change-modal-btn.confirm {
    background: #3b82f6;
    color: white;
}

.location-change-modal-btn:hover {
    opacity: 0.9;
    transform: translateY(-1px);
}

/* Make user cards clickable */
.user-card.clickable {
    cursor: pointer;
    transition: all 0.2s;
}

.user-card.clickable:hover {
    transform: translateX(4px);
    box-shadow: 0 2px 8px rgba(0, 3, 69, 0.15);
}

.user-card.clickable:hover .user-name::after {
    content: ' ';
    font-size: 0.8rem;
}

/* ============================================
   BUSYNESS TRACKER STYLES
   ============================================ */

/* Floating Busyness Button - HIDDEN (users click status bar instead) */
.busyness-float-btn {
    display: none !important;
}

/* Busyness Panel Overlay */
.busyness-panel-overlay {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0, 3, 69, 0.5);
    backdrop-filter: blur(5px);
    -webkit-backdrop-filter: blur(5px);
    z-index: 10001;
    display: flex;
    align-items: flex-end;
    justify-content: center;
    padding: 1rem;
}

.busyness-panel {
    background: white;
    border-radius: 1rem 1rem 0 0;
    width: 100%;
    max-width: 500px;
    max-height: 85vh;
    overflow-y: auto;
    box-shadow: 0 -10px 40px rgba(0, 0, 0, 0.2);
}

.busyness-panel-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 1rem;
    border-bottom: 1px solid #e5e7eb;
    background: #000345;
    color: white;
    border-radius: 1rem 1rem 0 0;
}

.busyness-panel-title {
    font-size: 1.1rem;
    font-weight: 700;
}

.busyness-header-actions {
    display: flex;
    align-items: center;
    gap: 8px;
}

.busyness-clear-btn {
    background: rgba(220, 38, 38, 0.8);
    border: none;
    color: white;
    padding: 6px 12px;
    border-radius: 6px;
    font-size: 0.75rem;
    cursor: pointer;
    font-weight: 600;
    transition: all 0.2s;
}

.busyness-clear-btn:hover {
    background: #dc2626;
}

.busyness-close-btn {
    background: rgba(255,255,255,0.2);
    border: none;
    color: white;
    width: 28px;
    height: 28px;
    border-radius: 50%;
    font-size: 0.9rem;
    cursor: pointer;
    font-weight: bold;
    display: flex;
    align-items: center;
    justify-content: center;
}

.busyness-panel-content {
    padding: 1rem;
}

/* Location Section */
.busyness-location {
    margin-bottom: 1.25rem;
    padding-bottom: 1rem;
    border-bottom: 1px solid #e5e7eb;
}

.busyness-location:last-child {
    margin-bottom: 0;
    padding-bottom: 0;
    border-bottom: none;
}

.busyness-location-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 0.75rem;
}

.busyness-location-name {
    font-weight: 600;
    color: #000345;
    font-size: 0.95rem;
}

.busyness-location-status {
    font-size: 0.8rem;
    color: #6b7280;
}

/* Busyness Buttons */
.busyness-btn-group {
    display: flex;
    gap: 0.4rem;
    flex-wrap: wrap;
}

.busyness-btn {
    flex: 1;
    min-width: 60px;
    padding: 0.6rem 0.4rem;
    border: 2px solid #e5e7eb;
    border-radius: 0.5rem;
    background: white;
    cursor: pointer;
    text-align: center;
    transition: all 0.2s;
    font-size: 0.75rem;
}

.busyness-btn:hover:not(:disabled) {
    transform: translateY(-2px);
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
}

.busyness-btn:disabled {
    opacity: 0.5;
    cursor: not-allowed;
}

.busyness-btn.selected {
    border-width: 3px;
}

.busyness-btn .busyness-icon {
    font-size: 1.3rem;
    display: block;
    margin-bottom: 0.25rem;
}

.busyness-btn.quiet { border-color: #22c55e; }
.busyness-btn.quiet.selected { background: #dcfce7; }
.busyness-btn.moderate { border-color: #eab308; }
.busyness-btn.moderate.selected { background: #fef9c3; }
.busyness-btn.busy { border-color: #f97316; }
.busyness-btn.busy.selected { background: #ffedd5; }
.busyness-btn.very-busy { border-color: #ef4444; }
.busyness-btn.very-busy.selected { background: #fee2e2; }
.busyness-btn.chaos { border-color: #1f2937; }
.busyness-btn.chaos.selected { background: #f3f4f6; }

/* Cooldown Timer */
.busyness-cooldown {
    margin-top: 0.5rem;
    padding: 0.5rem;
    background: #f3f4f6;
    border-radius: 0.375rem;
    font-size: 0.8rem;
    color: #6b7280;
    text-align: center;
}

/* Quick Snapshot Section */
.busyness-snapshot-section {
    margin-top: 1rem;
    padding-top: 1rem;
    border-top: 2px solid #e5e7eb;
}

.busyness-snapshot-title {
    font-weight: 600;
    color: #000345;
    font-size: 0.9rem;
    margin-bottom: 0.75rem;
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

/* Mini Chart */
.busyness-chart-container {
    background: #f9fafb;
    border-radius: 0.5rem;
    padding: 0.75rem;
    margin-bottom: 0.75rem;
}

.busyness-chart {
    display: flex;
    height: 60px;
    align-items: flex-end;
    gap: 2px;
    border-bottom: 1px solid #d1d5db;
    padding-bottom: 4px;
}

.busyness-chart-bar {
    flex: 1;
    min-width: 8px;
    border-radius: 2px 2px 0 0;
    transition: height 0.3s;
}

.busyness-chart-bar.quiet { background: #22c55e; }
.busyness-chart-bar.moderate { background: #eab308; }
.busyness-chart-bar.busy { background: #f97316; }
.busyness-chart-bar.very-busy { background: #ef4444; }
.busyness-chart-bar.chaos { background: #1f2937; }
.busyness-chart-bar.empty { background: #e5e7eb; height: 5px !important; }

.busyness-chart-labels {
    display: flex;
    justify-content: space-between;
    font-size: 0.65rem;
    color: #9ca3af;
    margin-top: 4px;
}

/* Flight Pressure Stats */
.flight-pressure-stats {
    display: flex;
    gap: 0.5rem;
    flex-wrap: wrap;
}

.pressure-stat {
    flex: 1;
    min-width: 70px;
    text-align: center;
    padding: 0.5rem;
    background: #f3f4f6;
    border-radius: 0.375rem;
}

.pressure-stat-number {
    font-size: 1.3rem;
    font-weight: 700;
}

.pressure-stat-number.open { color: #22c55e; }
.pressure-stat-number.closing { color: #f97316; }
.pressure-stat-number.closed { color: #6b7280; }

.pressure-stat-label {
    font-size: 0.7rem;
    color: #6b7280;
    text-transform: uppercase;
}

/* No Data Message */
.busyness-no-data {
    text-align: center;
    color: #9ca3af;
    font-style: italic;
    padding: 1rem;
    font-size: 0.85rem;
}

/* Start Tracking Message */
.busyness-start-tracking {
    text-align: center;
    color: #6b7280;
    font-style: italic;
    padding: 1rem;
    font-size: 0.85rem;
    background: #f9fafb;
    border-radius: 8px;
    border: 1px dashed #d1d5db;
}

/* ============================================
   CLEAR FIREBASE BUTTON
   ============================================ */

.busyness-clear-firebase-btn {
    background: linear-gradient(135deg, #dc2626, #b91c1c);
    color: white;
    border: none;
    padding: 6px 12px;
    border-radius: 6px;
    font-size: 0.75rem;
    font-weight: 600;
    cursor: pointer;
    display: flex;
    align-items: center;
    gap: 4px;
    transition: all 0.2s;
}

.busyness-clear-firebase-btn:hover {
    background: linear-gradient(135deg, #b91c1c, #991b1b);
    transform: scale(1.02);
}

/* ============================================
   VERTICAL LOG LIST STYLES
   ============================================ */

.busyness-log-list {
    display: flex;
    flex-direction: column;
    gap: 6px;
    max-height: 200px;
    overflow-y: auto;
    padding: 8px;
    background: #f9fafb;
    border-radius: 8px;
    border: 1px solid #e5e7eb;
}

.busyness-log-entry {
    display: flex;
    align-items: center;
    gap: 8px;
    padding: 6px 10px;
    background: white;
    border-radius: 6px;
    border: 1px solid #e5e7eb;
    font-size: 0.8rem;
}

.busyness-log-entry.status-change {
    border-left: 3px solid #000345;
}

.busyness-log-entry.confirmation {
    opacity: 0.7;
    border-left: 3px solid #9ca3af;
}

.log-time {
    font-family: monospace;
    font-weight: 600;
    color: #374151;
    min-width: 45px;
}

.log-level-indicator {
    width: 12px;
    height: 12px;
    border-radius: 50%;
    flex-shrink: 0;
}

.log-details {
    display: flex;
    align-items: center;
    gap: 8px;
    flex: 1;
}

.log-level-text {
    font-weight: 600;
    min-width: 70px;
}

.log-user {
    color: #6b7280;
    font-size: 0.75rem;
}

.log-confirmation-badge {
    background: #f3f4f6;
    color: #6b7280;
    padding: 2px 6px;
    border-radius: 4px;
    font-size: 0.65rem;
    text-transform: uppercase;
}

.busyness-log-more {
    text-align: center;
    color: #6b7280;
    font-size: 0.75rem;
    padding: 4px;
    font-style: italic;
}

.busyness-log-summary {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 8px 10px;
    background: #f3f4f6;
    border-radius: 6px;
    font-size: 0.75rem;
    color: #6b7280;
    margin-top: 8px;
}

/* ============================================
   PER-LOCATION SNAPSHOT STYLES
   ============================================ */

.location-snapshot {
    background: white;
    border-radius: 8px;
    padding: 12px;
    margin-bottom: 12px;
    border: 1px solid #e5e7eb;
}

.location-snapshot:last-child {
    margin-bottom: 0;
}

.location-snapshot-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 8px;
}

.location-snapshot-title {
    font-weight: 700;
    color: #000345;
    font-size: 0.9rem;
    display: flex;
    align-items: center;
    gap: 6px;
}

.location-snapshot-current {
    font-size: 0.75rem;
    padding: 4px 10px;
    border-radius: 12px;
    font-weight: 600;
}

.location-snapshot-current.quiet { background: #dcfce7; color: #166534; }
.location-snapshot-current.moderate { background: #fef9c3; color: #854d0e; }
.location-snapshot-current.busy { background: #ffedd5; color: #c2410c; }
.location-snapshot-current.very-busy { background: #fee2e2; color: #dc2626; }
.location-snapshot-current.chaos { background: #f3f4f6; color: #1f2937; }
.location-snapshot-current.no-data { background: #f3f4f6; color: #6b7280; }

.location-mini-chart {
    display: flex;
    height: 40px;
    align-items: flex-end;
    gap: 3px;
    border-bottom: 1px solid #e5e7eb;
    padding-bottom: 4px;
    margin-bottom: 6px;
}

.location-chart-bar {
    flex: 1;
    border-radius: 3px 3px 0 0;
    min-width: 12px;
    max-width: 40px;
    transition: height 0.3s;
}

.location-chart-bar.quiet { background: #22c55e; }
.location-chart-bar.moderate { background: #eab308; }
.location-chart-bar.busy { background: #f97316; }
.location-chart-bar.very-busy { background: #ef4444; }
.location-chart-bar.chaos { background: #1f2937; }

.location-chart-labels {
    display: flex;
    justify-content: space-between;
    font-size: 0.65rem;
    color: #9ca3af;
}

@media (max-width: 500px) {
    .busyness-btn {
        min-width: 50px;
        padding: 0.5rem 0.25rem;
    }
    
    .busyness-btn .busyness-icon {
        font-size: 1.1rem;
    }
    
    .busyness-btn span:last-child {
        font-size: 0.65rem;
    }
}

/* ============================================
   STEPPED TIMELINE CHART STYLES
   ============================================ */

.stepped-timeline-container {
    margin-top: 8px;
}

.stepped-timeline-bar {
    position: relative;
    height: 24px;
    background: #f3f4f6;
    border-radius: 6px;
    overflow: hidden;
    border: 1px solid #e5e7eb;
}

.timeline-segment {
    position: absolute;
    top: 0;
    bottom: 0;
    transition: all 0.3s;
}

.timeline-segment.quiet { background: #22c55e; }
.timeline-segment.moderate { background: #eab308; }
.timeline-segment.busy { background: #f97316; }
.timeline-segment.very-busy { background: #ef4444; }
.timeline-segment.chaos { background: #1f2937; }

.stepped-timeline-labels {
    display: flex;
    justify-content: space-between;
    align-items: center;
    font-size: 0.65rem;
    color: #6b7280;
    margin-top: 4px;
    padding: 0 2px;
}

.timeline-entries-count {
    font-size: 0.6rem;
    color: #9ca3af;
    background: #f3f4f6;
    padding: 2px 6px;
    border-radius: 8px;
}

/* Location snapshot status container */
.location-snapshot-status-container {
    display: flex;
    flex-direction: column;
    align-items: flex-end;
    gap: 2px;
}

.location-snapshot-time {
    font-size: 0.65rem;
    color: #9ca3af;
}

/* Busyness Legend Bar */
.busyness-legend-bar {
    display: flex;
    justify-content: center;
    align-items: center;
    gap: 12px;
    flex-wrap: wrap;
    margin-top: 16px;
    padding: 10px;
    background: #f8fafc;
    border-radius: 8px;
    border: 1px solid #e5e7eb;
}

.busyness-legend-bar .legend-label {
    font-size: 0.7rem;
    font-weight: 600;
    color: #64748b;
}

.busyness-legend-bar .legend-item {
    display: flex;
    align-items: center;
    gap: 4px;
    font-size: 0.7rem;
    color: #64748b;
}

.busyness-legend-bar .legend-color {
    width: 12px;
    height: 12px;
    border-radius: 3px;
}

.legend-color.quiet { background: #22c55e; }
.legend-color.moderate { background: #eab308; }
.legend-color.busy { background: #f97316; }
.legend-color.very-busy { background: #ef4444; }
.legend-color.chaos { background: #1f2937; }

/* ============================================
   BUSYNESS BAR GRAPH STYLES (NEW)
   Optimized for 8-inch iPad Mini
   ============================================ */

.busyness-bar-graph-container {
    margin-top: 10px;
    background: #fafbfc;
    border-radius: 10px;
    padding: 12px;
    border: 1px solid #e5e7eb;
}

.busyness-bar-graph-wrapper {
    position: relative;
    overflow-x: scroll;
    overflow-y: hidden;
    -webkit-overflow-scrolling: touch;
    scrollbar-width: thin;
    scrollbar-color: #94a3b8 #e2e8f0;
    border-radius: 6px;
    background: white;
    border: 1px solid #e5e7eb;
    touch-action: pan-x pan-y;  /* Allow both horizontal and vertical panning */
    cursor: grab;
}

.busyness-bar-graph-wrapper:active {
    cursor: grabbing;
}

/* Prevent zoom interference with scroll */
.busyness-bar-graph-wrapper svg {
    touch-action: pan-x;
    pointer-events: auto;
}

.busyness-bar-graph-wrapper::-webkit-scrollbar {
    height: 8px;
}

.busyness-bar-graph-wrapper::-webkit-scrollbar-track {
    background: #e2e8f0;
    border-radius: 4px;
}

.busyness-bar-graph-wrapper::-webkit-scrollbar-thumb {
    background: #94a3b8;
    border-radius: 4px;
}

.busyness-bar-graph-wrapper::-webkit-scrollbar-thumb:hover {
    background: #64748b;
}

.busyness-bar-graph-wrapper::-webkit-scrollbar-thumb:active {
    background: #475569;
}

.busyness-bar-graph-svg {
    display: block;
}

.busyness-bar {
    transition: opacity 0.2s;
    cursor: pointer;
}

.busyness-bar:hover {
    opacity: 0.75;
    filter: brightness(1.1);
}

.busyness-graph-x-label {
    fill: #4b5563;
    font-size: 10px;
    text-anchor: middle;
    font-weight: 600;
}

.busyness-graph-scroll-hint {
    text-align: center;
    padding: 6px 10px;
    margin-top: 8px;
    background: linear-gradient(135deg, #e0f2fe 0%, #f0f9ff 100%);
    border-radius: 8px;
    font-size: 0.75rem;
    color: #0369a1;
    border: 1px solid #bae6fd;
}

.busyness-graph-info {
    text-align: center;
    margin-top: 8px;
}

.busyness-graph-entry-count {
    font-size: 0.8rem;
    color: #6b7280;
    padding: 5px 12px;
    background: #f3f4f6;
    border-radius: 12px;
    display: inline-block;
    font-weight: 500;
}

.busyness-graph-no-data {
    text-align: center;
    color: #9ca3af;
    font-size: 0.9rem;
    padding: 35px 10px;
    font-style: italic;
}

/* PDF report graph styles */
.pdf-busyness-graph {
    margin: 8px 0;
    background: #fafbfc;
    border-radius: 6px;
    padding: 10px;
    border: 1px solid #e5e7eb;
}

.pdf-busyness-graph svg {
    display: block;
    width: 100%;
    height: auto;
}

/* ============================================
   BLOCKING BUSYNESS REMINDER STYLES (NEW)
   ============================================ */

.busyness-blocking-reminder-overlay {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0, 3, 69, 0.95);
    backdrop-filter: blur(10px);
    -webkit-backdrop-filter: blur(10px);
    z-index: 50000;
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 1rem;
}

.busyness-blocking-reminder-modal {
    background: white;
    border-radius: 1.5rem;
    box-shadow: 0 30px 90px rgba(0, 0, 0, 0.5);
    max-width: 450px;
    width: 95%;
    overflow: hidden;
    animation: reminderSlideIn 0.3s ease-out;
}

@keyframes reminderSlideIn {
    from {
        transform: translateY(20px);
        opacity: 0;
    }
    to {
        transform: translateY(0);
        opacity: 1;
    }
}

.reminder-header {
    background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
    color: white;
    padding: 1.25rem 1.5rem;
    display: flex;
    align-items: center;
    gap: 0.75rem;
}

.reminder-icon {
    font-size: 1.75rem;
}

.reminder-title {
    font-size: 1.2rem;
    font-weight: bold;
}

.reminder-body {
    padding: 1.5rem;
}

.reminder-location-badge {
    display: inline-block;
    background: linear-gradient(135deg, #000345 0%, #1a1a4e 100%);
    color: white;
    padding: 0.5rem 1.25rem;
    border-radius: 2rem;
    font-weight: bold;
    font-size: 1rem;
    margin-bottom: 1rem;
}

.reminder-message {
    color: #4b5563;
    font-size: 0.95rem;
    line-height: 1.6;
    margin-bottom: 1rem;
}

.reminder-last-info {
    background: #f3f4f6;
    padding: 0.75rem 1rem;
    border-radius: 0.5rem;
    font-size: 0.85rem;
    color: #6b7280;
    margin-bottom: 1.25rem;
    text-align: center;
}

.reminder-btn-group {
    display: grid;
    grid-template-columns: repeat(5, 1fr);
    gap: 0.5rem;
}

.reminder-level-btn {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    padding: 0.75rem 0.25rem;
    border: 2px solid #e5e7eb;
    border-radius: 0.75rem;
    background: white;
    cursor: pointer;
    transition: all 0.2s;
    min-height: 70px;
}

.reminder-level-btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
}

.reminder-level-btn:active {
    transform: translateY(0);
}

.reminder-level-btn.quiet { border-color: #22c55e; }
.reminder-level-btn.quiet:hover { background: #dcfce7; }
.reminder-level-btn.moderate { border-color: #eab308; }
.reminder-level-btn.moderate:hover { background: #fef9c3; }
.reminder-level-btn.busy { border-color: #f97316; }
.reminder-level-btn.busy:hover { background: #ffedd5; }
.reminder-level-btn.very-busy { border-color: #ef4444; }
.reminder-level-btn.very-busy:hover { background: #fee2e2; }
.reminder-level-btn.chaos { border-color: #1f2937; }
.reminder-level-btn.chaos:hover { background: #f3f4f6; }

.reminder-btn-icon {
    font-size: 1.5rem;
    margin-bottom: 0.25rem;
}

.reminder-btn-label {
    font-size: 0.65rem;
    font-weight: 600;
    color: #374151;
    text-align: center;
}

/* Update Now button in reminder */
.reminder-update-now-btn {
    width: 100%;
    background: linear-gradient(135deg, #000345 0%, #1a1a4e 100%);
    color: white;
    padding: 1rem 2rem;
    border-radius: 0.75rem;
    border: none;
    font-size: 1.1rem;
    font-weight: bold;
    cursor: pointer;
    transition: all 0.3s;
    box-shadow: 0 4px 12px rgba(0, 3, 69, 0.3);
    margin-top: 0.5rem;
}

.reminder-update-now-btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 6px 16px rgba(0, 3, 69, 0.4);
}

/* Blocking overlay behind busyness panel when update required */
.busyness-update-required-overlay {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0, 3, 69, 0.9);
    z-index: 10000;
}

/* Update required banner in panel */
.update-required-banner {
    background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
    border: 2px solid #f59e0b;
    border-radius: 0.75rem;
    padding: 1rem;
    margin-bottom: 1rem;
    text-align: center;
    font-size: 0.95rem;
    color: #92400e;
    font-weight: 500;
}

.update-required-banner span {
    font-size: 1.25rem;
}

/* Highlighted location that needs updating */
.busyness-location.highlighted-location {
    border: 3px solid #f59e0b !important;
    background: linear-gradient(135deg, #fffbeb 0%, #fef3c7 100%) !important;
    box-shadow: 0 0 20px rgba(245, 158, 11, 0.3);
    animation: highlightPulse 2s ease-in-out infinite;
}

@keyframes highlightPulse {
    0%, 100% {
        box-shadow: 0 0 20px rgba(245, 158, 11, 0.3);
    }
    50% {
        box-shadow: 0 0 30px rgba(245, 158, 11, 0.5);
    }
}

.busyness-location.highlighted-location .busyness-location-name {
    color: #d97706;
    font-weight: 700;
}

/* Cannot close message toast */
.cannot-close-message {
    position: fixed;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    z-index: 60000;
    animation: shakeToast 0.5s ease-out;
}

@keyframes shakeToast {
    0%, 100% { transform: translate(-50%, -50%); }
    10%, 30%, 50%, 70%, 90% { transform: translate(-52%, -50%); }
    20%, 40%, 60%, 80% { transform: translate(-48%, -50%); }
}

.cannot-close-content {
    background: linear-gradient(135deg, #dc2626 0%, #b91c1c 100%);
    color: white;
    padding: 1.25rem 2rem;
    border-radius: 1rem;
    display: flex;
    align-items: center;
    gap: 0.75rem;
    box-shadow: 0 10px 40px rgba(220, 38, 38, 0.4);
    font-size: 0.95rem;
}

.cannot-close-icon {
    font-size: 1.5rem;
}

.cannot-close-message.fade-out {
    opacity: 0;
    transition: opacity 0.3s ease-out;
}

/* Other device updated notification */
.other-device-updated-notification {
    position: fixed;
    top: 20px;
    left: 50%;
    transform: translateX(-50%);
    z-index: 60000;
    animation: slideDownNotif 0.3s ease-out;
}

@keyframes slideDownNotif {
    from {
        transform: translateX(-50%) translateY(-20px);
        opacity: 0;
    }
    to {
        transform: translateX(-50%) translateY(0);
        opacity: 1;
    }
}

.other-device-notification-content {
    background: linear-gradient(135deg, #10b981 0%, #059669 100%);
    color: white;
    padding: 1rem 1.5rem;
    border-radius: 1rem;
    display: flex;
    align-items: center;
    gap: 0.75rem;
    box-shadow: 0 10px 40px rgba(16, 185, 129, 0.4);
}

.other-device-notification-icon {
    font-size: 1.5rem;
}

.other-device-notification-text {
    font-size: 0.95rem;
}

.other-device-notification-by {
    font-size: 0.8rem;
    opacity: 0.9;
    margin-top: 0.25rem;
}

.other-device-updated-notification.fade-out {
    opacity: 0;
    transition: opacity 0.3s ease-out;
}

/* Mobile responsive for reminder */
@media (max-width: 500px) {
    .reminder-btn-group {
        grid-template-columns: repeat(3, 1fr);
    }
    
    .reminder-level-btn {
        min-height: 60px;
    }
    
    .reminder-btn-icon {
        font-size: 1.25rem;
    }
}

/* ============================================
   ZONE E CLOSED BANNER STYLES (NEW)
   ============================================ */

.zone-e-closed-banner {
    display: flex;
    align-items: center;
    gap: 1rem;
    padding: 1rem;
    background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
    border: 2px dashed #94a3b8;
    border-radius: 0.75rem;
    margin-top: 0.5rem;
}

.zone-e-closed-icon {
    font-size: 2rem;
}

.zone-e-closed-text {
    flex: 1;
}

.zone-e-closed-text strong {
    color: #475569;
    font-size: 0.95rem;
    display: block;
    margin-bottom: 0.25rem;
}

.zone-e-closed-subtext {
    color: #94a3b8;
    font-size: 0.8rem;
}

.busyness-location.zone-e-closed {
    opacity: 0.85;
}

/* Zone E closed indicator in snapshot */
.zone-e-snapshot-closed {
    font-size: 0.7rem;
    color: #94a3b8;
    background: #f1f5f9;
    padding: 2px 8px;
    border-radius: 10px;
    margin-left: 8px;
}

.location-snapshot.zone-e-closed-snapshot {
    opacity: 0.8;
    border-style: dashed;
}

/* Success notification subtext */
.busyness-success-subtext {
    font-size: 0.75rem;
    color: rgba(255, 255, 255, 0.8);
    margin-top: 0.25rem;
    font-weight: normal;
}

/* ============================================
   BUSYNESS INACTIVITY REMINDER POPUP (OLD - KEPT FOR REFERENCE)
   ============================================ */

.busyness-inactivity-popup {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0, 3, 69, 0.85);
    backdrop-filter: blur(8px);
    -webkit-backdrop-filter: blur(8px);
    z-index: 10004;
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 1rem;
}

.busyness-inactivity-content {
    background: white;
    border-radius: 1rem;
    padding: 2rem;
    max-width: 400px;
    width: 100%;
    text-align: center;
    box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
}

.busyness-inactivity-icon {
    font-size: 3rem;
    margin-bottom: 1rem;
}

.busyness-inactivity-title {
    font-size: 1.4rem;
    font-weight: 700;
    color: #000345;
    margin-bottom: 0.75rem;
}

.busyness-inactivity-message {
    font-size: 0.95rem;
    color: #4b5563;
    margin-bottom: 1rem;
    line-height: 1.5;
}

.busyness-inactivity-zones {
    background: #f8fafc;
    border-radius: 8px;
    padding: 12px;
    margin-bottom: 1.5rem;
    text-align: left;
}

.reminder-zone {
    font-size: 0.9rem;
    color: #374151;
    padding: 4px 0;
}

.busyness-inactivity-btn {
    width: 100%;
    padding: 0.875rem 1.5rem;
    border-radius: 0.5rem;
    font-size: 1rem;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.2s;
    margin-bottom: 8px;
}

.busyness-inactivity-btn:first-of-type {
    background: #f3f4f6;
    color: #374151;
    border: 1px solid #d1d5db;
}

.busyness-inactivity-btn:first-of-type:hover {
    background: #e5e7eb;
}

.busyness-inactivity-btn.update {
    background: #000345;
    color: white;
    border: none;
    margin-bottom: 0;
}

.busyness-inactivity-btn.update:hover {
    background: #000456;
    transform: translateY(-1px);
}

/* ============================================
   BUSYNESS SUCCESS NOTIFICATION (Green Tick)
   ============================================ */

.busyness-success-notification {
    position: fixed;
    top: 20px;
    right: 20px;
    background: #22c55e;
    color: white;
    padding: 12px 20px;
    border-radius: 12px;
    display: flex;
    align-items: center;
    gap: 12px;
    box-shadow: 0 8px 30px rgba(34, 197, 94, 0.4);
    z-index: 10010;
    transform: translateX(120%);
    transition: transform 0.3s ease-out;
}

.busyness-success-notification.show {
    transform: translateX(0);
}

.busyness-success-icon {
    width: 32px;
    height: 32px;
    background: white;
    color: #22c55e;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1.2rem;
    font-weight: bold;
}

.busyness-success-text {
    font-size: 0.9rem;
}

.busyness-success-text strong {
    font-weight: 600;
}

/* ============================================
   BUSYNESS COOLDOWN NOTIFICATION POPUP
   ============================================ */

.busyness-cooldown-notification {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0, 3, 69, 0.85);
    backdrop-filter: blur(8px);
    -webkit-backdrop-filter: blur(8px);
    z-index: 10010;
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 1rem;
}

.cooldown-notification-content {
    background: white;
    border-radius: 1rem;
    padding: 2rem;
    max-width: 380px;
    width: 100%;
    text-align: center;
    box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
}

.cooldown-notification-icon {
    font-size: 3rem;
    margin-bottom: 1rem;
}

.cooldown-notification-title {
    font-size: 1.4rem;
    font-weight: 700;
    color: #f59e0b;
    margin-bottom: 0.75rem;
}

.cooldown-notification-message {
    font-size: 0.95rem;
    color: #4b5563;
    margin-bottom: 1rem;
    line-height: 1.5;
}

.cooldown-notification-timer {
    font-size: 1.1rem;
    color: #000345;
    margin-bottom: 1.5rem;
    padding: 12px;
    background: #f8fafc;
    border-radius: 8px;
}

.cooldown-notification-timer strong {
    color: #f59e0b;
    font-size: 1.2rem;
}

.cooldown-notification-btn {
    width: 100%;
    padding: 0.875rem 1.5rem;
    border-radius: 0.5rem;
    font-size: 1rem;
    font-weight: 600;
    cursor: pointer;
    background: #000345;
    color: white;
    border: none;
    transition: all 0.2s;
}

.cooldown-notification-btn:hover {
    background: #000456;
    transform: translateY(-1px);
}

/* ============================================
   BUSYNESS PREVIEW GRAPHS (Summary Report Editor)
   ============================================ */

.busyness-preview-container {
    background: #f8fafc;
    border-radius: 8px;
    padding: 12px;
    margin-top: 8px;
}

.busyness-preview-grid {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 12px;
}

.busyness-preview-item {
    background: white;
    border-radius: 8px;
    padding: 10px;
    border: 1px solid #e5e7eb;
}

/* Full-width busyness preview (1 per line) */
.busyness-preview-full-width {
    display: flex;
    flex-direction: column;
    gap: 16px;
}

.busyness-preview-item-full {
    background: white;
    border-radius: 10px;
    padding: 12px;
    border: 1px solid #e5e7eb;
}

.busyness-preview-header-full {
    display: flex;
    align-items: center;
    gap: 12px;
    margin-bottom: 10px;
}

.busyness-preview-header-full .busyness-preview-name {
    font-weight: 700;
    font-size: 1rem;
    color: #000345;
    flex: 1;
}

.busyness-preview-header-full .busyness-preview-status {
    font-size: 0.75rem;
    padding: 4px 10px;
    border-radius: 12px;
    font-weight: 600;
}

.busyness-graph-meta {
    display: flex;
    justify-content: space-between;
    font-size: 0.75rem;
    color: #6b7280;
    margin-top: 4px;
    padding: 0 5px;
}

.busyness-legend-compact {
    display: flex;
    justify-content: center;
    gap: 16px;
    margin-top: 16px;
    padding: 10px;
    background: #f8fafc;
    border-radius: 8px;
    flex-wrap: wrap;
}

.busyness-legend-compact .legend-item {
    display: flex;
    align-items: center;
    gap: 6px;
    font-size: 0.8rem;
    color: #4b5563;
}

.busyness-legend-compact .legend-dot {
    width: 14px;
    height: 14px;
    border-radius: 4px;
}

.busyness-preview-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 8px;
}

.busyness-preview-name {
    font-weight: 600;
    font-size: 0.85rem;
    color: #000345;
}

.busyness-preview-status {
    font-size: 0.7rem;
    padding: 3px 8px;
    border-radius: 10px;
    font-weight: 500;
}

.busyness-preview-status.no-data {
    background: #f3f4f6;
    color: #6b7280;
}

.busyness-preview-empty {
    text-align: center;
    color: #9ca3af;
    font-size: 0.8rem;
    padding: 15px 0;
    font-style: italic;
}

.preview-timeline-bar {
    position: relative;
    height: 20px;
    background: #e5e7eb;
    border-radius: 4px;
    overflow: hidden;
}

.preview-timeline-segment {
    position: absolute;
    top: 0;
    bottom: 0;
}

.preview-timeline-labels {
    display: flex;
    justify-content: space-between;
    font-size: 0.65rem;
    color: #6b7280;
    margin-top: 4px;
}

.busyness-preview-legend {
    display: flex;
    justify-content: center;
    gap: 12px;
    flex-wrap: wrap;
    margin-top: 12px;
    padding-top: 12px;
    border-top: 1px solid #e5e7eb;
}

.preview-legend-item {
    display: flex;
    align-items: center;
    gap: 4px;
    font-size: 0.7rem;
    color: #64748b;
}

.preview-legend-color {
    width: 12px;
    height: 12px;
    border-radius: 3px;
}

.busyness-preview-no-data {
    text-align: center;
    color: #9ca3af;
    font-style: italic;
    padding: 20px;
}

@media (max-width: 500px) {
    .busyness-preview-grid {
        grid-template-columns: 1fr;
    }
}

/* ============================================
   BUSYNESS STATUS BAR (Always Visible)
   ============================================ */

.busyness-status-bar {
    display: none;
    background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
    border: 1px solid #e2e8f0;
    border-radius: 0.75rem;
    padding: 0.6rem 1rem;
    margin-bottom: 1rem;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
}

.busyness-status-bar-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    flex-wrap: wrap;
    gap: 0.5rem;
    margin-bottom: 0.5rem;
}

.busyness-status-bar-title {
    font-size: 0.7rem;
    font-weight: 600;
    color: #64748b;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

.busyness-status-legend {
    display: flex;
    gap: 0.6rem;
    flex-wrap: wrap;
}

.legend-item {
    display: flex;
    align-items: center;
    gap: 0.25rem;
    font-size: 0.65rem;
    color: #64748b;
}

.legend-dot {
    width: 10px;
    height: 10px;
    border-radius: 50%;
    border: 2px solid;
}

.legend-dot.quiet { background: #dcfce7; border-color: #22c55e; }
.legend-dot.moderate { background: #fef9c3; border-color: #eab308; }
.legend-dot.busy { background: #ffedd5; border-color: #f97316; }
.legend-dot.very-busy { background: #fee2e2; border-color: #ef4444; }
.legend-dot.chaos { background: #f3f4f6; border-color: #1f2937; }

.busyness-status-bar-items {
    display: flex;
    gap: 0.5rem;
    flex-wrap: wrap;
}

.busyness-status-item {
    display: flex;
    flex-direction: column;
    align-items: center;
    padding: 0.5rem 0.6rem;
    background: white;
    border-radius: 0.5rem;
    border: 2px solid #e5e7eb;
    font-size: 0.75rem;
    min-width: 85px;
    flex: 1;
    cursor: pointer;
    transition: all 0.2s;
}

.busyness-status-item:hover {
    transform: translateY(-1px);
    box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1);
}

.busyness-status-item.quiet { border-color: #22c55e; background: #f0fdf4; }
.busyness-status-item.moderate { border-color: #eab308; background: #fefce8; }
.busyness-status-item.busy { border-color: #f97316; background: #fff7ed; }
.busyness-status-item.very-busy { border-color: #ef4444; background: #fef2f2; }
.busyness-status-item.chaos { border-color: #1f2937; background: #f3f4f6; }
.busyness-status-item.no-data { border-color: #d1d5db; background: #f9fafb; color: #9ca3af; }

.busyness-status-location {
    font-weight: 600;
    color: #374151;
    font-size: 0.7rem;
    text-align: center;
    margin-bottom: 2px;
}

.busyness-status-level {
    font-size: 1.2rem;
    line-height: 1;
}

.busyness-status-label {
    font-size: 0.65rem;
    font-weight: 500;
    color: #4b5563;
    text-transform: uppercase;
    letter-spacing: 0.3px;
}

.busyness-status-item.no-data .busyness-status-label {
    color: #9ca3af;
}

.busyness-status-time {
    font-size: 0.6rem;
    color: #9ca3af;
    margin-top: 2px;
}

@media (max-width: 600px) {
    .busyness-status-bar-items {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
    }
    
    .busyness-status-item {
        min-width: auto;
    }
}
    </style>
<style>
    @keyframes shake {
        0%, 100% { transform: translateX(0); }
        10%, 30%, 50%, 70%, 90% { transform: translateX(-10px); }
        20%, 40%, 60%, 80% { transform: translateX(10px); }
    }
</style>
    <style id="saved-file-style">
        /* Hide only these 3 buttons */
        .upload-btn:not(.add-comment-main-btn):not(.add-flight-btn):not(.early-open-btn) { 
            display: none !important; 
        }
        #reset-btn { display: none !important; }
        #save-html-btn { display: none !important; }
        
        /* Hide all content until user logs in */
        body.requires-login .container {
            opacity: 0;
            pointer-events: none;
        }
        body.requires-login .user-login-overlay {
            opacity: 1 !important;
            pointer-events: all !important;
        }
        
        /* Keep busyness button visible even before login */
        body.requires-login .busyness-float-btn {
            opacity: 1 !important;
            pointer-events: all !important;
        }
    </style>
</head>
<body class="requires-login saved-html-file">
    <div class="container">
        <div class="header">
            <div class="scroll-time-reference" id="scroll-time-ref"></div>
    <div class="date-validation-badge warning" id="date-validation-badge" style="display: block;"> CSV date does not match today</div>
    <div class="connection-indicator" id="connection-indicator" style="display: none; border-color: rgb(16, 185, 129); color: rgb(16, 185, 129); opacity: 1;">
    <span class="connection-dot"></span>
    <span class="connection-text">Synced</span>
</div>
    <h1> Flight Check-in Countdown</h1>
    <div class="clock" id="current-time">18:20:20</div>
    <div id="flight-date-badge" class="date-badge" style="display: inline-block;">Flight Schedule: Thursday 19 February 2026</div>
</div>

        <!-- ACTIVE USER DASHBOARD (Only visible in saved HTML files) -->
        <div class="active-users-dashboard" id="active-users-dashboard" style="display: none;">
            <div class="current-user-bar" id="current-user-bar">
                <div class="current-user-info">
                    <span></span>
                    <span id="current-user-display">Loading...</span>
                </div>
                <div class="location-change-container">
                    <span class="location-change-label">Location:</span>
                    <select class="location-change-select" id="location-change-select" onchange="changeUserLocation(this.value)">
                        <option value="C.O.W.">C.O.W.</option>
                        <option value="Zone E">Zone E</option>
                        <option value="ABDs">ABDs</option>
                        <option value="Check-In Floor">Check-In Floor</option>
                        <option value="Service Desk">Service Desk</option>
                        <option value="Office">Office</option>
                    </select>
                    <button class="logout-btn" onclick="logoutUser()"> Logout</button>
                </div>
            </div>
            <div class="active-users-header" onclick="toggleActiveUsersDashboard()">
                <div class="active-users-title">
                    <span></span>
                    <span>ACTIVE USERS</span>
                    <span class="active-users-count" id="active-users-count">0</span>
                </div>
                <button class="active-users-toggle" id="active-users-toggle"></button>
            </div>
            <div class="active-users-content" id="active-users-content">
                <div class="no-users-message" id="no-users-message">No other users online</div>
                <div id="active-users-list"></div>
            </div>
        </div>

        <!-- BUSYNESS STATUS BAR (Always visible when logged in) -->
        <div class="busyness-status-bar" id="busyness-status-bar" style="display: block;">
            <div class="busyness-status-bar-header">
                <div class="busyness-status-bar-title">
                    <span></span>
                    <span>CURRENT BUSYNESS STATUS</span>
                </div>
                <div class="busyness-status-legend">
                    <span class="legend-item"><span class="legend-dot quiet"></span>Quiet</span>
                    <span class="legend-item"><span class="legend-dot moderate"></span>Moderate</span>
                    <span class="legend-item"><span class="legend-dot busy"></span>Busy</span>
                    <span class="legend-item"><span class="legend-dot very-busy"></span>V.Busy</span>
                    <span class="legend-item"><span class="legend-dot chaos"></span>Chaos</span>
                </div>
            </div>
            <div class="busyness-status-bar-items" id="busyness-status-items">
            <div class="busyness-status-item no-data" onclick="openBusynessPanel()" title="Click to update Check-In Area">
                <span class="busyness-status-location">Check-In</span>
                <span class="busyness-status-level"></span>
                <span class="busyness-status-label">No Data</span>
                
            </div>
        
            <div class="busyness-status-item no-data" onclick="openBusynessPanel()" title="Click to update Zone E">
                <span class="busyness-status-location">Zone E</span>
                <span class="busyness-status-level"></span>
                <span class="busyness-status-label">No Data</span>
                
            </div>
        
            <div class="busyness-status-item no-data" onclick="openBusynessPanel()" title="Click to update ABDs">
                <span class="busyness-status-location">ABDs</span>
                <span class="busyness-status-level"></span>
                <span class="busyness-status-label">No Data</span>
                
            </div>
        
            <div class="busyness-status-item no-data" onclick="openBusynessPanel()" title="Click to update Service Desk">
                <span class="busyness-status-location">Svc Desk</span>
                <span class="busyness-status-level"></span>
                <span class="busyness-status-label">No Data</span>
                
            </div>
        </div>
        </div>

        <div class="upload-btn-container">
            <input type="file" id="csv-upload" accept=".csv" style="display: none;">
           <button class="upload-btn" onclick="document.getElementById('csv-upload').click()">
     Upload CSV File
</button>
<button class="upload-btn" onclick="resetToUploadScreen()" id="reset-btn" style="display: block; background: rgb(107, 114, 128);">
     Upload New CSV
</button>
           
            <button class="save-btn save-html-btn" onclick="saveAsHTML()" id="save-html-btn" style="display: block;">
      Save as HTML File
</button>
<button class="add-flight-btn" onclick="openAddFlightModal()" id="add-flight-btn" style="display: block;">
     Add Flight
</button>
<button class="early-open-btn" onclick="openEarlyOpenModal()" id="early-open-btn" style="display: block;">
     Open Flights Earlier
    <span class="early-open-indicator" id="early-open-indicator" style="display: none;" onclick="showEarlyOpenStatus(event)"></span>
</button>
<button class="add-comment-main-btn" onclick="openCommentModalFromButton()" id="add-comment-main-btn" style="display: block;">
     Add Comment
</button>
<button class="refresh-all-btn" onclick="forceRefreshAllDevices()" id="refresh-all-btn" style="display: block;">
     Refresh All Devices
</button>
<button class="summary-report-btn" onclick="generateSummaryReport()" id="summary-report-btn" style="display: none;">
     Summary Report
</button>
<button class="leadership-team-btn" onclick="openLeadershipTeamModal()" id="leadership-team-btn" style="display: none;">
     Leadership Team
</button>
<button class="pax-loads-btn" onclick="openPaxLoadsModal()" id="pax-loads-btn" style="display: none;">
     Pax Loads
</button>
<button class="refresh-all-btn" onclick="clearAllStoredData()" id="clear-data-btn" style="display: none; background: #dc2626;">
     Clear All Stored Data
</button>
        </div>

        <div class="search-container" id="search-container" style="display: block;">
            <input type="text" class="search-input" id="search-input" placeholder=" Search by flight number or destination (e.g., 123, BNE)..." autocomplete="off">
<button class="search-clear-btn" id="search-clear-btn" onclick="clearSearch()"> </button>
        </div>

        <div id="loading" style="display: none;">
            <svg style="width: 4rem; height: 4rem; margin: 0 auto 1rem; opacity: 0.5;" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <circle cx="12" cy="12" r="10" stroke-width="2"></circle>
                <path d="M12 6v6l4 2" stroke-width="2" stroke-linecap="round"></path>
            </svg>
            <p>Upload CSV file to display flights</p>
        </div>

        <div class="comments-section" id="comments-section" style="display: none;">
           <div class="comments-header">
    <h2 class="comments-title"> Comments</h2>
    <div class="comments-actions">
        <button class="delete-all-btn" onclick="deleteAllComments()" id="delete-all-btn">Delete All</button>
    </div>
</div>
            <div id="comments-container"></div>
        </div>

        <!-- ZONE E COMMENTS SECTION (ORANGE THEMED) -->
        <div class="zone-e-comments-section" id="zone-e-comments-section" style="display: none;">
           <div class="zone-e-comments-header">
    <h2 class="zone-e-comments-title"> Zone E Comments</h2>
    <div class="comments-actions">
        <button class="zone-e-delete-all-btn" onclick="deleteAllZoneEComments()" id="zone-e-delete-all-btn">Delete All</button>
    </div>
</div>
            <div id="zone-e-comments-container"></div>
        </div>

       <div id="urgent-section" class="section-container" style="display: none;">
    <div class="section-header" onclick="toggleSection('urgent')">
        <div class="section-header-left">
            <div class="section-header-title">
                <span style="font-size: 1.5rem;"></span>
                <span>CLOSING SOON - PRIORITY</span>
                <span id="urgent-count" class="section-header-count"></span>
            </div>
        </div>
        <button class="section-toggle" id="urgent-toggle"></button>
    </div>
    <div id="urgent-flights" class="section-content expanded"></div>
</div>
<!-- ADD THIS NEW EXTENDED SECTION HERE -->
<div id="extended-section" class="section-container" style="display: none;">
    <div class="section-header" onclick="toggleSection('extended')">
        <div class="section-header-left">
            <div class="section-header-title">
                <span style="font-size: 1.5rem;"></span>
                <span>CHECK-IN EXTENDED</span>
                <span id="extended-count" class="section-header-count"></span>
            </div>
        </div>
        <button class="section-toggle" id="extended-toggle"></button>
    </div>
    <div id="extended-flights" class="section-content expanded"></div>
</div>
      
       <div id="active-section" class="section-container" style="display: none;">
    <div class="section-header" onclick="toggleSection('active')">
        <div class="section-header-left">
            <div class="section-header-title">
                <span style="font-size: 1.5rem;"></span>
                <span id="active-title">Check-in Open</span>
                <span id="active-count" class="section-header-count"></span>
            </div>
        </div>
        <button class="section-toggle" id="active-toggle">+</button>
    </div>
    <div id="active-flights" class="section-content"></div>
</div>
  <div id="not-open-section" class="section-container" style="display: block;">
    <div class="section-header" onclick="toggleSection('notopen')">
        <div class="section-header-left">
            <div class="section-header-title">
                <span style="font-size: 1.5rem;"></span>
                <span>Check-in Not Yet Open</span>
                <span id="notopen-count" class="section-header-count">57</span>
            </div>
        </div>
        <button class="section-toggle" id="notopen-toggle">+</button>
    </div>
    <div id="notopen-flights" class="section-content"><div class="flight-card not-open notopen-section-card">
    <!-- TOP ROW: Three bubbles -->
    <div class="section-left">
        <div class="flight-number-glass">
            <span class="editable-flight-num editable">JQ719</span>
        </div>
    </div>
    
    <div class="section-center">
        <div class="destination-glass">
            <span class="dest-display editable">HBA</span>
        </div>
    </div>
    
    <div class="section-right-top">
        <div class="close-time-glass">
            <span class="close-time-label">Closes:</span>
            <span class="close-time-value">05:20</span>
        </div>
    </div>
    
    <!-- MIDDLE ROW: Timer and flight info -->
    <div class="section-timer">
        
        <div style="font-size: 1.5rem; color: #6b7280; margin-bottom: 0.5rem; font-weight: bold;">
    Departure: <span class="editable-dep editable" style="font-weight: bold; font-size: 1.3rem; color: #000345;">06:00</span>
</div>
        
        <div class="timer-content-wrapper" style="margin-top: 0.5rem;">
            
            <div class="timer" style="font-size: 1.5rem;">NOT OPEN</div>
        
        </div>
    </div>
    
    <!-- BOTTOM ROW: Status badge and delete button -->
    <div class="section-bottom">
        <div class="status-badge-wrapper">
            <div class="status-badge status-not-open" data-flight-id="1771399212973"> 3 HOURS FROM DEPARTURE</div>
        </div>
        <button class="permanent-delete-btn" onclick="deleteFlight(1771399212973)">
             Delete
        </button>
    </div>
</div><div class="flight-card not-open notopen-section-card">
    <!-- TOP ROW: Three bubbles -->
    <div class="section-left">
        <div class="flight-number-glass">
            <span class="editable-flight-num editable">JQ501</span>
        </div>
    </div>
    
    <div class="section-center">
        <div class="destination-glass">
            <span class="dest-display editable">MEL</span>
        </div>
    </div>
    
    <div class="section-right-top">
        <div class="close-time-glass">
            <span class="close-time-label">Closes:</span>
            <span class="close-time-value">05:20</span>
        </div>
    </div>
    
    <!-- MIDDLE ROW: Timer and flight info -->
    <div class="section-timer">
        
        <div style="font-size: 1.5rem; color: #6b7280; margin-bottom: 0.5rem; font-weight: bold;">
    Departure: <span class="editable-dep editable" style="font-weight: bold; font-size: 1.3rem; color: #000345;">06:00</span>
</div>
        
        <div class="timer-content-wrapper" style="margin-top: 0.5rem;">
            
            <div class="timer" style="font-size: 1.5rem;">NOT OPEN</div>
        
        </div>
    </div>
    
    <!-- BOTTOM ROW: Status badge and delete button -->
    <div class="section-bottom">
        <div class="status-badge-wrapper">
            <div class="status-badge status-not-open" data-flight-id="1771399221205"> 3 HOURS FROM DEPARTURE</div>
        </div>
        <button class="permanent-delete-btn" onclick="deleteFlight(1771399221205)">
             Delete
        </button>
    </div>
</div><div class="flight-card not-open notopen-section-card">
    <!-- TOP ROW: Three bubbles -->
    <div class="section-left">
        <div class="flight-number-glass">
            <span class="editable-flight-num editable">JQ603</span>
        </div>
    </div>
    
    <div class="section-center">
        <div class="destination-glass">
            <span class="dest-display editable">AVV</span>
        </div>
    </div>
    
    <div class="section-right-top">
        <div class="close-time-glass">
            <span class="close-time-label">Closes:</span>
            <span class="close-time-value">05:20</span>
        </div>
    </div>
    
    <!-- MIDDLE ROW: Timer and flight info -->
    <div class="section-timer">
        
        <div style="font-size: 1.5rem; color: #6b7280; margin-bottom: 0.5rem; font-weight: bold;">
    Departure: <span class="editable-dep editable" style="font-weight: bold; font-size: 1.3rem; color: #000345;">06:00</span>
</div>
        
        <div class="timer-content-wrapper" style="margin-top: 0.5rem;">
            
            <div class="timer" style="font-size: 1.5rem;">NOT OPEN</div>
        
        </div>
    </div>
    
    <!-- BOTTOM ROW: Status badge and delete button -->
    <div class="section-bottom">
        <div class="status-badge-wrapper">
            <div class="status-badge status-not-open" data-flight-id="1771399214173"> 3 HOURS FROM DEPARTURE</div>
        </div>
        <button class="permanent-delete-btn" onclick="deleteFlight(1771399214173)">
             Delete
        </button>
    </div>
</div><div class="flight-card not-open notopen-section-card">
    <!-- TOP ROW: Three bubbles -->
    <div class="section-left">
        <div class="flight-number-glass">
            <span class="editable-flight-num editable">JQ400</span>
        </div>
    </div>
    
    <div class="section-center">
        <div class="destination-glass">
            <span class="dest-display editable">OOL</span>
        </div>
    </div>
    
    <div class="section-right-top">
        <div class="close-time-glass">
            <span class="close-time-label">Closes:</span>
            <span class="close-time-value">05:30</span>
        </div>
    </div>
    
    <!-- MIDDLE ROW: Timer and flight info -->
    <div class="section-timer">
        
        <div style="font-size: 1.5rem; color: #6b7280; margin-bottom: 0.5rem; font-weight: bold;">
    Departure: <span class="editable-dep editable" style="font-weight: bold; font-size: 1.3rem; color: #000345;">06:10</span>
</div>
        
        <div class="timer-content-wrapper" style="margin-top: 0.5rem;">
            
            <div class="timer" style="font-size: 1.5rem;">NOT OPEN</div>
        
        </div>
    </div>
    
    <!-- BOTTOM ROW: Status badge and delete button -->
    <div class="section-bottom">
        <div class="status-badge-wrapper">
            <div class="status-badge status-not-open" data-flight-id="1771399218883"> 3 HOURS FROM DEPARTURE</div>
        </div>
        <button class="permanent-delete-btn" onclick="deleteFlight(1771399218883)">
             Delete
        </button>
    </div>
</div><div class="flight-card not-open notopen-section-card">
    <!-- TOP ROW: Three bubbles -->
    <div class="section-left">
        <div class="flight-number-glass">
            <span class="editable-flight-num editable">JQ810</span>
        </div>
    </div>
    
    <div class="section-center">
        <div class="destination-glass">
            <span class="dest-display editable">BNE</span>
        </div>
    </div>
    
    <div class="section-right-top">
        <div class="close-time-glass">
            <span class="close-time-label">Closes:</span>
            <span class="close-time-value">05:40</span>
        </div>
    </div>
    
    <!-- MIDDLE ROW: Timer and flight info -->
    <div class="section-timer">
        
        <div style="font-size: 1.5rem; color: #6b7280; margin-bottom: 0.5rem; font-weight: bold;">
    Departure: <span class="editable-dep editable" style="font-weight: bold; font-size: 1.3rem; color: #000345;">06:20</span>
</div>
        
        <div class="timer-content-wrapper" style="margin-top: 0.5rem;">
            
            <div class="timer" style="font-size: 1.5rem;">NOT OPEN</div>
        
        </div>
    </div>
    
    <!-- BOTTOM ROW: Status badge and delete button -->
    <div class="section-bottom">
        <div class="status-badge-wrapper">
            <div class="status-badge status-not-open" data-flight-id="1771399212626"> 3 HOURS FROM DEPARTURE</div>
        </div>
        <button class="permanent-delete-btn" onclick="deleteFlight(1771399212626)">
             Delete
        </button>
    </div>
</div><div class="flight-card not-open notopen-section-card">
    <!-- TOP ROW: Three bubbles -->
    <div class="section-left">
        <div class="flight-number-glass">
            <span class="editable-flight-num editable">JQ950</span>
        </div>
    </div>
    
    <div class="section-center">
        <div class="destination-glass">
            <span class="dest-display editable">CNS</span>
        </div>
    </div>
    
    <div class="section-right-top">
        <div class="close-time-glass">
            <span class="close-time-label">Closes:</span>
            <span class="close-time-value">05:40</span>
        </div>
    </div>
    
    <!-- MIDDLE ROW: Timer and flight info -->
    <div class="section-timer">
        
        <div style="font-size: 1.5rem; color: #6b7280; margin-bottom: 0.5rem; font-weight: bold;">
    Departure: <span class="editable-dep editable" style="font-weight: bold; font-size: 1.3rem; color: #000345;">06:20</span>
</div>
        
        <div class="timer-content-wrapper" style="margin-top: 0.5rem;">
            
            <div class="timer" style="font-size: 1.5rem;">NOT OPEN</div>
        
        </div>
    </div>
    
    <!-- BOTTOM ROW: Status badge and delete button -->
    <div class="section-bottom">
        <div class="status-badge-wrapper">
            <div class="status-badge status-not-open" data-flight-id="1771399216860"> 3 HOURS FROM DEPARTURE</div>
        </div>
        <button class="permanent-delete-btn" onclick="deleteFlight(1771399216860)">
             Delete
        </button>
    </div>
</div><div class="flight-card not-open notopen-section-card">
    <!-- TOP ROW: Three bubbles -->
    <div class="section-left">
        <div class="flight-number-glass">
            <span class="editable-flight-num editable">JQ912</span>
        </div>
    </div>
    
    <div class="section-center">
        <div class="destination-glass">
            <span class="dest-display editable">TSV</span>
        </div>
    </div>
    
    <div class="section-right-top">
        <div class="close-time-glass">
            <span class="close-time-label">Closes:</span>
            <span class="close-time-value">06:00</span>
        </div>
    </div>
    
    <!-- MIDDLE ROW: Timer and flight info -->
    <div class="section-timer">
        
        <div style="font-size: 1.5rem; color: #6b7280; margin-bottom: 0.5rem; font-weight: bold;">
    Departure: <span class="editable-dep editable" style="font-weight: bold; font-size: 1.3rem; color: #000345;">06:40</span>
</div>
        
        <div class="timer-content-wrapper" style="margin-top: 0.5rem;">
            
            <div class="timer" style="font-size: 1.5rem;">NOT OPEN</div>
        
        </div>
    </div>
    
    <!-- BOTTOM ROW: Status badge and delete button -->
    <div class="section-bottom">
        <div class="status-badge-wrapper">
            <div class="status-badge status-not-open" data-flight-id="1771399215475"> 3 HOURS FROM DEPARTURE</div>
        </div>
        <button class="permanent-delete-btn" onclick="deleteFlight(1771399215475)">
             Delete
        </button>
    </div>
</div><div class="flight-card not-open notopen-section-card">
    <!-- TOP ROW: Three bubbles -->
    <div class="section-left">
        <div class="flight-number-glass">
            <span class="editable-flight-num editable">JQ760</span>
        </div>
    </div>
    
    <div class="section-center">
        <div class="destination-glass">
            <span class="dest-display editable">ADL</span>
        </div>
    </div>
    
    <div class="section-right-top">
        <div class="close-time-glass">
            <span class="close-time-label">Closes:</span>
            <span class="close-time-value">06:20</span>
        </div>
    </div>
    
    <!-- MIDDLE ROW: Timer and flight info -->
    <div class="section-timer">
        <div style="font-size: rem; margin-bottom: 1.5rem;"><span class="turnaround-icon" style="font-size: 2.4rem; letter-spacing: 0.5rem;"></span></div>
        <div style="font-size: 1.5rem; color: #6b7280; margin-bottom: 0.5rem; font-weight: bold;">
    Departure: <span class="editable-dep editable" style="font-weight: bold; font-size: 1.3rem; color: #000345;">07:00</span>
</div>
        
        <div class="timer-content-wrapper" style="margin-top: 0.5rem;">
            
            <div class="timer" style="font-size: 1.5rem;">NOT OPEN</div>
        
        </div>
    </div>
    
    <!-- BOTTOM ROW: Status badge and delete button -->
    <div class="section-bottom">
        <div class="status-badge-wrapper">
            <div class="status-badge status-not-open" data-flight-id="1771399221965"> 3 HOURS FROM DEPARTURE</div>
        </div>
        <button class="permanent-delete-btn" onclick="deleteFlight(1771399221965)">
             Delete
        </button>
    </div>
</div><div class="flight-card not-open notopen-section-card">
    <!-- TOP ROW: Three bubbles -->
    <div class="section-left">
        <div class="flight-number-glass">
            <span class="editable-flight-num editable">JQ505</span>
        </div>
    </div>
    
    <div class="section-center">
        <div class="destination-glass">
            <span class="dest-display editable">MEL</span>
        </div>
    </div>
    
    <div class="section-right-top">
        <div class="close-time-glass">
            <span class="close-time-label">Closes:</span>
            <span class="close-time-value">06:20</span>
        </div>
    </div>
    
    <!-- MIDDLE ROW: Timer and flight info -->
    <div class="section-timer">
        
        <div style="font-size: 1.5rem; color: #6b7280; margin-bottom: 0.5rem; font-weight: bold;">
    Departure: <span class="editable-dep editable" style="font-weight: bold; font-size: 1.3rem; color: #000345;">07:00</span>
</div>
        
        <div class="timer-content-wrapper" style="margin-top: 0.5rem;">
            
            <div class="timer" style="font-size: 1.5rem;">NOT OPEN</div>
        
        </div>
    </div>
    
    <!-- BOTTOM ROW: Status badge and delete button -->
    <div class="section-bottom">
        <div class="status-badge-wrapper">
            <div class="status-badge status-not-open" data-flight-id="1771399217691"> 3 HOURS FROM DEPARTURE</div>
        </div>
        <button class="permanent-delete-btn" onclick="deleteFlight(1771399217691)">
             Delete
        </button>
    </div>
</div><div class="flight-card not-open notopen-section-card">
    <!-- TOP ROW: Three bubbles -->
    <div class="section-left">
        <div class="flight-number-glass">
            <span class="editable-flight-num editable">JQ784</span>
        </div>
    </div>
    
    <div class="section-center">
        <div class="destination-glass">
            <span class="dest-display editable">MCY</span>
        </div>
    </div>
    
    <div class="section-right-top">
        <div class="close-time-glass">
            <span class="close-time-label">Closes:</span>
            <span class="close-time-value">06:25</span>
        </div>
    </div>
    
    <!-- MIDDLE ROW: Timer and flight info -->
    <div class="section-timer">
        
        <div style="font-size: 1.5rem; color: #6b7280; margin-bottom: 0.5rem; font-weight: bold;">
    Departure: <span class="editable-dep editable" style="font-weight: bold; font-size: 1.3rem; color: #000345;">07:05</span>
</div>
        
        <div class="timer-content-wrapper" style="margin-top: 0.5rem;">
            
            <div class="timer" style="font-size: 1.5rem;">NOT OPEN</div>
        
        </div>
    </div>
    
    <!-- BOTTOM ROW: Status badge and delete button -->
    <div class="section-bottom">
        <div class="status-badge-wrapper">
            <div class="status-badge status-not-open" data-flight-id="1771399215368"> 3 HOURS FROM DEPARTURE</div>
        </div>
        <button class="permanent-delete-btn" onclick="deleteFlight(1771399215368)">
             Delete
        </button>
    </div>
</div><div class="flight-card not-open notopen-section-card">
    <!-- TOP ROW: Three bubbles -->
    <div class="section-left">
        <div class="flight-number-glass">
            <span class="editable-flight-num editable">JQ402</span>
        </div>
    </div>
    
    <div class="section-center">
        <div class="destination-glass">
            <span class="dest-display editable">OOL</span>
        </div>
    </div>
    
    <div class="section-right-top">
        <div class="close-time-glass">
            <span class="close-time-label">Closes:</span>
            <span class="close-time-value">06:40</span>
        </div>
    </div>
    
    <!-- MIDDLE ROW: Timer and flight info -->
    <div class="section-timer">
        
        <div style="font-size: 1.5rem; color: #6b7280; margin-bottom: 0.5rem; font-weight: bold;">
    Departure: <span class="editable-dep editable" style="font-weight: bold; font-size: 1.3rem; color: #000345;">07:20</span>
</div>
        
        <div class="timer-content-wrapper" style="margin-top: 0.5rem;">
            
            <div class="timer" style="font-size: 1.5rem;">NOT OPEN</div>
        
        </div>
    </div>
    
    <!-- BOTTOM ROW: Status badge and delete button -->
    <div class="section-bottom">
        <div class="status-badge-wrapper">
            <div class="status-badge status-not-open" data-flight-id="1771399219947"> 3 HOURS FROM DEPARTURE</div>
        </div>
        <button class="permanent-delete-btn" onclick="deleteFlight(1771399219947)">
             Delete
        </button>
    </div>
</div><div class="flight-card not-open notopen-section-card">
    <!-- TOP ROW: Three bubbles -->
    <div class="section-left">
        <div class="flight-number-glass">
            <span class="editable-flight-num editable">JQ456</span>
        </div>
    </div>
    
    <div class="section-center">
        <div class="destination-glass">
            <span class="dest-display editable">BNK</span>
        </div>
    </div>
    
    <div class="section-right-top">
        <div class="close-time-glass">
            <span class="close-time-label">Closes:</span>
            <span class="close-time-value">06:40</span>
        </div>
    </div>
    
    <!-- MIDDLE ROW: Timer and flight info -->
    <div class="section-timer">
        <div style="font-size: rem; margin-bottom: 1.5rem;"><span class="turnaround-icon" style="font-size: 2.4rem; letter-spacing: 0.5rem;"></span></div>
        <div style="font-size: 1.5rem; color: #6b7280; margin-bottom: 0.5rem; font-weight: bold;">
    Departure: <span class="editable-dep editable" style="font-weight: bold; font-size: 1.3rem; color: #000345;">07:20</span>
</div>
        
        <div class="timer-content-wrapper" style="margin-top: 0.5rem;">
            
            <div class="timer" style="font-size: 1.5rem;">NOT OPEN</div>
        
        </div>
    </div>
    
    <!-- BOTTOM ROW: Status badge and delete button -->
    <div class="section-bottom">
        <div class="status-badge-wrapper">
            <div class="status-badge status-not-open" data-flight-id="1771399214401"> 3 HOURS FROM DEPARTURE</div>
        </div>
        <button class="permanent-delete-btn" onclick="deleteFlight(1771399214401)">
             Delete
        </button>
    </div>
</div><div class="flight-card not-open notopen-section-card">
    <!-- TOP ROW: Three bubbles -->
    <div class="section-left">
        <div class="flight-number-glass">
            <span class="editable-flight-num editable">JQ507</span>
        </div>
    </div>
    
    <div class="section-center">
        <div class="destination-glass">
            <span class="dest-display editable">MEL</span>
        </div>
    </div>
    
    <div class="section-right-top">
        <div class="close-time-glass">
            <span class="close-time-label">Closes:</span>
            <span class="close-time-value">07:30</span>
        </div>
    </div>
    
    <!-- MIDDLE ROW: Timer and flight info -->
    <div class="section-timer">
        
        <div style="font-size: 1.5rem; color: #6b7280; margin-bottom: 0.5rem; font-weight: bold;">
    Departure: <span class="editable-dep editable" style="font-weight: bold; font-size: 1.3rem; color: #000345;">08:10</span>
</div>
        
        <div class="timer-content-wrapper" style="margin-top: 0.5rem;">
            
            <div class="timer" style="font-size: 1.5rem;">NOT OPEN</div>
        
        </div>
    </div>
    
    <!-- BOTTOM ROW: Status badge and delete button -->
    <div class="section-bottom">
        <div class="status-badge-wrapper">
            <div class="status-badge status-not-open" data-flight-id="1771399218759"> 3 HOURS FROM DEPARTURE</div>
        </div>
        <button class="permanent-delete-btn" onclick="deleteFlight(1771399218759)">
             Delete
        </button>
    </div>
</div><div class="flight-card not-open notopen-section-card">
    <!-- TOP ROW: Three bubbles -->
    <div class="section-left">
        <div class="flight-number-glass">
            <span class="editable-flight-num editable">JQ605</span>
        </div>
    </div>
    
    <div class="section-center">
        <div class="destination-glass">
            <span class="dest-display editable">AVV</span>
        </div>
    </div>
    
    <div class="section-right-top">
        <div class="close-time-glass">
            <span class="close-time-label">Closes:</span>
            <span class="close-time-value">07:30</span>
        </div>
    </div>
    
    <!-- MIDDLE ROW: Timer and flight info -->
    <div class="section-timer">
        <div style="font-size: rem; margin-bottom: 1.5rem;"><span class="turnaround-icon" style="font-size: 2.4rem; letter-spacing: 0.5rem;"></span></div>
        <div style="font-size: 1.5rem; color: #6b7280; margin-bottom: 0.5rem; font-weight: bold;">
    Departure: <span class="editable-dep editable" style="font-weight: bold; font-size: 1.3rem; color: #000345;">08:10</span>
</div>
        
        <div class="timer-content-wrapper" style="margin-top: 0.5rem;">
            
            <div class="timer" style="font-size: 1.5rem;">NOT OPEN</div>
        
        </div>
    </div>
    
    <!-- BOTTOM ROW: Status badge and delete button -->
    <div class="section-bottom">
        <div class="status-badge-wrapper">
            <div class="status-badge status-not-open" data-flight-id="1771399221903"> 3 HOURS FROM DEPARTURE</div>
        </div>
        <button class="permanent-delete-btn" onclick="deleteFlight(1771399221903)">
             Delete
        </button>
    </div>
</div><div class="flight-card not-open notopen-section-card">
    <!-- TOP ROW: Three bubbles -->
    <div class="section-left">
        <div class="flight-number-glass">
            <span class="editable-flight-num editable">JQ404</span>
        </div>
    </div>
    
    <div class="section-center">
        <div class="destination-glass">
            <span class="dest-display editable">OOL</span>
        </div>
    </div>
    
    <div class="section-right-top">
        <div class="close-time-glass">
            <span class="close-time-label">Closes:</span>
            <span class="close-time-value">08:30</span>
        </div>
    </div>
    
    <!-- MIDDLE ROW: Timer and flight info -->
    <div class="section-timer">
        <div style="font-size: rem; margin-bottom: 1.5rem;"><span class="turnaround-icon" style="font-size: 2.4rem; letter-spacing: 0.5rem;"></span></div>
        <div style="font-size: 1.5rem; color: #6b7280; margin-bottom: 0.5rem; font-weight: bold;">
    Departure: <span class="editable-dep editable" style="font-weight: bold; font-size: 1.3rem; color: #000345;">09:10</span>
</div>
        
        <div class="timer-content-wrapper" style="margin-top: 0.5rem;">
            
            <div class="timer" style="font-size: 1.5rem;">NOT OPEN</div>
        
        </div>
    </div>
    
    <!-- BOTTOM ROW: Status badge and delete button -->
    <div class="section-bottom">
        <div class="status-badge-wrapper">
            <div class="status-badge status-not-open" data-flight-id="1771399213882"> 3 HOURS FROM DEPARTURE</div>
        </div>
        <button class="permanent-delete-btn" onclick="deleteFlight(1771399213882)">
             Delete
        </button>
    </div>
</div><div class="flight-card not-open notopen-section-card">
    <!-- TOP ROW: Three bubbles -->
    <div class="section-left">
        <div class="flight-number-glass">
            <span class="editable-flight-num editable">JQ509</span>
        </div>
    </div>
    
    <div class="section-center">
        <div class="destination-glass">
            <span class="dest-display editable">MEL</span>
        </div>
    </div>
    
    <div class="section-right-top">
        <div class="close-time-glass">
            <span class="close-time-label">Closes:</span>
            <span class="close-time-value">08:35</span>
        </div>
    </div>
    
    <!-- MIDDLE ROW: Timer and flight info -->
    <div class="section-timer">
        <div style="font-size: rem; margin-bottom: 1.5rem;"><span class="turnaround-icon" style="font-size: 2.4rem; letter-spacing: 0.5rem;"></span></div>
        <div style="font-size: 1.5rem; color: #6b7280; margin-bottom: 0.5rem; font-weight: bold;">
    Departure: <span class="editable-dep editable" style="font-weight: bold; font-size: 1.3rem; color: #000345;">09:15</span>
</div>
        
        <div class="timer-content-wrapper" style="margin-top: 0.5rem;">
            
            <div class="timer" style="font-size: 1.5rem;">NOT OPEN</div>
        
        </div>
    </div>
    
    <!-- BOTTOM ROW: Status badge and delete button -->
    <div class="section-bottom">
        <div class="status-badge-wrapper">
            <div class="status-badge status-not-open" data-flight-id="1771399214549"> 3 HOURS FROM DEPARTURE</div>
        </div>
        <button class="permanent-delete-btn" onclick="deleteFlight(1771399214549)">
             Delete
        </button>
    </div>
</div><div class="flight-card not-open notopen-section-card">
    <!-- TOP ROW: Three bubbles -->
    <div class="section-left">
        <div class="flight-number-glass">
            <span class="editable-flight-num editable">JQ812</span>
        </div>
    </div>
    
    <div class="section-center">
        <div class="destination-glass">
            <span class="dest-display editable">BNE</span>
        </div>
    </div>
    
    <div class="section-right-top">
        <div class="close-time-glass">
            <span class="close-time-label">Closes:</span>
            <span class="close-time-value">08:55</span>
        </div>
    </div>
    
    <!-- MIDDLE ROW: Timer and flight info -->
    <div class="section-timer">
        <div style="font-size: rem; margin-bottom: 1.5rem;"><span class="turnaround-icon" style="font-size: 2.4rem; letter-spacing: 0.5rem;"></span></div>
        <div style="font-size: 1.5rem; color: #6b7280; margin-bottom: 0.5rem; font-weight: bold;">
    Departure: <span class="editable-dep editable" style="font-weight: bold; font-size: 1.3rem; color: #000345;">09:35</span>
</div>
        
        <div class="timer-content-wrapper" style="margin-top: 0.5rem;">
            
            <div class="timer" style="font-size: 1.5rem;">NOT OPEN</div>
        
        </div>
    </div>
    
    <!-- BOTTOM ROW: Status badge and delete button -->
    <div class="section-bottom">
        <div class="status-badge-wrapper">
            <div class="status-badge status-not-open" data-flight-id="1771399220677"> 3 HOURS FROM DEPARTURE</div>
        </div>
        <button class="permanent-delete-btn" onclick="deleteFlight(1771399220677)">
             Delete
        </button>
    </div>
</div><div class="flight-card not-open notopen-section-card">
    <!-- TOP ROW: Three bubbles -->
    <div class="section-left">
        <div class="flight-number-glass">
            <span class="editable-flight-num editable">JQ511</span>
        </div>
    </div>
    
    <div class="section-center">
        <div class="destination-glass">
            <span class="dest-display editable">MEL</span>
        </div>
    </div>
    
    <div class="section-right-top">
        <div class="close-time-glass">
            <span class="close-time-label">Closes:</span>
            <span class="close-time-value">09:00</span>
        </div>
    </div>
    
    <!-- MIDDLE ROW: Timer and flight info -->
    <div class="section-timer">
        <div style="font-size: rem; margin-bottom: 1.5rem;"><span class="turnaround-icon" style="font-size: 2.4rem; letter-spacing: 0.5rem;"></span></div>
        <div style="font-size: 1.5rem; color: #6b7280; margin-bottom: 0.5rem; font-weight: bold;">
    Departure: <span class="editable-dep editable" style="font-weight: bold; font-size: 1.3rem; color: #000345;">09:40</span>
</div>
        
        <div class="timer-content-wrapper" style="margin-top: 0.5rem;">
            
            <div class="timer" style="font-size: 1.5rem;">NOT OPEN</div>
        
        </div>
    </div>
    
    <!-- BOTTOM ROW: Status badge and delete button -->
    <div class="section-bottom">
        <div class="status-badge-wrapper">
            <div class="status-badge status-not-open" data-flight-id="1771399216498"> 3 HOURS FROM DEPARTURE</div>
        </div>
        <button class="permanent-delete-btn" onclick="deleteFlight(1771399216498)">
             Delete
        </button>
    </div>
</div><div class="flight-card not-open notopen-section-card">
    <!-- TOP ROW: Three bubbles -->
    <div class="section-left">
        <div class="flight-number-glass">
            <span class="editable-flight-num editable">JQ406</span>
        </div>
    </div>
    
    <div class="section-center">
        <div class="destination-glass">
            <span class="dest-display editable">OOL</span>
        </div>
    </div>
    
    <div class="section-right-top">
        <div class="close-time-glass">
            <span class="close-time-label">Closes:</span>
            <span class="close-time-value">09:35</span>
        </div>
    </div>
    
    <!-- MIDDLE ROW: Timer and flight info -->
    <div class="section-timer">
        <div style="font-size: rem; margin-bottom: 1.5rem;"><span class="turnaround-icon" style="font-size: 2.4rem; letter-spacing: 0.5rem;"></span></div>
        <div style="font-size: 1.5rem; color: #6b7280; margin-bottom: 0.5rem; font-weight: bold;">
    Departure: <span class="editable-dep editable" style="font-weight: bold; font-size: 1.3rem; color: #000345;">10:15</span>
</div>
        
        <div class="timer-content-wrapper" style="margin-top: 0.5rem;">
            
            <div class="timer" style="font-size: 1.5rem;">NOT OPEN</div>
        
        </div>
    </div>
    
    <!-- BOTTOM ROW: Status badge and delete button -->
    <div class="section-bottom">
        <div class="status-badge-wrapper">
            <div class="status-badge status-not-open" data-flight-id="1771399219988"> 3 HOURS FROM DEPARTURE</div>
        </div>
        <button class="permanent-delete-btn" onclick="deleteFlight(1771399219988)">
             Delete
        </button>
    </div>
</div><div class="flight-card not-open notopen-section-card">
    <!-- TOP ROW: Three bubbles -->
    <div class="section-left">
        <div class="flight-number-glass">
            <span class="editable-flight-num editable">JQ458</span>
        </div>
    </div>
    
    <div class="section-center">
        <div class="destination-glass">
            <span class="dest-display editable">BNK</span>
        </div>
    </div>
    
    <div class="section-right-top">
        <div class="close-time-glass">
            <span class="close-time-label">Closes:</span>
            <span class="close-time-value">09:40</span>
        </div>
    </div>
    
    <!-- MIDDLE ROW: Timer and flight info -->
    <div class="section-timer">
        <div style="font-size: rem; margin-bottom: 1.5rem;"><span class="turnaround-icon" style="font-size: 2.4rem; letter-spacing: 0.5rem;"></span></div>
        <div style="font-size: 1.5rem; color: #6b7280; margin-bottom: 0.5rem; font-weight: bold;">
    Departure: <span class="editable-dep editable" style="font-weight: bold; font-size: 1.3rem; color: #000345;">10:20</span>
</div>
        
        <div class="timer-content-wrapper" style="margin-top: 0.5rem;">
            
            <div class="timer" style="font-size: 1.5rem;">NOT OPEN</div>
        
        </div>
    </div>
    
    <!-- BOTTOM ROW: Status badge and delete button -->
    <div class="section-bottom">
        <div class="status-badge-wrapper">
            <div class="status-badge status-not-open" data-flight-id="1771399214267"> 3 HOURS FROM DEPARTURE</div>
        </div>
        <button class="permanent-delete-btn" onclick="deleteFlight(1771399214267)">
             Delete
        </button>
    </div>
</div><div class="flight-card not-open notopen-section-card">
    <!-- TOP ROW: Three bubbles -->
    <div class="section-left">
        <div class="flight-number-glass">
            <span class="editable-flight-num editable">JQ786</span>
        </div>
    </div>
    
    <div class="section-center">
        <div class="destination-glass">
            <span class="dest-display editable">MCY</span>
        </div>
    </div>
    
    <div class="section-right-top">
        <div class="close-time-glass">
            <span class="close-time-label">Closes:</span>
            <span class="close-time-value">10:10</span>
        </div>
    </div>
    
    <!-- MIDDLE ROW: Timer and flight info -->
    <div class="section-timer">
        <div style="font-size: rem; margin-bottom: 1.5rem;"><span class="turnaround-icon" style="font-size: 2.4rem; letter-spacing: 0.5rem;"></span></div>
        <div style="font-size: 1.5rem; color: #6b7280; margin-bottom: 0.5rem; font-weight: bold;">
    Departure: <span class="editable-dep editable" style="font-weight: bold; font-size: 1.3rem; color: #000345;">10:50</span>
</div>
        
        <div class="timer-content-wrapper" style="margin-top: 0.5rem;">
            
            <div class="timer" style="font-size: 1.5rem;">NOT OPEN</div>
        
        </div>
    </div>
    
    <!-- BOTTOM ROW: Status badge and delete button -->
    <div class="section-bottom">
        <div class="status-badge-wrapper">
            <div class="status-badge status-not-open" data-flight-id="1771399221851"> 3 HOURS FROM DEPARTURE</div>
        </div>
        <button class="permanent-delete-btn" onclick="deleteFlight(1771399221851)">
             Delete
        </button>
    </div>
</div><div class="flight-card not-open notopen-section-card">
    <!-- TOP ROW: Three bubbles -->
    <div class="section-left">
        <div class="flight-number-glass">
            <span class="editable-flight-num editable">JQ513</span>
        </div>
    </div>
    
    <div class="section-center">
        <div class="destination-glass">
            <span class="dest-display editable">MEL</span>
        </div>
    </div>
    
    <div class="section-right-top">
        <div class="close-time-glass">
            <span class="close-time-label">Closes:</span>
            <span class="close-time-value">10:10</span>
        </div>
    </div>
    
    <!-- MIDDLE ROW: Timer and flight info -->
    <div class="section-timer">
        
        <div style="font-size: 1.5rem; color: #6b7280; margin-bottom: 0.5rem; font-weight: bold;">
    Departure: <span class="editable-dep editable" style="font-weight: bold; font-size: 1.3rem; color: #000345;">10:50</span>
</div>
        
        <div class="timer-content-wrapper" style="margin-top: 0.5rem;">
            
            <div class="timer" style="font-size: 1.5rem;">NOT OPEN</div>
        
        </div>
    </div>
    
    <!-- BOTTOM ROW: Status badge and delete button -->
    <div class="section-bottom">
        <div class="status-badge-wrapper">
            <div class="status-badge status-not-open" data-flight-id="1771399214168"> 3 HOURS FROM DEPARTURE</div>
        </div>
        <button class="permanent-delete-btn" onclick="deleteFlight(1771399214168)">
             Delete
        </button>
    </div>
</div><div class="flight-card not-open notopen-section-card">
    <!-- TOP ROW: Three bubbles -->
    <div class="section-left">
        <div class="flight-number-glass">
            <span class="editable-flight-num editable">JQ762</span>
        </div>
    </div>
    
    <div class="section-center">
        <div class="destination-glass">
            <span class="dest-display editable">ADL</span>
        </div>
    </div>
    
    <div class="section-right-top">
        <div class="close-time-glass">
            <span class="close-time-label">Closes:</span>
            <span class="close-time-value">10:20</span>
        </div>
    </div>
    
    <!-- MIDDLE ROW: Timer and flight info -->
    <div class="section-timer">
        <div style="font-size: rem; margin-bottom: 1.5rem;"><span class="turnaround-icon" style="font-size: 2.4rem; letter-spacing: 0.5rem;"></span></div>
        <div style="font-size: 1.5rem; color: #6b7280; margin-bottom: 0.5rem; font-weight: bold;">
    Departure: <span class="editable-dep editable" style="font-weight: bold; font-size: 1.3rem; color: #000345;">11:00</span>
</div>
        
        <div class="timer-content-wrapper" style="margin-top: 0.5rem;">
            
            <div class="timer" style="font-size: 1.5rem;">NOT OPEN</div>
        
        </div>
    </div>
    
    <!-- BOTTOM ROW: Status badge and delete button -->
    <div class="section-bottom">
        <div class="status-badge-wrapper">
            <div class="status-badge status-not-open" data-flight-id="1771399221556"> 3 HOURS FROM DEPARTURE</div>
        </div>
        <button class="permanent-delete-btn" onclick="deleteFlight(1771399221556)">
             Delete
        </button>
    </div>
</div><div class="flight-card not-open notopen-section-card">
    <!-- TOP ROW: Three bubbles -->
    <div class="section-left">
        <div class="flight-number-glass">
            <span class="editable-flight-num editable">JQ840</span>
        </div>
    </div>
    
    <div class="section-center">
        <div class="destination-glass">
            <span class="dest-display editable">PPP</span>
        </div>
    </div>
    
    <div class="section-right-top">
        <div class="close-time-glass">
            <span class="close-time-label">Closes:</span>
            <span class="close-time-value">11:00</span>
        </div>
    </div>
    
    <!-- MIDDLE ROW: Timer and flight info -->
    <div class="section-timer">
        <div style="font-size: rem; margin-bottom: 1.5rem;"><span class="turnaround-icon" style="font-size: 2.4rem; letter-spacing: 0.5rem;"></span></div>
        <div style="font-size: 1.5rem; color: #6b7280; margin-bottom: 0.5rem; font-weight: bold;">
    Departure: <span class="editable-dep editable" style="font-weight: bold; font-size: 1.3rem; color: #000345;">11:40</span>
</div>
        
        <div class="timer-content-wrapper" style="margin-top: 0.5rem;">
            
            <div class="timer" style="font-size: 1.5rem;">NOT OPEN</div>
        
        </div>
    </div>
    
    <!-- BOTTOM ROW: Status badge and delete button -->
    <div class="section-bottom">
        <div class="status-badge-wrapper">
            <div class="status-badge status-not-open" data-flight-id="1771399220056"> 3 HOURS FROM DEPARTURE</div>
        </div>
        <button class="permanent-delete-btn" onclick="deleteFlight(1771399220056)">
             Delete
        </button>
    </div>
</div><div class="flight-card not-open notopen-section-card">
    <!-- TOP ROW: Three bubbles -->
    <div class="section-left">
        <div class="flight-number-glass">
            <span class="editable-flight-num editable">JQ721</span>
        </div>
    </div>
    
    <div class="section-center">
        <div class="destination-glass">
            <span class="dest-display editable">HBA</span>
        </div>
    </div>
    
    <div class="section-right-top">
        <div class="close-time-glass">
            <span class="close-time-label">Closes:</span>
            <span class="close-time-value">11:05</span>
        </div>
    </div>
    
    <!-- MIDDLE ROW: Timer and flight info -->
    <div class="section-timer">
        <div style="font-size: rem; margin-bottom: 1.5rem;"><span class="turnaround-icon" style="font-size: 2.4rem; letter-spacing: 0.5rem;"></span></div>
        <div style="font-size: 1.5rem; color: #6b7280; margin-bottom: 0.5rem; font-weight: bold;">
    Departure: <span class="editable-dep editable" style="font-weight: bold; font-size: 1.3rem; color: #000345;">11:45</span>
</div>
        
        <div class="timer-content-wrapper" style="margin-top: 0.5rem;">
            
            <div class="timer" style="font-size: 1.5rem;">NOT OPEN</div>
        
        </div>
    </div>
    
    <!-- BOTTOM ROW: Status badge and delete button -->
    <div class="section-bottom">
        <div class="status-badge-wrapper">
            <div class="status-badge status-not-open" data-flight-id="1771399214423"> 3 HOURS FROM DEPARTURE</div>
        </div>
        <button class="permanent-delete-btn" onclick="deleteFlight(1771399214423)">
             Delete
        </button>
    </div>
</div><div class="flight-card not-open notopen-section-card">
    <!-- TOP ROW: Three bubbles -->
    <div class="section-left">
        <div class="flight-number-glass">
            <span class="editable-flight-num editable">JQ952</span>
        </div>
    </div>
    
    <div class="section-center">
        <div class="destination-glass">
            <span class="dest-display editable">CNS</span>
        </div>
    </div>
    
    <div class="section-right-top">
        <div class="close-time-glass">
            <span class="close-time-label">Closes:</span>
            <span class="close-time-value">11:05</span>
        </div>
    </div>
    
    <!-- MIDDLE ROW: Timer and flight info -->
    <div class="section-timer">
        <div style="font-size: rem; margin-bottom: 1.5rem;"><span class="turnaround-icon" style="font-size: 2.4rem; letter-spacing: 0.5rem;"></span></div>
        <div style="font-size: 1.5rem; color: #6b7280; margin-bottom: 0.5rem; font-weight: bold;">
    Departure: <span class="editable-dep editable" style="font-weight: bold; font-size: 1.3rem; color: #000345;">11:45</span>
</div>
        
        <div class="timer-content-wrapper" style="margin-top: 0.5rem;">
            
            <div class="timer" style="font-size: 1.5rem;">NOT OPEN</div>
        
        </div>
    </div>
    
    <!-- BOTTOM ROW: Status badge and delete button -->
    <div class="section-bottom">
        <div class="status-badge-wrapper">
            <div class="status-badge status-not-open" data-flight-id="1771399220160"> 3 HOURS FROM DEPARTURE</div>
        </div>
        <button class="permanent-delete-btn" onclick="deleteFlight(1771399220160)">
             Delete
        </button>
    </div>
</div><div class="flight-card not-open notopen-section-card">
    <!-- TOP ROW: Three bubbles -->
    <div class="section-left">
        <div class="flight-number-glass">
            <span class="editable-flight-num editable">JQ898</span>
        </div>
    </div>
    
    <div class="section-center">
        <div class="destination-glass">
            <span class="dest-display editable">BQB</span>
        </div>
    </div>
    
    <div class="section-right-top">
        <div class="close-time-glass">
            <span class="close-time-label">Closes:</span>
            <span class="close-time-value">11:10</span>
        </div>
    </div>
    
    <!-- MIDDLE ROW: Timer and flight info -->
    <div class="section-timer">
        <div style="font-size: rem; margin-bottom: 1.5rem;"><span class="turnaround-icon" style="font-size: 2.4rem; letter-spacing: 0.5rem;"></span></div>
        <div style="font-size: 1.5rem; color: #6b7280; margin-bottom: 0.5rem; font-weight: bold;">
    Departure: <span class="editable-dep editable" style="font-weight: bold; font-size: 1.3rem; color: #000345;">11:50</span>
</div>
        
        <div class="timer-content-wrapper" style="margin-top: 0.5rem;">
            
            <div class="timer" style="font-size: 1.5rem;">NOT OPEN</div>
        
        </div>
    </div>
    
    <!-- BOTTOM ROW: Status badge and delete button -->
    <div class="section-bottom">
        <div class="status-badge-wrapper">
            <div class="status-badge status-not-open" data-flight-id="1771399217051"> 3 HOURS FROM DEPARTURE</div>
        </div>
        <button class="permanent-delete-btn" onclick="deleteFlight(1771399217051)">
             Delete
        </button>
    </div>
</div><div class="flight-card not-open notopen-section-card">
    <!-- TOP ROW: Three bubbles -->
    <div class="section-left">
        <div class="flight-number-glass">
            <span class="editable-flight-num editable">JQ986</span>
        </div>
    </div>
    
    <div class="section-center">
        <div class="destination-glass">
            <span class="dest-display editable">PER</span>
        </div>
    </div>
    
    <div class="section-right-top">
        <div class="close-time-glass">
            <span class="close-time-label">Closes:</span>
            <span class="close-time-value">11:15</span>
        </div>
    </div>
    
    <!-- MIDDLE ROW: Timer and flight info -->
    <div class="section-timer">
        <div style="font-size: rem; margin-bottom: 1.5rem;"><span class="turnaround-icon" style="font-size: 2.4rem; letter-spacing: 0.5rem;"></span></div>
        <div style="font-size: 1.5rem; color: #6b7280; margin-bottom: 0.5rem; font-weight: bold;">
    Departure: <span class="editable-dep editable" style="font-weight: bold; font-size: 1.3rem; color: #000345;">11:55</span>
</div>
        
        <div class="timer-content-wrapper" style="margin-top: 0.5rem;">
            
            <div class="timer" style="font-size: 1.5rem;">NOT OPEN</div>
        
        </div>
    </div>
    
    <!-- BOTTOM ROW: Status badge and delete button -->
    <div class="section-bottom">
        <div class="status-badge-wrapper">
            <div class="status-badge status-not-open" data-flight-id="1771399218245"> 3 HOURS FROM DEPARTURE</div>
        </div>
        <button class="permanent-delete-btn" onclick="deleteFlight(1771399218245)">
             Delete
        </button>
    </div>
</div><div class="flight-card not-open notopen-section-card">
    <!-- TOP ROW: Three bubbles -->
    <div class="section-left">
        <div class="flight-number-glass">
            <span class="editable-flight-num editable">JQ515</span>
        </div>
    </div>
    
    <div class="section-center">
        <div class="destination-glass">
            <span class="dest-display editable">MEL</span>
        </div>
    </div>
    
    <div class="section-right-top">
        <div class="close-time-glass">
            <span class="close-time-label">Closes:</span>
            <span class="close-time-value">11:50</span>
        </div>
    </div>
    
    <!-- MIDDLE ROW: Timer and flight info -->
    <div class="section-timer">
        <div style="font-size: rem; margin-bottom: 1.5rem;"><span class="turnaround-icon" style="font-size: 2.4rem; letter-spacing: 0.5rem;"></span></div>
        <div style="font-size: 1.5rem; color: #6b7280; margin-bottom: 0.5rem; font-weight: bold;">
    Departure: <span class="editable-dep editable" style="font-weight: bold; font-size: 1.3rem; color: #000345;">12:30</span>
</div>
        
        <div class="timer-content-wrapper" style="margin-top: 0.5rem;">
            
            <div class="timer" style="font-size: 1.5rem;">NOT OPEN</div>
        
        </div>
    </div>
    
    <!-- BOTTOM ROW: Status badge and delete button -->
    <div class="section-bottom">
        <div class="status-badge-wrapper">
            <div class="status-badge status-not-open" data-flight-id="1771399217366"> 3 HOURS FROM DEPARTURE</div>
        </div>
        <button class="permanent-delete-btn" onclick="deleteFlight(1771399217366)">
             Delete
        </button>
    </div>
</div><div class="flight-card not-open notopen-section-card">
    <!-- TOP ROW: Three bubbles -->
    <div class="section-left">
        <div class="flight-number-glass">
            <span class="editable-flight-num editable">JQ890</span>
        </div>
    </div>
    
    <div class="section-center">
        <div class="destination-glass">
            <span class="dest-display editable">HVB</span>
        </div>
    </div>
    
    <div class="section-right-top">
        <div class="close-time-glass">
            <span class="close-time-label">Closes:</span>
            <span class="close-time-value">11:55</span>
        </div>
    </div>
    
    <!-- MIDDLE ROW: Timer and flight info -->
    <div class="section-timer">
        <div style="font-size: rem; margin-bottom: 1.5rem;"><span class="turnaround-icon" style="font-size: 2.4rem; letter-spacing: 0.5rem;"></span></div>
        <div style="font-size: 1.5rem; color: #6b7280; margin-bottom: 0.5rem; font-weight: bold;">
    Departure: <span class="editable-dep editable" style="font-weight: bold; font-size: 1.3rem; color: #000345;">12:35</span>
</div>
        
        <div class="timer-content-wrapper" style="margin-top: 0.5rem;">
            
            <div class="timer" style="font-size: 1.5rem;">NOT OPEN</div>
        
        </div>
    </div>
    
    <!-- BOTTOM ROW: Status badge and delete button -->
    <div class="section-bottom">
        <div class="status-badge-wrapper">
            <div class="status-badge status-not-open" data-flight-id="1771399218454"> 3 HOURS FROM DEPARTURE</div>
        </div>
        <button class="permanent-delete-btn" onclick="deleteFlight(1771399218454)">
             Delete
        </button>
    </div>
</div><div class="flight-card not-open notopen-section-card">
    <!-- TOP ROW: Three bubbles -->
    <div class="section-left">
        <div class="flight-number-glass">
            <span class="editable-flight-num editable">JQ609</span>
        </div>
    </div>
    
    <div class="section-center">
        <div class="destination-glass">
            <span class="dest-display editable">AVV</span>
        </div>
    </div>
    
    <div class="section-right-top">
        <div class="close-time-glass">
            <span class="close-time-label">Closes:</span>
            <span class="close-time-value">11:55</span>
        </div>
    </div>
    
    <!-- MIDDLE ROW: Timer and flight info -->
    <div class="section-timer">
        
        <div style="font-size: 1.5rem; color: #6b7280; margin-bottom: 0.5rem; font-weight: bold;">
    Departure: <span class="editable-dep editable" style="font-weight: bold; font-size: 1.3rem; color: #000345;">12:35</span>
</div>
        
        <div class="timer-content-wrapper" style="margin-top: 0.5rem;">
            
            <div class="timer" style="font-size: 1.5rem;">NOT OPEN</div>
        
        </div>
    </div>
    
    <!-- BOTTOM ROW: Status badge and delete button -->
    <div class="section-bottom">
        <div class="status-badge-wrapper">
            <div class="status-badge status-not-open" data-flight-id="1771399215788"> 3 HOURS FROM DEPARTURE</div>
        </div>
        <button class="permanent-delete-btn" onclick="deleteFlight(1771399215788)">
             Delete
        </button>
    </div>
</div><div class="flight-card not-open notopen-section-card">
    <!-- TOP ROW: Three bubbles -->
    <div class="section-left">
        <div class="flight-number-glass">
            <span class="editable-flight-num editable">JQ517</span>
        </div>
    </div>
    
    <div class="section-center">
        <div class="destination-glass">
            <span class="dest-display editable">MEL</span>
        </div>
    </div>
    
    <div class="section-right-top">
        <div class="close-time-glass">
            <span class="close-time-label">Closes:</span>
            <span class="close-time-value">12:35</span>
        </div>
    </div>
    
    <!-- MIDDLE ROW: Timer and flight info -->
    <div class="section-timer">
        <div style="font-size: rem; margin-bottom: 1.5rem;"><span class="turnaround-icon" style="font-size: 2.4rem; letter-spacing: 0.5rem;"></span></div>
        <div style="font-size: 1.5rem; color: #6b7280; margin-bottom: 0.5rem; font-weight: bold;">
    Departure: <span class="editable-dep editable" style="font-weight: bold; font-size: 1.3rem; color: #000345;">13:15</span>
</div>
        
        <div class="timer-content-wrapper" style="margin-top: 0.5rem;">
            
            <div class="timer" style="font-size: 1.5rem;">NOT OPEN</div>
        
        </div>
    </div>
    
    <!-- BOTTOM ROW: Status badge and delete button -->
    <div class="section-bottom">
        <div class="status-badge-wrapper">
            <div class="status-badge status-not-open" data-flight-id="1771399218793"> 3 HOURS FROM DEPARTURE</div>
        </div>
        <button class="permanent-delete-btn" onclick="deleteFlight(1771399218793)">
             Delete
        </button>
    </div>
</div><div class="flight-card not-open notopen-section-card">
    <!-- TOP ROW: Three bubbles -->
    <div class="section-left">
        <div class="flight-number-glass">
            <span class="editable-flight-num editable">JQ788</span>
        </div>
    </div>
    
    <div class="section-center">
        <div class="destination-glass">
            <span class="dest-display editable">MCY</span>
        </div>
    </div>
    
    <div class="section-right-top">
        <div class="close-time-glass">
            <span class="close-time-label">Closes:</span>
            <span class="close-time-value">12:40</span>
        </div>
    </div>
    
    <!-- MIDDLE ROW: Timer and flight info -->
    <div class="section-timer">
        <div style="font-size: rem; margin-bottom: 1.5rem;"><span class="turnaround-icon" style="font-size: 2.4rem; letter-spacing: 0.5rem;"></span></div>
        <div style="font-size: 1.5rem; color: #6b7280; margin-bottom: 0.5rem; font-weight: bold;">
    Departure: <span class="editable-dep editable" style="font-weight: bold; font-size: 1.3rem; color: #000345;">13:20</span>
</div>
        
        <div class="timer-content-wrapper" style="margin-top: 0.5rem;">
            
            <div class="timer" style="font-size: 1.5rem;">NOT OPEN</div>
        
        </div>
    </div>
    
    <!-- BOTTOM ROW: Status badge and delete button -->
    <div class="section-bottom">
        <div class="status-badge-wrapper">
            <div class="status-badge status-not-open" data-flight-id="1771399216534"> 3 HOURS FROM DEPARTURE</div>
        </div>
        <button class="permanent-delete-btn" onclick="deleteFlight(1771399216534)">
             Delete
        </button>
    </div>
</div><div class="flight-card not-open notopen-section-card">
    <!-- TOP ROW: Three bubbles -->
    <div class="section-left">
        <div class="flight-number-glass">
            <span class="editable-flight-num editable">JQ816</span>
        </div>
    </div>
    
    <div class="section-center">
        <div class="destination-glass">
            <span class="dest-display editable">BNE</span>
        </div>
    </div>
    
    <div class="section-right-top">
        <div class="close-time-glass">
            <span class="close-time-label">Closes:</span>
            <span class="close-time-value">13:10</span>
        </div>
    </div>
    
    <!-- MIDDLE ROW: Timer and flight info -->
    <div class="section-timer">
        <div style="font-size: rem; margin-bottom: 1.5rem;"><span class="turnaround-icon" style="font-size: 2.4rem; letter-spacing: 0.5rem;"></span></div>
        <div style="font-size: 1.5rem; color: #6b7280; margin-bottom: 0.5rem; font-weight: bold;">
    Departure: <span class="editable-dep editable" style="font-weight: bold; font-size: 1.3rem; color: #000345;">13:50</span>
</div>
        
        <div class="timer-content-wrapper" style="margin-top: 0.5rem;">
            
            <div class="timer" style="font-size: 1.5rem;">NOT OPEN</div>
        
        </div>
    </div>
    
    <!-- BOTTOM ROW: Status badge and delete button -->
    <div class="section-bottom">
        <div class="status-badge-wrapper">
            <div class="status-badge status-not-open" data-flight-id="1771399220609"> 3 HOURS FROM DEPARTURE</div>
        </div>
        <button class="permanent-delete-btn" onclick="deleteFlight(1771399220609)">
             Delete
        </button>
    </div>
</div><div class="flight-card not-open notopen-section-card">
    <!-- TOP ROW: Three bubbles -->
    <div class="section-left">
        <div class="flight-number-glass">
            <span class="editable-flight-num editable">JQ460</span>
        </div>
    </div>
    
    <div class="section-center">
        <div class="destination-glass">
            <span class="dest-display editable">BNK</span>
        </div>
    </div>
    
    <div class="section-right-top">
        <div class="close-time-glass">
            <span class="close-time-label">Closes:</span>
            <span class="close-time-value">14:00</span>
        </div>
    </div>
    
    <!-- MIDDLE ROW: Timer and flight info -->
    <div class="section-timer">
        <div style="font-size: rem; margin-bottom: 1.5rem;"><span class="turnaround-icon" style="font-size: 2.4rem; letter-spacing: 0.5rem;"></span></div>
        <div style="font-size: 1.5rem; color: #6b7280; margin-bottom: 0.5rem; font-weight: bold;">
    Departure: <span class="editable-dep editable" style="font-weight: bold; font-size: 1.3rem; color: #000345;">14:40</span>
</div>
        
        <div class="timer-content-wrapper" style="margin-top: 0.5rem;">
            
            <div class="timer" style="font-size: 1.5rem;">NOT OPEN</div>
        
        </div>
    </div>
    
    <!-- BOTTOM ROW: Status badge and delete button -->
    <div class="section-bottom">
        <div class="status-badge-wrapper">
            <div class="status-badge status-not-open" data-flight-id="1771399213366"> 3 HOURS FROM DEPARTURE</div>
        </div>
        <button class="permanent-delete-btn" onclick="deleteFlight(1771399213366)">
             Delete
        </button>
    </div>
</div><div class="flight-card not-open notopen-section-card">
    <!-- TOP ROW: Three bubbles -->
    <div class="section-left">
        <div class="flight-number-glass">
            <span class="editable-flight-num editable">JQ412</span>
        </div>
    </div>
    
    <div class="section-center">
        <div class="destination-glass">
            <span class="dest-display editable">OOL</span>
        </div>
    </div>
    
    <div class="section-right-top">
        <div class="close-time-glass">
            <span class="close-time-label">Closes:</span>
            <span class="close-time-value">14:10</span>
        </div>
    </div>
    
    <!-- MIDDLE ROW: Timer and flight info -->
    <div class="section-timer">
        <div style="font-size: rem; margin-bottom: 1.5rem;"><span class="turnaround-icon" style="font-size: 2.4rem; letter-spacing: 0.5rem;"></span></div>
        <div style="font-size: 1.5rem; color: #6b7280; margin-bottom: 0.5rem; font-weight: bold;">
    Departure: <span class="editable-dep editable" style="font-weight: bold; font-size: 1.3rem; color: #000345;">14:50</span>
</div>
        
        <div class="timer-content-wrapper" style="margin-top: 0.5rem;">
            
            <div class="timer" style="font-size: 1.5rem;">NOT OPEN</div>
        
        </div>
    </div>
    
    <!-- BOTTOM ROW: Status badge and delete button -->
    <div class="section-bottom">
        <div class="status-badge-wrapper">
            <div class="status-badge status-not-open" data-flight-id="1771399215146"> 3 HOURS FROM DEPARTURE</div>
        </div>
        <button class="permanent-delete-btn" onclick="deleteFlight(1771399215146)">
             Delete
        </button>
    </div>
</div><div class="flight-card not-open notopen-section-card">
    <!-- TOP ROW: Three bubbles -->
    <div class="section-left">
        <div class="flight-number-glass">
            <span class="editable-flight-num editable">JQ521</span>
        </div>
    </div>
    
    <div class="section-center">
        <div class="destination-glass">
            <span class="dest-display editable">MEL</span>
        </div>
    </div>
    
    <div class="section-right-top">
        <div class="close-time-glass">
            <span class="close-time-label">Closes:</span>
            <span class="close-time-value">14:30</span>
        </div>
    </div>
    
    <!-- MIDDLE ROW: Timer and flight info -->
    <div class="section-timer">
        
        <div style="font-size: 1.5rem; color: #6b7280; margin-bottom: 0.5rem; font-weight: bold;">
    Departure: <span class="editable-dep editable" style="font-weight: bold; font-size: 1.3rem; color: #000345;">15:10</span>
</div>
        
        <div class="timer-content-wrapper" style="margin-top: 0.5rem;">
            
            <div class="timer" style="font-size: 1.5rem;">NOT OPEN</div>
        
        </div>
    </div>
    
    <!-- BOTTOM ROW: Status badge and delete button -->
    <div class="section-bottom">
        <div class="status-badge-wrapper">
            <div class="status-badge status-not-open" data-flight-id="1771399213079"> 3 HOURS FROM DEPARTURE</div>
        </div>
        <button class="permanent-delete-btn" onclick="deleteFlight(1771399213079)">
             Delete
        </button>
    </div>
</div><div class="flight-card not-open notopen-section-card">
    <!-- TOP ROW: Three bubbles -->
    <div class="section-left">
        <div class="flight-number-glass">
            <span class="editable-flight-num editable">JQ954</span>
        </div>
    </div>
    
    <div class="section-center">
        <div class="destination-glass">
            <span class="dest-display editable">CNS</span>
        </div>
    </div>
    
    <div class="section-right-top">
        <div class="close-time-glass">
            <span class="close-time-label">Closes:</span>
            <span class="close-time-value">14:45</span>
        </div>
    </div>
    
    <!-- MIDDLE ROW: Timer and flight info -->
    <div class="section-timer">
        <div style="font-size: rem; margin-bottom: 1.5rem;"><span class="turnaround-icon" style="font-size: 2.4rem; letter-spacing: 0.5rem;"></span></div>
        <div style="font-size: 1.5rem; color: #6b7280; margin-bottom: 0.5rem; font-weight: bold;">
    Departure: <span class="editable-dep editable" style="font-weight: bold; font-size: 1.3rem; color: #000345;">15:25</span>
</div>
        
        <div class="timer-content-wrapper" style="margin-top: 0.5rem;">
            
            <div class="timer" style="font-size: 1.5rem;">NOT OPEN</div>
        
        </div>
    </div>
    
    <!-- BOTTOM ROW: Status badge and delete button -->
    <div class="section-bottom">
        <div class="status-badge-wrapper">
            <div class="status-badge status-not-open" data-flight-id="1771399213790"> 3 HOURS FROM DEPARTURE</div>
        </div>
        <button class="permanent-delete-btn" onclick="deleteFlight(1771399213790)">
             Delete
        </button>
    </div>
</div><div class="flight-card not-open notopen-section-card">
    <!-- TOP ROW: Three bubbles -->
    <div class="section-left">
        <div class="flight-number-glass">
            <span class="editable-flight-num editable">JQ525</span>
        </div>
    </div>
    
    <div class="section-center">
        <div class="destination-glass">
            <span class="dest-display editable">MEL</span>
        </div>
    </div>
    
    <div class="section-right-top">
        <div class="close-time-glass">
            <span class="close-time-label">Closes:</span>
            <span class="close-time-value">15:45</span>
        </div>
    </div>
    
    <!-- MIDDLE ROW: Timer and flight info -->
    <div class="section-timer">
        <div style="font-size: rem; margin-bottom: 1.5rem;"><span class="turnaround-icon" style="font-size: 2.4rem; letter-spacing: 0.5rem;"></span></div>
        <div style="font-size: 1.5rem; color: #6b7280; margin-bottom: 0.5rem; font-weight: bold;">
    Departure: <span class="editable-dep editable" style="font-weight: bold; font-size: 1.3rem; color: #000345;">16:25</span>
</div>
        
        <div class="timer-content-wrapper" style="margin-top: 0.5rem;">
            
            <div class="timer" style="font-size: 1.5rem;">NOT OPEN</div>
        
        </div>
    </div>
    
    <!-- BOTTOM ROW: Status badge and delete button -->
    <div class="section-bottom">
        <div class="status-badge-wrapper">
            <div class="status-badge status-not-open" data-flight-id="1771399219331"> 3 HOURS FROM DEPARTURE</div>
        </div>
        <button class="permanent-delete-btn" onclick="deleteFlight(1771399219331)">
             Delete
        </button>
    </div>
</div><div class="flight-card not-open notopen-section-card">
    <!-- TOP ROW: Three bubbles -->
    <div class="section-left">
        <div class="flight-number-glass">
            <span class="editable-flight-num editable">JQ820</span>
        </div>
    </div>
    
    <div class="section-center">
        <div class="destination-glass">
            <span class="dest-display editable">BNE</span>
        </div>
    </div>
    
    <div class="section-right-top">
        <div class="close-time-glass">
            <span class="close-time-label">Closes:</span>
            <span class="close-time-value">16:20</span>
        </div>
    </div>
    
    <!-- MIDDLE ROW: Timer and flight info -->
    <div class="section-timer">
        <div style="font-size: rem; margin-bottom: 1.5rem;"><span class="turnaround-icon" style="font-size: 2.4rem; letter-spacing: 0.5rem;"></span></div>
        <div style="font-size: 1.5rem; color: #6b7280; margin-bottom: 0.5rem; font-weight: bold;">
    Departure: <span class="editable-dep editable" style="font-weight: bold; font-size: 1.3rem; color: #000345;">17:00</span>
</div>
        
        <div class="timer-content-wrapper" style="margin-top: 0.5rem;">
            
            <div class="timer" style="font-size: 1.5rem;">NOT OPEN</div>
        
        </div>
    </div>
    
    <!-- BOTTOM ROW: Status badge and delete button -->
    <div class="section-bottom">
        <div class="status-badge-wrapper">
            <div class="status-badge status-not-open" data-flight-id="1771399215718"> 3 HOURS FROM DEPARTURE</div>
        </div>
        <button class="permanent-delete-btn" onclick="deleteFlight(1771399215718)">
             Delete
        </button>
    </div>
</div><div class="flight-card not-open notopen-section-card">
    <!-- TOP ROW: Three bubbles -->
    <div class="section-left">
        <div class="flight-number-glass">
            <span class="editable-flight-num editable">JQ527</span>
        </div>
    </div>
    
    <div class="section-center">
        <div class="destination-glass">
            <span class="dest-display editable">MEL</span>
        </div>
    </div>
    
    <div class="section-right-top">
        <div class="close-time-glass">
            <span class="close-time-label">Closes:</span>
            <span class="close-time-value">16:20</span>
        </div>
    </div>
    
    <!-- MIDDLE ROW: Timer and flight info -->
    <div class="section-timer">
        <div style="font-size: rem; margin-bottom: 1.5rem;"><span class="turnaround-icon" style="font-size: 2.4rem; letter-spacing: 0.5rem;"></span></div>
        <div style="font-size: 1.5rem; color: #6b7280; margin-bottom: 0.5rem; font-weight: bold;">
    Departure: <span class="editable-dep editable" style="font-weight: bold; font-size: 1.3rem; color: #000345;">17:00</span>
</div>
        
        <div class="timer-content-wrapper" style="margin-top: 0.5rem;">
            
            <div class="timer" style="font-size: 1.5rem;">NOT OPEN</div>
        
        </div>
    </div>
    
    <!-- BOTTOM ROW: Status badge and delete button -->
    <div class="section-bottom">
        <div class="status-badge-wrapper">
            <div class="status-badge status-not-open" data-flight-id="1771399217865"> 3 HOURS FROM DEPARTURE</div>
        </div>
        <button class="permanent-delete-btn" onclick="deleteFlight(1771399217865)">
             Delete
        </button>
    </div>
</div><div class="flight-card not-open notopen-section-card">
    <!-- TOP ROW: Three bubbles -->
    <div class="section-left">
        <div class="flight-number-glass">
            <span class="editable-flight-num editable">JQ766</span>
        </div>
    </div>
    
    <div class="section-center">
        <div class="destination-glass">
            <span class="dest-display editable">ADL</span>
        </div>
    </div>
    
    <div class="section-right-top">
        <div class="close-time-glass">
            <span class="close-time-label">Closes:</span>
            <span class="close-time-value">16:45</span>
        </div>
    </div>
    
    <!-- MIDDLE ROW: Timer and flight info -->
    <div class="section-timer">
        <div style="font-size: rem; margin-bottom: 1.5rem;"><span class="turnaround-icon" style="font-size: 2.4rem; letter-spacing: 0.5rem;"></span></div>
        <div style="font-size: 1.5rem; color: #6b7280; margin-bottom: 0.5rem; font-weight: bold;">
    Departure: <span class="editable-dep editable" style="font-weight: bold; font-size: 1.3rem; color: #000345;">17:25</span>
</div>
        
        <div class="timer-content-wrapper" style="margin-top: 0.5rem;">
            
            <div class="timer" style="font-size: 1.5rem;">NOT OPEN</div>
        
        </div>
    </div>
    
    <!-- BOTTOM ROW: Status badge and delete button -->
    <div class="section-bottom">
        <div class="status-badge-wrapper">
            <div class="status-badge status-not-open" data-flight-id="1771399217154"> 3 HOURS FROM DEPARTURE</div>
        </div>
        <button class="permanent-delete-btn" onclick="deleteFlight(1771399217154)">
             Delete
        </button>
    </div>
</div><div class="flight-card not-open notopen-section-card">
    <!-- TOP ROW: Three bubbles -->
    <div class="section-left">
        <div class="flight-number-glass">
            <span class="editable-flight-num editable">JQ529</span>
        </div>
    </div>
    
    <div class="section-center">
        <div class="destination-glass">
            <span class="dest-display editable">MEL</span>
        </div>
    </div>
    
    <div class="section-right-top">
        <div class="close-time-glass">
            <span class="close-time-label">Closes:</span>
            <span class="close-time-value">16:50</span>
        </div>
    </div>
    
    <!-- MIDDLE ROW: Timer and flight info -->
    <div class="section-timer">
        <div style="font-size: rem; margin-bottom: 1.5rem;"><span class="turnaround-icon" style="font-size: 2.4rem; letter-spacing: 0.5rem;"></span></div>
        <div style="font-size: 1.5rem; color: #6b7280; margin-bottom: 0.5rem; font-weight: bold;">
    Departure: <span class="editable-dep editable" style="font-weight: bold; font-size: 1.3rem; color: #000345;">17:30</span>
</div>
        
        <div class="timer-content-wrapper" style="margin-top: 0.5rem;">
            
            <div class="timer" style="font-size: 1.5rem;">NOT OPEN</div>
        
        </div>
    </div>
    
    <!-- BOTTOM ROW: Status badge and delete button -->
    <div class="section-bottom">
        <div class="status-badge-wrapper">
            <div class="status-badge status-not-open" data-flight-id="1771399217792"> 3 HOURS FROM DEPARTURE</div>
        </div>
        <button class="permanent-delete-btn" onclick="deleteFlight(1771399217792)">
             Delete
        </button>
    </div>
</div><div class="flight-card not-open notopen-section-card">
    <!-- TOP ROW: Three bubbles -->
    <div class="section-left">
        <div class="flight-number-glass">
            <span class="editable-flight-num editable">JQ531</span>
        </div>
    </div>
    
    <div class="section-center">
        <div class="destination-glass">
            <span class="dest-display editable">MEL</span>
        </div>
    </div>
    
    <div class="section-right-top">
        <div class="close-time-glass">
            <span class="close-time-label">Closes:</span>
            <span class="close-time-value">17:20</span>
        </div>
    </div>
    
    <!-- MIDDLE ROW: Timer and flight info -->
    <div class="section-timer">
        <div style="font-size: rem; margin-bottom: 1.5rem;"><span class="turnaround-icon" style="font-size: 2.4rem; letter-spacing: 0.5rem;"></span></div>
        <div style="font-size: 1.5rem; color: #6b7280; margin-bottom: 0.5rem; font-weight: bold;">
    Departure: <span class="editable-dep editable" style="font-weight: bold; font-size: 1.3rem; color: #000345;">18:00</span>
</div>
        
        <div class="timer-content-wrapper" style="margin-top: 0.5rem;">
            
            <div class="timer" style="font-size: 1.5rem;">NOT OPEN</div>
        
        </div>
    </div>
    
    <!-- BOTTOM ROW: Status badge and delete button -->
    <div class="section-bottom">
        <div class="status-badge-wrapper">
            <div class="status-badge status-not-open" data-flight-id="1771399218986"> 3 HOURS FROM DEPARTURE</div>
        </div>
        <button class="permanent-delete-btn" onclick="deleteFlight(1771399218986)">
             Delete
        </button>
    </div>
</div><div class="flight-card not-open notopen-section-card">
    <!-- TOP ROW: Three bubbles -->
    <div class="section-left">
        <div class="flight-number-glass">
            <span class="editable-flight-num editable">JQ749</span>
        </div>
    </div>
    
    <div class="section-center">
        <div class="destination-glass">
            <span class="dest-display editable">LST</span>
        </div>
    </div>
    
    <div class="section-right-top">
        <div class="close-time-glass">
            <span class="close-time-label">Closes:</span>
            <span class="close-time-value">17:25</span>
        </div>
    </div>
    
    <!-- MIDDLE ROW: Timer and flight info -->
    <div class="section-timer">
        <div style="font-size: rem; margin-bottom: 1.5rem;"><span class="turnaround-icon" style="font-size: 2.4rem; letter-spacing: 0.5rem;"></span></div>
        <div style="font-size: 1.5rem; color: #6b7280; margin-bottom: 0.5rem; font-weight: bold;">
    Departure: <span class="editable-dep editable" style="font-weight: bold; font-size: 1.3rem; color: #000345;">18:05</span>
</div>
        
        <div class="timer-content-wrapper" style="margin-top: 0.5rem;">
            
            <div class="timer" style="font-size: 1.5rem;">NOT OPEN</div>
        
        </div>
    </div>
    
    <!-- BOTTOM ROW: Status badge and delete button -->
    <div class="section-bottom">
        <div class="status-badge-wrapper">
            <div class="status-badge status-not-open" data-flight-id="1771399215266"> 3 HOURS FROM DEPARTURE</div>
        </div>
        <button class="permanent-delete-btn" onclick="deleteFlight(1771399215266)">
             Delete
        </button>
    </div>
</div><div class="flight-card not-open notopen-section-card">
    <!-- TOP ROW: Three bubbles -->
    <div class="section-left">
        <div class="flight-number-glass">
            <span class="editable-flight-num editable">JQ822</span>
        </div>
    </div>
    
    <div class="section-center">
        <div class="destination-glass">
            <span class="dest-display editable">BNE</span>
        </div>
    </div>
    
    <div class="section-right-top">
        <div class="close-time-glass">
            <span class="close-time-label">Closes:</span>
            <span class="close-time-value">17:45</span>
        </div>
    </div>
    
    <!-- MIDDLE ROW: Timer and flight info -->
    <div class="section-timer">
        <div style="font-size: rem; margin-bottom: 1.5rem;"><span class="turnaround-icon" style="font-size: 2.4rem; letter-spacing: 0.5rem;"></span></div>
        <div style="font-size: 1.5rem; color: #6b7280; margin-bottom: 0.5rem; font-weight: bold;">
    Departure: <span class="editable-dep editable" style="font-weight: bold; font-size: 1.3rem; color: #000345;">18:25</span>
</div>
        
        <div class="timer-content-wrapper" style="margin-top: 0.5rem;">
            
            <div class="timer" style="font-size: 1.5rem;">NOT OPEN</div>
        
        </div>
    </div>
    
    <!-- BOTTOM ROW: Status badge and delete button -->
    <div class="section-bottom">
        <div class="status-badge-wrapper">
            <div class="status-badge status-not-open" data-flight-id="1771399221976"> 3 HOURS FROM DEPARTURE</div>
        </div>
        <button class="permanent-delete-btn" onclick="deleteFlight(1771399221976)">
             Delete
        </button>
    </div>
</div><div class="flight-card not-open notopen-section-card">
    <!-- TOP ROW: Three bubbles -->
    <div class="section-left">
        <div class="flight-number-glass">
            <span class="editable-flight-num editable">JQ533</span>
        </div>
    </div>
    
    <div class="section-center">
        <div class="destination-glass">
            <span class="dest-display editable">MEL</span>
        </div>
    </div>
    
    <div class="section-right-top">
        <div class="close-time-glass">
            <span class="close-time-label">Closes:</span>
            <span class="close-time-value">17:50</span>
        </div>
    </div>
    
    <!-- MIDDLE ROW: Timer and flight info -->
    <div class="section-timer">
        
        <div style="font-size: 1.5rem; color: #6b7280; margin-bottom: 0.5rem; font-weight: bold;">
    Departure: <span class="editable-dep editable" style="font-weight: bold; font-size: 1.3rem; color: #000345;">18:30</span>
</div>
        
        <div class="timer-content-wrapper" style="margin-top: 0.5rem;">
            
            <div class="timer" style="font-size: 1.5rem;">NOT OPEN</div>
        
        </div>
    </div>
    
    <!-- BOTTOM ROW: Status badge and delete button -->
    <div class="section-bottom">
        <div class="status-badge-wrapper">
            <div class="status-badge status-not-open" data-flight-id="1771399218372"> 3 HOURS FROM DEPARTURE</div>
        </div>
        <button class="permanent-delete-btn" onclick="deleteFlight(1771399218372)">
             Delete
        </button>
    </div>
</div><div class="flight-card not-open notopen-section-card">
    <!-- TOP ROW: Three bubbles -->
    <div class="section-left">
        <div class="flight-number-glass">
            <span class="editable-flight-num editable">JQ611</span>
        </div>
    </div>
    
    <div class="section-center">
        <div class="destination-glass">
            <span class="dest-display editable">AVV</span>
        </div>
    </div>
    
    <div class="section-right-top">
        <div class="close-time-glass">
            <span class="close-time-label">Closes:</span>
            <span class="close-time-value">18:05</span>
        </div>
    </div>
    
    <!-- MIDDLE ROW: Timer and flight info -->
    <div class="section-timer">
        <div style="font-size: rem; margin-bottom: 1.5rem;"><span class="turnaround-icon" style="font-size: 2.4rem; letter-spacing: 0.5rem;"></span></div>
        <div style="font-size: 1.5rem; color: #6b7280; margin-bottom: 0.5rem; font-weight: bold;">
    Departure: <span class="editable-dep editable" style="font-weight: bold; font-size: 1.3rem; color: #000345;">18:45</span>
</div>
        
        <div class="timer-content-wrapper" style="margin-top: 0.5rem;">
            
            <div class="timer" style="font-size: 1.5rem;">NOT OPEN</div>
        
        </div>
    </div>
    
    <!-- BOTTOM ROW: Status badge and delete button -->
    <div class="section-bottom">
        <div class="status-badge-wrapper">
            <div class="status-badge status-not-open" data-flight-id="1771399215873"> 3 HOURS FROM DEPARTURE</div>
        </div>
        <button class="permanent-delete-btn" onclick="deleteFlight(1771399215873)">
             Delete
        </button>
    </div>
</div><div class="flight-card not-open notopen-section-card">
    <!-- TOP ROW: Three bubbles -->
    <div class="section-left">
        <div class="flight-number-glass">
            <span class="editable-flight-num editable">JQ416</span>
        </div>
    </div>
    
    <div class="section-center">
        <div class="destination-glass">
            <span class="dest-display editable">OOL</span>
        </div>
    </div>
    
    <div class="section-right-top">
        <div class="close-time-glass">
            <span class="close-time-label">Closes:</span>
            <span class="close-time-value">18:20</span>
        </div>
    </div>
    
    <!-- MIDDLE ROW: Timer and flight info -->
    <div class="section-timer">
        <div style="font-size: rem; margin-bottom: 1.5rem;"><span class="turnaround-icon" style="font-size: 2.4rem; letter-spacing: 0.5rem;"></span></div>
        <div style="font-size: 1.5rem; color: #6b7280; margin-bottom: 0.5rem; font-weight: bold;">
    Departure: <span class="editable-dep editable" style="font-weight: bold; font-size: 1.3rem; color: #000345;">19:00</span>
</div>
        
        <div class="timer-content-wrapper" style="margin-top: 0.5rem;">
            
            <div class="timer" style="font-size: 1.5rem;">NOT OPEN</div>
        
        </div>
    </div>
    
    <!-- BOTTOM ROW: Status badge and delete button -->
    <div class="section-bottom">
        <div class="status-badge-wrapper">
            <div class="status-badge status-not-open" data-flight-id="1771399220789"> 3 HOURS FROM DEPARTURE</div>
        </div>
        <button class="permanent-delete-btn" onclick="deleteFlight(1771399220789)">
             Delete
        </button>
    </div>
</div><div class="flight-card not-open notopen-section-card">
    <!-- TOP ROW: Three bubbles -->
    <div class="section-left">
        <div class="flight-number-glass">
            <span class="editable-flight-num editable">JQ824</span>
        </div>
    </div>
    
    <div class="section-center">
        <div class="destination-glass">
            <span class="dest-display editable">BNE</span>
        </div>
    </div>
    
    <div class="section-right-top">
        <div class="close-time-glass">
            <span class="close-time-label">Closes:</span>
            <span class="close-time-value">18:45</span>
        </div>
    </div>
    
    <!-- MIDDLE ROW: Timer and flight info -->
    <div class="section-timer">
        <div style="font-size: rem; margin-bottom: 1.5rem;"><span class="turnaround-icon" style="font-size: 2.4rem; letter-spacing: 0.5rem;"></span></div>
        <div style="font-size: 1.5rem; color: #6b7280; margin-bottom: 0.5rem; font-weight: bold;">
    Departure: <span class="editable-dep editable" style="font-weight: bold; font-size: 1.3rem; color: #000345;">19:25</span>
</div>
        
        <div class="timer-content-wrapper" style="margin-top: 0.5rem;">
            
            <div class="timer" style="font-size: 1.5rem;">NOT OPEN</div>
        
        </div>
    </div>
    
    <!-- BOTTOM ROW: Status badge and delete button -->
    <div class="section-bottom">
        <div class="status-badge-wrapper">
            <div class="status-badge status-not-open" data-flight-id="1771399214649"> 3 HOURS FROM DEPARTURE</div>
        </div>
        <button class="permanent-delete-btn" onclick="deleteFlight(1771399214649)">
             Delete
        </button>
    </div>
</div><div class="flight-card not-open notopen-section-card">
    <!-- TOP ROW: Three bubbles -->
    <div class="section-left">
        <div class="flight-number-glass">
            <span class="editable-flight-num editable">JQ988</span>
        </div>
    </div>
    
    <div class="section-center">
        <div class="destination-glass">
            <span class="dest-display editable">PER</span>
        </div>
    </div>
    
    <div class="section-right-top">
        <div class="close-time-glass">
            <span class="close-time-label">Closes:</span>
            <span class="close-time-value">19:10</span>
        </div>
    </div>
    
    <!-- MIDDLE ROW: Timer and flight info -->
    <div class="section-timer">
        
        <div style="font-size: 1.5rem; color: #6b7280; margin-bottom: 0.5rem; font-weight: bold;">
    Departure: <span class="editable-dep editable" style="font-weight: bold; font-size: 1.3rem; color: #000345;">19:50</span>
</div>
        
        <div class="timer-content-wrapper" style="margin-top: 0.5rem;">
            
            <div class="timer" style="font-size: 1.5rem;">NOT OPEN</div>
        
        </div>
    </div>
    
    <!-- BOTTOM ROW: Status badge and delete button -->
    <div class="section-bottom">
        <div class="status-badge-wrapper">
            <div class="status-badge status-not-open" data-flight-id="1771399214283"> 3 HOURS FROM DEPARTURE</div>
        </div>
        <button class="permanent-delete-btn" onclick="deleteFlight(1771399214283)">
             Delete
        </button>
    </div>
</div><div class="flight-card not-open notopen-section-card">
    <!-- TOP ROW: Three bubbles -->
    <div class="section-left">
        <div class="flight-number-glass">
            <span class="editable-flight-num editable">JQ768</span>
        </div>
    </div>
    
    <div class="section-center">
        <div class="destination-glass">
            <span class="dest-display editable">ADL</span>
        </div>
    </div>
    
    <div class="section-right-top">
        <div class="close-time-glass">
            <span class="close-time-label">Closes:</span>
            <span class="close-time-value">19:40</span>
        </div>
    </div>
    
    <!-- MIDDLE ROW: Timer and flight info -->
    <div class="section-timer">
        <div style="font-size: rem; margin-bottom: 1.5rem;"><span class="turnaround-icon" style="font-size: 2.4rem; letter-spacing: 0.5rem;"></span></div>
        <div style="font-size: 1.5rem; color: #6b7280; margin-bottom: 0.5rem; font-weight: bold;">
    Departure: <span class="editable-dep editable" style="font-weight: bold; font-size: 1.3rem; color: #000345;">20:20</span>
</div>
        
        <div class="timer-content-wrapper" style="margin-top: 0.5rem;">
            
            <div class="timer" style="font-size: 1.5rem;">NOT OPEN</div>
        
        </div>
    </div>
    
    <!-- BOTTOM ROW: Status badge and delete button -->
    <div class="section-bottom">
        <div class="status-badge-wrapper">
            <div class="status-badge status-not-open" data-flight-id="1771399218716"> 3 HOURS FROM DEPARTURE</div>
        </div>
        <button class="permanent-delete-btn" onclick="deleteFlight(1771399218716)">
             Delete
        </button>
    </div>
</div><div class="flight-card not-open notopen-section-card">
    <!-- TOP ROW: Three bubbles -->
    <div class="section-left">
        <div class="flight-number-glass">
            <span class="editable-flight-num editable">JQ535</span>
        </div>
    </div>
    
    <div class="section-center">
        <div class="destination-glass">
            <span class="dest-display editable">MEL</span>
        </div>
    </div>
    
    <div class="section-right-top">
        <div class="close-time-glass">
            <span class="close-time-label">Closes:</span>
            <span class="close-time-value">19:45</span>
        </div>
    </div>
    
    <!-- MIDDLE ROW: Timer and flight info -->
    <div class="section-timer">
        <div style="font-size: rem; margin-bottom: 1.5rem;"><span class="turnaround-icon" style="font-size: 2.4rem; letter-spacing: 0.5rem;"></span></div>
        <div style="font-size: 1.5rem; color: #6b7280; margin-bottom: 0.5rem; font-weight: bold;">
    Departure: <span class="editable-dep editable" style="font-weight: bold; font-size: 1.3rem; color: #000345;">20:25</span>
</div>
        
        <div class="timer-content-wrapper" style="margin-top: 0.5rem;">
            
            <div class="timer" style="font-size: 1.5rem;">NOT OPEN</div>
        
        </div>
    </div>
    
    <!-- BOTTOM ROW: Status badge and delete button -->
    <div class="section-bottom">
        <div class="status-badge-wrapper">
            <div class="status-badge status-not-open" data-flight-id="1771399217115"> 3 HOURS FROM DEPARTURE</div>
        </div>
        <button class="permanent-delete-btn" onclick="deleteFlight(1771399217115)">
             Delete
        </button>
    </div>
</div><div class="flight-card not-open notopen-section-card">
    <!-- TOP ROW: Three bubbles -->
    <div class="section-left">
        <div class="flight-number-glass">
            <span class="editable-flight-num editable">JQ537</span>
        </div>
    </div>
    
    <div class="section-center">
        <div class="destination-glass">
            <span class="dest-display editable">MEL</span>
        </div>
    </div>
    
    <div class="section-right-top">
        <div class="close-time-glass">
            <span class="close-time-label">Closes:</span>
            <span class="close-time-value">20:40</span>
        </div>
    </div>
    
    <!-- MIDDLE ROW: Timer and flight info -->
    <div class="section-timer">
        <div style="font-size: rem; margin-bottom: 1.5rem;"><span class="turnaround-icon" style="font-size: 2.4rem; letter-spacing: 0.5rem;"></span></div>
        <div style="font-size: 1.5rem; color: #6b7280; margin-bottom: 0.5rem; font-weight: bold;">
    Departure: <span class="editable-dep editable" style="font-weight: bold; font-size: 1.3rem; color: #000345;">21:20</span>
</div>
        
        <div class="timer-content-wrapper" style="margin-top: 0.5rem;">
            
            <div class="timer" style="font-size: 1.5rem;">NOT OPEN</div>
        
        </div>
    </div>
    
    <!-- BOTTOM ROW: Status badge and delete button -->
    <div class="section-bottom">
        <div class="status-badge-wrapper">
            <div class="status-badge status-not-open" data-flight-id="1771399217921"> 3 HOURS FROM DEPARTURE</div>
        </div>
        <button class="permanent-delete-btn" onclick="deleteFlight(1771399217921)">
             Delete
        </button>
    </div>
</div><div class="flight-card not-open notopen-section-card">
    <!-- TOP ROW: Three bubbles -->
    <div class="section-left">
        <div class="flight-number-glass">
            <span class="editable-flight-num editable">JQ826</span>
        </div>
    </div>
    
    <div class="section-center">
        <div class="destination-glass">
            <span class="dest-display editable">BNE</span>
        </div>
    </div>
    
    <div class="section-right-top">
        <div class="close-time-glass">
            <span class="close-time-label">Closes:</span>
            <span class="close-time-value">20:50</span>
        </div>
    </div>
    
    <!-- MIDDLE ROW: Timer and flight info -->
    <div class="section-timer">
        <div style="font-size: rem; margin-bottom: 1.5rem;"><span class="turnaround-icon" style="font-size: 2.4rem; letter-spacing: 0.5rem;"></span></div>
        <div style="font-size: 1.5rem; color: #6b7280; margin-bottom: 0.5rem; font-weight: bold;">
    Departure: <span class="editable-dep editable" style="font-weight: bold; font-size: 1.3rem; color: #000345;">21:30</span>
</div>
        
        <div class="timer-content-wrapper" style="margin-top: 0.5rem;">
            
            <div class="timer" style="font-size: 1.5rem;">NOT OPEN</div>
        
        </div>
    </div>
    
    <!-- BOTTOM ROW: Status badge and delete button -->
    <div class="section-bottom">
        <div class="status-badge-wrapper">
            <div class="status-badge status-not-open" data-flight-id="1771399217504"> 3 HOURS FROM DEPARTURE</div>
        </div>
        <button class="permanent-delete-btn" onclick="deleteFlight(1771399217504)">
             Delete
        </button>
    </div>
</div><div class="flight-card not-open notopen-section-card">
    <!-- TOP ROW: Three bubbles -->
    <div class="section-left">
        <div class="flight-number-glass">
            <span class="editable-flight-num editable">JQ418</span>
        </div>
    </div>
    
    <div class="section-center">
        <div class="destination-glass">
            <span class="dest-display editable">OOL</span>
        </div>
    </div>
    
    <div class="section-right-top">
        <div class="close-time-glass">
            <span class="close-time-label">Closes:</span>
            <span class="close-time-value">21:05</span>
        </div>
    </div>
    
    <!-- MIDDLE ROW: Timer and flight info -->
    <div class="section-timer">
        <div style="font-size: rem; margin-bottom: 1.5rem;"><span class="turnaround-icon" style="font-size: 2.4rem; letter-spacing: 0.5rem;"></span></div>
        <div style="font-size: 1.5rem; color: #6b7280; margin-bottom: 0.5rem; font-weight: bold;">
    Departure: <span class="editable-dep editable" style="font-weight: bold; font-size: 1.3rem; color: #000345;">21:45</span>
</div>
        
        <div class="timer-content-wrapper" style="margin-top: 0.5rem;">
            
            <div class="timer" style="font-size: 1.5rem;">NOT OPEN</div>
        
        </div>
    </div>
    
    <!-- BOTTOM ROW: Status badge and delete button -->
    <div class="section-bottom">
        <div class="status-badge-wrapper">
            <div class="status-badge status-not-open" data-flight-id="1771399216770"> 3 HOURS FROM DEPARTURE</div>
        </div>
        <button class="permanent-delete-btn" onclick="deleteFlight(1771399216770)">
             Delete
        </button>
    </div>
</div><div class="flight-card not-open notopen-section-card">
    <!-- TOP ROW: Three bubbles -->
    <div class="section-left">
        <div class="flight-number-glass">
            <span class="editable-flight-num editable">JQ613</span>
        </div>
    </div>
    
    <div class="section-center">
        <div class="destination-glass">
            <span class="dest-display editable">AVV</span>
        </div>
    </div>
    
    <div class="section-right-top">
        <div class="close-time-glass">
            <span class="close-time-label">Closes:</span>
            <span class="close-time-value">21:05</span>
        </div>
    </div>
    
    <!-- MIDDLE ROW: Timer and flight info -->
    <div class="section-timer">
        <div style="font-size: rem; margin-bottom: 1.5rem;"><span class="turnaround-icon" style="font-size: 2.4rem; letter-spacing: 0.5rem;"></span></div>
        <div style="font-size: 1.5rem; color: #6b7280; margin-bottom: 0.5rem; font-weight: bold;">
    Departure: <span class="editable-dep editable" style="font-weight: bold; font-size: 1.3rem; color: #000345;">21:45</span>
</div>
        
        <div class="timer-content-wrapper" style="margin-top: 0.5rem;">
            
            <div class="timer" style="font-size: 1.5rem;">NOT OPEN</div>
        
        </div>
    </div>
    
    <!-- BOTTOM ROW: Status badge and delete button -->
    <div class="section-bottom">
        <div class="status-badge-wrapper">
            <div class="status-badge status-not-open" data-flight-id="1771399214732"> 3 HOURS FROM DEPARTURE</div>
        </div>
        <button class="permanent-delete-btn" onclick="deleteFlight(1771399214732)">
             Delete
        </button>
    </div>
</div></div>
</div>
   <div id="closed-section" class="section-container" style="display: none;">
    <div class="section-header" onclick="toggleSection('closed')">
        <div class="section-header-left">
            <div class="section-header-title">
                <span style="font-size: 1.5rem;"></span>
                <span id="closed-title">Check-in Closed</span>
                <span id="closed-count" class="section-header-count"></span>
            </div>
        </div>
        <button class="section-toggle" id="closed-toggle">+</button>
    </div>
    <div id="closed-flights" class="section-content"></div>
</div>
    
     <div id="cancelled-section" class="section-container" style="display: none;">
    <div class="section-header" onclick="toggleSection('cancelled')">
        <div class="section-header-left">
            <div class="section-header-title">
                <span style="font-size: 1.5rem;"></span>
                <span>CANCELLED FLIGHTS</span>
                <span id="cancelled-count-header" class="section-header-count"></span>
            </div>
        </div>
        <button class="section-toggle" id="cancelled-toggle">+</button>
    </div>
    <div id="cancelled-flights" class="section-content"></div>
</div>
<div class="deleted-flights-section" id="deleted-flights-section" style="display: none;">
    <div class="deleted-flights-header">
        <h2 class="deleted-flights-title">
            <span style="font-size: 1.5rem;"></span>
            <span>Deleted Flights</span>
            <span id="deleted-count" style="background: #dc2626; color: white; padding: 0.25rem 0.75rem; border-radius: 9999px; font-size: 0.875rem;"></span>
        </h2>
        <button class="clear-all-deleted-btn" onclick="clearAllDeletedFlights()">Clear All</button>
    </div>
    <div id="deleted-flights-container">
        <div class="no-deleted-flights">No deleted flights</div>
    </div>
</div>

<script>
    // Early initialization for busyness button (runs immediately)
    (function() {
        // Wait for DOM to be ready
        function showBusynessButton() {
            // Check if body has saved-html-file class OR if EMBEDDED_DATA exists
            const isSavedFile = document.body.classList.contains('saved-html-file') || 
                               (typeof EMBEDDED_DATA !== 'undefined' && EMBEDDED_DATA !== null);
            
            if (isSavedFile) {
                const floatBtn = document.getElementById('busyness-float-btn');
                if (floatBtn) {
                    floatBtn.style.display = 'flex';
                    console.log(' Busyness float button shown');
                }
            }
        }
        
        // Try immediately
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', showBusynessButton);
        } else {
            showBusynessButton();
        }
        
        // Also try after a short delay as backup
        setTimeout(showBusynessButton, 500);
        setTimeout(showBusynessButton, 1500);
    })();

    // iPad-specific optimizations
(function() {
    // Detect iPad
    const isIPad = /iPad/.test(navigator.userAgent) || 
                   (navigator.platform === 'MacIntel' && navigator.maxTouchPoints > 1);
    
   if (isIPad) {
    console.log(' iPad detected - applying optimizations');
    
    // Keep normal timer update frequency
    window.TIMER_UPDATE_INTERVAL = 1000; //  Changed back to 1 second
    window.FULL_RERENDER_INTERVAL = 60000; // 60 seconds instead of 30
        
        // Disable smooth scrolling
        document.documentElement.style.scrollBehavior = 'auto';
        
        // Reduce motion for better performance
        const style = document.createElement('style');
style.textContent = `
    * {
        transition-duration: 0.15s !important;
        animation-duration: 0.5s !important;
    }
    .flight-card {
        will-change: auto !important;
    }
    /*  Slow down pulsing animation on iPad */
    @keyframes pulse {
        0%, 100% { 
            opacity: 1; 
            box-shadow: 
                0 8px 32px rgba(239, 68, 68, 0.25),
                inset 0 1px 0 rgba(255, 255, 255, 0.6),
                inset 0 -1px 0 rgba(239, 68, 68, 0.1),
                0 0 40px rgba(239, 68, 68, 0.3);
        }
        50% { 
            opacity: 0.9; 
            box-shadow: 
                0 12px 48px rgba(239, 68, 68, 0.35),
                inset 0 1px 0 rgba(255, 255, 255, 0.7),
                inset 0 -1px 0 rgba(239, 68, 68, 0.15),
                0 0 50px rgba(239, 68, 68, 0.5);
        }
    }
    .flight-card.critical.pulsing {
        animation: pulse 3s ease-in-out infinite !important; /*  Slowed from 1.5s to 3s */
    }
`;
        document.head.appendChild(style);
    }
})();
// Workspace ONE Detection and Compatibility
const WorkspaceONE = {
    isRunning: function() {
        return navigator.userAgent.includes('VMware') || 
               navigator.userAgent.includes('AirWatch') ||
               navigator.userAgent.includes('WorkspaceONE') ||
               window.AirWatch !== undefined;
    },
    
    logCompatibility: function() {
        if (this.isRunning()) {
            console.log(' === WORKSPACE ONE DETECTED ===');
            console.log('Browser:', navigator.userAgent);
            console.log('localStorage available:', typeof localStorage !== 'undefined');
            console.log('sessionStorage available:', typeof sessionStorage !== 'undefined');
            console.log('IndexedDB available:', typeof indexedDB !== 'undefined');
            console.log('================================');
        }
    },
    
    getRecommendedStorage: function() {
        if (this.isRunning()) {
            // Workspace ONE: localStorage is most reliable
            return 'localStorage';
        }
        return 'any';
    }
};

// Call on page load
WorkspaceONE.logCompatibility();
// Firebase Configuration - WORKSPACE ONE COMPATIBLE
const firebaseConfig = {
  apiKey: "AIzaSyBZvBuD9WmNCbnulHw37k2CqzNuEZyFK2o",
  authDomain: "flight-close-dashboard.firebaseapp.com",
  databaseURL: "https://flight-close-dashboard-default-rtdb.firebaseio.com",
  projectId: "flight-close-dashboard",
  storageBucket: "flight-close-dashboard.firebasestorage.app",
  messagingSenderId: "631830069348",
  appId: "1:631830069348:web:d57ceaa1c4755b1e43df71"
};


// Check if Firebase config is properly set up
function isFirebaseConfigured() {
    return firebaseConfig.apiKey && 
           !firebaseConfig.apiKey.includes('YOUR_') &&
           firebaseConfig.databaseURL &&
           !firebaseConfig.databaseURL.includes('YOUR_');
}

// Workspace ONE compatible Firebase initialization
let firebaseInitialized = false;
let firebaseDbRef = null;

try {
    if (isFirebaseConfigured()) {
        // Check if running in Workspace ONE Browser
        const isWorkspaceOne = navigator.userAgent.includes('VMware') || 
                              navigator.userAgent.includes('AirWatch') ||
                              navigator.userAgent.includes('WorkspaceONE');
        
        if (isWorkspaceOne) {
            console.log(' Workspace ONE Browser detected');
            // Workspace ONE specific initialization if needed
        }
        
        firebase.initializeApp(firebaseConfig);
        firebaseInitialized = true;
        console.log(' Firebase initialized successfully');
        
        if (isWorkspaceOne) {
            console.log(' Firebase compatible with Workspace ONE');
        }
    } else {
        console.warn(' Firebase not configured - using localStorage only');
        console.log(' Replace the placeholder values in firebaseConfig to enable cloud sync');
    }
} catch (error) {
    console.error(' Firebase initialization error:', error);
    console.log(' Falling back to localStorage (safe for Workspace ONE)');
    firebaseInitialized = false;
}

        const INTERNATIONAL_DESTINATIONS = ['NAN', 'HLZ', 'HKT', 'KIX', 'DPS', 'AKL', 'ZQN', 'ICN', 'SGN', 'RAR', 'VLI'];
        let flights = [];
        let currentTime = new Date();
        let flightDate = null;
        let isInitializing = true; // Prevents sync until Firebase check completes
        let activeDropdown = null;
        let comments = [];
        let zoneEComments = [];
        let isEditingComments = false;
        let deletedFlights = [];
        let searchResultsModal = null;
let isEditingField = false;
// ADD THESE TWO LINES:
let acknowledgedCancellations = new Set();
let acknowledgedComments = new Set(); // NEW: Track acknowledged comment notifications
let acknowledgedZoneEComments = new Set(); // Track acknowledged Zone E comment notifications

        let dateValidationDismissed = false;
        // ============================================
        // AUTOMATIC LOCALSTORAGE MANAGEMENT
        // ============================================
      
        let sessionId = 'session_' + Date.now() + '_' + Math.random();
    // ============================================
// MULTI-TAB DETECTION SYSTEM (iPad/Tablet Compatible)
// ============================================
const TAB_HEARTBEAT_KEY = 'flight_tracker_tab_heartbeat';
const TAB_CLOSE_SIGNAL_KEY = 'flight_tracker_close_signal';
const TAB_CHECK_INTERVAL = 500; // Check every 500ms
const TAB_TIMEOUT = 3000; // Consider tab dead after 3 seconds (increased for tablets)
let tabId = 'tab_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
let isClosingDueToMultiTab = false;
let isTabDisabled = false; // New flag - tab is disabled but not closed
let heartbeatInterval = null;
let multiTabCheckInterval = null;
let closeSignalCheckInterval = null; // New - actively poll for close signals
let hasShownMultiTabWarning = false;

// Store this tab's information
function sendHeartbeat() {
    if (isTabDisabled) return; // Don't send heartbeats if tab is disabled
    
    try {
        const tabs = JSON.parse(localStorage.getItem(TAB_HEARTBEAT_KEY) || '[]');
        const now = Date.now();
        
        // Remove stale tabs (no heartbeat for TAB_TIMEOUT)
        const activeTabs = tabs.filter(tab => (now - tab.lastSeen) < TAB_TIMEOUT);
        
        // Update or add this tab
        const existingIndex = activeTabs.findIndex(tab => tab.id === tabId);
        if (existingIndex >= 0) {
            activeTabs[existingIndex].lastSeen = now;
        } else {
            console.log(' Registering new tab:', tabId);
            activeTabs.push({
                id: tabId,
                openedAt: now,
                lastSeen: now,
                url: window.location.href
            });
        }
        
        localStorage.setItem(TAB_HEARTBEAT_KEY, JSON.stringify(activeTabs));
        
        // Log periodically (every 20 heartbeats)
        if (!window.heartbeatCount) window.heartbeatCount = 0;
        window.heartbeatCount++;
        
        if (window.heartbeatCount % 20 === 0) {
            console.log(' Heartbeat:', {
                thisTab: tabId,
                totalActiveTabs: activeTabs.length,
                tabIds: activeTabs.map(t => t.id.substring(0, 15) + '...')
            });
        }
    } catch (e) {
        console.error('Error sending heartbeat:', e);
    }
}

// Check if there are multiple tabs open
function checkForMultipleTabs() {
    // Desktop users: Allow multiple tabs without aggressive warnings
    // The multi-tab system still works but doesn't interrupt workflow
    if (IS_DESKTOP) {
        // On desktop, still track tabs but don't show intrusive warnings
        // Just silently manage which tab is "active"
        return;
    }
    
    if (isClosingDueToMultiTab || isTabDisabled || hasShownMultiTabWarning) return;
    
    try {
        const tabs = JSON.parse(localStorage.getItem(TAB_HEARTBEAT_KEY) || '[]');
        const now = Date.now();
        
        // Filter to only active tabs
        const activeTabs = tabs.filter(tab => (now - tab.lastSeen) < TAB_TIMEOUT);
        
        // If there's more than one active tab
        if (activeTabs.length > 1) {
            // Sort by openedAt to find the newest tab
            activeTabs.sort((a, b) => b.openedAt - a.openedAt);
            
            const newestTab = activeTabs[0];
            const isThisTabNewest = newestTab.id === tabId;
            
            console.log(' Multiple tabs detected!', {
                totalTabs: activeTabs.length,
                newestTabId: newestTab.id.substring(0, 15) + '...',
                thisTabId: tabId.substring(0, 15) + '...',
                isThisTabNewest: isThisTabNewest
            });
            
            // If this IS the newest tab, show warning and signal others to close
            if (isThisTabNewest) {
                console.log(' This is the NEWEST tab. Showing warning and disabling older tabs...');
                hasShownMultiTabWarning = true;
                showMultiTabWarningOnNewestTab(activeTabs);
            }
        }
    } catch (e) {
        console.error('Error checking for multiple tabs:', e);
    }
}

// Actively check for close signals (works on iPad/tablets where storage event may not fire)
function checkForCloseSignal() {
    if (isClosingDueToMultiTab || isTabDisabled) return;
    
    try {
        const signalData = localStorage.getItem(TAB_CLOSE_SIGNAL_KEY);
        if (!signalData) return;
        
        const signal = JSON.parse(signalData);
        const now = Date.now();
        
        // Only process recent signals (within last 30 seconds)
        if (signal && signal.action === 'close_old_tabs' && 
            signal.keepTabId !== tabId && 
            (now - signal.timestamp) < 30000) {
            
            console.log(' Found close signal for this tab. Disabling...');
            disableOldTab();
        }
    } catch (e) {
        // Ignore parse errors
    }
}

// Show warning modal on the NEWEST tab (the one user is looking at)
function showMultiTabWarningOnNewestTab(allTabs) {
    // Stop checking for more tabs temporarily
    if (multiTabCheckInterval) {
        clearInterval(multiTabCheckInterval);
        multiTabCheckInterval = null;
    }
    
    const overlay = document.createElement('div');
    overlay.className = 'overlay multi-tab-overlay';
    overlay.style.zIndex = '10004';
    
    const modal = document.createElement('div');
    modal.className = 'multi-tab-warning-modal';
    
    const olderTabCount = allTabs.length - 1;
    let countdown = 5;
    
    modal.innerHTML = `
        <div class="multi-tab-warning-icon"></div>
        <div class="multi-tab-warning-title">Multiple Tabs Detected</div>
        <div class="multi-tab-warning-text">
            We detected <strong>${allTabs.length} tabs</strong> of Flight Tracker currently open.
            <br><br>
            To prevent data conflicts, we're disabling the <strong>${olderTabCount} older tab${olderTabCount > 1 ? 's' : ''}</strong>.
        </div>
        
        <div class="multi-tab-info">
            <strong> This is your most recent tab</strong> - it will remain open and you can continue working here.
        </div>
        
        <div class="multi-tab-countdown-container">
            <div class="multi-tab-countdown-label">Disabling older tabs in:</div>
            <div class="multi-tab-countdown" id="multi-tab-countdown">${countdown}</div>
        </div>
        
        <div class="multi-tab-status-bar-container">
            <div class="multi-tab-status-label"> Cleaning up duplicate tabs...</div>
            <div class="multi-tab-status-bar">
                <div class="multi-tab-status-fill" id="multi-tab-status-fill"></div>
            </div>
        </div>
        
        <div class="multi-tab-footer">
            The older tabs will be disabled automatically. No action needed from you.
        </div>
    `;
    
    document.body.appendChild(overlay);
    document.body.appendChild(modal);
    
    const statusFill = document.getElementById('multi-tab-status-fill');
    const totalSeconds = countdown;
    
    // Signal to older tabs that they should close/disable
    const closeSignal = {
        action: 'close_old_tabs',
        keepTabId: tabId,
        timestamp: Date.now()
    };
    localStorage.setItem(TAB_CLOSE_SIGNAL_KEY, JSON.stringify(closeSignal));
    
    // Countdown timer with status bar
    const countdownInterval = setInterval(() => {
        countdown--;
        const countdownEl = document.getElementById('multi-tab-countdown');
        if (countdownEl) {
            countdownEl.textContent = countdown;
        }
        
        // Update status bar
        const percentage = ((totalSeconds - countdown) / totalSeconds) * 100;
        if (statusFill) {
            statusFill.style.width = percentage + '%';
        }
        
        // Re-send the signal to ensure tablets pick it up
        if (countdown > 0) {
            const refreshSignal = {
                action: 'close_old_tabs',
                keepTabId: tabId,
                timestamp: Date.now()
            };
            localStorage.setItem(TAB_CLOSE_SIGNAL_KEY, JSON.stringify(refreshSignal));
        }
        
        if (countdown <= 0) {
            clearInterval(countdownInterval);
            
            // Close the modal with animation
            if (modal && modal.parentElement) {
                modal.style.opacity = '0';
                modal.style.transform = 'translate(-50%, -20%) scale(0.95)';
                modal.style.transition = 'all 0.3s ease-out';
            }
            if (overlay && overlay.parentElement) {
                overlay.style.opacity = '0';
                overlay.style.transition = 'opacity 0.3s ease-out';
            }
            
            setTimeout(() => {
                if (modal && modal.parentElement) modal.remove();
                if (overlay && overlay.parentElement) overlay.remove();
                
                // Clean up the close signal after a delay (let other tabs see it)
                setTimeout(() => {
                    localStorage.removeItem(TAB_CLOSE_SIGNAL_KEY);
                }, 5000);
                
                // Resume normal operation
                hasShownMultiTabWarning = false;
                
                // Restart checking (in case user opens another tab later)
                if (!multiTabCheckInterval) {
                    multiTabCheckInterval = setInterval(checkForMultipleTabs, TAB_CHECK_INTERVAL);
                }
            }, 300);
        }
    }, 1000);
}

// Disable this old tab (instead of trying to close it - works on iPad/tablets)
function disableOldTab() {
    if (isTabDisabled || isClosingDueToMultiTab) return;
    
    console.log(' Disabling this older tab...');
    
    isClosingDueToMultiTab = true;
    isTabDisabled = true;
    
    // Stop all intervals
    if (heartbeatInterval) {
        clearInterval(heartbeatInterval);
        heartbeatInterval = null;
    }
    if (multiTabCheckInterval) {
        clearInterval(multiTabCheckInterval);
        multiTabCheckInterval = null;
    }
    if (closeSignalCheckInterval) {
        clearInterval(closeSignalCheckInterval);
        closeSignalCheckInterval = null;
    }
    
    // Stop update intervals
    if (typeof stopUpdateIntervals === 'function') {
        stopUpdateIntervals();
    }
    
    // Clean up Firebase
    if (typeof firebaseDbRef !== 'undefined' && firebaseDbRef && typeof firebaseListenerActive !== 'undefined' && firebaseListenerActive) {
        firebaseDbRef.off('value');
    }
    
    // Remove this tab from heartbeat
    try {
        const tabs = JSON.parse(localStorage.getItem(TAB_HEARTBEAT_KEY) || '[]');
        const filteredTabs = tabs.filter(tab => tab.id !== tabId);
        localStorage.setItem(TAB_HEARTBEAT_KEY, JSON.stringify(filteredTabs));
    } catch (err) {
        console.error('Error removing tab from heartbeat:', err);
    }
    
    // Show "Tab Disabled" screen - user must manually close
    document.body.innerHTML = `
        <div style="display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100vh; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%); color: #000345; padding: 2rem;">
            <div style="text-align: center; padding: 3rem; background: white; border: 3px solid #FA5115; border-radius: 2rem; box-shadow: 0 20px 60px rgba(0,3,69,0.15); max-width: 500px; width: 90%;">
                <div style="font-size: 4rem; margin-bottom: 1rem;"></div>
                <h1 style="margin-bottom: 1rem; font-size: 1.8rem; color: #000345;">Tab Disabled</h1>
                <p style="color: #6b7280; font-size: 1rem; margin-bottom: 1.5rem; line-height: 1.5;">
                    A newer tab of Flight Tracker was opened.<br>
                    This tab has been disabled to prevent data conflicts.
                </p>
                <div style="background: rgba(250, 81, 21, 0.1); padding: 1rem; border-radius: 1rem; margin-bottom: 1.5rem;">
                    <p style="color: #FA5115; font-size: 0.95rem; font-weight: 600; margin: 0;">
                         Please continue working in your newest tab
                    </p>
                </div>
                <button onclick="window.location.reload()" style="
                    background: #000345;
                    color: white;
                    border: none;
                    padding: 1rem 2rem;
                    border-radius: 0.75rem;
                    font-size: 1rem;
                    font-weight: 600;
                    cursor: pointer;
                    margin-right: 0.5rem;
                    transition: all 0.2s;
                "> Reload This Tab</button>
                <button onclick="try{window.close()}catch(e){alert('Please close this tab manually')}" style="
                    background: #6b7280;
                    color: white;
                    border: none;
                    padding: 1rem 2rem;
                    border-radius: 0.75rem;
                    font-size: 1rem;
                    font-weight: 600;
                    cursor: pointer;
                    transition: all 0.2s;
                ">Close Tab</button>
            </div>
        </div>
    `;
}

// Listen for close signals from the newest tab (storage event - works on desktop)
function listenForCloseSignal() {
    window.addEventListener('storage', function(e) {
        if (e.key === TAB_CLOSE_SIGNAL_KEY && !isTabDisabled && !isClosingDueToMultiTab) {
            try {
                const signal = JSON.parse(e.newValue);
                
                // If the signal says to keep a different tab, this tab should be disabled
                if (signal && signal.action === 'close_old_tabs' && signal.keepTabId !== tabId) {
                    console.log(' Received close signal via storage event. Disabling this tab...');
                    disableOldTab();
                }
            } catch (err) {
                console.error('Error processing close signal:', err);
            }
        }
    });
}

// Start multi-tab detection
function startMultiTabDetection() {
    console.log(' Starting multi-tab detection system (iPad/Tablet compatible)');
    console.log(' Tab ID:', tabId);
    
    // Check for existing close signal immediately (for page refresh scenarios)
    checkForCloseSignal();
    
    // Send heartbeat every 500ms
    sendHeartbeat(); // Initial heartbeat
    heartbeatInterval = setInterval(sendHeartbeat, TAB_CHECK_INTERVAL);
    
    // Check for multiple tabs every 500ms
    multiTabCheckInterval = setInterval(checkForMultipleTabs, TAB_CHECK_INTERVAL);
    
    // Actively poll for close signals (for iPad/tablets where storage event may not fire)
    closeSignalCheckInterval = setInterval(checkForCloseSignal, 500);
    
    // Also listen via storage event (works better on desktop)
    listenForCloseSignal();
    
    console.log(' Multi-tab detection active');
}

// Clean up on page unload
window.addEventListener('beforeunload', function() {
    if (!isClosingDueToMultiTab && !isTabDisabled) {
        // Normal close - remove this tab from heartbeat
        try {
            const tabs = JSON.parse(localStorage.getItem(TAB_HEARTBEAT_KEY) || '[]');
            const filteredTabs = tabs.filter(tab => tab.id !== tabId);
            localStorage.setItem(TAB_HEARTBEAT_KEY, JSON.stringify(filteredTabs));
        } catch (e) {
            console.error('Error cleaning up tab heartbeat:', e);
        }
    }
});

// Also handle visibility change (when user switches tabs on mobile)
document.addEventListener('visibilitychange', function() {
    if (document.visibilityState === 'visible' && !isTabDisabled) {
        // Tab became visible - check for close signals
        checkForCloseSignal();
    }
});
        const SYNC_KEY = 'flight_tracker_sync';
        const COMMENT_LOCK_KEY = 'comment_lock';
    
        const POLL_INTERVAL = 2000;
       let firebaseListenerActive = false;
     let searchQuery = '';

let earlyOpenMode = null;
let earlyOpenFlightNumber = null;
let earlyOpenHours = 3;
let extensionTimers = {}; // Track extension timers for each flight

        // Get unique Firebase path based on flight date
        function getFirebasePath(basePath) {
            if (!flightDate) return basePath;
            const dateKey = getFlightDateKey();
            return `${basePath}_${dateKey}`;
        }

        // Initialize Firebase database reference
        function initializeFirebaseRef() {
            if (!firebaseInitialized || !flightDate) return;
            
            const dataPath = getFirebasePath('flight_tracker_data');
            firebaseDbRef = firebase.database().ref(dataPath);
            console.log(` Firebase path set to: ${dataPath}`);
            
            // Set up force refresh listener NOW that we have a valid flightDate
            setupForceRefreshListener();
        }
        
        // Track if force refresh listener is already set up
        let forceRefreshListenerActive = false;
        let lastProcessedRefreshSignal = null; // Track last processed signal to prevent duplicates
        
        // Set up Firebase listener for force refresh signals
        function setupForceRefreshListener() {
            if (!firebaseInitialized || !flightDate || forceRefreshListenerActive) return;
            
            const refreshPath = getFirebasePath('force_refresh_trigger');
            const forceRefreshRef = firebase.database().ref(refreshPath);
            
            console.log(' Setting up Firebase force refresh listener on path:', refreshPath);
            
            // Mark as active BEFORE setting up listener to prevent race conditions
            forceRefreshListenerActive = true;
            
            // Track the time when listener was set up - ignore signals older than this
            const listenerSetupTime = Date.now();
            
            forceRefreshRef.on('child_added', (snapshot) => {
                const signal = snapshot.val();
                
                if (!signal) {
                    console.log(' Empty signal received');
                    return;
                }
                
                const signalKey = snapshot.key;
                const now = Date.now();
                const signalAge = now - (signal.timestamp || 0);
                
                console.log(' Force refresh signal detected:', {
                    key: signalKey,
                    age: signalAge + 'ms',
                    fromSession: signal.fromSession?.substring(0, 15) + '...',
                    mySession: sessionId.substring(0, 15) + '...'
                });
                
                // DUPLICATE CHECK: Skip if we already processed this signal
                if (lastProcessedRefreshSignal === signalKey) {
                    console.log(' Skipping duplicate signal (already processed):', signalKey);
                    return;
                }
                
                // AGE CHECK: Only process signals created AFTER listener was set up and within 10 seconds
                if (signal.timestamp < listenerSetupTime) {
                    console.log(' Skipping old signal (created before listener setup)');
                    return;
                }
                
                if (signalAge >= 10000) {
                    console.log(' Skipping expired signal (age: ' + signalAge + 'ms)');
                    return;
                }
                
                // SESSION CHECK: Don't process our own signals
                if (signal.fromSession === sessionId) {
                    console.log(' Skipping signal from my own session');
                    return;
                }
                
                // Mark this signal as processed
                lastProcessedRefreshSignal = signalKey;
                
                console.log(' PROCESSING FORCE RELOAD SIGNAL (Firebase)');
                console.log(' Signal from session:', signal.fromSession.substring(0, 20) + '...');
                console.log(' Signal age:', signalAge + 'ms');
                
                // CRITICAL: Save user session BEFORE refresh so they don't have to login again
                if (typeof saveUserSession === 'function' && typeof currentUser !== 'undefined' && currentUser) {
                    saveUserSession();
                    console.log(' User session saved for post-refresh restore');
                }
                
                // Show refreshing animation IMMEDIATELY
                showRefreshingAnimation();
                
                // Stop all intervals
                if (heartbeatInterval) {
                    clearInterval(heartbeatInterval);
                    console.log(' Stopped heartbeat');
                }
                if (multiTabCheckInterval) {
                    clearInterval(multiTabCheckInterval);
                    console.log(' Stopped multi-tab check');
                }
                if (typeof closeSignalCheckInterval !== 'undefined' && closeSignalCheckInterval) {
                    clearInterval(closeSignalCheckInterval);
                }
                stopUpdateIntervals();
                
                // Clean up Firebase listener
                if (firebaseDbRef && firebaseListenerActive) {
                    firebaseDbRef.off('value');
                    firebaseListenerActive = false;
                    console.log(' Firebase listener cleaned up');
                }
                
                // Clean up heartbeat
                try {
                    localStorage.removeItem(TAB_HEARTBEAT_KEY);
                } catch (e) {
                    console.error('Error clearing heartbeat:', e);
                }
                
                // Update progress bar steps
                setTimeout(() => {
                    const statusEl = document.getElementById('refresh-status');
                    const progressEl = document.getElementById('refresh-progress');
                    if (statusEl) statusEl.textContent = 'Received refresh signal...';
                    if (progressEl) progressEl.style.width = '60%';
                }, 500);
                
                setTimeout(() => {
                    const statusEl = document.getElementById('refresh-status');
                    const progressEl = document.getElementById('refresh-progress');
                    if (statusEl) statusEl.textContent = 'Preparing reload...';
                    if (progressEl) progressEl.style.width = '90%';
                }, 2000);
                
                // Reload after 5 seconds
                setTimeout(() => {
                    console.log(' Reloading page now...');
                    const progressEl = document.getElementById('refresh-progress');
                    if (progressEl) progressEl.style.width = '100%';
                    location.reload(true);
                }, 5000);
            });
            
            console.log(' Firebase force refresh listener active on:', refreshPath);
        }

        function updateTime() {
            currentTime = new Date();
            document.getElementById('current-time').textContent = 
                currentTime.toLocaleTimeString('en-AU', { hour12: false });
        }
        setInterval(updateTime, 1000);
        updateTime();

        function toggleSection(sectionName) {
            const content = document.getElementById(`${sectionName}-flights`);
            const toggle = document.getElementById(`${sectionName}-toggle`);
            
            content.classList.add('user-interacted');
            
            if (content.classList.contains('expanded')) {
                content.classList.remove('expanded');
                toggle.style.transform = 'rotate(-90deg)';
            } else {
                content.classList.add('expanded');
                toggle.style.transform = 'rotate(0deg)';
            }
        }

        function openAddFlightModal() {
            closeAllDropdowns();
            
            const overlay = document.createElement('div');
            overlay.className = 'overlay';
            
            const modal = document.createElement('div');
            modal.className = 'add-flight-modal';
            
            modal.innerHTML = `
                <div class="add-flight-title"> Add New Flight</div>
                <div class="add-flight-form">
                    <div class="form-group">
                        <label class="form-label">Flight Number *</label>
                        <input type="text" class="form-input" id="new-flight-number" placeholder="e.g., VA123" autocomplete="off">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Destination *</label>
                        <input type="text" class="form-input" id="new-flight-destination" placeholder="e.g., BNE, SYD, MEL" autocomplete="off" maxlength="3" style="text-transform: uppercase;">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Departure Time *</label>
                        <input type="time" class="form-input" id="new-flight-time">
                        <div class="form-note">Check-in will automatically close 40 minutes before this time</div>
                    </div>
                    <div class="form-actions">
                        <button class="form-cancel-btn" onclick="closeAddFlightModal()">Cancel</button>
                        <button class="form-save-btn" onclick="saveNewFlight()">Add Flight</button>
                    </div>
                </div>
            `;
            
            overlay.onclick = closeAddFlightModal;
            
            document.body.appendChild(overlay);
            document.body.appendChild(modal);
            
            document.getElementById('new-flight-number').focus();
        }

        function closeAddFlightModal() {
            const overlay = document.querySelector('.overlay');
            const modal = document.querySelector('.add-flight-modal');
            if (overlay) overlay.remove();
            if (modal) modal.remove();
        }

        function saveNewFlight() {
            const flightNumber = document.getElementById('new-flight-number').value.trim().toUpperCase();
            const destination = document.getElementById('new-flight-destination').value.trim().toUpperCase();
            const departureTime = document.getElementById('new-flight-time').value;
            
            if (!flightNumber) {
                alert('Please enter a flight number');
                document.getElementById('new-flight-number').focus();
                return;
            }
            
            if (!destination) {
                alert('Please enter a destination');
                document.getElementById('new-flight-destination').focus();
                return;
            }
            
            if (destination.length !== 3) {
                alert('Destination must be 3 letters (e.g., BNE, SYD, MEL)');
                document.getElementById('new-flight-destination').focus();
                return;
            }
            
            if (!departureTime) {
                alert('Please select a departure time');
                document.getElementById('new-flight-time').focus();
                return;
            }
            
            const newFlight = {
                id: Date.now(),
                flightNumber: flightNumber,
                destination: destination,
                departureTime: departureTime,
                originalDepartureTime: departureTime,
                isDelayed: false,
                isTurnaround: false,
              inboundFlight: '',
                pax: 0,
                manualStatus: null,
                cancelReason: null,
                isAdhoc: true,
                extensionStartTime: null,
                extensionDuration: null
            };
            
          flights.push(newFlight);
    
    closeAddFlightModal();
      // ADD THIS - Clear cache for new flight
    debouncedSync();
    updateDisplay();
            
            alert(` Flight ${flightNumber} to ${destination} added successfully!`);
        }



       

   function saveAsHTML() {
    // Create filename directly from flight date
    let fileName = 'Flight Tracker';
    
    if (flightDate) {
        const day = flightDate.getDate().toString().padStart(2, '0');
        const month = (flightDate.getMonth() + 1).toString().padStart(2, '0');
        const year = flightDate.getFullYear();
        fileName = `Flight Close_${day}-${month}-${year}`;
    }
    
    //  STEP 1: Filter out cancelled flights before saving
    console.log(' Preparing to save HTML file...');
    console.log(' Total flights:', flights.length);
    
    // Count how many are cancelled
    const cancelledCount = flights.filter(f => f.manualStatus === 'cancelled').length;
    console.log(' Cancelled flights:', cancelledCount);
    
    // Create filtered array WITHOUT cancelled flights
    const flightsToSave = flights.filter(f => {
        const isCancelled = f.manualStatus === 'cancelled';
        
        if (isCancelled) {
            console.log('   Excluding cancelled flight:', f.flightNumber, 'to', f.destination);
        }
        
        return !isCancelled; // Keep only non-cancelled flights
    });
    
    console.log(' Flights to save:', flightsToSave.length);
    console.log(' Excluded:', flights.length - flightsToSave.length, 'cancelled flights');
     //  OPTIONAL: Warn user if cancelled flights are being excluded
    if (cancelledCount > 0) {
        const shouldContinue = confirm(
            ` NOTICE: ${cancelledCount} cancelled flight${cancelledCount > 1 ? 's' : ''} will NOT be saved in the HTML file.\n\n` +
            `This is intentional - cancelled flights won't appear when you open this file later.\n\n` +
            `Flights being excluded:\n${flights.filter(f => f.manualStatus === 'cancelled').map(f => ` ${f.flightNumber} to ${f.destination}`).join('\n')}\n\n` +
            `Continue saving?`
        );
        
        if (!shouldContinue) {
            console.log(' User cancelled HTML save');
            return; // Exit function without saving
        }
    }
    //  STEP 2: Prepare data to embed (using filtered flights)
const dataToEmbed = {
    flights: flightsToSave,
    comments: comments,
    zoneEComments: zoneEComments,
    deletedFlights: [],  //  Always start fresh - don't include deleted flights in saved HTML
    earlyOpenMode: earlyOpenMode,
    earlyOpenFlightNumber: earlyOpenFlightNumber,
    earlyOpenHours: earlyOpenHours,
    flightDate: flightDate ? (flightDate.getFullYear() + '-' + String(flightDate.getMonth() + 1).padStart(2, '0') + '-' + String(flightDate.getDate()).padStart(2, '0')) : null,
    leadershipData: leadershipData,  //  Save leadership team assignments
    savedTimestamp: Date.now()
};
    
    // Get current HTML
    let htmlContent = document.documentElement.outerHTML;
    
    // Embed the data
    const dataScript = `const EMBEDDED_DATA = ${JSON.stringify(dataToEmbed)};`;
    htmlContent = htmlContent.replace(
        'const EMBEDDED_DATA = null;',
        dataScript
    );
    
    // Add CSS to hide only the 3 buttons
    const hideStyle = `
    <style id="saved-file-style">
        /* Hide only these 3 buttons */
        .upload-btn:not(.add-comment-main-btn):not(.add-flight-btn):not(.early-open-btn) { 
            display: none !important; 
        }
        #reset-btn { display: none !important; }
        #save-html-btn { display: none !important; }
        
        /* Hide all content until user logs in */
        body.requires-login .container {
            opacity: 0;
            pointer-events: none;
        }
        body.requires-login .user-login-overlay {
            opacity: 1 !important;
            pointer-events: all !important;
        }
        
        /* Keep busyness button visible even before login */
        body.requires-login .busyness-float-btn {
            opacity: 1 !important;
            pointer-events: all !important;
        }
    </style>
`;
    
    // Add marker class to body for saved files that require login
    htmlContent = htmlContent.replace('<body>', '<body class="requires-login saved-html-file">');
    
    htmlContent = htmlContent.replace('</head>', hideStyle + '</head>');
    
    // Save the file
    const blob = new Blob([htmlContent], { type: 'text/html' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `${fileName}.html`;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
    
    alert(' HTML file saved!');
}

       // Debounce sync to prevent hammering Firebase
let syncTimeout;
let syncQueue = [];
let lastSyncTime = 0;
const MIN_SYNC_INTERVAL = 2000; // Minimum 2 seconds between syncs

function debouncedSync() {
    clearTimeout(syncTimeout);
    
    // Don't sync if editing
    if (isEditingField || activeDropdown) {
        console.log(' Sync delayed - user interaction');
        syncTimeout = setTimeout(debouncedSync, 1000);
        return;
    }
    
    const now = Date.now();
    const timeSinceLastSync = now - lastSyncTime;
    
    // If we just synced recently, wait longer
    if (timeSinceLastSync < MIN_SYNC_INTERVAL) {
        syncTimeout = setTimeout(() => {
            syncData();
            lastSyncTime = Date.now();
        }, MIN_SYNC_INTERVAL - timeSinceLastSync + 500);
    } else {
        // Normal debounce
        syncTimeout = setTimeout(() => {
            syncData();
            lastSyncTime = Date.now();
        }, 500);
    }
}
async function syncData() {
    // CRITICAL: Block sync during initialization
    if (isInitializing) {
        console.log(' BLOCKED: Sync prevented during initialization');
        return;
    }
    
    // CRITICAL: If user is actively editing, wait
    if (isEditingField) {
        console.log(' Delaying sync - user is editing');
        return;
    }
    
    // Remove any duplicate flights by ID before syncing
    const seenIds = new Set();
    flights = flights.filter(flight => {
        if (seenIds.has(flight.id)) {
            console.warn(' Removing duplicate flight:', flight.flightNumber, flight.id);
            return false;
        }
        seenIds.add(flight.id);
        return true;
    });

    // Remove any flights with invalid data
    flights = flights.filter(flight => {
        if (!flight.flightNumber || !flight.destination || !flight.departureTime) {
            console.warn(' Removing invalid flight:', flight);
            return false;
        }
        return true;
    });
    
    const indicator = document.getElementById('connection-indicator');
    
    // Show syncing indicator
    if (indicator) {
        indicator.style.display = 'flex';
        indicator.className = 'connection-indicator syncing';
        const textEl = indicator.querySelector('.connection-text');
        if (textEl) textEl.textContent = 'Syncing...';
    }
    
    const timestamp = Date.now();
    
    const data = {
        flights: flights,
        comments: comments,
        zoneEComments: zoneEComments,
        deletedFlights: deletedFlights,
        earlyOpenMode: earlyOpenMode,
        earlyOpenFlightNumber: earlyOpenFlightNumber,
        earlyOpenHours: earlyOpenHours,
        timestamp: timestamp,
        sessionId: sessionId
    };
    
    try {
        // Only sync to localStorage for multi-tab coordination (minimal)
        localStorage.setItem(SYNC_KEY, JSON.stringify(data));
        
        let firebaseSuccess = false;
        
        // Firebase is the PRIMARY storage
        if (firebaseInitialized && firebaseDbRef) {
            try {
                await firebaseDbRef.set(data);
                console.log(' Data synced to Firebase');
                firebaseSuccess = true;
            } catch (fbError) {
                console.warn(' Firebase sync failed:', fbError);
                firebaseSuccess = false;
            }
        }
        
        // Show success indicator
        if (indicator) {
            const textEl = indicator.querySelector('.connection-text');
            indicator.className = 'connection-indicator';
            indicator.style.borderColor = '#10b981';
            indicator.style.color = '#10b981';
            if (textEl) {
                textEl.textContent = firebaseSuccess ? 'Synced' : 'Local Only';
            }
            
            // Hide after 2 seconds
            setTimeout(() => {
                indicator.style.opacity = '0';
                setTimeout(() => {
                    indicator.style.display = 'none';
                    indicator.style.opacity = '1';
                }, 300);
            }, 2000);
        }
        
    } catch (e) {
        console.error(' Error syncing data:', e);
        
        // Show error indicator
        if (indicator) {
            const textEl = indicator.querySelector('.connection-text');
            indicator.className = 'connection-indicator error';
            indicator.style.borderColor = '#ef4444';
            indicator.style.color = '#ef4444';
            if (textEl) textEl.textContent = 'Sync Failed';
            
            setTimeout(() => {
                indicator.style.display = 'none';
            }, 3000);
        }
    }
}
function broadcastRefreshSignal() {
    const refreshSignal = {
        action: 'force_refresh',
        timestamp: Date.now(),
        fromSession: sessionId
    };
    
    try {
        localStorage.setItem('force_refresh_signal', JSON.stringify(refreshSignal));
        console.log(' Broadcast refresh signal to all devices');
        
        // Clear signal after 1 second
        setTimeout(() => {
            localStorage.removeItem('force_refresh_signal');
        }, 1000);
    } catch (e) {
        console.error('Error broadcasting refresh:', e);
    }
}
async function forceRefreshAllDevices() {
    // Confirm action
    if (!confirm('This will refresh ALL devices using this file (computers, iPads, phones, etc). Continue?')) {
        return;
    }
    
    console.log(' FORCING REFRESH ON ALL DEVICES');
    
    // CRITICAL: Save user session BEFORE refresh so they don't have to login again
    if (typeof saveUserSession === 'function' && currentUser) {
        saveUserSession();
        console.log(' User session saved for post-refresh restore');
    }
    
    // Show refreshing animation on THIS device
    showRefreshingAnimation();
    
    // CRITICAL: Stop all intervals to prevent conflicts
    if (heartbeatInterval) {
        clearInterval(heartbeatInterval);
        console.log(' Stopped heartbeat');
    }
    if (multiTabCheckInterval) {
        clearInterval(multiTabCheckInterval);
        console.log(' Stopped multi-tab check');
    }
    stopUpdateIntervals();
    
    try {
        // STEP 1: Force complete sync to Firebase with current state
        console.log(' Step 1: Syncing current state to Firebase...');
        
        const timestamp = Date.now();
        const completeState = {
            flights: flights,
            comments: comments,
            deletedFlights: deletedFlights,
            earlyOpenMode: earlyOpenMode,
            earlyOpenFlightNumber: earlyOpenFlightNumber,
            earlyOpenHours: earlyOpenHours,
            timestamp: timestamp,
            sessionId: sessionId
        };
        
        // Save to localStorage first
        localStorage.setItem(SYNC_KEY, JSON.stringify(completeState));
          
        
        // Then to Firebase if available
        if (firebaseInitialized && firebaseDbRef) {
            await firebaseDbRef.set(completeState);
            console.log(' State synced to Firebase');
            
            // Wait for Firebase to propagate (important!)
            await new Promise(resolve => setTimeout(resolve, 1500));
        }
        
        // STEP 2: Create unique refresh signal with UNIQUE KEY
console.log(' Step 2: Broadcasting refresh signal...');

const refreshSignalId = 'refresh_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);

const refreshSignal = {
    action: 'force_reload_all',
    timestamp: Date.now(),
    fromSession: sessionId,
    triggerCount: Math.random(),
    stateTimestamp: timestamp  //  Link to the state we just saved
};

// Send via Firebase with PUSH (creates unique key for each signal)
if (firebaseInitialized) {
    const forceRefreshRef = firebase.database().ref(getFirebasePath('force_refresh_trigger'));
    
    // Use push() to create unique key for each signal
    await forceRefreshRef.push(refreshSignal);
    console.log(' Firebase refresh signal sent');
    
    // Clean up old signals (older than 30 seconds)
    setTimeout(async () => {
        try {
            const oldSignals = await forceRefreshRef.once('value');
            const now = Date.now();
            
            oldSignals.forEach(childSnapshot => {
                const data = childSnapshot.val();
                if (data && data.timestamp && (now - data.timestamp) > 30000) {
                    childSnapshot.ref.remove();
                }
            });
            
            console.log(' Cleaned up old refresh signals');
        } catch (e) {
            console.error('Error cleaning up old signals:', e);
        }
    }, 5000);
}
        
        // Send via localStorage (for same-device tabs)
        localStorage.setItem('force_reload_all_signal', JSON.stringify(refreshSignal));
        console.log(' localStorage refresh signal sent');
        
        // STEP 3: Wait for signals to propagate to other devices
console.log(' Step 3: Waiting for signal propagation (2 seconds)...');
await new Promise(resolve => setTimeout(resolve, 2000));
        
        // STEP 4: Clean up before reload
        console.log(' Step 4: Cleaning up...');
        try {
            localStorage.removeItem(TAB_HEARTBEAT_KEY);
            console.log(' Heartbeat data cleared');
        } catch (e) {
            console.error('Error cleaning heartbeat:', e);
        }
        
// STEP 5: Update progress one more time before reload
console.log(' Step 5: Final progress update...');
setTimeout(() => {
    const statusEl = document.getElementById('refresh-status');
    const progressEl = document.getElementById('refresh-progress');
    if (statusEl) statusEl.textContent = 'Reloading now...';
    if (progressEl) progressEl.style.width = '100%';
}, 4500);

// STEP 6: Hard reload THIS device after 5 seconds total
setTimeout(() => {
    console.log(' Step 6: Reloading this device NOW...');
    
    // Clear cache and force reload
    if ('caches' in window) {
        caches.keys().then(names => {
            names.forEach(name => caches.delete(name));
        });
    }
    
    location.reload(true); // true = force reload from server
}, 5000); // Match the 5 second timing from receiving devices
        
    } catch (e) {
        console.error(' Error during force refresh:', e);
        
        // Remove refreshing overlay
        const overlay = document.getElementById('refreshing-overlay');
        if (overlay) overlay.remove();
        
        alert('Error sending refresh signal: ' + e.message + '\n\nPlease check your connection and try again.');
        
        // Restart intervals if refresh failed
        startMultiTabDetection();
        startUpdateIntervals();
    }
}
function showRefreshingAnimation() {
    // Remove any existing refresh overlays
    const existing = document.getElementById('refreshing-overlay');
    if (existing) existing.remove();
    
    // CRITICAL: Also remove any green notification overlays
    const greenNotif = document.querySelector('.overlay');
    if (greenNotif) greenNotif.remove();
    
    // Create elegant, minimal overlay matching theme
    const overlay = document.createElement('div');
    overlay.id = 'refreshing-overlay';
    overlay.style.cssText = `
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(255, 255, 255, 0.95);
        backdrop-filter: blur(10px);
        -webkit-backdrop-filter: blur(10px);
        z-index: 99999;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
    `;
    
    overlay.innerHTML = `
        <div style="text-align: center; padding: 3rem; background: rgba(255, 255, 255, 0.98); border: 2px solid rgba(0, 3, 69, 0.15); border-radius: 1.5rem; box-shadow: 0 20px 60px rgba(0, 3, 69, 0.1); max-width: 450px; width: 90%;">
            <div style="width: 60px; height: 60px; border: 4px solid rgba(0, 3, 69, 0.1); border-top: 4px solid #000345; border-radius: 50%; animation: elegantSpin 1s linear infinite; margin: 0 auto 1.5rem;"></div>
            <div style="font-size: 1.5rem; font-weight: 700; color: #000345; margin-bottom: 0.75rem;">Syncing All Devices</div>
            <div style="font-size: 1rem; color: #6b7280; margin-bottom: 1.5rem;" id="refresh-status">Refreshing data across all connected devices...</div>
            <div style="width: 100%; height: 6px; background: rgba(0, 3, 69, 0.1); border-radius: 10px; overflow: hidden;">
                <div id="refresh-progress" style="width: 0%; height: 100%; background: linear-gradient(90deg, #000345, #FA5115); border-radius: 10px; transition: width 0.5s ease;"></div>
            </div>
            <div style="font-size: 0.85rem; color: #9ca3af; margin-top: 1rem;">Please wait while all devices sync...</div>
        </div>
        <style>
            @keyframes elegantSpin {
                from { transform: rotate(0deg); }
                to { transform: rotate(360deg); }
            }
        </style>
    `;
    
    document.body.appendChild(overlay);
    
    console.log(' Elegant refreshing animation shown');
}

window.addEventListener('storage', function(e) {
    // ============================================
    // HANDLE CLEAR ALL DATA SIGNAL (NEW - ADD THIS)
    // ============================================
   
    
    // ============================================
    // HANDLE FORCE RELOAD SIGNAL (EXISTING - KEEP THIS)
    // ============================================
    // Handle force reload signal via localStorage (for same-device multi-tab scenarios)
    if (e.key === 'force_reload_all_signal' && e.newValue) {
        try {
            const signal = JSON.parse(e.newValue);
            
            // Only reload if signal is from a different session AND is recent
            const signalAge = Date.now() - (signal.timestamp || 0);
            
            if (signal && signal.fromSession !== sessionId && signalAge < 10000) {
                console.log(' RECEIVED FORCE RELOAD SIGNAL (localStorage)');
                console.log(' Signal from session:', signal.fromSession.substring(0, 20) + '...');
                console.log(' Signal age:', signalAge + 'ms');
                
                // CRITICAL FIX: Show BLUE refreshing animation (same as initiating device)
                showRefreshingAnimation();
                
                // Update the progress bar steps
                setTimeout(() => {
                    document.getElementById('refresh-status').textContent = 'Received refresh signal...';
                    document.getElementById('refresh-progress').style.width = '60%';
                }, 500);
                
                setTimeout(() => {
                    document.getElementById('refresh-status').textContent = 'Preparing reload...';
                    document.getElementById('refresh-progress').style.width = '90%';
                }, 2000);
                
                // Reload after 5 seconds (match the initiating device timing)
                setTimeout(() => {
                    console.log(' Reloading page now...');
                    document.getElementById('refresh-progress').style.width = '100%';
                    location.reload(true);
                }, 5000);
            } else if (signalAge >= 10000) {
                console.log(' Ignoring old localStorage reload signal (age: ' + signalAge + 'ms)');
            } else {
                console.log(' Ignoring reload signal from same session');
            }
        } catch (err) {
            console.error(' Error processing force reload signal:', err);
        }
    }
    
    // ============================================
    // HANDLE REGULAR SYNC UPDATES (EXISTING - KEEP THIS)
    // ============================================
    // Handle regular sync updates
    if (e.key === SYNC_KEY && e.newValue) {
        console.log(' Received sync update from another device');
        loadSyncData();
    }
    
    // ============================================
    // HANDLE REFRESH SIGNAL (EXISTING - KEEP THIS)
    // ============================================
    // Handle refresh signal (non-reload version)
    if (e.key === 'force_refresh_signal' && e.newValue) {
        try {
            const signal = JSON.parse(e.newValue);
            
            if (signal && signal.fromSession !== sessionId) {
                console.log(' Received refresh signal from another device');
                
                // Force immediate reload of data (don't reload page)
                setTimeout(() => {
                    loadSyncData();
                    updateDisplay();
                    renderComments();
                    renderDeletedFlights();
                }, 100);
            }
        } catch (err) {
            console.error('Error processing refresh signal:', err);
        }
    }// ============================================
    // HANDLE CANCELLATION BROADCASTS (NEW)
    // ============================================
  // ============================================
// HANDLE CANCELLATION BROADCASTS (NEW)
// ============================================
if (e.key === 'cancellation_broadcast' && e.newValue) {
    try {
        const broadcast = JSON.parse(e.newValue);
        
        // Only process if from different session and recent
        const broadcastAge = Date.now() - (broadcast.timestamp || 0);
        
        if (broadcast.fromSession !== sessionId && broadcastAge < 10000) {
            console.log(' Received cancellation broadcast from another tab');
            
            // Find the flight
            const flight = flights.find(f => f.id === broadcast.flightId);
            if (flight && flight.manualStatus !== 'cancelled') {
                // Update flight status AND reason
                flight.manualStatus = 'cancelled';
                flight.cancelledAt = broadcast.cancelledAt;
                flight.cancelReason = broadcast.cancelReason;
flight.approverName = broadcast.approvalInfo.approverName;  // ADD THIS LINE
flight.approverPosition = broadcast.approvalInfo.approverPosition;  // ADD THIS LINE
flight.supervisorName = broadcast.approvalInfo.supervisorName;  // ADD THIS LINE
                
                updateDisplay();
                
                // Show notification with approval info
                showCancellationNotificationWithApproval(flight, broadcast.approvalInfo);
            }
        }
    } catch (err) {
        console.error('Error processing cancellation broadcast:', err);
    }
}
// ============================================
// HANDLE COMMENT BROADCASTS (NEW)
// ============================================
if (e.key === 'comment_broadcast' && e.newValue) {
    try {
        const broadcast = JSON.parse(e.newValue);
        
        // Only process if from different session and recent
        const broadcastAge = Date.now() - (broadcast.timestamp || 0);
        
        if (broadcast.fromSession !== sessionId && broadcastAge < 10000) {
            console.log(' Received comment broadcast from another tab');
            
            if (broadcast.action === 'comment_added') {
                // Check if comment already exists
                const exists = comments.find(c => c.id === broadcast.comment.id);
                if (!exists) {
                    comments.push(broadcast.comment);
                    renderComments();
                    
                    // Show notification
                    showCommentNotification(broadcast.comment);
                }
            } else if (broadcast.action === 'comment_edited') {
                // Find and update the comment
                const comment = comments.find(c => c.id === broadcast.commentId);
                if (comment) {
                    comment.text = broadcast.newText;
                    comment.editedAt = broadcast.editedAt;
                    comment.editedBy = broadcast.editedBy;
                    renderComments();
                    
                    // Show notification for edit
                    showCommentEditNotification(comment);
                }
            }
        }
    } catch (err) {
        console.error('Error processing comment broadcast:', err);
    }
}
});
function showReloadNotification() {
    // CRITICAL: This function is now DEPRECATED - use showRefreshingAnimation() instead
    console.warn(' showReloadNotification() called but should use showRefreshingAnimation()');
    
    // Redirect to blue animation instead
    showRefreshingAnimation();
    return;
    
    // Remove any existing refresh overlays
    const existing = document.getElementById('refreshing-overlay');
    if (existing) existing.remove();
    
    // Create full-screen refreshing overlay
    const overlay = document.createElement('div');
    overlay.id = 'refreshing-overlay';
    overlay.style.cssText = `
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: linear-gradient(135deg, rgba(16, 185, 129, 0.95), rgba(5, 150, 105, 0.98));
        z-index: 99999;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        color: white;
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
        animation: fadeIn 0.3s ease-in;
    `;
    
    overlay.innerHTML = `
        <div style="text-align: center;">
            <div style="font-size: 5rem; margin-bottom: 1.5rem; animation: spin 2s linear infinite;"></div>
            <div style="font-size: 2rem; font-weight: bold; margin-bottom: 1rem;">Refresh Triggered</div>
            <div style="font-size: 1.2rem; opacity: 0.9; margin-bottom: 0.5rem;">Another device requested a refresh</div>
            <div style="font-size: 1rem; opacity: 0.8;">Reloading now...</div>
            <div style="width: 300px; height: 8px; background: rgba(255,255,255,0.3); border-radius: 10px; overflow: hidden; margin: 2rem auto 0;">
                <div style="width: 100%; height: 100%; background: white; border-radius: 10px; animation: progressBar 1.5s ease-in-out infinite;"></div>
            </div>
        </div>
        <style>
            @keyframes fadeIn {
                from { opacity: 0; }
                to { opacity: 1; }
            }
            @keyframes spin {
                from { transform: rotate(0deg); }
                to { transform: rotate(360deg); }
            }
            @keyframes progressBar {
                0% { transform: translateX(-100%); }
                100% { transform: translateX(100%); }
            }
        </style>
    `;
    
    document.body.appendChild(overlay);
}
// ============================================
// CLEARING ANIMATION (NEW)
// ============================================

// Listen for refresh signals
window.addEventListener('storage', function(e) {
    if (e.key === 'force_refresh_signal') {
        try {
            const signal = JSON.parse(e.newValue);
            
            if (signal && signal.fromSession !== sessionId) {
                console.log(' Received refresh signal from another device');
                
                // Force immediate reload of data
                setTimeout(() => {
                    loadSyncData();
                    updateDisplay();
                    renderComments();
                    renderDeletedFlights();
                }, 100);
            }
        } catch (err) {
            console.error('Error processing refresh signal:', err);
        }
    }
});
   function setupFirebaseListener() {
    if (!firebaseInitialized || !firebaseDbRef) {
        return;
    }
    
    // CRITICAL: Always remove old listener first
    if (firebaseListenerActive) {
        firebaseDbRef.off('value');
        console.log(' Cleaned up old Firebase listener');
    }
    
    console.log(' Setting up Firebase realtime listener...');
    
firebaseDbRef.on('value', async (snapshot) => {
    const remoteData = snapshot.val();
    
    if (!remoteData) {
        console.log(' No remote data found');
        return;
    }
    
    // CRITICAL: Always apply remote data if timestamp is newer
     
    const remoteTimestamp = remoteData.timestamp || 0;
    
   if (remoteData.sessionId === sessionId) {
    console.log(' Skipping - this is our own update');
    return;
}
    
    console.log(' Applying remote update from', remoteData.sessionId === sessionId ? 'this device' : 'another device');
    
    // CRITICAL FIX: Always clear render cache when receiving remote updates
     
    console.log(' Cleared render cache for remote update');
        
        if (isEditingField || activeDropdown || checkCommentLock()) {
            console.log(' User is editing, will sync later');
            return;
        }
        
        const scrollPosition = window.scrollY;
        
        const sectionStates = {
            urgent: document.getElementById('urgent-flights')?.classList.contains('expanded'),
            extended: document.getElementById('extended-flights')?.classList.contains('expanded'),
            active: document.getElementById('active-flights')?.classList.contains('expanded'),
            closed: document.getElementById('closed-flights')?.classList.contains('expanded'),
            notopen: document.getElementById('notopen-flights')?.classList.contains('expanded'),
            cancelled: document.getElementById('cancelled-flights')?.classList.contains('expanded')
        };
        
       // Accept remote data directly - Firebase is single source of truth
flights = remoteData.flights || [];
comments = remoteData.comments || [];
zoneEComments = remoteData.zoneEComments || [];
deletedFlights = remoteData.deletedFlights || [];
earlyOpenMode = remoteData.earlyOpenMode || null;
earlyOpenFlightNumber = remoteData.earlyOpenFlightNumber || null;
earlyOpenHours = remoteData.earlyOpenHours || 3;

updateDisplay();
renderComments();
renderZoneEComments();
renderDeletedFlights();
updateEarlyOpenIndicator();
loadLeadershipData(); // Load leadership team data
await checkAndNotifyCancellations();
await checkAndNotifyComments();
await checkAndNotifyZoneEComments();
        
Object.keys(sectionStates).forEach(section => {
            const content = document.getElementById(`${section}-flights`);
            const toggle = document.getElementById(`${section}-toggle`);
            
            if (content && toggle) {
                if (sectionStates[section]) {
                    content.classList.add('expanded');
                    toggle.textContent = '';
                } else {
                    content.classList.remove('expanded');
                    toggle.textContent = '+';
                }
            }
        });
        
        window.scrollTo(0, scrollPosition);
        
        await checkAndNotifyCancellations();
        await checkAndNotifyComments();
        
        console.log(' Display updated with remote data');
    }, (error) => {
        console.error(' Firebase listener error:', error);
        firebaseListenerActive = false;
    });
    
    firebaseListenerActive = true;
    console.log(' Firebase realtime listener active');
  // Listen for force refresh signals via Firebase
// ============================================
// LISTEN FOR FORCE REFRESH SIGNALS VIA FIREBASE
// ============================================

// ============================================
// LISTEN FOR CLEAR DATA SIGNALS VIA FIREBASE (NEW)
// ============================================
if (firebaseInitialized) {
    const clearDataRef = firebase.database().ref(getFirebasePath('clear_data_signal'));
    
    clearDataRef.on('child_added', (snapshot) => {
        const clearData = snapshot.val();
        
        if (!clearData) return;
        
        // Only process if from a different session and recent (within 10 seconds)
        const now = Date.now();
        const signalAge = now - clearData.timestamp;
        
        if (clearData.fromSession !== sessionId && signalAge < 10000) {
            console.log(' RECEIVED CLEAR DATA SIGNAL (Firebase)');
            console.log(' Signal from session:', clearData.fromSession.substring(0, 20) + '...');
            console.log(' Clearing date:', clearData.date);
            console.log(' Signal age:', signalAge + 'ms');
            
            // Show clearing animation
            showClearingAnimation(clearData.date);
            
            // Stop all intervals
            if (heartbeatInterval) clearInterval(heartbeatInterval);
            if (multiTabCheckInterval) clearInterval(multiTabCheckInterval);
            stopUpdateIntervals();
            
            // Clean up Firebase listener
            if (firebaseDbRef && firebaseListenerActive) {
                firebaseDbRef.off('value');
                firebaseListenerActive = false;
            }
            
            // Clear heartbeat
            try {
                localStorage.removeItem(TAB_HEARTBEAT_KEY);
            } catch (e) {
                console.error('Error clearing heartbeat:', e);
            }
            
            // Clear all data locally
            console.log(' Clearing local data...');
            const keysToRemove = [];
            for (let i = 0; i < localStorage.length; i++) {
                const key = localStorage.key(i);
                if (!key) continue;
                
                if (key.includes(clearData.date) || 
                    key.includes('flight_tracker') ||
                    key.includes('comment_lock') ||
                    key.includes('last_local_update')) {
                    keysToRemove.push(key);
                }
            }
            
            keysToRemove.forEach(key => localStorage.removeItem(key));
            console.log(' Cleared', keysToRemove.length, 'localStorage keys');
            
            // Reload after 3 seconds
            setTimeout(() => {
                console.log(' Reloading after data clear...');
                location.reload(true);
            }, 3000);
        } else if (signalAge >= 10000) {
            console.log(' Ignoring old clear data signal (age: ' + signalAge + 'ms)');
        } else {
            console.log(' Ignoring clear signal from same session');
        }
    });
    
    console.log(' Firebase clear data listener active');
}

firebaseListenerActive = true;
console.log(' Firebase realtime listener active');

    // ============================================
    // LISTEN FOR CANCELLATION BROADCASTS VIA FIREBASE
    // ============================================
    // NOTE: Force refresh listener is now set up in setupForceRefreshListener()
    // which is called from initializeFirebaseRef() after flightDate is available
 // Listen for cancellation broadcasts via Firebase
if (firebaseInitialized) {
    const cancellationRef = firebase.database().ref(getFirebasePath('cancellation_broadcast'));
    
    console.log(' Setting up Firebase cancellation broadcast listener...');
    
    cancellationRef.on('child_added', (snapshot) => {
        const broadcast = snapshot.val();
        
        if (!broadcast) return;
        
        const now = Date.now();
        const broadcastAge = now - (broadcast.timestamp || 0);
        
        // Only process if from different session and recent (within 10 seconds)
        if (broadcast.fromSession !== sessionId && broadcastAge < 10000) {
            console.log(' RECEIVED CANCELLATION BROADCAST (Firebase)');
            console.log('   Flight:', broadcast.flightNumber, 'to', broadcast.destination);
            console.log('   Approved by:', broadcast.approvalInfo.approverName, '-', broadcast.approvalInfo.approverPosition);
            console.log('   Reason:', broadcast.approvalInfo.cancellationReason);
            
            // Find the flight
            const flight = flights.find(f => f.id === broadcast.flightId);
            if (flight && flight.manualStatus !== 'cancelled') {
                flight.manualStatus = 'cancelled';
flight.cancelledAt = broadcast.cancelledAt;
flight.cancelReason = broadcast.cancelReason;
flight.approverName = broadcast.approvalInfo.approverName;
flight.approverPosition = broadcast.approvalInfo.approverPosition;
flight.supervisorName = broadcast.approvalInfo.supervisorName;
                
                updateDisplay();
                
                // Show notification with approval info (includes reason)
                showCancellationNotificationWithApproval(flight, broadcast.approvalInfo);
            }
        } else if (broadcastAge >= 10000) {
            console.log(' Ignoring old cancellation broadcast (age: ' + broadcastAge + 'ms)');
        }
    });
        
        // Clean up old broadcasts every 30 seconds
        setInterval(() => {
            cancellationRef.once('value', (snapshot) => {
                const now = Date.now();
                snapshot.forEach((childSnapshot) => {
                    const data = childSnapshot.val();
                    if (data && data.timestamp && (now - data.timestamp) > 30000) {
                        childSnapshot.ref.remove();
                    }
                });
            });
        }, 30000);
        
        console.log(' Firebase cancellation broadcast listener active');
    }
}
     // ============================================
// LISTEN FOR COMMENT BROADCASTS VIA FIREBASE
// ============================================
if (firebaseInitialized) {
    const commentBroadcastRef = firebase.database().ref(getFirebasePath('comment_broadcast'));
    
    console.log(' Setting up Firebase comment broadcast listener...');
    
    commentBroadcastRef.on('child_added', (snapshot) => {
        const broadcast = snapshot.val();
        
        if (!broadcast) return;
        
        const now = Date.now();
        const broadcastAge = now - (broadcast.timestamp || 0);
        
        // Only process if from different session and recent
        if (broadcast.fromSession !== sessionId && broadcastAge < 10000) {
            console.log(' RECEIVED COMMENT BROADCAST (Firebase)');
            
            if (broadcast.action === 'comment_added') {
                // Check if comment already exists
                const exists = comments.find(c => c.id === broadcast.comment.id);
                if (!exists) {
                    comments.push(broadcast.comment);
                    renderComments();
                    
                    // Show notification
                    showCommentNotification(broadcast.comment);
                }
            } else if (broadcast.action === 'comment_edited') {
                // Find and update the comment
                const comment = comments.find(c => c.id === broadcast.commentId);
                if (comment) {
                    comment.text = broadcast.newText;
                    comment.editedAt = broadcast.editedAt;
                    comment.editedBy = broadcast.editedBy;
                    renderComments();
                    
                    // Show notification for edit
                    showCommentEditNotification(comment);
                }
            }
        } else if (broadcastAge >= 10000) {
            console.log(' Ignoring old comment broadcast (age: ' + broadcastAge + 'ms)');
        }
    });
    
    // Clean up old broadcasts every 30 seconds
    setInterval(() => {
        commentBroadcastRef.once('value', (snapshot) => {
            const now = Date.now();
            snapshot.forEach((childSnapshot) => {
                const data = childSnapshot.val();
                if (data && data.timestamp && (now - data.timestamp) > 30000) {
                    childSnapshot.ref.remove();
                }
            });
        });
    }, 30000);
    
    console.log(' Firebase comment broadcast listener active');
}  

// ============================================
// LISTEN FOR ZONE E COMMENT BROADCASTS VIA FIREBASE
// ============================================
if (firebaseInitialized) {
    const zoneECommentBroadcastRef = firebase.database().ref(getFirebasePath('zone_e_comment_broadcast'));
    
    console.log(' Setting up Firebase Zone E comment broadcast listener...');
    
    zoneECommentBroadcastRef.on('child_added', (snapshot) => {
        const broadcast = snapshot.val();
        
        if (!broadcast) return;
        
        const now = Date.now();
        const broadcastAge = now - (broadcast.timestamp || 0);
        
        // Only process if from different session and recent
        if (broadcast.fromSession !== sessionId && broadcastAge < 10000) {
            console.log(' RECEIVED ZONE E COMMENT BROADCAST (Firebase)');
            
            if (broadcast.action === 'zone_e_comment_added') {
                // Check if comment already exists
                const exists = zoneEComments.find(c => c.id === broadcast.comment.id);
                if (!exists) {
                    zoneEComments.push(broadcast.comment);
                    renderZoneEComments();
                    
                    // Show notification
                    showZoneECommentNotification(broadcast.comment);
                }
            } else if (broadcast.action === 'zone_e_comment_edited') {
                // Find and update the comment
                const comment = zoneEComments.find(c => c.id === broadcast.commentId);
                if (comment) {
                    comment.text = broadcast.newText;
                    comment.editedAt = broadcast.editedAt;
                    comment.editedBy = broadcast.editedBy;
                    renderZoneEComments();
                    
                    // Show notification for edit (using Zone E style)
                    showZoneECommentEditNotification(comment);
                }
            }
        } else if (broadcastAge >= 10000) {
            console.log(' Ignoring old Zone E comment broadcast (age: ' + broadcastAge + 'ms)');
        }
    });
    
    // Clean up old broadcasts every 30 seconds
    setInterval(() => {
        zoneECommentBroadcastRef.once('value', (snapshot) => {
            const now = Date.now();
            snapshot.forEach((childSnapshot) => {
                const data = childSnapshot.val();
                if (data && data.timestamp && (now - data.timestamp) > 30000) {
                    childSnapshot.ref.remove();
                }
            });
        });
    }, 30000);
    
    console.log(' Firebase Zone E comment broadcast listener active');
}

// Zone E Comment Edit Notification
function showZoneECommentEditNotification(comment) {
    console.log(' Showing Zone E comment edit notification:', comment.id);
    
    if (document.querySelector('.zone-e-notification-popup')) {
        console.log(' Notification already visible, skipping');
        return;
    }
    
    const notification = document.createElement('div');
    notification.className = 'zone-e-notification-popup';
    notification.id = `zone-e-edit-notif-${comment.id}`;
    
    const editedTime = new Date(comment.editedAt).toLocaleString('en-AU', {
        month: 'short',
        day: 'numeric',
        hour: '2-digit',
        minute: '2-digit',
        hour12: false
    });
    
    let previewText = comment.text;
    if (previewText.length > 150) {
        previewText = previewText.substring(0, 147) + '...';
    }
    
    notification.innerHTML = `
        <div class="zone-e-notification-header">
            <div class="zone-e-notification-icon"></div>
            <div class="zone-e-notification-title">Zone E Comment Edited</div>
        </div>
        
        <div class="zone-e-notification-body">
            <div class="zone-e-notification-time">Edited at ${editedTime}</div>
            <div class="zone-e-notification-preview">${previewText}</div>
        </div>
        
        <button class="zone-e-notification-acknowledge" onclick="acknowledgeZoneECommentEdit('${notification.id}')">
            " Acknowledge
        </button>
    `;
    
    document.body.appendChild(notification);
    
    setTimeout(() => {
        if (document.getElementById(notification.id)) {
            acknowledgeZoneECommentEdit(notification.id);
        }
    }, 5 * 60 * 1000);
    
    console.log(' Zone E comment edit notification displayed');
}

function acknowledgeZoneECommentEdit(notificationId) {
    console.log('" User acknowledged Zone E comment edit');
    
    const notification = document.getElementById(notificationId);
    if (notification) {
        notification.classList.add('fade-out');
        setTimeout(() => {
            notification.remove();
        }, 300);
    }
}

        function loadSyncData() {
            try {
                const data = localStorage.getItem(SYNC_KEY);
                if (data) {
                    const parsed = JSON.parse(data);
                    if (parsed.sessionId !== sessionId) {
                        flights = parsed.flights || [];
comments = parsed.comments || [];
zoneEComments = parsed.zoneEComments || [];
deletedFlights = parsed.deletedFlights || [];
earlyOpenMode = parsed.earlyOpenMode || null;
earlyOpenFlightNumber = parsed.earlyOpenFlightNumber || null;
earlyOpenHours = parsed.earlyOpenHours || 3;
                        if (flights.length > 0) {
                            updateDisplay();
                            renderComments();
                            renderZoneEComments();
                            renderDeletedFlights();
                        }
                    }
                }
            } catch (e) {
                console.error('Error loading sync data:', e);
            }
        }

        function checkCommentLock() {
            try {
                const lock = localStorage.getItem(COMMENT_LOCK_KEY);
                if (lock) {
                    const lockData = JSON.parse(lock);
                    if (Date.now() - lockData.timestamp < 30000 && lockData.sessionId !== sessionId) {
                        return true;
                    }
                }
            } catch (e) {
                console.error('Error checking comment lock:', e);
            }
            return false;
        }

        function setCommentLock(isLocked) {
            try {
                if (isLocked) {
                    localStorage.setItem(COMMENT_LOCK_KEY, JSON.stringify({
                        sessionId: sessionId,
                        timestamp: Date.now()
                    }));
                } else {
                    const lock = localStorage.getItem(COMMENT_LOCK_KEY);
                    if (lock) {
                        const lockData = JSON.parse(lock);
                        if (lockData.sessionId === sessionId) {
                            localStorage.removeItem(COMMENT_LOCK_KEY);
                        }
                    }
                }
            } catch (e) {
                console.error('Error setting comment lock:', e);
            }
        }

        function showEditingWarning() {
            closeAllDropdowns();
            
            const overlay = document.createElement('div');
            overlay.className = 'overlay';
            
            const modal = document.createElement('div');
            modal.className = 'editing-warning-modal';
            
            modal.innerHTML = `
                <div class="editing-warning-title"> Comments Being Edited</div>
                <div class="editing-warning-text">
                    Another user is currently editing the comments section. Please wait a moment and try again.
                </div>
                <button class="editing-warning-btn" onclick="closeEditingWarning()">OK</button>
            `;
            
            document.body.appendChild(overlay);
            document.body.appendChild(modal);
        }

        function closeEditingWarning() {
            const overlay = document.querySelector('.overlay');
            const modal = document.querySelector('.editing-warning-modal');
            if (overlay) overlay.remove();
            if (modal) modal.remove();
        }

   window.addEventListener('storage', function(e) {
    if (e.key === SYNC_KEY) {
        loadSyncData();
    }
});
 
        function compareDates(date1, date2) {
            return date1.getFullYear() === date2.getFullYear() &&
                   date1.getMonth() === date2.getMonth() &&
                   date1.getDate() === date2.getDate();
        }

        function showDateMismatchModal(csvDate, today) {
            const overlay = document.createElement('div');
            overlay.className = 'overlay';
            
            const modal = document.createElement('div');
            modal.className = 'date-mismatch-modal';
            
            // Check if this is stale data (file from previous day being opened)
            const daysDifference = Math.floor((today - csvDate) / (1000 * 60 * 60 * 24));
            const isStaleData = daysDifference >= 1;
            
            if (isStaleData) {
                // BLOCKING MODAL - File is from a previous day
                modal.innerHTML = `
                    <div class="date-mismatch-title" style="background:#dc2626;"> ACCESS DENIED - Stale Data</div>
                    <div class="date-mismatch-text" style="text-align:center;">
                        <div style="font-size:60px;margin:20px 0;"></div>
                        <p style="font-size:16px;color:#dc2626;font-weight:bold;margin-bottom:15px;">This file contains outdated data and cannot be used.</p>
                        <div style="background:#fee2e2;padding:15px;border-radius:8px;margin:15px 0;text-align:left;">
                            <p><strong>File Date:</strong> ${csvDate.toLocaleDateString('en-AU', { weekday: 'long', day: 'numeric', month: 'long', year: 'numeric' })}</p>
                            <p><strong>Today's Date:</strong> ${today.toLocaleDateString('en-AU', { weekday: 'long', day: 'numeric', month: 'long', year: 'numeric' })}</p>
                        </div>
                        <p style="font-size:14px;color:#6b7280;margin-top:15px;">Please close this file and open today's Flight Tracker file.</p>
                    </div>
                    <div class="date-mismatch-actions" style="justify-content:center;">
                        <button class="date-mismatch-btn cancel" onclick="forceCloseStaleFile()" style="background:#dc2626;color:white;padding:15px 40px;font-size:16px;">
                             Close This File
                        </button>
                    </div>
                `;
            } else {
                // Regular mismatch (same day, different time zone or minor issue)
                modal.innerHTML = `
                    <div class="date-mismatch-title"> Date Mismatch Warning</div>
                    <div class="date-mismatch-text">
                        <strong>Please note:</strong> The date in the CSV file does not match today's date.
                        <strong>CSV Date:</strong> ${csvDate.toLocaleDateString('en-AU', { weekday: 'long', day: 'numeric', month: 'long', year: 'numeric' })}
                        <strong>Today's Date:</strong> ${today.toLocaleDateString('en-AU', { weekday: 'long', day: 'numeric', month: 'long', year: 'numeric' })}
                        Do you wish to continue?
                    </div>
                    <div class="date-mismatch-actions">
                        <button class="date-mismatch-btn cancel" onclick="cancelDateMismatch()">Cancel</button>
                        <button class="date-mismatch-btn continue" onclick="acceptDateMismatch()">Continue Anyway</button>
                    </div>
                `;
            }
            
            document.body.appendChild(overlay);
            document.body.appendChild(modal);
        }

        function forceCloseStaleFile() {
            // Clear everything and show a permanent block
            document.body.innerHTML = `
                <div style="min-height:100vh;display:flex;flex-direction:column;justify-content:center;align-items:center;background:linear-gradient(135deg,#1a1a2e 0%,#16213e 100%);color:white;text-align:center;padding:40px;">
                    <div style="font-size:80px;margin-bottom:20px;"></div>
                    <h1 style="font-size:28px;margin-bottom:15px;color:#dc2626;">File Closed - Stale Data</h1>
                    <p style="font-size:16px;color:#9ca3af;max-width:400px;margin-bottom:30px;">
                        This file contains data from a previous date and has been closed for safety.
                    </p>
                    <p style="font-size:14px;color:#6b7280;margin-bottom:30px;">
                        Please open today's Flight Tracker file to continue.
                    </p>
                    <button onclick="window.close();location.reload();" style="background:#FA5115;color:white;border:none;padding:15px 30px;border-radius:8px;font-size:16px;cursor:pointer;">
                        Close Window
                    </button>
                </div>
            `;
        }

        function cancelDateMismatch() {
            const overlay = document.querySelector('.overlay');
            const modal = document.querySelector('.date-mismatch-modal');
            if (overlay) overlay.remove();
            if (modal) modal.remove();
            
            flights = [];
            flightDate = null;
            document.getElementById('loading').style.display = 'block';
            document.getElementById('comments-section').style.display = 'none';
            document.getElementById('date-validation-badge').style.display = 'none';
            document.getElementById('flight-date-badge').style.display = 'none';
        }

        function acceptDateMismatch() {
            const overlay = document.querySelector('.overlay');
            const modal = document.querySelector('.date-mismatch-modal');
            if (overlay) overlay.remove();
            if (modal) modal.remove();
            
            dateValidationDismissed = true;
            updateDateValidationBadge();
            updateDisplay();
            initializeBusynessTracker(); // Initialize busyness tracker
            
            (async function() {
                await debouncedSync();
                setupFirebaseListener();
            })();
        }

      function updateDateValidationBadge() {
    const badge = document.getElementById('date-validation-badge');
    const today = new Date();
    today.setHours(0, 0, 0, 0);
    
    if (!flightDate) {
        badge.style.display = 'none';
        return;
    }
    
    const csvDateOnly = new Date(flightDate);
    csvDateOnly.setHours(0, 0, 0, 0);
    
   if (compareDates(csvDateOnly, today)) {
    //  Green tick for today
    badge.textContent = '';
    badge.className = 'date-validation-badge success-tick';
    badge.style.display = 'flex';
} else if (csvDateOnly < today) {
    //  Simple text for past dates (no badge shown)
    badge.style.display = 'none';
} else {
    //  Simple warning for future dates (keep original orange)
    badge.textContent = ' CSV date does not match today';
    badge.className = 'date-validation-badge warning';
    badge.style.display = 'block';
}
}

        document.getElementById('csv-upload').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (!file) return;

            Papa.parse(file, {
                complete: function(results) {processCSV(results.data);
            },
            skipEmptyLines: true
        });
    });

    function extractDateAndTime(dateTimeString) {
        const cleaned = dateTimeString.trim();
        
        const hasAMPM = /AM|PM/i.test(cleaned);
        
        if (hasAMPM) {
            const parts = cleaned.split(' ');
            if (parts.length < 3) return null;
            
            const datePart = parts[0];
            const timePart = parts[1];
            const meridiem = parts[2].toUpperCase();
            
            const dateComponents = datePart.split('/');
            if (dateComponents.length !== 3) return null;
            
            const day = parseInt(dateComponents[0], 10);
            const month = parseInt(dateComponents[1], 10);
            let year = parseInt(dateComponents[2], 10);
            
            if (year < 100) year = 2000 + year;
            
            const timeComponents = timePart.split(':');
            if (timeComponents.length < 2) return null;
            
            let hours = parseInt(timeComponents[0], 10);
            const minutes = parseInt(timeComponents[1], 10);
            
            if (meridiem === 'PM' && hours !== 12) {
                hours += 12;
            } else if (meridiem === 'AM' && hours === 12) {
                hours = 0;
            }
            
            if (isNaN(hours) || isNaN(minutes)) return null;
            if (hours < 0 || hours > 23) return null;
            if (minutes < 0 || minutes > 59) return null;
            
            const timeString = String(hours).padStart(2, '0') + ':' + String(minutes).padStart(2, '0');
            
            return {
                date: new Date(year, month - 1, day),
                time: timeString
            };
        } else {
            const parts = cleaned.split(' ');
            if (parts.length < 2) return null;
            
            const datePart = parts[0];
            const timePart = parts[1];
            
            const dateComponents = datePart.split('/');
            if (dateComponents.length !== 3) return null;
            
            const day = parseInt(dateComponents[0], 10);
            const month = parseInt(dateComponents[1], 10);
            let year = parseInt(dateComponents[2], 10);
            
            if (year < 100) year = 2000 + year;
            
            const timeComponents = timePart.split(':');
            if (timeComponents.length < 2) return null;
            
            const hours = parseInt(timeComponents[0], 10);
            const minutes = parseInt(timeComponents[1], 10);
            
            if (isNaN(hours) || isNaN(minutes)) return null;
            if (hours < 0 || hours > 23) return null;
            if (minutes < 0 || minutes > 59) return null;
            
            const timeString = String(hours).padStart(2, '0') + ':' + String(minutes).padStart(2, '0');
            
            return {
                date: new Date(year, month - 1, day),
                time: timeString
            };
        }
    }

function processCSV(data) {
    console.log(' ===== PROCESS CSV STARTED =====');
    console.log(' Raw data rows:', data.length);
    
    flights = [];
    flightDate = null;
    dateValidationDismissed = false;
    
    console.log(' Reset: flights, flightDate, dateValidationDismissed');
    
    for (let i = 1; i < data.length; i++) {
        const row = data[i];
        
        const flightNumber = row[14] ? row[14].trim() : '';
        if (!flightNumber) continue;
        
        const destination = row[15] ? row[15].trim().toUpperCase() : '';
        if (!destination) continue;
        
        // Filter international destinations
        if (INTERNATIONAL_DESTINATIONS.includes(destination.toUpperCase())) {
            console.log(`Filtered out international flight to ${destination}`);
            continue;
        }
        
        const columnU = row[20] ? row[20].trim() : '';
        if (!columnU) continue;
        
        const departureInfo = extractDateAndTime(columnU);
        if (!departureInfo) {
            console.log('Failed to parse columnU:', columnU);
            continue;
        }

        const hourCheck = parseInt(departureInfo.time.split(':')[0], 10);
        if (hourCheck >= 12) {
            console.log('=== AFTERNOON FLIGHT ===');
            console.log('Flight:', flightNumber, 'Destination:', destination);
            console.log('Column U raw:', columnU);
            console.log('Extracted time:', departureInfo.time);
            console.log('Hour parsed as:', hourCheck);
            console.log('========================');
        }
        
        if (!flightDate) {
            flightDate = departureInfo.date;
            console.log(' Flight date set to:', flightDate);
            
            const dateBadge = document.getElementById('flight-date-badge');
            dateBadge.textContent = `Flight Schedule: ${flightDate.toLocaleDateString('en-AU', { 
                weekday: 'long', 
                year: 'numeric', 
                month: 'long', 
                day: 'numeric' 
            })}`;
            dateBadge.style.display = 'inline-block';
            console.log(' Date badge updated');
            
            // Setup busyness listeners now that we have the flight date
            reinitializeBusynessListeners();
        }
        
        const columnV = row[21] ? row[21].trim() : '';
        const delayedInfo = columnV ? extractDateAndTime(columnV) : null;
        
        let actualDepartureTime = departureInfo.time;
        let isDelayed = false;
        
        if (delayedInfo) {
            const diffMinutes = calculateTimeDifference(departureInfo.time, delayedInfo.time);
            if (diffMinutes > 45) {
                actualDepartureTime = delayedInfo.time;
                isDelayed = true;
            }
        }
        
        const inboundFlight = row[0] ? row[0].trim() : '';
        const isTurnaround = inboundFlight !== '';
        
        const uniqueId = Date.now() + Math.floor(Math.random() * 10000) + i;

        // Get passenger count from column R (index 17)
        const paxValue = row[17] ? parseInt(row[17].trim()) || 0 : 0;
        console.log(' Flight', flightNumber, 'Pax:', paxValue, 'Raw:', row[17]);
        
        flights.push({
            id: uniqueId,
            flightNumber,
            destination,
            departureTime: actualDepartureTime,
            originalDepartureTime: departureInfo.time,
            isDelayed,
            isTurnaround,
            inboundFlight,
            pax: paxValue,
            manualStatus: null,
            cancelReason: null,
            extensionStartTime: null,
            extensionDuration: null,
            isAdhoc: false
        });
    }
    
    console.log(' Total flights parsed:', flights.length);
    
    if (flights.length === 0) {
        console.error(' NO FLIGHTS PARSED!');
        alert('No flights found in CSV. Please check:\n\n1. CSV has data in rows\n2. Flight numbers in column O (index 14)\n3. Destinations in column P (index 15)\n4. Departure times in column U (index 20)');
        return;
    }
    
// ============================================
    // DATE LOGGING (No localStorage tracking needed)
    // ============================================
    console.log(' Processing flight date:', getFlightDateKey());
    
    // Firebase handles per-date data via getFirebasePath()
    // No need to track dates in localStorage
    
    // Show buttons
    console.log(' Showing UI buttons...');
    document.getElementById('save-html-btn').style.display = 'block';
    document.getElementById('add-flight-btn').style.display = 'block';
    document.getElementById('search-container').style.display = 'block';
    document.getElementById('reset-btn').style.display = 'block';
    document.getElementById('early-open-btn').style.display = 'block';
    document.getElementById('add-comment-main-btn').style.display = 'block';
    document.getElementById('refresh-all-btn').style.display = 'block';
    
    console.log(' Buttons shown');
    
    // Date validation
    console.log(' Checking date validation...');
    const today = new Date();
    today.setHours(0, 0, 0, 0);
    const csvDateOnly = new Date(flightDate);
    csvDateOnly.setHours(0, 0, 0, 0);
    
    console.log('   Today:', today.toDateString());
    console.log('   CSV date:', csvDateOnly.toDateString());
    console.log('   Match?', csvDateOnly.getTime() === today.getTime());
    
    // Initialize Firebase
    console.log(' Initializing Firebase...');
    initializeFirebaseRef();
    
    // Apply date-based status for past/future dates
   // Apply date-based status for past/future dates
if (csvDateOnly < today) {
    console.log(' Past date - auto-closing ALL flights and making uneditable');
    flights.forEach(flight => {
        flight.manualStatus = 'closed'; // Force all to closed
        flight.isReadOnly = true; // Mark as read-only
    });
    
    // Show alert that this is past date
    alert(' PAST DATE LOADED\n\nThis data is from a previous date. All flights are closed and cannot be edited.\n\nYou can view the data but cannot make changes.');
    
} else if (csvDateOnly > today) {
    console.log(' Future date - flights will show calculated status when opened on correct date');
    flights.forEach(flight => {
        flight.isReadOnly = false; // Future dates are editable
    });
} else {
    // Today's date - normal behavior
    flights.forEach(flight => {
        flight.isReadOnly = false; // Today is always editable
    });
}
    
    // Show date mismatch or proceed
    if (!compareDates(csvDateOnly, today)) {
        console.log(' Date mismatch - showing modal');
        showDateMismatchModal(flightDate, today);
    } else {
        console.log(' Date matches - proceeding');
        dateValidationDismissed = true;
updateDateValidationBadge();
updateDisplay();
startUpdateIntervals();
startStaleDateMonitoring(); // ADD THIS LINE
initializeBusynessTracker(); // Initialize busyness tracker
    }
    
    console.log(' Starting sync...');
    (async function() {
        await syncData();
        setupFirebaseListener();
        console.log(' Sync complete');
    })();
    
    console.log(' ===== PROCESS CSV COMPLETED =====');
}
    function calculateTimeDifference(time1, time2) {
        const [h1, m1] = time1.split(':').map(Number);
        const [h2, m2] = time2.split(':').map(Number);
        
        const minutes1 = h1 * 60 + m1;
        const minutes2 = h2 * 60 + m2;
        
        return Math.abs(minutes2 - minutes1);
    }

    function calculateTimeRemaining(flight) {
    if (flight.manualStatus === 'cancelled') {
    // Calculate the original close time so departure time is still visible
    const today = new Date();
    let timeForCheckIn;
    if (flight.isDelayed) {
        timeForCheckIn = flight.departureTime;
    } else if (flight.originalDepartureTime) {
        timeForCheckIn = flight.originalDepartureTime;
    } else {
        timeForCheckIn = flight.departureTime;
    }
    
    const [hours, minutes] = timeForCheckIn.split(':').map(Number);
    const departure = new Date(today.getFullYear(), today.getMonth(), today.getDate(), hours, minutes);
    const checkinClose = new Date(departure.getTime() - 40 * 60000);
    
    return {
        status: 'cancelled',
        display: 'CANCELLED',
        closeTime: checkinClose, // Keep this so departure time displays
        totalMinutes: -1,
        percentage: 0
    };
}

        // Handle extended status
        // Handle extended status - MUST come before other checks
// Handle extended status - MUST come before other checks
// Handle extended status - SIMPLE VERSION (like "open")
if (flight.manualStatus === 'extended') {
    const today = new Date();
    
    // Get the correct time to use for calculations
    let timeForCheckIn;
    if (flight.isDelayed) {
        timeForCheckIn = flight.departureTime;
    } else if (flight.originalDepartureTime) {
        timeForCheckIn = flight.originalDepartureTime;
    } else {
        timeForCheckIn = flight.departureTime;
    }
    
    const [hours, minutes] = timeForCheckIn.split(':').map(Number);
    const departure = new Date(today.getFullYear(), today.getMonth(), today.getDate(), hours, minutes);
    const originalCheckinClose = new Date(departure.getTime() - 40 * 60000);
    
    // Initialize extension start time if not set
    if (!flight.extensionStartTime) {
        flight.extensionStartTime = Date.now();
        console.log(' Extension activated for', flight.flightNumber);
    }
    
    const now = Date.now();
    const timeSinceExtension = now - flight.extensionStartTime;
    const extensionMinutes = Math.floor(timeSinceExtension / 60000);
    
    // Auto-close after 45 minutes of extension
    if (extensionMinutes >= 45) {
        flight.manualStatus = 'closed';
        console.log(' Auto-closing', flight.flightNumber, 'after 45 minutes');
        debouncedSync();
        return {
            status: 'closed',
            display: 'CLOSED',
            closeTime: originalCheckinClose,
            totalMinutes: -1,
            percentage: 0
        };
    }
    
    // Simple display - just show "EXTENDED" like "OPEN"
    return {
        status: 'extended',
        display: 'EXTENDED',
        closeTime: originalCheckinClose,
        totalMinutes: -1,
        percentage: 100
    };
}

        const now = new Date();

        let timeForCheckIn;
        if (flight.isDelayed) {
            timeForCheckIn = flight.departureTime;
        } else if (flight.originalDepartureTime) {
            timeForCheckIn = flight.originalDepartureTime;
        } else {
            timeForCheckIn = flight.departureTime;
        }

        const [hours, minutes] = timeForCheckIn.split(':').map(Number);
        
        // ROBUST FIX: Determine the correct base date for flight time calculations
        // The key insight: we want to use the FLIGHT DATE (from CSV) not today's date
        // This ensures flights show correct status when file is opened on the matching day
        let baseDateForFlight;
        
        if (flightDate && flightDate instanceof Date && !isNaN(flightDate.getTime())) {
            // flightDate is a valid Date object - use it
            baseDateForFlight = flightDate;
        } else if (flightDate && typeof flightDate === 'string') {
            // flightDate is a string (from JSON) - parse it
            baseDateForFlight = new Date(flightDate);
        } else {
            // No flightDate available - fall back to today
            baseDateForFlight = now;
        }
        
        // Create departure time using the flight date's year/month/day but with the flight's time
        const departure = new Date(
            baseDateForFlight.getFullYear(), 
            baseDateForFlight.getMonth(), 
            baseDateForFlight.getDate(), 
            hours, 
            minutes
        );

        const checkinClose = new Date(departure.getTime() - 40 * 60000);
        const diffToClose = checkinClose - now;
        const diffToDeparture = departure - now;
        
        if (diffToClose < 0 && !flight.manualStatus) {
            return { 
                status: 'closed', 
                display: 'CLOSED', 
                closeTime: checkinClose, 
                totalMinutes: -1,
                percentage: 0
            };
        }
        
      const minutesToDeparture = Math.floor(diffToDeparture / 60000);

// Only apply "not yet open" if check-in hasn't started yet AND flight is more than 3 hours away
let shouldOpenEarly = false;

if (earlyOpenMode === 'flight' && earlyOpenFlightNumber) {
    const targetFlight = flights.find(f => f.flightNumber.toUpperCase() === earlyOpenFlightNumber.toUpperCase());
    if (targetFlight) {
        const [targetH, targetM] = targetFlight.departureTime.split(':').map(Number);
        const [currentH, currentM] = (flight.isDelayed ? flight.departureTime : flight.originalDepartureTime || flight.departureTime).split(':').map(Number);
        
        const targetMinutes = targetH * 60 + targetM;
        const currentMinutes = currentH * 60 + currentM;
        
        if (currentMinutes <= targetMinutes) {
            shouldOpenEarly = true;
        }
    }
} else if (earlyOpenMode === 'hours') {
    const earlyOpenMinutes = earlyOpenHours * 60;
    if (minutesToDeparture <= earlyOpenMinutes) {
        shouldOpenEarly = true;
    }
}

const openThreshold = shouldOpenEarly ? (earlyOpenMode === 'hours' ? earlyOpenHours * 60 : 999999) : 180;

// CRITICAL FIX: Only mark as "not yet open" if BOTH conditions are true:
// 1. Check-in close time is still in the future (diffToClose > 0)
// 2. Departure is beyond the threshold
if (diffToClose > 0 && minutesToDeparture > openThreshold && !flight.manualStatus) {
    return {
        status: 'not-open',
        display: 'NOT OPEN',
        closeTime: checkinClose,
        totalMinutes: Math.floor(diffToClose / 60000),
        percentage: 0
    };
}
        const totalMinutes = Math.floor(diffToClose / 60000);
        
  if (flight.manualStatus === 'urgent' || flight.manualStatus === 'closing' || totalMinutes <= 30) {
    const m = totalMinutes;
    const s = Math.floor((diffToClose % 60000) / 1000);
    
    let status = 'open';
    if (flight.manualStatus) {
        status = flight.manualStatus;
    } else {
        status = totalMinutes <= 5 ? 'critical' : (totalMinutes <= 15 ? 'urgent' : 'closing');
    }
    
    let displayTime = `${m}:${s.toString().padStart(2, '0')}`;
            
            if (totalMinutes <= 15 || flight.manualStatus === 'urgent' || flight.manualStatus === 'closing') {
                displayTime = `${m}:${s.toString().padStart(2, '0')}`;
            }
            
            const percentage = Math.min((totalMinutes / 30) * 100, 100);
            
            return {
                status,
                display: displayTime,
                closeTime: checkinClose,
                totalMinutes,
                percentage
            };
        }
        
        return {
            status: 'open',
            display: 'OPEN',
            closeTime: checkinClose,
            totalMinutes,
            percentage: 100
        };
    }

 function makeEditable(element, flight, field, listeners) {
    element.classList.add('editable');
    
    const clickHandler = function(e) {
    e.stopPropagation();
    
    //  BLOCK editing if flight is read-only (past date)
    if (flight.isReadOnly) {
        alert(' Cannot Edit Past Date\n\nThis flight is from a previous date and cannot be modified.');
        return; // Exit - don't allow editing
    }
    
    // Prevent editing if already editing somewhere else
    if (isEditingField) {
        return;
    }
        
        isEditingField = true;
        element.contentEditable = true;
        element.focus();
        
        const range = document.createRange();
        range.selectNodeContents(element);
        const selection = window.getSelection();
        selection.removeAllRanges();
        selection.addRange(range);
        
        console.log(' Started editing', field, 'for flight', flight.flightNumber);
    };
    
    const blurHandler = function() {
        const newValue = element.textContent.trim();
        const oldValue = flight[field];
        
        console.log(' Saving edit:', field, 'from', oldValue, 'to', newValue);
        
        if (newValue && newValue !== oldValue) {
            if (field === 'departureTime') {
                const timeRegex = /^([0-1]?[0-9]|2[0-3]):([0-5][0-9])$/;
                if (!timeRegex.test(newValue)) {
                    alert('Invalid time format. Please use HH:MM (e.g., 09:30)');
                    element.textContent = oldValue;
                    element.contentEditable = false;
                    isEditingField = false;
                    return;
                }
                
                if (!flight.originalDepartureTime) {
                    flight.originalDepartureTime = flight.departureTime;
                }
                
                const diffMinutes = calculateTimeDifference(flight.originalDepartureTime, newValue);
                
                if (diffMinutes > 45) {
                    flight.departureTime = newValue;
                    flight.isDelayed = true;
                    console.log(' Flight marked as delayed');
                } else {
                    flight.departureTime = newValue;
                    flight.isDelayed = false;
                    flight.originalDepartureTime = newValue;
                    console.log(' Flight time updated (not delayed)');
                }
                
                // CRITICAL: If flight is extended, update extension start time
                if (flight.manualStatus === 'extended') {
                    const today = new Date();
                    const [hours, minutes] = newValue.split(':').map(Number);
                    const departure = new Date(today.getFullYear(), today.getMonth(), today.getDate(), hours, minutes);
                    const checkinClose = new Date(departure.getTime() - 40 * 60000);
                    flight.extensionStartTime = checkinClose.getTime();
                    console.log(' Updated extension start time due to departure change');
                }
            } else {
                flight[field] = newValue;
                console.log(' Updated', field, 'to', newValue);
            }
            
            // Sync and update immediately
            debouncedSync();
            
            // Force immediate display update
            setTimeout(() => {
                updateDisplay();
            }, 100);
        } else {
            // Restore original value if no change
            element.textContent = oldValue;
        }
        
        element.contentEditable = false;
        isEditingField = false;
        console.log(' Finished editing', field);
    };
    
    const keydownHandler = function(e) {
        if (e.key === 'Enter') {
            e.preventDefault();
            element.blur();
        }
        if (e.key === 'Escape') {
            element.textContent = flight[field];
            element.blur();
        }
    };
    
    element.addEventListener('click', clickHandler);
    element.addEventListener('blur', blurHandler);
    element.addEventListener('keydown', keydownHandler);
    
    // Track all listeners if array provided
    if (listeners) {
        listeners.push({ element, event: 'click', handler: clickHandler });
        listeners.push({ element, event: 'blur', handler: blurHandler });
        listeners.push({ element, event: 'keydown', handler: keydownHandler });
    }
}

    function closeAllDropdowns() {
        if (activeDropdown) {
            activeDropdown.style.display = 'none';
            activeDropdown = null;
            
            const criticalCards = document.querySelectorAll('.flight-card.critical');
            criticalCards.forEach(c => c.classList.add('pulsing'));
        }
        const overlay = document.querySelector('.overlay');
        if (overlay) overlay.remove();
    }

    function deleteFlight(flightId) {
    const flight = flights.find(f => f.id === flightId);
    if (!flight) return;
    
    //  BLOCK deletion for past dates
    if (flight.isReadOnly) {
        alert(' Cannot Delete Past Date\n\nFlights from previous dates cannot be deleted.');
        return;
    }
    
    if (confirm(`Are you sure you want to delete flight ${flight.flightNumber} to ${flight.destination}?`)) {
            deletedFlights.push({
                ...flight,
                deletedAt: new Date()
            });
            
            flights = flights.filter(f => f.id !== flightId);
    
      // ADD THIS - Clear cache for deleted flight
    debouncedSync();
    updateDisplay();
    renderDeletedFlights();
        }
    }

    function showRestoreModal(deletedFlight) {
        closeAllDropdowns();
        
        const overlay = document.createElement('div');
        overlay.className = 'overlay';
        
        const modal = document.createElement('div');
        modal.className = 'restore-modal';
        
        modal.innerHTML = `
            <div class="restore-modal-title">Restore Flight ${deletedFlight.flightNumber}</div>
            <div style="margin-bottom: 1rem; text-align: center; color: #6b7280;">Select status to restore with:</div>
            <div class="restore-option" onclick="restoreFlight(${deletedFlight.id}, null)"> Automatic (Based on Time)</div>
            <div class="restore-option" onclick="restoreFlight(${deletedFlight.id}, 'open')"> Check-in Open</div>
            <div class="restore-option" onclick="restoreFlight(${deletedFlight.id}, 'closing')"> Closing Soon</div>
            <div class="restore-option" onclick="restoreFlight(${deletedFlight.id}, 'urgent')"> Urgent Closing</div>
            <div class="restore-option" onclick="restoreFlight(${deletedFlight.id}, 'closed')"> Closed</div>
            <div class="restore-option" onclick="restoreFlight(${deletedFlight.id}, 'cancelled')"> Cancelled</div>
        `;
        
        overlay.onclick = function() {
            modal.remove();
            overlay.remove();
        };
        
        document.body.appendChild(overlay);
        document.body.appendChild(modal);
    }

    async function restoreFlight(flightId, status) {
    const deletedFlight = deletedFlights.find(f => f.id === flightId);
    if (!deletedFlight) return;
    
    const { deletedAt, ...restoredFlight } = deletedFlight;
    
    // CRITICAL: Completely reset flight state
    restoredFlight.manualStatus = status;
    restoredFlight.extensionStartTime = null;
    restoredFlight.extensionDuration = null;
    
    // If restoring to extended, set it up properly
    if (status === 'extended') {
        const today = new Date();
        const [hours, minutes] = (restoredFlight.isDelayed ? restoredFlight.departureTime : restoredFlight.originalDepartureTime || restoredFlight.departureTime).split(':').map(Number);
        const departure = new Date(today.getFullYear(), today.getMonth(), today.getDate(), hours, minutes);
        const checkinClose = new Date(departure.getTime() - 40 * 60000);
        restoredFlight.extensionStartTime = checkinClose.getTime();
    }
        
        if (status === 'cancelled') {
            const overlay = document.querySelector('.overlay');
            const modal = document.querySelector('.restore-modal');
            if (overlay) overlay.remove();
            if (modal) modal.remove();
            
flights.push(restoredFlight);
            deletedFlights = deletedFlights.filter(f => f.id !== flightId);
            
              // ADD THIS - Clear cache for restored flight
            setTimeout(() => showCancelReasonDropdown(restoredFlight), 100);
} else {
    flights.push(restoredFlight);
    deletedFlights = deletedFlights.filter(f => f.id !== flightId);
    
    const overlay = document.querySelector('.overlay');
    const modal = document.querySelector('.restore-modal');
    if (overlay) overlay.remove();
    if (modal) modal.remove();
}

// CRITICAL: Clear cache and force sync
 
await syncData();

// Broadcast to other devices
broadcastRefreshSignal();

// Wait for sync to complete
await new Promise(resolve => setTimeout(resolve, 500));

updateDisplay();
renderDeletedFlights();

console.log(' Flight restored and synced:', restoredFlight.flightNumber);
    }

    function permanentlyDeleteFlight(flightId) {
        const deletedFlight = deletedFlights.find(f => f.id === flightId);
        if (!deletedFlight) return;
        
        if (confirm(`Permanently delete flight ${deletedFlight.flightNumber}? This cannot be undone!`)) {
            deletedFlights = deletedFlights.filter(f => f.id !== flightId);
            debouncedSync();
            renderDeletedFlights();
        }
    }

    function clearAllDeletedFlights() {
        if (deletedFlights.length === 0) return;
        
        if (confirm(`Permanently delete all ${deletedFlights.length} deleted flights? This cannot be undone!`)) {
            deletedFlights = [];
            debouncedSync();
            renderDeletedFlights();
        }
    }

    function renderDeletedFlights() {
        const section = document.getElementById('deleted-flights-section');
        const container = document.getElementById('deleted-flights-container');
        const countBadge = document.getElementById('deleted-count');
        
        if (deletedFlights.length === 0) {
            section.style.display = 'none';
            return;
        }
        
        section.style.display = 'block';
        countBadge.textContent = deletedFlights.length;
        container.innerHTML = '';
        
        const sorted = [...deletedFlights].sort((a, b) => b.deletedAt - a.deletedAt);
        
        sorted.forEach(flight => {
            const card = document.createElement('div');
            card.className = 'deleted-flight-card';
            
            const deletedTime = new Date(flight.deletedAt).toLocaleString('en-AU', {
                month: 'short',
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit',
                hour12: false
            });
            
            card.innerHTML = `
                <div class="deleted-flight-info">
                    <div class="deleted-flight-number">${flight.flightNumber}</div>
                    <div class="deleted-flight-details">to ${flight.destination}  Departure: ${flight.departureTime}</div>
                    <div class="deleted-flight-timestamp">Deleted: ${deletedTime}</div>
                </div>
                <button class="restore-btn" onclick="showRestoreModal(deletedFlights.find(f => f.id === ${flight.id}))">
                     Restore
                </button>
                <button class="permanent-delete-btn" onclick="permanentlyDeleteFlight(${flight.id})">
                     Delete Forever
                </button>
            `;
            
            container.appendChild(card);
        });
    }


    // Store event listeners so we can clean them up
// Store event listeners so we can clean them up
const flightCardListeners = new WeakMap();

function cleanupFlightCard(card) {
    const listeners = flightCardListeners.get(card);
    if (listeners) {
        listeners.forEach(({ element, event, handler }) => {
            element.removeEventListener(event, handler);
        });
        flightCardListeners.delete(card);
    }
}
 function renderFlight(flight) {
    const timeInfo = calculateTimeRemaining(flight);
    const card = document.createElement('div');
    
    const listeners = [];
    
    let effectiveStatus = flight.manualStatus || timeInfo.status;

    let sectionClass = '';
    if (effectiveStatus === 'critical' || effectiveStatus === 'urgent' || effectiveStatus === 'closing') {
        sectionClass = 'urgent-section-card';
    } else if (effectiveStatus === 'open') {
        sectionClass = 'active-section-card';
    } else if (effectiveStatus === 'not-open') {
        sectionClass = 'notopen-section-card';
    } else if (effectiveStatus === 'closed') {
        sectionClass = 'closed-section-card';
    } else if (effectiveStatus === 'cancelled') {
        sectionClass = 'cancelled-section-card';
    } else if (effectiveStatus === 'extended' || effectiveStatus.startsWith('extended-')) {
        sectionClass = 'active-section-card'; // Use active styling for extended
    }

    card.className = `flight-card ${effectiveStatus} ${sectionClass}`;
    
    let statusText = 'CHECK-IN OPEN';
    let statusClass = 'status-open';
    let centerContent = '';
    
    if (effectiveStatus === 'cancelled') {
    statusText = ' CANCELLED';
    statusClass = 'status-cancelled';
    
    // Build approval info display
    let approvalInfoHtml = '';
    if (flight.approverName) {
   approvalInfoHtml = `
    <div style="margin-top: 1rem; padding-top: 1rem; border-top: 2px solid rgba(220, 38, 38, 0.2); color: #000345; font-size: 1rem; line-height: 1.6; text-align: center;">
        <div style="margin-bottom: 0.25rem;"><strong>Actioned By:</strong> ${flight.approverName}</div>
        <div style="margin-bottom: 0.25rem;"><strong>Position:</strong> ${flight.approverPosition}</div>
        ${flight.supervisorName ? `<div style="margin-bottom: 0.25rem;"><strong>Approved By:</strong> ${flight.supervisorName}</div>` : ''}
        <div style="margin-bottom: 0.25rem;"><strong>Actioned At:</strong> ${new Date(flight.cancelledAt).toLocaleString('en-AU', {
                    year: 'numeric',
                    month: 'short',
                    day: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit',
                    second: '2-digit',
                    hour12: false
                })}</div>
            </div>
            </div>
        `;
    }
    
    centerContent = `
        <div class="timer-label">CANCELLATION REASON</div>
        <div class="cancel-reason-display">${flight.cancelReason || 'Not specified'}</div>
        ${approvalInfoHtml}
    `;
} else if (effectiveStatus === 'critical') {
        statusText = ' CRITICAL!';
        statusClass = 'status-urgent';
        centerContent = `
            <div class="timer-label">CHECK-IN CLOSES IN</div>
            <div class="timer" data-flight-id="${flight.id}">${timeInfo.display}</div>
            <div class="progress-bar">
                <div class="progress-fill urgent" data-flight-id="${flight.id}" style="width: ${timeInfo.percentage}%"></div>
            </div>
        `;
        // Add pulsing for critical
        if (!activeDropdown) {
            setTimeout(() => {
                if (card.parentElement) card.classList.add('pulsing');
            }, 10);
        }
    } else if (effectiveStatus === 'urgent') {
        statusText = ' URGENT CLOSING!';
        statusClass = 'status-urgent';
        centerContent = `
            <div class="timer-label">CHECK-IN CLOSES IN</div>
            <div class="timer" data-flight-id="${flight.id}">${timeInfo.display}</div>
            <div class="progress-bar">
                <div class="progress-fill urgent" data-flight-id="${flight.id}" style="width: ${timeInfo.percentage}%"></div>
            </div>
        `;
    } else if (effectiveStatus === 'closing') {
        statusText = ' CLOSING SOON';
        statusClass = 'status-closing';
        centerContent = `
            <div class="timer-label">CHECK-IN CLOSES IN</div>
            <div class="timer" data-flight-id="${flight.id}">${timeInfo.display}</div>
            <div class="progress-bar">
                <div class="progress-fill closing" data-flight-id="${flight.id}" style="width: ${timeInfo.percentage}%"></div>
            </div>
        `;
    } else if (effectiveStatus === 'open') {
        statusText = ' CHECK-IN OPEN';
        statusClass = 'status-open';
        centerContent = `
            <div class="timer" style="font-size: 2rem;">OPEN</div>
            <div class="progress-bar">
                <div class="progress-fill" style="width: 100%"></div>
            </div>
        `;
    } else if (effectiveStatus === 'not-open') {
        statusText = ' 3 HOURS FROM DEPARTURE';
        statusClass = 'status-not-open';
        centerContent = `
            <div class="timer" style="font-size: 1.5rem;">NOT OPEN</div>
        `;
    } else if (effectiveStatus === 'extended') {
        statusText = ' CHECK-IN EXTENDED';
        statusClass = 'status-extended';
        
        centerContent = `
            <div class="timer" style="font-size: 2rem;">EXTENDED</div>
            <div class="progress-bar">
                <div class="progress-fill" style="width: 100%; background: linear-gradient(90deg, #3b82f6, #60a5fa);"></div>
            </div>
        `;
    } else if (effectiveStatus === 'closed') {
        statusText = ' CLOSED';
        statusClass = 'status-closed';
        
       const extensionInfo = '';
        
        centerContent = `
            <div class="timer" style="font-size: 2rem;">CLOSED ${extensionInfo}</div>
        `;
    }
    
    const turnaroundIcon = flight.isTurnaround ? 
        `<span class="turnaround-icon" style="font-size: 2.4rem; letter-spacing: 0.5rem;"></span>` : '';

    const delayedInfo = flight.isDelayed ? 
        `<div style="font-size: 0.75rem; color: #f59e0b;"> Delayed from ${flight.originalDepartureTime}</div>` : '';

   const closeTimeDisplay = timeInfo.closeTime ? 
    timeInfo.closeTime.toLocaleTimeString('en-AU', { hour: '2-digit', minute: '2-digit', hour12: false }) : 
    '--:--';

card.innerHTML = `
    <!-- TOP ROW: Three bubbles -->
    <div class="section-left">
        <div class="flight-number-glass">
            <span class="editable-flight-num">${flight.flightNumber}</span>
        </div>
    </div>
    
    <div class="section-center">
        <div class="destination-glass">
            <span class="dest-display">${flight.destination}</span>
        </div>
    </div>
    
    <div class="section-right-top">
        <div class="close-time-glass">
            <span class="close-time-label">Closes:</span>
            <span class="close-time-value">${closeTimeDisplay}</span>
        </div>
    </div>
    
    <!-- MIDDLE ROW: Timer and flight info -->
    <div class="section-timer">
        ${turnaroundIcon ? `<div style="font-size: rem; margin-bottom: 1.5rem;">${turnaroundIcon}</div>` : ''}
        <div style="font-size: 1.5rem; color: #6b7280; margin-bottom: 0.5rem; font-weight: bold;">
    Departure: <span class="editable-dep" style="font-weight: bold; font-size: 1.3rem; color: #000345;">${flight.departureTime}</span>
</div>
        ${delayedInfo}
        <div class="timer-content-wrapper" style="margin-top: 0.5rem;">
            ${centerContent}
        </div>
    </div>
    
    <!-- BOTTOM ROW: Status badge and delete button -->
    <div class="section-bottom">
        <div class="status-badge-wrapper">
            <div class="status-badge ${statusClass}" data-flight-id="${flight.id}">${statusText}</div>
        </div>
        <button class="permanent-delete-btn" onclick="deleteFlight(${flight.id})">
             Delete
        </button>
    </div>
`;
    
    const flightNumEl = card.querySelector('.editable-flight-num');
    const destEl = card.querySelector('.dest-display');
    const depEl = card.querySelector('.editable-dep');

    if (flightNumEl) makeEditable(flightNumEl, flight, 'flightNumber', listeners);
    if (destEl) makeEditable(destEl, flight, 'destination', listeners);
    if (depEl) makeEditable(depEl, flight, 'departureTime', listeners);
    
    const statusBadgeWrapper = card.querySelector('.status-badge-wrapper');
    const statusBadge = card.querySelector('.status-badge');
    const dropdown = document.createElement('div');
    dropdown.className = 'status-dropdown';
    dropdown.style.display = 'none';
    
    const statuses = [
        { value: 'auto', label: 'Automatic (Based on Time)' },
        { value: 'open', label: ' Check-in Open' },
        { value: 'closing', label: ' Closing Soon' },
        { value: 'urgent', label: ' Urgent Closing' },
        { value: 'extended', label: ' Extend Check-In' },
        { value: 'closed', label: ' Closed' },
        { value: 'cancelled', label: ' Cancelled' }
    ];
    
    statuses.forEach(status => {
        const option = document.createElement('div');
        option.className = 'status-option';
        option.textContent = status.label;
        
const optionClickHandler = async function(e) {
    e.stopPropagation();
    e.preventDefault();
    
    console.log(' Status change requested:', status.value, 'for flight', flight.flightNumber);
    
    // Close dropdown first
    closeAllDropdowns();
    
    // Update the flight status
    if (status.value === 'auto') {
        flight.manualStatus = null;
        flight.cancelReason = null;
        flight.extensionStartTime = null;
        flight.extensionDuration = null;
    } else if (status.value === 'cancelled') {
    // NEW: Show approval modal instead of directly cancelling
    showCancellationApprovalModal(flight);
    console.log(' Showing cancellation approval modal');
    return;
        
    } else if (status.value === 'extended') {
    flight.manualStatus = 'extended';
    
    // Calculate the check-in close time (40 mins before departure)
    const today = new Date();
    const [hours, minutes] = (flight.isDelayed ? flight.departureTime : flight.originalDepartureTime || flight.departureTime).split(':').map(Number);
    const departure = new Date(today.getFullYear(), today.getMonth(), today.getDate(), hours, minutes);
    const checkinClose = new Date(departure.getTime() - 40 * 60000);
    
    // Use the close time as the extension start (deterministic across all devices)
    flight.extensionStartTime = checkinClose.getTime();
    flight.cancelReason = null;
    flight.extensionDuration = null;
    
    console.log(' Extension activated for flight', flight.flightNumber);
    
    // CRITICAL: Sync immediately and exit (like cancelled does)
    updateDisplay();
    await syncData();
    broadcastRefreshSignal();
    
    console.log(' Extension synced to all devices');
    return; // Exit immediately - don't continue to the generic sync below
}else {
        flight.manualStatus = status.value;
        flight.cancelReason = null;
        flight.extensionStartTime = null;
        flight.extensionDuration = null;
    }
    
    // FORCE SYNC ON EVERY STATUS CHANGE - NO EXCEPTIONS
    console.log(' Updating display...');
    updateDisplay();
    
    console.log(' Syncing to Firebase...');
    await syncData();
    
    console.log(' Broadcasting to other devices...');
    broadcastRefreshSignal();
    
    console.log(' Status change complete and synced for', flight.flightNumber);
};
        
        // Use touchstart for better mobile support
        option.addEventListener('touchstart', optionClickHandler);
        option.addEventListener('click', optionClickHandler);
        listeners.push({ element: option, event: 'touchstart', handler: optionClickHandler });
        listeners.push({ element: option, event: 'click', handler: optionClickHandler });
        
        dropdown.appendChild(option);
    });
    
    document.body.appendChild(dropdown);
    
const statusClickHandler = function(e) {
    e.stopPropagation();
    e.preventDefault();
    
    //  BLOCK dropdown if flight is read-only (past date)
    if (flight.isReadOnly) {
        alert(' Cannot Edit Past Date\n\nThis flight is from a previous date and cannot be modified.');
        return; // Exit - don't show dropdown
    }
    
    // Close any other open dropdowns first
    if (activeDropdown && activeDropdown !== dropdown) {
        closeAllDropdowns();
    }
        
        // If this dropdown is already open, close it
        if (dropdown.style.display === 'block') {
            closeAllDropdowns();
        } else {
            // Stop pulsing animation on critical cards while dropdown is open
            const criticalCards = document.querySelectorAll('.flight-card.critical');
            criticalCards.forEach(c => c.classList.remove('pulsing'));
            
            // Get button position and size
            const rect = statusBadge.getBoundingClientRect();
            
            // Show the dropdown
            dropdown.style.display = 'block';

            // ============================================
            // DEVICE DETECTION
            // ============================================
            const screenWidth = window.innerWidth;
            const isTablet = screenWidth >= 600 && screenWidth <= 1024;
            const isMobile = screenWidth < 600;
            const isDesktop = screenWidth > 1024;
            
            console.log(' Device type:', isTablet ? 'Tablet' : (isMobile ? 'Mobile' : 'Desktop'));
            console.log(' Screen width:', screenWidth);
            
            // ============================================
            // TABLET & MOBILE POSITIONING (600px - 1024px)
            // ============================================
            if (isTablet || isMobile) {
                console.log(' Using tablet/mobile positioning');
                
                // Set dropdown width
                const dropdownWidth = 250; // Fixed width for consistency
                dropdown.style.width = `${dropdownWidth}px`;
                
                // Calculate center of the button
                const buttonCenterX = rect.left + (rect.width / 2);
                
                // Calculate where dropdown should start (centered on button)
                const dropdownLeft = buttonCenterX - (dropdownWidth / 2);
                
                // Prevent dropdown from going off left edge
                const minLeft = 10; // 10px margin from left edge
                
                // Prevent dropdown from going off right edge
                const maxLeft = screenWidth - dropdownWidth - 10; // 10px margin from right edge
                
                // Apply constraints
                const finalLeft = Math.max(minLeft, Math.min(dropdownLeft, maxLeft));
                
                // Set horizontal position
                dropdown.style.left = `${finalLeft}px`;
                dropdown.style.right = 'auto'; // Clear any right positioning
                
                // ============================================
                // VERTICAL POSITIONING (Always above button)
                // ============================================
                
                // Calculate space above button
                const spaceAbove = rect.top;
                
                // Position dropdown above button (with 8px gap)
                dropdown.style.bottom = `${window.innerHeight - rect.top + 8}px`;
                dropdown.style.top = 'auto'; // Clear any top positioning
                
                // Add visual indicator that dropdown is centered on button
                dropdown.style.transformOrigin = 'bottom center';
                
                console.log(' Dropdown positioned:', {
                    left: finalLeft,
                    bottom: window.innerHeight - rect.top + 8,
                    width: dropdownWidth,
                    buttonCenter: buttonCenterX,
                    spaceAbove: spaceAbove
                });
                
            } 
            // ============================================
            // DESKTOP POSITIONING (> 1024px)
            // ============================================
            else if (isDesktop) {
                console.log(' Using desktop positioning');
                
                const dropdownHeight = 300;
                const spaceBelow = window.innerHeight - rect.bottom;
                const spaceAbove = rect.top;

                // Decide if dropdown should go above or below button
                if (spaceBelow < dropdownHeight && spaceAbove > spaceBelow) {
                    // Not enough space below, and more space above - put it above
                    dropdown.style.bottom = `${window.innerHeight - rect.top + 8}px`;
                    dropdown.style.top = 'auto';
                } else {
                    // Default: Put it below
                    dropdown.style.top = `${rect.bottom + 8}px`;
                    dropdown.style.bottom = 'auto';
                }

                // Position to the right of the button (desktop has more space)
                dropdown.style.right = `${window.innerWidth - rect.right}px`;
                dropdown.style.left = 'auto';
                dropdown.style.width = 'auto'; // Let it size naturally
            }
            
            // Mark this as the active dropdown
            activeDropdown = dropdown;
        }
    };
    
    // Use both touchstart and click for compatibility
    statusBadge.addEventListener('touchstart', statusClickHandler);
    statusBadge.addEventListener('click', statusClickHandler);
    listeners.push({ element: statusBadge, event: 'touchstart', handler: statusClickHandler });
    listeners.push({ element: statusBadge, event: 'click', handler: statusClickHandler });
    
    flightCardListeners.set(card, listeners);
    
    return card;
}

    function updateDisplay() {
    // CRITICAL: Don't display if data is stale
    if (checkForStaleData()) {
        console.log(' Blocked display update - stale data');
        return;
    }
        
    if (!dateValidationDismissed) return;
    
    // CRITICAL: Don't modify flight statuses based on date here
    // Date logic should only run on initial CSV load
    console.log(' Display update - preserving current statuses');
    
    // Close any open dropdowns to prevent conflicts
    closeAllDropdowns();
    
    // Remove pulsing from all cards before re-render
    document.querySelectorAll('.flight-card.pulsing').forEach(c => c.classList.remove('pulsing'));
    
    updateDateValidationBadge();
    
    const sorted = flights.sort((a, b) => {
        const timeA = calculateTimeRemaining(a).totalMinutes;
        const timeB = calculateTimeRemaining(b).totalMinutes;
        return timeA - timeB;
    });

    const cancelled = sorted.filter(f => {
        return f.manualStatus === 'cancelled';
    });

    const urgent = sorted.filter(f => {
        if (f.manualStatus === 'cancelled') return false;
        const time = calculateTimeRemaining(f);
        const effectiveStatus = f.manualStatus || time.status;
        if (f.manualStatus === 'extended') return false;
        return effectiveStatus === 'urgent' || effectiveStatus === 'closing' || effectiveStatus === 'critical';
    });

    const extended = sorted.filter(f => {
        if (f.manualStatus === 'cancelled') return false;
        const time = calculateTimeRemaining(f);
        const effectiveStatus = f.manualStatus || time.status;
        return f.manualStatus === 'extended' || effectiveStatus === 'extended' || effectiveStatus === 'extended-critical' || effectiveStatus === 'extended-urgent' || effectiveStatus === 'extended-closing';
    });

    const active = sorted.filter(f => {
        if (f.manualStatus === 'cancelled') return false;
        const time = calculateTimeRemaining(f);
        const effectiveStatus = f.manualStatus || time.status;
        if (f.manualStatus === 'extended') return false;
        return effectiveStatus === 'open';
    });

    const notOpen = sorted.filter(f => {
        if (f.manualStatus === 'cancelled') return false;
        const time = calculateTimeRemaining(f);
        const effectiveStatus = f.manualStatus || time.status;
        return effectiveStatus === 'not-open';
    });

    const closed = sorted.filter(f => {
        if (f.manualStatus === 'cancelled') return false;
        const time = calculateTimeRemaining(f);
        const effectiveStatus = f.manualStatus || time.status;
        return effectiveStatus === 'closed';
    });

    const urgentSection = document.getElementById('urgent-section');
    const urgentFlights = document.getElementById('urgent-flights');

    if (urgent.length > 0) {
        urgentSection.style.display = 'block';
        document.getElementById('urgent-count').textContent = urgent.length;
        
        const existingIds = Array.from(urgentFlights.querySelectorAll('.flight-card'))
            .map(card => parseInt(card.querySelector('.status-badge').getAttribute('data-flight-id')));
        const newIds = urgent.map(f => f.id);
        
        // Always update - Firebase is source of truth
Array.from(urgentFlights.children).forEach(cleanupFlightCard);

urgentFlights.innerHTML = '';
urgent.forEach(flight => {
    const card = renderFlight(flight);
    urgentFlights.appendChild(card);
});
    } else {
        urgentSection.style.display = 'none';
    }

    const activeContent = document.getElementById('active-flights');
    const closedContent = document.getElementById('closed-flights');
    const notOpenContent = document.getElementById('notopen-flights');
    const cancelledContent = document.getElementById('cancelled-flights');
    const extendedContent = document.getElementById('extended-flights');
    
    if (extendedContent && !extendedContent.classList.contains('user-interacted')) {
        extendedContent.classList.add('expanded');
        document.getElementById('extended-toggle').textContent = '';
    }

    if (activeContent && !activeContent.classList.contains('user-interacted')) {
        activeContent.classList.remove('expanded');
        document.getElementById('active-toggle').textContent = '+';
    }
    if (closedContent && !closedContent.classList.contains('user-interacted')) {
        closedContent.classList.remove('expanded');
        document.getElementById('closed-toggle').textContent = '+';
    }
    if (notOpenContent && !notOpenContent.classList.contains('user-interacted')) {
        notOpenContent.classList.remove('expanded');
        document.getElementById('notopen-toggle').textContent = '+';
    }
    if (cancelledContent && !cancelledContent.classList.contains('user-interacted')) {
        cancelledContent.classList.remove('expanded');
        document.getElementById('cancelled-toggle').textContent = '+';
    }

    const activeSection = document.getElementById('active-section');
    const activeFlights = document.getElementById('active-flights');

    const extendedSection = document.getElementById('extended-section');
    const extendedFlights = document.getElementById('extended-flights');

    if (extended.length > 0) {
        extendedSection.style.display = 'block';
        document.getElementById('extended-count').textContent = extended.length;
        
        Array.from(extendedFlights.children).forEach(cleanupFlightCard);
        
        extendedFlights.innerHTML = '';
        extended.forEach(flight => {
            const card = renderFlight(flight);
            extendedFlights.appendChild(card);
        });
    } else {
        extendedSection.style.display = 'none';
    }

    if (active.length > 0) {
        activeSection.style.display = 'block';
        document.getElementById('active-count').textContent = `${active.length}`;
        
        Array.from(activeFlights.children).forEach(cleanupFlightCard);
        
        activeFlights.innerHTML = '';
        active.forEach(flight => {
            const card = renderFlight(flight);
            activeFlights.appendChild(card);
        });
    } else {
        activeSection.style.display = 'none';
    }

    const closedSection = document.getElementById('closed-section');
    const closedFlights = document.getElementById('closed-flights');
    
    if (closed.length > 0) {
        closedSection.style.display = 'block';
        document.getElementById('closed-count').textContent = `${closed.length}`;
        
        Array.from(closedFlights.children).forEach(cleanupFlightCard);
        
        closedFlights.innerHTML = '';
        closed.forEach(flight => {
            const card = renderFlight(flight);
            closedFlights.appendChild(card);
        });
    } else {
        closedSection.style.display = 'none';
    }
    
    const notOpenSection = document.getElementById('not-open-section');
    const notOpenFlights = document.getElementById('notopen-flights');
    
    if (notOpen.length > 0) {
        notOpenSection.style.display = 'block';
        document.getElementById('notopen-count').textContent = `${notOpen.length}`;
        
        Array.from(notOpenFlights.children).forEach(cleanupFlightCard);
        
        notOpenFlights.innerHTML = '';
        notOpen.forEach(flight => {
            const card = renderFlight(flight);
            notOpenFlights.appendChild(card);
        });
    } else {
        notOpenSection.style.display = 'none';
    }

    const cancelledSection = document.getElementById('cancelled-section');
    const cancelledFlights = document.getElementById('cancelled-flights');
    
    if (cancelled.length > 0) {
        cancelledSection.style.display = 'block';
        document.getElementById('cancelled-count-header').textContent = `${cancelled.length}`;
        
        Array.from(cancelledFlights.children).forEach(cleanupFlightCard);
        
        cancelledFlights.innerHTML = '';
        cancelled.forEach(flight => {
            const card = renderFlight(flight);
            cancelledFlights.appendChild(card);
        });
    } else {
        cancelledSection.style.display = 'none';
    }

    document.getElementById('loading').style.display = 
        flights.length === 0 ? 'block' : 'none';
        //  HIDE closed section if this is past date data
    if (flightDate) {
        const today = new Date();
        today.setHours(0, 0, 0, 0);
        const csvDateOnly = new Date(flightDate);
        csvDateOnly.setHours(0, 0, 0, 0);
        
        if (csvDateOnly < today) {
            // Past date - hide the closed section entirely
            const closedSection = document.getElementById('closed-section');
            if (closedSection) {
                closedSection.style.display = 'none';
            }
            
            console.log(' Hidden closed section - past date data');
        }
    }
}
        
function searchFlights(query) {
    console.log('=== SEARCH DEBUG ===');
    console.log('Search query:', query);
    console.log('Total flights:', flights.length);
    
    if (!query || query.trim() === '') {
        return [];
    }
    
    const searchTerm = query.trim().toUpperCase();
    console.log('Search term (uppercase):', searchTerm);
    
    const results = flights.filter(flight => {
        const flightNum = flight.flightNumber.toUpperCase();
        const dest = flight.destination.toUpperCase();
        
        // Extract just the numbers from flight number (e.g., "JQ788" -> "788")
        const flightNumOnly = flightNum.replace(/[^0-9]/g, '');
        
        // Extract just the numbers from search term
        const searchNumOnly = searchTerm.replace(/[^0-9]/g, '');
        
        console.log('Checking flight:', flightNum, 'to', dest, '(numbers only:', flightNumOnly + ')');
        
        // Check multiple match types
        const directFlightMatch = flightNum.includes(searchTerm); // Exact match: "JQ788" includes "JQ788"
        const numberMatch = searchNumOnly && flightNumOnly.includes(searchNumOnly); // Number match: "788" in "788"
        const destMatch = dest.includes(searchTerm); // Destination match: "BNE" includes "BNE"
        const prefixMatch = searchTerm.replace(/^JQ/i, '') && flightNum === ('JQ' + searchTerm.replace(/^JQ/i, '')); // "788" -> "JQ788"
        
        // NEW: Partial flight number match (e.g., "78" matches "JQ788")
        const partialFlightMatch = searchNumOnly && flightNumOnly.startsWith(searchNumOnly);
        
        const matched = directFlightMatch || numberMatch || destMatch || prefixMatch || partialFlightMatch;
        
        if (matched) {
            console.log('" MATCH FOUND:', flightNum, '->', 
                'directMatch:', directFlightMatch, 
                'numberMatch:', numberMatch, 
                'destMatch:', destMatch, 
                'prefixMatch:', prefixMatch,
                'partialMatch:', partialFlightMatch);
        }
        
        return matched;
    });
    
    console.log('Total results found:', results.length);
    console.log('===================');
    
    return results;
}
        function highlightMatch(text, query) {
            if (!query) return text;
            const regex = new RegExp(`(${query})`, 'gi');
            return text.replace(regex, '<span class="search-highlight">$1</span>');
        }
        
       function showSearchResults(results, query) {
      // ADD THIS - Clear cache since search renders new cards
    
    closeAllDropdowns();
    
    if (searchResultsModal) {
        searchResultsModal.remove();
    }
            
            const overlay = document.createElement('div');
            overlay.className = 'overlay';
            
            const modal = document.createElement('div');
            modal.className = 'search-results-modal';
            searchResultsModal = modal;
            
            const header = document.createElement('div');
            header.className = 'search-results-header';
            
            const title = document.createElement('div');
            title.className = 'search-results-title';
            title.innerHTML = `Search Results for: <span class="search-highlight">${query}</span> (${results.length} found)`;
            
            const closeBtn = document.createElement('button');
            closeBtn.className = 'search-results-close';
            closeBtn.textContent = ' ';
            closeBtn.onclick = closeSearchResults;
            
            header.appendChild(title);
            header.appendChild(closeBtn);
            modal.appendChild(header);
            
            const content = document.createElement('div');
            content.className = 'search-results-content';
            
            if (results.length === 0) {
                content.innerHTML = '<div class="no-results">No flights found matching your search.</div>';
            } else {
            results.forEach(flight => {
    const flightCard = renderFlight(flight);
    
    // Find and highlight flight number
    const flightNumEl = flightCard.querySelector('.editable-flight-num');
    if (flightNumEl) {
        flightNumEl.innerHTML = highlightMatch(flight.flightNumber, query);
    }
    
    // Find and highlight destination
    const destEl = flightCard.querySelector('.dest-display');
    if (destEl) {
        destEl.innerHTML = highlightMatch(flight.destination, query);
    }
    
    content.appendChild(flightCard);
});
            }
            
            modal.appendChild(content);
            
            overlay.onclick = closeSearchResults;
            
            document.body.appendChild(overlay);
            document.body.appendChild(modal);
        }
        
        function closeSearchResults() {
            const overlay = document.querySelector('.overlay');
            if (searchResultsModal) {
                searchResultsModal.remove();
                searchResultsModal = null;
            }
            if (overlay) overlay.remove();
        }
        
        function clearSearch() {
            const searchInput = document.getElementById('search-input');
            const clearBtn = document.getElementById('search-clear-btn');
            searchInput.value = '';
            clearBtn.style.display = 'none';
            searchQuery = '';
            closeSearchResults();
        }
        
      function initializeSearch() {
    const searchInput = document.getElementById('search-input');
    const clearBtn = document.getElementById('search-clear-btn');
    
    searchInput.addEventListener('input', function(e) {
        const query = e.target.value.trim();
        searchQuery = query;
        
        if (query.length > 0) {
            clearBtn.style.display = 'flex';
        } else {
            clearBtn.style.display = 'none';
            closeSearchResults();
            return;
        }
        
        // CHANGED: Search immediately for 1+ characters instead of waiting for 3
        if (query.length >= 1) {
            const results = searchFlights(query);
            showSearchResults(results, query);
        }
    });
    
    searchInput.addEventListener('keydown', function(e) {
        if (e.key === 'Escape') {
            clearSearch();
        }
    });
}
        
        function openCommentModal() {
            if (checkCommentLock()) {
                showEditingWarning();
                return;
            }
            
            setCommentLock(true);
            closeAllDropdowns();
            
            const overlay = document.createElement('div');
            overlay.className = 'overlay';
            
            const modal = document.createElement('div');
            modal.className = 'comment-input-modal';
            
            modal.innerHTML = `
                <div class="comment-input-title">Add New Comment</div>
                <textarea class="comment-textarea" placeholder="Enter your comment here..." id="new-comment-text"></textarea>
                <div class="comment-input-actions">
                    <button class="comment-cancel-btn" onclick="closeCommentModal()">Cancel</button>
                    <button class="comment-save-btn" onclick="saveComment()">Save Comment</button>
                </div>
            `;
            
            overlay.onclick = function() {
                setCommentLock(false);
                modal.remove();
                overlay.remove();
            };
            
            document.body.appendChild(overlay);
            document.body.appendChild(modal);
            document.getElementById('new-comment-text').focus();
        }
        
        function closeCommentModal() {
            setCommentLock(false);
            const overlay = document.querySelector('.overlay');
            const modal = document.querySelector('.comment-input-modal');
            if (overlay) overlay.remove();
            if (modal) modal.remove();
        }
        function openCommentModalFromButton() {
    // Show comment type selection modal
    showCommentSelectionModal();
}

function showCommentSelectionModal() {
    closeAllDropdowns();
    
    const overlay = document.createElement('div');
    overlay.className = 'overlay';
    overlay.id = 'comment-selection-overlay';
    
    const modal = document.createElement('div');
    modal.className = 'comment-selection-modal';
    modal.id = 'comment-selection-modal';
    
    modal.innerHTML = `
        <div class="comment-selection-title"> Add Comment</div>
        <div class="comment-selection-subtitle">Select the type of comment you want to add</div>
        
        <button class="comment-type-btn zone-e" onclick="selectCommentType('zone-e')">
            <span class="comment-type-icon"></span>
            <div class="comment-type-text">
                <div>Zone E Comment</div>
                <div class="comment-type-desc">For Zone E specific updates and notes</div>
            </div>
        </button>
        
        <button class="comment-type-btn general" onclick="selectCommentType('general')">
            <span class="comment-type-icon"></span>
            <div class="comment-type-text">
                <div>General Comment</div>
                <div class="comment-type-desc">For general shift updates and notes</div>
            </div>
        </button>
        
        <button class="comment-selection-cancel" onclick="closeCommentSelectionModal()">Cancel</button>
    `;
    
    overlay.onclick = function(e) {
        if (e.target === overlay) {
            closeCommentSelectionModal();
        }
    };
    
    document.body.appendChild(overlay);
    document.body.appendChild(modal);
}

function closeCommentSelectionModal() {
    const overlay = document.getElementById('comment-selection-overlay');
    const modal = document.getElementById('comment-selection-modal');
    if (overlay) overlay.remove();
    if (modal) modal.remove();
}

function selectCommentType(type) {
    closeCommentSelectionModal();
    
    if (type === 'zone-e') {
        openZoneECommentModal();
    } else {
        // Show regular comments section and open modal
        document.getElementById('comments-section').style.display = 'block';
        openCommentModal();
    }
}
async function saveComment() {
    const text = document.getElementById('new-comment-text').value.trim();
    if (!text) {
        setCommentLock(false);
        return;
    }
    
    const comment = {
        id: Date.now(),
        text: text,
        timestamp: Date.now(), // Number, not Date object
        sessionId: sessionId,
        editedAt: null,
        editedBy: null
    };
    
    comments.push(comment);
    // CRITICAL: Immediately acknowledge this comment for User 1 (the creator)
acknowledgedComments.add(comment.id);
try {
    const acknowledged = Array.from(acknowledgedComments);
    localStorage.setItem('acknowledged_comments', JSON.stringify(acknowledged));
} catch (e) {
    console.error('Error saving acknowledged comments:', e);
}
    
    // Show the comments section
    document.getElementById('comments-section').style.display = 'block';
    
    setCommentLock(false);
    closeCommentModal();
    
    // Sync to Firebase first
    await syncData();
    
    // Broadcast to other users that a comment was added
    const commentBroadcast = {
        action: 'comment_added',
        comment: comment,
        fromSession: sessionId,
        timestamp: Date.now()
    };
    
    console.log(' Broadcasting new comment to other users');
    
    // Send via localStorage (for same-device tabs)
    localStorage.setItem('comment_broadcast', JSON.stringify(commentBroadcast));
    
    // Send via Firebase (for other devices)
    if (firebaseInitialized) {
        const commentBroadcastRef = firebase.database().ref(getFirebasePath('comment_broadcast'));
        await commentBroadcastRef.push(commentBroadcast);
        console.log(' Comment broadcast sent via Firebase');
    }
    
    renderComments();
    
    console.log(' New comment saved and broadcast sent');
}

// ============================================
// ZONE E COMMENT FUNCTIONS
// ============================================

function openZoneECommentModal() {
    if (checkCommentLock()) {
        showEditingWarning();
        return;
    }
    
    setCommentLock(true);
    closeAllDropdowns();
    
    const overlay = document.createElement('div');
    overlay.className = 'overlay';
    overlay.id = 'zone-e-comment-overlay';
    
    const modal = document.createElement('div');
    modal.className = 'comment-input-modal';
    modal.id = 'zone-e-comment-modal';
    modal.style.borderColor = '#FA5115';
    
    modal.innerHTML = `
        <div class="comment-input-title" style="color: #FA5115;"> Add Zone E Comment</div>
        <textarea class="comment-textarea" placeholder="Enter your Zone E comment here..." id="new-zone-e-comment-text" style="border-color: #FA5115;"></textarea>
        <div class="comment-input-actions">
            <button class="comment-cancel-btn" onclick="closeZoneECommentModal()">Cancel</button>
            <button class="comment-save-btn" onclick="saveZoneEComment()" style="background: #FA5115;">Save Comment</button>
        </div>
    `;
    
    overlay.onclick = function() {
        closeZoneECommentModal();
    };
    
    document.body.appendChild(overlay);
    document.body.appendChild(modal);
    document.getElementById('new-zone-e-comment-text').focus();
}

function closeZoneECommentModal() {
    setCommentLock(false);
    const overlay = document.getElementById('zone-e-comment-overlay');
    const modal = document.getElementById('zone-e-comment-modal');
    if (overlay) overlay.remove();
    if (modal) modal.remove();
}

async function saveZoneEComment() {
    const text = document.getElementById('new-zone-e-comment-text').value.trim();
    if (!text) {
        setCommentLock(false);
        return;
    }
    
    const comment = {
        id: Date.now(),
        text: text,
        timestamp: Date.now(),
        sessionId: sessionId,
        editedAt: null,
        editedBy: null,
        type: 'zone-e'
    };
    
    zoneEComments.push(comment);
    
    // Immediately acknowledge this comment for the creator
    acknowledgedZoneEComments.add(comment.id);
    try {
        const acknowledged = Array.from(acknowledgedZoneEComments);
        localStorage.setItem('acknowledged_zone_e_comments', JSON.stringify(acknowledged));
    } catch (e) {
        console.error('Error saving acknowledged Zone E comments:', e);
    }
    
    // Show the Zone E comments section
    document.getElementById('zone-e-comments-section').style.display = 'block';
    
    setCommentLock(false);
    closeZoneECommentModal();
    
    // Sync to Firebase first
    await syncData();
    
    // Broadcast to other users
    const commentBroadcast = {
        action: 'zone_e_comment_added',
        comment: comment,
        fromSession: sessionId,
        timestamp: Date.now()
    };
    
    console.log(' Broadcasting new Zone E comment to other users');
    
    // Send via localStorage
    localStorage.setItem('zone_e_comment_broadcast', JSON.stringify(commentBroadcast));
    
    // Send via Firebase
    if (firebaseInitialized) {
        const zoneECommentBroadcastRef = firebase.database().ref(getFirebasePath('zone_e_comment_broadcast'));
        await zoneECommentBroadcastRef.push(commentBroadcast);
        console.log(' Zone E comment broadcast sent via Firebase');
    }
    
    renderZoneEComments();
    
    console.log(' New Zone E comment saved and broadcast sent');
}

function deleteZoneEComment(id) {
    if (checkCommentLock()) {
        showEditingWarning();
        return;
    }
    
    if (!confirm('Delete this Zone E comment?')) {
        return;
    }
    
    setCommentLock(true);
    zoneEComments = zoneEComments.filter(c => c.id !== id);
    setCommentLock(false);
    debouncedSync();
    renderZoneEComments();
}

function deleteAllZoneEComments() {
    if (checkCommentLock()) {
        showEditingWarning();
        return;
    }
    
    if (zoneEComments.length === 0) {
        return;
    }
    
    if (confirm('Are you sure you want to delete all Zone E comments?')) {
        setCommentLock(true);
        zoneEComments = [];
        setCommentLock(false);
        debouncedSync();
        renderZoneEComments();
    }
}

async function editZoneEComment(id) {
    if (checkCommentLock()) {
        showEditingWarning();
        return;
    }
    
    setCommentLock(true);
    const comment = zoneEComments.find(c => c.id === id);
    if (!comment) {
        setCommentLock(false);
        return;
    }
    
    const commentElement = document.querySelector(`[data-zone-e-comment-id="${id}"] .comment-text`);
    const originalText = comment.text;
    
    commentElement.contentEditable = true;
    commentElement.focus();
    commentElement.style.borderColor = '#FA5115';
    
    const saveEdit = async function() {
        const newText = commentElement.textContent.trim();
        if (newText && newText !== originalText) {
            comment.text = newText;
            comment.editedAt = Date.now();
            comment.editedBy = sessionId;
            
            await syncData();
            
            // Broadcast edit
            const editBroadcast = {
                action: 'zone_e_comment_edited',
                commentId: id,
                newText: newText,
                editedAt: comment.editedAt,
                editedBy: comment.editedBy,
                fromSession: sessionId,
                timestamp: Date.now()
            };
            
            localStorage.setItem('zone_e_comment_broadcast', JSON.stringify(editBroadcast));
            
            if (firebaseInitialized) {
                const zoneECommentBroadcastRef = firebase.database().ref(getFirebasePath('zone_e_comment_broadcast'));
                await zoneECommentBroadcastRef.push(editBroadcast);
            }
        }
        commentElement.contentEditable = false;
        setCommentLock(false);
        renderZoneEComments();
    };
    
    commentElement.addEventListener('blur', saveEdit, { once: true });
    commentElement.addEventListener('keydown', function(e) {
        if (e.key === 'Enter' && !e.shiftKey) {
            e.preventDefault();
            commentElement.blur();
        }
        if (e.key === 'Escape') {
            commentElement.textContent = originalText;
            commentElement.blur();
        }
    });
}

function renderZoneEComments() {
    const container = document.getElementById('zone-e-comments-container');
    const deleteAllBtn = document.getElementById('zone-e-delete-all-btn');
    const zoneESection = document.getElementById('zone-e-comments-section');
    
    if (zoneEComments.length === 0) {
        container.innerHTML = '';
        zoneESection.style.display = 'none';
    } else {
        zoneESection.style.display = 'block';
        deleteAllBtn.style.display = 'block';
        container.innerHTML = '';
        
        const sortedComments = [...zoneEComments].sort((a, b) => b.timestamp - a.timestamp);
        
        sortedComments.forEach(comment => {
            const card = document.createElement('div');
            card.className = 'zone-e-comment-card';
            card.setAttribute('data-zone-e-comment-id', comment.id);
            
            let timestampValue = comment.timestamp;
            if (typeof timestampValue !== 'number') {
                timestampValue = new Date(timestampValue).getTime();
            }
            
            let timestampDisplay = 'Invalid Date';
            if (!isNaN(timestampValue) && timestampValue > 0) {
                timestampDisplay = new Date(timestampValue).toLocaleString('en-AU', {
                    year: 'numeric',
                    month: 'short',
                    day: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit',
                    hour12: false
                });
            }
            
            let editIndicator = '';
            if (comment.editedAt) {
                const editedTime = new Date(comment.editedAt).toLocaleString('en-AU', {
                    hour: '2-digit',
                    minute: '2-digit',
                    hour12: false
                });
                editIndicator = ` <span style="color: #6b7280; font-style: italic; font-size: 0.75rem;">(edited ${editedTime})</span>`;
            }
            
            card.innerHTML = `
                <div class="comment-header">
                    <div class="comment-timestamp">${timestampDisplay}<span class="zone-e-badge">ZONE E</span>${editIndicator}</div>
                    <button class="comment-delete" onclick="deleteZoneEComment(${comment.id})" style="background: #FA5115;"> </button>
                </div>
                <div class="comment-text" onclick="editZoneEComment(${comment.id})">${comment.text}</div>
            `;
            
            container.appendChild(card);
        });
    }
}

// Zone E Comment Notification
function showZoneECommentNotification(comment) {
    console.log(' Showing Zone E comment notification:', comment.id);
    
    if (document.querySelector('.zone-e-notification-popup')) {
        console.log(' Zone E notification already visible, skipping');
        return;
    }
    
    const notification = document.createElement('div');
    notification.className = 'zone-e-notification-popup';
    notification.id = `zone-e-notif-${comment.id}`;
    
    let timestampValue = comment.timestamp;
    if (typeof timestampValue !== 'number') {
        timestampValue = new Date(timestampValue).getTime();
    }
    
    const timestamp = new Date(timestampValue).toLocaleString('en-AU', {
        month: 'short',
        day: 'numeric',
        hour: '2-digit',
        minute: '2-digit',
        hour12: false
    });
    
    let previewText = comment.text;
    if (previewText.length > 150) {
        previewText = previewText.substring(0, 147) + '...';
    }
    
    notification.innerHTML = `
        <div class="zone-e-notification-header">
            <div class="zone-e-notification-icon"></div>
            <div class="zone-e-notification-title">New Zone E Comment</div>
        </div>
        
        <div class="zone-e-notification-body">
            <div class="zone-e-notification-time">${timestamp}</div>
            <div class="zone-e-notification-preview">${previewText}</div>
        </div>
        
        <button class="zone-e-notification-acknowledge" onclick="acknowledgeZoneEComment(${comment.id})">
            " Acknowledge
        </button>
    `;
    
    document.body.appendChild(notification);
    
    // Auto-dismiss after 5 minutes
    setTimeout(() => {
        if (document.getElementById(`zone-e-notif-${comment.id}`)) {
            acknowledgeZoneEComment(comment.id);
        }
    }, 5 * 60 * 1000);
    
    console.log(' Zone E comment notification displayed');
}

function acknowledgeZoneEComment(commentId) {
    console.log('" User acknowledged Zone E comment:', commentId);
    
    acknowledgedZoneEComments.add(commentId);
    
    try {
        const acknowledged = Array.from(acknowledgedZoneEComments);
        localStorage.setItem('acknowledged_zone_e_comments', JSON.stringify(acknowledged));
    } catch (e) {
        console.error('Error saving acknowledged Zone E comments:', e);
    }
    
    const notification = document.getElementById(`zone-e-notif-${commentId}`);
    if (notification) {
        notification.classList.add('fade-out');
        setTimeout(() => {
            notification.remove();
        }, 300);
    }
    
    console.log(' Zone E comment notification dismissed');
}

function shouldShowZoneECommentNotification(comment) {
    if (acknowledgedZoneEComments.has(comment.id)) {
        return false;
    }
    
    const commentAge = Date.now() - new Date(comment.timestamp).getTime();
    const fiveMinutes = 5 * 60 * 1000;
    
    return commentAge < fiveMinutes;
}

async function checkAndNotifyZoneEComments() {
    console.log(' Checking for Zone E comment notifications...');
    
    try {
        const stored = localStorage.getItem('acknowledged_zone_e_comments');
        if (stored) {
            const acknowledged = JSON.parse(stored);
            acknowledged.forEach(id => acknowledgedZoneEComments.add(id));
        }
    } catch (e) {
        console.error('Error loading acknowledged Zone E comments:', e);
    }
    
    const needsNotification = zoneEComments.filter(comment => shouldShowZoneECommentNotification(comment));
    
    if (needsNotification.length > 0) {
        console.log(` Found ${needsNotification.length} Zone E comment(s) to notify`);
        
        const mostRecent = needsNotification.sort((a, b) => 
            new Date(b.timestamp) - new Date(a.timestamp)
        )[0];
        
        showZoneECommentNotification(mostRecent);
    } else {
        console.log('" No Zone E comments need notification');
    }
}
       function deleteComment(id) {
    if (checkCommentLock()) {
        showEditingWarning();
        return;
    }
    
    if (!confirm('Delete this comment?')) {
        return;
    }
    
    setCommentLock(true);
    comments = comments.filter(c => c.id !== id);
    setCommentLock(false);
    debouncedSync();
    renderComments(); // This will auto-hide section if no comments remain
}
       function deleteAllComments() {
    if (checkCommentLock()) {
        showEditingWarning();
        return;
    }
    
    if (comments.length === 0) {
        return;
    }
    
    if (confirm('Are you sure you want to delete all comments?')) {
        setCommentLock(true);
        comments = [];
        setCommentLock(false);
        debouncedSync();
        renderComments(); // This will auto-hide section
    }
}
        
        async function editComment(id) {
    if (checkCommentLock()) {
        showEditingWarning();
        return;
    }
    
    setCommentLock(true);
    const comment = comments.find(c => c.id === id);
    if (!comment) {
        setCommentLock(false);
        return;
    }
    
    const commentElement = document.querySelector(`[data-comment-id="${id}"] .comment-text`);
    const originalText = comment.text;
    
    commentElement.contentEditable = true;
    commentElement.focus();
    
    const saveEdit = async function() {
        const newText = commentElement.textContent.trim();
        
        if (newText !== originalText && newText !== '') {
            comment.text = newText;
            comment.editedAt = Date.now();
            comment.editedBy = sessionId;
            // CRITICAL: User 1 (the editor) should not see edit notification
// Mark this edit as acknowledged for the editor
acknowledgedComments.add(comment.id);
try {
    const acknowledged = Array.from(acknowledgedComments);
    localStorage.setItem('acknowledged_comments', JSON.stringify(acknowledged));
} catch (e) {
    console.error('Error saving acknowledged comments:', e);
}
            
            commentElement.contentEditable = false;
            commentElement.removeEventListener('blur', saveEdit);
            commentElement.removeEventListener('keydown', handleEnter);
            setCommentLock(false);
            
            // Sync to Firebase
            await syncData();
            
            // Broadcast edit to other users
            const editBroadcast = {
                action: 'comment_edited',
                commentId: id,
                newText: newText,
                editedAt: comment.editedAt,
                editedBy: sessionId,
                fromSession: sessionId,
                timestamp: Date.now()
            };
            
            console.log(' Broadcasting comment edit to other users');
            
            // Send via localStorage
            localStorage.setItem('comment_broadcast', JSON.stringify(editBroadcast));
            
            // Send via Firebase
            if (firebaseInitialized) {
                const commentBroadcastRef = firebase.database().ref(getFirebasePath('comment_broadcast'));
                await commentBroadcastRef.push(editBroadcast);
                console.log(' Comment edit broadcast sent via Firebase');
            }
            
            renderComments();
        } else {
            // No change, just revert
            commentElement.textContent = originalText;
            commentElement.contentEditable = false;
            commentElement.removeEventListener('blur', saveEdit);
            commentElement.removeEventListener('keydown', handleEnter);
            setCommentLock(false);
        }
    };
    
    const handleEnter = function(e) {
        if (e.key === 'Enter' && !e.shiftKey) {
            e.preventDefault();
            commentElement.blur();
        }
    };
    
    commentElement.addEventListener('blur', saveEdit);
    commentElement.addEventListener('keydown', handleEnter);
}
        
     function renderComments() {
    const container = document.getElementById('comments-container');
    const deleteAllBtn = document.getElementById('delete-all-btn');
    const commentsSection = document.getElementById('comments-section');
    
    if (comments.length === 0) {
        container.innerHTML = '';
        commentsSection.style.display = 'none'; // Hide entire section
    } else {
        commentsSection.style.display = 'block'; // Show entire section
        deleteAllBtn.style.display = 'block';
        container.innerHTML = '';
        
        const sortedComments = [...comments].sort((a, b) => b.timestamp - a.timestamp);
        
      sortedComments.forEach(comment => {
    const card = document.createElement('div');
    card.className = 'comment-card';
    card.setAttribute('data-comment-id', comment.id);
    
    // Ensure timestamp is a number
    let timestampValue = comment.timestamp;
    if (typeof timestampValue !== 'number') {
        // Try to convert if it's a Date object or string
        timestampValue = new Date(timestampValue).getTime();
    }
    
    // Check if timestamp is valid
    let timestampDisplay = 'Invalid Date';
    if (!isNaN(timestampValue) && timestampValue > 0) {
        timestampDisplay = new Date(timestampValue).toLocaleString('en-AU', {
            year: 'numeric',
            month: 'short',
            day: 'numeric',
            hour: '2-digit',
            minute: '2-digit',
            hour12: false
        });
    }
    
    // Show edited indicator if applicable
    let editIndicator = '';
    if (comment.editedAt) {
        const editedTime = new Date(comment.editedAt).toLocaleString('en-AU', {
            hour: '2-digit',
            minute: '2-digit',
            hour12: false
        });
        editIndicator = ` <span style="color: #6b7280; font-style: italic; font-size: 0.75rem;">(edited ${editedTime})</span>`;
    }
    
    const timestamp = timestampDisplay;
            
            card.innerHTML = `
    <div class="comment-header">
        <div class="comment-timestamp">${timestamp}${editIndicator}</div>
        <button class="comment-delete" onclick="deleteComment(${comment.id})"> </button>
    </div>
                <div class="comment-text" onclick="editComment(${comment.id})">${comment.text}</div>
            `;
            
            container.appendChild(card);
        });
    }
}
        document.addEventListener('click', function(e) {
            if (!e.target.closest('.status-badge') && !e.target.closest('.status-dropdown')) {
                closeAllDropdowns();
            }
        });

function updateOnlyTimers() {
    // CRITICAL: Update global current time first
    currentTime = new Date();
    
    flights.forEach(flight => {
        // Find timer elements using data-flight-id attribute for reliability
        const timerEl = document.querySelector(`.timer[data-flight-id="${flight.id}"]`);
        const progressFill = document.querySelector(`.progress-fill[data-flight-id="${flight.id}"]`);
        
        if (!timerEl) return; // Flight not in DOM
        
        const timeInfo = calculateTimeRemaining(flight);
        
        // Only update if showing dynamic countdown
        if (timeInfo.display !== 'OPEN' && 
            timeInfo.display !== 'CLOSED' && 
            timeInfo.display !== 'NOT OPEN' && 
            timeInfo.display !== 'CANCELLED') {
            
            timerEl.textContent = timeInfo.display;
            
            if (progressFill) {
                progressFill.style.width = timeInfo.percentage + '%';
            }
        }
    });
}

// Store interval IDs globally so we can clear them
let timerUpdateInterval = null;
let fullRerenderInterval = null;

function startUpdateIntervals() {
    stopUpdateIntervals();
    
    const timerInterval = window.TIMER_UPDATE_INTERVAL || 1000;
    const rerenderInterval = window.FULL_RERENDER_INTERVAL || 30000;
    
    timerUpdateInterval = setInterval(() => {
        if (flights.length > 0 && dateValidationDismissed && !isEditingField) {
            updateOnlyTimers();
        }
    }, timerInterval);

    fullRerenderInterval = setInterval(() => {
        if (flights.length > 0 && dateValidationDismissed && !isEditingField) {
            updateDisplay();
        }
    }, rerenderInterval);
}
function stopUpdateIntervals() {
    if (timerUpdateInterval) {
        clearInterval(timerUpdateInterval);
        timerUpdateInterval = null;
    }
    if (fullRerenderInterval) {
        clearInterval(fullRerenderInterval);
        fullRerenderInterval = null;
    }
}

// ========== ADD ALL THREE FUNCTIONS HERE ==========

// Track user activity


// Set up activity tracking

// Background refresh without blank screen


// Set up periodic background refresh

//  SAFETY CHECK: Clear orphaned data on page load

if (EMBEDDED_DATA !== null) {
    // Mark this as a saved HTML file
    document.body.classList.add('saved-html');
    console.log(' Loaded from saved HTML file');
    
    // Extract flight date first (needed for Firebase path)
    // Parse flightDate from YYYY-MM-DD string to avoid timezone issues
    if (EMBEDDED_DATA.flightDate) {
        const dateParts = EMBEDDED_DATA.flightDate.split('-');
        if (dateParts.length === 3) {
            // Create date using LOCAL timezone (not UTC)
            flightDate = new Date(parseInt(dateParts[0]), parseInt(dateParts[1]) - 1, parseInt(dateParts[2]));
        } else {
            // Fallback for old format (ISO string)
            flightDate = new Date(EMBEDDED_DATA.flightDate);
        }
    } else {
        flightDate = null;
    }
    
    console.log(' DEBUG EMBEDDED_DATA.flightDate raw:', EMBEDDED_DATA.flightDate);
    console.log(' DEBUG flightDate after parsing:', flightDate);
    console.log(' DEBUG flightDate instanceof Date:', flightDate instanceof Date);
    
    if (flightDate) {
        console.log(' Flight date:', flightDate.getFullYear() + '-' + String(flightDate.getMonth()+1).padStart(2,'0') + '-' + String(flightDate.getDate()).padStart(2,'0'));
        console.log(' Flight date (local):', flightDate.toLocaleDateString());
        
        // Initialize Firebase path
        initializeFirebaseRef();
        
        // CRITICAL: Check Firebase FIRST before loading embedded data
        if (firebaseInitialized && firebaseDbRef) {
            console.log(' Checking Firebase for latest data...');
            console.log(' Starting Firebase read at:', new Date().toLocaleTimeString());
            
            // Use async/await for cleaner flow and faster execution
            (async function() {
                try {
                    const snapshot = await firebaseDbRef.once('value');
                    const firebaseData = snapshot.val();
                    
                    console.log(' Firebase read completed at:', new Date().toLocaleTimeString());
                    
                    if (firebaseData && firebaseData.timestamp) {
                        // Firebase has data - check if it's newer than embedded data
                        const firebaseTimestamp = firebaseData.timestamp || 0;
                        const embeddedTimestamp = EMBEDDED_DATA.savedTimestamp || 0;
                        
                        console.log(' Firebase timestamp:', new Date(firebaseTimestamp).toLocaleString());
                        console.log(' Embedded timestamp:', new Date(embeddedTimestamp).toLocaleString());
                        
                        if (firebaseTimestamp > embeddedTimestamp) {
                            // Firebase data is NEWER - use it
                            console.log(' Firebase has newer data - loading from Firebase');
                            
                            flights = firebaseData.flights || [];
                            comments = firebaseData.comments || [];
                            deletedFlights = firebaseData.deletedFlights || [];
                            earlyOpenMode = firebaseData.earlyOpenMode || null;
                            earlyOpenFlightNumber = firebaseData.earlyOpenFlightNumber || null;
                            earlyOpenHours = firebaseData.earlyOpenHours || 3;
                            
                            console.log(' Loaded from Firebase:', flights.length, 'flights');
                        } else {
                            // Embedded data is newer or same age - use it
                            console.log(' Embedded data is newer - loading from embedded data');
                            
                            flights = EMBEDDED_DATA.flights || [];
                            comments = EMBEDDED_DATA.comments || [];
                            zoneEComments = EMBEDDED_DATA.zoneEComments || [];
                            deletedFlights = EMBEDDED_DATA.deletedFlights || [];
                            earlyOpenMode = EMBEDDED_DATA.earlyOpenMode || null;
                            earlyOpenFlightNumber = EMBEDDED_DATA.earlyOpenFlightNumber || null;
                            earlyOpenHours = EMBEDDED_DATA.earlyOpenHours || 3;
                            if (EMBEDDED_DATA.leadershipData) {
                                leadershipData = EMBEDDED_DATA.leadershipData;
                                console.log(' Loaded leadership data from embedded');
                            }
                            
                            console.log(' Loaded from embedded data:', flights.length, 'flights');
                        }
                    } else {
                        // Firebase is EMPTY - use embedded data as initial data
                        console.log(' Firebase is empty - loading from embedded data');
                        
                        flights = EMBEDDED_DATA.flights || [];
                        comments = EMBEDDED_DATA.comments || [];
                        zoneEComments = EMBEDDED_DATA.zoneEComments || [];
                        deletedFlights = EMBEDDED_DATA.deletedFlights || [];
                        earlyOpenMode = EMBEDDED_DATA.earlyOpenMode || null;
                        earlyOpenFlightNumber = EMBEDDED_DATA.earlyOpenFlightNumber || null;
                        earlyOpenHours = EMBEDDED_DATA.earlyOpenHours || 3;
                        if (EMBEDDED_DATA.leadershipData) {
                            leadershipData = EMBEDDED_DATA.leadershipData;
                            console.log(' Loaded leadership data from embedded');
                        }
                        
                        console.log(' Loaded from embedded data:', flights.length, 'flights');
                    }
                    
                } catch (error) {
                    // Firebase read failed - fall back to embedded data
                    console.error(' Firebase read error:', error);
                    console.log(' Falling back to embedded data');
                    
                    flights = EMBEDDED_DATA.flights || [];
                    comments = EMBEDDED_DATA.comments || [];
                    zoneEComments = EMBEDDED_DATA.zoneEComments || [];
                    deletedFlights = EMBEDDED_DATA.deletedFlights || [];
                    earlyOpenMode = EMBEDDED_DATA.earlyOpenMode || null;
                    earlyOpenFlightNumber = EMBEDDED_DATA.earlyOpenFlightNumber || null;
                    earlyOpenHours = EMBEDDED_DATA.earlyOpenHours || 3;
                    if (EMBEDDED_DATA.leadershipData) {
                        leadershipData = EMBEDDED_DATA.leadershipData;
                        console.log(' Loaded leadership data from embedded');
                    }
                }
                
                // ============================================
                // INITIALIZATION COMPLETE - UNLOCK SYNCING
                // ============================================
                console.log(' Initialization complete - enabling sync');
                isInitializing = false;
                
                // NOW apply date-based status logic
                dateValidationDismissed = true;
                const today = new Date();
                today.setHours(0, 0, 0, 0);
                const csvDateOnly = flightDate ? new Date(flightDate) : today;
                csvDateOnly.setHours(0, 0, 0, 0);
                
                console.log(' Date check:', {
                    today: today.toDateString(),
                    csvDate: csvDateOnly.toDateString(),
                    isSameDay: today.getTime() === csvDateOnly.getTime()
                });
                
                if (today.getTime() === csvDateOnly.getTime()) {
                    console.log(' Date matches today - using real-time calculations');
                    
                    flights.forEach(flight => {
                        if (flight.manualStatus === 'extended' && flight.extensionStartTime) {
                            const now = Date.now();
                            const extensionAge = now - flight.extensionStartTime;
                            
                            if (extensionAge >= 3600000) {
                                console.log(' Closing expired extension for:', flight.flightNumber);
                                flight.manualStatus = 'closed';
                                flight.extensionDuration = 60;
                            }
                        }
                    });
              } else if (csvDateOnly < today) {
    console.log(' Date is in the PAST - auto-closing ALL flights and making read-only');
    flights.forEach(flight => {
        flight.manualStatus = 'closed'; // Force all to closed
        flight.isReadOnly = true; // Make read-only
        console.log(' Auto-closed past flight:', flight.flightNumber);
    });
} else if (csvDateOnly > today) {
    console.log(' Date is in the FUTURE - flights editable, will show calculated status');
    flights.forEach(flight => {
        flight.isReadOnly = false; // Future dates are editable
    });
}
                
             // Hide upload button
                document.getElementById('csv-upload').style.display = 'none';
                document.querySelector('.upload-btn').style.display = 'none';
                
                // Show UI elements
                if (flights.length > 0) {
                    const dateBadge = document.getElementById('flight-date-badge');
                    dateBadge.textContent = `Flight Schedule: ${flightDate.toLocaleDateString('en-AU', { 
                        weekday: 'long', 
                        year: 'numeric', 
                        month: 'long', 
                        day: 'numeric' 
                    })}`;
                    dateBadge.style.display = 'inline-block';
                    
                    document.getElementById('save-html-btn').style.display = 'block';
                    document.getElementById('add-flight-btn').style.display = 'block';
                    document.getElementById('early-open-btn').style.display = 'block';
                    document.getElementById('reset-btn').style.display = 'block';
                    document.getElementById('add-comment-main-btn').style.display = 'block';
                    document.getElementById('refresh-all-btn').style.display = 'block';
                    document.getElementById('summary-report-btn').style.display = 'block';
                    document.getElementById('leadership-team-btn').style.display = 'block';
                    document.getElementById('pax-loads-btn').style.display = 'block';
                    document.getElementById('search-container').style.display = 'block';

                    // CRITICAL: Check for stale data BEFORE displaying anything
                    if (checkForStaleData()) {
                        console.log(' Stale data detected on load - blocking display');
                        return; // Exit early, don't display anything
                    }

                    updateDateValidationBadge();
                    updateDisplay();
                    startUpdateIntervals();
                    renderComments();
                    renderZoneEComments();
                    renderDeletedFlights();
                    updateEarlyOpenIndicator();
                    loadLeadershipData(); // Load leadership team data
                    checkAndNotifyCancellations();
                    checkAndNotifyComments();
                    checkAndNotifyZoneEComments();
                    startStaleDateMonitoring();
                }
                
                // Set up Firebase listener for real-time updates
                setupFirebaseListener();
                
                // Check for notifications
                await checkAndNotifyCancellations();
                await checkAndNotifyComments();
                
                console.log(' All initialization tasks complete');
                
                // Initialize Active User System (login + dashboard)
                initializeActiveUserSystem();
                
                // Setup busyness listeners now that everything is ready
                reinitializeBusynessListeners();
                
            })(); // Execute async function immediately
            
        } else {
            // Firebase not initialized - use embedded data
            console.log(' Firebase not initialized - using embedded data only');
            
            flights = EMBEDDED_DATA.flights || [];
            comments = EMBEDDED_DATA.comments || [];
            zoneEComments = EMBEDDED_DATA.zoneEComments || [];
            deletedFlights = EMBEDDED_DATA.deletedFlights || [];
            earlyOpenMode = EMBEDDED_DATA.earlyOpenMode || null;
            earlyOpenFlightNumber = EMBEDDED_DATA.earlyOpenFlightNumber || null;
            earlyOpenHours = EMBEDDED_DATA.earlyOpenHours || 3;
            if (EMBEDDED_DATA.leadershipData) {
                leadershipData = EMBEDDED_DATA.leadershipData;
                console.log(' Loaded leadership data from embedded');
            }
            dateValidationDismissed = true;
            
            // UNLOCK SYNCING
            isInitializing = false;
            
            // Continue with normal initialization
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            const csvDateOnly = flightDate ? new Date(flightDate) : today;
            csvDateOnly.setHours(0, 0, 0, 0);
            
            if (today.getTime() === csvDateOnly.getTime()) {
                flights.forEach(flight => {
                    if (flight.manualStatus === 'extended' && flight.extensionStartTime) {
                        const now = Date.now();
                        const extensionAge = now - flight.extensionStartTime;
                        
                        if (extensionAge >= 3600000) {
                            flight.manualStatus = 'closed';
                            flight.extensionDuration = 60;
                        }
                    }
                });
            } else if (csvDateOnly < today) {
                flights.forEach(flight => {
                    if (!flight.manualStatus || 
                        flight.manualStatus === 'open' || 
                        flight.manualStatus === 'not-open') {
                        flight.manualStatus = 'closed';
                    }
                });
            } else if (csvDateOnly > today) {
                flights.forEach(flight => {
                    flight.isReadOnly = false; // Future dates are editable
                });
            }
            
            document.getElementById('csv-upload').style.display = 'none';
            document.querySelector('.upload-btn').style.display = 'none';
            
            if (flights.length > 0) {
                const dateBadge = document.getElementById('flight-date-badge');
                dateBadge.textContent = `Flight Schedule: ${flightDate.toLocaleDateString('en-AU', { 
                    weekday: 'long', 
                    year: 'numeric', 
                    month: 'long', 
                    day: 'numeric' 
                })}`;
                dateBadge.style.display = 'inline-block';
                
                document.getElementById('save-html-btn').style.display = 'block';
document.getElementById('add-flight-btn').style.display = 'block';
document.getElementById('early-open-btn').style.display = 'block';
document.getElementById('reset-btn').style.display = 'block';
document.getElementById('add-comment-main-btn').style.display = 'block';
document.getElementById('refresh-all-btn').style.display = 'block';
document.getElementById('summary-report-btn').style.display = 'block';
document.getElementById('leadership-team-btn').style.display = 'block';
document.getElementById('pax-loads-btn').style.display = 'block';
document.getElementById('search-container').style.display = 'block';

updateDateValidationBadge();
updateDisplay();
startUpdateIntervals();
renderComments();
renderZoneEComments();
renderDeletedFlights();
updateEarlyOpenIndicator();
loadLeadershipData(); // Load leadership team data
checkAndNotifyCancellations();
checkAndNotifyZoneEComments();

// Initialize Active User System (login + dashboard)
initializeActiveUserSystem();

// Initialize Busyness Tracker
initializeBusynessTracker();

// Setup busyness listeners now that everything is ready
reinitializeBusynessListeners();
            }
        }
    }
            
} else {
    // No embedded data - allow normal CSV upload flow
    isInitializing = false;
}
loadSyncData();
initializeSearch();

// Start multi-tab detection
startMultiTabDetection();

// Start activity tracking and background refresh


// Force an immediate check after a short delay
setTimeout(() => {
    console.log(' Running immediate multi-tab check...');
    checkForMultipleTabs();
}, 1000);

// Run periodic cleanup every 30 seconds
setInterval(() => {
    cleanupOldLocalStorage();
}, 30000);
// Reset function to go back to upload screen
function resetToUploadScreen() {
    if (confirm('Are you sure you want to reset? All unsaved changes will be lost.')) {
        // ============================================
        // STOP ALL TIMERS FIRST (prevents memory leak)
        // ============================================
        stopUpdateIntervals();
        
        // Clean up Firebase listener if active
        if (firebaseListenerActive && firebaseDbRef) {
            firebaseDbRef.off('value');
            firebaseListenerActive = false;
            console.log(' Firebase listener cleaned up on reset');
        }
        
        // Clear the render cache
         
        
        // ============================================
        // NOW clear all data
        // ============================================
        flights = [];
        comments = [];
        zoneEComments = [];
        deletedFlights = [];
        flightDate = null;
        dateValidationDismissed = false;
        acknowledgedCancellations.clear();
        acknowledgedComments.clear();
        acknowledgedZoneEComments.clear();
        earlyOpenMode = null;
        earlyOpenFlightNumber = null;
        earlyOpenHours = 3;
        
        // Hide all sections
        document.getElementById('urgent-section').style.display = 'none';
        document.getElementById('active-section').style.display = 'none';
        document.getElementById('not-open-section').style.display = 'none';
        document.getElementById('closed-section').style.display = 'none';
        document.getElementById('cancelled-section').style.display = 'none';
        document.getElementById('deleted-flights-section').style.display = 'none';
        document.getElementById('comments-section').style.display = 'none';
        document.getElementById('zone-e-comments-section').style.display = 'none';
        document.getElementById('add-comment-main-btn').style.display = 'none';
        
        // Hide buttons
        document.getElementById('save-html-btn').style.display = 'none';
        document.getElementById('add-flight-btn').style.display = 'none';
        document.getElementById('reset-btn').style.display = 'none';
        document.getElementById('search-container').style.display = 'none';
        document.getElementById('early-open-btn').style.display = 'none';
        document.getElementById('refresh-all-btn').style.display = 'none';
        document.getElementById('summary-report-btn').style.display = 'none';
        document.getElementById('pax-loads-btn').style.display = 'none';
        
        // Hide badges
        document.getElementById('flight-date-badge').style.display = 'none';
        document.getElementById('date-validation-badge').style.display = 'none';
        
        // Show loading screen
        document.getElementById('loading').style.display = 'block';
        
        // Reset file input
        document.getElementById('csv-upload').value = '';
        
        // Close any open dropdowns
        closeAllDropdowns();
        
        console.log(' Reset to upload screen');
    }
}
function openEarlyOpenModal() {
    closeAllDropdowns();
    
    const overlay = document.createElement('div');
    overlay.className = 'overlay';
    
    const modal = document.createElement('div');
    modal.className = 'early-open-modal';
    
    let currentStatus = '';
    if (earlyOpenMode === 'flight' && earlyOpenFlightNumber) {
        currentStatus = `<div class="early-open-status">" Currently opening until flight: ${earlyOpenFlightNumber}</div>`;
    } else if (earlyOpenMode === 'hours') {
        currentStatus = `<div class="early-open-status">" Currently opening flights ${earlyOpenHours} hours early</div>`;
    // Add escape key support
const handleEscape = function(e) {
    if (e.key === 'Escape') {
        closeEarlyOpenModal();
        document.removeEventListener('keydown', handleEscape);
    }
};
document.addEventListener('keydown', handleEscape);}
    
   modal.innerHTML = `
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
        <div class="early-open-title" style="margin: 0;"> Open Flights Earlier</div>
        <button class="search-results-close" onclick="closeEarlyOpenModal()" style="position: static;"> </button>
    </div>
    ${currentStatus}
        <div class="early-open-option" onclick="selectEarlyOpenOption('flight')">
            <div class="early-open-option-title">Option 1: Open Until Specific Flight</div>
            <div class="early-open-option-desc">Enter a flight number to open all flights up to that departure, regardless of time</div>
        </div>
        <div class="early-open-option" onclick="selectEarlyOpenOption('hours')">
            <div class="early-open-option-title">Option 2: Open X Hours Early</div>
            <div class="early-open-option-desc">Set how many hours before departure flights should open (minimum 2 hours)</div>
        </div>
        <div class="early-open-option" onclick="clearEarlyOpen()" style="border-color: #dc2626; background: rgba(220, 38, 38, 0.05);">
            <div class="early-open-option-title" style="color: #dc2626;">Reset to Default</div>
            <div class="early-open-option-desc">Return to normal 3-hour opening logic</div>
        </div>
    `;
    
    overlay.onclick = function(e) {
    if (e.target === overlay) {
        closeEarlyOpenModal();
    }
};

document.body.appendChild(overlay);
document.body.appendChild(modal);
}

function closeEarlyOpenModal() {
    const overlay = document.querySelector('.overlay');
    const modal = document.querySelector('.early-open-modal');
    if (overlay) overlay.remove();
    if (modal) modal.remove();
    
    // Remove escape key listener if it exists
    document.removeEventListener('keydown', arguments.callee.escapeHandler);
}

function selectEarlyOpenOption(option) {
    closeEarlyOpenModal();
    
    const overlay = document.createElement('div');
    overlay.className = 'overlay';
    
    const modal = document.createElement('div');
    modal.className = 'early-open-input-modal';
    
   if (option === 'flight') {
    modal.innerHTML = `
        <div class="early-open-input-title">Enter Flight Number or Destination</div>
        <input type="text" class="early-open-input" id="early-open-flight-input" placeholder="e.g., 788, JQ788, or BNE" autocomplete="off">
        <div style="font-size: 0.85rem; color: #6b7280; margin-bottom: 1rem;">
            All flights up to and including this flight will be opened, regardless of time
        </div>
        <div id="flight-selection-area"></div>
        <div class="early-open-actions">
            <button class="early-open-cancel" onclick="closeEarlyOpenInputModal()">Cancel</button>
            <button class="early-open-confirm" onclick="confirmEarlyOpenFlight()">Confirm</button>
        </div>
    `;
    } else {
        modal.innerHTML = `
            <div class="early-open-input-title">How Many Hours Early?</div>
            <input type="number" class="early-open-input" id="early-open-hours-input" min="2" max="24" value="${earlyOpenHours}" autocomplete="off">
            <div style="font-size: 0.85rem; color: #6b7280; margin-bottom: 1rem;">
                Minimum: 2 hours | Maximum: 24 hours<br>
                All flights will open this many hours before departure
            </div>
            <div class="early-open-actions">
                <button class="early-open-cancel" onclick="closeEarlyOpenInputModal()">Cancel</button>
                <button class="early-open-confirm" onclick="confirmEarlyOpenHours()">Confirm</button>
            </div>
        `;
    }
    
   overlay.onclick = function(e) {
    if (e.target === overlay) {
        closeEarlyOpenInputModal();
    }
};

document.body.appendChild(overlay);
document.body.appendChild(modal);
    
   // Add escape key support
    const handleEscape = function(e) {
        if (e.key === 'Escape') {
            closeEarlyOpenInputModal();
            document.removeEventListener('keydown', handleEscape);
        }
    };
    document.addEventListener('keydown', handleEscape);
    
    if (option === 'flight') {
    const input = document.getElementById('early-open-flight-input');
    input.focus();
    
    // Add live search functionality
    input.addEventListener('input', function(e) {
        searchAndDisplayFlightOptions(e.target.value);
    });
    
    input.addEventListener('keydown', function(e) {
        if (e.key === 'Enter') {
            confirmEarlyOpenFlight();
        }
    });
} else {
    const input = document.getElementById('early-open-hours-input');
    input.focus();
    input.addEventListener('keydown', function(e) {
        if (e.key === 'Enter') {
            confirmEarlyOpenHours();
        }
    });
}
}
function searchAndDisplayFlightOptions(searchTerm) {
    const selectionArea = document.getElementById('flight-selection-area');
    if (!selectionArea) return;
    
    if (!searchTerm || searchTerm.length < 2) {
        selectionArea.innerHTML = '';
        return;
    }
    
    const upperSearch = searchTerm.toUpperCase();
    const cleanSearch = upperSearch.startsWith('JQ') ? upperSearch.substring(2) : upperSearch;
    
    const matchingFlights = flights.filter(f => {
        const flightNum = f.flightNumber.toUpperCase().replace('JQ', '');
        const dest = f.destination.toUpperCase();
        return flightNum.includes(cleanSearch) || dest.includes(cleanSearch);
    }).sort((a, b) => {
        return a.departureTime.localeCompare(b.departureTime);
    });
    
    if (matchingFlights.length === 0) {
        selectionArea.innerHTML = '<div style="color: #6b7280; padding: 0.5rem; text-align: center; font-size: 0.9rem;">No matching flights found</div>';
        return;
    }
    
    if (matchingFlights.length === 1) {
        selectionArea.innerHTML = `
            <div style="background: rgba(16, 185, 129, 0.1); border: 1px solid #10b981; border-radius: 0.5rem; padding: 0.75rem; margin-bottom: 1rem;">
                <div style="color: #10b981; font-weight: 600; margin-bottom: 0.25rem;"> Flight Found</div>
                <div style="color: #000345; font-weight: bold;">${matchingFlights[0].flightNumber} to ${matchingFlights[0].destination}</div>
                <div style="color: #6b7280; font-size: 0.85rem;">Departs: ${matchingFlights[0].departureTime}</div>
            </div>
        `;
        return;
    }
    
    let html = '<div style="margin-bottom: 1rem;"><div style="font-weight: 600; color: #000345; margin-bottom: 0.5rem;">Multiple flights found - select one:</div>';
    
    matchingFlights.forEach(flight => {
        html += `
            <div class="early-open-option" onclick="selectSpecificFlight('${flight.flightNumber}')" style="padding: 0.5rem; margin-bottom: 0.5rem; cursor: pointer;">
                <div style="font-weight: bold; color: #000345;">${flight.flightNumber} to ${flight.destination}</div>
                <div style="font-size: 0.85rem; color: #6b7280;">Departs: ${flight.departureTime}</div>
            </div>
        `;
    });
    
    html += '</div>';
    selectionArea.innerHTML = html;
}

function selectSpecificFlight(flightNumber) {
    document.getElementById('early-open-flight-input').value = flightNumber.replace('JQ', '');
    searchAndDisplayFlightOptions(flightNumber.replace('JQ', ''));
}
function closeEarlyOpenInputModal() {
    const overlay = document.querySelector('.overlay');
    const modal = document.querySelector('.early-open-input-modal');
    if (overlay) overlay.remove();
    if (modal) modal.remove();
    
    // Remove escape key listener if it exists
    document.removeEventListener('keydown', arguments.callee.escapeHandler);
}
async function confirmEarlyOpenFlight() {
    let input = document.getElementById('early-open-flight-input').value.trim().toUpperCase();
    
    if (!input) {
        alert('Please enter a flight number or destination');
        return;
    }
    
    // Remove JQ prefix if user typed it
    if (input.startsWith('JQ')) {
        input = input.substring(2);
    }
    
    // Try to find flight by number first
    let flight = flights.find(f => f.flightNumber.toUpperCase().replace('JQ', '') === input);
    
    // If not found by number, try by destination
    if (!flight) {
        const matchingFlights = flights.filter(f => f.destination.toUpperCase() === input);
        
        if (matchingFlights.length === 0) {
            alert(`No flight found matching "${input}"`);
            return;
        }
        
        if (matchingFlights.length > 1) {
            alert('Multiple flights found. Please select one from the list below.');
            return;
        }
        
        flight = matchingFlights[0];
    }
    
    earlyOpenMode = 'flight';
    earlyOpenFlightNumber = flight.flightNumber;
    
 closeEarlyOpenInputModal();
    
    // CRITICAL: Sync to Firebase immediately
    console.log(' Syncing early open mode to Firebase...');
    await syncData();
    
    // Broadcast to other devices
    broadcastRefreshSignal();
    
    updateDisplay();
    updateEarlyOpenIndicator();
    
    alert(`" All flights up to ${flight.flightNumber} (${flight.destination}) departing at ${flight.departureTime} will now be opened early`);
}
async function confirmEarlyOpenHours() {
    const input = parseInt(document.getElementById('early-open-hours-input').value);
    
    if (isNaN(input) || input < 2) {
        alert('Please enter a number of at least 2 hours');
        return;
    }
    
    if (input > 24) {
        alert('Maximum is 24 hours');
        return;
    }
    
    earlyOpenMode = 'hours';
    earlyOpenHours = input;
    
   closeEarlyOpenInputModal();
    
    // CRITICAL: Sync to Firebase immediately
    console.log(' Syncing early open mode to Firebase...');
    await syncData();
    
    // Broadcast to other devices
    broadcastRefreshSignal();
    
    updateDisplay();
    updateEarlyOpenIndicator();
    
    alert(`" All flights will now open ${input} hours before their departure time`);
}
async function clearEarlyOpen() {
    earlyOpenMode = null;
    earlyOpenFlightNumber = null;
    earlyOpenHours = 3;
    
   closeEarlyOpenModal();
    
    // CRITICAL: Sync to Firebase immediately
    console.log(' Clearing early open mode on Firebase...');
    await syncData();
    
    // Broadcast to other devices
    broadcastRefreshSignal();
    
    updateDisplay();
    updateEarlyOpenIndicator();
    
    alert('" Reset to default 3-hour opening logic');
}
function showEarlyOpenStatus(event) {
    event.stopPropagation();
    closeAllDropdowns();
    
    const overlay = document.createElement('div');
    overlay.className = 'overlay';
    
    const popup = document.createElement('div');
    popup.className = 'early-open-status-popup';
    
    let statusMessage = '';
    
    if (earlyOpenMode === 'flight' && earlyOpenFlightNumber) {
        const flight = flights.find(f => f.flightNumber.toUpperCase() === earlyOpenFlightNumber.toUpperCase());
        if (flight) {
            statusMessage = `Flights are currently opening up to and including flight <strong>${earlyOpenFlightNumber}</strong> to <strong>${flight.destination}</strong>, departing at <strong>${flight.departureTime}</strong>`;
        } else {
            statusMessage = `Flights are currently opening up to flight <strong>${earlyOpenFlightNumber}</strong>`;
        }
    } else if (earlyOpenMode === 'hours') {
        statusMessage = `Flights are currently opening <strong>${earlyOpenHours} hours</strong> before their departure time`;
    }
    
    popup.innerHTML = `
        <div class="early-open-status-title">
            <span></span>
            <span>Early Opening Active</span>
        </div>
        <div class="early-open-status-message">
            ${statusMessage}
        </div>
        <button class="early-open-status-close" onclick="closeEarlyOpenStatusPopup()">Got it</button>
    `;
    
    overlay.onclick = closeEarlyOpenStatusPopup;
    
    document.body.appendChild(overlay);
    document.body.appendChild(popup);
}

function closeEarlyOpenStatusPopup() {
    const overlay = document.querySelector('.overlay');
    const popup = document.querySelector('.early-open-status-popup');
    if (overlay) overlay.remove();
    if (popup) popup.remove();
}

function updateEarlyOpenIndicator() {
    const indicator = document.getElementById('early-open-indicator');
    if (!indicator) return;
    
    if (earlyOpenMode === 'flight' || earlyOpenMode === 'hours') {
        indicator.style.display = 'inline-flex';
    } else {
        indicator.style.display = 'none';
    }
}
// ============================================
// CANCELLATION NOTIFICATION SYSTEM
// ============================================

/**
 * Check if a cancellation should trigger a notification
 * Rules:
 * 1. Flight must be cancelled
 * 2. Flight must depart within 4 hours from now
 * 3. User must not have already acknowledged this cancellation
 * 4. Cancellation must have occurred (cancelledAt timestamp exists)
 */
function shouldShowCancellationNotification(flight) {
    if (!flight.cancelledAt || flight.manualStatus !== 'cancelled') {
        return false;
    }
    
    // Check if already acknowledged by this user
    if (acknowledgedCancellations.has(flight.id)) {
        return false;
    }
    
    // Calculate time until departure
    const now = new Date();
    const [hours, minutes] = flight.departureTime.split(':').map(Number);
    const departureToday = new Date(now.getFullYear(), now.getMonth(), now.getDate(), hours, minutes);
    
    // If departure is in the past, don't show notification
    if (departureToday < now) {
        return false;
    }
    
    // Calculate hours until departure
    const hoursUntilDeparture = (departureToday - now) / (1000 * 60 * 60);
    
    // Show notification if departure is within 4 hours
    return hoursUntilDeparture <= 4;
}

/**
 * Show cancellation notification modal
 */
function showCancellationNotification(flight) {
    console.log(' Showing cancellation notification for:', flight.flightNumber);
    
    // Create overlay
    const overlay = document.createElement('div');
    overlay.className = 'cancellation-notification-overlay';
    overlay.style.zIndex = '10003';
    
    // Create notification modal
    const notification = document.createElement('div');
    notification.className = 'cancellation-notification';
    
    // Format timestamps
    const cancelledTime = new Date(flight.cancelledAt).toLocaleString('en-AU', {
        year: 'numeric',
        month: 'short',
        day: 'numeric',
        hour: '2-digit',
        minute: '2-digit',
        hour12: false
    });
    
    // Build approval info HTML if available
    let approvalInfoHtml = '';
    if (flight.approverName) {
        approvalInfoHtml = `
            <div class="cancellation-detail" style="margin-top: 1rem; padding-top: 1rem; border-top: 2px solid rgba(220, 38, 38, 0.2);">
                <span class="cancellation-label">Actioned By:</span>
                <span class="cancellation-value">${flight.approverName}</span>
            </div>
            <div class="cancellation-detail">
                <span class="cancellation-label">Position:</span>
                <span class="cancellation-value">${flight.approverPosition || 'Not specified'}</span>
            </div>
            ${flight.supervisorName ? `
                <div class="cancellation-detail">
                    <span class="cancellation-label">Approved By:</span>
                    <span class="cancellation-value">${flight.supervisorName}</span>
                </div>
            ` : ''}
        `;
    }
    
    // Build notification content
    notification.innerHTML = `
        <div class="cancellation-notification-header">
            <div class="cancellation-notification-icon"></div>
            <div class="cancellation-notification-title">FLIGHT CANCELLED</div>
        </div>
        
        <div class="cancellation-notification-body">
            <div class="cancellation-detail">
                <span class="cancellation-label">Flight Number:</span>
                <span class="cancellation-value">${flight.flightNumber}</span>
            </div>
            <div class="cancellation-detail">
                <span class="cancellation-label">Destination:</span>
                <span class="cancellation-value">${flight.destination}</span>
            </div>
            <div class="cancellation-detail">
                <span class="cancellation-label">Scheduled Departure:</span>
                <span class="cancellation-value">${flight.departureTime}</span>
            </div>
            <div class="cancellation-detail">
                <span class="cancellation-label">Cancelled At:</span>
                <span class="cancellation-value">${cancelledTime}</span>
            </div>
            
            <div class="cancellation-reason">
                <span class="cancellation-label">Cancellation Reason:</span>
                <span class="cancellation-value-reason">${flight.cancelReason || 'Not specified'}</span>
            </div>
            
            ${approvalInfoHtml}
        </div>
        
        <button class="cancellation-acknowledge-btn" onclick="acknowledgeCancellation(${flight.id})">
            I Acknowledge This Cancellation
        </button>
    `;
    
    // Prevent closing by clicking overlay
    overlay.onclick = function(e) {
        if (e.target === overlay) {
            e.preventDefault();
            e.stopPropagation();
        }
    };
    
    document.body.appendChild(overlay);
    overlay.appendChild(notification);
    
    console.log(' Cancellation notification displayed');
}

/**
 * User acknowledges a cancellation
 */
function acknowledgeCancellation(flightId) {
    console.log('" User acknowledged cancellation:', flightId);
    
    // Add to acknowledged set
    acknowledgedCancellations.add(flightId);
    
    // Save to localStorage so it persists across page reloads
    try {
        const acknowledged = Array.from(acknowledgedCancellations);
        localStorage.setItem('acknowledged_cancellations', JSON.stringify(acknowledged));
    } catch (e) {
        console.error('Error saving acknowledged cancellations:', e);
    }
    
    // Remove the notification INSTANTLY
    const overlay = document.querySelector('.cancellation-notification-overlay');
    if (overlay) {
        overlay.remove(); // Direct removal, no fade
    }
    
    console.log(' Notification dismissed');
}

/**
 * Check all flights for cancellations that need notification
 */
async function checkAndNotifyCancellations() {
    console.log(' Checking for cancellations that need notification...');
    
    // Load previously acknowledged cancellations
    try {
        const stored = localStorage.getItem('acknowledged_cancellations');
        if (stored) {
            const acknowledged = JSON.parse(stored);
            acknowledged.forEach(id => acknowledgedCancellations.add(id));
        }
    } catch (e) {
        console.error('Error loading acknowledged cancellations:', e);
    }
    
    // Find cancelled flights that need notification
    const needsNotification = flights.filter(flight => shouldShowCancellationNotification(flight));
    
    if (needsNotification.length > 0) {
        console.log(` Found ${needsNotification.length} cancellation(s) to notify`);
        
        // Show notifications one at a time
        for (const flight of needsNotification) {
            // Wait for previous notification to be acknowledged
            await new Promise((resolve) => {
                showCancellationNotification(flight);
                
                // Check every 500ms if this notification has been acknowledged
                const checkInterval = setInterval(() => {
                    if (acknowledgedCancellations.has(flight.id)) {
                        clearInterval(checkInterval);
                        resolve();
                    }
                }, 500);
            });
        }
        
        console.log(' All cancellation notifications processed');
    } else {
        console.log('" No cancellations need notification');
    }
}
// ============================================
// COMMENT NOTIFICATION SYSTEM
// ============================================

/**
 * Check if a comment should trigger a notification
 */
function shouldShowCommentNotification(comment) {
    // Don't notify if already acknowledged
    if (acknowledgedComments.has(comment.id)) {
        return false;
    }
    
    // Only notify for comments added in the last 5 minutes
    const commentAge = Date.now() - new Date(comment.timestamp).getTime();
    const fiveMinutes = 5 * 60 * 1000;
    
    return commentAge < fiveMinutes;
}

/**
 * Show comment notification
 */
function showCommentNotification(comment) {
    console.log(' Showing comment notification:', comment.id);
    
    // Check if notification already exists
    if (document.querySelector('.comment-notification-popup')) {
        console.log(' Notification already visible, skipping');
        return;
    }
    
    // Create notification popup
    const notification = document.createElement('div');
    notification.className = 'comment-notification-popup';
    notification.id = `comment-notif-${comment.id}`;
    
    // Format timestamp - ensure it's a number
let timestampValue = comment.timestamp;
if (typeof timestampValue !== 'number') {
    timestampValue = new Date(timestampValue).getTime();
}

const timestamp = new Date(timestampValue).toLocaleString('en-AU', {
    month: 'short',
    day: 'numeric',
    hour: '2-digit',
    minute: '2-digit',
    hour12: false
});
    
    // Truncate long comments
    let previewText = comment.text;
    if (previewText.length > 150) {
        previewText = previewText.substring(0, 147) + '...';
    }
    
    notification.innerHTML = `
        <div class="comment-notification-header">
            <div class="comment-notification-icon"></div>
            <div class="comment-notification-title">New Comment Added</div>
        </div>
        
        <div class="comment-notification-body">
            <div class="comment-notification-time">${timestamp}</div>
            <div class="comment-notification-preview">${previewText}</div>
        </div>
        
        <button class="comment-notification-acknowledge" onclick="acknowledgeComment(${comment.id})">
            " Acknowledge
        </button>
    `;
    
    document.body.appendChild(notification);
    
    // Auto-dismiss after 5 minutes
    setTimeout(() => {
        if (document.getElementById(`comment-notif-${comment.id}`)) {
            acknowledgeComment(comment.id);
        }
    }, 5 * 60 * 1000);
    
    console.log(' Comment notification displayed');
}
/**
 * Show notification when a comment is edited
 */
function showCommentEditNotification(comment) {
    console.log(' Showing comment edit notification:', comment.id);
    
    // Check if notification already exists
    if (document.querySelector('.comment-notification-popup')) {
        console.log(' Notification already visible, skipping');
        return;
    }
    
    // Create notification popup
    const notification = document.createElement('div');
    notification.className = 'comment-notification-popup';
    notification.id = `comment-edit-notif-${comment.id}`;
    
    // Format timestamp
    const editedTime = new Date(comment.editedAt).toLocaleString('en-AU', {
        month: 'short',
        day: 'numeric',
        hour: '2-digit',
        minute: '2-digit',
        hour12: false
    });
    
    // Truncate long comments
    let previewText = comment.text;
    if (previewText.length > 150) {
        previewText = previewText.substring(0, 147) + '...';
    }
    
    notification.innerHTML = `
        <div class="comment-notification-header">
            <div class="comment-notification-icon"></div>
            <div class="comment-notification-title">Comment Edited</div>
        </div>
        
        <div class="comment-notification-body">
            <div class="comment-notification-time">Edited at ${editedTime}</div>
            <div class="comment-notification-preview">${previewText}</div>
        </div>
        
        <button class="comment-notification-acknowledge" onclick="acknowledgeCommentEdit('${notification.id}')">
            " Acknowledge
        </button>
    `;
    
    document.body.appendChild(notification);
    
    // Auto-dismiss after 5 minutes
    setTimeout(() => {
        if (document.getElementById(notification.id)) {
            acknowledgeCommentEdit(notification.id);
        }
    }, 5 * 60 * 1000);
    
    console.log(' Comment edit notification displayed');
}

/**
 * Acknowledge comment edit notification
 */
function acknowledgeCommentEdit(notificationId) {
    console.log('" User acknowledged comment edit');
    
    const notification = document.getElementById(notificationId);
    if (notification) {
        notification.classList.add('fade-out');
        setTimeout(() => {
            notification.remove();
        }, 300);
    }
}
/**
 * User acknowledges a comment notification
 */
function acknowledgeComment(commentId) {
    console.log('" User acknowledged comment:', commentId);
    
    // Add to acknowledged set
    acknowledgedComments.add(commentId);
    
    // Save to localStorage
    try {
        const acknowledged = Array.from(acknowledgedComments);
        localStorage.setItem('acknowledged_comments', JSON.stringify(acknowledged));
    } catch (e) {
        console.error('Error saving acknowledged comments:', e);
    }
    
    // Remove the notification with fade-out animation
    const notification = document.getElementById(`comment-notif-${commentId}`);
    if (notification) {
        notification.classList.add('fade-out');
        setTimeout(() => {
            notification.remove();
        }, 300);
    }
    
    console.log(' Comment notification dismissed');
}

/**
 * Check all comments for ones that need notification
 */
async function checkAndNotifyComments() {
    console.log(' Checking for comment notifications...');
    
    // Load previously acknowledged comments
    try {
        const stored = localStorage.getItem('acknowledged_comments');
        if (stored) {
            const acknowledged = JSON.parse(stored);
            acknowledged.forEach(id => acknowledgedComments.add(id));
        }
    } catch (e) {
        console.error('Error loading acknowledged comments:', e);
    }
    
    // Find comments that need notification
    const needsNotification = comments.filter(comment => shouldShowCommentNotification(comment));
    
    if (needsNotification.length > 0) {
        console.log(` Found ${needsNotification.length} comment(s) to notify`);
        
        // Show only the most recent comment notification
        const mostRecent = needsNotification.sort((a, b) => 
            new Date(b.timestamp) - new Date(a.timestamp)
        )[0];
        
        showCommentNotification(mostRecent);
    } else {
        console.log('" No comments need notification');
    }
}
// ============================================
// ENHANCED CANCELLATION APPROVAL SYSTEM
// ============================================

/**
 * Show cancellation approval modal before cancelling flight
 */
function showCancellationApprovalModal(flight) {
    console.log(' Showing cancellation approval modal for:', flight.flightNumber);
    
    closeAllDropdowns();
    
    const overlay = document.createElement('div');
    overlay.className = 'overlay';
    overlay.style.zIndex = '10001';
    
    const modal = document.createElement('div');
    modal.className = 'cancellation-approval-modal';
    modal.id = 'cancellation-approval-modal';
    
    modal.innerHTML = `
        <div class="cancellation-approval-header">
            <div class="cancellation-approval-icon"></div>
            <div class="cancellation-approval-title">Cancel Flight Approval</div>
        </div>
        
        <div class="cancellation-approval-flight-info">
            <div class="cancellation-approval-flight-detail">
                <span class="cancellation-approval-label">Flight Number:</span>
                <span class="cancellation-approval-value">${flight.flightNumber}</span>
            </div>
            <div class="cancellation-approval-flight-detail">
                <span class="cancellation-approval-label">Destination:</span>
                <span class="cancellation-approval-value">${flight.destination}</span>
            </div>
            <div class="cancellation-approval-flight-detail">
                <span class="cancellation-approval-label">Departure Time:</span>
                <span class="cancellation-approval-value">${flight.departureTime}</span>
            </div>
        </div>
        
        <div class="cancellation-approval-warning">
             You are about to CANCEL this flight. Please complete ALL required fields below.
        </div>
        
        <form class="cancellation-approval-form" id="cancellation-approval-form" onsubmit="return false;">
            <!-- Name Field -->
            <div class="cancellation-approval-field">
                <label class="cancellation-approval-field-label required">Your Full Name</label>
                <input 
                    type="text" 
                    class="cancellation-approval-input" 
                    id="cancel-approver-name"
                    placeholder="Enter your full name"
                    autocomplete="off"
                    required
                >
                <div class="cancellation-approval-error-msg" id="cancel-name-error">Please enter your name</div>
            </div>
            
       <!-- Position Field -->
<div class="cancellation-approval-field">
    <label class="cancellation-approval-field-label required">Your Position</label>
    <select 
        class="cancellation-approval-select" 
        id="cancel-approver-position"
        required
    >
        <option value="">-- Select Position --</option>
    <option value="TAM">TAM</option>
<option value="Relief TAM">Relief TAM</option>
<option value="ROS">ROS</option>
<option value="Relief ROS">Relief ROS</option>
<option value="Team Leader">Team Leader</option>
<option value="Relief Team Leader">Relief Team Leader</option>
<option value="Customer Service Officer">Customer Service Officer</option>
    </select>
    <div class="cancellation-approval-error-msg" id="cancel-position-error">Please select your position</div>
</div>

<!-- Approver Name (conditional - only for "Other") -->
<div class="cancellation-approval-field" id="cancel-approver-field" style="display: none;">
    <label class="cancellation-approval-field-label required">Name of Approver</label>
    <input 
        type="text" 
        class="cancellation-approval-input" 
        id="cancel-approver-name-input"
        placeholder="Enter approver's name"
        autocomplete="off"
    >
    <div class="cancellation-approval-error-msg" id="cancel-approver-error">Please enter approver's name</div>
</div>

<!-- NEW: Cancellation Reason Field -->
<div class="cancellation-approval-field">
    <label class="cancellation-approval-field-label required">Cancellation Reason</label>
    <select 
        class="cancellation-approval-select" 
        id="cancel-reason-select"
        required
    >
        <option value="">-- Select Reason --</option>
        <option value="Engineering">Engineering</option>
        <option value="Crewing">Crewing</option>
        <option value="Operational Requirements">Operational Requirements</option>
        <option value="Weather">Weather</option>
        <option value="ATC Staff Shortage">ATC Staff Shortage</option>
        <option value="Aircraft Damage">Aircraft Damage</option>
        <option value="Other">Other</option>
    </select>
    <div class="cancellation-approval-error-msg" id="cancel-reason-error">Please select a cancellation reason</div>
</div>

<!-- Custom Reason (conditional - only for "Other") -->
<div class="cancellation-approval-field" id="cancel-custom-reason-field" style="display: none;">
    <label class="cancellation-approval-field-label required">Specify Custom Reason</label>
    <input 
        type="text" 
        class="cancellation-approval-input" 
        id="cancel-custom-reason-input"
        placeholder="Enter custom cancellation reason"
        autocomplete="off"
    >
    <div class="cancellation-approval-error-msg" id="cancel-custom-reason-error">Please specify the reason</div>
</div>

<!-- Keep the original approver field here -->
<div class="cancellation-approval-field" id="cancel-approver-field-hidden" style="display: none;">
                <label class="cancellation-approval-field-label required">Name of Approver</label>
                <input 
                    type="text" 
                    class="cancellation-approval-input" 
                    id="cancel-approver-name-input"
                    placeholder="Enter approver's name"
                    autocomplete="off"
                >
                <div class="cancellation-approval-error-msg" id="cancel-approver-error">Please enter approver's name</div>
            </div>
            
            <div class="cancellation-approval-actions">
                <button type="button" class="cancellation-approval-cancel" onclick="closeCancellationApprovalModal()">
                    Cancel
                </button>
                <button type="button" class="cancellation-approval-submit" onclick="submitCancellationApproval(${flight.id})">
                    Confirm Cancellation
                </button>
            </div>
        </form>
    `;
    
    // Prevent closing by clicking overlay
    overlay.onclick = function(e) {
        if (e.target === overlay) {
            e.preventDefault();
            e.stopPropagation();
        }
    };
    
    document.body.appendChild(overlay);
    document.body.appendChild(modal);
    
    // Set up position selector change handler
    const positionSelect = document.getElementById('cancel-approver-position');
    const approverField = document.getElementById('cancel-approver-field');
    
positionSelect.addEventListener('change', function() {
    if (this.value === 'Customer Service Officer') {
        approverField.style.display = 'flex';
        document.getElementById('cancel-approver-name-input').required = true;
    } else {
        approverField.style.display = 'none';
        document.getElementById('cancel-approver-name-input').required = false;
        document.getElementById('cancel-approver-name-input').value = '';
    }
});
    // Set up cancellation reason selector change handler
const reasonSelect = document.getElementById('cancel-reason-select');
const customReasonField = document.getElementById('cancel-custom-reason-field');

reasonSelect.addEventListener('change', function() {
    if (this.value === 'Other') {
        customReasonField.style.display = 'flex';
        document.getElementById('cancel-custom-reason-input').required = true;
    } else {
        customReasonField.style.display = 'none';
        document.getElementById('cancel-custom-reason-input').required = false;
        document.getElementById('cancel-custom-reason-input').value = '';
    }
});
    
    // Focus on first field
    document.getElementById('cancel-approver-name').focus();
    
    console.log(' Cancellation approval modal displayed');
}

/**
 * Close cancellation approval modal
 */
function closeCancellationApprovalModal() {
    const overlay = document.querySelector('.overlay');
    const modal = document.getElementById('cancellation-approval-modal');
    
    if (overlay) overlay.remove();
    if (modal) modal.remove();
    
    console.log(' Cancellation approval modal closed');
}

/**
 * Validate and submit cancellation approval
 */
/**
 * Validate and submit cancellation approval
 */
async function submitCancellationApproval(flightId) {
    console.log(' Validating cancellation approval...');
    
    // Get form values
    const name = document.getElementById('cancel-approver-name').value.trim();
    const position = document.getElementById('cancel-approver-position').value;
    const approverName = document.getElementById('cancel-approver-name-input').value.trim();
    const reason = document.getElementById('cancel-reason-select').value;
    const customReason = document.getElementById('cancel-custom-reason-input').value.trim();
    
    // Validate fields
    let hasErrors = false;
    
    // Validate name
    const nameInput = document.getElementById('cancel-approver-name');
    const nameError = document.getElementById('cancel-name-error');
    if (!name) {
        nameInput.classList.add('error');
        nameError.classList.add('show');
        hasErrors = true;
    } else {
        nameInput.classList.remove('error');
        nameError.classList.remove('show');
    }
    
    // Validate position
    const positionSelect = document.getElementById('cancel-approver-position');
    const positionError = document.getElementById('cancel-position-error');
    if (!position) {
        positionSelect.classList.add('error');
        positionError.classList.add('show');
        hasErrors = true;
    } else {
        positionSelect.classList.remove('error');
        positionError.classList.remove('show');
    }
    
    // Validate approver name if "Other" is selected
    const approverInput = document.getElementById('cancel-approver-name-input');
    const approverError = document.getElementById('cancel-approver-error');
    if (position === 'Customer Service Officer' && !approverName) {
    approverInput.classList.add('error');
    approverError.classList.add('show');
    hasErrors = true;
} else {
        approverInput.classList.remove('error');
        approverError.classList.remove('show');
    }
    
    // Validate reason
    const reasonSelect = document.getElementById('cancel-reason-select');
    const reasonError = document.getElementById('cancel-reason-error');
    if (!reason) {
        reasonSelect.classList.add('error');
        reasonError.classList.add('show');
        hasErrors = true;
    } else {
        reasonSelect.classList.remove('error');
        reasonError.classList.remove('show');
    }
    
    // Validate custom reason if "Other" is selected
    const customReasonInput = document.getElementById('cancel-custom-reason-input');
    const customReasonError = document.getElementById('cancel-custom-reason-error');
    if (reason === 'Other' && !customReason) {
        customReasonInput.classList.add('error');
        customReasonError.classList.add('show');
        hasErrors = true;
    } else {
        customReasonInput.classList.remove('error');
        customReasonError.classList.remove('show');
    }
    
    if (hasErrors) {
        console.log(' Validation errors found');
        return;
    }
    
    console.log(' Validation passed');
    
    // Determine final cancellation reason
    const finalReason = reason === 'Other' ? customReason : reason;
    
    // Find the flight
    const flight = flights.find(f => f.id === flightId);
    if (!flight) {
        console.error(' Flight not found:', flightId);
        return;
    }
    
    // Close the approval modal
    closeCancellationApprovalModal();
    
// Set flight to cancelled WITH the reason
flight.manualStatus = 'cancelled';
flight.cancelledAt = Date.now();
flight.cancelReason = finalReason;
flight.approverName = name;
flight.approverPosition = position;
flight.supervisorName = position === 'Customer Service Officer' ? approverName : null;
    
    
    
// Create approval info object
const approvalInfo = {
    approverName: name,
    approverPosition: position,
    supervisorName: position === 'Customer Service Officer' ? approverName : null,
    cancellationReason: finalReason,
    timestamp: Date.now(),
    timestampFormatted: new Date().toLocaleString('en-AU', {
        year: 'numeric',
        month: 'short',
        day: 'numeric',
        hour: '2-digit',
        minute: '2-digit',
        second: '2-digit',
        hour12: false
    })
};
    // Broadcast cancellation with ALL info to other users
    const cancellationBroadcast = {
        action: 'flight_cancelled_with_approval',
        flightId: flight.id,
        flightNumber: flight.flightNumber,
        destination: flight.destination,
        departureTime: flight.departureTime,
        cancelledAt: flight.cancelledAt,
        cancelReason: finalReason, // Include in broadcast
        approvalInfo: approvalInfo,
        fromSession: sessionId,
        timestamp: Date.now()
    };
    
    console.log(' Broadcasting cancellation with full approval info:', cancellationBroadcast);
    
    // Send via localStorage (for same-device tabs)
    localStorage.setItem('cancellation_broadcast', JSON.stringify(cancellationBroadcast));
    
    // Send via Firebase (for other devices)
    if (firebaseInitialized) {
        const cancellationRef = firebase.database().ref(getFirebasePath('cancellation_broadcast'));
        await cancellationRef.push(cancellationBroadcast);
        console.log(' Cancellation broadcast sent via Firebase');
    }
    
    // Update display immediately for User 1
    updateDisplay();
    
    // Sync flight status to Firebase
    await syncData();
    
    // IMPORTANT: User 1 does NOT see the notification - they cancelled it
    console.log(' Flight cancelled - User 1 will not see notification');
    
    // Mark this cancellation as already acknowledged for User 1
    acknowledgedCancellations.add(flight.id);
    try {
        const acknowledged = Array.from(acknowledgedCancellations);
        localStorage.setItem('acknowledged_cancellations', JSON.stringify(acknowledged));
    } catch (e) {
        console.error('Error saving acknowledged cancellations:', e);
    }
}
/**
 * Show cancellation notification with approval information
 * (Approval data is passed as parameter, NOT stored in flight object)
 */
function showCancellationNotificationWithApproval(flight, approvalData) {
    console.log(' Showing cancellation notification with approval data');
    
    // Create overlay
    const overlay = document.createElement('div');
    overlay.className = 'cancellation-notification-overlay';
    overlay.style.zIndex = '10003';
    
    // Create notification modal
    const notification = document.createElement('div');
    notification.className = 'cancellation-notification';
    
    // Format cancelled time
    const cancelledTime = new Date(flight.cancelledAt).toLocaleString('en-AU', {
        year: 'numeric',
        month: 'short',
        day: 'numeric',
        hour: '2-digit',
        minute: '2-digit',
        hour12: false
    });
    
    // Build notification content with approval info
    notification.innerHTML = `
        <div class="cancellation-notification-header">
            <div class="cancellation-notification-icon"></div>
            <div class="cancellation-notification-title">FLIGHT CANCELLED</div>
        </div>
        
        <div class="cancellation-notification-body">
            <div class="cancellation-detail">
                <span class="cancellation-label">Flight Number:</span>
                <span class="cancellation-value">${flight.flightNumber}</span>
            </div>
            <div class="cancellation-detail">
                <span class="cancellation-label">Destination:</span>
                <span class="cancellation-value">${flight.destination}</span>
            </div>
            <div class="cancellation-detail">
                <span class="cancellation-label">Scheduled Departure:</span>
                <span class="cancellation-value">${flight.departureTime}</span>
            </div>
            <div class="cancellation-detail">
                <span class="cancellation-label">Cancelled At:</span>
                <span class="cancellation-value">${cancelledTime}</span>
            </div>
            <div class="cancellation-reason">
    <span class="cancellation-label">Cancellation Reason:</span>
    <span class="cancellation-value-reason">${approvalData.cancellationReason || 'Not specified'}</span>
</div>

<div class="cancellation-detail" style="margin-top: 1rem; padding-top: 1rem; border-top: 2px solid rgba(220, 38, 38, 0.2);">
    <span class="cancellation-label">Actioned By:</span>
    <span class="cancellation-value">${approvalData.approverName}</span>
</div>
<div class="cancellation-detail">
    <span class="cancellation-label">Position:</span>
    <span class="cancellation-value">${approvalData.approverPosition}</span>
</div>
${approvalData.supervisorName ? `
    <div class="cancellation-detail">
        <span class="cancellation-label">Approved By:</span>
        <span class="cancellation-value">${approvalData.supervisorName}</span>
    </div>
` : ''}
<div class="cancellation-detail">
    <span class="cancellation-label">Approved At:</span>
    <span class="cancellation-value">${approvalData.timestampFormatted}</span>
</div>
        </div>
        
        <button class="cancellation-acknowledge-btn" onclick="acknowledgeCancellationWithApproval(${flight.id})">
            I Acknowledge This Cancellation
        </button>
    `;
    
    // Prevent closing by clicking overlay
    overlay.onclick = function(e) {
        if (e.target === overlay) {
            e.preventDefault();
            e.stopPropagation();
        }
    };
    
    document.body.appendChild(overlay);
    overlay.appendChild(notification);
    
    console.log(' Cancellation notification with approval displayed');
}

/**
 * Acknowledge cancellation (same as before, but called from approval flow)
 */
function acknowledgeCancellationWithApproval(flightId) {
    console.log('" User acknowledged cancellation with approval:', flightId);
    
    // Add to acknowledged set
    acknowledgedCancellations.add(flightId);
    
    // Save to localStorage
    try {
        const acknowledged = Array.from(acknowledgedCancellations);
        localStorage.setItem('acknowledged_cancellations', JSON.stringify(acknowledged));
    } catch (e) {
        console.error('Error saving acknowledged cancellations:', e);
    }
    
    // Remove the notification INSTANTLY
    const overlay = document.querySelector('.cancellation-notification-overlay');
    if (overlay) {
        overlay.remove(); // Direct removal, no fade
    }
    
    console.log(' Notification dismissed - reason was shown in notification');
}
console.log(' Enhanced cancellation approval system initialized');
console.log(' Comment notification system initialized');
// Add shake animation to CSS (if user tries to close without acknowledging)
const shakeStyle = document.createElement('style');
shakeStyle.textContent = `
    @keyframes shake {
        0%, 100% { transform: translateX(0); }
        10%, 30%, 50%, 70%, 90% { transform: translateX(-10px); }
        20%, 40%, 60%, 80% { transform: translateX(10px); }
    }
`;
document.head.appendChild(shakeStyle);

console.log(' Cancellation notification system initialized');
// ========== CLEANUP ON PAGE UNLOAD ==========
window.addEventListener('beforeunload', function() {
    console.log(' Page unloading - cleaning up resources');
    
    // Clean up multi-tab detection
    if (heartbeatInterval) {
        clearInterval(heartbeatInterval);
    }
    if (multiTabCheckInterval) {
        clearInterval(multiTabCheckInterval);
    }
    
    // Clean up Firebase listener
    if (firebaseDbRef && firebaseListenerActive) {
        firebaseDbRef.off('value');
        firebaseListenerActive = false;
        console.log(' Firebase listener cleaned up');
    }
    
    // Clear all timers
  
    if (syncTimeout) {
        clearTimeout(syncTimeout);
    }
    
    console.log(' All resources cleaned up on page unload');
});
// ============================================
// STALE DATE DETECTION SYSTEM (INSTANT CHECK)
// ============================================

// Flag to prevent multiple alerts
let staleDateAlertShown = false;

/**
 * Check if the loaded data is from a different date than today
 * Returns TRUE if stale, FALSE if OK
 */
function checkForStaleData() {
    if (!flightDate || flights.length === 0) {
        return false;
    }
    
    // Prevent multiple alerts
    if (staleDateAlertShown) {
        return true; // Already handled
    }
    
    const today = new Date();
    today.setHours(0, 0, 0, 0);
    
    const dataDate = new Date(flightDate);
    dataDate.setHours(0, 0, 0, 0);
    
    //  ONLY block if date is IN THE PAST (not future)
    if (dataDate.getTime() < today.getTime()) {
        console.log(' PAST DATE DETECTED - BLOCKING ACCESS');
        
        // Set flag immediately to prevent multiple triggers
        staleDateAlertShown = true;
        
        // Stop all timers and listeners
        stopUpdateIntervals();
        if (heartbeatInterval) clearInterval(heartbeatInterval);
        if (multiTabCheckInterval) clearInterval(multiTabCheckInterval);
        
        // Remove any existing overlays/modals first
        const existingOverlays = document.querySelectorAll('.overlay, .stale-date-warning-overlay');
        existingOverlays.forEach(el => el.remove());
        
        // Hide everything and show access denied screen (no alert - cleaner UX)
        document.body.innerHTML = `
            <div style="display: flex; align-items: center; justify-content: center; height: 100vh; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; background: white; color: #dc2626; text-align: center; padding: 2rem;">
                <div style="max-width: 500px;">
                    <div style="font-size: 4rem; margin-bottom: 1rem;"></div>
                    <h1 style="font-size: 2rem; margin-bottom: 0.5rem;">Past Date - Access Denied</h1>
                    <p style="color: #6b7280; font-size: 1.1rem; margin-bottom: 1.5rem;">This data is from a previous date and cannot be accessed.</p>
                    <p style="color: #6b7280; font-size: 0.95rem;">Please close this tab and load today's data.</p>
                    <button onclick="window.close(); setTimeout(() => location.reload(true), 500);" style="margin-top: 1.5rem; padding: 0.75rem 2rem; background: #dc2626; color: white; border: none; border-radius: 0.5rem; font-size: 1rem; font-weight: bold; cursor: pointer;">Close Tab</button>
                </div>
            </div>
        `;
        
        return true;
    }
    
    //  Future dates are OK - return false (no blocking)
    return false;
}

/**
 * Show stale date warning modal
 */
function showStaleDateWarning(dataDate, today) {
    // Check if warning already exists
    if (document.querySelector('.stale-date-warning-overlay')) {
        return;
    }
    
    const overlay = document.createElement('div');
    overlay.className = 'stale-date-warning-overlay';
    
    const modal = document.createElement('div');
    modal.className = 'stale-date-warning-modal';
    
    const dataDaysDiff = Math.floor((today - dataDate) / (1000 * 60 * 60 * 24));
    let timeframeText = '';
    
    if (dataDaysDiff === 1) {
        timeframeText = 'This data is from <strong>yesterday</strong>.';
    } else if (dataDaysDiff > 1) {
        timeframeText = `This data is from <strong>${dataDaysDiff} days ago</strong>.`;
    } else if (dataDaysDiff === -1) {
        timeframeText = 'This data is from <strong>tomorrow</strong> (future date).';
    } else if (dataDaysDiff < -1) {
        timeframeText = `This data is from <strong>${Math.abs(dataDaysDiff)} days in the future</strong>.`;
    }
    
    modal.innerHTML = `
        <div class="stale-date-warning-icon"></div>
        <div class="stale-date-warning-title">Stale Data Detected</div>
        
        <div class="stale-date-warning-text">
            ${timeframeText}
            <br><br>
            This data is <strong>outdated and cannot be displayed</strong>.
        </div>
        
        <div class="stale-date-info-box">
            <div class="stale-date-info-row">
                <span class="stale-date-info-label">Data From:</span>
                <span class="stale-date-info-value">${dataDate.toLocaleDateString('en-AU', { 
                    weekday: 'long', 
                    year: 'numeric', 
                    month: 'long', 
                    day: 'numeric' 
                })}</span>
            </div>
            <div class="stale-date-info-row">
                <span class="stale-date-info-label">Today's Date:</span>
                <span class="stale-date-info-value">${today.toLocaleDateString('en-AU', { 
                    weekday: 'long', 
                    year: 'numeric', 
                    month: 'long', 
                    day: 'numeric' 
                })}</span>
            </div>
        </div>
        
        <div class="stale-date-warning-text">
            <strong>Please close this tab and log back on to access the latest data.</strong>
        </div>
        
        <div class="stale-date-warning-actions">
            <button class="stale-date-close-btn" onclick="closeStaleDateWarning()">
                 Close Tab & Refresh
            </button>
        </div>
    `;
    
    // Prevent closing by clicking overlay
    overlay.onclick = function(e) {
        if (e.target === overlay) {
            e.preventDefault();
            e.stopPropagation();
        }
    };
    
    document.body.appendChild(overlay);
    document.body.appendChild(modal);
    
    // Stop all timers while warning is shown
    stopUpdateIntervals();
    
    // CRITICAL: Hide ALL flight displays
    hideAllFlights();
    
    console.log(' Stale date warning displayed');
}

/**
 * Hide all flights and UI elements when stale data detected
 */
function hideAllFlights() {
    console.log(' Hiding all flights due to stale data');
    
    // Hide all flight sections
    const sectionsToHide = [
        'urgent-section',
        'extended-section',
        'active-section',
        'not-open-section',
        'closed-section',
        'cancelled-section',
        'deleted-flights-section',
        'comments-section'
    ];
    
    sectionsToHide.forEach(sectionId => {
        const section = document.getElementById(sectionId);
        if (section) {
            section.style.display = 'none';
        }
    });
    
    // Hide all control buttons
    const buttonsToHide = [
        'save-html-btn',
        'add-flight-btn',
        'reset-btn',
        'search-container',
        'early-open-btn',
        'add-comment-main-btn',
        'refresh-all-btn',
        'clear-data-btn'
    ];
    
    buttonsToHide.forEach(buttonId => {
        const button = document.getElementById(buttonId);
        if (button) {
            button.style.display = 'none';
        }
    });
    
    // Hide date badge
    const dateBadge = document.getElementById('flight-date-badge');
    if (dateBadge) {
        dateBadge.style.display = 'none';
    }
    
    // Show a "No Data Available" message in the main area
    const loading = document.getElementById('loading');
    if (loading) {
        loading.style.display = 'block';
        loading.innerHTML = `
            <svg style="width: 4rem; height: 4rem; margin: 0 auto 1rem; opacity: 0.5; color: #f59e0b;" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/>
            </svg>
            <p style="color: #f59e0b; font-weight: bold; font-size: 1.2rem;">Data Not Available</p>
            <p style="color: #6b7280; margin-top: 0.5rem;">The loaded data does not match today's date.</p>
        `;
    }
    
    console.log(' All flights and controls hidden');
}

/**
 * Close tab and force refresh
 */
function closeStaleDateWarning() {
    // Try to close the window/tab
    window.close();
    
    // If that doesn't work (some browsers block it), force reload
    setTimeout(() => {
        // Check if window is still open (close failed)
        if (!window.closed) {
            // Force a hard refresh
            location.reload(true);
        }
    }, 500);
}

/**
 * Start instant stale date monitoring (checks every 10 seconds + on visibility change)
 */
function startStaleDateMonitoring() {
    console.log(' Starting INSTANT stale date monitoring...');
    
    // Check IMMEDIATELY on start
    if (checkForStaleData()) {
        console.log(' Stale data detected on monitoring start - blocking display');
        return;
    }
    
    // Check every 10 seconds (instead of 60)
    setInterval(() => {
        checkForStaleData();
    }, 10000); // 10 seconds
    
    // CRITICAL: Also check when page becomes visible (user switches back to tab)
    document.addEventListener('visibilitychange', function() {
        if (!document.hidden) {
            console.log(' Page became visible - running instant stale check');
            // Small delay to ensure everything is ready
            setTimeout(() => {
                checkForStaleData();
            }, 100);
        }
    });
    
    // CRITICAL: Also check on page focus (another way to detect user returning)
    window.addEventListener('focus', function() {
        console.log(' Window focused - running instant stale check');
        setTimeout(() => {
            checkForStaleData();
        }, 100);
    });
    
    console.log(' Stale date monitoring active:');
    console.log('    Checks every 10 seconds');
    console.log('    Instant check when tab becomes visible');
    console.log('    Instant check when window gains focus');
}
// ========== FINAL INITIALIZATION CHECK ==========
console.log(' Flight Tracker Initialized');
console.log(' Firebase:', firebaseInitialized ? 'Connected' : 'Local only');
console.log(' Multi-tab detection:', 'Active');
console.log(' Activity tracking:', 'Active');
console.log(' Background refresh:', 'Active');
console.log(' Early open mode:', earlyOpenMode || 'Default (3 hours)');
console.log('=====================================');

// ============================================
// MIDNIGHT CACHE CLEARING SYSTEM
// ============================================
function scheduleMidnightCacheClear() {
    const now = new Date();
    const midnight = new Date(now);
    midnight.setHours(24, 0, 0, 0); // Next midnight
    
    const msUntilMidnight = midnight.getTime() - now.getTime();
    
    console.log(' Midnight cache clear scheduled in', Math.round(msUntilMidnight / 60000), 'minutes');
    
    setTimeout(() => {
        console.log(' MIDNIGHT CACHE CLEAR TRIGGERED');
        clearOldCacheData();
        
        // Re-schedule for next midnight
        scheduleMidnightCacheClear();
    }, msUntilMidnight);
}

function clearOldCacheData() {
    console.log(' Starting midnight cache cleanup...');
    
    const today = new Date();
    today.setHours(0, 0, 0, 0);
    const todayKey = getLocalDateKey();
    
    try {
        // Clear old localStorage data (keep only today's data)
        const keysToRemove = [];
        for (let i = 0; i < localStorage.length; i++) {
            const key = localStorage.key(i);
            if (!key) continue;
            
            // Check if it's a dated key that's not from today
            const dateMatch = key.match(/\d{4}-\d{2}-\d{2}/);
            if (dateMatch && dateMatch[0] !== todayKey) {
                keysToRemove.push(key);
                console.log('   Marking for removal:', key);
            }
            
            // Clear ALL flight_tracker keys for fresh start
            if (key.includes('flight_tracker') && !key.includes(todayKey)) {
                keysToRemove.push(key);
            }
            
            // Also clear acknowledged cancellations/comments for old dates
            if (key === 'acknowledged_cancellations' || key === 'acknowledged_comments') {
                keysToRemove.push(key);
            }
            
            // Clear busyness reminder flag
            if (key === 'last_busyness_reminder') {
                keysToRemove.push(key);
            }
        }
        
        keysToRemove.forEach(key => {
            localStorage.removeItem(key);
            console.log('   " Removed:', key);
        });
        
        console.log(' Cleared', keysToRemove.length, 'old cache entries');
        
        // Reset local busyness state for fresh day
        busynessEntries = [];
        busynessCooldowns = {};
        busynessTimelineData = {};
        lastBusynessActivityTime = Date.now();
        
        // Update status bar to show fresh state
        updateBusynessStatusBar();
        
        console.log(' Busyness tracker reset for new day');
        
        // Clear browser cache if available
        if ('caches' in window) {
            caches.keys().then(names => {
                names.forEach(name => {
                    caches.delete(name);
                    console.log('   " Cleared cache:', name);
                });
            });
        }
        
        console.log(' Midnight cache clear complete');
        
    } catch (e) {
        console.error(' Error during cache clear:', e);
    }
}

// Start midnight cache clearing scheduler
scheduleMidnightCacheClear();
console.log(' Midnight cache clearing system active');

   // ========== SCROLL TIME REFERENCE ==========
(function() {
    const scrollTimeRef = document.getElementById('scroll-time-ref');
    if (!scrollTimeRef) return;
    
    let scrollTimeout;
    let isScrolling = false;
    
    // Update time in the reference
    function updateScrollTime() {
        const now = new Date();
        scrollTimeRef.textContent = now.toLocaleTimeString('en-AU', { 
            hour12: false,
            hour: '2-digit',
            minute: '2-digit',
            second: '2-digit'
        });
    }
    
    // Show on scroll
    function handleScroll() {
        const scrollY = window.scrollY || window.pageYOffset;
        
        // Only show if scrolled past header (more than 150px)
        if (scrollY > 150) {
            if (!isScrolling) {
                isScrolling = true;
                scrollTimeRef.classList.add('visible');
                updateScrollTime();
            }
            
            // Clear existing timeout
            clearTimeout(scrollTimeout);
            
            // Hide after 3 seconds of no scrolling
            scrollTimeout = setTimeout(() => {
                scrollTimeRef.classList.remove('visible');
                isScrolling = false;
            }, 3000);
        } else {
            // At top of page - hide immediately
            scrollTimeRef.classList.remove('visible');
            isScrolling = false;
            clearTimeout(scrollTimeout);
        }
    }
    
    // Efficient scroll listener with throttling
    let ticking = false;
    window.addEventListener('scroll', function() {
        if (!ticking) {
            window.requestAnimationFrame(function() {
                handleScroll();
                ticking = false;
            });
            ticking = true;
        }
    }, { passive: true });
    
    // Update time every second when visible
    setInterval(function() {
        if (scrollTimeRef.classList.contains('visible')) {
            updateScrollTime();
        }
    }, 1000);
    
    console.log(' Scroll time reference initialized');
})();
    // ============================================
// MANUAL CLEAR ALL DATA FUNCTION
// ============================================

// ============================================
// ACTIVE USER DASHBOARD SYSTEM
// ============================================

// Active User State
let currentUser = null;
let isTAMMode = false; // TAM Mode - bypasses password prompts and inactivity timeouts
const TAM_MASTER_PIN = '1920'; // Master PIN for TAM mode
let activeUsersRef = null;
let activeUsersListener = null;
let userActivityTimeout = null;
let userShiftTimeout = null;
let stillThereTimeout = null;
let stillThereCountdown = null;
let lastActivityTime = Date.now();
let isUserLoggedIn = false;
let userSessionId = 'user_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);

// Constants
const INACTIVITY_TIMEOUT = 30 * 60 * 1000; // 30 minutes
const SHIFT_TIMEOUT = 8 * 60 * 60 * 1000; // 8 hours
const STILL_THERE_RESPONSE_TIME = 30 * 1000; // 30 seconds to respond
const HEARTBEAT_INTERVAL = 120000; // 2 minutes (optimized for Firebase usage)
const USER_SESSION_KEY = 'flight_tracker_user_session';

// Device detection - Desktop users don't need "Still There?" prompts
const IS_IPAD = /iPad/.test(navigator.userAgent) || 
    (navigator.platform === 'MacIntel' && navigator.maxTouchPoints > 1);
const IS_MOBILE = /iPhone|Android|webOS|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
const IS_DESKTOP = !IS_IPAD && !IS_MOBILE;
// On desktop: disable inactivity timeout and "Still There?" prompts completely

// Security Alerts Log (stored in memory for report)
window.securityAlertsLog = [];

// Log security alert function
function logSecurityAlert(type, details) {
    const alert = {
        type: type,
        timestamp: Date.now(),
        details: typeof details === 'object' ? 
            `User: ${details.targetUser || 'Unknown'} at ${details.targetLocation || 'Unknown'} (${details.device || 'Unknown device'})` : 
            details
    };
    
    window.securityAlertsLog.push(alert);
    console.log(' Security Alert logged:', alert);
    
    // Also save to Firebase if available
    if (firebaseInitialized && flightDate) {
        const dateKey = getFlightDateKey();
        const alertsRef = firebase.database().ref(`security_alerts_${dateKey}`);
        alertsRef.push(alert);
    }
}

// Save user session to localStorage (for refresh persistence)
function saveUserSession() {
    if (!currentUser) return;
    
    const sessionData = {
        ...currentUser,
        savedAt: Date.now()
    };
    
    try {
        localStorage.setItem(USER_SESSION_KEY, JSON.stringify(sessionData));
        console.log(' User session saved for refresh persistence');
    } catch (e) {
        console.error('Error saving user session:', e);
    }
}

// Restore user session from localStorage (after refresh)
function restoreUserSession() {
    try {
        const savedSession = localStorage.getItem(USER_SESSION_KEY);
        if (!savedSession) return null;
        
        const sessionData = JSON.parse(savedSession);
        
        // Check if session is still valid (within 8 hour shift)
        const sessionAge = Date.now() - sessionData.loginTime;
        if (sessionAge >= SHIFT_TIMEOUT) {
            console.log(' Saved session expired (8 hour limit)');
            localStorage.removeItem(USER_SESSION_KEY);
            return null;
        }
        
        // Check if session was saved recently (within 5 minutes - for refresh scenario)
        const saveAge = Date.now() - sessionData.savedAt;
        if (saveAge > 5 * 60 * 1000) {
            console.log(' Saved session too old (>5 minutes)');
            localStorage.removeItem(USER_SESSION_KEY);
            return null;
        }
        
        console.log(' Restored user session:', sessionData.name);
        return sessionData;
        
    } catch (e) {
        console.error('Error restoring user session:', e);
        return null;
    }
}

// Clear user session from localStorage
function clearUserSession() {
    try {
        localStorage.removeItem(USER_SESSION_KEY);
    } catch (e) {
        console.error('Error clearing user session:', e);
    }
}

// Device Detection
function detectDevice() {
    const ua = navigator.userAgent;
    const screenWidth = window.innerWidth;
    
    // iPad detection
    if (/iPad/.test(ua) || (navigator.platform === 'MacIntel' && navigator.maxTouchPoints > 1)) {
        return { type: 'iPad', icon: '' };
    }
    
    // iPhone detection
    if (/iPhone/.test(ua)) {
        return { type: 'Phone', icon: '' };
    }
    
    // Android tablet detection
    if (/Android/.test(ua) && !/Mobile/.test(ua)) {
        return { type: 'Tablet', icon: '' };
    }
    
    // Android phone detection
    if (/Android/.test(ua) && /Mobile/.test(ua)) {
        return { type: 'Phone', icon: '' };
    }
    
    // Generic tablet detection by screen size
    if (screenWidth >= 600 && screenWidth <= 1024 && 'ontouchstart' in window) {
        return { type: 'Tablet', icon: '' };
    }
    
    // Generic mobile detection
    if (screenWidth < 600 || /Mobile/.test(ua)) {
        return { type: 'Phone', icon: '' };
    }
    
    // Desktop
    return { type: 'Computer', icon: '' };
}

// Show Login Modal (only for saved HTML files)
function showUserLoginModal() {
    // Only show in saved HTML files
    if (EMBEDDED_DATA === null) {
        console.log(' Not a saved HTML file - skipping login');
        return;
    }
    
    console.log(' Showing user login modal');
    
    const overlay = document.createElement('div');
    overlay.className = 'user-login-overlay';
    overlay.id = 'user-login-overlay';
    
    const modal = document.createElement('div');
    modal.className = 'user-login-modal';
    
    modal.innerHTML = `
        <div class="user-login-icon"></div>
        <div class="user-login-title">Welcome to Flight Tracker</div>
        <div class="user-login-subtitle">Please sign in to continue</div>
        
        <div class="tam-toggle-container" style="margin: 15px 0; padding: 12px; background: linear-gradient(135deg, #000345 0%, #1a1a5e 100%); border-radius: 8px; display: flex; align-items: center; justify-content: space-between;">
            <div style="display: flex; align-items: center; gap: 10px;">
                <div>
                    <div style="color: white; font-weight: 600; font-size: 14px;">TAM Mode</div>
                    <div style="color: rgba(255,255,255,0.7); font-size: 11px;">Turnaround Manager Access</div>
                </div>
            </div>
            <label class="tam-toggle-switch" style="position: relative; width: 50px; height: 26px; cursor: pointer;">
                <input type="checkbox" id="tam-mode-toggle" style="opacity: 0; width: 0; height: 0;" onchange="onTAMToggleChange()">
                <span style="position: absolute; top: 0; left: 0; right: 0; bottom: 0; background: #374151; border-radius: 26px; transition: 0.3s;"></span>
                <span id="tam-toggle-knob" style="position: absolute; height: 20px; width: 20px; left: 3px; bottom: 3px; background: white; border-radius: 50%; transition: 0.3s;"></span>
            </label>
        </div>
        <div id="tam-mode-indicator" style="display: none; text-align: center; padding: 8px; background: #dcfce7; border: 1px solid #059669; border-radius: 6px; margin-bottom: 10px;">
            <span style="color: #059669; font-weight: 600; font-size: 12px;"> TAM Mode Active</span>
        </div>
        
        <div class="user-login-form">
            <div class="login-form-group">
                <label class="login-form-label">Your Full Name *</label>
                <input type="text" class="login-form-input" id="login-name-input" placeholder="e.g., John Smith" autocomplete="off">
            </div>
            
            <div class="login-form-group">
                <label class="login-form-label">Your Location *</label>
                <select class="login-form-select" id="login-location-select">
                    <option value="">-- Select Location --</option>
                    <option value="C.O.W.">C.O.W.</option>
                    <option value="Zone E">Zone E</option>
                    <option value="ABDs">ABDs</option>
                    <option value="Check-In Floor">Check-In Floor</option>
                    <option value="Service Desk">Service Desk</option>
                    <option value="Office">Office</option>
                </select>
            </div>
            
            <div class="login-form-group">
                <label class="login-form-label">Create a 4-Digit Session PIN *</label>
                <div class="login-pin-container">
                    <input type="password" class="login-pin-input" id="pin-1" maxlength="1" pattern="[0-9]" inputmode="numeric" autocomplete="off">
                    <input type="password" class="login-pin-input" id="pin-2" maxlength="1" pattern="[0-9]" inputmode="numeric" autocomplete="off">
                    <input type="password" class="login-pin-input" id="pin-3" maxlength="1" pattern="[0-9]" inputmode="numeric" autocomplete="off">
                    <input type="password" class="login-pin-input" id="pin-4" maxlength="1" pattern="[0-9]" inputmode="numeric" autocomplete="off">
                </div>
                <div class="login-pin-note">This PIN is for this session only. You'll need it if your screen goes idle.</div>
            </div>
            
            <button class="user-login-btn" id="login-submit-btn" onclick="submitUserLogin()">
                 Sign In & Continue
            </button>
        </div>
    `;
    
    overlay.appendChild(modal);
    document.body.appendChild(overlay);
    
    // Setup PIN input auto-advance
    setupPinInputs();
    
    // Focus on name input
    setTimeout(() => {
        document.getElementById('login-name-input').focus();
    }, 100);
}

// TAM Toggle Change Handler
function onTAMToggleChange() {
    const toggle = document.getElementById('tam-mode-toggle');
    const indicator = document.getElementById('tam-mode-indicator');
    const knob = document.getElementById('tam-toggle-knob');
    const pinNote = document.querySelector('.login-pin-note');
    
    // Find the labels
    const allLabels = document.querySelectorAll('.login-form-label');
    let pinLabelElement = null;
    let nameLabelElement = null;
    allLabels.forEach(label => {
        if (label.textContent.includes('PIN') || label.textContent.includes('Session PIN')) {
            pinLabelElement = label;
        }
        if (label.textContent.includes('Name')) {
            nameLabelElement = label;
        }
    });
    
    if (toggle && toggle.checked) {
        // TAM mode ON
        indicator.style.display = 'block';
        knob.style.transform = 'translateX(24px)';
        // Toggle slider track color only (not the container background)
        const track = knob.parentElement.querySelector('span:first-of-type');
        if (track) track.style.background = '#059669';
        
        // Change Name label
        if (nameLabelElement) {
            nameLabelElement.textContent = 'Your Name *';
        }
        // Change PIN label to TAM mode
        if (pinLabelElement) {
            pinLabelElement.textContent = 'Enter TAM Mode PIN *';
        }
        // Hide the "session only" note
        if (pinNote) {
            pinNote.style.display = 'none';
        }
        
        console.log('TAM Mode toggled ON');
    } else {
        // TAM mode OFF
        indicator.style.display = 'none';
        knob.style.transform = 'translateX(0)';
        // Toggle slider track color only
        const track = knob.parentElement.querySelector('span:first-of-type');
        if (track) track.style.background = '#374151';
        
        // Restore Name label
        if (nameLabelElement) {
            nameLabelElement.textContent = 'Your Full Name *';
        }
        // Restore PIN label
        if (pinLabelElement) {
            pinLabelElement.textContent = 'Create a 4-Digit Session PIN *';
        }
        // Show the note again
        if (pinNote) {
            pinNote.style.display = 'block';
        }
        
        console.log('TAM Mode toggled OFF');
    }
}

// Setup PIN input behavior
function setupPinInputs() {
    const pinInputs = [
        document.getElementById('pin-1'),
        document.getElementById('pin-2'),
        document.getElementById('pin-3'),
        document.getElementById('pin-4')
    ];
    
    pinInputs.forEach((input, index) => {
        // Only allow numbers
        input.addEventListener('input', function(e) {
            this.value = this.value.replace(/[^0-9]/g, '');
            
            if (this.value.length === 1 && index < 3) {
                pinInputs[index + 1].focus();
            }
        });
        
        // Handle backspace
        input.addEventListener('keydown', function(e) {
            if (e.key === 'Backspace' && this.value === '' && index > 0) {
                pinInputs[index - 1].focus();
            }
            
            // Submit on Enter at last PIN
            if (e.key === 'Enter' && index === 3) {
                submitUserLogin();
            }
        });
        
        // Handle paste
        input.addEventListener('paste', function(e) {
            e.preventDefault();
            const pastedData = e.clipboardData.getData('text').replace(/[^0-9]/g, '').substr(0, 4);
            
            for (let i = 0; i < pastedData.length && i < 4; i++) {
                pinInputs[i].value = pastedData[i];
            }
            
            if (pastedData.length >= 4) {
                pinInputs[3].focus();
            } else if (pastedData.length > 0) {
                pinInputs[pastedData.length].focus();
            }
        });
    });
}

// Submit Login
function submitUserLogin() {
    const name = document.getElementById('login-name-input').value.trim();
    const location = document.getElementById('login-location-select').value;
    const pin = [
        document.getElementById('pin-1').value,
        document.getElementById('pin-2').value,
        document.getElementById('pin-3').value,
        document.getElementById('pin-4').value
    ].join('');
    
    // Validation
    if (!name) {
        alert('Please enter your name');
        document.getElementById('login-name-input').focus();
        return;
    }
    
    if (!location) {
        alert('Please select your location');
        document.getElementById('login-location-select').focus();
        return;
    }
    
    if (pin.length !== 4) {
        alert('Please enter a complete 4-digit PIN');
        document.getElementById('pin-1').focus();
        return;
    }
    
    // Check TAM Mode
    const tamToggle = document.getElementById('tam-mode-toggle');
    const tamModeEnabled = tamToggle && tamToggle.checked;
    
    if (tamModeEnabled) {
        // TAM Mode requires specific PIN
        if (pin !== TAM_MASTER_PIN) {
            alert('Invalid TAM PIN. TAM Mode requires the authorized PIN.');
            document.getElementById('pin-1').focus();
            document.getElementById('pin-1').value = '';
            document.getElementById('pin-2').value = '';
            document.getElementById('pin-3').value = '';
            document.getElementById('pin-4').value = '';
            return;
        }
        isTAMMode = true;
        console.log('TAM Mode login successful');
    } else {
        isTAMMode = false;
    }
    
    // Create user object
    const device = detectDevice();
    currentUser = {
        sessionId: userSessionId,
        name: name,
        location: location,
        pin: pin,
        device: device.type,
        deviceIcon: device.icon,
        loginTime: Date.now(),
        lastActivity: Date.now(),
        loginTimeFormatted: new Date().toLocaleTimeString('en-AU', { hour: '2-digit', minute: '2-digit', hour12: false })
    };
    
    console.log(' User logged in:', currentUser.name, 'at', currentUser.location);
    
    // Close login modal
    const overlay = document.getElementById('user-login-overlay');
    if (overlay) {
        overlay.remove();
    }
    
    // Remove the requires-login class to reveal content
    document.body.classList.remove('requires-login');
    
    // Initialize user in Firebase
    initializeActiveUser();
    
    // Show dashboard
    showActiveUserDashboard();
    
    // Start activity tracking
    startUserActivityTracking();
    
    // Mark as logged in
    isUserLoggedIn = true;
    
    // Check busyness requirements AFTER login (not before)
    // Small delay to ensure UI is ready
    setTimeout(() => {
        console.log(' Checking busyness requirements after login...');
        checkBusynessAfterAuth();
    }, 500);
}

// Initialize Active User in Firebase
function initializeActiveUser() {
    if (!firebaseInitialized || !flightDate || !currentUser) {
        console.log(' Cannot initialize active user - missing requirements');
        return;
    }
    
    const dateKey = getFlightDateKey();
    activeUsersRef = firebase.database().ref(`active_users_${dateKey}`);
    
    // Add current user to Firebase
    const userRef = activeUsersRef.child(currentUser.sessionId);
    
    userRef.set({
        name: currentUser.name,
        location: currentUser.location,
        device: currentUser.device,
        deviceIcon: currentUser.deviceIcon,
        loginTime: currentUser.loginTime,
        loginTimeFormatted: currentUser.loginTimeFormatted,
        lastHeartbeat: Date.now()
    });
    
    // Remove user on disconnect
    userRef.onDisconnect().remove();
    
    // Start heartbeat
    startUserHeartbeat();
    
    // Listen for active users changes
    listenForActiveUsers();
    
    console.log(' Active user initialized in Firebase');
}

// Start User Heartbeat
let heartbeatIntervalId = null;

function startUserHeartbeat() {
    if (!activeUsersRef || !currentUser) return;
    
    heartbeatIntervalId = setInterval(() => {
        if (currentUser && activeUsersRef) {
            // Include ALL user fields in heartbeat to prevent data loss
            activeUsersRef.child(currentUser.sessionId).update({
                name: currentUser.name,
                device: currentUser.device,
                deviceIcon: currentUser.deviceIcon,
                loginTime: currentUser.loginTime,
                loginTimeFormatted: currentUser.loginTimeFormatted,
                lastHeartbeat: Date.now()
                // Note: location is intentionally NOT included here
                // Location is only updated when explicitly changed by the user
                // This allows other users to change this user's location without heartbeat overwriting it
            });
        }
    }, HEARTBEAT_INTERVAL);
}

// Listen for Active Users
function listenForActiveUsers() {
    if (!activeUsersRef) return;
    
    activeUsersListener = activeUsersRef.on('value', (snapshot) => {
        const users = snapshot.val() || {};
        updateActiveUsersDashboard(users);
        
        // Sync current user's location if it was changed by another user
        if (currentUser && users[currentUser.sessionId]) {
            const updatedLocation = users[currentUser.sessionId].location;
            if (updatedLocation && updatedLocation !== currentUser.location) {
                console.log(' Location updated by another user from', currentUser.location, 'to', updatedLocation);
                currentUser.location = updatedLocation;
                
                // Update the dropdown in the header
                const locationSelect = document.getElementById('location-change-select');
                if (locationSelect) {
                    locationSelect.value = updatedLocation;
                }
            }
        }
    });
}

// Update Active Users Dashboard
function updateActiveUsersDashboard(users) {
    const listContainer = document.getElementById('active-users-list');
    const countEl = document.getElementById('active-users-count');
    const noUsersMsg = document.getElementById('no-users-message');
    
    if (!listContainer) return;
    
    // Clean up stale users (no heartbeat in 30 seconds)
    const now = Date.now();
    const activeUsers = {};
    let userCount = 0;
    
    Object.keys(users).forEach(key => {
        const user = users[key];
        if (user && (now - user.lastHeartbeat) < 180000) {
            activeUsers[key] = user;
            userCount++;
        }
    });
    
    // Update count
    if (countEl) {
        countEl.textContent = userCount;
    }
    
    // Group users by location
    const locations = {
        'C.O.W.': [],
        'Zone E': [],
        'ABDs': [],
        'Check-In Floor': [],
        'Service Desk': [],
        'Office': []
    };
    
    Object.keys(activeUsers).forEach(sessionId => {
        const user = activeUsers[sessionId];
        user.sessionId = sessionId;
        // Default to 'Check-In' if location is missing
        const userLocation = user.location || 'C.O.W.';
        if (locations[userLocation]) {
            locations[userLocation].push(user);
        } else {
            // Fallback to Check-In if location doesn't match any known location
            locations['C.O.W.'].push(user);
        }
    });
    
    // Build HTML - all user cards are clickable to change location
    let html = '';
    let hasUsers = false;
    
    Object.keys(locations).forEach(location => {
        const usersInLocation = locations[location];
        if (usersInLocation.length === 0) return;
        
        hasUsers = true;
        const isZoneE = location === 'Zone E';
        
        html += `
            <div class="active-users-location-group">
                <div class="location-header ${isZoneE ? 'zone-e' : ''}">
                    ${isZoneE ? ' ' : ''}${location.toUpperCase()}
                </div>
        `;
        
        usersInLocation.forEach(user => {
            const isCurrentUser = user.sessionId === currentUser?.sessionId;
            
            // All users are clickable to change their location
            html += `
                <div class="user-card clickable ${isZoneE ? 'zone-e' : ''} ${isCurrentUser ? 'current-user' : ''}" 
                     onclick="openLocationChangeModal('${user.sessionId}', '${user.name}', '${user.location}')"
                     title="Click to change location">
                    <div class="user-avatar"></div>
                    <div class="user-info">
                        <div class="user-name ${isZoneE ? 'zone-e' : ''}">
                            ${user.name || 'Unknown'}${isCurrentUser ? ' (You)' : ''}
                        </div>
                        <div class="user-details">
                            <span class="user-device">${user.deviceIcon || ''} ${user.device || 'Unknown'}</span>
                            <span class="user-time"> Since ${user.loginTimeFormatted || 'Unknown'}</span>
                        </div>
                    </div>
                </div>
            `;
        });
        
        html += '</div>';
    });
    
    listContainer.innerHTML = html;
    
    // Show/hide no users message
    if (noUsersMsg) {
        noUsersMsg.style.display = hasUsers ? 'none' : 'block';
    }
}

// Open Location Change Modal for any user
function openLocationChangeModal(targetSessionId, targetName, currentLocation) {
    const overlay = document.createElement('div');
    overlay.className = 'location-change-modal-overlay';
    overlay.id = 'location-change-modal-overlay';
    
    const modal = document.createElement('div');
    modal.className = 'location-change-modal';
    
    modal.innerHTML = `
        <div class="location-change-modal-header">
            <div class="location-change-modal-title"> Change Location</div>
            <div class="location-change-modal-user">${targetName}</div>
        </div>
        <div class="location-change-modal-content">
            <label class="location-change-modal-label">Select New Location:</label>
            <select class="location-change-modal-select" id="new-location-select">
                <option value="C.O.W." ${currentLocation === 'C.O.W.' ? 'selected' : ''}>C.O.W.</option>
                <option value="Zone E" ${currentLocation === 'Zone E' ? 'selected' : ''}>Zone E</option>
                <option value="ABDs" ${currentLocation === 'ABDs' ? 'selected' : ''}>ABDs</option>
                <option value="Check-In Floor" ${currentLocation === 'Check-In Floor' ? 'selected' : ''}>Check-In Floor</option>
                
                <option value="Service Desk" ${currentLocation === 'Service Desk' ? 'selected' : ''}>Service Desk</option>
                <option value="Office" ${currentLocation === 'Office' ? 'selected' : ''}>Office</option>
            </select>
            <div class="location-change-modal-actions">
                <button class="location-change-modal-btn cancel" onclick="closeLocationChangeModal()">Cancel</button>
                <button class="location-change-modal-btn confirm" onclick="confirmLocationChange('${targetSessionId}', '${targetName}')">Update Location</button>
            </div>
        </div>
    `;
    
    // Close on overlay click
    overlay.onclick = function(e) {
        if (e.target === overlay) {
            closeLocationChangeModal();
        }
    };
    
    overlay.appendChild(modal);
    document.body.appendChild(overlay);
}

// Close Location Change Modal
function closeLocationChangeModal() {
    const overlay = document.getElementById('location-change-modal-overlay');
    if (overlay) overlay.remove();
}

// Confirm Location Change for any user
function confirmLocationChange(targetSessionId, targetName) {
    const newLocation = document.getElementById('new-location-select').value;
    
    if (!newLocation) {
        alert('Please select a location');
        return;
    }
    
    // Update in Firebase
    if (activeUsersRef) {
        activeUsersRef.child(targetSessionId).update({
            location: newLocation
        }).then(() => {
            console.log(' Location changed for', targetName, 'to:', newLocation);
            
            // If this is the current user, also update local state
            if (targetSessionId === currentUser?.sessionId) {
                currentUser.location = newLocation;
                // Update the dropdown in the header
                const locationSelect = document.getElementById('location-change-select');
                if (locationSelect) {
                    locationSelect.value = newLocation;
                }
            }
            
            closeLocationChangeModal();
        }).catch(err => {
            console.error('Error updating location:', err);
            alert('Failed to update location. Please try again.');
        });
    } else {
        alert('Not connected to server. Please refresh and try again.');
    }
}

// Show Active Users Dashboard
function showActiveUserDashboard() {
    const dashboard = document.getElementById('active-users-dashboard');
    const currentUserDisplay = document.getElementById('current-user-display');
    const locationSelect = document.getElementById('location-change-select');
    
    if (dashboard && currentUser) {
        dashboard.style.display = 'block';
        
        if (currentUserDisplay) {
            if (isTAMMode) {
                currentUserDisplay.innerHTML = currentUser.name + ' <span style="background:#000345;color:white;padding:2px 8px;border-radius:4px;font-size:11px;margin-left:8px;">TAM</span>';
            } else {
                currentUserDisplay.textContent = currentUser.name;
            }
        }
        
        if (locationSelect) {
            locationSelect.value = currentUser.location;
        }
    }
}

// Toggle Dashboard
function toggleActiveUsersDashboard() {
    const content = document.getElementById('active-users-content');
    const toggle = document.getElementById('active-users-toggle');
    
    if (content.classList.contains('expanded')) {
        // Collapsing - no password needed
        content.classList.remove('expanded');
        toggle.textContent = '';
    } else {
        // Expanding - check if supervisor access is unlocked or TAM mode
        if (supervisorAccessUnlocked || isTAMMode) {
            content.classList.add('expanded');
            toggle.textContent = '';
            if (isTAMMode) {
                supervisorAccessUnlocked = true;
                console.log('TAM Mode - Active Users unlocked automatically');
            }
        } else {
            // Show password modal
            showSupervisorPasswordModal('active-users');
        }
    }
}

// Show Supervisor Password Modal
function showSupervisorPasswordModal(source) {
    const overlay = document.createElement('div');
    overlay.className = 'supervisor-password-overlay';
    overlay.id = 'supervisor-password-overlay';
    
    overlay.innerHTML = `
        <div class="supervisor-password-modal">
            <div class="supervisor-password-header">
                <span></span> Supervisor Access Required
            </div>
            <div class="supervisor-password-body">
                <p class="supervisor-password-info">This area is restricted to Team Leaders and Supervisors.</p>
                <label for="supervisor-password-input">Enter Password:</label>
                <input type="password" id="supervisor-password-input" class="supervisor-password-input" placeholder="Enter password" autocomplete="off">
                <div class="supervisor-password-error" id="supervisor-password-error" style="display: none;">
                    Incorrect password. Please try again.
                </div>
            </div>
            <div class="supervisor-password-footer">
                <button class="supervisor-password-btn cancel" onclick="closeSupervisorPasswordModal()">Cancel</button>
                <button class="supervisor-password-btn submit" onclick="submitSupervisorPassword('${source}')">Unlock</button>
            </div>
        </div>
    `;
    
    document.body.appendChild(overlay);
    
    // Focus password input
    setTimeout(() => {
        const input = document.getElementById('supervisor-password-input');
        if (input) {
            input.focus();
            input.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    submitSupervisorPassword(source);
                }
            });
        }
    }, 100);
}

// Close Supervisor Password Modal
function closeSupervisorPasswordModal() {
    const overlay = document.getElementById('supervisor-password-overlay');
    if (overlay) overlay.remove();
}

// Submit Supervisor Password
function submitSupervisorPassword(source) {
    const input = document.getElementById('supervisor-password-input');
    const password = input?.value || '';
    
    if (password === LEADERSHIP_PASSWORD) {
        supervisorAccessUnlocked = true;
        leadershipUnlocked = true; // Also unlock leadership editing
        closeSupervisorPasswordModal();
        
        console.log(' Supervisor access unlocked');
        
        // Perform the action that was requested
        if (source === 'active-users') {
            const content = document.getElementById('active-users-content');
            const toggle = document.getElementById('active-users-toggle');
            if (content && toggle) {
                content.classList.add('expanded');
                toggle.textContent = '';
            }
        } else if (source === 'leadership') {
            closeLeadershipModal();
            openLeadershipTeamModal(); // Reopen in edit mode
        }
    } else {
        const errorEl = document.getElementById('supervisor-password-error');
        if (errorEl) {
            errorEl.style.display = 'block';
        }
        if (input) {
            input.value = '';
            input.focus();
        }
    }
}

// Change User Location
function changeUserLocation(newLocation) {
    if (!currentUser || !activeUsersRef) return;
    
    currentUser.location = newLocation;
    
    // Update in Firebase
    activeUsersRef.child(currentUser.sessionId).update({
        location: newLocation
    });
    
    console.log(' Location changed to:', newLocation);
}

// Start Activity Tracking
function startUserActivityTracking() {
    // Reset activity on any interaction
    const resetActivity = () => {
        lastActivityTime = Date.now();
        resetInactivityTimer();
    };
    
    // Track various activities
    ['click', 'touchstart', 'keydown', 'scroll', 'mousemove'].forEach(event => {
        document.addEventListener(event, resetActivity, { passive: true });
    });
    
    // Start inactivity timer
    resetInactivityTimer();
    
    // Start shift timer (8 hours max)
    startShiftTimer();
    
    // Handle visibility change (screen goes black)
    document.addEventListener('visibilitychange', handleVisibilityChange);
    
    console.log(' Activity tracking started');
}

// Reset Inactivity Timer
function resetInactivityTimer() {
    // TAM Mode users: Skip inactivity timeout entirely - stay logged in until app close or date change
    if (isTAMMode) {
        console.log('TAM Mode - skipping inactivity timer');
        return; // No timeout for TAM users
    }
    
    // Desktop users: Skip inactivity timeout entirely - once logged in, stay logged in
    if (IS_DESKTOP) {
        return; // No timeout on desktop
    }
    
    if (userActivityTimeout) {
        clearTimeout(userActivityTimeout);
    }
    
    // After 30 minutes of inactivity, show "Still There?" prompt (iPad/mobile only)
    userActivityTimeout = setTimeout(() => {
        console.log(' 30-minute inactivity timeout reached - showing still there prompt');
        showStillTherePrompt();
    }, INACTIVITY_TIMEOUT);
}

// Start Shift Timer
function startShiftTimer() {
    if (userShiftTimeout) {
        clearTimeout(userShiftTimeout);
    }
    
    userShiftTimeout = setTimeout(() => {
        console.log(' 8-hour shift timeout reached - logging out');
        logoutUser('shift_end');
    }, SHIFT_TIMEOUT);
}

// Handle Visibility Change (Screen Goes Black / Power Save Mode)
// This now only tracks when visibility changes for the inactivity system
// The "Still There?" prompt is now ONLY triggered by 30-minute inactivity timeout
// Tab switching and app switching do NOT trigger the prompt
let lastHiddenTime = null;
let screenOffDetected = false;

function handleVisibilityChange() {
    if (!currentUser || !isUserLoggedIn) return;
    
    // Desktop users: Don't interrupt when switching tabs/windows
    if (IS_DESKTOP) return;
    
    if (document.hidden) {
        // Screen went hidden - record the time
        lastHiddenTime = Date.now();
        console.log(' Screen hidden at:', new Date(lastHiddenTime).toLocaleTimeString());
    } else {
        // Screen became visible again
        if (lastHiddenTime) {
            const hiddenDuration = Date.now() - lastHiddenTime;
            const hiddenSeconds = Math.floor(hiddenDuration / 1000);
            console.log(' Screen visible again. Was hidden for:', hiddenSeconds, 'seconds');
            
            // If screen was off for more than 5 seconds, show prompt
            // This catches quick screen locks during passenger interactions
            if (hiddenDuration > 5000) { // 5 seconds
                screenOffDetected = true;
                console.log(' Screen was off - showing prompt');
                showStillTherePrompt();
            }
            
            lastHiddenTime = null;
        }
    }
}

// Show "Still There?" Prompt
function showStillTherePrompt() {
    // Desktop users: Never show this prompt - they stay logged in
    if (IS_DESKTOP) {
        console.log(' Desktop detected - skipping still there prompt');
        return;
    }
    
    // Don't show if already showing
    if (document.getElementById('still-there-overlay')) return;
    
    console.log(' Showing still there prompt');
    
    const overlay = document.createElement('div');
    overlay.className = 'still-there-overlay';
    overlay.id = 'still-there-overlay';
    
    const modal = document.createElement('div');
    modal.className = 'still-there-modal';
    
    modal.innerHTML = `
        <div class="still-there-icon"></div>
        <div class="still-there-title">Are you still ${currentUser?.name || 'there'}?</div>
        <div class="still-there-countdown" id="still-there-countdown">30</div>
        <div style="color: #6b7280; margin-bottom: 1.5rem;">You'll be logged out if you don't respond</div>
        <button class="still-there-btn still-there-yes" onclick="confirmStillThere()">Yes, I'm here!</button>
        <button class="still-there-btn still-there-no" onclick="logoutUser('manual')">No, log me out</button>
    `;
    
    overlay.appendChild(modal);
    document.body.appendChild(overlay);
    
    // Start countdown
    let countdown = 30;
    const countdownEl = document.getElementById('still-there-countdown');
    
    stillThereCountdown = setInterval(() => {
        countdown--;
        if (countdownEl) {
            countdownEl.textContent = countdown;
        }
        
        if (countdown <= 0) {
            clearInterval(stillThereCountdown);
            closeStillTherePrompt();
            logoutUser('no_response');
        }
    }, 1000);
    
    // Auto-timeout
    stillThereTimeout = setTimeout(() => {
        closeStillTherePrompt();
        logoutUser('timeout');
    }, STILL_THERE_RESPONSE_TIME);
}

// Confirm Still There - Show PIN verification
function confirmStillThere() {
    // Clear timeouts
    if (stillThereTimeout) clearTimeout(stillThereTimeout);
    if (stillThereCountdown) clearInterval(stillThereCountdown);
    
    // Replace with PIN verification
    const overlay = document.getElementById('still-there-overlay');
    if (!overlay) return;
    
    overlay.innerHTML = `
        <div class="pin-verify-modal">
            <div class="still-there-icon"></div>
            <div class="pin-verify-title">Enter Your PIN to Continue</div>
            <div class="login-pin-container">
                <input type="password" class="login-pin-input" id="verify-pin-1" maxlength="1" pattern="[0-9]" inputmode="numeric" autocomplete="off">
                <input type="password" class="login-pin-input" id="verify-pin-2" maxlength="1" pattern="[0-9]" inputmode="numeric" autocomplete="off">
                <input type="password" class="login-pin-input" id="verify-pin-3" maxlength="1" pattern="[0-9]" inputmode="numeric" autocomplete="off">
                <input type="password" class="login-pin-input" id="verify-pin-4" maxlength="1" pattern="[0-9]" inputmode="numeric" autocomplete="off">
            </div>
            <button class="pin-verify-btn" onclick="verifyUserPin()"> Verify & Continue</button>
            <button class="still-there-btn still-there-no" style="margin-top: 0.5rem;" onclick="logoutUser('manual')">Cancel & Log Out</button>
        </div>
    `;
    
    // Setup PIN inputs for verification
    setupVerifyPinInputs();
    
    setTimeout(() => {
        document.getElementById('verify-pin-1')?.focus();
    }, 100);
}

// Setup PIN verification inputs
function setupVerifyPinInputs() {
    const pinInputs = [
        document.getElementById('verify-pin-1'),
        document.getElementById('verify-pin-2'),
        document.getElementById('verify-pin-3'),
        document.getElementById('verify-pin-4')
    ];
    
    pinInputs.forEach((input, index) => {
        if (!input) return;
        
        input.addEventListener('input', function(e) {
            this.value = this.value.replace(/[^0-9]/g, '');
            if (this.value.length === 1 && index < 3) {
                pinInputs[index + 1].focus();
            }
        });
        
        input.addEventListener('keydown', function(e) {
            if (e.key === 'Backspace' && this.value === '' && index > 0) {
                pinInputs[index - 1].focus();
            }
            if (e.key === 'Enter' && index === 3) {
                verifyUserPin();
            }
        });
    });
}

// Verify User PIN
function verifyUserPin() {
    const enteredPin = [
        document.getElementById('verify-pin-1')?.value || '',
        document.getElementById('verify-pin-2')?.value || '',
        document.getElementById('verify-pin-3')?.value || '',
        document.getElementById('verify-pin-4')?.value || ''
    ].join('');
    
    // Store current user info before verification in case we need it
    const userName = currentUser?.name || 'Unknown';
    const userLocation = currentUser?.location || 'Unknown';
    const userSessionId = currentUser?.sessionId || 'Unknown';
    
    if (enteredPin === currentUser?.pin) {
        console.log(' PIN verified successfully for:', userName);
        closeStillTherePrompt();
        lastActivityTime = Date.now();
        resetInactivityTimer();
        
        // Check busyness requirements after PIN verification
        setTimeout(() => {
            console.log(' Checking busyness requirements after PIN verification...');
            checkBusynessAfterAuth();
        }, 500);
        
        // Ensure currentUser is still properly set after verification
        if (currentUser && activeUsersRef) {
            // Re-sync ALL user data to Firebase to ensure it's up to date
            activeUsersRef.child(currentUser.sessionId).update({
                name: currentUser.name,
                location: currentUser.location,
                device: currentUser.device,
                deviceIcon: currentUser.deviceIcon,
                loginTime: currentUser.loginTime,
                loginTimeFormatted: currentUser.loginTimeFormatted,
                lastHeartbeat: Date.now()
            });
        }
    } else {
        // Log failed PIN attempt as security alert
        logSecurityAlert('incorrect_pin', {
            targetUser: userName,
            targetLocation: userLocation,
            targetSessionId: userSessionId,
            device: detectDevice().type,
            attemptedAt: new Date().toLocaleString('en-AU')
        });
        
        alert('Incorrect PIN. Please try again or log out.');
        // Clear inputs
        for (let i = 1; i <= 4; i++) {
            const input = document.getElementById(`verify-pin-${i}`);
            if (input) input.value = '';
        }
        document.getElementById('verify-pin-1')?.focus();
    }
}

// Close Still There Prompt
function closeStillTherePrompt() {
    const overlay = document.getElementById('still-there-overlay');
    if (overlay) overlay.remove();
    
    if (stillThereTimeout) clearTimeout(stillThereTimeout);
    if (stillThereCountdown) clearInterval(stillThereCountdown);
}

// Logout User
function logoutUser(reason = 'manual') {
    console.log(' Logging out user, reason:', reason);
    
    // Clear saved session (important - prevents auto-restore after manual logout)
    clearUserSession();
    
    // Clear timers
    if (userActivityTimeout) clearTimeout(userActivityTimeout);
    if (userShiftTimeout) clearTimeout(userShiftTimeout);
    if (stillThereTimeout) clearTimeout(stillThereTimeout);
    if (stillThereCountdown) clearInterval(stillThereCountdown);
    if (heartbeatIntervalId) clearInterval(heartbeatIntervalId);
    
    // Remove from Firebase
    if (activeUsersRef && currentUser) {
        activeUsersRef.child(currentUser.sessionId).remove();
    }
    
    // Stop listening for active users
    if (activeUsersRef && activeUsersListener) {
        activeUsersRef.off('value', activeUsersListener);
        activeUsersListener = null;
    }
    
    // Remove visibility listener
    document.removeEventListener('visibilitychange', handleVisibilityChange);
    
    // Clear user state
    currentUser = null;
    isUserLoggedIn = false;
    
    // Reset supervisor/leadership access
    supervisorAccessUnlocked = false;
    leadershipUnlocked = false;
    
    // Generate new session ID for next login
    userSessionId = 'user_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
    
    // Close any prompts
    closeStillTherePrompt();
    
    // Hide dashboard
    const dashboard = document.getElementById('active-users-dashboard');
    if (dashboard) dashboard.style.display = 'none';
    
    // Collapse active users content if expanded
    const activeUsersContent = document.getElementById('active-users-content');
    const activeUsersToggle = document.getElementById('active-users-toggle');
    if (activeUsersContent) activeUsersContent.classList.remove('expanded');
    if (activeUsersToggle) activeUsersToggle.textContent = '';
    
    // Add requires-login class to hide content
    document.body.classList.add('requires-login');
    
    // Show login modal again
    showUserLoginModal();
}

// Load Security Alerts from Firebase
function loadSecurityAlerts() {
    if (!firebaseInitialized || !flightDate) {
        console.log(' Cannot load security alerts - Firebase not ready');
        return;
    }
    
    const dateKey = getFlightDateKey();
    const alertsRef = firebase.database().ref(`security_alerts_${dateKey}`);
    
    alertsRef.once('value', (snapshot) => {
        const alerts = snapshot.val();
        if (alerts) {
            window.securityAlertsLog = Object.values(alerts);
            console.log(' Loaded', window.securityAlertsLog.length, 'security alerts from Firebase');
        }
    });
    
    // Also listen for new alerts in real-time
    alertsRef.on('child_added', (snapshot) => {
        const alert = snapshot.val();
        // Check if this alert is already in our log (avoid duplicates)
        const exists = window.securityAlertsLog.some(a => a.timestamp === alert.timestamp);
        if (!exists) {
            window.securityAlertsLog.push(alert);
            console.log(' New security alert received');
        }
    });
}

// Initialize Active User System (called after embedded data loads)
function initializeActiveUserSystem() {
    // Only for saved HTML files
    if (EMBEDDED_DATA === null) {
        console.log(' Not a saved HTML file - skipping active user system');
        return;
    }
    
    // Load security alerts from Firebase
    loadSecurityAlerts();
    
    // Check for restored session (after Refresh All Devices)
    if (EMBEDDED_DATA === null) {
        console.log(' Not a saved HTML file - active user system disabled');
        return;
    }
    
    console.log(' Initializing Active User System');
    
    // Check for restored session (after Refresh All Devices)
    const restoredSession = restoreUserSession();
    
    if (restoredSession) {
        // Restore the user without showing login
        currentUser = restoredSession;
        userSessionId = restoredSession.sessionId;
        isUserLoggedIn = true;
        
        console.log(' Session restored for:', currentUser.name);
        
        // Remove requires-login class to show content
        document.body.classList.remove('requires-login');
        
        // Clear the saved session (one-time restore)
        clearUserSession();
        
        // Initialize user in Firebase
        initializeActiveUser();
        
        // Show dashboard
        showActiveUserDashboard();
        
        // Start activity tracking
        startUserActivityTracking();
        
        return;
    }
    
    // No restored session - show login modal (blocks everything until login)
    showUserLoginModal();
}

// Hook into the existing initialization flow
// This will be called after Firebase is ready and embedded data is loaded

// ============================================
// LEADERSHIP TEAM MANAGEMENT SYSTEM
// ============================================

const LEADERSHIP_POSITIONS = [
    'Team Leader Check-In (AM)',
    'Team Leader Check-In',
    'Team Leader Concourse (AM)',
    'Team Leader Concourse',
    'Team Leader Buddying',
    'Team Leader Check-In (PM)',
    'Team Leader Concourse (PM)',
    'ROS (AM)',
    'ROS (PM)',
    'ROS (ADMIN)',
    'TAM (AM)',
    'TAM (PM)',
    'TAM (ADMIN)',
    'TAM (ADMIN/INTL)'
];

const LEADERSHIP_NAMES = [
    'Alle', 'Amal', 'Amelia', 'Angelica', 'Dean', 'Dennis', 'Dimi', 'Donna',
    'Fran', 'Hayley', 'Helga', 'Isabel', 'Jackie', 'Julie', 'KJ',
    'Maria D', 'Maria T', 'Max', 'Mel', 'Michelle', 'Paul', 'Phil',
    'Rahul', 'Ramy', 'Reanne', 'Seif', 'Tara'
];

const LEADERSHIP_PASSWORD = 'Jetstar01';

let leadershipData = {};
let leadershipUnlocked = false;
let leadershipPublishedBy = null;
let leadershipPublishedAt = null;
let supervisorAccessUnlocked = false; // Unified access for Active Users and Leadership editing

// Initialize leadership data structure
function initializeLeadershipData() {
    LEADERSHIP_POSITIONS.forEach(position => {
        if (!leadershipData[position]) {
            leadershipData[position] = {
                name: '',
                visible: false
            };
        }
    });
}

// Open leadership team modal
// ============================================================
// PAX LOADS - Passenger Numbers by Time Interval
// ============================================================

let paxLoadsData = [];
let paxLoadsMerged = {}; // Tracks which intervals are merged
let paxLoadsSelected = new Set(); // Tracks selected checkboxes

// Calculate passenger loads from flight data
function calculatePaxLoads() {
    // Time intervals (2-hour blocks)
    const intervals = [
        { start: 6, end: 8, label: '06:00 - 08:00' },
        { start: 8, end: 10, label: '08:00 - 10:00' },
        { start: 10, end: 12, label: '10:00 - 12:00' },
        { start: 12, end: 14, label: '12:00 - 14:00' },
        { start: 14, end: 16, label: '14:00 - 16:00' },
        { start: 16, end: 18, label: '16:00 - 18:00' },
        { start: 18, end: 20, label: '18:00 - 20:00' },
        { start: 20, end: 22, label: '20:00 - 22:00' }
    ];
    
    // Initialize counts
    const intervalPax = {};
    intervals.forEach(interval => {
        intervalPax[interval.label] = 0;
    });
    
    // Sum up passengers from flights based on departure time
    console.log(' Calculating pax loads for', flights.length, 'flights');
    let flightsWithPax = 0;
    
    flights.forEach(flight => {
        if (flight.departureTime) {
            const pax = parseInt(flight.pax) || 0;
            if (pax > 0) flightsWithPax++;
            
            const [hours, minutes] = flight.departureTime.split(':').map(Number);
            
            // Find which interval this belongs to
            for (const interval of intervals) {
                if (hours >= interval.start && hours < interval.end) {
                    intervalPax[interval.label] += pax;
                    break;
                }
            }
        }
    });
    
    console.log(' Flights with pax data:', flightsWithPax);
    console.log(' Interval totals:', intervalPax);
    
    // Convert to array format
    paxLoadsData = intervals.map(interval => ({
        label: interval.label,
        start: interval.start,
        end: interval.end,
        pax: intervalPax[interval.label],
        merged: false,
        mergedFrom: null
    }));
    
    return paxLoadsData;
}

// Open Pax Loads modal
function openPaxLoadsModal() {
    // Reset state
    paxLoadsSelected.clear();
    paxLoadsMerged = {};
    
    // Calculate data
    calculatePaxLoads();
    
    // Create modal
    const overlay = document.createElement('div');
    overlay.className = 'pax-loads-overlay';
    overlay.id = 'pax-loads-overlay';
    overlay.onclick = (e) => { if (e.target === overlay) closePaxLoadsModal(); };
    
    const modal = document.createElement('div');
    modal.className = 'pax-loads-modal';
    
    // Format date
    const dateStr = flightDate ? flightDate.toLocaleDateString('en-AU', { 
        weekday: 'long', 
        day: 'numeric', 
        month: 'long', 
        year: 'numeric' 
    }) : 'Today';
    
    modal.innerHTML = 
        '<div class="pax-loads-header">' +
            '<div>' +
                '<div class="pax-loads-title"> Passenger Numbers</div>' +
                '<div class="pax-loads-date">' + dateStr + '</div>' +
            '</div>' +
            '<button class="pax-loads-close" onclick="closePaxLoadsModal()"></button>' +
        '</div>' +
        '<div class="pax-loads-content">' +
            '<div id="pax-loads-table-container"></div>' +
            '<div class="pax-loads-actions">' +
                '<button class="pax-action-btn merge" id="pax-merge-btn" onclick="mergePaxLoadsSelected()" disabled>Merge Selected</button>' +
                '<button class="pax-action-btn reset" onclick="resetPaxLoads()">Reset All</button>' +
                '<button class="pax-action-btn close-btn" onclick="closePaxLoadsModal()">Close</button>' +
            '</div>' +
        '</div>';
    
    overlay.appendChild(modal);
    document.body.appendChild(overlay);
    
    // Render table
    renderPaxLoadsTable();
}

// Render the Pax Loads table
function renderPaxLoadsTable() {
    const container = document.getElementById('pax-loads-table-container');
    if (!container) return;
    
    // Get current data (applying merges)
    const displayData = getDisplayPaxData();
    
    // Find max for bar scaling
    const maxPax = Math.max(...displayData.map(d => d.pax), 1);
    
    // Find peak
    const peakPax = Math.max(...displayData.filter(d => d.pax > 0).map(d => d.pax));
    
    // Calculate total
    const totalPax = displayData.reduce((sum, d) => sum + d.pax, 0);
    
    let html = '<table class="pax-loads-table">' +
        '<thead><tr>' +
            '<th><input type="checkbox" class="pax-checkbox" onchange="toggleAllPaxSelection(this)"></th>' +
            '<th>Flight Time Interval</th>' +
            '<th>Passengers</th>' +
            '<th>Visual</th>' +
        '</tr></thead>' +
        '<tbody>';
    
    displayData.forEach((item, index) => {
        const isSelected = paxLoadsSelected.has(item.label);
        const isPeak = item.pax === peakPax && item.pax > 0;
        const barWidth = maxPax > 0 ? (item.pax / maxPax * 100) : 0;
        
        let rowClass = '';
        if (isPeak) rowClass = 'peak-row';
        else if (isSelected) rowClass = 'selected';
        else if (item.merged) rowClass = 'merged-row';
        
        html += '<tr class="' + rowClass + '" data-label="' + item.label + '">' +
            '<td><input type="checkbox" class="pax-checkbox" ' + (isSelected ? 'checked' : '') + ' onchange="togglePaxSelection(\'' + item.label + '\')"></td>' +
            '<td>' + item.label + (item.merged ? ' <button class="unmerge-btn" onclick="unmergePaxInterval(\'' + item.label + '\')"></button>' : '') + '</td>' +
            '<td style="font-weight: bold;">' + item.pax.toLocaleString() + '</td>' +
            '<td>' +
                '<div class="pax-bar-container">' +
                    (item.pax > 0 ? '<div class="pax-bar ' + (isPeak ? 'peak' : '') + '" style="width: ' + barWidth + '%;"></div>' : '<span style="color: #999;"></span>') +
                    (isPeak ? ' <span class="peak-badge"> PEAK</span>' : '') +
                '</div>' +
            '</td>' +
        '</tr>';
    });
    
    // Total row
    html += '<tr class="total-row">' +
        '<td></td>' +
        '<td>TOTAL</td>' +
        '<td>' + totalPax.toLocaleString() + '</td>' +
        '<td></td>' +
    '</tr>';
    
    html += '</tbody></table>';
    
    container.innerHTML = html;
    
    // Update merge button state
    updateMergeButtonState();
}

// Get display data (with merges applied)
function getDisplayPaxData() {
    // Start with original data
    let displayData = [...paxLoadsData];
    
    // Apply merges
    Object.keys(paxLoadsMerged).forEach(mergedLabel => {
        const mergeInfo = paxLoadsMerged[mergedLabel];
        if (mergeInfo && mergeInfo.originalLabels) {
            // Remove the original intervals
            displayData = displayData.filter(d => !mergeInfo.originalLabels.includes(d.label));
            
            // Add the merged interval
            displayData.push({
                label: mergedLabel,
                pax: mergeInfo.totalPax,
                merged: true,
                mergedFrom: mergeInfo.originalLabels
            });
        }
    });
    
    // Sort by start time
    displayData.sort((a, b) => {
        const aStart = parseInt(a.label.split(':')[0]);
        const bStart = parseInt(b.label.split(':')[0]);
        return aStart - bStart;
    });
    
    return displayData;
}

// Toggle selection for a single row
function togglePaxSelection(label) {
    if (paxLoadsSelected.has(label)) {
        paxLoadsSelected.delete(label);
    } else {
        paxLoadsSelected.add(label);
    }
    renderPaxLoadsTable();
}

// Toggle all selections
function toggleAllPaxSelection(checkbox) {
    const displayData = getDisplayPaxData();
    if (checkbox.checked) {
        displayData.forEach(d => paxLoadsSelected.add(d.label));
    } else {
        paxLoadsSelected.clear();
    }
    renderPaxLoadsTable();
}

// Update merge button state
function updateMergeButtonState() {
    const mergeBtn = document.getElementById('pax-merge-btn');
    if (mergeBtn) {
        // Need at least 2 consecutive intervals selected
        const canMerge = canMergeSelected();
        mergeBtn.disabled = !canMerge;
    }
}

// Check if selected intervals can be merged (must be consecutive)
function canMergeSelected() {
    if (paxLoadsSelected.size < 2) return false;
    
    const displayData = getDisplayPaxData();
    const selectedIndices = [];
    
    displayData.forEach((item, index) => {
        if (paxLoadsSelected.has(item.label)) {
            selectedIndices.push(index);
        }
    });
    
    // Check if consecutive
    for (let i = 1; i < selectedIndices.length; i++) {
        if (selectedIndices[i] - selectedIndices[i-1] !== 1) {
            return false;
        }
    }
    
    return true;
}

// Merge selected intervals
function mergePaxLoadsSelected() {
    if (!canMergeSelected()) return;
    
    const displayData = getDisplayPaxData();
    const selectedItems = displayData.filter(d => paxLoadsSelected.has(d.label));
    
    if (selectedItems.length < 2) return;
    
    // Sort by time
    selectedItems.sort((a, b) => {
        const aStart = parseInt(a.label.split(':')[0]);
        const bStart = parseInt(b.label.split(':')[0]);
        return aStart - bStart;
    });
    
    // Get start and end times
    const firstLabel = selectedItems[0].label;
    const lastLabel = selectedItems[selectedItems.length - 1].label;
    
    const startTime = firstLabel.split(' - ')[0];
    const endTime = lastLabel.split(' - ')[1];
    const newLabel = startTime + ' - ' + endTime;
    
    // Calculate total pax
    const totalPax = selectedItems.reduce((sum, item) => sum + item.pax, 0);
    
    // Get all original labels (including any that were already merged)
    const originalLabels = [];
    selectedItems.forEach(item => {
        if (item.merged && item.mergedFrom) {
            originalLabels.push(...item.mergedFrom);
            // Remove the old merge entry
            delete paxLoadsMerged[item.label];
        } else {
            originalLabels.push(item.label);
        }
    });
    
    // Store merge
    paxLoadsMerged[newLabel] = {
        originalLabels: originalLabels,
        totalPax: totalPax
    };
    
    // Clear selection
    paxLoadsSelected.clear();
    
    // Re-render
    renderPaxLoadsTable();
}

// Unmerge a specific interval
function unmergePaxInterval(label) {
    if (paxLoadsMerged[label]) {
        delete paxLoadsMerged[label];
        paxLoadsSelected.clear();
        renderPaxLoadsTable();
    }
}

// Reset all merges
function resetPaxLoads() {
    paxLoadsMerged = {};
    paxLoadsSelected.clear();
    renderPaxLoadsTable();
}

// Close Pax Loads modal
function closePaxLoadsModal() {
    const overlay = document.getElementById('pax-loads-overlay');
    if (overlay) overlay.remove();
}

function openLeadershipTeamModal() {
    console.log(' Opening Leadership Team Modal');
    
    // Initialize if needed
    initializeLeadershipData();
    
    const overlay = document.createElement('div');
    overlay.className = 'leadership-modal-overlay';
    overlay.id = 'leadership-modal-overlay';
    
    const modal = document.createElement('div');
    modal.className = 'leadership-modal';
    
    // Check if user is in team leader mode
    const isTeamLeaderMode = leadershipUnlocked;
    
    // Generate position rows
    let positionRowsHTML = '';
    
    if (isTeamLeaderMode) {
        // Team Leader view - show button grids and toggles
        LEADERSHIP_POSITIONS.forEach(position => {
            const data = leadershipData[position] || { name: '', visible: false };
            const visibleClass = data.visible ? 'visible' : '';
            const toggleClass = 'visibility-toggle ' + visibleClass;
            
            // Check if current name is a custom name (not in the predefined list)
            const isCustomName = data.name && !LEADERSHIP_NAMES.includes(data.name) && data.name !== '';
            
            positionRowsHTML += `
                <div class="leadership-position-row-grid">
                    <div class="leadership-position-header">
                        <div class="leadership-position-label">${position}</div>
                        <div class="${toggleClass}" data-position="${position}" onclick="toggleLeadershipVisibility('${position}')">
                            <div class="visibility-toggle-slider"></div>
                        </div>
                    </div>
                    <div class="leadership-name-grid" data-position="${position}">
                        <button class="name-btn ${data.name === '' ? 'selected' : ''}" onclick="selectLeadershipName('${position}', '')">None</button>
                        ${LEADERSHIP_NAMES.map(name => 
                            `<button class="name-btn ${data.name === name ? 'selected' : ''}" onclick="selectLeadershipName('${position}', '${name}')">${name}</button>`
                        ).join('')}
                        <button class="name-btn other-btn ${isCustomName ? 'selected' : ''}" onclick="showCustomNameInput('${position}')">+ Other</button>
                    </div>
                    <div class="custom-name-input-container" id="custom-input-${position.replace(/[^a-zA-Z0-9]/g, '-')}" style="display: ${isCustomName ? 'flex' : 'none'};">
                        <input type="text" class="custom-name-input" id="custom-name-${position.replace(/[^a-zA-Z0-9]/g, '-')}" placeholder="Enter name..." value="${isCustomName ? data.name : ''}" onkeypress="handleCustomNameKeypress(event, '${position}')">
                        <button class="custom-name-save-btn" onclick="saveCustomName('${position}')"></button>
                        <button class="custom-name-cancel-btn" onclick="cancelCustomName('${position}')"></button>
                    </div>
                </div>
            `;
        });
    } else {
        // Public view - Option B: Compact List with Color Bar (grouped by role type)
        // Group positions by role type
        const teamLeaders = [];
        const rosPositions = [];
        const tamPositions = [];
        
        LEADERSHIP_POSITIONS.forEach(position => {
            const data = leadershipData[position] || { name: '', visible: false };
            if (data.visible && data.name) {
                if (position.startsWith('Team Leader') || position.startsWith('TL ')) {
                    teamLeaders.push({ position, name: data.name });
                } else if (position.startsWith('ROS')) {
                    rosPositions.push({ position, name: data.name });
                } else if (position.startsWith('TAM')) {
                    tamPositions.push({ position, name: data.name });
                }
            }
        });
        
        let hasVisiblePositions = teamLeaders.length > 0 || rosPositions.length > 0 || tamPositions.length > 0;
        
        // Helper function to render a role group (Option B style)
        const renderRoleGroup = (groupIcon, groupName, positions) => {
            if (positions.length === 0) return '';
            
            let groupHTML = `<div class="leadership-group">
                <div class="leadership-group-header">${groupIcon} ${groupName}</div>
                <div class="leadership-group-list">`;
            
            positions.forEach(item => {
                groupHTML += `
                    <div class="leadership-public-row">
                        <div class="leadership-color-bar"></div>
                        <div class="leadership-public-position">${item.position}</div>
                        <div class="leadership-public-name">${item.name}</div>
                    </div>
                `;
            });
            
            groupHTML += '</div></div>';
            return groupHTML;
        };
        
        positionRowsHTML = renderRoleGroup('', 'TEAM LEADERS', teamLeaders);
        positionRowsHTML += renderRoleGroup('', 'ROS', rosPositions);
        positionRowsHTML += renderRoleGroup('', 'TAM', tamPositions);
        
        // If no visible positions, show a message
        if (!hasVisiblePositions) {
            positionRowsHTML = '<div class="leadership-no-data">No leadership team published yet.</div>';
        }
    }
    
    // Last published info
    let lastPublishedHTML = '';
    if (leadershipPublishedAt && leadershipPublishedBy) {
        const publishDate = new Date(leadershipPublishedAt);
        const dateStr = publishDate.toLocaleDateString('en-AU', { day: '2-digit', month: '2-digit' });
        const timeStr = publishDate.toLocaleTimeString('en-AU', { hour: '2-digit', minute: '2-digit', hour12: false });
        lastPublishedHTML = `<div class="leadership-last-published">Last: ${dateStr} ${timeStr} - ${leadershipPublishedBy}</div>`;
    }
    
    // Footer buttons
    let footerButtonsHTML = '';
    if (isTeamLeaderMode) {
        footerButtonsHTML = `
            <button class="leadership-btn exit-edit" id="exit-edit-btn" type="button">
                 View Mode
            </button>
            <button class="leadership-btn clear-all" id="clear-all-btn" type="button">
                 Clear All
            </button>
            <button class="leadership-btn publish visible" id="publish-leadership-btn" type="button">
                 Publish
            </button>
        `;
    } else {
        // Show Edit Mode button if supervisor has access, otherwise Team Leader Login
        if (supervisorAccessUnlocked) {
            footerButtonsHTML = `
                <button class="leadership-btn edit-mode" onclick="enterLeadershipEditMode()">
                     Edit Mode
                </button>
            `;
        } else {
            footerButtonsHTML = `
                <button class="leadership-btn unlock" onclick="unlockLeadershipMode()">
                     Team Leader Login
                </button>
            `;
        }
    }
    
    modal.innerHTML = `
        <div class="leadership-modal-header">
            <div class="leadership-modal-title"> Leadership Team On Shift ${isTeamLeaderMode ? '<span class="edit-mode-badge"> EDIT MODE</span>' : ''}</div>
            <button class="leadership-close-btn" onclick="closeLeadershipModal()"> </button>
        </div>
        
        <div class="leadership-modal-content">
            ${positionRowsHTML}
        </div>
        
        <div class="leadership-modal-footer">
            ${lastPublishedHTML}
            <div class="leadership-actions">
                ${footerButtonsHTML}
            </div>
        </div>
    `;
    
    overlay.appendChild(modal);
    document.body.appendChild(overlay);
    
    // Add click handler for publish button if in team leader mode
    if (isTeamLeaderMode) {
        const publishBtn = document.getElementById('publish-leadership-btn');
        if (publishBtn) {
            publishBtn.addEventListener('click', function(e) {
                e.preventDefault();
                e.stopPropagation();
                console.log('Publish button clicked via event listener');
                publishLeadershipTeam();
            });
            console.log(' Publish button event listener attached');
        }
        
        // Clear All button
        const clearAllBtn = document.getElementById('clear-all-btn');
        if (clearAllBtn) {
            clearAllBtn.addEventListener('click', function(e) {
                e.preventDefault();
                e.stopPropagation();
                clearAllLeadership();
            });
            console.log(' Clear All button event listener attached');
        }
        
        // Exit Edit Mode button
        const exitEditBtn = document.getElementById('exit-edit-btn');
        if (exitEditBtn) {
            exitEditBtn.addEventListener('click', function(e) {
                e.preventDefault();
                e.stopPropagation();
                exitLeadershipEditMode();
            });
            console.log(' Exit Edit Mode button event listener attached');
        }
    }
    
    console.log(' Leadership Team Modal opened');
}

// Close leadership modal
function closeLeadershipModal() {
    const overlay = document.getElementById('leadership-modal-overlay');
    if (overlay) {
        overlay.remove();
    }
}

// Clear all leadership selections (local only - no Firebase call)
function clearAllLeadership() {
    if (confirm('Are you sure you want to clear all selections? This will reset all names and visibility toggles.')) {
        // Reset all positions
        LEADERSHIP_POSITIONS.forEach(position => {
            leadershipData[position] = { name: '', visible: false };
        });
        
        console.log(' All leadership selections cleared');
        
        // Refresh the modal to show cleared state
        closeLeadershipModal();
        openLeadershipTeamModal();
    }
}

// Exit edit mode and return to public view
function exitLeadershipEditMode() {
    // Temporarily disable edit mode to show public view
    const wasUnlocked = leadershipUnlocked;
    leadershipUnlocked = false;
    
    // Reopen modal in public view mode
    closeLeadershipModal();
    openLeadershipTeamModal();
    
    // Restore the unlocked state so they can go back to edit mode
    leadershipUnlocked = wasUnlocked;
    
    console.log(' Switched to public view mode');
}

// Enter edit mode from public view (for supervisors who already have access)
function enterLeadershipEditMode() {
    leadershipUnlocked = true;
    closeLeadershipModal();
    openLeadershipTeamModal();
    console.log(' Entered edit mode');
}

// Unlock leadership editing mode
function unlockLeadershipMode() {
    // TAM Mode: Skip password prompt entirely
    if (isTAMMode) {
        leadershipUnlocked = true;
        supervisorAccessUnlocked = true;
        closeLeadershipModal();
        openLeadershipTeamModal();
        console.log('TAM Mode - Leadership unlocked automatically');
        return;
    }
    // Check if already unlocked via supervisor access
    if (supervisorAccessUnlocked) {
        leadershipUnlocked = true;
        closeLeadershipModal();
        openLeadershipTeamModal(); // Reopen in edit mode
        console.log(' Leadership mode unlocked (already had supervisor access)');
        return;
    }
    
    // Show supervisor password modal
    showSupervisorPasswordModal('leadership');
}

// Update leadership position assignment
function updateLeadershipPosition(position, name) {
    if (!leadershipData[position]) {
        leadershipData[position] = { name: '', visible: false };
    }
    leadershipData[position].name = name;
    console.log(` Updated ${position} to ${name}`);
}

// Select leadership name from button grid
function selectLeadershipName(position, name) {
    if (!leadershipData[position]) {
        leadershipData[position] = { name: '', visible: false };
    }
    leadershipData[position].name = name;
    
    // Hide custom input if visible
    const positionId = position.replace(/[^a-zA-Z0-9]/g, '-');
    const customContainer = document.getElementById(`custom-input-${positionId}`);
    if (customContainer) {
        customContainer.style.display = 'none';
    }
    
    // Update button UI
    const grid = document.querySelector(`.leadership-name-grid[data-position="${position}"]`);
    if (grid) {
        grid.querySelectorAll('.name-btn').forEach(btn => {
            btn.classList.remove('selected');
        });
        // Find and select the clicked button
        grid.querySelectorAll('.name-btn').forEach(btn => {
            if ((name === '' && btn.textContent === 'None') || btn.textContent === name) {
                btn.classList.add('selected');
            }
        });
    }
    
    console.log(` Selected ${name || 'None'} for ${position}`);
}

// Show custom name input field
function showCustomNameInput(position) {
    const positionId = position.replace(/[^a-zA-Z0-9]/g, '-');
    const customContainer = document.getElementById(`custom-input-${positionId}`);
    const customInput = document.getElementById(`custom-name-${positionId}`);
    
    if (customContainer) {
        customContainer.style.display = 'flex';
    }
    
    if (customInput) {
        customInput.focus();
        customInput.select();
    }
    
    // Highlight the Other button
    const grid = document.querySelector(`.leadership-name-grid[data-position="${position}"]`);
    if (grid) {
        grid.querySelectorAll('.name-btn').forEach(btn => {
            btn.classList.remove('selected');
        });
        const otherBtn = grid.querySelector('.other-btn');
        if (otherBtn) {
            otherBtn.classList.add('selected');
        }
    }
}

// Save custom name
function saveCustomName(position) {
    const positionId = position.replace(/[^a-zA-Z0-9]/g, '-');
    const customInput = document.getElementById(`custom-name-${positionId}`);
    
    if (customInput && customInput.value.trim()) {
        const customName = customInput.value.trim();
        
        if (!leadershipData[position]) {
            leadershipData[position] = { name: '', visible: false };
        }
        leadershipData[position].name = customName;
        
        console.log(` Custom name "${customName}" saved for ${position}`);
    }
}

// Cancel custom name entry
function cancelCustomName(position) {
    const positionId = position.replace(/[^a-zA-Z0-9]/g, '-');
    const customContainer = document.getElementById(`custom-input-${positionId}`);
    const customInput = document.getElementById(`custom-name-${positionId}`);
    
    // Check if there was a previously selected name
    const data = leadershipData[position] || { name: '', visible: false };
    const isCustomName = data.name && !LEADERSHIP_NAMES.includes(data.name) && data.name !== '';
    
    if (!isCustomName) {
        // Hide the input and clear it
        if (customContainer) {
            customContainer.style.display = 'none';
        }
        if (customInput) {
            customInput.value = '';
        }
        
        // Remove selection from Other button
        const grid = document.querySelector(`.leadership-name-grid[data-position="${position}"]`);
        if (grid) {
            const otherBtn = grid.querySelector('.other-btn');
            if (otherBtn) {
                otherBtn.classList.remove('selected');
            }
            
            // Re-select the current name if any
            if (data.name) {
                grid.querySelectorAll('.name-btn').forEach(btn => {
                    if (btn.textContent === data.name) {
                        btn.classList.add('selected');
                    }
                });
            } else {
                // Select "None" if no name
                grid.querySelectorAll('.name-btn').forEach(btn => {
                    if (btn.textContent === 'None') {
                        btn.classList.add('selected');
                    }
                });
            }
        }
    }
}

// Handle Enter key in custom name input
function handleCustomNameKeypress(event, position) {
    if (event.key === 'Enter') {
        saveCustomName(position);
    }
}

// Toggle visibility for a position
function toggleLeadershipVisibility(position) {
    if (!leadershipUnlocked) {
        return; // Can't toggle if not unlocked
    }
    
    if (!leadershipData[position]) {
        leadershipData[position] = { name: '', visible: false };
    }
    
    leadershipData[position].visible = !leadershipData[position].visible;
    
    // Update the toggle UI
    const toggle = document.querySelector(`.visibility-toggle[data-position="${position}"]`);
    if (toggle) {
        if (leadershipData[position].visible) {
            toggle.classList.add('visible');
        } else {
            toggle.classList.remove('visible');
        }
    }
    
    console.log(` Toggled visibility for ${position}: ${leadershipData[position].visible}`);
}

// Publish leadership team to Firebase
function publishLeadershipTeam() {
    try {
        console.log(' Publish button clicked');
        console.log('leadershipUnlocked:', leadershipUnlocked);
        console.log('currentUser:', currentUser);
        console.log('firebaseInitialized:', firebaseInitialized);
        
        if (!leadershipUnlocked) {
            alert('You must unlock Team Leader mode first');
            return;
        }
        
        // Use the logged-in user's name directly
        let publisherName = currentUser?.name;
        console.log('publisherName:', publisherName);
        
        if (!publisherName) {
            alert('You must be logged in to publish. Please log in first.');
            return;
        }
        
        leadershipPublishedBy = publisherName;
        leadershipPublishedAt = new Date().toISOString();
        
        // Sanitize leadership data keys for Firebase (replace invalid characters)
        const sanitizedData = {};
        Object.keys(leadershipData).forEach(key => {
            // Replace characters not allowed in Firebase keys: . # $ / [ ]
            const sanitizedKey = key.replace(/[.#$/\[\]]/g, '_');
            sanitizedData[sanitizedKey] = leadershipData[key];
        });
        
        console.log('Publishing with:', { publisherName, sanitizedData });
        
        // Save to Firebase
        if (firebaseInitialized) {
            const dateKey = getTodayDateKey();
            console.log('Saving to Firebase path: leadership/' + dateKey);
            
            const leadershipRef = firebase.database().ref(`leadership/${dateKey}`);
            leadershipRef.set({
                data: sanitizedData,
                publishedBy: leadershipPublishedBy,
                publishedAt: leadershipPublishedAt
            }).then(() => {
                console.log(' Leadership team published to Firebase');
                alert('Leadership team published successfully by ' + publisherName + '!');
                closeLeadershipModal();
            }).catch(error => {
                console.error(' Error publishing leadership team:', error);
                alert('Error publishing: ' + error.message);
            });
        } else {
            console.log(' Firebase not available - leadership data saved locally only');
            alert('Leadership team saved locally. Firebase sync not available.');
            closeLeadershipModal();
        }
    } catch (error) {
        console.error(' Exception in publishLeadershipTeam:', error);
        alert('Error: ' + error.message);
    }
}

// Leadership Firebase listener reference
let leadershipListener = null;

// Load leadership data from Firebase with real-time listener
function loadLeadershipData() {
    if (!firebaseInitialized) {
        console.log(' Firebase not initialized - using local leadership data');
        return;
    }
    
    const leadershipRef = firebase.database().ref(`leadership/${getTodayDateKey()}`);
    
    // Remove existing listener if any
    if (leadershipListener) {
        leadershipRef.off('value', leadershipListener);
    }
    
    // Set up real-time listener
    leadershipListener = leadershipRef.on('value', snapshot => {
        const data = snapshot.val();
        
        if (data) {
            // Unsanitize the keys back to original position names
            const rawData = data.data || {};
            leadershipData = {};
            
            // Map sanitized keys back to original position names
            LEADERSHIP_POSITIONS.forEach(position => {
                const sanitizedKey = position.replace(/[.#$/\[\]]/g, '_');
                if (rawData[sanitizedKey]) {
                    leadershipData[position] = rawData[sanitizedKey];
                }
            });
            
            leadershipPublishedBy = data.publishedBy;
            leadershipPublishedAt = data.publishedAt;
            console.log(' Leadership data updated from Firebase');
        } else {
            console.log(' No leadership data for today');
            initializeLeadershipData();
        }
    }, error => {
        console.error(' Error loading leadership data:', error);
        initializeLeadershipData();
    });
}

// Get today's date key for Firebase
function getTodayDateKey() {
    const date = flightDate || new Date();
    const day = String(date.getDate()).padStart(2, '0');
    const month = String(date.getMonth() + 1).padStart(2, '0');
    const year = date.getFullYear();
    return `${day}-${month}-${year}`;
}

// Get leadership roster for summary report
function getLeadershipRosterForReport() {
    const visibleLeaders = [];
    
    console.log(' Getting leadership roster for report. Current data:', leadershipData);
    
    LEADERSHIP_POSITIONS.forEach(position => {
        const data = leadershipData[position];
        if (data && data.visible && data.name) {
            visibleLeaders.push({
                position: position,
                name: data.name
            });
        }
    });
    
    console.log(' Visible leaders for report:', visibleLeaders);
    
    return visibleLeaders;
}

// ============================================
// BUSYNESS TRACKER SYSTEM
// ============================================

const BUSYNESS_LOCATIONS = ['Check-In Area', 'Zone E', 'ABDs', 'Service Desk'];

// ============================================
// UNIVERSAL BUSYNESS NOTIFICATION SYSTEM
// ============================================
// Tracks busyness updates across all devices with fixed 20-minute intervals
// Operating hours: 04:00 - 22:30 (Zone E ends at 12:00)

const BUSYNESS_NOTIFICATION_CONFIG = {
    startHour: 4,        // 04:00
    startMinute: 0,
    endHour: 22,         // 22:30
    endMinute: 30,
    zoneEEndHour: 12,    // Zone E ends at 12:00 PM
    zoneEEndMinute: 0,
    intervalMinutes: 20, // Check every 20 minutes
    graceMinutes: 20     // First check at 04:20 (grace period)
};

let universalBusynessCheckInterval = null;
let busynessNotificationShowing = false;

// Get the current 20-minute window start time
function getCurrentBusynessWindow() {
    const now = new Date();
    const hours = now.getHours();
    const minutes = now.getMinutes();
    
    // Calculate which 20-minute window we're in
    const windowIndex = Math.floor(minutes / 20);
    const windowStartMinute = windowIndex * 20;
    
    return {
        hour: hours,
        minute: windowStartMinute,
        windowKey: hours.toString().padStart(2, '0') + ':' + windowStartMinute.toString().padStart(2, '0')
    };
}

// Check if current time is within operating hours
function isWithinBusynessOperatingHours() {
    const now = new Date();
    const hours = now.getHours();
    const minutes = now.getMinutes();
    const currentTime = hours * 60 + minutes;
    
    const startTime = BUSYNESS_NOTIFICATION_CONFIG.startHour * 60 + BUSYNESS_NOTIFICATION_CONFIG.startMinute;
    const endTime = BUSYNESS_NOTIFICATION_CONFIG.endHour * 60 + BUSYNESS_NOTIFICATION_CONFIG.endMinute;
    
    return currentTime >= startTime && currentTime <= endTime;
}

// Check if Zone E is still operating
function isZoneEOperating() {
    // If viewing a future date, Zone E should always be available for viewing/preparation
    if (flightDate) {
        const today = new Date();
        today.setHours(0, 0, 0, 0);
        const flightDateOnly = new Date(flightDate);
        flightDateOnly.setHours(0, 0, 0, 0);
        
        // If flight date is in the future, show Zone E
        if (flightDateOnly > today) {
            console.log(' Viewing future date - Zone E available for preparation');
            return true;
        }
    }
    
    // For today's date, check actual time
    const now = new Date();
    const hours = now.getHours();
    const minutes = now.getMinutes();
    const currentTime = hours * 60 + minutes;
    
    const zoneEEndTime = BUSYNESS_NOTIFICATION_CONFIG.zoneEEndHour * 60 + BUSYNESS_NOTIFICATION_CONFIG.zoneEEndMinute;
    
    return currentTime < zoneEEndTime;
}

// Check if we're past the initial grace period (04:20)
function isPastGracePeriod() {
    const now = new Date();
    const hours = now.getHours();
    const minutes = now.getMinutes();
    const currentTime = hours * 60 + minutes;
    
    const graceEndTime = BUSYNESS_NOTIFICATION_CONFIG.startHour * 60 + BUSYNESS_NOTIFICATION_CONFIG.graceMinutes;
    
    return currentTime >= graceEndTime;
}

// Start the universal busyness check system
function startUniversalBusynessCheck() {
    if (universalBusynessCheckInterval) {
        clearInterval(universalBusynessCheckInterval);
    }
    
    // Check every 2 minutes to conserve Firebase quota
    universalBusynessCheckInterval = setInterval(() => {
        console.log(' 2-minute interval check running...');
        checkUniversalBusynessNotifications();
    }, 120000); // Check every 2 minutes
    
    // Initial busyness check is triggered AFTER login/PIN verification
    // Not on page load - this is handled by handleSuccessfulLogin and verifyStillThere
    console.log(' Busyness system ready - will check after user login/verification');
    
    console.log(' Universal busyness notification system started');
}

// Screen wake-up listener for busyness notifications
document.addEventListener('visibilitychange', function() {
    if (document.visibilityState === 'visible') {
        console.log(' Screen woke up - checking busyness notifications');
        setTimeout(() => {
            checkUniversalBusynessNotifications();
        }, 1000);
    }
});

// Main check function - runs every minute
function checkUniversalBusynessNotifications() {
    // Only check if within operating hours (04:00 - 22:30)
    if (!isWithinBusynessOperatingHours()) {
        // No action needed (using new prompt system)
        return;
    }
    
    // Grace period: 04:00 - 04:20 (no prompts)
    if (!isPastGracePeriod()) {
        // No action needed (using new prompt system)
        return;
    }
    
    // Check immediately - no boundary restriction
    checkLocationsNeedingUpdate();
}

// Check Firebase for locations missing data in current window
// Helper function to get local date key without UTC conversion
function getLocalDateKey() {
    const now = new Date();
    return now.getFullYear() + '-' + String(now.getMonth() + 1).padStart(2, '0') + '-' + String(now.getDate()).padStart(2, '0');
}

// Get flightDate as local date key (no UTC conversion)
function getFlightDateKey() {
    if (!flightDate) return getLocalDateKey();
    // flightDate is already a local Date object
    return flightDate.getFullYear() + '-' + String(flightDate.getMonth() + 1).padStart(2, '0') + '-' + String(flightDate.getDate()).padStart(2, '0');
}

function checkLocationsNeedingUpdate() {
    if (!firebaseInitialized) {
        console.log(' Firebase not initialized, skipping busyness check');
        return;
    }
    
    const dateKey = getLocalDateKey();
    const now = Date.now();
    const twentyMinutesAgo = now - (20 * 60 * 1000);
    
    console.log(' Checking busyness updates at', new Date().toLocaleTimeString('en-AU'));
    console.log('   Date key:', dateKey);
    
    // Reference to the busyness tracking node for today (timestamp-based)
    const trackingRef = firebase.database().ref('busyness_last_update_' + dateKey);
    
    trackingRef.once('value', (snapshot) => {
        const lastUpdateData = snapshot.val() || {};
        const locationsMissingData = [];
        
        console.log('   Firebase data:', JSON.stringify(lastUpdateData));
        
        // Check each location
        BUSYNESS_LOCATIONS.forEach(location => {
            // Skip Zone E if past its operating hours (12:00 PM)
            if (location === 'Zone E' && !isZoneEOperating()) {
                console.log('   Skipping Zone E (past 12pm)');
                return;
            }
            
            // Check if this location has been updated in the last 20 minutes
            const locationKey = location.replace(/[^a-zA-Z0-9]/g, '_');
            const lastUpdate = lastUpdateData[locationKey]?.timestamp || 0;
            const minutesSinceUpdate = lastUpdate ? Math.floor((now - lastUpdate) / 60000) : 'never';
            
            console.log('   ' + location + ': last update ' + minutesSinceUpdate + ' mins ago');
            
            if (lastUpdate < twentyMinutesAgo) {
                locationsMissingData.push(location);
            }
        });
        
        if (locationsMissingData.length > 0) {
            console.log(' TRIGGERING MODAL for:', locationsMissingData);
            showBusynessPrompt(locationsMissingData);
        } else {
            console.log(' All locations up to date');
            // No prompt needed - all locations up to date
        }
    }).catch(err => {
        console.error(' Firebase error in checkLocationsNeedingUpdate:', err);
    });
}

// Mark a location as updated in Firebase for current window
function markLocationUpdatedInWindow(location) {
    if (!firebaseInitialized) return;
    
    const dateKey = getLocalDateKey();
    const locationKey = location.replace(/[^a-zA-Z0-9]/g, '_');
    
    // Use timestamp-based tracking path
    const trackingRef = firebase.database().ref('busyness_last_update_' + dateKey + '/' + locationKey);
    
    trackingRef.set({
        timestamp: Date.now(),
        updatedBy: currentUser ? currentUser.name : 'Unknown'
    });
    
    console.log(' Marked ' + location + ' as updated at ' + new Date().toLocaleTimeString('en-AU'));
    
    // Show "Would you like to update another section?" popup
    setTimeout(() => {
        showUpdateAnotherPrompt(location);
    }, 300);
}

// Show notification for locations needing update
// Check busyness after authentication (login or PIN)
function checkBusynessAfterAuth() {
    // Skip if not within operating hours (04:00 - 22:30)
    if (!isWithinBusynessOperatingHours()) {
        console.log(' Outside busyness operating hours, skipping check');
        return;
    }
    
    // Skip during grace period (04:00 - 04:20)
    if (!isPastGracePeriod()) {
        console.log(' Within grace period (04:00-04:20), skipping check');
        return;
    }
    
    // Check Firebase for locations needing updates
    if (!firebaseInitialized) {
        console.log(' Firebase not ready, skipping busyness check');
        return;
    }
    
    const dateKey = getLocalDateKey();
    const now = Date.now();
    const twentyMinutesAgo = now - (20 * 60 * 1000);
    
    const trackingRef = firebase.database().ref('busyness_last_update_' + dateKey);
    
    trackingRef.once('value', (snapshot) => {
        const lastUpdateData = snapshot.val() || {};
        const locationsMissingData = [];
        
        BUSYNESS_LOCATIONS.forEach(location => {
            // Skip Zone E if past 12:00 PM
            if (location === 'Zone E' && !isZoneEOperating()) {
                return;
            }
            
            const locationKey = location.replace(/[^a-zA-Z0-9]/g, '_');
            const lastUpdate = lastUpdateData[locationKey]?.timestamp || 0;
            
            if (lastUpdate < twentyMinutesAgo) {
                locationsMissingData.push(location);
            }
        });
        
        if (locationsMissingData.length > 0) {
            console.log(' Locations need busyness update:', locationsMissingData);
            showBusynessPrompt(locationsMissingData);
        } else {
            console.log(' All busyness data up to date');
        }
    });
}

// Store locations that need updating globally
window.locationsNeedingUpdate = [];

// Show clean white full-screen prompt with section buttons
function showBusynessPrompt(locations) {
    // Remove any existing prompt
    const existingPrompt = document.getElementById('busyness-prompt-overlay');
    if (existingPrompt) existingPrompt.remove();
    
    window.locationsNeedingUpdate = locations;
    busynessNotificationShowing = true;
    
    // Create full-screen white overlay
    const overlay = document.createElement('div');
    overlay.id = 'busyness-prompt-overlay';
    overlay.style.cssText = 'position:fixed;top:0;left:0;right:0;bottom:0;background:#ffffff;z-index:99998;display:flex;align-items:center;justify-content:center;flex-direction:column;';
    
    // Build buttons HTML (2x2 grid for locations that need updating)
    let buttonsHTML = '<div style="display:grid;grid-template-columns:repeat(2,1fr);gap:15px;width:100%;max-width:320px;">';
    locations.forEach(location => {
        buttonsHTML += '<button class="busyness-prompt-btn" data-location="' + location + '" style="background:#000345;color:white;border:3px solid #FA5116;padding:20px 15px;border-radius:12px;font-size:16px;font-weight:bold;cursor:pointer;transition:all 0.2s;min-height:80px;">' + location + '</button>';
    });
    buttonsHTML += '</div>';
    
    overlay.innerHTML = 
        '<div style="text-align:center;padding:20px;max-width:400px;">' +
            '<div style="font-size:60px;margin-bottom:20px;"></div>' +
            '<div style="font-size:24px;font-weight:bold;color:#000345;margin-bottom:10px;">Busyness Update Required</div>' +
            '<div style="font-size:15px;color:#666;margin-bottom:25px;">The following sections have not been updated in the last 20 minutes. Tap a section to update it.</div>' +
            buttonsHTML +
            '<div style="font-size:13px;color:#999;margin-top:20px;">Tap any section to update it</div>' +
        '</div>';
    
    document.body.appendChild(overlay);
    
    // Add hover effects and click handlers
    overlay.querySelectorAll('.busyness-prompt-btn').forEach(btn => {
        btn.onmouseenter = function() {
            this.style.background = '#FA5116';
            this.style.transform = 'scale(1.05)';
        };
        btn.onmouseleave = function() {
            this.style.background = '#000345';
            this.style.transform = 'scale(1)';
        };
        btn.onclick = function(e) {
            e.preventDefault();
            e.stopPropagation();
            const location = this.dataset.location;
            console.log(' Button clicked for location:', location);
            try {
                openBusynessToSection(location);
            } catch (err) {
                console.error(' Error in openBusynessToSection:', err);
                alert('Error opening busyness panel: ' + err.message);
            }
        };
    });
    
    console.log(' Busyness prompt displayed with', locations.length, 'locations');
}

// Open busyness tracker directly to a specific section
function openBusynessToSection(location) {
    console.log(' openBusynessToSection called for:', location);
    
    // COMPLETELY REMOVE the prompt (not just hide)
    const prompt = document.getElementById('busyness-prompt-overlay');
    if (prompt) {
        prompt.remove();
        console.log(' Removed prompt overlay');
    }
    
    // Store the target location
    window.pendingBusynessLocationToOpen = location;
    
    // Check if panel already exists
    const existingPanel = document.getElementById('busyness-panel-overlay');
    if (existingPanel) {
        console.log(' Panel already exists, removing first');
        existingPanel.remove();
    }
    
    // Open the busyness panel (this creates it dynamically)
    console.log(' Opening busyness panel...');
    openBusynessPanel();
    
    // After panel is created, scroll to and highlight the location
    setTimeout(() => {
        console.log(' Looking for location sections...');
        const locationSections = document.querySelectorAll('.busyness-location');
        console.log('Found', locationSections.length, 'location sections');
        
        locationSections.forEach(section => {
            const sectionLocation = section.getAttribute('data-location');
            if (sectionLocation === location) {
                console.log(' Found and highlighting:', location);
                // Scroll this section into view
                section.scrollIntoView({ behavior: 'smooth', block: 'center' });
                // Add highlight
                section.style.boxShadow = '0 0 20px #FA5116';
                section.style.border = '3px solid #FA5116';
            }
        });
        
        // Highlight all locations that need updating
        highlightBusynessLocationsInPanel();
    }, 300);
    
    busynessNotificationShowing = false;
}

// Highlight busyness locations in panel that need updating
function highlightBusynessLocationsInPanel() {
    // Add animation style if not exists
    if (!document.getElementById('busyness-highlight-style')) {
        const style = document.createElement('style');
        style.id = 'busyness-highlight-style';
        style.textContent = '@keyframes pulse-glow { 0%, 100% { box-shadow: 0 0 8px #FA5116; } 50% { box-shadow: 0 0 20px #FA5116, 0 0 30px #FA5116; } }' +
            '.busyness-needs-update { animation: pulse-glow 1.5s infinite !important; border: 3px solid #FA5116 !important; position: relative !important; }' +
            '.busyness-needs-update .busyness-location-name::after { content: "  UPDATE"; color: #FA5116; font-size: 12px; font-weight: bold; margin-left: 10px; }';
        document.head.appendChild(style);
    }
    
    // Get current locations that still need updating
    const locations = window.locationsNeedingUpdate || [];
    
    // Apply highlighting to location sections in the panel
    const locationSections = document.querySelectorAll('.busyness-location');
    locationSections.forEach(section => {
        const sectionLocation = section.getAttribute('data-location');
        const needsUpdate = locations.some(loc => sectionLocation === loc);
        
        if (needsUpdate) {
            section.classList.add('busyness-needs-update');
        } else {
            section.classList.remove('busyness-needs-update');
        }
    });
}

// Alias for backward compatibility
function highlightBusynessTabs() {
    highlightBusynessLocationsInPanel();
}

// Remove highlighting from busyness locations
function clearBusynessTabHighlights() {
    const sections = document.querySelectorAll('.busyness-location');
    sections.forEach(section => {
        section.classList.remove('busyness-needs-update');
        section.style.boxShadow = '';
        section.style.border = '';
    });
}

// Show "Would you like to update another section?" popup after updating
function showUpdateAnotherPrompt(updatedLocation) {
    // Remove updated location from the list
    window.locationsNeedingUpdate = (window.locationsNeedingUpdate || []).filter(loc => loc !== updatedLocation);
    
    // Update tab highlighting
    highlightBusynessTabs();
    
    // Check if there are more locations to update
    if (window.locationsNeedingUpdate.length === 0) {
        console.log(' All locations updated!');
        clearBusynessTabHighlights();
        busynessNotificationShowing = false;
        // Remove prompt overlay completely
        const prompt = document.getElementById('busyness-prompt-overlay');
        if (prompt) prompt.remove();
        return;
    }
    
    // Show popup asking if they want to update another
    const existingPopup = document.getElementById('update-another-popup');
    if (existingPopup) existingPopup.remove();
    
    const popup = document.createElement('div');
    popup.id = 'update-another-popup';
    popup.style.cssText = 'position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);background:white;border-radius:16px;padding:25px;box-shadow:0 10px 40px rgba(0,0,0,0.3);z-index:100000;text-align:center;max-width:90%;width:320px;border:3px solid #000345;';
    
    const remainingText = window.locationsNeedingUpdate.join(', ');
    
    popup.innerHTML = 
        '<div style="font-size:40px;margin-bottom:15px;"></div>' +
        '<div style="font-size:18px;font-weight:bold;color:#000345;margin-bottom:10px;">' + updatedLocation + ' Updated!</div>' +
        '<div style="font-size:14px;color:#666;margin-bottom:8px;">Would you like to update another section while you are here?</div>' +
        '<div style="font-size:13px;color:#FA5116;font-weight:600;margin-bottom:20px;">Remaining: ' + remainingText + '</div>' +
        '<div style="display:flex;gap:10px;justify-content:center;">' +
            '<button id="update-another-yes" style="background:#FA5116;color:white;border:none;padding:12px 24px;border-radius:8px;font-size:15px;font-weight:bold;cursor:pointer;">Yes, show me</button>' +
            '<button id="update-another-no" style="background:#f0f0f0;color:#333;border:none;padding:12px 24px;border-radius:8px;font-size:15px;font-weight:bold;cursor:pointer;">No, I am done</button>' +
        '</div>';
    
    document.body.appendChild(popup);
    
    // Click handlers
    document.getElementById('update-another-yes').onclick = function() {
        popup.remove();
        // Keep busyness panel open, user can click highlighted tabs
    };
    
    document.getElementById('update-another-no').onclick = function() {
        popup.remove();
        // Close busyness panel (the overlay contains the panel)
        const panelOverlay = document.getElementById('busyness-panel-overlay');
        if (panelOverlay) panelOverlay.remove();
        // Clear highlights
        clearBusynessTabHighlights();
        // Remove the initial prompt overlay if it still exists
        const promptOverlay = document.getElementById('busyness-prompt-overlay');
        if (promptOverlay) promptOverlay.remove();
        
        // Clear tracking variables so prompt doesn't re-appear
        window.locationsNeedingUpdate = [];
        busynessNotificationShowing = false;
        
        // User can now see flights - they updated THEIR location, done!
        console.log(' User done updating their location - can see flights now');
        console.log(' Other locations will be prompted to other users by the regular 20-min check');
    };
}

// Check pending busyness - simplified for new system
function checkPendingBusynessComplete() {
    // This is now handled by showUpdateAnotherPrompt
    return true;
}

// Remove busyness prompt overlay
function removeBusynessBlockingOverlay() {
    const overlay = document.getElementById('busyness-prompt-overlay');
    if (overlay) overlay.remove();
    
    const popup = document.getElementById('update-another-popup');
    if (popup) popup.remove();
    
    clearBusynessTabHighlights();
    busynessNotificationShowing = false;
}

// ============================================================
// BACKUP REDUNDANCY LAYER - Device Agnostic Busyness Check
// ============================================================
// This is a simple, robust backup that checks Firebase timestamps
// regardless of device type, power saving mode, or user activity
// ============================================================

let lastBusynessBackupCheck = 0;
const BACKUP_CHECK_COOLDOWN = 30000; // Don't spam checks - 30 second cooldown

// Simple backup check - just looks at Firebase timestamps
function backupBusynessCheck() {
    // Cooldown to prevent spam
    const now = Date.now();
    if (now - lastBusynessBackupCheck < BACKUP_CHECK_COOLDOWN) {
        return;
    }
    lastBusynessBackupCheck = now;
    
    // Must be logged in
    if (!isUserLoggedIn || !currentUser) {
        return;
    }
    
    // Must have Firebase
    if (!firebaseInitialized) {
        console.log(' Backup check: Firebase not ready');
        return;
    }
    
    // Check operating hours (04:00 - 22:30 Sydney time)
    const currentTime = new Date();
    const hours = currentTime.getHours();
    const minutes = currentTime.getMinutes();
    const totalMinutes = hours * 60 + minutes;
    
    // Outside operating hours (before 4am or after 10:30pm)
    if (totalMinutes < 240 || totalMinutes > 1350) {
        return;
    }
    
    // Grace period (04:00 - 04:20)
    if (totalMinutes >= 240 && totalMinutes < 260) {
        console.log(' Backup check: Within grace period, skipping');
        return;
    }
    
    // Already showing a prompt
    if (busynessNotificationShowing) {
        return;
    }
    
    console.log(' BACKUP CHECK running at', currentTime.toLocaleTimeString('en-AU'));
    
    // Check Firebase for last update times
    const dateKey = getLocalDateKey();
    const twentyMinutesAgo = now - (20 * 60 * 1000);
    
    const trackingRef = firebase.database().ref('busyness_last_update_' + dateKey);
    
    trackingRef.once('value', (snapshot) => {
        const lastUpdateData = snapshot.val() || {};
        const locationsMissingData = [];
        
        // Check each location
        ['Check-In Area', 'Zone E', 'ABDs', 'Service Desk'].forEach(location => {
            // Skip Zone E after 12:00 PM
            if (location === 'Zone E') {
                const zoneECutoff = 12 * 60; // 12:00 PM in minutes
                if (totalMinutes >= zoneECutoff) {
                    return;
                }
            }
            
            const locationKey = location.replace(/[^a-zA-Z0-9]/g, '_');
            const lastUpdate = lastUpdateData[locationKey]?.timestamp || 0;
            const minutesSinceUpdate = lastUpdate ? Math.floor((now - lastUpdate) / 60000) : 999;
            
            console.log('   ' + location + ': ' + minutesSinceUpdate + ' mins since last update');
            
            if (lastUpdate < twentyMinutesAgo) {
                locationsMissingData.push(location);
            }
        });
        
        if (locationsMissingData.length > 0 && !busynessNotificationShowing) {
            console.log(' BACKUP CHECK TRIGGERED - Missing:', locationsMissingData);
            showBusynessPrompt(locationsMissingData);
        }
    }).catch(err => {
        console.error('Backup check Firebase error:', err);
    });
}

// Run backup check on various events for maximum reliability
function setupBackupBusynessChecks() {
    console.log(' Setting up backup busyness checks (device-agnostic)');
    
    // 1. Visibility change (works on most devices)
    document.addEventListener('visibilitychange', function() {
        if (document.visibilityState === 'visible') {
            console.log(' Visibility change detected');
            setTimeout(backupBusynessCheck, 1000);
        }
    });
    
    // 2. Page focus (backup for visibility)
    window.addEventListener('focus', function() {
        console.log(' Window focus detected');
        setTimeout(backupBusynessCheck, 1000);
    });
    
    // 3. Touch events (mobile devices)
    document.addEventListener('touchstart', function() {
        backupBusynessCheck();
    }, { passive: true });
    
    // 4. Mouse events (desktop)
    document.addEventListener('mousedown', function() {
        backupBusynessCheck();
    });
    
    // 5. Scroll events (user is active)
    let scrollTimeout;
    document.addEventListener('scroll', function() {
        clearTimeout(scrollTimeout);
        scrollTimeout = setTimeout(backupBusynessCheck, 500);
    }, { passive: true });
    
    // 6. Interval backup - runs every 2 minutes regardless
    setInterval(function() {
        if (isUserLoggedIn && currentUser) {
            console.log(' Interval backup check...');
            backupBusynessCheck();
        }
    }, 120000);
    
    // 7. Page show event (iOS Safari specific)
    window.addEventListener('pageshow', function(event) {
        if (event.persisted) {
            console.log(' Page restored from cache (iOS)');
            setTimeout(backupBusynessCheck, 1000);
        }
    });
    
    console.log(' Backup checks ready: visibility, focus, touch, mouse, scroll, interval, pageshow');
}

// Initialize backup checks when DOM is ready
if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', setupBackupBusynessChecks);
} else {
    setupBackupBusynessChecks();
}

function showBusynessUpdateNotification(locations) {
    // DEPRECATED - Using new showBusynessPrompt system
    console.log('showBusynessUpdateNotification called - redirecting to new system');
    showBusynessPrompt(locations);
}

function attachLocationButtonHandlers() {
    const buttons = document.querySelectorAll('.busyness-modal-location-btn');
    buttons.forEach(btn => {
        btn.onclick = function() {
            const location = this.getAttribute('data-location');
            openBusynessFromNotification(location);
        };
    });
}

// Hide the blocking modal
function hideBusynessUpdateNotification() {
    // DEPRECATED - Using new prompt system
    removeBusynessBlockingOverlay();
}

// Temporarily dismiss (will reappear at next check if still needed)
function dismissBusynessNotificationTemporarily() {
    // No action needed (using new prompt system)
}

// Open busyness panel from notification
function openBusynessFromNotification(location) {
    // No action needed (using new prompt system)
    
    // Open the busyness panel
    const panel = document.getElementById('busyness-panel');
    if (panel) {
        panel.classList.add('open');
    }
    
    // Select the location tab
    setTimeout(() => {
        const tabs = document.querySelectorAll('.busyness-location-btn');
        tabs.forEach(tab => {
            if (tab.textContent.includes(location) || tab.dataset.location === location) {
                tab.click();
            }
        });
    }, 100);
}

// Listen for busyness updates from Firebase to auto-dismiss notifications
function setupBusynessNotificationListener() {
    if (!firebaseInitialized) return;
    
    const dateKey = getLocalDateKey();
    const windowKey = currentWindow.windowKey;
    
    const trackingRef = firebase.database().ref('busyness_window_tracking_' + dateKey + '/' + windowKey);
    
    trackingRef.on('value', (snapshot) => {
        // Re-check if all locations are now updated
        if (busynessNotificationShowing) {
            checkLocationsNeedingUpdate();
        }
    });
}
const BUSYNESS_LEVELS = [
    { id: 'quiet', icon: '', label: 'Quiet', color: '#22c55e' },
    { id: 'moderate', icon: '', label: 'Moderate', color: '#eab308' },
    { id: 'busy', icon: '', label: 'Busy', color: '#f97316' },
    { id: 'very-busy', icon: '', label: 'Very Busy', color: '#ef4444' },
    { id: 'chaos', icon: '', label: 'Chaos', color: '#1f2937' }
];
const BUSYNESS_COOLDOWN_MS = 5 * 60 * 1000; // 5 minutes per zone (global)
const BUSYNESS_INACTIVITY_REMINDER_MS = 30 * 60 * 1000; // 30 minutes inactivity reminder (changed from 1 hour)
const BUSYNESS_OPERATIONAL_START = 4; // 4:00 AM
const BUSYNESS_OPERATIONAL_END = 22; // 10:00 PM
const ZONE_E_CLOSE_HOUR = 12; // Zone E closes at 12:00 PM

// Busyness data - ALL synced via Firebase only (no localStorage for busyness)
let busynessCooldowns = {}; // Per-location cooldowns from Firebase
let busynessTimelineData = {}; // Timeline data for stepped graphs - synced from Firebase
let busynessInactivityInterval = null; // Interval for checking inactivity
let busynessReminderBlockingOverlay = null; // Blocking overlay for reminders
let lastReminderDismissTime = {}; // Track when reminders were dismissed per location

// Firebase usage tracking - NOW CENTRALIZED ACROSS ALL DEVICES
let firebaseUsageStats = {
    reads: 0,
    writes: 0,
    lastReset: Date.now()
};
let centralizedFirebaseUsage = {
    totalReads: 0,
    totalWrites: 0,
    activeDevices: 0,
    lastUpdated: null
};

// Load Firebase usage from localStorage (local device tracking)
function loadFirebaseUsageStats() {
    const saved = localStorage.getItem('firebase_usage_' + getTodayDateKey());
    if (saved) {
        firebaseUsageStats = JSON.parse(saved);
    } else {
        firebaseUsageStats = { reads: 0, writes: 0, lastReset: Date.now() };
    }
}

// Save Firebase usage to localStorage
function saveFirebaseUsageStats() {
    localStorage.setItem('firebase_usage_' + getTodayDateKey(), JSON.stringify(firebaseUsageStats));
}

// Track a Firebase read - LOCAL + CENTRALIZED
function trackFirebaseRead(count = 1) {
    firebaseUsageStats.reads += count;
    saveFirebaseUsageStats();
    
    // Also update centralized counter in Firebase
    updateCentralizedFirebaseUsage('reads', count);
}

// Track a Firebase write - LOCAL + CENTRALIZED
function trackFirebaseWrite(count = 1) {
    firebaseUsageStats.writes += count;
    saveFirebaseUsageStats();
    
    // Also update centralized counter in Firebase
    updateCentralizedFirebaseUsage('writes', count);
}

// Update centralized Firebase usage counter
function updateCentralizedFirebaseUsage(type, count) {
    if (!firebaseInitialized) return;
    
    const dateKey = getTodayDateKey();
    const deviceId = getDeviceId();
    
    // Update this device's contribution
    const deviceUsageRef = firebase.database().ref(`firebase_usage/${dateKey}/devices/${deviceId}/${type}`);
    deviceUsageRef.transaction(currentVal => {
        return (currentVal || 0) + count;
    });
    
    // Update total counter
    const totalRef = firebase.database().ref(`firebase_usage/${dateKey}/total${type.charAt(0).toUpperCase() + type.slice(1)}`);
    totalRef.transaction(currentVal => {
        return (currentVal || 0) + count;
    });
}

// Get unique device ID (persistent per device)
function getDeviceId() {
    let deviceId = localStorage.getItem('device_id');
    if (!deviceId) {
        deviceId = 'device_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
        localStorage.setItem('device_id', deviceId);
    }
    return deviceId;
}

// Setup listener for centralized Firebase usage
function setupCentralizedUsageListener() {
    if (!firebaseInitialized) return;
    
    const dateKey = getTodayDateKey();
    const usageRef = firebase.database().ref(`firebase_usage/${dateKey}`);
    
    usageRef.on('value', (snapshot) => {
        const data = snapshot.val() || {};
        centralizedFirebaseUsage = {
            totalReads: data.totalReads || 0,
            totalWrites: data.totalWrites || 0,
            activeDevices: data.devices ? Object.keys(data.devices).length : 0,
            lastUpdated: Date.now()
        };
        console.log(' Centralized Firebase usage updated:', centralizedFirebaseUsage);
    });
}

// Get Firebase usage for report - NOW RETURNS CENTRALIZED DATA
function getFirebaseUsageForReport() {
    return {
        dailyReads: centralizedFirebaseUsage.totalReads || firebaseUsageStats.reads,
        dailyWrites: centralizedFirebaseUsage.totalWrites || firebaseUsageStats.writes,
        activeDevices: centralizedFirebaseUsage.activeDevices || 1,
        monthlyReadLimit: 1500000,
        monthlyWriteLimit: 600000,
        dailyReadLimit: 50000,
        dailyWriteLimit: 20000,
        isCentralized: centralizedFirebaseUsage.totalReads > 0
    };
}

// Initialize busyness tracker - PURE FIREBASE (no localStorage for busyness data)
// Clean up deprecated Flight Close data from Firebase
function cleanupFlightCloseData() {
    if (!firebaseInitialized || !flightDate) return;
    
    const dateKey = getFlightDateKey();
    
    try {
        // Remove Flight Close from busyness cooldowns
        const cooldownRef = firebase.database().ref('busyness_cooldowns_' + dateKey + '/Flight Close');
        cooldownRef.remove().then(() => {
            console.log(' Removed Flight Close cooldown data');
        }).catch(() => {});
        
        // Remove Flight Close from busyness timeline
        const timelineRef = firebase.database().ref('busyness_timeline_' + dateKey + '/Flight Close');
        timelineRef.remove().then(() => {
            console.log(' Removed Flight Close timeline data');
        }).catch(() => {});
        
        // Also try alternate key format
        const cooldownRef2 = firebase.database().ref('busyness_cooldowns_' + dateKey + '/Flt Close');
        cooldownRef2.remove().catch(() => {});
        
        const timelineRef2 = firebase.database().ref('busyness_timeline_' + dateKey + '/Flt Close');
        timelineRef2.remove().catch(() => {});
        
    } catch (e) {
        console.log('Flight Close cleanup skipped:', e.message);
    }
}

function initializeBusynessTracker() {
    // Show the status bar (always when tracker is initialized)
    const statusBar = document.getElementById('busyness-status-bar');
    if (statusBar) statusBar.style.display = 'block';
    
    // Clean up deprecated Flight Close data from Firebase
    cleanupFlightCloseData();
    
    // Start universal busyness notification system
    startUniversalBusynessCheck();
    setupBusynessNotificationListener();
    
    // Listen for cooldown updates from Firebase (real-time sync)
    setupBusynessCooldownListener();
    
    // Listen for timeline data from Firebase (for stepped graphs)
    setupBusynessTimelineListener();
    
    // Setup centralized Firebase usage listener
    setupCentralizedUsageListener();
    
    // Start inactivity reminder checker (per-location)
    startBusynessInactivityChecker();
    
    // Initial status bar update
    updateBusynessStatusBar();
    
    console.log(' Busyness tracker initialized - PURE FIREBASE MODE (no localStorage)');
}

// Track if busyness listeners have been set up
let busynessListenersInitialized = false;

// Re-setup busyness Firebase listeners - call this when flightDate becomes available
function reinitializeBusynessListeners() {
    if (!firebaseInitialized || !flightDate) {
        console.log(' Cannot setup busyness listeners yet - Firebase:', firebaseInitialized, 'flightDate:', !!flightDate);
        return;
    }
    
    if (busynessListenersInitialized) {
        console.log(' Busyness listeners already initialized');
        return;
    }
    
    console.log(' Setting up busyness Firebase listeners for date:', getFlightDateKey());
    
    setupBusynessCooldownListener();
    setupBusynessTimelineListener();
    updateBusynessStatusBar();
    
    busynessListenersInitialized = true;
    console.log(' Busyness listeners initialized');
}

// Setup Firebase listener for busyness timeline data - INSTANT SYNC
function setupBusynessTimelineListener() {
    if (!firebaseInitialized || !flightDate) return;
    
    const dateKey = getFlightDateKey();
    const timelineRef = firebase.database().ref(`busyness_timeline_${dateKey}`);
    
    trackFirebaseRead();
    
    timelineRef.on('value', (snapshot) => {
        busynessTimelineData = snapshot.val() || {};
        console.log(' Busyness timeline data synced from Firebase:', Object.keys(busynessTimelineData).length, 'locations');
        
        // INSTANT UI UPDATE: Refresh any open busyness panel
        refreshBusynessPanelContent();
        
        trackFirebaseRead();
    });
}

// Start inactivity checker for 30-minute reminder (per location)
function startBusynessInactivityChecker() {
    // Clear any existing interval
    if (busynessInactivityInterval) {
        clearInterval(busynessInactivityInterval);
    }
    
    // Check every 1 minute for more responsive reminders
    busynessInactivityInterval = setInterval(() => {
        checkBusynessInactivityPerLocation();
    }, 1 * 60 * 1000); // Check every minute
    
    console.log(' Busyness inactivity checker started (30-minute per-location)');
}

// Check if any specific location has been inactive for 30 minutes
function checkBusynessInactivityPerLocation() {
    // Only check during operational hours (4am - 10pm)
    const now = new Date();
    const currentHour = now.getHours();
    const currentMinutes = now.getMinutes();
    
    if (currentHour < BUSYNESS_OPERATIONAL_START || currentHour >= BUSYNESS_OPERATIONAL_END) {
        return; // Outside operational hours, don't remind
    }
    
    // Check each location individually
    BUSYNESS_LOCATIONS.forEach(location => {
        // SPECIAL HANDLING FOR ZONE E - closes at 12pm
        if (location === 'Zone E' && currentHour >= ZONE_E_CLOSE_HOUR) {
            return; // Zone E is closed, no reminders needed
        }
        
        const locKey = location.replace(/\s+/g, '_');
        const cooldown = busynessCooldowns[locKey];
        
        // Check last activity time for this location
        let lastActivityTime = 0;
        if (cooldown && cooldown.timestamp) {
            lastActivityTime = cooldown.timestamp;
        }
        
        const timeSinceActivity = Date.now() - lastActivityTime;
        
        // Check if this location needs a reminder (30 min = 1800000ms)
        // Also check if we recently dismissed a reminder for this location (give 5 min grace period)
        const lastDismiss = lastReminderDismissTime[locKey] || 0;
        const timeSinceDismiss = Date.now() - lastDismiss;
        
        if ((lastActivityTime === 0 || timeSinceActivity >= BUSYNESS_INACTIVITY_REMINDER_MS) && timeSinceDismiss >= 5 * 60 * 1000) {
            showBusynessLocationReminder(location);
        }
    });
}

// Show blocking reminder for a specific location - MUST UPDATE TO CONTINUE
function showBusynessLocationReminder(location) {
    // Don't show if there's already a reminder blocking overlay showing
    if (document.getElementById('busyness-blocking-reminder')) return;
    
    const locKey = location.replace(/\s+/g, '_');
    const cooldown = busynessCooldowns[locKey];
    
    // Get last logged info if available
    let lastInfo = '';
    if (cooldown && cooldown.timestamp) {
        const lastTime = new Date(cooldown.timestamp);
        const timeStr = lastTime.toLocaleTimeString('en-AU', { hour: '2-digit', minute: '2-digit', hour12: false });
        const levelInfo = BUSYNESS_LEVELS.find(l => l.id === cooldown.level);
        lastInfo = `<div class="reminder-last-info">Last update: ${timeStr} - ${levelInfo?.icon || ''} ${levelInfo?.label || cooldown.level} by ${cooldown.loggedBy || 'Unknown'}</div>`;
    } else {
        lastInfo = `<div class="reminder-last-info">No data logged yet today for this location</div>`;
    }
    
    const overlay = document.createElement('div');
    overlay.id = 'busyness-blocking-reminder';
    overlay.className = 'busyness-blocking-reminder-overlay';
    overlay.setAttribute('data-location', location); // Store which location triggered this
    overlay.innerHTML = `
        <div class="busyness-blocking-reminder-modal">
            <div class="reminder-header">
                <span class="reminder-icon"></span>
                <span class="reminder-title">Busyness Update Required</span>
            </div>
            <div class="reminder-body">
                <div class="reminder-location-badge">${location}</div>
                <div class="reminder-message">
                    This location hasn't been updated in the last 30 minutes.
                    <br><br>
                    <strong>Please update the busyness level to continue viewing flights.</strong>
                </div>
                ${lastInfo}
                <button class="reminder-update-now-btn" onclick="openBusynessPanelForLocation('${location}')">
                     Update Now
                </button>
            </div>
        </div>
    `;
    
    document.body.appendChild(overlay);
    console.log(` Blocking busyness reminder shown for: ${location}`);
}

// Open busyness panel focused on a specific location
function openBusynessPanelForLocation(targetLocation) {
    // Close the reminder modal but keep tracking that we need an update
    const reminderOverlay = document.getElementById('busyness-blocking-reminder');
    const pendingLocation = reminderOverlay?.getAttribute('data-location');
    
    if (reminderOverlay) {
        reminderOverlay.remove();
    }
    
    // Create the busyness panel with a blocking overlay behind it
    const blockingOverlay = document.createElement('div');
    blockingOverlay.id = 'busyness-update-required-overlay';
    blockingOverlay.className = 'busyness-update-required-overlay';
    blockingOverlay.setAttribute('data-pending-location', targetLocation);
    document.body.appendChild(blockingOverlay);
    
    // Now open the busyness panel
    const panelOverlay = document.createElement('div');
    panelOverlay.className = 'busyness-panel-overlay';
    panelOverlay.id = 'busyness-panel-overlay';
    // Don't allow closing by clicking outside when update is required
    panelOverlay.onclick = (e) => { 
        if (e.target === panelOverlay) {
            showCannotCloseMessage(targetLocation);
        }
    };
    
    const panel = document.createElement('div');
    panel.className = 'busyness-panel';
    
    panel.innerHTML = `
        <div class="busyness-panel-header" style="background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);">
            <div class="busyness-panel-title"> Update Required: ${targetLocation}</div>
            <div class="busyness-header-actions">
                <button class="busyness-close-btn" onclick="showCannotCloseMessage('${targetLocation}')" title="Update required before closing"> </button>
            </div>
        </div>
        <div class="busyness-panel-content">
            <div class="update-required-banner">
                <span></span> Please select a busyness level for <strong>${targetLocation}</strong> below to continue
            </div>
            ${renderBusynessLocationsWithHighlight(targetLocation)}
            ${renderBusynessSnapshot()}
        </div>
    `;
    
    panelOverlay.appendChild(panel);
    document.body.appendChild(panelOverlay);
    
    // Start cooldown timer updates
    startCooldownTimerUpdates();
    
    // Scroll to the target location
    setTimeout(() => {
        const targetEl = document.querySelector(`.busyness-location[data-location="${targetLocation}"]`);
        if (targetEl) {
            targetEl.scrollIntoView({ behavior: 'smooth', block: 'center' });
            targetEl.classList.add('highlight-pulse');
        }
    }, 100);
}

// Render locations with one highlighted
function renderBusynessLocationsWithHighlight(highlightLocation) {
    let html = '';
    const now = new Date();
    const currentHour = now.getHours();
    
    BUSYNESS_LOCATIONS.forEach(location => {
        const isHighlighted = location === highlightLocation;
        const onCooldown = isLocationOnCooldown(location);
        const cooldown = busynessCooldowns[location.replace(/\s+/g, '_')];
        
        // SPECIAL HANDLING: Zone E closes at 12pm
        const isZoneEClosed = location === 'Zone E' && currentHour >= ZONE_E_CLOSE_HOUR;
        
        let statusText = 'No data yet';
        if (cooldown && cooldown.level) {
            const level = BUSYNESS_LEVELS.find(l => l.id === cooldown.level);
            const timeAgo = Math.floor((Date.now() - cooldown.timestamp) / 60000);
            statusText = `${level?.icon || ''} ${level?.label || cooldown.level} (${timeAgo}m ago by ${cooldown.loggedBy || 'Unknown'})`;
        }
        
        if (isZoneEClosed) {
            html += `
                <div class="busyness-location zone-e-closed ${isHighlighted ? 'highlighted-location' : ''}" data-location="${location}">
                    <div class="busyness-location-header">
                        <div class="busyness-location-name">${location}</div>
                        <div class="busyness-location-status">${statusText}</div>
                    </div>
                    <div class="zone-e-closed-banner">
                        <div class="zone-e-closed-icon"></div>
                        <div class="zone-e-closed-text">
                            <strong>Zone E is closed for today</strong>
                            <div class="zone-e-closed-subtext">Operations end at 12:00 PM daily</div>
                        </div>
                    </div>
                </div>
            `;
        } else {
            html += `
                <div class="busyness-location ${isHighlighted ? 'highlighted-location' : ''}" data-location="${location}">
                    <div class="busyness-location-header">
                        <div class="busyness-location-name">${isHighlighted ? ' ' : ''}${location}${isHighlighted ? ' ' : ''}</div>
                        <div class="busyness-location-status">${statusText}</div>
                    </div>
                    <div class="busyness-btn-group">
                        ${BUSYNESS_LEVELS.map(level => `
                            <button class="busyness-btn ${level.id} ${cooldown?.level === level.id ? 'selected' : ''}" 
                                    onclick="logBusynessFromReminder('${location}', '${level.id}')"
                                    ${onCooldown && !isHighlighted ? 'disabled' : ''}>
                                <span class="busyness-icon">${level.icon}</span>
                                <span>${level.label}</span>
                            </button>
                        `).join('')}
                    </div>
                    ${onCooldown && !isHighlighted ? `
                        <div class="busyness-cooldown" data-location="${location}">
                             Next update available in <span class="cooldown-timer">${formatCooldownTime(getCooldownRemaining(location))}</span>
                        </div>
                    ` : ''}
                </div>
            `;
        }
    });
    
    return html;
}

// Log busyness from the reminder panel (handles closing the blocking overlay)
function logBusynessFromReminder(location, level) {
    const locKey = location.replace(/\s+/g, '_');
    const blockingOverlay = document.getElementById('busyness-update-required-overlay');
    const pendingLocation = blockingOverlay?.getAttribute('data-pending-location');
    
    // Log the busyness as normal
    logBusyness(location, level);
    
    // If this was the pending location that needed updating, remove the blocking overlay
    if (pendingLocation === location) {
        if (blockingOverlay) {
            blockingOverlay.remove();
        }
        // Record dismiss time so we don't immediately prompt again
        lastReminderDismissTime[locKey] = Date.now();
        
        // Close the busyness panel
        closeBusynessPanel();
        
        console.log(` Required update completed for ${location} - blocking overlay removed`);
    }
}

// Show message that panel can't be closed until update is made
function showCannotCloseMessage(location) {
    // Remove any existing message
    const existing = document.getElementById('cannot-close-message');
    if (existing) existing.remove();
    
    const message = document.createElement('div');
    message.id = 'cannot-close-message';
    message.className = 'cannot-close-message';
    message.innerHTML = `
        <div class="cannot-close-content">
            <span class="cannot-close-icon"></span>
            <span class="cannot-close-text">Please select a busyness level for <strong>${location}</strong> before closing</span>
        </div>
    `;
    
    document.body.appendChild(message);
    
    // Auto-remove after 3 seconds
    setTimeout(() => {
        message.classList.add('fade-out');
        setTimeout(() => message.remove(), 300);
    }, 3000);
}

// Override the normal close function when update is required
function closeBusynessPanel() {
    const blockingOverlay = document.getElementById('busyness-update-required-overlay');
    const pendingLocation = blockingOverlay?.getAttribute('data-pending-location');
    
    // If there's a pending required update, don't allow closing
    if (blockingOverlay && pendingLocation) {
        showCannotCloseMessage(pendingLocation);
        return;
    }
    
    // Check if user came from the busyness prompt and hasn't updated anything yet
    const locationsStillNeeding = window.locationsNeedingUpdate || [];
    const promptWasShown = busynessNotificationShowing;
    
    // If there are still locations needing update and prompt was showing, re-show the prompt
    if (promptWasShown && locationsStillNeeding.length > 0) {
        console.log(' User closed panel without updating - re-showing prompt');
        
        // Close the current panel
        const overlay = document.getElementById('busyness-panel-overlay');
        if (overlay) overlay.remove();
        
        if (cooldownTimerInterval) {
            clearInterval(cooldownTimerInterval);
            cooldownTimerInterval = null;
        }
        
        // Re-show the prompt after a brief delay
        setTimeout(() => {
            showBusynessPrompt(locationsStillNeeding);
        }, 100);
        
        return;
    }
    
    // Normal close
    const overlay = document.getElementById('busyness-panel-overlay');
    if (overlay) overlay.remove();
    
    if (cooldownTimerInterval) {
        clearInterval(cooldownTimerInterval);
        cooldownTimerInterval = null;
    }
}

// Submit busyness from reminder (handles "same status" smart logic) - REMOVED, using logBusynessFromReminder instead
function submitReminderBusyness(location, level) {
    // This function is kept for backwards compatibility but redirects to new flow
    logBusynessFromReminder(location, level);
}

// Close inactivity reminder (no longer used - reminders are blocking)
function closeBusynessInactivityReminder() {
    const popup = document.getElementById('busyness-inactivity-popup');
    if (popup) popup.remove();
}

// Update the always-visible status bar
function updateBusynessStatusBar() {
    const container = document.getElementById('busyness-status-items');
    if (!container) return;
    
    let html = '';
    
    BUSYNESS_LOCATIONS.forEach(location => {
        const locKey = location.replace(/\s+/g, '_');
        const cooldown = busynessCooldowns[locKey];
        
        let levelClass = 'no-data';
        let levelIcon = '';
        let levelText = 'No Data';
        let timeText = '';
        
        if (cooldown && cooldown.level) {
            const levelInfo = BUSYNESS_LEVELS.find(l => l.id === cooldown.level);
            levelClass = cooldown.level;
            levelIcon = levelInfo?.icon || '';
            levelText = levelInfo?.label || cooldown.level;
            
            // Format as "Last: HH:MM"
            const lastTime = new Date(cooldown.timestamp);
            const timeStr = lastTime.toLocaleTimeString('en-AU', { 
                hour: '2-digit', 
                minute: '2-digit', 
                hour12: false 
            });
            timeText = `Last: ${timeStr}`;
        }
        
        // Shorten location names for display
        let shortLocation = location
            .replace('Check-In Area', 'Check-In')
            
            .replace('Service Desk', 'Svc Desk');
        
        html += `
            <div class="busyness-status-item ${levelClass}" onclick="openBusynessPanel()" title="Click to update ${location}">
                <span class="busyness-status-location">${shortLocation}</span>
                <span class="busyness-status-level">${levelIcon}</span>
                <span class="busyness-status-label">${levelText}</span>
                ${timeText ? `<span class="busyness-status-time">${timeText}</span>` : ''}
            </div>
        `;
    });
    
    container.innerHTML = html;
}

// Setup Firebase listener for cooldowns - INSTANT SYNC
function setupBusynessCooldownListener() {
    if (!firebaseInitialized || !flightDate) return;
    
    const dateKey = getFlightDateKey();
    const cooldownRef = firebase.database().ref(`busyness_cooldowns_${dateKey}`);
    
    trackFirebaseRead(); // Track the listener setup as a read
    
    cooldownRef.on('value', (snapshot) => {
        const previousCooldowns = { ...busynessCooldowns };
        busynessCooldowns = snapshot.val() || {};
        console.log(' Busyness cooldowns synced from Firebase - INSTANT UPDATE');
        
        // INSTANT UI UPDATE: Update the status bar whenever cooldowns change
        updateBusynessStatusBar();
        
        // INSTANT UI UPDATE: Refresh any open busyness panel
        refreshBusynessPanelContent();
        
        // CHECK: If there's a blocking overlay waiting for a location update, 
        // and that location was just updated by another device, dismiss it
        const blockingOverlay = document.getElementById('busyness-update-required-overlay');
        if (blockingOverlay) {
            const pendingLocation = blockingOverlay.getAttribute('data-pending-location');
            if (pendingLocation) {
                const locKey = pendingLocation.replace(/\s+/g, '_');
                const previousTimestamp = previousCooldowns[locKey]?.timestamp || 0;
                const newTimestamp = busynessCooldowns[locKey]?.timestamp || 0;
                
                // If the timestamp changed, someone updated it
                if (newTimestamp > previousTimestamp) {
                    console.log(` ${pendingLocation} was updated by another device - dismissing blocking overlay`);
                    blockingOverlay.remove();
                    closeBusynessPanel();
                    lastReminderDismissTime[locKey] = Date.now();
                    
                    // Show a nice notification that someone else updated it
                    showOtherDeviceUpdatedNotification(pendingLocation, busynessCooldowns[locKey]);
                }
            }
        }
        
        // Also check if there's a reminder waiting and the location was updated
        const reminderOverlay = document.getElementById('busyness-blocking-reminder');
        if (reminderOverlay) {
            const pendingLocation = reminderOverlay.getAttribute('data-location');
            if (pendingLocation) {
                const locKey = pendingLocation.replace(/\s+/g, '_');
                const previousTimestamp = previousCooldowns[locKey]?.timestamp || 0;
                const newTimestamp = busynessCooldowns[locKey]?.timestamp || 0;
                
                if (newTimestamp > previousTimestamp) {
                    console.log(` ${pendingLocation} was updated by another device - dismissing reminder`);
                    reminderOverlay.remove();
                    lastReminderDismissTime[locKey] = Date.now();
                    showOtherDeviceUpdatedNotification(pendingLocation, busynessCooldowns[locKey]);
                }
            }
        }
        
        trackFirebaseRead(); // Track each update received
    });
}

// Show notification that another device updated the location
function showOtherDeviceUpdatedNotification(location, cooldownData) {
    const levelInfo = BUSYNESS_LEVELS.find(l => l.id === cooldownData.level);
    
    const notification = document.createElement('div');
    notification.className = 'other-device-updated-notification';
    notification.innerHTML = `
        <div class="other-device-notification-content">
            <span class="other-device-notification-icon"></span>
            <div class="other-device-notification-text">
                <strong>${location}</strong> was updated to <strong>${levelInfo?.label || cooldownData.level}</strong>
                <div class="other-device-notification-by">by ${cooldownData.loggedBy || 'another user'}</div>
            </div>
        </div>
    `;
    
    document.body.appendChild(notification);
    
    // Auto-remove after 3 seconds
    setTimeout(() => {
        notification.classList.add('fade-out');
        setTimeout(() => notification.remove(), 300);
    }, 3000);
}

// Check if location is on cooldown
function isLocationOnCooldown(location) {
    const cooldown = busynessCooldowns[location.replace(/\s+/g, '_')];
    if (!cooldown) return false;
    
    const elapsed = Date.now() - cooldown.timestamp;
    return elapsed < BUSYNESS_COOLDOWN_MS;
}

// Get cooldown remaining time
function getCooldownRemaining(location) {
    const cooldown = busynessCooldowns[location.replace(/\s+/g, '_')];
    if (!cooldown) return 0;
    
    const elapsed = Date.now() - cooldown.timestamp;
    const remaining = BUSYNESS_COOLDOWN_MS - elapsed;
    return Math.max(0, remaining);
}

// Format cooldown time
function formatCooldownTime(ms) {
    const minutes = Math.floor(ms / 60000);
    const seconds = Math.floor((ms % 60000) / 1000);
    return `${minutes}m ${seconds}s`;
}

// Open busyness panel
function openBusynessPanel() {
    console.log(' openBusynessPanel() called');
    
    try {
        // Check if panel already exists - remove it first to avoid duplicates
        const existingOverlay = document.getElementById('busyness-panel-overlay');
        if (existingOverlay) {
            console.log(' Removing existing panel overlay');
            existingOverlay.remove();
        }
        
        const overlay = document.createElement('div');
    overlay.className = 'busyness-panel-overlay';
    overlay.id = 'busyness-panel-overlay';
    overlay.onclick = (e) => { if (e.target === overlay) closeBusynessPanel(); };
    
    const panel = document.createElement('div');
    panel.className = 'busyness-panel';
    
    panel.innerHTML = `
        <div class="busyness-panel-header">
            <div class="busyness-panel-title"> Busyness Tracker</div>
            <div class="busyness-header-actions">
                <button class="busyness-clear-firebase-btn" onclick="clearTodayFirebaseBusynessData()" title="Clear Firebase busyness data for today (testing)"> Clear Firebase</button>
                <button class="busyness-clear-btn" onclick="clearAllBusynessData()" title="Clear all busyness data for today"> Clear All</button>
                <button class="busyness-clear-btn" onclick="showFirebaseCleanupModal()" title="Clean up old Firebase data" style="background:#dc2626;"> Cleanup Old</button>
                <button class="busyness-close-btn" onclick="closeBusynessPanel()"> </button>
            </div>
        </div>
        <div class="busyness-panel-content">
            ${renderBusynessLocations()}
            ${renderBusynessSnapshot()}
        </div>
    `;
    
    overlay.appendChild(panel);
    document.body.appendChild(overlay);
    
    console.log(' Busyness panel created and appended to body');
    
    // Start cooldown timer updates
    startCooldownTimerUpdates();
    
    // Initialize graph scrolling to center on current time
    initBusynessGraphScrolling();
    
    } catch (err) {
        console.error(' Error in openBusynessPanel:', err);
        alert('Error opening busyness panel: ' + err.message);
    }
}

// Render location buttons
function renderBusynessLocations() {
    let html = '';
    const now = new Date();
    const currentHour = now.getHours();
    
    BUSYNESS_LOCATIONS.forEach(location => {
        const onCooldown = isLocationOnCooldown(location);
        const cooldown = busynessCooldowns[location.replace(/\s+/g, '_')];
        const lastEntry = getLastEntryForLocation(location);
        
        // SPECIAL HANDLING: Zone E closes at 12pm
        const isZoneEClosed = location === 'Zone E' && currentHour >= ZONE_E_CLOSE_HOUR;
        
        let statusText = 'No data yet';
        if (cooldown && cooldown.level) {
            const level = BUSYNESS_LEVELS.find(l => l.id === cooldown.level);
            const timeAgo = Math.floor((Date.now() - cooldown.timestamp) / 60000);
            statusText = `${level?.icon || ''} ${level?.label || cooldown.level} (${timeAgo}m ago by ${cooldown.loggedBy || 'Unknown'})`;
        }
        
        if (isZoneEClosed) {
            // Show Zone E closed message
            html += `
                <div class="busyness-location zone-e-closed" data-location="${location}">
                    <div class="busyness-location-header">
                        <div class="busyness-location-name">${location}</div>
                        <div class="busyness-location-status">${statusText}</div>
                    </div>
                    <div class="zone-e-closed-banner">
                        <div class="zone-e-closed-icon"></div>
                        <div class="zone-e-closed-text">
                            <strong>Zone E is closed for today</strong>
                            <div class="zone-e-closed-subtext">Operations end at 12:00 PM daily</div>
                        </div>
                    </div>
                </div>
            `;
        } else {
            html += `
                <div class="busyness-location" data-location="${location}">
                    <div class="busyness-location-header">
                        <div class="busyness-location-name">${location}</div>
                        <div class="busyness-location-status">${statusText}</div>
                    </div>
                    <div class="busyness-btn-group">
                        ${BUSYNESS_LEVELS.map(level => `
                            <button class="busyness-btn ${level.id} ${cooldown?.level === level.id ? 'selected' : ''}" 
                                    onclick="logBusyness('${location}', '${level.id}')"
                                    ${onCooldown ? 'disabled' : ''}>
                                <span class="busyness-icon">${level.icon}</span>
                                <span>${level.label}</span>
                            </button>
                        `).join('')}
                    </div>
                    ${onCooldown ? `
                        <div class="busyness-cooldown" data-location="${location}">
                             Next update available in <span class="cooldown-timer">${formatCooldownTime(getCooldownRemaining(location))}</span>
                        </div>
                    ` : ''}
                </div>
            `;
        }
    });
    
    return html;
}

// Render quick snapshot - PER LOCATION with stepped timeline graphs
function renderBusynessSnapshot() {
    // Get current flight pressure
    const flightPressure = calculateFlightPressure();
    const now = new Date();
    const currentHour = now.getHours();
    
    // Location icons
    const locationIcons = {
        'Check-In Area': '',
        'Zone E': '',
        'ABDs': '',
        
        'Service Desk': ''
    };
    
    // Generate per-location snapshots with stepped timeline graphs
    let locationSnapshotsHtml = '';
    
    BUSYNESS_LOCATIONS.forEach(location => {
        const locKey = location.replace(/\s+/g, '_');
        const cooldown = busynessCooldowns[locKey];
        const timelineData = busynessTimelineData[locKey] || {};
        
        // Check if Zone E is closed
        const isZoneEClosed = location === 'Zone E' && currentHour >= ZONE_E_CLOSE_HOUR;
        
        // Get current status from cooldown (last logged)
        let currentLevel = 'no-data';
        let currentLevelLabel = 'No Data';
        let currentIcon = '';
        let lastTimeStr = '';
        
        if (cooldown && cooldown.level) {
            currentLevel = cooldown.level;
            const levelInfo = BUSYNESS_LEVELS.find(l => l.id === cooldown.level);
            currentLevelLabel = levelInfo?.label || cooldown.level;
            currentIcon = levelInfo?.icon || '';
            
            const lastTime = new Date(cooldown.timestamp);
            lastTimeStr = lastTime.toLocaleTimeString('en-AU', { hour: '2-digit', minute: '2-digit', hour12: false });
        }
        
        // Generate stepped timeline chart from Firebase data
        let chartHtml = '';
        const entries = Object.values(timelineData).sort((a, b) => a.timestamp - b.timestamp);
        
        if (entries.length > 0) {
            chartHtml = renderSteppedTimelineChart(entries, location);
        } else {
            chartHtml = '<div class="busyness-start-tracking">Start tracking by selecting a level above</div>';
        }
        
        // Add Zone E closed indicator if applicable
        let zoneClosedIndicator = '';
        if (isZoneEClosed) {
            zoneClosedIndicator = '<div class="zone-e-snapshot-closed"> Closed at 12:00 PM</div>';
        }
        
        locationSnapshotsHtml += `
            <div class="location-snapshot ${isZoneEClosed ? 'zone-e-closed-snapshot' : ''}">
                <div class="location-snapshot-header">
                    <div class="location-snapshot-title">
                        <span>${locationIcons[location] || ''}</span>
                        ${location}
                        ${zoneClosedIndicator}
                    </div>
                    <div class="location-snapshot-status-container">
                        <span class="location-snapshot-current ${currentLevel}">${currentIcon} ${currentLevelLabel}</span>
                        ${lastTimeStr ? `<span class="location-snapshot-time">Last: ${lastTimeStr}</span>` : ''}
                    </div>
                </div>
                ${chartHtml}
            </div>
        `;
    });
    
    return `
        <div class="busyness-snapshot-section">
            <div class="busyness-snapshot-title"> Today's Busyness Timeline</div>
            
            <div class="flight-pressure-stats">
                <div class="pressure-stat">
                    <div class="pressure-stat-number open">${flightPressure.open}</div>
                    <div class="pressure-stat-label">Open</div>
                </div>
                <div class="pressure-stat">
                    <div class="pressure-stat-number closing">${flightPressure.closing}</div>
                    <div class="pressure-stat-label">Closing</div>
                </div>
                <div class="pressure-stat">
                    <div class="pressure-stat-number closed">${flightPressure.closed}</div>
                    <div class="pressure-stat-label">Closed</div>
                </div>
            </div>
            
            ${locationSnapshotsHtml}
            
            <div class="busyness-legend-bar">
                <span class="legend-label">Legend:</span>
                <span class="legend-item"><span class="legend-color quiet"></span>Quiet</span>
                <span class="legend-item"><span class="legend-color moderate"></span>Moderate</span>
                <span class="legend-item"><span class="legend-color busy"></span>Busy</span>
                <span class="legend-item"><span class="legend-color very-busy"></span>V.Busy</span>
                <span class="legend-item"><span class="legend-color chaos"></span>Chaos</span>
            </div>
        </div>
    `;
}

// Render stepped timeline chart - shows colored segments over time
// Render vertical log list - shows each entry with exact timestamp
function renderSteppedTimelineChart(entries, location) {
    if (!entries || entries.length === 0) {
        return '<div class="busyness-start-tracking">No data yet - select a level above to start tracking</div>';
    }
    
    // Sort entries by timestamp (oldest first for the graph)
    const sortedEntries = [...entries].sort((a, b) => a.timestamp - b.timestamp);
    
    // Generate the bar graph (no log list needed)
    return renderBusynessBarGraph(sortedEntries, location);
}

// Render bar graph for busyness data with visible X-axis
// Optimized for 8-inch iPad Mini with horizontal scrolling
function renderBusynessBarGraph(entries, location, options = {}) {
    const {
        width = 1200,         // Wide enough to require scrolling (18.5 hours = ~65px per hour)
        height = 110,         // Optimized height for iPad Mini (not too tall, clear visibility)
        showInPdf = false     // Whether this is for PDF
    } = options;
    
    // Color and magnitude mapping
    const levelMagnitude = {
        'quiet': 2,
        'moderate': 4,
        'busy': 6,
        'very-busy': 8,
        'chaos': 10
    };
    
    const levelColors = {
        'quiet': '#22c55e',
        'moderate': '#eab308',
        'busy': '#f97316',
        'very-busy': '#ef4444',
        'chaos': '#1f2937'
    };
    
    // Fixed time range: 04:00 to 22:30
    const today = new Date();
    const startTime = new Date(today);
    startTime.setHours(4, 0, 0, 0);
    const endTime = new Date(today);
    endTime.setHours(22, 30, 0, 0);
    
    const totalDuration = endTime.getTime() - startTime.getTime(); // 18.5 hours in ms
    const padding = { top: 15, bottom: 28, left: 15, right: 15 };
    const graphHeight = height - padding.top - padding.bottom;
    const graphWidth = width - padding.left - padding.right;
    
    const sortedEntries = [...entries].sort((a, b) => a.timestamp - b.timestamp);
    
    if (sortedEntries.length === 0) {
        return '<div class="busyness-graph-no-data">No data available</div>';
    }
    
    // Calculate bar width - wider bars for better visibility on iPad
    const barWidth = Math.max(12, Math.min(25, graphWidth / (sortedEntries.length * 1.5)));
    
    // Build bars
    let barsHtml = '';
    sortedEntries.forEach((entry, index) => {
        const x = padding.left + ((entry.timestamp - startTime.getTime()) / totalDuration) * graphWidth;
        const magnitude = levelMagnitude[entry.level] || 2;
        const barHeight = (magnitude / 10) * graphHeight;
        const y = padding.top + graphHeight - barHeight;
        const color = levelColors[entry.level] || '#9ca3af';
        const time = new Date(entry.timestamp).toLocaleTimeString('en-AU', { hour: '2-digit', minute: '2-digit', hour12: false });
        
        barsHtml += `
            <rect 
                x="${x - barWidth/2}" 
                y="${y}" 
                width="${barWidth}" 
                height="${barHeight}" 
                fill="${color}"
                rx="3"
                class="busyness-bar"
            >
                <title>${time} - ${entry.level} (by ${entry.loggedBy || 'Unknown'})</title>
            </rect>
        `;
    });
    
    // Build smooth line connecting the bars (optional overlay)
    let linePath = '';
    if (sortedEntries.length > 1) {
        const linePoints = [];
        sortedEntries.forEach((entry, index) => {
            const x = padding.left + ((entry.timestamp - startTime.getTime()) / totalDuration) * graphWidth;
            const magnitude = levelMagnitude[entry.level] || 2;
            const y = padding.top + graphHeight - (magnitude / 10) * graphHeight;
            linePoints.push({ x, y, level: entry.level });
        });
        
        // Add interpolation points for smooth transitions
        const smoothPoints = [];
        for (let i = 0; i < linePoints.length; i++) {
            smoothPoints.push(linePoints[i]);
            if (i < linePoints.length - 1 && linePoints[i].level !== linePoints[i + 1].level) {
                // Add midpoint for smooth transition
                const midX = (linePoints[i].x + linePoints[i + 1].x) / 2;
                const midY = (linePoints[i].y + linePoints[i + 1].y) / 2;
                smoothPoints.push({ x: midX, y: midY });
            }
        }
        
        // Build smooth curve path
        linePath = `M ${smoothPoints[0].x} ${smoothPoints[0].y}`;
        for (let i = 0; i < smoothPoints.length - 1; i++) {
            const p0 = smoothPoints[Math.max(0, i - 1)];
            const p1 = smoothPoints[i];
            const p2 = smoothPoints[i + 1];
            const p3 = smoothPoints[Math.min(smoothPoints.length - 1, i + 2)];
            
            const cp1x = p1.x + (p2.x - p0.x) / 6;
            const cp1y = p1.y + (p2.y - p0.y) / 6;
            const cp2x = p2.x - (p3.x - p1.x) / 6;
            const cp2y = p2.y - (p3.y - p1.y) / 6;
            
            linePath += ` C ${cp1x} ${cp1y}, ${cp2x} ${cp2y}, ${p2.x} ${p2.y}`;
        }
    }
    
    // Calculate current time position for the "now" marker
    const now = Date.now();
    const nowX = padding.left + ((now - startTime.getTime()) / totalDuration) * graphWidth;
    const showNowLine = now >= startTime.getTime() && now <= endTime.getTime();
    
    // Build X-axis time labels (every hour for better clarity when scrolling)
    let timeLabels = '';
    let tickMarks = '';
    let gridLines = '';
    for (let hour = 4; hour <= 22; hour += 1) {
        const labelTime = new Date(today);
        labelTime.setHours(hour, 0, 0, 0);
        const labelX = padding.left + ((labelTime.getTime() - startTime.getTime()) / totalDuration) * graphWidth;
        const labelText = `${hour.toString().padStart(2, '0')}:00`;
        
        // Show label every 2 hours, but tick every hour
        if (hour % 2 === 0) {
            timeLabels += `<text x="${labelX}" y="${height - 6}" class="busyness-graph-x-label">${labelText}</text>`;
        }
        tickMarks += `<line x1="${labelX}" y1="${padding.top + graphHeight}" x2="${labelX}" y2="${padding.top + graphHeight + 5}" stroke="#9ca3af" stroke-width="1"/>`;
        gridLines += `<line x1="${labelX}" y1="${padding.top}" x2="${labelX}" y2="${padding.top + graphHeight}" stroke="#f3f4f6" stroke-width="1"/>`;
    }
    
    // Generate unique ID for this graph
    const graphId = `busyness-bar-graph-${location.replace(/\s+/g, '-')}-${Date.now()}`;
    const wrapperId = `graph-wrapper-${location.replace(/\s+/g, '-')}`;
    
    const svgContent = `
        <svg 
            id="${graphId}"
            class="busyness-bar-graph-svg" 
            width="${width}" 
            height="${height}" 
            viewBox="0 0 ${width} ${height}"
            style="min-width: ${width}px;"
        >
            <!-- Background grid lines (light, every hour) -->
            ${gridLines}
            
            <!-- X-axis line -->
            <line 
                x1="${padding.left}" 
                y1="${padding.top + graphHeight}" 
                x2="${width - padding.right}" 
                y2="${padding.top + graphHeight}" 
                stroke="#d1d5db"
                stroke-width="1.5"
            />
            
            <!-- Tick marks -->
            ${tickMarks}
            
            <!-- Bars -->
            ${barsHtml}
            
            <!-- Smooth line overlay -->
            ${linePath ? `
                <path 
                    d="${linePath}" 
                    fill="none"
                    stroke="rgba(0, 3, 69, 0.5)"
                    stroke-width="2.5"
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-dasharray="6 3"
                />
            ` : ''}
            
            <!-- Current time marker -->
            ${showNowLine ? `
                <line 
                    x1="${nowX}" 
                    y1="${padding.top}" 
                    x2="${nowX}" 
                    y2="${padding.top + graphHeight}" 
                    stroke="#dc2626"
                    stroke-width="2.5"
                />
                <circle cx="${nowX}" cy="${padding.top}" r="5" fill="#dc2626"/>
                <text x="${nowX}" y="${padding.top - 5}" fill="#dc2626" font-size="10" font-weight="bold" text-anchor="middle">NOW</text>
            ` : ''}
            
            <!-- Time labels -->
            ${timeLabels}
        </svg>
    `;
    
    // Calculate scroll position to center on current time
    // Assuming viewport is about 350px on iPad Mini
    const viewportWidth = 350;
    const scrollToX = Math.max(0, nowX - viewportWidth / 2);
    
    // Wrap in scrollable container for interactive view
    return `
        <div class="busyness-bar-graph-container">
            <div class="busyness-bar-graph-wrapper" id="${wrapperId}" data-scroll-to="${scrollToX}" data-now-x="${nowX}">
                ${svgContent}
            </div>
            <div class="busyness-graph-scroll-hint">
                <span> Swipe left/right to see full timeline (04:00 - 22:30)</span>
            </div>
            <div class="busyness-graph-info">
                <span class="busyness-graph-entry-count"> ${entries.length} entries</span>
            </div>
        </div>
    `;
}

// Initialize graph scrolling after panel opens - centers on current time
function initBusynessGraphScrolling() {
    setTimeout(() => {
        BUSYNESS_LOCATIONS.forEach(location => {
            const wrapperId = `graph-wrapper-${location.replace(/\s+/g, '-')}`;
            const wrapper = document.getElementById(wrapperId);
            if (wrapper) {
                const scrollTo = parseFloat(wrapper.dataset.scrollTo) || 0;
                wrapper.scrollLeft = scrollTo;
                console.log(` Graph "${location}" scrolled to position ${scrollTo}px (centering on NOW)`);
            }
        });
    }, 150);
}

// ============================================
// EXPANDED GRAPH VIEW (MAGNIFYING GLASS)
// ============================================

let expandedGraphZoom = 1;
let expandedGraphTouchStartDistance = 0;

function openExpandedGraphView(location) {
    const locKey = location.replace(/\s+/g, '_');
    const timelineData = busynessTimelineData[locKey] || {};
    const entries = Object.values(timelineData).sort((a, b) => a.timestamp - b.timestamp);
    
    const isZoneE = location === 'Zone E';
    const icons = {'Check-In Area':'','Zone E':'','ABDs':'','Service Desk':''};
    
    expandedGraphZoom = 1;
    
    const overlay = document.createElement('div');
    overlay.className = 'expanded-graph-overlay';
    overlay.id = 'expanded-graph-overlay';
    
    const graphSVG = entries.length > 0 ? renderExpandedGraphSVG(entries, location, isZoneE) : '<div style="text-align:center;color:#9ca3af;padding:40px;">No data logged for this location</div>';
    
    overlay.innerHTML = `
        <div class="expanded-graph-header">
            <div class="expanded-graph-title">${icons[location]||''} ${location} - Busyness Timeline</div>
            <button class="expanded-graph-close-btn" onclick="closeExpandedGraphView()">Close</button>
        </div>
        <div class="expanded-graph-container">
            <div class="expanded-graph-wrapper" id="expanded-graph-wrapper">
                ${graphSVG}
            </div>
            <div class="expanded-graph-controls">
                <button class="zoom-btn" onclick="zoomExpandedGraph(-0.25)"> Zoom Out</button>
                <button class="zoom-btn reset" onclick="zoomExpandedGraph(0)"> Reset</button>
                <button class="zoom-btn" onclick="zoomExpandedGraph(0.25)"> Zoom In</button>
            </div>
            <div class="expanded-graph-hint">Pinch to zoom on iPad/tablet  Tap any bar to see details</div>
        </div>
    `;
    
    document.body.appendChild(overlay);
    
    // Setup touch handlers for pinch zoom
    setTimeout(() => setupExpandedGraphTouchHandlers(), 100);
}

function closeExpandedGraphView() {
    const overlay = document.getElementById('expanded-graph-overlay');
    if (overlay) overlay.remove();
    closeBarInfoPopup();
}

function renderExpandedGraphSVG(entries, location, isZoneE) {
    const levelColors = {'quiet':'#22c55e','moderate':'#eab308','busy':'#f97316','very-busy':'#ef4444','chaos':'#1f2937'};
    const levelMag = {'quiet':2,'moderate':4,'busy':6,'very-busy':8,'chaos':10};
    
    const width = 1600;
    const height = 300;
    const padding = {top:30,bottom:40,left:50,right:30};
    const graphHeight = height - padding.top - padding.bottom;
    const graphWidth = width - padding.left - padding.right;
    
    const today = entries[0] ? new Date(entries[0].timestamp) : new Date();
    const startTime = new Date(today);
    startTime.setHours(4,0,0,0);
    const endTime = new Date(today);
    endTime.setHours(isZoneE ? 13 : 22, isZoneE ? 0 : 30, 0, 0);
    const totalDur = endTime.getTime() - startTime.getTime();
    
    const barWidth = Math.max(15, Math.min(35, graphWidth / (entries.length * 2)));
    
    let bars = '';
    entries.forEach((entry, idx) => {
        const x = padding.left + ((entry.timestamp - startTime.getTime()) / totalDur) * graphWidth;
        const mag = levelMag[entry.level] || 2;
        const bH = (mag / 10) * graphHeight;
        const y = padding.top + graphHeight - bH;
        const time = new Date(entry.timestamp).toLocaleTimeString('en-AU',{hour:'2-digit',minute:'2-digit',hour12:false});
        
        bars += `<rect x="${x-barWidth/2}" y="${y}" width="${barWidth}" height="${bH}" fill="${levelColors[entry.level]||'#9ca3af'}" rx="4" 
            style="cursor:pointer;" onclick="showBarInfoPopup(event,'${entry.loggedBy||'Unknown'}','${entry.level}','${time}')"/>`;
    });
    
    // Time labels and grid
    let labels = '', grid = '', ticks = '';
    const endHour = isZoneE ? 13 : 22;
    for (let h = 4; h <= endHour; h++) {
        const lt = new Date(today);
        lt.setHours(h,0,0,0);
        const lx = padding.left + ((lt.getTime() - startTime.getTime()) / totalDur) * graphWidth;
        if (h % 2 === 0) {
            labels += `<text x="${lx}" y="${height-10}" style="font-size:12px;fill:#374151;text-anchor:middle;font-weight:500;">${h.toString().padStart(2,'0')}:00</text>`;
        }
        ticks += `<line x1="${lx}" y1="${padding.top+graphHeight}" x2="${lx}" y2="${padding.top+graphHeight+6}" stroke="#6b7280" stroke-width="1"/>`;
        grid += `<line x1="${lx}" y1="${padding.top}" x2="${lx}" y2="${padding.top+graphHeight}" stroke="#e5e7eb" stroke-width="1"/>`;
    }
    
    // NOW line
    const now = Date.now();
    const nowX = padding.left + ((now - startTime.getTime()) / totalDur) * graphWidth;
    const showNow = now >= startTime.getTime() && now <= endTime.getTime();
    const nowLine = showNow ? `
        <line x1="${nowX}" y1="${padding.top}" x2="${nowX}" y2="${padding.top+graphHeight}" stroke="#dc2626" stroke-width="3"/>
        <circle cx="${nowX}" cy="${padding.top}" r="8" fill="#dc2626"/>
        <text x="${nowX}" y="${padding.top-10}" fill="#dc2626" font-size="14" font-weight="bold" text-anchor="middle">NOW</text>
    ` : '';
    
    return `<svg id="expanded-graph-svg" class="expanded-graph-svg" width="${width}" height="${height}" viewBox="0 0 ${width} ${height}" style="display:block;">
        ${grid}
        <line x1="${padding.left}" y1="${padding.top+graphHeight}" x2="${width-padding.right}" y2="${padding.top+graphHeight}" stroke="#374151" stroke-width="2"/>
        ${ticks}
        ${bars}
        ${nowLine}
        ${labels}
    </svg>`;
}

function zoomExpandedGraph(delta) {
    if (delta === 0) {
        expandedGraphZoom = 1;
    } else {
        expandedGraphZoom = Math.max(0.5, Math.min(3, expandedGraphZoom + delta));
    }
    
    const svg = document.getElementById('expanded-graph-svg');
    if (svg) {
        svg.style.transform = `scale(${expandedGraphZoom})`;
        svg.style.transformOrigin = 'center center';
    }
}

function setupExpandedGraphTouchHandlers() {
    const wrapper = document.getElementById('expanded-graph-wrapper');
    if (!wrapper) return;
    
    wrapper.addEventListener('touchstart', (e) => {
        if (e.touches.length === 2) {
            expandedGraphTouchStartDistance = Math.hypot(
                e.touches[0].clientX - e.touches[1].clientX,
                e.touches[0].clientY - e.touches[1].clientY
            );
        }
    }, {passive:true});
    
    wrapper.addEventListener('touchmove', (e) => {
        if (e.touches.length === 2) {
            const dist = Math.hypot(
                e.touches[0].clientX - e.touches[1].clientX,
                e.touches[0].clientY - e.touches[1].clientY
            );
            if (expandedGraphTouchStartDistance > 0) {
                const scale = dist / expandedGraphTouchStartDistance;
                expandedGraphZoom = Math.max(0.5, Math.min(3, expandedGraphZoom * scale));
                const svg = document.getElementById('expanded-graph-svg');
                if (svg) svg.style.transform = `scale(${expandedGraphZoom})`;
                expandedGraphTouchStartDistance = dist;
            }
        }
    }, {passive:true});
}

function showBarInfoPopup(event, loggedBy, level, time) {
    event.stopPropagation();
    closeBarInfoPopup();
    
    const levelLabels = {'quiet':' Quiet','moderate':' Moderate','busy':' Busy','very-busy':' Very Busy','chaos':' Chaos'};
    const levelColors = {'quiet':'#22c55e','moderate':'#eab308','busy':'#f97316','very-busy':'#ef4444','chaos':'#1f2937'};
    
    const popup = document.createElement('div');
    popup.className = 'bar-info-popup';
    popup.id = 'bar-info-popup';
    popup.innerHTML = `
        <div class="bar-info-popup-header">
            <span class="bar-info-popup-title">Entry Details</span>
            <button class="bar-info-popup-close" onclick="closeBarInfoPopup()"> </button>
        </div>
        <div class="bar-info-item"><span class="bar-info-label">Logged by:</span><span class="bar-info-value">${loggedBy}</span></div>
        <div class="bar-info-item"><span class="bar-info-label">Level:</span><span class="bar-info-value" style="color:${levelColors[level]||'#374151'}">${levelLabels[level]||level}</span></div>
        <div class="bar-info-item"><span class="bar-info-label">Time:</span><span class="bar-info-value">${time}</span></div>
    `;
    
    document.body.appendChild(popup);
    
    // Position near click
    const rect = popup.getBoundingClientRect();
    let x = event.clientX - rect.width / 2;
    let y = event.clientY - rect.height - 20;
    
    x = Math.max(10, Math.min(window.innerWidth - rect.width - 10, x));
    y = Math.max(10, y);
    
    popup.style.left = x + 'px';
    popup.style.top = y + 'px';
}

function closeBarInfoPopup() {
    const popup = document.getElementById('bar-info-popup');
    if (popup) popup.remove();
}


// Render mini chart for a specific location - ONLY shows bars where data exists
function renderLocationMiniChart(entries) {
    if (entries.length === 0) {
        return '<div class="busyness-start-tracking">Start tracking by selecting a level below</div>';
    }
    
    // Sort entries by timestamp
    const sortedEntries = [...entries].sort((a, b) => a.timestamp - b.timestamp);
    
    // Get time range from first to last entry
    const firstEntry = sortedEntries[0];
    const lastEntry = sortedEntries[sortedEntries.length - 1];
    
    // Create time-based buckets (group by 30-min intervals for the range we have data)
    const buckets = new Map();
    
    sortedEntries.forEach(entry => {
        // Round to nearest 30 min
        const date = new Date(entry.timestamp);
        const mins = date.getMinutes();
        date.setMinutes(mins < 30 ? 0 : 30, 0, 0);
        const bucketKey = date.getTime();
        
        // Keep highest severity in each bucket
        const existing = buckets.get(bucketKey);
        const severityOrder = ['quiet', 'moderate', 'busy', 'very-busy', 'chaos'];
        if (!existing || severityOrder.indexOf(entry.level) > severityOrder.indexOf(existing.level)) {
            buckets.set(bucketKey, entry);
        }
    });
    
    // Convert to array and sort by time
    const bucketArray = Array.from(buckets.entries()).sort((a, b) => a[0] - b[0]);
    
    // Height mapping
    const heightMap = { 'quiet': 20, 'moderate': 40, 'busy': 60, 'very-busy': 80, 'chaos': 100 };
    
    // Build bars
    const barsHtml = bucketArray.map(([time, entry]) => {
        const height = heightMap[entry.level] || 20;
        const timeStr = new Date(time).toLocaleTimeString('en-AU', { hour: '2-digit', minute: '2-digit', hour12: false });
        return `<div class="location-chart-bar ${entry.level}" style="height: ${height}%;" title="${timeStr}"></div>`;
    }).join('');
    
    const firstTime = new Date(bucketArray[0][0]).toLocaleTimeString('en-AU', { hour: '2-digit', minute: '2-digit', hour12: false });
    const lastTime = new Date(bucketArray[bucketArray.length - 1][0]).toLocaleTimeString('en-AU', { hour: '2-digit', minute: '2-digit', hour12: false });
    
    return `
        <div class="location-mini-chart">
            ${barsHtml}
        </div>
        <div class="location-chart-labels">
            <span>${firstTime}</span>
            <span>${lastTime}</span>
        </div>
    `;
}

// Legacy function kept for compatibility
function renderBusynessChart(entries) {
    return renderLocationMiniChart(entries);
}

// Calculate current flight pressure
function calculateFlightPressure() {
    let open = 0, closing = 0, closed = 0;
    
    flights.forEach(flight => {
        if (flight.manualStatus === 'cancelled') return;
        
        const timeInfo = calculateTimeRemaining(flight);
        const status = flight.manualStatus || timeInfo.status;
        
        if (status === 'open' || status === 'extended') {
            open++;
        } else if (status === 'closing' || status === 'urgent' || status === 'critical') {
            closing++;
        } else if (status === 'closed') {
            closed++;
        }
    });
    
    return { open, closing, closed };
}

// Log busyness entry - PURE FIREBASE (no localStorage)
function logBusyness(location, level) {
    const locKey = location.replace(/\s+/g, '_');
    
    // Check cooldown using local state (includes optimistic updates)
    if (isLocationOnCooldown(location)) {
        const remaining = getCooldownRemaining(location);
        const mins = Math.floor(remaining / 60000);
        const secs = Math.floor((remaining % 60000) / 1000);
        
        // Show styled cooldown notification popup
        showBusynessCooldownNotification(location, mins, secs);
        return;
    }
    
    const timestamp = Date.now();
    const previousLevel = busynessCooldowns[locKey]?.level;
    
    // Check if this is actually a status change
    const isStatusChange = previousLevel !== level;
    
    const entry = {
        location: location,
        level: level,
        timestamp: timestamp,
        loggedBy: currentUser?.name || 'Unknown',
        loggedByLocation: currentUser?.location || 'Unknown',
        isStatusChange: isStatusChange
    };
    
    // Mark this location as updated in the current 20-minute window (for universal notifications)
    markLocationUpdatedInWindow(location);
    
    // OPTIMISTIC UPDATE: Immediately update local cooldowns so UI reflects change
    busynessCooldowns[locKey] = {
        level: level,
        timestamp: timestamp,
        loggedBy: currentUser?.name || 'Unknown'
    };
    
    // OPTIMISTIC UPDATE: Immediately update timeline data for graph
    if (!busynessTimelineData[locKey]) {
        busynessTimelineData[locKey] = {};
    }
    busynessTimelineData[locKey][`entry_${timestamp}`] = {
        level: level,
        timestamp: timestamp,
        loggedBy: currentUser?.name || 'Unknown'
    };
    
    // FIREBASE SYNC - Always write to both cooldowns and timeline
    if (firebaseInitialized && flightDate) {
        const dateKey = getFlightDateKey();
        
        // Set cooldown (for 5-min lockout) - always write to keep devices in sync
        const cooldownRef = firebase.database().ref(`busyness_cooldowns_${dateKey}/${locKey}`);
        cooldownRef.set({
            level: level,
            timestamp: timestamp,
            loggedBy: currentUser?.name || 'Unknown'
        }).catch(err => {
            console.error('Error writing cooldown to Firebase:', err);
        });
        trackFirebaseWrite();
        
        // Add to timeline data (for stepped graph) - always write to record the timestamp
        const timelineRef = firebase.database().ref(`busyness_timeline_${dateKey}/${locKey}`);
        const entryId = `entry_${timestamp}`;
        timelineRef.child(entryId).set({
            level: level,
            timestamp: timestamp,
            loggedBy: currentUser?.name || 'Unknown',
            isStatusChange: isStatusChange
        }).catch(err => {
            console.error('Error writing timeline to Firebase:', err);
        });
        trackFirebaseWrite();
    }
    
    console.log(' Busyness logged:', entry);
    
    // Show success notification with green tick
    showBusynessSuccessNotification(location, level, !isStatusChange);
    
    // Update the status bar immediately
    updateBusynessStatusBar();
    
    // Refresh the panel in place (don't close/reopen to avoid losing state)
    refreshBusynessPanelContent();
}

// Clear today's busyness data from Firebase - for testing purposes
async function clearTodayFirebaseBusynessData() {
    // Password protection - TAM mode bypasses
    if (!isTAMMode && !supervisorAccessUnlocked) {
        const password = prompt(' Enter password to clear Firebase busyness data:');
        if (password !== '1920') {
            alert(' Incorrect password. Access denied.');
            return;
        }
    }
    
    if (!confirm(' TESTING ONLY: This will clear ALL busyness data from Firebase for today.\n\nThis affects ALL devices using this date file.\n\nAre you sure?')) {
        return;
    }
    
    if (!firebaseInitialized || !flightDate) {
        alert('Firebase not initialized or flight date not set.');
        return;
    }
    
    const dateKey = getFlightDateKey();
    
    console.log(' Clearing Firebase busyness data for:', dateKey);
    
    try {
        // Clear cooldowns
        const cooldownRef = firebase.database().ref(`busyness_cooldowns_${dateKey}`);
        await cooldownRef.remove();
        console.log(' Cooldowns cleared');
        
        // Clear timeline data
        const timelineRef = firebase.database().ref(`busyness_timeline_${dateKey}`);
        await timelineRef.remove();
        console.log(' Timeline data cleared');
        
        // Clear local state
        busynessCooldowns = {};
        busynessTimelineData = {};
        
        // Update UI
        updateBusynessStatusBar();
        refreshBusynessPanelContent();
        
        alert(' Firebase busyness data cleared successfully!\n\nAll devices will now see a fresh start for today\'s busyness tracking.');
        
        console.log(' Firebase busyness data cleared for', dateKey);
        
    } catch (error) {
        console.error(' Error clearing Firebase data:', error);
        alert(' Error clearing Firebase data: ' + error.message);
    }
}

// Refresh the busyness panel content without closing it
function refreshBusynessPanelContent() {
    const panel = document.querySelector('.busyness-panel');
    if (!panel) return;
    
    const content = panel.querySelector('.busyness-panel-content');
    if (!content) return;
    
    // Re-render the content
    content.innerHTML = `
        ${renderBusynessLocations()}
        ${renderBusynessSnapshot()}
    `;
    
    // Restart cooldown timer updates
    startCooldownTimerUpdates();
    
    // Reinitialize graph scrolling
    initBusynessGraphScrolling();
}

// Show success notification with green tick (handles confirmation vs status change)
function showBusynessSuccessNotification(location, level, isConfirmation = false) {
    const levelInfo = BUSYNESS_LEVELS.find(l => l.id === level);
    
    // Remove any existing notification
    const existing = document.getElementById('busyness-success-notification');
    if (existing) existing.remove();
    
    const notification = document.createElement('div');
    notification.id = 'busyness-success-notification';
    notification.className = 'busyness-success-notification';
    
    const message = isConfirmation 
        ? `<strong>${location}</strong> confirmed as <strong>${levelInfo?.label || level}</strong>`
        : `<strong>${location}</strong> set to <strong>${levelInfo?.label || level}</strong>`;
    
    notification.innerHTML = `
        <div class="busyness-success-icon"></div>
        <div class="busyness-success-text">
            ${message}
            ${isConfirmation ? '<div class="busyness-success-subtext">Status unchanged - recorded for tracking</div>' : ''}
        </div>
    `;
    
    document.body.appendChild(notification);
    
    // Trigger animation
    setTimeout(() => notification.classList.add('show'), 10);
    
    // Remove after 2 seconds
    setTimeout(() => {
        notification.classList.remove('show');
        setTimeout(() => notification.remove(), 300);
    }, 2000);
}

// Show cooldown notification popup
function showBusynessCooldownNotification(location, mins, secs) {
    // Remove any existing notification
    const existing = document.getElementById('busyness-cooldown-notification');
    if (existing) existing.remove();
    
    const notification = document.createElement('div');
    notification.id = 'busyness-cooldown-notification';
    notification.className = 'busyness-cooldown-notification';
    notification.innerHTML = `
        <div class="cooldown-notification-content">
            <div class="cooldown-notification-icon"></div>
            <div class="cooldown-notification-title">Please Wait</div>
            <div class="cooldown-notification-message">
                Someone has already entered a value for <strong>${location}</strong>.
            </div>
            <div class="cooldown-notification-timer">
                Next update available in: <strong>${mins}m ${secs}s</strong>
            </div>
            <button class="cooldown-notification-btn" onclick="this.parentElement.parentElement.remove()">OK</button>
        </div>
    `;
    
    document.body.appendChild(notification);
}

// Get last entry for location (from Firebase timeline data)
function getLastEntryForLocation(location) {
    const locKey = location.replace(/\s+/g, '_');
    const timelineData = busynessTimelineData[locKey] || {};
    const entries = Object.values(timelineData);
    
    if (entries.length === 0) return null;
    
    // Sort by timestamp and return most recent
    entries.sort((a, b) => b.timestamp - a.timestamp);
    return {
        location: location,
        level: entries[0].level,
        timestamp: entries[0].timestamp,
        loggedBy: entries[0].loggedBy
    };
}

// Start cooldown timer updates
let cooldownTimerInterval = null;

function startCooldownTimerUpdates() {
    if (cooldownTimerInterval) clearInterval(cooldownTimerInterval);
    
    cooldownTimerInterval = setInterval(() => {
        BUSYNESS_LOCATIONS.forEach(location => {
            const timerEl = document.querySelector(`.busyness-cooldown[data-location="${location}"] .cooldown-timer`);
            if (timerEl) {
                const remaining = getCooldownRemaining(location);
                if (remaining > 0) {
                    timerEl.textContent = formatCooldownTime(remaining);
                } else {
                    // Cooldown expired - refresh panel
                    closeBusynessPanel();
                    openBusynessPanel();
                }
            }
        });
    }, 1000);
}

// Clear all busyness data for today (Firebase only - no localStorage)
// ============================================================
// FIREBASE CLEANUP - Clear old date-keyed data
// ============================================================

async function showFirebaseCleanupModal() {
    // Password protection - TAM mode bypasses
    if (!isTAMMode && !supervisorAccessUnlocked) {
        const password = prompt(' Enter password to access Firebase cleanup:');
        if (password !== '1920') {
            alert(' Incorrect password. Access denied.');
            return;
        }
    }
    
    if (!firebaseInitialized) {
        alert('Firebase not initialized.');
        return;
    }
    
    // Create modal
    const overlay = document.createElement('div');
    overlay.id = 'firebase-cleanup-overlay';
    overlay.style.cssText = 'position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,3,69,0.7);z-index:10003;display:flex;align-items:center;justify-content:center;padding:1rem;';
    
    const modal = document.createElement('div');
    modal.style.cssText = 'background:white;border-radius:1rem;width:100%;max-width:500px;max-height:90vh;overflow-y:auto;box-shadow:0 20px 60px rgba(0,0,0,0.3);';
    
    modal.innerHTML = 
        '<div style="background:linear-gradient(135deg,#dc2626,#b91c1c);color:white;padding:1.25rem;border-radius:1rem 1rem 0 0;">' +
            '<div style="font-size:1.25rem;font-weight:bold;"> Firebase Cleanup</div>' +
            '<div style="font-size:0.9rem;opacity:0.9;">Remove old date-keyed data</div>' +
        '</div>' +
        '<div style="padding:1.5rem;">' +
            '<p style="margin-bottom:1rem;color:#666;">This will permanently delete Firebase data older than the specified number of days.</p>' +
            '<div style="margin-bottom:1rem;">' +
                '<label style="font-weight:bold;display:block;margin-bottom:0.5rem;">Keep data from the last:</label>' +
                '<select id="cleanup-days" style="width:100%;padding:0.75rem;border:2px solid #ddd;border-radius:0.5rem;font-size:1rem;">' +
                    '<option value="7">7 days</option>' +
                    '<option value="14">14 days</option>' +
                    '<option value="30" selected>30 days</option>' +
                    '<option value="60">60 days</option>' +
                    '<option value="90">90 days</option>' +
                '</select>' +
            '</div>' +
            '<div style="background:#fef3c7;border:1px solid #f59e0b;border-radius:0.5rem;padding:1rem;margin-bottom:1rem;">' +
                '<strong style="color:#92400e;"> Warning:</strong>' +
                '<ul style="margin:0.5rem 0 0 1.25rem;color:#92400e;font-size:0.9rem;">' +
                    '<li>This cannot be undone</li>' +
                    '<li>Old busyness graphs will be lost</li>' +
                    '<li>Old security alerts will be deleted</li>' +
                '</ul>' +
            '</div>' +
            '<div id="cleanup-status" style="display:none;padding:1rem;background:#f0f0f0;border-radius:0.5rem;margin-bottom:1rem;"></div>' +
            '<div style="display:flex;gap:0.75rem;justify-content:flex-end;">' +
                '<button onclick="closeFirebaseCleanupModal()" style="padding:0.75rem 1.5rem;border:none;border-radius:0.5rem;background:#f0f0f0;color:#333;font-weight:bold;cursor:pointer;">Cancel</button>' +
                '<button onclick="executeFirebaseCleanup()" style="padding:0.75rem 1.5rem;border:none;border-radius:0.5rem;background:#dc2626;color:white;font-weight:bold;cursor:pointer;"> Clean Up Old Data</button>' +
            '</div>' +
        '</div>';
    
    overlay.appendChild(modal);
    document.body.appendChild(overlay);
}

function closeFirebaseCleanupModal() {
    const overlay = document.getElementById('firebase-cleanup-overlay');
    if (overlay) overlay.remove();
}

async function executeFirebaseCleanup() {
    const daysToKeep = parseInt(document.getElementById('cleanup-days').value);
    const statusDiv = document.getElementById('cleanup-status');
    
    if (!confirm(' FINAL WARNING\n\nYou are about to DELETE all Firebase data older than ' + daysToKeep + ' days.\n\nThis includes:\n Busyness tracking data\n Active user logs\n Security alerts\n Usage statistics\n\nThis CANNOT be undone. Continue?')) {
        return;
    }
    
    statusDiv.style.display = 'block';
    statusDiv.innerHTML = ' Scanning Firebase for old data...';
    
    const cutoffDate = new Date();
    cutoffDate.setDate(cutoffDate.getDate() - daysToKeep);
    cutoffDate.setHours(0, 0, 0, 0);
    
    const datePatterns = [
        'busyness_cooldowns_',
        'busyness_timeline_',
        'busyness_last_update_',
        'busyness_window_tracking_',
        'active_users_',
        'security_alerts_',
        'flight_data_'
    ];
    
    let deletedCount = 0;
    let errors = [];
    
    try {
        // Get root reference to scan for date-keyed paths
        const rootRef = firebase.database().ref();
        const snapshot = await rootRef.once('value');
        const allKeys = snapshot.val() ? Object.keys(snapshot.val()) : [];
        
        statusDiv.innerHTML = ' Found ' + allKeys.length + ' root paths. Analyzing...';
        
        for (const key of allKeys) {
            // Check if this key matches any date pattern
            for (const pattern of datePatterns) {
                if (key.startsWith(pattern)) {
                    // Extract date from key (format: pattern_YYYY-MM-DD)
                    const dateStr = key.replace(pattern, '');
                    const dateParts = dateStr.split('-');
                    
                    if (dateParts.length === 3) {
                        const keyDate = new Date(parseInt(dateParts[0]), parseInt(dateParts[1]) - 1, parseInt(dateParts[2]));
                        
                        if (keyDate < cutoffDate) {
                            try {
                                await firebase.database().ref(key).remove();
                                deletedCount++;
                                statusDiv.innerHTML = ' Deleted: ' + key + ' (' + deletedCount + ' removed)';
                                console.log(' Deleted:', key);
                            } catch (err) {
                                errors.push(key + ': ' + err.message);
                                console.error('Error deleting', key, err);
                            }
                        }
                    }
                    break;
                }
            }
            
            // Also check firebase_usage/YYYY-MM-DD format
            if (key === 'firebase_usage') {
                const usageSnapshot = await firebase.database().ref('firebase_usage').once('value');
                const usageDates = usageSnapshot.val() ? Object.keys(usageSnapshot.val()) : [];
                
                for (const dateKey of usageDates) {
                    const dateParts = dateKey.split('-');
                    if (dateParts.length === 3) {
                        const keyDate = new Date(parseInt(dateParts[0]), parseInt(dateParts[1]) - 1, parseInt(dateParts[2]));
                        
                        if (keyDate < cutoffDate) {
                            try {
                                await firebase.database().ref('firebase_usage/' + dateKey).remove();
                                deletedCount++;
                                console.log(' Deleted: firebase_usage/' + dateKey);
                            } catch (err) {
                                errors.push('firebase_usage/' + dateKey + ': ' + err.message);
                            }
                        }
                    }
                }
            }
            
            // Also check leadership/YYYY-MM-DD format
            if (key === 'leadership') {
                const leadershipSnapshot = await firebase.database().ref('leadership').once('value');
                const leadershipDates = leadershipSnapshot.val() ? Object.keys(leadershipSnapshot.val()) : [];
                
                for (const dateKey of leadershipDates) {
                    const dateParts = dateKey.split('-');
                    if (dateParts.length === 3) {
                        const keyDate = new Date(parseInt(dateParts[0]), parseInt(dateParts[1]) - 1, parseInt(dateParts[2]));
                        
                        if (keyDate < cutoffDate) {
                            try {
                                await firebase.database().ref('leadership/' + dateKey).remove();
                                deletedCount++;
                                console.log(' Deleted: leadership/' + dateKey);
                            } catch (err) {
                                errors.push('leadership/' + dateKey + ': ' + err.message);
                            }
                        }
                    }
                }
            }
        }
        
        // Show results
        let resultHTML = '<div style="color:#059669;font-weight:bold;margin-bottom:0.5rem;"> Cleanup Complete!</div>';
        resultHTML += '<div>Deleted ' + deletedCount + ' old data paths.</div>';
        
        if (errors.length > 0) {
            resultHTML += '<div style="color:#dc2626;margin-top:0.5rem;"> ' + errors.length + ' errors occurred (check console)</div>';
        }
        
        statusDiv.innerHTML = resultHTML;
        
    } catch (error) {
        console.error('Cleanup error:', error);
        statusDiv.innerHTML = '<div style="color:#dc2626;"> Error: ' + error.message + '</div>';
    }
}

function clearAllBusynessData() {
    // Password protection - TAM mode bypasses
    if (!isTAMMode && !supervisorAccessUnlocked) {
        const password = prompt(' Enter password to clear busyness data:');
        if (password !== '1920') {
            alert(' Incorrect password. Access denied.');
            return;
        }
    }
    
    if (!confirm(' Clear ALL busyness data for today?\n\nThis will remove:\n All logged busyness entries\n Current status for all locations\n Timeline graph data\n Cooldown timers\n\nThis cannot be undone.')) {
        return;
    }
    
    // Clear Firebase cooldowns and timeline data
    if (firebaseInitialized && flightDate) {
        const dateKey = getFlightDateKey();
        
        // Clear cooldowns
        const cooldownRef = firebase.database().ref(`busyness_cooldowns_${dateKey}`);
        cooldownRef.remove().then(() => {
            console.log(' Firebase busyness cooldowns cleared');
        }).catch(err => {
            console.error('Error clearing Firebase cooldowns:', err);
        });
        
        // Clear timeline data
        const timelineRef = firebase.database().ref(`busyness_timeline_${dateKey}`);
        timelineRef.remove().then(() => {
            console.log(' Firebase busyness timeline cleared');
        }).catch(err => {
            console.error('Error clearing Firebase timeline:', err);
        });
    }
    
    // Reset local cooldowns and timeline (will be synced from Firebase listeners)
    busynessCooldowns = {};
    busynessTimelineData = {};
    lastReminderDismissTime = {};
    
    // Update status bar
    updateBusynessStatusBar();
    
    // Refresh the panel
    closeBusynessPanel();
    openBusynessPanel();
    
    console.log(' All busyness data cleared for today');
}

// Get busyness data for report - PURE FIREBASE (combines timeline data)
function getBusynessDataForReport() {
    // Build entries array from Firebase timeline data only
    let allEntries = [];
    
    // Get entries from Firebase timeline data
    BUSYNESS_LOCATIONS.forEach(loc => {
        const locKey = loc.replace(/\s+/g, '_');
        const timelineData = busynessTimelineData[locKey] || {};
        
        Object.values(timelineData).forEach(entry => {
            allEntries.push({
                location: loc,
                level: entry.level,
                timestamp: entry.timestamp,
                loggedBy: entry.loggedBy || 'Unknown',
                isConfirmation: entry.isConfirmation || false
            });
        });
    });
    
    // Sort by timestamp
    allEntries.sort((a, b) => a.timestamp - b.timestamp);
    
    return {
        entries: allEntries,
        summary: generateBusynessSummary(allEntries)
    };
}

// Generate busyness summary for AI narrative
function generateBusynessSummary(entriesArray) {
    const entries = entriesArray || busynessEntries;
    
    if (!entries || entries.length === 0) {
        return 'No busyness data was logged during this shift.';
    }
    
    // Analyze patterns
    const locationSummaries = {};
    BUSYNESS_LOCATIONS.forEach(loc => {
        const locEntries = entries.filter(e => e.location === loc);
        if (locEntries.length > 0) {
            const levels = locEntries.map(e => e.level);
            const severityOrder = ['quiet', 'moderate', 'busy', 'very-busy', 'chaos'];
            const avgSeverity = levels.reduce((sum, l) => sum + severityOrder.indexOf(l), 0) / levels.length;
            
            let avgLabel = 'quiet';
            if (avgSeverity >= 3.5) avgLabel = 'extremely busy';
            else if (avgSeverity >= 2.5) avgLabel = 'very busy';
            else if (avgSeverity >= 1.5) avgLabel = 'moderately busy';
            else if (avgSeverity >= 0.5) avgLabel = 'relatively quiet';
            
            const peakLevel = levels.reduce((max, l) => 
                severityOrder.indexOf(l) > severityOrder.indexOf(max) ? l : max, 'quiet');
            
            locationSummaries[loc] = {
                entries: locEntries.length,
                avgLabel: avgLabel,
                peakLevel: peakLevel
            };
        }
    });
    
    let narrative = `Busyness was tracked ${entries.length} time${entries.length > 1 ? 's' : ''} during this shift. `;
    
    Object.keys(locationSummaries).forEach(loc => {
        const summary = locationSummaries[loc];
        const peakLabel = BUSYNESS_LEVELS.find(l => l.id === summary.peakLevel)?.label || summary.peakLevel;
        narrative += `${loc} was ${summary.avgLabel} on average, with peak activity reaching "${peakLabel}". `;
    });
    
    return narrative;
}

console.log(' Busyness Tracker system initialized');

// ============================================
// SUMMARY REPORT GENERATION SYSTEM
// ============================================

// Session-based authentication flag
let summaryReportAuthenticated = false;
const SUMMARY_REPORT_PASSWORD = '1920';

// Handover data stored in Firebase
let handoverData = {
    content: '',
    lastSavedBy: '',
    lastSavedAt: null,
    lastClearedBy: '',
    lastClearedAt: null
};

function generateSummaryReport() {
    console.log(' Opening Summary Report...');
    
    // TAM Mode: Skip password prompt entirely
    if (isTAMMode) {
        summaryReportAuthenticated = true;
        console.log('TAM Mode - Summary Report unlocked automatically');
        openSummaryReportEditor();
        return;
    }
    
    // Check if already authenticated this session
    if (summaryReportAuthenticated) {
        openSummaryReportEditor();
        return;
    }
    
    // Show password modal
    showPasswordModal();
}

function showPasswordModal() {
    const overlay = document.createElement('div');
    overlay.className = 'password-modal-overlay';
    overlay.id = 'password-modal-overlay';
    
    overlay.innerHTML = `
        <div class="password-modal">
            <div class="password-modal-icon"></div>
            <div class="password-modal-title">Access Summary Report</div>
            <div class="password-modal-subtitle">Enter password to access team leader editing, publishing, and active users</div>
            <div class="password-input-container">
                <input type="password" class="password-input" id="summary-report-password" placeholder="Enter password" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false">
                <div class="password-error-msg" id="password-error">Incorrect password. Please try again.</div>
            </div>
            <div class="password-modal-buttons">
                <button class="password-btn cancel" onclick="closePasswordModal()">Cancel</button>
                <button class="password-btn submit" onclick="submitSummaryPassword()">Submit</button>
            </div>
        </div>
    `;
    
    document.body.appendChild(overlay);
    
    setTimeout(() => {
        const input = document.getElementById('summary-report-password');
        if (input) {
            input.value = ''; // Ensure it's blank
            input.setAttribute('value', ''); // Double ensure
            input.focus();
            input.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    submitSummaryPassword();
                }
            });
        }
    }, 100);
}

function closePasswordModal() {
    const overlay = document.getElementById('password-modal-overlay');
    if (overlay) overlay.remove();
}

function submitSummaryPassword() {
    const input = document.getElementById('summary-report-password');
    const errorMsg = document.getElementById('password-error');
    
    if (input && input.value === SUMMARY_REPORT_PASSWORD) {
        summaryReportAuthenticated = true;
        closePasswordModal();
        openSummaryReportEditor();
    } else {
        if (input) input.classList.add('error');
        if (errorMsg) errorMsg.classList.add('visible');
        
        setTimeout(() => {
            if (input) {
                input.classList.remove('error');
                input.value = '';
                input.focus();
            }
        }, 500);
    }
}

function openSummaryReportEditor() {
    loadHandoverData().then(() => {
        const reportData = gatherReportData();
        showSummaryReportEditor(reportData);
    });
}

function loadHandoverData() {
    return new Promise((resolve) => {
        if (!firebaseInitialized) {
            resolve();
            return;
        }
        
        const dateKey = getTodayDateKey();
        const handoverRef = firebase.database().ref(`handover_notes/${dateKey}`);
        
        handoverRef.once('value', (snapshot) => {
            const data = snapshot.val();
            if (data) {
                handoverData = {
                    content: data.content || '',
                    lastSavedBy: data.lastSavedBy || '',
                    lastSavedAt: data.lastSavedAt || null,
                    lastClearedBy: data.lastClearedBy || '',
                    lastClearedAt: data.lastClearedAt || null
                };
            }
            resolve();
        }).catch(() => resolve());
    });
}

function saveHandoverData() {
    const textarea = document.getElementById('edit-handover');
    if (!textarea) return;
    
    const content = textarea.value.trim();
    const timestamp = Date.now();
    const userName = currentUser?.name || 'Unknown';
    
    handoverData.content = content;
    handoverData.lastSavedBy = userName;
    handoverData.lastSavedAt = timestamp;
    
    if (firebaseInitialized) {
        const dateKey = getTodayDateKey();
        const handoverRef = firebase.database().ref(`handover_notes/${dateKey}`);
        
        handoverRef.update({
            content: content,
            lastSavedBy: userName,
            lastSavedAt: timestamp
        }).then(() => {
            updateHandoverTimestampDisplay();
            showHandoverNotification(' Handover notes saved!', 'success');
        }).catch(err => {
            console.error('Error saving handover:', err);
            showHandoverNotification(' Failed to save', 'error');
        });
    }
}

function clearHandoverData() {
    const textarea = document.getElementById('edit-handover');
    if (textarea) textarea.value = '';
    
    const timestamp = Date.now();
    const userName = currentUser?.name || 'Unknown';
    
    handoverData.content = '';
    handoverData.lastClearedBy = userName;
    handoverData.lastClearedAt = timestamp;
    
    if (firebaseInitialized) {
        const dateKey = getTodayDateKey();
        const handoverRef = firebase.database().ref(`handover_notes/${dateKey}`);
        
        handoverRef.update({
            content: '',
            lastClearedBy: userName,
            lastClearedAt: timestamp
        }).then(() => {
            updateHandoverTimestampDisplay();
            showHandoverNotification(' Handover cleared', 'info');
        });
    }
}

function updateHandoverTimestampDisplay() {
    const timestampDiv = document.getElementById('handover-timestamp-display');
    if (!timestampDiv) return;
    
    let html = '';
    
    if (handoverData.lastSavedAt) {
        const savedTime = new Date(handoverData.lastSavedAt).toLocaleString('en-AU', {
            hour: '2-digit', minute: '2-digit', hour12: false, day: 'numeric', month: 'short'
        });
        html += `<span class="saved-info"> Saved by ${handoverData.lastSavedBy} at ${savedTime}</span>`;
    }
    
    if (handoverData.lastClearedAt) {
        const clearedTime = new Date(handoverData.lastClearedAt).toLocaleString('en-AU', {
            hour: '2-digit', minute: '2-digit', hour12: false, day: 'numeric', month: 'short'
        });
        if (html) html += ' | ';
        html += `<span class="cleared-info"> Cleared by ${handoverData.lastClearedBy} at ${clearedTime}</span>`;
    }
    
    timestampDiv.innerHTML = html || 'No handover activity yet';
}

function showHandoverNotification(message, type) {
    const existing = document.querySelector('.handover-notification');
    if (existing) existing.remove();
    
    const notif = document.createElement('div');
    notif.className = 'handover-notification';
    notif.style.cssText = `
        position: fixed; top: 20px; left: 50%; transform: translateX(-50%);
        padding: 0.75rem 1.5rem; border-radius: 0.5rem; font-weight: 600;
        z-index: 50000; animation: slideDownNotif 0.3s ease-out;
        ${type === 'success' ? 'background: #059669; color: white;' : 
          type === 'error' ? 'background: #dc2626; color: white;' : 
          'background: #3b82f6; color: white;'}
    `;
    notif.innerHTML = message;
    document.body.appendChild(notif);
    
    setTimeout(() => {
        notif.style.opacity = '0';
        notif.style.transition = 'opacity 0.3s';
        setTimeout(() => notif.remove(), 300);
    }, 2500);
}


// Editable Summary Report Preview Modal
function showSummaryReportEditor(data) {
    const overlay = document.createElement('div');
    overlay.className = 'summary-report-overlay';
    overlay.id = 'summary-report-overlay';
    
    const modal = document.createElement('div');
    modal.className = 'summary-report-editor-modal';
    
    const dateStr = data.reportDate.toLocaleDateString('en-AU', {
        weekday: 'long',
        year: 'numeric',
        month: 'long',
        day: 'numeric'
    });
    
    // Generate cancellation text - format with [DOM] tags, use cancelReason
    let cancellationText = '';
    if (data.cancelledFlights.length > 0) {
        cancellationText = data.cancelledFlights.map(f => 
            `[DOM] ${f.flightNumber} (${f.destination}) - ${f.cancelReason || 'No reason specified'}`
        ).join('\n');
    }
    // Note: INTL cancellations added via updateCancelledTextarea after modal loads
    
    // Generate extended flights text - empty if no extensions
    let extendedText = '';
    if (data.extendedFlights.length > 0) {
        extendedText = data.extendedFlights.map(f => 
            `${f.flightNumber} to ${f.destination} (${f.departureTime})${f.extensionDuration ? ' - Extended ' + f.extensionDuration + ' mins' : ''}`
        ).join('\n');
    }
    
    // Generate comments text - empty if no comments
    let commentsText = '';
    const allComments = [...data.comments.map(c => ({...c, type: 'General'})), ...data.zoneEComments.map(c => ({...c, type: 'Zone E'}))];
    if (allComments.length > 0) {
        commentsText = allComments.map(c => {
            const time = new Date(c.timestamp).toLocaleString('en-AU', { hour: '2-digit', minute: '2-digit', hour12: false, day: 'numeric', month: 'short' });
            return `[${time}] [${c.type}] ${c.text}`;
        }).join('\n');
    }
    
    // Generate security alerts text - empty if no alerts
    let securityText = '';
    if (data.securityAlerts.length > 0) {
        securityText = data.securityAlerts.map(a => {
            const time = new Date(a.timestamp).toLocaleTimeString('en-AU', { hour: '2-digit', minute: '2-digit', hour12: false });
            return `[${time}] ${a.type === 'incorrect_pin' ? 'Incorrect PIN Attempt' : 'Security Alert'} - ${a.details || 'Details not available'}`;
        }).join('\n');
    }
    
    // Generate leadership roster HTML - Option C: All positions with names assigned (regardless of visible toggle)
    let leadershipHtml = '';
    const allLeaders = getAllLeadersForReport();
    if (allLeaders.length > 0) {
        leadershipHtml = `
            <div class="summary-editor-section leadership-summary-section">
                <div class="summary-editor-section-title"> Leadership Team on Shift</div>
                <table class="leadership-summary-table">
                    <thead>
                        <tr><th>Position</th><th>Name</th></tr>
                    </thead>
                    <tbody>
                        ${allLeaders.map(l => `<tr><td>${l.position}</td><td>${l.name}</td></tr>`).join('')}
                    </tbody>
                </table>
            </div>
        `;
    }
    
    // Generate busyness graphs preview HTML with AI summaries
    const busynessGraphsHtml = generateBusynessPreviewGraphsWithAI(data.busynessData);
    
    // Handover timestamp info
    let handoverTimestampHtml = '';
    if (handoverData.lastSavedAt || handoverData.lastClearedAt) {
        handoverTimestampHtml = '<div class="handover-timestamp-info" id="handover-timestamp-display"></div>';
    } else {
        handoverTimestampHtml = '<div class="handover-timestamp-info" id="handover-timestamp-display">No handover activity yet</div>';
    }
    
    modal.innerHTML = `
        <div class="summary-editor-header">
            <div class="summary-editor-title"> Check-In Summary Report</div>
            <div class="summary-editor-subtitle">${dateStr}</div>
            <button class="summary-editor-close" onclick="closeSummaryReportEditor()"> </button>
        </div>
        
        <div class="summary-editor-content">
            <!-- HANDOVER SECTION - NOW AT TOP -->
            <div class="summary-editor-section handover-section">
                <div class="summary-editor-section-title"> TAM Handover Notes</div>
                <textarea class="summary-editor-textarea" id="edit-handover" rows="5" placeholder="Enter handover notes for the next shift...">${handoverData.content || ''}</textarea>
                <div class="handover-action-buttons">
                    <button class="handover-action-btn save" onclick="saveHandoverData()"> Save</button>
                    <button class="handover-action-btn clear" onclick="clearHandoverData()"> Clear Content</button>
                </div>
                ${handoverTimestampHtml}
            </div>
            
            <!-- PERFORMANCE & STAFFING - Manual Input Section -->
            <div class="performance-staffing-section">
                <div class="performance-staffing-title">
                     Performance & Staffing
                </div>
                <div class="performance-staffing-content">
                    <div class="performance-boxes">
                        <!-- FF @ 0 Domestic -->
                        <div class="perf-box neutral" id="perf-box-domestic">
                            <div class="perf-box-label">FF @ 0 Domestic</div>
                            <div class="perf-box-value">
                                <input type="number" class="perf-box-input" id="perf-ff-domestic" 
                                    placeholder="--" min="0" max="100" 
                                    onchange="updatePerformanceBox('domestic')" 
                                    oninput="updatePerformanceBox('domestic')">%
                            </div>
                            <div class="perf-box-meta">
                                <span class="perf-target-label">Target: 63%</span>
                                <span class="perf-diff-badge" id="perf-diff-domestic">--</span>
                            </div>
                        </div>
                        
                        <!-- FF @ 0 International -->
                        <div class="perf-box neutral" id="perf-box-intl">
                            <div class="perf-box-label">FF @ 0 International</div>
                            <div class="perf-box-value">
                                <input type="number" class="perf-box-input" id="perf-ff-intl" 
                                    placeholder="--" min="0" max="100"
                                    onchange="updatePerformanceBox('intl')" 
                                    oninput="updatePerformanceBox('intl')">%
                            </div>
                            <div class="perf-box-meta">
                                <span class="perf-target-label">Target: 31%</span>
                                <span class="perf-diff-badge" id="perf-diff-intl">--</span>
                            </div>
                        </div>
                        
                        <!-- Total Sick -->
                        <div class="perf-box neutral" id="perf-box-sick">
                            <div class="perf-box-label">Total Sick</div>
                            <div class="perf-box-value">
                                <input type="number" class="perf-box-input" id="perf-sick" 
                                    placeholder="--" min="0" max="999"
                                    onchange="updatePerformanceBox('sick')" 
                                    oninput="updatePerformanceBox('sick')">
                            </div>
                            <div class="perf-box-meta">
                                <span class="perf-target-label">Staff members</span>
                                <span></span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- SUMMARY STATISTICS - Dynamic Dashboard -->
            <div class="summary-editor-section">
                <div class="summary-editor-section-title"> Summary Statistics</div>
                <div class="summary-editor-stats-content" id="summary-editor-dynamic-stats">
                    <!-- Will be populated by JavaScript with dynamic category counts -->
                </div>
            </div>
            
            <!-- LEADERSHIP TEAM ON SHIFT - NEW SECTION -->
            ${leadershipHtml}
            
            <!-- BUSYNESS TIMELINE GRAPHS WITH AI SUMMARIES -->
            <div class="summary-editor-section">
                <div class="summary-editor-section-title"> Busyness Timeline Graphs</div>
                <div class="summary-editor-help">Visual representation of busyness levels. Click magnifying glass to expand.</div>
                <div class="busyness-preview-container" id="busyness-preview-graphs">
                    ${busynessGraphsHtml}
                </div>
            </div>
            
            <!-- CANCELLED FLIGHTS - Only show if there are cancellations -->
            <div class="summary-editor-section" id="summary-cancelled-section" style="${data.cancelledFlights.length > 0 ? '' : 'display:none;'}">
                <div class="summary-editor-section-title"> Cancelled Flights</div>
                <textarea class="summary-editor-textarea" id="edit-cancelled" rows="4">${cancellationText}</textarea>
            </div>
            
            <!-- EXTENDED CHECK-INS - Only show if there are extensions -->
            <div class="summary-editor-section" id="summary-extended-section" style="${data.extendedFlights.length > 0 ? '' : 'display:none;'}">
                <div class="summary-editor-section-title"> Extended Check-ins</div>
                <textarea class="summary-editor-textarea" id="edit-extended" rows="3">${extendedText}</textarea>
            </div>
            
            <!-- SHIFT COMMENTS - Only show if there are comments -->
            <div class="summary-editor-section" id="summary-comments-section" style="${allComments.length > 0 ? '' : 'display:none;'}">
                <div class="summary-editor-section-title"> Shift Comments & Notes</div>
                <textarea class="summary-editor-textarea" id="edit-comments" rows="4">${commentsText}</textarea>
            </div>
            
            <!-- SECURITY ALERTS - Only show if there are alerts -->
            <div class="summary-editor-section" id="summary-security-section" style="${data.securityAlerts.length > 0 ? '' : 'display:none;'}">
                <div class="summary-editor-section-title"> Access Alerts</div>
                <textarea class="summary-editor-textarea" id="edit-security" rows="3">${securityText}</textarea>
            </div>
            
            <!-- EVENT LOG SECTION (DOMESTIC) -->
            <div class="summary-editor-section event-log-section">
                <div class="event-log-header">
                    <div class="event-log-title"> Event Log (Domestic)</div>
                    <div class="event-log-header-buttons">
                        <button class="event-log-add-btn" onclick="addEventLogEntry()"> Add Event</button>
                        <button class="event-log-clear-btn" onclick="clearAllEventLogEntries('domestic')"> Clear All</button>
                    </div>
                </div>
                <div class="event-log-entries" id="event-log-entries">
                    <!-- Event entries will be populated by JavaScript -->
                </div>
                <div class="event-log-actions">
                    <button class="event-log-save-btn" onclick="saveEventLog()"> Save Activity Log</button>
                    <button class="event-log-sync-btn" onclick="syncEventLog()"> Sync Activity Log</button>
                </div>
                <div class="event-log-status" id="event-log-status"></div>
            </div>
            
            <!-- INTERNATIONAL EVENT LOG SECTION -->
            <div class="summary-editor-section event-log-section intl-event-log-section">
                <div class="event-log-header intl-header">
                    <div class="event-log-title"> International Event Log <span class="intl-badge">INTL</span></div>
                    <div class="event-log-header-buttons">
                        <button class="event-log-add-btn" onclick="addIntlEventLogEntry()"> Add Event</button>
                        <button class="event-log-clear-btn" onclick="clearAllEventLogEntries('international')"> Clear All</button>
                    </div>
                </div>
                <div class="event-log-entries" id="intl-event-log-entries">
                    <!-- INTL Event entries will be populated by JavaScript -->
                </div>
                <div class="event-log-actions">
                    <button class="event-log-save-btn" onclick="saveIntlEventLog()"> Save INTL Activity Log</button>
                    <button class="event-log-sync-btn" onclick="syncIntlEventLog()"> Sync INTL Activity Log</button>
                </div>
                <div class="event-log-status" id="intl-event-log-status"></div>
            </div>
            
            <!-- INTERNATIONAL CANCELLATIONS QUICK-ADD -->
            <div class="summary-editor-section event-log-section intl-cancel-section">
                <div class="event-log-header intl-header">
                    <div class="event-log-title"> International Cancellations <span class="intl-badge">INTL</span></div>
                    <div class="event-log-header-buttons">
                        <button class="event-log-add-btn" onclick="addIntlCancellation()"> Add Cancellation</button>
                        <button class="event-log-clear-btn" onclick="clearAllEventLogEntries('intl-cancellations')"> Clear All</button>
                    </div>
                </div>
                <div class="intl-cancel-entries" id="intl-cancel-entries">
                    <!-- INTL Cancellation entries will be populated by JavaScript -->
                </div>
                <div class="event-log-actions">
                    <button class="event-log-save-btn" onclick="saveIntlCancellations()"> Save Cancellations</button>
                    <button class="event-log-sync-btn" onclick="syncIntlCancellations()"> Sync Cancellations</button>
                </div>
                <div class="event-log-status" id="intl-cancel-status"></div>
                <div class="intl-cancel-note"> These cancellations will be added to the "Cancelled Flights" count and appear in the PDF report.</div>
            </div>
            
            <!-- FIREBASE USAGE - ALL DEVICES -->
            <div class="firebase-usage-info" id="firebase-usage-info">
                <!-- Populated by JavaScript -->
            </div>
        </div>
        
        <div class="summary-editor-footer">
            <button class="summary-editor-btn cancel" onclick="closeSummaryReportEditor()">Cancel</button>
            <button class="summary-editor-btn generate" onclick="generateFinalReport()"> Generate PDF Report</button>
        </div>
    `;
    
    overlay.appendChild(modal);
    document.body.appendChild(overlay);
    
    // Populate Firebase usage stats, handover timestamp, and event log after DOM is added
    setTimeout(() => {
        populateFirebaseUsageStats();
        updateHandoverTimestampDisplay();
        loadEventLogFromFirebase(); // Load and sync domestic event log when opening
        loadIntlEventLogFromFirebase(); // Load INTL event log
        loadIntlCancellationsFromFirebase(); // Load INTL cancellations
        populateDynamicStats(); // Populate dynamic dashboard stats
    }, 100);
    
    // Store report data for later use
    window.currentReportData = data;
    
    console.log(' Summary Report Editor opened');
    
    // Load performance data from Firebase
    setTimeout(() => {
        if (typeof loadPerformanceFromFirebase === 'function') {
            loadPerformanceFromFirebase();
        }
    }, 500);
}

// Get ALL leaders with names assigned (regardless of visible toggle) - Option C
function getAllLeadersForReport() {
    const leaders = [];
    
    LEADERSHIP_POSITIONS.forEach(position => {
        const data = leadershipData[position];
        if (data && data.name && data.name.trim()) {
            leaders.push({
                position: position,
                name: data.name
            });
        }
    });
    
    return leaders;
}

// Generate busyness preview graphs with AI summaries - 1 per line, full width
function generateBusynessPreviewGraphsWithAI(busynessData) {
    if (!busynessData || !busynessData.entries || busynessData.entries.length === 0) {
        return '<div class="busyness-preview-no-data">No busyness data was logged during this shift.</div>';
    }
    
    const levelColors = {
        'quiet': '#22c55e',
        'moderate': '#eab308',
        'busy': '#f97316',
        'very-busy': '#ef4444',
        'chaos': '#1f2937'
    };
    
    const levelLabels = {
        'quiet': 'Quiet',
        'moderate': 'Moderate',
        'busy': 'Busy',
        'very-busy': 'Very Busy',
        'chaos': 'Chaos'
    };
    
    const levelMagnitude = {
        'quiet': 2,
        'moderate': 4,
        'busy': 6,
        'very-busy': 8,
        'chaos': 10
    };
    
    const locationIcons = {
        'Check-In Area': '',
        'Zone E': '',
        'ABDs': '',
        
        'Service Desk': ''
    };
    
    // Group entries by location
    const locationData = {};
    BUSYNESS_LOCATIONS.forEach(loc => {
        locationData[loc] = busynessData.entries.filter(e => e.location === loc);
    });
    
    // Fixed time range
    const today = busynessData.entries[0] ? new Date(busynessData.entries[0].timestamp) : new Date();
    const startTime = new Date(today);
    startTime.setHours(4, 0, 0, 0);
    
    // Chart dimensions - full width, 1 per line
    const chartWidth = 700;
    const chartHeight = 100;
    const padding = { top: 10, bottom: 25, left: 10, right: 10 };
    const graphHeight = chartHeight - padding.top - padding.bottom;
    const graphWidth = chartWidth - padding.left - padding.right;
    
    let graphsHtml = '<div class="busyness-preview-full-width">';
    
    BUSYNESS_LOCATIONS.forEach(location => {
        const entries = locationData[location];
        const icon = locationIcons[location] || '';
        const isZoneE = location === 'Zone E';
        
        // Set end time - Zone E ends at 13:00
        const endTime = new Date(today);
        if (isZoneE) {
            endTime.setHours(13, 0, 0, 0);
        } else {
            endTime.setHours(22, 30, 0, 0);
        }
        const totalDuration = endTime.getTime() - startTime.getTime();
        
        if (!entries || entries.length === 0) {
            graphsHtml += `
                <div class="busyness-preview-item-full">
                    <div class="busyness-preview-header-full">
                        <span class="busyness-preview-name">${icon} ${location}</span>
                        <button class="magnify-graph-btn" onclick="openExpandedGraphView('${location}')"></button>
                    </div>
                    <div class="busyness-preview-empty">No data logged for this location</div>
                </div>
            `;
            return;
        }
        
        // Sort entries by timestamp
        const sortedEntries = [...entries].sort((a, b) => a.timestamp - b.timestamp);
        
        // Calculate bar width
        const barWidth = Math.max(8, Math.min(20, graphWidth / (sortedEntries.length * 2)));
        
        // Build bars (NO Bezier curve)
        let barsHtml = '';
        sortedEntries.forEach(entry => {
            const x = padding.left + ((entry.timestamp - startTime.getTime()) / totalDuration) * graphWidth;
            const magnitude = levelMagnitude[entry.level] || 2;
            const barHeight = (magnitude / 10) * graphHeight;
            const y = padding.top + graphHeight - barHeight;
            const color = levelColors[entry.level] || '#9ca3af';
            
            barsHtml += `<rect x="${x - barWidth/2}" y="${y}" width="${barWidth}" height="${barHeight}" fill="${color}" rx="2"/>`;
        });
        
        // Build X-axis time labels
        let timeLabels = '';
        let tickMarks = '';
        const endHour = isZoneE ? 13 : 22;
        for (let hour = 4; hour <= endHour; hour += 2) {
            const labelTime = new Date(today);
            labelTime.setHours(hour, 0, 0, 0);
            const labelX = padding.left + ((labelTime.getTime() - startTime.getTime()) / totalDuration) * graphWidth;
            timeLabels += `<text x="${labelX}" y="${chartHeight - 5}" style="font-size: 9px; fill: #6b7280; text-anchor: middle;">${hour.toString().padStart(2, '0')}:00</text>`;
            tickMarks += `<line x1="${labelX}" y1="${padding.top + graphHeight}" x2="${labelX}" y2="${padding.top + graphHeight + 4}" stroke="#9ca3af" stroke-width="1"/>`;
        }
        
        // Generate AI summary
        const aiSummary = generateAISummaryForLocation(location, sortedEntries, isZoneE);
        
        // Get last status
        const lastEntry = sortedEntries[sortedEntries.length - 1];
        const lastStatus = levelLabels[lastEntry.level] || lastEntry.level;
        const statusColor = levelColors[lastEntry.level] || '#9ca3af';
        
        graphsHtml += `
            <div class="busyness-preview-item-full">
                <div class="busyness-preview-header-full">
                    <span class="busyness-preview-name">${icon} ${location}</span>
                    <span class="busyness-preview-status" style="background: ${statusColor}20; color: ${statusColor};">Last: ${lastStatus}</span>
                    <button class="magnify-graph-btn" onclick="openExpandedGraphView('${location}')"></button>
                </div>
                <svg width="100%" height="${chartHeight}" viewBox="0 0 ${chartWidth} ${chartHeight}" preserveAspectRatio="xMidYMid meet" style="display: block; max-width: 100%;">
                    <line x1="${padding.left}" y1="${padding.top + graphHeight}" x2="${chartWidth - padding.right}" y2="${padding.top + graphHeight}" stroke="#d1d5db" stroke-width="1"/>
                    ${tickMarks}
                    ${barsHtml}
                    ${timeLabels}
                </svg>
                <div class="busyness-graph-meta">
                    <span>04:00</span>
                    <span style="color: #9ca3af;">${sortedEntries.length} entries</span>
                    <span>${isZoneE ? '13:00' : '22:30'}</span>
                </div>
                <div class="ai-summary-paragraph">
                    <span class="ai-summary-label">AI Summary</span>
                    ${aiSummary}
                </div>
            </div>
        `;
    });
    
    graphsHtml += '</div>';
    
    // Add legend
    graphsHtml += `
        <div class="busyness-legend-compact">
            <span class="legend-item"><span class="legend-dot" style="background: #22c55e;"></span>Quiet</span>
            <span class="legend-item"><span class="legend-dot" style="background: #eab308;"></span>Moderate</span>
            <span class="legend-item"><span class="legend-dot" style="background: #f97316;"></span>Busy</span>
            <span class="legend-item"><span class="legend-dot" style="background: #ef4444;"></span>V.Busy</span>
            <span class="legend-item"><span class="legend-dot" style="background: #1f2937;"></span>Chaos</span>
        </div>
    `;
    
    return graphsHtml;
}

// Generate AI summary for a location based on actual data
function generateAISummaryForLocation(location, entries, isZoneE) {
    if (!entries || entries.length === 0) {
        return 'No activity data recorded for this location.';
    }
    
    const levelSeverity = { 'quiet': 1, 'moderate': 2, 'busy': 3, 'very-busy': 4, 'chaos': 5 };
    const levelLabels = { 'quiet': 'quiet', 'moderate': 'moderate', 'busy': 'busy', 'very-busy': 'very busy', 'chaos': 'extremely busy (chaos)' };
    
    // Find peaks and patterns
    let peakEntry = entries[0];
    let peakSeverity = levelSeverity[entries[0].level] || 1;
    let totalSeverity = 0;
    
    // Track time periods
    const morningEntries = entries.filter(e => {
        const hour = new Date(e.timestamp).getHours();
        return hour >= 4 && hour < 10;
    });
    const middayEntries = entries.filter(e => {
        const hour = new Date(e.timestamp).getHours();
        return hour >= 10 && hour < 14;
    });
    const afternoonEntries = entries.filter(e => {
        const hour = new Date(e.timestamp).getHours();
        return hour >= 14 && hour < 18;
    });
    const eveningEntries = entries.filter(e => {
        const hour = new Date(e.timestamp).getHours();
        return hour >= 18;
    });
    
    entries.forEach(e => {
        const severity = levelSeverity[e.level] || 1;
        totalSeverity += severity;
        if (severity > peakSeverity) {
            peakSeverity = severity;
            peakEntry = e;
        }
    });
    
    const avgSeverity = totalSeverity / entries.length;
    const peakTime = new Date(peakEntry.timestamp).toLocaleTimeString('en-AU', { hour: '2-digit', minute: '2-digit', hour12: false });
    const peakLabel = levelLabels[peakEntry.level] || peakEntry.level;
    
    // Calculate period averages
    const calcAvg = (arr) => {
        if (arr.length === 0) return 0;
        return arr.reduce((sum, e) => sum + (levelSeverity[e.level] || 1), 0) / arr.length;
    };
    
    const morningAvg = calcAvg(morningEntries);
    const middayAvg = calcAvg(middayEntries);
    const afternoonAvg = calcAvg(afternoonEntries);
    const eveningAvg = calcAvg(eveningEntries);
    
    // Build narrative
    let summary = '';
    
    // Opening statement with peak
    summary += `${location} experienced peak activity around ${peakTime}, reaching ${peakLabel} levels. `;
    
    // Morning period
    if (morningEntries.length > 0) {
        if (morningAvg >= 3.5) {
            summary += 'The morning period (04:00-10:00) was particularly busy, likely due to early departures. ';
        } else if (morningAvg >= 2) {
            summary += 'Morning activity was moderate with steady passenger flow. ';
        } else {
            summary += 'The early morning remained relatively quiet. ';
        }
    }
    
    // Midday
    if (middayEntries.length > 0 && !isZoneE) {
        if (middayAvg > morningAvg + 0.5) {
            summary += 'Activity increased through midday. ';
        } else if (middayAvg < morningAvg - 0.5) {
            summary += 'Traffic quietened after the morning rush. ';
        }
    }
    
    // Afternoon/Evening for non-Zone E
    if (!isZoneE) {
        if (afternoonEntries.length > 0 && afternoonAvg >= 3) {
            summary += 'A secondary busy period occurred in the afternoon, coinciding with afternoon departures. ';
        }
        if (eveningEntries.length > 0) {
            if (eveningAvg < 2) {
                summary += 'Evening operations were quiet.';
            } else {
                summary += 'Evening maintained steady activity levels.';
            }
        }
    } else {
        summary += 'Operations concluded at 12:00 PM as scheduled.';
    }
    
    return summary;
}

function generateBusynessPreviewGraphs(busynessData) {
    if (!busynessData || !busynessData.entries || busynessData.entries.length === 0) {
        return '<div class="busyness-preview-no-data">No busyness data was logged during this shift.</div>';
    }
    
    const levelColors = {
        'quiet': '#22c55e',
        'moderate': '#eab308',
        'busy': '#f97316',
        'very-busy': '#ef4444',
        'chaos': '#1f2937'
    };
    
    const levelLabels = {
        'quiet': 'Quiet',
        'moderate': 'Moderate',
        'busy': 'Busy',
        'very-busy': 'Very Busy',
        'chaos': 'Chaos'
    };
    
    // Group entries by location
    const locationData = {};
    BUSYNESS_LOCATIONS.forEach(loc => {
        locationData[loc] = busynessData.entries.filter(e => e.location === loc);
    });
    
    let graphsHtml = '<div class="busyness-preview-grid">';
    
    BUSYNESS_LOCATIONS.forEach(location => {
        const entries = locationData[location];
        const shortName = location
            .replace('Check-In Area', 'Check-In')
            ;
        
        if (!entries || entries.length === 0) {
            graphsHtml += `
                <div class="busyness-preview-item">
                    <div class="busyness-preview-header">
                        <span class="busyness-preview-name">${shortName}</span>
                        <span class="busyness-preview-status no-data">No Data</span>
                    </div>
                    <div class="busyness-preview-empty">No data logged</div>
                </div>
            `;
            return;
        }
        
        // Sort entries by timestamp
        const sortedEntries = entries.slice().sort((a, b) => a.timestamp - b.timestamp);
        const firstEntry = sortedEntries[0];
        const lastEntry = sortedEntries[sortedEntries.length - 1];
        const firstTime = new Date(firstEntry.timestamp);
        const lastTime = new Date(lastEntry.timestamp);
        const totalDuration = lastTime.getTime() - firstTime.getTime() || 1;
        
        // Build stepped segments
        let segmentsHtml = '';
        for (let i = 0; i < sortedEntries.length; i++) {
            const entry = sortedEntries[i];
            const nextEntry = sortedEntries[i + 1];
            const startTime = entry.timestamp;
            const endTime = nextEntry ? nextEntry.timestamp : lastTime.getTime();
            const startPercent = ((startTime - firstTime.getTime()) / totalDuration) * 100;
            const widthPercent = ((endTime - startTime) / totalDuration) * 100;
            const color = levelColors[entry.level] || '#9ca3af';
            
            segmentsHtml += `<div class="preview-timeline-segment" style="left: ${startPercent}%; width: ${widthPercent}%; background: ${color};"></div>`;
        }
        
        const firstTimeStr = firstTime.toLocaleTimeString('en-AU', { hour: '2-digit', minute: '2-digit', hour12: false });
        const lastTimeStr = lastTime.toLocaleTimeString('en-AU', { hour: '2-digit', minute: '2-digit', hour12: false });
        const lastStatus = levelLabels[lastEntry.level] || lastEntry.level;
        const statusColor = levelColors[lastEntry.level] || '#9ca3af';
        
        graphsHtml += `
            <div class="busyness-preview-item">
                <div class="busyness-preview-header">
                    <span class="busyness-preview-name">${shortName}</span>
                    <span class="busyness-preview-status" style="background: ${statusColor}20; color: ${statusColor};">Last: ${lastStatus}</span>
                </div>
                <div class="preview-timeline-bar">
                    ${segmentsHtml}
                </div>
                <div class="preview-timeline-labels">
                    <span>${firstTimeStr}</span>
                    <span>${sortedEntries.length} entries</span>
                    <span>${lastTimeStr}</span>
                </div>
            </div>
        `;
    });
    
    graphsHtml += '</div>';
    
    // Add legend
    graphsHtml += '<div class="busyness-preview-legend">';
    ['quiet', 'moderate', 'busy', 'very-busy', 'chaos'].forEach(level => {
        graphsHtml += `<span class="preview-legend-item"><span class="preview-legend-color" style="background: ${levelColors[level]};"></span>${levelLabels[level]}</span>`;
    });
    graphsHtml += '</div>';
    
    return graphsHtml;
}

function showHandoverInput() {
    document.getElementById('handover-question').style.display = 'none';
    document.getElementById('handover-input-container').style.display = 'block';
    document.getElementById('edit-handover').focus();
}

function hideHandoverInput() {
    document.getElementById('handover-question').style.display = 'none';
    document.getElementById('handover-input-container').style.display = 'none';
    document.getElementById('edit-handover').value = '';
}

function closeSummaryReportEditor() {
    const overlay = document.getElementById('summary-report-overlay');
    if (overlay) overlay.remove();
    window.currentReportData = null;
}

// ============================================
// EVENT LOG SYSTEM
// ============================================
const EVENT_LOG_STORAGE_KEY = 'flight_tracker_event_log';
const EVENT_LOG_FIREBASE_KEY = 'event_log';
let eventLogEntries = [];
let eventLogSynced = false;

// Get current user name from login system
function getCurrentUserName() {
    // Try to get from currentUser first (the active login session)
    if (typeof currentUser !== 'undefined' && currentUser && currentUser.name) {
        return currentUser.name;
    }
    // Fallback to localStorage
    const savedUser = localStorage.getItem('flight_tracker_user_session');
    if (savedUser) {
        try {
            const user = JSON.parse(savedUser);
            return user.name || 'Unknown User';
        } catch (e) {
            return 'Unknown User';
        }
    }
    return 'Unknown User';
}

// Load event log from localStorage
function loadEventLogFromStorage() {
    try {
        const stored = localStorage.getItem(EVENT_LOG_STORAGE_KEY);
        if (stored) {
            const data = JSON.parse(stored);
            // Check if data is from today (clear at midnight)
            const today = new Date().toDateString();
            if (data.date === today) {
                eventLogEntries = data.entries || [];
            } else {
                // Old data from previous day - clear it
                eventLogEntries = [];
                localStorage.removeItem(EVENT_LOG_STORAGE_KEY);
            }
        }
    } catch (e) {
        console.error('Error loading event log from storage:', e);
        eventLogEntries = [];
    }
}

// Save event log to localStorage
function saveEventLogToStorage() {
    try {
        const data = {
            date: new Date().toDateString(),
            entries: eventLogEntries,
            lastSaved: Date.now()
        };
        localStorage.setItem(EVENT_LOG_STORAGE_KEY, JSON.stringify(data));
    } catch (e) {
        console.error('Error saving event log to storage:', e);
    }
}

// Generate unique ID for event entries
function generateEventId() {
    return 'evt_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
}

// Add a new event log entry
function addEventLogEntry() {
    const now = new Date();
    const timeStr = now.toLocaleTimeString('en-AU', { hour: '2-digit', minute: '2-digit', hour12: false });
    
    const newEntry = {
        id: generateEventId(),
        time: timeStr,
        user: getCurrentUserName(),
        category: '',
        description: '',
        createdAt: Date.now()
    };
    
    eventLogEntries.push(newEntry);
    renderEventLogEntries();
    
    // Focus on the new textarea
    setTimeout(() => {
        const textarea = document.querySelector(`#event-entry-${newEntry.id} .event-log-textarea`);
        if (textarea) textarea.focus();
    }, 100);
}

// Remove an event log entry
function removeEventLogEntry(entryId) {
    eventLogEntries = eventLogEntries.filter(e => e.id !== entryId);
    renderEventLogEntries();
}

// Update an event entry field
function updateEventLogEntry(entryId, field, value) {
    const entry = eventLogEntries.find(e => e.id === entryId);
    if (entry) {
        entry[field] = value;
        entry.updatedAt = Date.now();
        
        // If category changed, update the summary stats immediately
        if (field === 'category') {
            if (typeof populateDynamicStats === 'function') populateDynamicStats();
        }
    }
}

// Render all event log entries
function renderEventLogEntries() {
    const container = document.getElementById('event-log-entries');
    if (!container) return;
    
    // Update dynamic stats dashboard
    if (typeof populateDynamicStats === 'function') populateDynamicStats();
    
    if (eventLogEntries.length === 0) {
        container.innerHTML = '<div class="event-log-empty">No events logged yet. Click " Add Event" to start logging.</div>';
        return;
    }
    
    // Sort by time
    const sorted = [...eventLogEntries].sort((a, b) => {
        const timeA = a.time.replace(':', '');
        const timeB = b.time.replace(':', '');
        return timeA.localeCompare(timeB);
    });
    
    container.innerHTML = sorted.map(entry => {
        const categoryBadge = entry.category ? 
            `<span class="event-log-category-badge ${entry.category}">${getCategoryLabel(entry.category)}</span>` : '';
        
        return `
            <div class="event-log-entry ${entry.important ? 'important' : ''}" id="event-entry-${entry.id}">
                <div class="event-log-entry-header">
                    <button class="event-star-toggle ${entry.important ? 'active' : ''}" 
                        onclick="toggleEventImportant('${entry.id}')" 
                        title="${entry.important ? 'Unmark as important' : 'Mark as important'}">
                        ${entry.important ? '' : ''}
                    </button>
                    <input type="time" class="event-log-time-input" value="${entry.time}" 
                        onchange="updateEventLogEntry('${entry.id}', 'time', this.value)">
                    <input type="text" class="event-log-user-input" value="${entry.user}" placeholder="User name"
                        onchange="updateEventLogEntry('${entry.id}', 'user', this.value)"
                        oninput="updateEventLogEntry('${entry.id}', 'user', this.value)">
                    <select class="event-log-category-select" onchange="updateEventLogEntry('${entry.id}', 'category', this.value)">
                        <option value="">-- Select (optional) --</option>
                        <option value="afp" ${entry.category === 'afp' ? 'selected' : ''}>AFP Required</option>
                        <option value="aircraft_damage" ${entry.category === 'aircraft_damage' ? 'selected' : ''}>Aircraft Damage</option>
                        <option value="infrastructure" ${entry.category === 'infrastructure' ? 'selected' : ''}>Airport Infrastructure</option>
                        <option value="checkin_issues" ${entry.category === 'checkin_issues' ? 'selected' : ''}>Check-In Issues</option>
                        <option value="cjo_issues" ${entry.category === 'cjo_issues' ? 'selected' : ''}>CJO Issues</option>
                        <option value="coaching" ${entry.category === 'coaching' ? 'selected' : ''}>Coaching Conversations</option>
                        <option value="concourse_issues" ${entry.category === 'concourse_issues' ? 'selected' : ''}>Concourse Issues</option>
                        <option value="crewing" ${entry.category === 'crewing' ? 'selected' : ''}>Crewing</option>
                        <option value="damp" ${entry.category === 'damp' ? 'selected' : ''}>DAMP Test</option>
                        <option value="delay_dispute" ${entry.category === 'delay_dispute' ? 'selected' : ''}>Delay Dispute</option>
                        <option value="downgrades" ${entry.category === 'downgrades' ? 'selected' : ''}>Downgrades</option>
                        <option value="engineering" ${entry.category === 'engineering' ? 'selected' : ''}>Engineering</option>
                        <option value="flight_capped" ${entry.category === 'flight_capped' ? 'selected' : ''}>Flight Capped</option>
                        <option value="general" ${entry.category === 'general' ? 'selected' : ''}>General</option>
                        <option value="internal_equipment" ${entry.category === 'internal_equipment' ? 'selected' : ''}>Internal Equipment Issues (PMK, Radios)</option>
                        <option value="it_issues" ${entry.category === 'it_issues' ? 'selected' : ''}>IT Issues</option>
                        <option value="medical" ${entry.category === 'medical' ? 'selected' : ''}>Medical</option>
                        <option value="operational_req" ${entry.category === 'operational_req' ? 'selected' : ''}>Operational Requirements</option>
                        <option value="escalation" ${entry.category === 'escalation' ? 'selected' : ''}>Passenger Escalation</option>
                        <option value="pax_injury" ${entry.category === 'pax_injury' ? 'selected' : ''}>Pax Injury</option>
                        <option value="safety" ${entry.category === 'safety' ? 'selected' : ''}>Safety</option>
                        <option value="security" ${entry.category === 'security' ? 'selected' : ''}>Security</option>
                        <option value="sop" ${entry.category === 'sop' ? 'selected' : ''}>SOP Breach</option>
                        <option value="stakeholder_equipment" ${entry.category === 'stakeholder_equipment' ? 'selected' : ''}>Stakeholder Equipment Issues</option>
                        <option value="stakeholders" ${entry.category === 'stakeholders' ? 'selected' : ''}>Stakeholders</option>
                        <option value="injury" ${entry.category === 'injury' ? 'selected' : ''}>Staff Injury</option>
                        <option value="stock" ${entry.category === 'stock' ? 'selected' : ''}>Stock</option>
                        <option value="upgrades" ${entry.category === 'upgrades' ? 'selected' : ''}>Upgrades</option>
                        <option value="weather" ${entry.category === 'weather' ? 'selected' : ''}>Weather</option>
                    </select>
                    <button class="event-log-remove-btn" onclick="removeEventLogEntry('${entry.id}')"> Remove</button>
                </div>
                <textarea class="event-log-textarea" placeholder="Describe the event..."
                    onchange="updateEventLogEntry('${entry.id}', 'description', this.value)"
                    oninput="updateEventLogEntry('${entry.id}', 'description', this.value)">${entry.description || ''}</textarea>
            </div>
        `;
    }).join('');
}

// Get category label for display
function getCategoryLabel(category) {
    const labels = {
        'afp': 'AFP Required',
        'aircraft_damage': 'Aircraft Damage',
        'infrastructure': 'Airport Infrastructure',
        'checkin_issues': 'Check-In Issues',
        'cjo_issues': 'CJO Issues',
        'coaching': 'Coaching Conversations',
        'concourse_issues': 'Concourse Issues',
        'crewing': 'Crewing',
        'damp': 'DAMP Test',
        'delay_dispute': 'Delay Dispute',
        'downgrades': 'Downgrades',
        'engineering': 'Engineering',
        'flight_capped': 'Flight Capped',
        'general': 'General',
        'internal_equipment': 'Internal Equipment Issues (PMK, Radios)',
        'it_issues': 'IT Issues',
        'medical': 'Medical',
        'operational_req': 'Operational Requirements',
        'escalation': 'Passenger Escalation',
        'pax_injury': 'Pax Injury',
        'safety': 'Safety',
        'security': 'Security',
        'sop': 'SOP Breach',
        'stakeholder_equipment': 'Stakeholder Equipment Issues',
        'stakeholders': 'Stakeholders',
        'injury': 'Staff Injury',
        'stock': 'Stock',
        'upgrades': 'Upgrades',
        'weather': 'Weather'
    };
    return labels[category] || category;
}

// Save event log (to localStorage)
function saveEventLog() {
    saveEventLogToStorage();
    
    const statusEl = document.getElementById('event-log-status');
    if (statusEl) {
        const now = new Date().toLocaleTimeString('en-AU', { hour: '2-digit', minute: '2-digit', hour12: false });
        statusEl.innerHTML = ` Saved locally at ${now}. Click "Sync Activity Log" to share with other devices.`;
        statusEl.style.color = '#059669';
    }
    
    console.log(' Event log saved to localStorage:', eventLogEntries.length, 'entries');
}

// Sync event log to Firebase
async function syncEventLog() {
    if (!firebaseInitialized) {
        alert('Firebase not connected. Please check your connection.');
        return;
    }
    
    const statusEl = document.getElementById('event-log-status');
    if (statusEl) {
        statusEl.innerHTML = ' Syncing to Firebase...';
        statusEl.style.color = '#f59e0b';
    }
    
    try {
        const eventLogRef = firebase.database().ref(getFirebasePath(EVENT_LOG_FIREBASE_KEY));
        
        // Get current Firebase data
        const snapshot = await eventLogRef.once('value');
        const firebaseData = snapshot.val() || { entries: [] };
        
        // Merge local entries with Firebase entries
        const mergedEntries = mergeEventLogEntries(eventLogEntries, firebaseData.entries || []);
        
        // Save merged data to Firebase
        await eventLogRef.set({
            entries: mergedEntries,
            lastSyncedAt: Date.now(),
            lastSyncedBy: getCurrentUserName()
        });
        
        // Update local entries with merged data
        eventLogEntries = mergedEntries;
        saveEventLogToStorage();
        renderEventLogEntries();
        
        const now = new Date().toLocaleTimeString('en-AU', { hour: '2-digit', minute: '2-digit', hour12: false });
        if (statusEl) {
            statusEl.innerHTML = ` Synced to Firebase at ${now}. All devices can now see these entries.`;
            statusEl.style.color = '#059669';
        }
        
        eventLogSynced = true;
        console.log(' Event log synced to Firebase:', mergedEntries.length, 'entries');
        
    } catch (error) {
        console.error('Error syncing event log to Firebase:', error);
        if (statusEl) {
            statusEl.innerHTML = ' Sync failed. Please try again.';
            statusEl.style.color = '#dc2626';
        }
    }
}

// Merge event log entries (combine unique entries by ID)
function mergeEventLogEntries(localEntries, firebaseEntries) {
    const merged = new Map();
    
    // Add all firebase entries first
    (firebaseEntries || []).forEach(entry => {
        if (entry && entry.id) {
            merged.set(entry.id, entry);
        }
    });
    
    // Add/update with local entries (local takes precedence for same ID)
    (localEntries || []).forEach(entry => {
        if (entry && entry.id) {
            const existing = merged.get(entry.id);
            if (!existing || (entry.updatedAt && entry.updatedAt > (existing.updatedAt || 0))) {
                merged.set(entry.id, entry);
            }
        }
    });
    
    // Convert back to array and sort by time
    return Array.from(merged.values()).sort((a, b) => {
        const timeA = (a.time || '00:00').replace(':', '');
        const timeB = (b.time || '00:00').replace(':', '');
        return timeA.localeCompare(timeB);
    });
}

// Load event log from Firebase (called when Summary Report opens)
async function loadEventLogFromFirebase() {
    if (!firebaseInitialized) {
        console.log(' Firebase not initialized, using local storage only');
        loadEventLogFromStorage();
        renderEventLogEntries();
        return;
    }
    
    try {
        const eventLogRef = firebase.database().ref(getFirebasePath(EVENT_LOG_FIREBASE_KEY));
        const snapshot = await eventLogRef.once('value');
        const firebaseData = snapshot.val();
        
        // Load local data first
        loadEventLogFromStorage();
        
        if (firebaseData && firebaseData.entries) {
            // Merge with local entries
            eventLogEntries = mergeEventLogEntries(eventLogEntries, firebaseData.entries);
            saveEventLogToStorage();
            
            const statusEl = document.getElementById('event-log-status');
            if (statusEl && firebaseData.lastSyncedBy) {
                const syncTime = new Date(firebaseData.lastSyncedAt).toLocaleTimeString('en-AU', { hour: '2-digit', minute: '2-digit', hour12: false });
                statusEl.innerHTML = ` Last synced by ${firebaseData.lastSyncedBy} at ${syncTime}`;
                statusEl.style.color = '#6b7280';
            }
        }
        
        renderEventLogEntries();
        console.log(' Event log loaded from Firebase:', eventLogEntries.length, 'entries');
        
    } catch (error) {
        console.error('Error loading event log from Firebase:', error);
        loadEventLogFromStorage();
        renderEventLogEntries();
    }
}

// Get event log entries for PDF generation
function getEventLogForReport() {
    return eventLogEntries.map(entry => ({
        time: entry.time,
        user: entry.user,
        category: entry.category ? getCategoryLabel(entry.category) : '',
        categoryKey: entry.category || '',
        description: entry.description,
        important: entry.important || false
    }));
}

// Generate category summary for event log
function generateCategorySummary(entries) {
    const counts = {};
    entries.forEach(entry => {
        if (entry.category) {
            counts[entry.category] = (counts[entry.category] || 0) + 1;
        }
    });
    
    // Only show categories with at least 1 entry
    const summaryItems = Object.entries(counts)
        .filter(([cat, count]) => count >= 1)
        .sort((a, b) => b[1] - a[1])
        .map(([cat, count]) => `<span class="category-summary-stat"><span class="count">${count}</span> ${getCategoryLabel(cat)}</span>`)
        .join('');
    
    if (!summaryItems) return '';
    return `<span class="category-summary-title"> Summary:</span>${summaryItems}`;
}

// Update category summary display
function updateCategorySummary() {
    const summaryContainer = document.getElementById('event-log-category-summary');
    if (summaryContainer) {
        const summaryHtml = generateCategorySummary(eventLogEntries);
        summaryContainer.innerHTML = summaryHtml || '<span style="color:#9ca3af;font-style:italic;">No categorized entries yet</span>';
    }
}

// ============================================
// INTERNATIONAL EVENT LOG SYSTEM
// ============================================
const INTL_EVENT_LOG_STORAGE_KEY = 'flight_tracker_intl_event_log';
const INTL_EVENT_LOG_FIREBASE_KEY = 'event_log_intl';
let intlEventLogEntries = [];

// Load INTL event log from localStorage
function loadIntlEventLogFromStorage() {
    try {
        const stored = localStorage.getItem(INTL_EVENT_LOG_STORAGE_KEY);
        if (stored) {
            const data = JSON.parse(stored);
            const today = new Date().toDateString();
            if (data.date === today) {
                intlEventLogEntries = data.entries || [];
            } else {
                intlEventLogEntries = [];
                localStorage.removeItem(INTL_EVENT_LOG_STORAGE_KEY);
            }
        }
    } catch (e) {
        console.error('Error loading INTL event log from storage:', e);
        intlEventLogEntries = [];
    }
}

// Save INTL event log to localStorage
function saveIntlEventLogToStorage() {
    try {
        const data = {
            date: new Date().toDateString(),
            entries: intlEventLogEntries,
            lastSaved: Date.now()
        };
        localStorage.setItem(INTL_EVENT_LOG_STORAGE_KEY, JSON.stringify(data));
    } catch (e) {
        console.error('Error saving INTL event log to storage:', e);
    }
}

// Add INTL event log entry
function addIntlEventLogEntry() {
    const now = new Date();
    const timeStr = now.toLocaleTimeString('en-AU', { hour: '2-digit', minute: '2-digit', hour12: false });
    
    const newEntry = {
        id: 'intl_evt_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9),
        time: timeStr,
        user: getCurrentUserName(),
        category: '',
        description: '',
        createdAt: Date.now()
    };
    
    intlEventLogEntries.push(newEntry);
    renderIntlEventLogEntries();
    
    setTimeout(() => {
        const textarea = document.querySelector(`#intl-event-entry-${newEntry.id} .event-log-textarea`);
        if (textarea) textarea.focus();
    }, 100);
}

// Remove INTL event log entry
function removeIntlEventLogEntry(entryId) {
    intlEventLogEntries = intlEventLogEntries.filter(e => e.id !== entryId);
    renderIntlEventLogEntries();
}

// Update INTL event entry field
function updateIntlEventLogEntry(entryId, field, value) {
    const entry = intlEventLogEntries.find(e => e.id === entryId);
    if (entry) {
        entry[field] = value;
        entry.updatedAt = Date.now();
        
        // If category changed, update the summary stats immediately
        if (field === 'category') {
            if (typeof populateDynamicStats === 'function') populateDynamicStats();
        }
    }
}

// Render INTL event log entries
function renderIntlEventLogEntries() {
    const container = document.getElementById('intl-event-log-entries');
    if (!container) return;
    
    // Update dynamic stats dashboard
    if (typeof populateDynamicStats === 'function') populateDynamicStats();
    
    if (intlEventLogEntries.length === 0) {
        container.innerHTML = '<div class="event-log-empty">No international events logged yet. Click " Add Event" to start logging.</div>';
        return;
    }
    
    const sorted = [...intlEventLogEntries].sort((a, b) => {
        const timeA = a.time.replace(':', '');
        const timeB = b.time.replace(':', '');
        return timeA.localeCompare(timeB);
    });
    
    container.innerHTML = sorted.map(entry => {
        return `
            <div class="event-log-entry ${entry.important ? 'important' : ''}" id="intl-event-entry-${entry.id}">
                <div class="event-log-entry-header">
                    <button class="event-star-toggle ${entry.important ? 'active' : ''}" 
                        onclick="toggleIntlEventImportant('${entry.id}')" 
                        title="${entry.important ? 'Unmark as important' : 'Mark as important'}">
                        ${entry.important ? '' : ''}
                    </button>
                    <span class="intl-badge">INTL</span>
                    <input type="time" class="event-log-time-input" value="${entry.time}" 
                        onchange="updateIntlEventLogEntry('${entry.id}', 'time', this.value)">
                    <input type="text" class="event-log-user-input" value="${entry.user}" placeholder="User name"
                        onchange="updateIntlEventLogEntry('${entry.id}', 'user', this.value)"
                        oninput="updateIntlEventLogEntry('${entry.id}', 'user', this.value)">
                    <select class="event-log-category-select" onchange="updateIntlEventLogEntry('${entry.id}', 'category', this.value)">
                        <option value="">-- Select (optional) --</option>
                        <option value="afp" ${entry.category === 'afp' ? 'selected' : ''}>AFP Required</option>
                        <option value="aircraft_damage" ${entry.category === 'aircraft_damage' ? 'selected' : ''}>Aircraft Damage</option>
                        <option value="infrastructure" ${entry.category === 'infrastructure' ? 'selected' : ''}>Airport Infrastructure</option>
                        <option value="checkin_issues" ${entry.category === 'checkin_issues' ? 'selected' : ''}>Check-In Issues</option>
                        <option value="cjo_issues" ${entry.category === 'cjo_issues' ? 'selected' : ''}>CJO Issues</option>
                        <option value="coaching" ${entry.category === 'coaching' ? 'selected' : ''}>Coaching Conversations</option>
                        <option value="concourse_issues" ${entry.category === 'concourse_issues' ? 'selected' : ''}>Concourse Issues</option>
                        <option value="crewing" ${entry.category === 'crewing' ? 'selected' : ''}>Crewing</option>
                        <option value="damp" ${entry.category === 'damp' ? 'selected' : ''}>DAMP Test</option>
                        <option value="delay_dispute" ${entry.category === 'delay_dispute' ? 'selected' : ''}>Delay Dispute</option>
                        <option value="downgrades" ${entry.category === 'downgrades' ? 'selected' : ''}>Downgrades</option>
                        <option value="engineering" ${entry.category === 'engineering' ? 'selected' : ''}>Engineering</option>
                        <option value="flight_capped" ${entry.category === 'flight_capped' ? 'selected' : ''}>Flight Capped</option>
                        <option value="general" ${entry.category === 'general' ? 'selected' : ''}>General</option>
                        <option value="internal_equipment" ${entry.category === 'internal_equipment' ? 'selected' : ''}>Internal Equipment Issues (PMK, Radios)</option>
                        <option value="it_issues" ${entry.category === 'it_issues' ? 'selected' : ''}>IT Issues</option>
                        <option value="medical" ${entry.category === 'medical' ? 'selected' : ''}>Medical</option>
                        <option value="operational_req" ${entry.category === 'operational_req' ? 'selected' : ''}>Operational Requirements</option>
                        <option value="escalation" ${entry.category === 'escalation' ? 'selected' : ''}>Passenger Escalation</option>
                        <option value="pax_injury" ${entry.category === 'pax_injury' ? 'selected' : ''}>Pax Injury</option>
                        <option value="safety" ${entry.category === 'safety' ? 'selected' : ''}>Safety</option>
                        <option value="security" ${entry.category === 'security' ? 'selected' : ''}>Security</option>
                        <option value="sop" ${entry.category === 'sop' ? 'selected' : ''}>SOP Breach</option>
                        <option value="stakeholder_equipment" ${entry.category === 'stakeholder_equipment' ? 'selected' : ''}>Stakeholder Equipment Issues</option>
                        <option value="stakeholders" ${entry.category === 'stakeholders' ? 'selected' : ''}>Stakeholders</option>
                        <option value="injury" ${entry.category === 'injury' ? 'selected' : ''}>Staff Injury</option>
                        <option value="stock" ${entry.category === 'stock' ? 'selected' : ''}>Stock</option>
                        <option value="upgrades" ${entry.category === 'upgrades' ? 'selected' : ''}>Upgrades</option>
                        <option value="weather" ${entry.category === 'weather' ? 'selected' : ''}>Weather</option>
                    </select>
                    <button class="event-log-remove-btn" onclick="removeIntlEventLogEntry('${entry.id}')"> Remove</button>
                </div>
                <textarea class="event-log-textarea" placeholder="Describe the event..."
                    onchange="updateIntlEventLogEntry('${entry.id}', 'description', this.value)"
                    oninput="updateIntlEventLogEntry('${entry.id}', 'description', this.value)">${entry.description || ''}</textarea>
            </div>
        `;
    }).join('');
}

// Save INTL event log (to localStorage)
function saveIntlEventLog() {
    saveIntlEventLogToStorage();
    
    const statusEl = document.getElementById('intl-event-log-status');
    if (statusEl) {
        const now = new Date().toLocaleTimeString('en-AU', { hour: '2-digit', minute: '2-digit', hour12: false });
        statusEl.innerHTML = ` Saved locally at ${now}. Click "Sync INTL Activity Log" to share with other devices.`;
        statusEl.style.color = '#059669';
    }
    
    console.log(' INTL Event log saved to localStorage:', intlEventLogEntries.length, 'entries');
}

// Sync INTL event log to Firebase
async function syncIntlEventLog() {
    if (!firebaseInitialized) {
        alert('Firebase not connected. Please check your connection.');
        return;
    }
    
    const statusEl = document.getElementById('intl-event-log-status');
    if (statusEl) {
        statusEl.innerHTML = ' Syncing to Firebase...';
        statusEl.style.color = '#f59e0b';
    }
    
    try {
        const eventLogRef = firebase.database().ref(getFirebasePath(INTL_EVENT_LOG_FIREBASE_KEY));
        const snapshot = await eventLogRef.once('value');
        const firebaseData = snapshot.val() || { entries: [] };
        
        const mergedEntries = mergeEventLogEntries(intlEventLogEntries, firebaseData.entries || []);
        
        await eventLogRef.set({
            entries: mergedEntries,
            lastSyncedAt: Date.now(),
            lastSyncedBy: getCurrentUserName()
        });
        
        intlEventLogEntries = mergedEntries;
        saveIntlEventLogToStorage();
        renderIntlEventLogEntries();
        
        const now = new Date().toLocaleTimeString('en-AU', { hour: '2-digit', minute: '2-digit', hour12: false });
        if (statusEl) {
            statusEl.innerHTML = ` Synced to Firebase at ${now}. All devices can now see these entries.`;
            statusEl.style.color = '#059669';
        }
        
        console.log(' INTL Event log synced to Firebase:', mergedEntries.length, 'entries');
        
    } catch (error) {
        console.error('Error syncing INTL event log to Firebase:', error);
        if (statusEl) {
            statusEl.innerHTML = '  Sync failed. Please try again.';
            statusEl.style.color = '#dc2626';
        }
    }
}

// Load INTL event log from Firebase
async function loadIntlEventLogFromFirebase() {
    if (!firebaseInitialized) {
        loadIntlEventLogFromStorage();
        renderIntlEventLogEntries();
        return;
    }
    
    try {
        const eventLogRef = firebase.database().ref(getFirebasePath(INTL_EVENT_LOG_FIREBASE_KEY));
        const snapshot = await eventLogRef.once('value');
        const firebaseData = snapshot.val();
        
        loadIntlEventLogFromStorage();
        
        if (firebaseData && firebaseData.entries) {
            intlEventLogEntries = mergeEventLogEntries(intlEventLogEntries, firebaseData.entries);
            saveIntlEventLogToStorage();
            
            const statusEl = document.getElementById('intl-event-log-status');
            if (statusEl && firebaseData.lastSyncedBy) {
                const syncTime = new Date(firebaseData.lastSyncedAt).toLocaleTimeString('en-AU', { hour: '2-digit', minute: '2-digit', hour12: false });
                statusEl.innerHTML = ` Last synced by ${firebaseData.lastSyncedBy} at ${syncTime}`;
                statusEl.style.color = '#6b7280';
            }
        }
        
        renderIntlEventLogEntries();
        console.log(' INTL Event log loaded from Firebase:', intlEventLogEntries.length, 'entries');
        
    } catch (error) {
        console.error('Error loading INTL event log from Firebase:', error);
        loadIntlEventLogFromStorage();
        renderIntlEventLogEntries();
    }
}

// Get INTL event log entries for PDF
function getIntlEventLogForReport() {
    return intlEventLogEntries.map(entry => ({
        time: entry.time,
        user: entry.user,
        category: entry.category ? getCategoryLabel(entry.category) : '',
        categoryKey: entry.category || '',
        description: entry.description,
        important: entry.important || false
    }));
}

// ============================================
// INTERNATIONAL CANCELLATIONS SYSTEM
// ============================================
const INTL_CANCEL_STORAGE_KEY = 'flight_tracker_intl_cancellations';
const INTL_CANCEL_FIREBASE_KEY = 'intl_cancellations';
let intlCancellations = [];

// Load INTL cancellations from localStorage
function loadIntlCancellationsFromStorage() {
    try {
        const stored = localStorage.getItem(INTL_CANCEL_STORAGE_KEY);
        if (stored) {
            const data = JSON.parse(stored);
            const today = new Date().toDateString();
            if (data.date === today) {
                intlCancellations = data.entries || [];
            } else {
                intlCancellations = [];
                localStorage.removeItem(INTL_CANCEL_STORAGE_KEY);
            }
        }
    } catch (e) {
        console.error('Error loading INTL cancellations from storage:', e);
        intlCancellations = [];
    }
}

// Save INTL cancellations to localStorage
function saveIntlCancellationsToStorage() {
    try {
        const data = {
            date: new Date().toDateString(),
            entries: intlCancellations,
            lastSaved: Date.now()
        };
        localStorage.setItem(INTL_CANCEL_STORAGE_KEY, JSON.stringify(data));
    } catch (e) {
        console.error('Error saving INTL cancellations to storage:', e);
    }
}

// Add INTL cancellation
function addIntlCancellation() {
    const newEntry = {
        id: 'intl_cancel_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9),
        flight: '',
        route: '',
        reason: '',
        createdAt: Date.now()
    };
    
    intlCancellations.push(newEntry);
    renderIntlCancellations();
    
    setTimeout(() => {
        const flightInput = document.querySelector(`#intl-cancel-${newEntry.id} .intl-cancel-input.flight`);
        if (flightInput) flightInput.focus();
    }, 100);
}

// Remove INTL cancellation
function removeIntlCancellation(entryId) {
    intlCancellations = intlCancellations.filter(e => e.id !== entryId);
    renderIntlCancellations();
}

// Update INTL cancellation field
function updateIntlCancellation(entryId, field, value) {
    const entry = intlCancellations.find(e => e.id === entryId);
    if (entry) {
        entry[field] = value.toUpperCase();
        entry.updatedAt = Date.now();
        // Immediately update the textarea and stat count
        updateCancelledStatCount();
        // Update dynamic dashboard stats
        if (typeof populateDynamicStats === 'function') populateDynamicStats();
    }
}

// Render INTL cancellations
function renderIntlCancellations() {
    const container = document.getElementById('intl-cancel-entries');
    if (!container) return;
    
    // Update the cancelled stat count in preview
    updateCancelledStatCount();
    if (typeof populateDynamicStats === "function") populateDynamicStats();
    
    // Immediately update the cancelled textarea to show INTL cancellations
    updateCancelledTextarea();
    
    if (intlCancellations.length === 0) {
        container.innerHTML = '<div class="intl-cancel-empty">No international cancellations added. Click " Add Cancellation" to add one.</div>';
        return;
    }
    
    container.innerHTML = intlCancellations.map(entry => {
        return `
            <div class="intl-cancel-entry" id="intl-cancel-${entry.id}">
                <span class="intl-badge">INTL</span>
                <span class="intl-cancel-label">Flight:</span>
                <input type="text" class="intl-cancel-input flight" value="${entry.flight}" placeholder="JQ37"
                    onchange="updateIntlCancellation('${entry.id}', 'flight', this.value)"
                    oninput="updateIntlCancellation('${entry.id}', 'flight', this.value)">
                <span class="intl-cancel-label">Route:</span>
                <input type="text" class="intl-cancel-input route" value="${entry.route}" placeholder="SYD-DPS"
                    onchange="updateIntlCancellation('${entry.id}', 'route', this.value)"
                    oninput="updateIntlCancellation('${entry.id}', 'route', this.value)">
                <span class="intl-cancel-label">Reason:</span>
                <input type="text" class="intl-cancel-input reason" value="${entry.reason}" placeholder="Engineering fault"
                    onchange="updateIntlCancellation('${entry.id}', 'reason', this.value)"
                    oninput="updateIntlCancellation('${entry.id}', 'reason', this.value)">
                <button class="intl-cancel-remove-btn" onclick="removeIntlCancellation('${entry.id}')"></button>
            </div>
        `;
    }).join('');
}

// Update cancelled stat count in preview (DOM + INTL combined)
function updateCancelledStatCount() {
    const statEl = document.getElementById('cancelled-stat-count');
    const cancelledSection = document.getElementById('summary-cancelled-section');
    
    if (statEl && window.currentReportData) {
        const domCancelled = window.currentReportData.cancelledFlights ? window.currentReportData.cancelledFlights.length : 0;
        const intlCancelled = intlCancellations.filter(c => c.flight && c.route).length;
        const totalCancelled = domCancelled + intlCancelled;
        statEl.textContent = totalCancelled;
        
        // Show/hide the cancelled section based on whether there are cancellations
        if (cancelledSection) {
            cancelledSection.style.display = totalCancelled > 0 ? '' : 'none';
        }
    }
    
    // Also update the cancelled flights textarea to include INTL cancellations
    updateCancelledTextarea();
}

// Update the cancelled flights textarea with INTL cancellations
function updateCancelledTextarea() {
    const textarea = document.getElementById('edit-cancelled');
    if (!textarea || !window.currentReportData) return;
    
    const domCancelled = window.currentReportData.cancelledFlights || [];
    const validIntlCancellations = intlCancellations.filter(c => c.flight && c.route);
    
    let text = '';
    
    // Domestic cancellations - use cancelReason from flight card
    if (domCancelled.length > 0) {
        text += domCancelled.map(f => 
            `[DOM] ${f.flightNumber} (${f.destination}) - ${f.cancelReason || 'No reason specified'}`
        ).join('\n');
    }
    
    // International cancellations
    if (validIntlCancellations.length > 0) {
        if (text) text += '\n';
        text += validIntlCancellations.map(c => 
            `[INTL] ${c.flight} (${c.route}) - ${c.reason || 'No reason specified'}`
        ).join('\n');
    }
    
    // No cancellations at all - return empty (section will be hidden)
    if (domCancelled.length === 0 && validIntlCancellations.length === 0) {
        text = '';
    }
    
    textarea.value = text;
}

// Save INTL cancellations (to localStorage)
function saveIntlCancellations() {
    saveIntlCancellationsToStorage();
    
    // Update dynamic dashboard stats immediately
    if (typeof populateDynamicStats === 'function') populateDynamicStats();
    
    const statusEl = document.getElementById('intl-cancel-status');
    if (statusEl) {
        const now = new Date().toLocaleTimeString('en-AU', { hour: '2-digit', minute: '2-digit', hour12: false });
        statusEl.innerHTML = ` Saved locally at ${now}. Click "Sync Cancellations" to share with other devices.`;
        statusEl.style.color = '#059669';
    }
    
    console.log(' INTL Cancellations saved to localStorage:', intlCancellations.length, 'entries');
}

// Sync INTL cancellations to Firebase
async function syncIntlCancellations() {
    if (!firebaseInitialized) {
        alert('Firebase not connected. Please check your connection.');
        return;
    }
    
    const statusEl = document.getElementById('intl-cancel-status');
    if (statusEl) {
        statusEl.innerHTML = ' Syncing to Firebase...';
        statusEl.style.color = '#f59e0b';
    }
    
    try {
        const cancelRef = firebase.database().ref(getFirebasePath(INTL_CANCEL_FIREBASE_KEY));
        const snapshot = await cancelRef.once('value');
        const firebaseData = snapshot.val() || { entries: [] };
        
        // Merge cancellations
        const merged = new Map();
        (firebaseData.entries || []).forEach(entry => {
            if (entry && entry.id) merged.set(entry.id, entry);
        });
        intlCancellations.forEach(entry => {
            if (entry && entry.id) {
                const existing = merged.get(entry.id);
                if (!existing || (entry.updatedAt && entry.updatedAt > (existing.updatedAt || 0))) {
                    merged.set(entry.id, entry);
                }
            }
        });
        const mergedEntries = Array.from(merged.values());
        
        await cancelRef.set({
            entries: mergedEntries,
            lastSyncedAt: Date.now(),
            lastSyncedBy: getCurrentUserName()
        });
        
        intlCancellations = mergedEntries;
        saveIntlCancellationsToStorage();
        renderIntlCancellations();
        
        const now = new Date().toLocaleTimeString('en-AU', { hour: '2-digit', minute: '2-digit', hour12: false });
        if (statusEl) {
            statusEl.innerHTML = ` Synced to Firebase at ${now}. All devices can now see these cancellations.`;
            statusEl.style.color = '#059669';
        }
        
        console.log(' INTL Cancellations synced to Firebase:', mergedEntries.length, 'entries');
        
    } catch (error) {
        console.error('Error syncing INTL cancellations to Firebase:', error);
        if (statusEl) {
            statusEl.innerHTML = ' Sync failed. Please try again.';
            statusEl.style.color = '#dc2626';
        }
    }
}

// Load INTL cancellations from Firebase
async function loadIntlCancellationsFromFirebase() {
    if (!firebaseInitialized) {
        loadIntlCancellationsFromStorage();
        renderIntlCancellations();
        return;
    }
    
    try {
        const cancelRef = firebase.database().ref(getFirebasePath(INTL_CANCEL_FIREBASE_KEY));
        const snapshot = await cancelRef.once('value');
        const firebaseData = snapshot.val();
        
        loadIntlCancellationsFromStorage();
        
        if (firebaseData && firebaseData.entries) {
            const merged = new Map();
            (firebaseData.entries || []).forEach(entry => {
                if (entry && entry.id) merged.set(entry.id, entry);
            });
            intlCancellations.forEach(entry => {
                if (entry && entry.id) {
                    const existing = merged.get(entry.id);
                    if (!existing || (entry.updatedAt && entry.updatedAt > (existing.updatedAt || 0))) {
                        merged.set(entry.id, entry);
                    }
                }
            });
            intlCancellations = Array.from(merged.values());
            saveIntlCancellationsToStorage();
            
            const statusEl = document.getElementById('intl-cancel-status');
            if (statusEl && firebaseData.lastSyncedBy) {
                const syncTime = new Date(firebaseData.lastSyncedAt).toLocaleTimeString('en-AU', { hour: '2-digit', minute: '2-digit', hour12: false });
                statusEl.innerHTML = ` Last synced by ${firebaseData.lastSyncedBy} at ${syncTime}`;
                statusEl.style.color = '#6b7280';
            }
        }
        
        renderIntlCancellations();
        console.log(' INTL Cancellations loaded from Firebase:', intlCancellations.length, 'entries');
        
    } catch (error) {
        console.error('Error loading INTL cancellations from Firebase:', error);
        loadIntlCancellationsFromStorage();
        renderIntlCancellations();
    }
}

// Get INTL cancellations for report
function getIntlCancellationsForReport() {
    return intlCancellations.filter(c => c.flight && c.route).map(entry => ({
        flight: entry.flight,
        route: entry.route,
        reason: entry.reason || 'No reason specified'
    }));
}

function populateFirebaseUsageStats() {
    const container = document.getElementById('firebase-usage-info');
    if (!container) return;
    
    const usage = getFirebaseUsageForReport();
    
    // Calculate percentages
    const dailyReadPercent = Math.min((usage.dailyReads / usage.dailyReadLimit) * 100, 100);
    const dailyWritePercent = Math.min((usage.dailyWrites / usage.dailyWriteLimit) * 100, 100);
    
    // Estimate monthly usage (multiply daily by days so far + project rest of month)
    const today = new Date();
    const daysInMonth = new Date(today.getFullYear(), today.getMonth() + 1, 0).getDate();
    const dayOfMonth = today.getDate();
    const avgDailyReads = usage.dailyReads;
    const avgDailyWrites = usage.dailyWrites;
    const projectedMonthlyReads = avgDailyReads * daysInMonth;
    const projectedMonthlyWrites = avgDailyWrites * daysInMonth;
    
    const monthlyReadPercent = Math.min((projectedMonthlyReads / usage.monthlyReadLimit) * 100, 100);
    const monthlyWritePercent = Math.min((projectedMonthlyWrites / usage.monthlyWriteLimit) * 100, 100);
    
    // Determine status classes
    const getStatusClass = (percent) => {
        if (percent >= 80) return 'danger';
        if (percent >= 50) return 'warning';
        return '';
    };
    
    // Centralized indicator
    const centralizedBadge = usage.isCentralized 
        ? '<span class="firebase-centralized-badge"> All Devices Combined</span>'
        : '<span class="firebase-local-badge"> This Device Only</span>';
    
    container.innerHTML = `
        <div class="firebase-usage-title">
            <span></span>
            <span>Firebase Usage (For Your Eyes Only - Not in Report)</span>
            ${centralizedBadge}
        </div>
        <div class="firebase-usage-grid">
            <div class="firebase-usage-item">
                <div class="firebase-usage-label">Daily Reads (All Devices)</div>
                <div class="firebase-usage-value ${getStatusClass(dailyReadPercent)}">${usage.dailyReads.toLocaleString()} / ${usage.dailyReadLimit.toLocaleString()}</div>
                <div class="firebase-usage-bar">
                    <div class="firebase-usage-bar-fill ${getStatusClass(dailyReadPercent)}" style="width: ${dailyReadPercent}%"></div>
                </div>
            </div>
            <div class="firebase-usage-item">
                <div class="firebase-usage-label">Daily Writes (All Devices)</div>
                <div class="firebase-usage-value ${getStatusClass(dailyWritePercent)}">${usage.dailyWrites.toLocaleString()} / ${usage.dailyWriteLimit.toLocaleString()}</div>
                <div class="firebase-usage-bar">
                    <div class="firebase-usage-bar-fill ${getStatusClass(dailyWritePercent)}" style="width: ${dailyWritePercent}%"></div>
                </div>
            </div>
            <div class="firebase-usage-item">
                <div class="firebase-usage-label">Projected Monthly Reads</div>
                <div class="firebase-usage-value ${getStatusClass(monthlyReadPercent)}">${projectedMonthlyReads.toLocaleString()} / ${(usage.monthlyReadLimit / 1000000).toFixed(1)}M</div>
                <div class="firebase-usage-bar">
                    <div class="firebase-usage-bar-fill ${getStatusClass(monthlyReadPercent)}" style="width: ${monthlyReadPercent}%"></div>
                </div>
            </div>
            <div class="firebase-usage-item">
                <div class="firebase-usage-label">Projected Monthly Writes</div>
                <div class="firebase-usage-value ${getStatusClass(monthlyWritePercent)}">${projectedMonthlyWrites.toLocaleString()} / ${(usage.monthlyWriteLimit / 1000).toFixed(0)}K</div>
                <div class="firebase-usage-bar">
                    <div class="firebase-usage-bar-fill ${getStatusClass(monthlyWritePercent)}" style="width: ${monthlyWritePercent}%"></div>
                </div>
            </div>
        </div>
        <div class="firebase-active-devices">
             Active Devices Today: <strong>${usage.activeDevices || 1}</strong>
        </div>
        <div class="firebase-usage-note">
             Usage combines all operations across all 15 iPads (cancellations, comments, status changes, etc.)
            <br>Green = OK | Yellow = Monitor (50-80%) | Red = Near Limit (>80%)
        </div>
    `;
}

// Replace old generateFinalReport and generateEditedReportHTML with these functions

function generateFinalReport() {
    const data = window.currentReportData;
    if (!data) {
        alert('Error: Report data not found');
        return;
    }
    
    const editedCancelled = document.getElementById('edit-cancelled')?.value || '';
    const editedExtended = document.getElementById('edit-extended')?.value || '';
    const editedComments = document.getElementById('edit-comments')?.value || '';
    const editedSecurity = document.getElementById('edit-security')?.value || '';
    const editedHandover = document.getElementById('edit-handover')?.value || '';
    const eventLogData = getEventLogForReport();
    const intlEventLogData = getIntlEventLogForReport();
    const intlCancellationsData = getIntlCancellationsForReport();
    
    const reportHTML = generateNewPDFReportHTML(data, {
        cancelled: editedCancelled,
        extended: editedExtended,
        comments: editedComments,
        security: editedSecurity,
        handover: editedHandover,
        eventLog: eventLogData,
        intlEventLog: intlEventLogData,
        intlCancellations: intlCancellationsData
    });
    
    closeSummaryReportEditor();
    printReportWithFilename(reportHTML);
}

function printReportWithFilename(htmlContent) {
    // Use flight date if available, otherwise today
    const reportDate = flightDate || new Date();
    const dateStr = `${reportDate.getDate().toString().padStart(2,'0')}-${(reportDate.getMonth()+1).toString().padStart(2,'0')}-${reportDate.getFullYear()}`;
    const filename = `TAM Handover Notes ${dateStr}`;
    
    // Open content in a new window for printing/saving as PDF
    const printWindow = window.open('', '_blank', 'width=900,height=800');
    
    if (printWindow) {
        printWindow.document.write(htmlContent);
        printWindow.document.close();
        
        // Set document title for filename suggestion
        printWindow.document.title = filename;
        
        // Wait for content to load, then auto-open print dialog
        printWindow.onload = function() {
            setTimeout(function() {
                printWindow.focus();
                printWindow.print();
            }, 500);
        };
    } else {
        alert('Pop-up blocked! Please allow pop-ups for this site and try again.');
    }
}


// ============================================
// PERFORMANCE & STAFFING PDF GENERATION
// ============================================

// Generate Performance & Staffing HTML for PDF
function generatePerformanceStaffingHTML() {
    const perfData = getPerformanceDataForReport();
    const targets = perfData.targets;
    
    // Check if any data exists
    if (perfData.ffDomestic === null && perfData.ffIntl === null && perfData.totalSick === null) {
        return ''; // Don't show section if no data
    }
    
    let boxesHTML = '';
    
    // FF @ 0 Domestic
    if (perfData.ffDomestic !== null) {
        const val = perfData.ffDomestic;
        const diff = val - targets.domestic;
        const isGood = val >= targets.domestic;
        const bgColor = isGood ? '#dcfce7' : '#fee2e2';
        const borderColor = isGood ? '#22c55e' : '#dc2626';
        const textColor = isGood ? '#166534' : '#dc2626';
        const arrow = diff === 0 ? 'On Target' : (diff > 0 ? ' +' + diff + '%' : ' ' + diff + '%');
        
        boxesHTML += '<div style="background:' + bgColor + '; border-left:4px solid ' + borderColor + '; padding:10px 15px; border-radius:4px; text-align:center; min-width:110px;">' +
            '<div style="font-size:8px; color:' + textColor + '; font-weight:600;">FF @ 0 DOMESTIC</div>' +
            '<div style="font-size:18px; font-weight:bold; color:' + textColor + ';">' + val + '%</div>' +
            '<div style="font-size:7px; color:#6b7280; margin-top:3px;">Target: 63%</div>' +
            '<div style="font-size:8px; color:' + textColor + '; font-weight:600; margin-top:2px;">' + arrow + '</div>' +
            '</div>';
    }
    
    // FF @ 0 International
    if (perfData.ffIntl !== null) {
        const val = perfData.ffIntl;
        const diff = val - targets.intl;
        const isGood = val >= targets.intl;
        const bgColor = isGood ? '#dcfce7' : '#fee2e2';
        const borderColor = isGood ? '#22c55e' : '#dc2626';
        const textColor = isGood ? '#166534' : '#dc2626';
        const arrow = diff === 0 ? 'On Target' : (diff > 0 ? ' +' + diff + '%' : ' ' + diff + '%');
        
        boxesHTML += '<div style="background:' + bgColor + '; border-left:4px solid ' + borderColor + '; padding:10px 15px; border-radius:4px; text-align:center; min-width:110px;">' +
            '<div style="font-size:8px; color:' + textColor + '; font-weight:600;">FF @ 0 INTL</div>' +
            '<div style="font-size:18px; font-weight:bold; color:' + textColor + ';">' + val + '%</div>' +
            '<div style="font-size:7px; color:#6b7280; margin-top:3px;">Target: 31%</div>' +
            '<div style="font-size:8px; color:' + textColor + '; font-weight:600; margin-top:2px;">' + arrow + '</div>' +
            '</div>';
    }
    
    // Total Sick
    if (perfData.totalSick !== null) {
        boxesHTML += '<div style="background:#f3f4f6; border-left:4px solid #6b7280; padding:10px 15px; border-radius:4px; text-align:center; min-width:110px;">' +
            '<div style="font-size:8px; color:#374151; font-weight:600;">TOTAL SICK</div>' +
            '<div style="font-size:18px; font-weight:bold; color:#374151;">' + perfData.totalSick + '</div>' +
            '<div style="font-size:7px; color:#6b7280; margin-top:3px;">Staff members</div>' +
            '</div>';
    }
    
    if (!boxesHTML) return '';
    
    return '<div class="section">' +
        '<div class="section-title"> PERFORMANCE & STAFFING</div>' +
        '<div style="display:flex; gap:25px; padding:10px 15px; flex-wrap:wrap; justify-content:center;">' + boxesHTML + '</div>' +
        '</div>';
}

// ============================================
// DYNAMIC DASHBOARD STATISTICS FUNCTIONS
// ============================================

// Generate dynamic stats HTML for both Summary Editor and PDF
function generateDynamicStatsHTML(data, editedContent, intlCancelCount) {
    let statsHTML = '';
    
    // 1. Completed Flights (green) - only if > 0
    const completedCount = data.closedFlights ? data.closedFlights.length : 0;
    if (completedCount > 0) {
        statsHTML += '<div class="stat-box"><div class="stat-number green">' + completedCount + '</div><div class="stat-label">Completed</div></div>';
    }
    
    // 2. Cancelled Flights (red) - combined DOM + INTL, only if > 0
    const domCancelCount = data.cancelledFlights ? data.cancelledFlights.length : 0;
    const totalCancelled = domCancelCount + (intlCancelCount || 0);
    if (totalCancelled > 0) {
        statsHTML += '<div class="stat-box"><div class="stat-number red">' + totalCancelled + '</div><div class="stat-label">Cancelled</div></div>';
    }
    
    // 3. Combine category counts from Domestic + International event logs
    const categoryCounts = {};
    const categoryLabels = {
        'medical': 'Medical',
        'afp': 'AFP Required',
        'injury': 'Staff Injury',
        'escalation': 'Escalation',
        'damp': 'DAMP Test',
        'security': 'Security',
        'safety': 'Safety',
        'sop': 'SOP Breach',
        'general': 'General Notes',
        'infrastructure': 'Airport Infrastructure',
        'weather': 'Weather',
        'stakeholders': 'Stakeholders',
        'pax_injury': 'Pax Injury',
        'it_issues': 'IT Issues',
        'checkin_issues': 'Check-In Issues',
        'concourse_issues': 'Concourse Issues',
        'downgrades': 'Downgrades',
        'upgrades': 'Upgrades',
        'flight_capped': 'Flight Capped',
        'operational_req': 'Operational Requirements',
        'crewing': 'Crewing',
        'cjo_issues': 'CJO Issues',
        'stock': 'Stock'
    };
    
    // Count from Domestic event log
    if (editedContent.eventLog && editedContent.eventLog.length > 0) {
        editedContent.eventLog.forEach(entry => {
            const cat = entry.categoryKey || entry.category;
            if (cat && cat !== '') {
                categoryCounts[cat] = (categoryCounts[cat] || 0) + 1;
            }
        });
    }
    
    // Count from International event log
    if (editedContent.intlEventLog && editedContent.intlEventLog.length > 0) {
        editedContent.intlEventLog.forEach(entry => {
            const cat = entry.categoryKey || entry.category;
            if (cat && cat !== '') {
                categoryCounts[cat] = (categoryCounts[cat] || 0) + 1;
            }
        });
    }
    
    // Sort categories by count (descending) and add to stats
    const sortedCategories = Object.entries(categoryCounts)
        .filter(([cat, count]) => count > 0)
        .sort((a, b) => b[1] - a[1]);
    
    sortedCategories.forEach(([cat, count]) => {
        const label = categoryLabels[cat] || cat;
        statsHTML += '<div class="stat-box"><div class="stat-number">' + count + '</div><div class="stat-label">' + label + '</div></div>';
    });
    
    // If nothing to show, return a message
    if (statsHTML === '') {
        statsHTML = '<div class="stat-box"><div class="stat-number">0</div><div class="stat-label">No Data</div></div>';
    }
    
    return statsHTML;
}

// Populate dynamic stats in Summary Report Editor
function populateDynamicStats() {
    const statsContainer = document.getElementById('summary-editor-dynamic-stats');
    if (!statsContainer) return;
    
    const data = window.currentReportData;
    if (!data) return;
    
    // Get current event log data
    const eventLogData = getEventLogForReport();
    const intlEventLogData = getIntlEventLogForReport();
    const intlCancellationsData = getIntlCancellationsForReport();
    const intlCancelCount = intlCancellationsData ? intlCancellationsData.length : 0;
    
    const editedContent = {
        eventLog: eventLogData,
        intlEventLog: intlEventLogData
    };
    
    // Generate the stats HTML
    let statsHTML = '';
    
    // 1. Completed Flights (green) - only if > 0
    const completedCount = data.closedFlights ? data.closedFlights.length : 0;
    if (completedCount > 0) {
        statsHTML += '<div class="summary-stat-box"><div class="summary-stat-number green">' + completedCount + '</div><div class="summary-stat-label">Completed</div></div>';
    }
    
    // 2. Cancelled Flights (red) - combined DOM + INTL, only if > 0
    const domCancelCount = data.cancelledFlights ? data.cancelledFlights.length : 0;
    const totalCancelled = domCancelCount + intlCancelCount;
    if (totalCancelled > 0) {
        statsHTML += '<div class="summary-stat-box"><div class="summary-stat-number red">' + totalCancelled + '</div><div class="summary-stat-label">Cancelled</div></div>';
    }
    
    // 3. Combine category counts from Domestic + International event logs
    const categoryCounts = {};
    const categoryLabels = {
        'medical': 'Medical',
        'afp': 'AFP Required',
        'injury': 'Staff Injury',
        'escalation': 'Escalation',
        'damp': 'DAMP Test',
        'security': 'Security',
        'safety': 'Safety',
        'sop': 'SOP Breach',
        'general': 'General Notes',
        'infrastructure': 'Airport Infrastructure',
        'weather': 'Weather',
        'stakeholders': 'Stakeholders',
        'pax_injury': 'Pax Injury',
        'it_issues': 'IT Issues',
        'checkin_issues': 'Check-In Issues',
        'concourse_issues': 'Concourse Issues',
        'downgrades': 'Downgrades',
        'upgrades': 'Upgrades',
        'flight_capped': 'Flight Capped',
        'operational_req': 'Operational Requirements',
        'crewing': 'Crewing',
        'cjo_issues': 'CJO Issues',
        'stock': 'Stock'
    };
    
    // Count from Domestic event log
    if (eventLogData && eventLogData.length > 0) {
        eventLogData.forEach(entry => {
            const cat = entry.categoryKey || entry.category;
            if (cat && cat !== '') {
                categoryCounts[cat] = (categoryCounts[cat] || 0) + 1;
            }
        });
    }
    
    // Count from International event log
    if (intlEventLogData && intlEventLogData.length > 0) {
        intlEventLogData.forEach(entry => {
            const cat = entry.categoryKey || entry.category;
            if (cat && cat !== '') {
                categoryCounts[cat] = (categoryCounts[cat] || 0) + 1;
            }
        });
    }
    
    // Sort categories by count (descending) and add to stats
    const sortedCategories = Object.entries(categoryCounts)
        .filter(([cat, count]) => count > 0)
        .sort((a, b) => b[1] - a[1]);
    
    sortedCategories.forEach(([cat, count]) => {
        const label = categoryLabels[cat] || cat;
        statsHTML += '<div class="summary-stat-box"><div class="summary-stat-number">' + count + '</div><div class="summary-stat-label">' + label + '</div></div>';
    });
    
    // If nothing to show, display a message
    if (statsHTML === '') {
        statsHTML = '<div class="summary-stat-box"><div class="summary-stat-number">0</div><div class="summary-stat-label">No Data</div></div>';
    }
    
    statsContainer.innerHTML = statsHTML;
}

// ============================================
// PERFORMANCE & STAFFING FUNCTIONS
// ============================================

const PERFORMANCE_FIREBASE_KEY = 'performance_staffing';
let performanceData = {
    ffDomestic: null,
    ffIntl: null,
    totalSick: null,
    lastUpdated: null,
    updatedBy: null
};

// Update performance box display based on input
function updatePerformanceBox(type) {
    const targets = { domestic: 63, intl: 31 };
    
    if (type === 'domestic') {
        const input = document.getElementById('perf-ff-domestic');
        const box = document.getElementById('perf-box-domestic');
        const diffBadge = document.getElementById('perf-diff-domestic');
        const value = parseFloat(input.value);
        
        performanceData.ffDomestic = isNaN(value) ? null : value;
        
        if (!isNaN(value)) {
            const diff = value - targets.domestic;
            box.className = 'perf-box ' + (value >= targets.domestic ? 'good' : 'bad');
            input.style.color = value >= targets.domestic ? '#059669' : '#dc2626';
            
            if (diff === 0) {
                diffBadge.className = 'perf-diff-badge on-target';
                diffBadge.innerHTML = 'On Target';
            } else if (diff > 0) {
                diffBadge.className = 'perf-diff-badge good';
                diffBadge.innerHTML = '<span class="perf-arrow-up"></span> +' + diff + '%';
            } else {
                diffBadge.className = 'perf-diff-badge bad';
                diffBadge.innerHTML = '<span class="perf-arrow-down"></span> ' + diff + '%';
            }
        } else {
            box.className = 'perf-box neutral';
            input.style.color = '#374151';
            diffBadge.className = 'perf-diff-badge';
            diffBadge.innerHTML = '--';
        }
    } else if (type === 'intl') {
        const input = document.getElementById('perf-ff-intl');
        const box = document.getElementById('perf-box-intl');
        const diffBadge = document.getElementById('perf-diff-intl');
        const value = parseFloat(input.value);
        
        performanceData.ffIntl = isNaN(value) ? null : value;
        
        if (!isNaN(value)) {
            const diff = value - targets.intl;
            box.className = 'perf-box ' + (value >= targets.intl ? 'good' : 'bad');
            input.style.color = value >= targets.intl ? '#059669' : '#dc2626';
            
            if (diff === 0) {
                diffBadge.className = 'perf-diff-badge on-target';
                diffBadge.innerHTML = 'On Target';
            } else if (diff > 0) {
                diffBadge.className = 'perf-diff-badge good';
                diffBadge.innerHTML = '<span class="perf-arrow-up"></span> +' + diff + '%';
            } else {
                diffBadge.className = 'perf-diff-badge bad';
                diffBadge.innerHTML = '<span class="perf-arrow-down"></span> ' + diff + '%';
            }
        } else {
            box.className = 'perf-box neutral';
            input.style.color = '#374151';
            diffBadge.className = 'perf-diff-badge';
            diffBadge.innerHTML = '--';
        }
    } else if (type === 'sick') {
        const input = document.getElementById('perf-sick');
        const value = parseInt(input.value);
        performanceData.totalSick = isNaN(value) ? null : value;
    }
    
    // Auto-save to Firebase after a short delay
    clearTimeout(window.perfSaveTimeout);
    window.perfSaveTimeout = setTimeout(() => {
        savePerformanceToFirebase();
    }, 1000);
}

// Save performance data to Firebase
function savePerformanceToFirebase() {
    if (!window.firebaseDatabase) {
        console.log('Firebase not available for performance save');
        return;
    }
    
    const today = getLocalDateKey();
    performanceData.lastUpdated = Date.now();
    performanceData.updatedBy = currentUser?.name || 'Unknown';
    
    try {
        window.firebaseDatabase.ref(PERFORMANCE_FIREBASE_KEY + '/' + today).set(performanceData);
        console.log(' Performance data saved to Firebase');
    } catch (e) {
        console.error('Error saving performance data:', e);
    }
}

// Load performance data from Firebase
function loadPerformanceFromFirebase() {
    if (!window.firebaseDatabase) {
        console.log('Firebase not available for performance load');
        return;
    }
    
    const today = getLocalDateKey();
    
    try {
        window.firebaseDatabase.ref(PERFORMANCE_FIREBASE_KEY + '/' + today).once('value', (snapshot) => {
            const data = snapshot.val();
            if (data) {
                performanceData = data;
                
                // Populate inputs
                if (data.ffDomestic !== null) {
                    document.getElementById('perf-ff-domestic').value = data.ffDomestic;
                    updatePerformanceBox('domestic');
                }
                if (data.ffIntl !== null) {
                    document.getElementById('perf-ff-intl').value = data.ffIntl;
                    updatePerformanceBox('intl');
                }
                if (data.totalSick !== null) {
                    document.getElementById('perf-sick').value = data.totalSick;
                    updatePerformanceBox('sick');
                }
                
                console.log(' Performance data loaded from Firebase');
            }
        });
    } catch (e) {
        console.error('Error loading performance data:', e);
    }
}

// Get performance data for PDF report
function getPerformanceDataForReport() {
    return {
        ffDomestic: performanceData.ffDomestic,
        ffIntl: performanceData.ffIntl,
        totalSick: performanceData.totalSick,
        targets: { domestic: 63, intl: 31 }
    };
}

// ============================================
// IMPORTANT EVENT MARKER FUNCTIONS
// ============================================

// Toggle important status for domestic event
function toggleEventImportant(entryId) {
    const entry = eventLogEntries.find(e => e.id === entryId);
    if (entry) {
        entry.important = !entry.important;
        entry.updatedAt = Date.now();
        renderEventLogEntries();
        if (typeof populateDynamicStats === 'function') populateDynamicStats();
    }
}

// Toggle important status for international event
function toggleIntlEventImportant(entryId) {
    const entry = intlEventLogEntries.find(e => e.id === entryId);
    if (entry) {
        entry.important = !entry.important;
        entry.updatedAt = Date.now();
        renderIntlEventLogEntries();
        if (typeof populateDynamicStats === 'function') populateDynamicStats();
    }
}

// Clear All Event Log Entries with confirmation
function clearAllEventLogEntries(type) {
    let message = '';
    let confirmCallback = null;
    
    if (type === 'domestic') {
        message = 'Are you sure you want to clear ALL Domestic Event Log entries?\n\nThis cannot be undone.';
        confirmCallback = function() {
            eventLogEntries = [];
            saveEventLogToStorage();
            renderEventLogEntries();
            populateDynamicStats();
            const statusEl = document.getElementById('event-log-status');
            if (statusEl) {
                statusEl.innerHTML = 'All entries cleared.';
                statusEl.style.color = '#dc2626';
            }
        };
    } else if (type === 'international') {
        message = 'Are you sure you want to clear ALL International Event Log entries?\n\nThis cannot be undone.';
        confirmCallback = function() {
            intlEventLogEntries = [];
            saveIntlEventLogToStorage();
            renderIntlEventLogEntries();
            populateDynamicStats();
            const statusEl = document.getElementById('intl-event-log-status');
            if (statusEl) {
                statusEl.innerHTML = 'All entries cleared.';
                statusEl.style.color = '#dc2626';
            }
        };
    } else if (type === 'intl-cancellations') {
        message = 'Are you sure you want to clear ALL International Cancellation entries?\n\nThis cannot be undone.';
        confirmCallback = function() {
            intlCancellations = [];
            saveIntlCancellationsToStorage();
            renderIntlCancellations();
            populateDynamicStats();
            const statusEl = document.getElementById('intl-cancel-status');
            if (statusEl) {
                statusEl.innerHTML = 'All cancellations cleared.';
                statusEl.style.color = '#dc2626';
            }
        };
    }
    
    if (confirm(message)) {
        confirmCallback();
    }
}

function generateNewPDFReportHTML(data, editedContent) {
    const dateStr = data.reportDate.toLocaleDateString('en-AU', {weekday:'long',year:'numeric',month:'long',day:'numeric'});
    const timeStr = data.generatedAt.toLocaleTimeString('en-AU', {hour:'2-digit',minute:'2-digit',hour12:false});
    const today = new Date();
    const year = today.getFullYear();
    
    // Format all sections - cancelled flights with styled badges
    const cancelledHTML = (!editedContent.cancelled || editedContent.cancelled.trim() === '') 
        ? ''
        : `<div class="compact-list">${editedContent.cancelled.split('\n').filter(l=>l.trim()).map(l => {
            // Style [DOM] and [INTL] badges
            let styled = l.replace(/^\[DOM\]/, '<span class="dom-type-badge">DOM</span>');
            styled = styled.replace(/^\[INTL\]/, '<span class="intl-type-badge">INTL</span>');
            return `<div class="list-item">${styled}</div>`;
        }).join('')}</div>`;
    
    const extendedHTML = editedContent.extended.includes('No flights required') || !editedContent.extended.trim()
        ? ''
        : `<div class="compact-list">${editedContent.extended.split('\n').filter(l=>l.trim()).map(l=>`<div class="list-item"> ${l}</div>`).join('')}</div>`;
    
    const commentsHTML = editedContent.comments.includes('No comments were logged') || !editedContent.comments.trim()
        ? ''
        : `<div class="compact-list">${editedContent.comments.split('\n').filter(l=>l.trim()).map(l=>`<div class="list-item">${l}</div>`).join('')}</div>`;
    
    const securityHTML = editedContent.security.includes('No security alerts') || !editedContent.security.trim()
        ? ''
        : `<div class="compact-list">${editedContent.security.split('\n').filter(l=>l.trim()).map(l=>`<div class="alert-item"> ${l}</div>`).join('')}</div>`;
    
    // Leadership - Option C
    const allLeaders = getAllLeadersForReport();
    const leadershipHTML = allLeaders.length > 0 ? `
        <div class="section">
            <div class="section-title"> LEADERSHIP TEAM ON SHIFT</div>
            <table class="data-table"><tr><th>Position</th><th>Name</th></tr>
            ${allLeaders.map(l=>`<tr><td>${l.position}</td><td style="font-weight:600;color:#000345;">${l.name}</td></tr>`).join('')}
            </table>
        </div>` : '';
    
    // Handover
    let handoverTimestamp = '';
    if (handoverData.lastSavedAt) {
        const t = new Date(handoverData.lastSavedAt);
        handoverTimestamp = `<div class="handover-meta">Saved by ${handoverData.lastSavedBy} at ${t.toLocaleString('en-AU',{hour:'2-digit',minute:'2-digit',hour12:false,day:'numeric',month:'short'})}</div>`;
    }
    const handoverHTML = editedContent.handover?.trim() ? `
        <div class="section"><div class="section-title green"> TAM HANDOVER NOTES</div>
        <div class="handover-box">${editedContent.handover.split('\n').map(l=>`<p>${l}</p>`).join('')}</div>
        ${handoverTimestamp}</div>` : '';
    
    // Busyness graphs
    const busynessHTML = generatePDFBusynessGraphsNew(data.busynessData);
    
    // Firebase usage
    const usage = getFirebaseUsageForReport();
    const firebaseHTML = `
        <div class="section"><div class="section-title"> FIREBASE USAGE (ALL DEVICES)</div>
        <div class="firebase-stats">
            <span>Reads: <strong>${usage.dailyReads.toLocaleString()}</strong></span> | 
            <span>Writes: <strong>${usage.dailyWrites.toLocaleString()}</strong></span> | 
            <span>Active Devices: <strong>${usage.activeDevices}</strong></span>
        </div></div>`;

    // Generate category summary for PDF
    function generatePDFCategorySummary(entries) {
        const counts = {};
        entries.forEach(entry => {
            const cat = entry.categoryKey || entry.category;
            if (cat) {
                counts[cat] = (counts[cat] || 0) + 1;
            }
        });
        
        const items = Object.entries(counts)
            .filter(([cat, count]) => count >= 1)
            .sort((a, b) => b[1] - a[1])
            .map(([cat, count]) => `${getCategoryLabel(cat)}: ${count}`)
            .join(' | ');
        
        return items ? `<div class="pdf-category-summary"> Summary: ${items}</div>` : '';
    }

    // Event Log (Domestic)
    let eventLogHTML = '';
    if (editedContent.eventLog && editedContent.eventLog.length > 0) {
        const eventRows = editedContent.eventLog.map(e => {
            const categoryText = e.category || '-';
            const importantBadge = e.important ? '<span style="background:#fef3c7;color:#92400e;padding:2px 6px;border-radius:8px;font-size:9px;font-weight:bold;margin-left:4px;"></span>' : '';
            const rowStyle = e.important ? 'background:#fffbeb;' : '';
            const firstTdStyle = e.important ? 'border-left:3px solid #f59e0b;background:#fffbeb;' : '';
            return `<tr style="${rowStyle}">
                <td class="time-col" style="${firstTdStyle}">${e.time}</td>
                <td class="user-col">${e.user}</td>
                <td class="category-col">${categoryText}${importantBadge}</td>
                <td>${e.description || '<em style="color:#9ca3af;">No description</em>'}</td>
            </tr>`;
        }).join('');
        
        eventLogHTML = `
        <div class="section">
            <div class="section-title"> EVENT LOG (DOMESTIC)</div>
            <table class="event-log-table">
                <tr><th class="time-col">Time</th><th class="user-col">User</th><th class="category-col">Category</th><th>Description</th></tr>
                ${eventRows}
            </table>
        </div>`;
    }

    // International Event Log
    let intlEventLogHTML = '';
    if (editedContent.intlEventLog && editedContent.intlEventLog.length > 0) {
        const eventRows = editedContent.intlEventLog.map(e => {
            const categoryText = e.category || '-';
            const importantBadge = e.important ? '<span style="background:#fef3c7;color:#92400e;padding:2px 6px;border-radius:8px;font-size:9px;font-weight:bold;margin-left:4px;"></span>' : '';
            const rowStyle = e.important ? 'background:#fffbeb;' : '';
            const firstTdStyle = e.important ? 'border-left:3px solid #f59e0b;background:#fffbeb;' : '';
            return `<tr style="${rowStyle}">
                <td class="time-col" style="${firstTdStyle}">${e.time}</td>
                <td class="user-col">${e.user}</td>
                <td class="category-col">${categoryText}${importantBadge}</td>
                <td>${e.description || '<em style="color:#9ca3af;">No description</em>'}</td>
            </tr>`;
        }).join('');
        
        intlEventLogHTML = `
        <div class="section">
            <div class="section-title intl-section-title"> EVENT LOG (INTERNATIONAL)</div>
            <table class="event-log-table">
                <tr><th class="time-col">Time</th><th class="user-col">User</th><th class="category-col">Category</th><th>Description</th></tr>
                ${eventRows}
            </table>
        </div>`;
    }

    // International Cancellations count for stats (already included in textarea)
    const intlCancelCount = editedContent.intlCancellations ? editedContent.intlCancellations.length : 0;

    return `<!DOCTYPE html><html><head><meta charset="UTF-8">
<title>TAM Handover Notes_${today.getDate().toString().padStart(2,'0')}-${(today.getMonth()+1).toString().padStart(2,'0')}-${today.getFullYear()}</title>
<style>
@page { size: A4; margin: 8mm 10mm 10mm 10mm; }
@media print {
    body { -webkit-print-color-adjust: exact; print-color-adjust: exact; }
    .section { page-break-inside: avoid; }
    .page-footer { position: fixed; bottom: 0; left: 0; right: 0; }
}
* { margin: 0; padding: 0; box-sizing: border-box; }
body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Arial, sans-serif; font-size: 10px; line-height: 1.4; color: #1f2937; background: white; }
.report-container { max-width: 210mm; margin: 0 auto; padding: 3mm; }
.report-header { background: linear-gradient(135deg, #000345 0%, #1a1a5e 100%); color: white; padding: 12px 15px; margin-bottom: 12px; display: flex; justify-content: space-between; align-items: center; border-radius: 4px; }
.header-logo { font-size: 14px; font-weight: bold; }
.header-logo .accent { color: #FA5115; }
.header-title { text-align: right; }
.header-title h1 { font-size: 14px; margin-bottom: 2px; }
.header-title p { font-size: 9px; opacity: 0.9; }
.section { margin-bottom: 10px; page-break-inside: avoid; }
.section-title { background: #000345; color: white; padding: 6px 10px; font-size: 10px; font-weight: bold; margin-bottom: 6px; border-radius: 3px; }
.section-title.green { background: #059669; }
.section-title.red { background: #dc2626; }
.section-title.orange { background: #FA5115; }
.stats-grid { display: flex; flex-wrap: wrap; justify-content: center; gap: 12px; padding: 10px 15px; margin-bottom: 10px; }
.stat-box { border: 1px solid #e5e7eb; padding: 8px; text-align: center; background: #f9fafb; border-radius: 4px; min-width: 120px; }
.stat-number { font-size: 20px; font-weight: bold; color: #000345; }
.stat-number.green { color: #059669; }
.stat-number.orange { color: #FA5115; }
.stat-number.red { color: #dc2626; }
.stat-label { font-size: 8px; color: #6b7280; text-transform: uppercase; }
.data-table { width: 100%; border-collapse: collapse; font-size: 9px; }
.data-table th { background: #f3f4f6; padding: 6px 8px; text-align: left; border: 1px solid #e5e7eb; }
.data-table td { padding: 6px 8px; border: 1px solid #e5e7eb; }
.compact-list { font-size: 9px; }
.list-item { padding: 4px 0; border-bottom: 1px solid #f3f4f6; }
.list-item:last-child { border-bottom: none; }
.alert-item { padding: 5px 8px; background: #fef2f2; border-left: 3px solid #dc2626; margin-bottom: 4px; font-size: 9px; }
.no-data { color: #9ca3af; font-style: italic; padding: 8px; text-align: center; font-size: 9px; }
.handover-box { background: #ecfdf5; border-left: 4px solid #059669; padding: 10px; font-size: 10px; }
.handover-box p { margin-bottom: 4px; }
.handover-date-label { font-size: 9px; color: #059669; margin-bottom: 6px; font-weight: 600; }
.handover-meta { font-size: 8px; color: #6b7280; margin-top: 6px; font-style: italic; }
.busyness-graph-container { margin-bottom: 12px; }
.busyness-graph-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 4px; }
.busyness-graph-title { font-weight: 600; font-size: 10px; color: #000345; }
.busyness-graph-status { font-size: 8px; padding: 2px 8px; border-radius: 10px; }
.busyness-ai-summary { background: #f0f9ff; border-left: 3px solid #0284c7; padding: 6px 10px; margin-top: 6px; font-size: 9px; color: #0c4a6e; line-height: 1.4; }
.busyness-legend { display: flex; justify-content: center; gap: 12px; margin-top: 8px; padding: 6px; background: #f8fafc; border-radius: 4px; flex-wrap: wrap; }
.legend-item { display: flex; align-items: center; gap: 4px; font-size: 8px; }
.legend-dot { width: 10px; height: 10px; border-radius: 3px; }
.firebase-stats { font-size: 9px; padding: 8px; background: #f8fafc; border: 1px solid #000345; border-radius: 4px; }
.firebase-stats strong { color: #000345; }
.event-log-table { width: 100%; border-collapse: collapse; font-size: 9px; line-height: 1.6; margin-top: 6px; }
.event-log-table th { background: #f8fafc; padding: 8px; text-align: left; border: 1px solid #000345; color: #000345; }
.event-log-table td { padding: 10px 8px; border: 1px solid #e5e7eb; vertical-align: top; }
.event-log-table .time-col { width: 50px; font-family: monospace; }
.event-log-table .user-col { width: 80px; }
.event-log-table .category-col { width: 90px; }
.event-category-badge { display: inline-block; padding: 1px 5px; border-radius: 3px; font-size: 7px; font-weight: 600; }
.event-category-badge.medical { background: #fef2f2; color: #dc2626; }
.event-category-badge.afp { background: #eff6ff; color: #2563eb; }
.event-category-badge.injury { background: #fefce8; color: #ca8a04; }
.event-category-badge.escalation { background: #fdf4ff; color: #a855f7; }
.event-category-badge.general { background: #f0fdf4; color: #16a34a; }
.event-category-badge.other { background: #f8fafc; color: #64748b; }
.pdf-category-summary { font-size: 9px; padding: 6px 10px; background: #f8fafc; border: 1px solid #e5e7eb; border-radius: 3px; margin-bottom: 6px; }
.intl-section-title { background: #000345; border-left: 4px solid #FA5115; }
.intl-type-badge { background: #FA5115; color: white; padding: 1px 5px; border-radius: 3px; font-size: 7px; font-weight: 600; margin-right: 4px; }
.dom-type-badge { background: #000345; color: white; padding: 1px 5px; border-radius: 3px; font-size: 7px; font-weight: 600; margin-right: 4px; }
.page-footer { margin-top: 10px; padding-top: 6px; border-top: 2px solid #000345; clear: both; text-align: center; font-size: 8px; color: #6b7280; }
.footer-brand { color: #000345; font-weight: 600; }
.footer-accent { color: #FA5115; }
</style></head><body>
<div class="report-container">
    <div class="report-header">
        <div class="header-logo"> <span class="accent">JETSTAR</span> Summary Report</div>
        <div class="header-title"><h1>TAM Handover Notes</h1><p>${dateStr} | Generated ${timeStr}</p></div>
    </div>
    
    ${handoverHTML}
    
    ${generatePerformanceStaffingHTML()}
    
    <div class="section">
        <div class="section-title"> SUMMARY STATISTICS</div>
        <div class="stats-grid">
            ${generateDynamicStatsHTML(data, editedContent, intlCancelCount)}
        </div>
    </div>
    
    ${leadershipHTML}
    
    ${busynessHTML}
    
    ${cancelledHTML ? `<div class="section"><div class="section-title red"> CANCELLED FLIGHTS</div>${cancelledHTML}</div>` : ''}
    ${extendedHTML ? `<div class="section"><div class="section-title"> EXTENDED CHECK-INS</div>${extendedHTML}</div>` : ''}
    ${commentsHTML ? `<div class="section"><div class="section-title"> SHIFT COMMENTS & NOTES</div>${commentsHTML}</div>` : ''}
    ${securityHTML ? `<div class="section" style="page-break-before:always;"><div class="section-title"> ACCESS ALERTS</div>${securityHTML}</div>` : ''}
    
    ${eventLogHTML}
    
    ${intlEventLogHTML}
    
    <div class="page-footer">
        <span class="footer-brand"> JETSTAR</span> <span class="footer-accent">Summary Report</span> | 
        Generated ${data.generatedAt.toLocaleString('en-AU')} 
    </div>
</div>
</body></html>`;
}

function generatePDFBusynessGraphsNew(busynessData) {
    if (!busynessData || !busynessData.entries || busynessData.entries.length === 0) {
        return '<div class="section"><div class="section-title"> BUSYNESS TIMELINE</div><div class="no-data">No busyness data logged.</div></div>';
    }
    
    const levelColors = {'quiet':'#22c55e','moderate':'#eab308','busy':'#f97316','very-busy':'#ef4444','chaos':'#1f2937'};
    const levelLabels = {'quiet':'Quiet','moderate':'Moderate','busy':'Busy','very-busy':'Very Busy','chaos':'Chaos'};
    const levelMag = {'quiet':2,'moderate':4,'busy':6,'very-busy':8,'chaos':10};
    const icons = {'Check-In Area':'','Zone E':'','ABDs':'','Service Desk':''};
    
    const locationData = {};
    BUSYNESS_LOCATIONS.forEach(loc => { locationData[loc] = busynessData.entries.filter(e => e.location === loc); });
    
    const today = busynessData.entries[0] ? new Date(busynessData.entries[0].timestamp) : new Date();
    const startTime = new Date(today); startTime.setHours(4,0,0,0);
    
    const chartW = 500, chartH = 70;
    const pad = {top:8,bottom:20,left:8,right:8};
    const gH = chartH - pad.top - pad.bottom;
    const gW = chartW - pad.left - pad.right;
    
    let html = '<div class="section"><div class="section-title"> BUSYNESS TIMELINE GRAPHS</div>';
    
    BUSYNESS_LOCATIONS.forEach(location => {
        const entries = locationData[location];
        const isZoneE = location === 'Zone E';
        const endTime = new Date(today);
        endTime.setHours(isZoneE ? 13 : 22, isZoneE ? 0 : 30, 0, 0);
        const totalDur = endTime.getTime() - startTime.getTime();
        
        if (!entries || entries.length === 0) {
            html += `<div class="busyness-graph-container"><div class="busyness-graph-header"><span class="busyness-graph-title">${icons[location]||''} ${location}</span></div><div class="no-data">No data logged</div></div>`;
            return;
        }
        
        const sorted = [...entries].sort((a,b) => a.timestamp - b.timestamp);
        const barW = Math.max(6, Math.min(15, gW / (sorted.length * 2)));
        
        let bars = '';
        sorted.forEach(e => {
            const x = pad.left + ((e.timestamp - startTime.getTime()) / totalDur) * gW;
            const mag = levelMag[e.level] || 2;
            const bH = (mag / 10) * gH;
            const y = pad.top + gH - bH;
            bars += `<rect x="${x-barW/2}" y="${y}" width="${barW}" height="${bH}" fill="${levelColors[e.level]||'#9ca3af'}" rx="2"/>`;
        });
        
        let ticks = '', labels = '';
        const endH = isZoneE ? 13 : 22;
        for (let h = 4; h <= endH; h += 3) {
            const lt = new Date(today); lt.setHours(h,0,0,0);
            const lx = pad.left + ((lt.getTime() - startTime.getTime()) / totalDur) * gW;
            labels += `<text x="${lx}" y="${chartH-4}" style="font-size:7px;fill:#6b7280;text-anchor:middle;">${h.toString().padStart(2,'0')}:00</text>`;
            ticks += `<line x1="${lx}" y1="${pad.top+gH}" x2="${lx}" y2="${pad.top+gH+3}" stroke="#9ca3af" stroke-width="0.5"/>`;
        }
        
        const last = sorted[sorted.length-1];
        const lastLabel = levelLabels[last.level] || last.level;
        const lastColor = levelColors[last.level] || '#9ca3af';
        
        const aiSummary = generateAISummaryForLocation(location, sorted, isZoneE);
        
        html += `<div class="busyness-graph-container">
            <div class="busyness-graph-header">
                <span class="busyness-graph-title">${icons[location]||''} ${location}</span>
                <span class="busyness-graph-status" style="background:${lastColor}20;color:${lastColor};">Last: ${lastLabel}</span>
            </div>
            <svg width="100%" height="${chartH}" viewBox="0 0 ${chartW} ${chartH}" style="display:block;max-width:100%;">
                <line x1="${pad.left}" y1="${pad.top+gH}" x2="${chartW-pad.right}" y2="${pad.top+gH}" stroke="#d1d5db" stroke-width="1"/>
                ${ticks}${bars}${labels}
            </svg>
            <div style="display:flex;justify-content:space-between;font-size:7px;color:#6b7280;margin-top:2px;">
                <span>04:00</span><span>${sorted.length} entries</span><span>${isZoneE?'13:00':'22:30'}</span>
            </div>
            <div class="busyness-ai-summary">${aiSummary}</div>
        </div>`;
    });
    
    html += `<div class="busyness-legend">
        <span class="legend-item"><span class="legend-dot" style="background:#22c55e;"></span>Quiet</span>
        <span class="legend-item"><span class="legend-dot" style="background:#eab308;"></span>Moderate</span>
        <span class="legend-item"><span class="legend-dot" style="background:#f97316;"></span>Busy</span>
        <span class="legend-item"><span class="legend-dot" style="background:#ef4444;"></span>V.Busy</span>
        <span class="legend-item"><span class="legend-dot" style="background:#1f2937;"></span>Chaos</span>
    </div></div>`;
    
    return html;
}

function gatherReportData() {
    const now = new Date();
    const reportDate = flightDate || now;
    
    // Flight statistics - use effectiveStatus to properly count closed flights
    const totalFlights = flights.length;
    const cancelledFlights = flights.filter(f => f.manualStatus === 'cancelled');
    const extendedFlights = flights.filter(f => f.manualStatus === 'extended' || f.extensionDuration);
    
    // Count closed flights properly - check both manualStatus AND time-based status
    const closedFlights = flights.filter(f => {
        if (f.manualStatus === 'cancelled') return false;
        if (f.manualStatus === 'extended') return false;
        if (f.manualStatus === 'closed') return true;
        
        // Check time-based status for flights that naturally closed
        const time = calculateTimeRemaining(f);
        const effectiveStatus = f.manualStatus || time.status;
        return effectiveStatus === 'closed';
    });
    
    // Open flights - neither cancelled, extended, nor closed
    const openFlights = flights.filter(f => {
        if (f.manualStatus === 'cancelled') return false;
        if (f.manualStatus === 'extended') return false;
        if (f.manualStatus === 'closed') return false;
        
        const time = calculateTimeRemaining(f);
        const effectiveStatus = f.manualStatus || time.status;
        return effectiveStatus !== 'closed';
    });
    
    // Delayed flights
    const delayedFlights = flights.filter(f => f.isDelayed);
    
    // Domestic flights only (no international for this report)
    const domesticFlights = flights.filter(f => !INTERNATIONAL_DESTINATIONS.includes(f.destination));
    
    // Get security alerts from memory (collected during session)
    const securityAlerts = window.securityAlertsLog || [];
    
    // Get leadership roster
    const leadershipRoster = getLeadershipRosterForReport();
    
    // Get busyness data
    const busynessData = getBusynessDataForReport();
    
    return {
        reportDate: reportDate,
        generatedAt: now,
        totalFlights: totalFlights,
        cancelledFlights: cancelledFlights,
        extendedFlights: extendedFlights,
        closedFlights: closedFlights,
        openFlights: openFlights,
        delayedFlights: delayedFlights,
        domesticFlights: domesticFlights,
        comments: comments,
        zoneEComments: zoneEComments,
        securityAlerts: securityAlerts,
        leadershipRoster: leadershipRoster,
        busynessData: busynessData
    };
}

function generateReportHTML(data) {
    const dateStr = data.reportDate.toLocaleDateString('en-AU', {
        weekday: 'long',
        year: 'numeric',
        month: 'long',
        day: 'numeric'
    });
    
    const timeStr = data.generatedAt.toLocaleTimeString('en-AU', {
        hour: '2-digit',
        minute: '2-digit',
        hour12: false
    });
    
    // Generate narrative summary paragraph
    const narrativeSummary = generateNarrativeSummary(data);
    
    // Generate cancellation details with context
    const cancellationSection = generateCancellationSection(data.cancelledFlights);
    
    // Generate extended flights section
    const extendedSection = generateExtendedSection(data.extendedFlights);
    
    // Generate comments section with context
    const commentsSection = generateCommentsSection(data.comments, data.zoneEComments);
    
    // Generate Zone E activity section
    const zoneESection = generateZoneEActivitySection();
    
    // Generate security alerts section
    const securitySection = generateSecuritySection(data.securityAlerts);
    
    // Generate busyness section
    const busynessSection = generateBusynessSection(data.busynessData);
    
    return `
<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Shift Summary Report - ${dateStr}</title>
    <style>
        @page { size: A4; margin: 15mm; }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Arial, sans-serif; font-size: 11px; line-height: 1.5; color: #1f2937; background: white; }
        .report-container { max-width: 210mm; margin: 0 auto; padding: 10mm; }
        .report-header { display: flex; justify-content: space-between; align-items: flex-start; border-bottom: 3px solid #000345; padding-bottom: 12px; margin-bottom: 15px; }
        .logo { font-size: 20px; font-weight: bold; color: #000345; }
        .logo span { color: #FA5115; }
        .report-title { text-align: right; }
        .report-title h1 { font-size: 18px; color: #000345; margin-bottom: 3px; }
        .report-title p { color: #6b7280; font-size: 10px; }
        .section { margin-bottom: 18px; page-break-inside: avoid; }
        .section-title { background: #000345; color: white; padding: 8px 12px; font-size: 12px; font-weight: bold; margin-bottom: 10px; }
        .section-title.orange { background: #FA5115; }
        .section-title.red { background: #dc2626; }
        .section-title.purple { background: #7c3aed; }
        .section-title.green { background: #059669; }
        .narrative { background: #f8fafc; border-left: 4px solid #000345; padding: 12px 15px; margin-bottom: 15px; font-size: 11px; line-height: 1.6; }
        .narrative p { margin-bottom: 8px; }
        .narrative p:last-child { margin-bottom: 0; }
        .stats-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 8px; margin-bottom: 15px; }
        .stat-box { border: 1px solid #e5e7eb; padding: 10px; text-align: center; background: #f9fafb; min-width: 120px; }
        .stat-number { font-size: 24px; font-weight: bold; color: #000345; }
        .stat-number.orange { color: #FA5115; }
        .stat-number.red { color: #dc2626; }
        .stat-number.green { color: #059669; }
        .stat-number.blue { color: #3b82f6; }
        .stat-label { font-size: 9px; color: #6b7280; text-transform: uppercase; margin-top: 2px; }
        table { width: 100%; border-collapse: collapse; font-size: 10px; margin-bottom: 10px; }
        th { background: #f3f4f6; padding: 8px; text-align: left; border: 1px solid #e5e7eb; font-weight: bold; }
        td { padding: 8px; border: 1px solid #e5e7eb; }
        .comment-box { background: #f8fafc; border-left: 3px solid #3b82f6; padding: 8px 12px; margin-bottom: 8px; }
        .comment-box.zone-e { border-left-color: #FA5115; background: #fff7ed; }
        .comment-time { font-size: 9px; color: #6b7280; margin-bottom: 3px; font-weight: 600; }
        .comment-text { font-size: 10px; }
        .alert-box { background: #fef2f2; border: 1px solid #fecaca; padding: 10px; margin-bottom: 8px; display: flex; align-items: flex-start; gap: 10px; }
        .alert-icon { font-size: 14px; }
        .alert-text { flex: 1; font-size: 10px; }
        .alert-text strong { color: #dc2626; }
        .context-paragraph { font-size: 10px; color: #4b5563; margin-bottom: 10px; font-style: italic; }
        .report-footer { margin-top: 20px; padding-top: 12px; border-top: 2px solid #e5e7eb; text-align: center; color: #6b7280; font-size: 9px; }
        .no-data { color: #9ca3af; font-style: italic; padding: 10px; text-align: center; }
        @media print { body { -webkit-print-color-adjust: exact; print-color-adjust: exact; } .section { page-break-inside: avoid; } }
    </style>
</head>
<body>
    <div class="report-container">
        <div class="report-header">
            <div class="logo"> <span>JETSTAR</span> Flight Tracker</div>
            <div class="report-title">
                <h1>Shift Summary Report</h1>
                <p>${dateStr}</p>
                <p>Generated at ${timeStr}</p>
            </div>
        </div>
        
        <div class="section">
            <div class="section-title"> EXECUTIVE SUMMARY</div>
            <div class="narrative">${narrativeSummary}</div>
        </div>
        
        <div class="section">
            <div class="section-title"> STATISTICS</div>
            <div class="stats-grid">
                <div class="stat-box"><div class="stat-number">${data.totalFlights}</div><div class="stat-label">Total Flights</div></div>
                <div class="stat-box"><div class="stat-number green">${data.closedFlights.length}</div><div class="stat-label">Completed</div></div>
                <div class="stat-box"><div class="stat-number orange">${data.extendedFlights.length}</div><div class="stat-label">Extended</div></div>
                <div class="stat-box"><div class="stat-number red">${data.cancelledFlights.length + intlCancelCount}</div><div class="stat-label">Cancelled</div></div>
            </div>
            <div class="stats-grid">
                <div class="stat-box"><div class="stat-number orange">${data.delayedFlights.length}</div><div class="stat-label">Delayed</div></div>
                <div class="stat-box"><div class="stat-number green">${data.openFlights.length}</div><div class="stat-label">Still Open</div></div>
            </div>
        </div>
        
        ${data.leadershipRoster && data.leadershipRoster.length > 0 ? `
        <div class="section">
            <div class="section-title" style="background: #000345;"> LEADERSHIP TEAM ON SHIFT</div>
            <table>
                <tr>
                    <th>Position</th>
                    <th>Name</th>
                </tr>
                ${data.leadershipRoster.map(leader => `
                    <tr>
                        <td>${leader.position}</td>
                        <td style="font-weight: 600; color: #000345;">${leader.name}</td>
                    </tr>
                `).join('')}
            </table>
        </div>
        ` : ''}
        
        ${cancellationSection}
        ${extendedSection}
        ${zoneESection}
        ${commentsSection}
        ${securitySection}
        ${busynessSection}
        
        <div class="report-footer">
            <p>This report was automatically generated by Jetstar Summary Report</p>
            <p>Report generated on ${data.generatedAt.toLocaleString('en-AU')} </p>
        </div>
    </div>
</body>
</html>`;
}

function generateNarrativeSummary(data) {
    let paragraphs = [];
    
    const completionRate = data.totalFlights > 0 ? Math.round(((data.closedFlights.length) / data.totalFlights) * 100) : 0;
    
    paragraphs.push('<p>This shift summary covers domestic flight operations for ' + data.reportDate.toLocaleDateString('en-AU', { weekday: 'long', day: 'numeric', month: 'long', year: 'numeric' }) + '. A total of <strong>' + data.totalFlights + ' flights</strong> were scheduled during this period.</p>');
    
    if (data.cancelledFlights.length === 0 && data.totalFlights > 0) {
        paragraphs.push('<p><strong>Operational Performance:</strong> The shift ran smoothly with no flight cancellations. ' + data.closedFlights.length + ' flights completed check-in successfully, achieving a ' + completionRate + '% completion rate.</p>');
    } else if (data.cancelledFlights.length > 0) {
        const cancellationReasons = [...new Set(data.cancelledFlights.map(f => f.cancelReason || 'Unspecified'))];
        paragraphs.push('<p><strong>Operational Performance:</strong> ' + data.cancelledFlights.length + ' flight' + (data.cancelledFlights.length > 1 ? 's were' : ' was') + ' cancelled during this shift. Primary cancellation reason' + (cancellationReasons.length > 1 ? 's include' : ' was') + ': ' + cancellationReasons.join(', ') + '. The remaining ' + data.closedFlights.length + ' flights completed check-in successfully.</p>');
    }
    
    if (data.extendedFlights.length > 0) {
        paragraphs.push('<p><strong>Check-in Extensions:</strong> ' + data.extendedFlights.length + ' flight' + (data.extendedFlights.length > 1 ? 's' : '') + ' required check-in extensions beyond the standard 40-minute close time. This may indicate late passenger arrivals, connection issues, or operational delays that required accommodation.</p>');
    }
    
    if (data.delayedFlights.length > 0) {
        paragraphs.push('<p><strong>Flight Delays:</strong> ' + data.delayedFlights.length + ' flight' + (data.delayedFlights.length > 1 ? 's experienced' : ' experienced') + ' departure delays during this shift. Check-in procedures were adjusted accordingly to accommodate the revised schedules.</p>');
    }
    
    const totalComments = data.comments.length + data.zoneEComments.length;
    if (totalComments > 0) {
        paragraphs.push('<p><strong>Shift Notes:</strong> ' + totalComments + ' comment' + (totalComments > 1 ? 's were' : ' was') + ' logged during this shift (' + data.comments.length + ' general, ' + data.zoneEComments.length + ' Zone E specific). Please review the detailed comments section below for important updates and observations from staff.</p>');
    }
    
    // Add busyness summary if available
    if (data.busynessData && data.busynessData.entries && data.busynessData.entries.length > 0) {
        paragraphs.push('<p><strong>Busyness Tracking:</strong> ' + data.busynessData.summary + '</p>');
    }
    
    return paragraphs.join('');
}

function generateCancellationSection(cancelledFlights) {
    if (cancelledFlights.length === 0) {
        return '<div class="section"><div class="section-title red"> CANCELLED FLIGHTS</div><div class="no-data">No flights were cancelled during this shift - excellent operational performance!</div></div>';
    }
    
    let tableRows = cancelledFlights.map(function(flight) {
        const cancelTime = flight.cancelledAt ? new Date(flight.cancelledAt).toLocaleTimeString('en-AU', { hour: '2-digit', minute: '2-digit', hour12: false }) : 'N/A';
        return '<tr><td><strong>' + flight.flightNumber + '</strong></td><td>' + flight.destination + '</td><td>' + flight.departureTime + '</td><td>' + (flight.cancelReason || 'Not specified') + '</td><td>' + (flight.approverName || 'N/A') + (flight.approverPosition ? ' (' + flight.approverPosition + ')' : '') + '</td><td>' + cancelTime + '</td></tr>';
    }).join('');
    
    return '<div class="section"><div class="section-title red"> CANCELLED FLIGHTS</div><p class="context-paragraph">The following flights were cancelled during this shift. Each cancellation was processed through the approval workflow and documented with the reason and authorising staff member.</p><table><thead><tr><th>Flight</th><th>Destination</th><th>Scheduled</th><th>Reason</th><th>Actioned By</th><th>Time</th></tr></thead><tbody>' + tableRows + '</tbody></table></div>';
}

function generateExtendedSection(extendedFlights) {
    if (extendedFlights.length === 0) {
        return '<div class="section"><div class="section-title"> EXTENDED CHECK-INS</div><div class="no-data">No flights required check-in extensions during this shift.</div></div>';
    }
    
    let tableRows = extendedFlights.map(function(flight) {
        const extensionMins = flight.extensionDuration || 'Active';
        return '<tr><td><strong>' + flight.flightNumber + '</strong></td><td>' + flight.destination + '</td><td>' + flight.departureTime + '</td><td>' + extensionMins + (typeof extensionMins === 'number' ? ' mins' : '') + '</td></tr>';
    }).join('');
    
    return '<div class="section"><div class="section-title"> EXTENDED CHECK-INS</div><p class="context-paragraph">The following flights had their check-in period extended beyond the standard 40-minute closure window. Extensions are typically granted for late-arriving passengers, delayed connections, or operational requirements.</p><table><thead><tr><th>Flight</th><th>Destination</th><th>Departure</th><th>Extension</th></tr></thead><tbody>' + tableRows + '</tbody></table></div>';
}

function generateZoneEActivitySection() {
    if (zoneEComments.length === 0) {
        return '<div class="section"><div class="section-title"> ZONE E ACTIVITY</div><div class="no-data">No Zone E specific activity was logged during this shift.</div></div>';
    }
    
    let content = '<p class="context-paragraph">Zone E operations were active during this shift. The following updates and notes were logged by staff stationed at Zone E, providing a record of activities and any issues encountered.</p>';
    
    zoneEComments.forEach(function(comment) {
        const time = new Date(comment.timestamp).toLocaleString('en-AU', { hour: '2-digit', minute: '2-digit', hour12: false, day: 'numeric', month: 'short' });
        content += '<div class="comment-box zone-e"><div class="comment-time">' + time + ' - Zone E Update</div><div class="comment-text">' + comment.text + '</div></div>';
    });
    
    return '<div class="section"><div class="section-title"> ZONE E ACTIVITY</div>' + content + '</div>';
}

function generateCommentsSection(generalComments, zoneECommentsList) {
    const totalComments = generalComments.length + zoneECommentsList.length;
    
    if (totalComments === 0) {
        return '<div class="section"><div class="section-title"> SHIFT COMMENTS & NOTES</div><div class="no-data">No comments were logged during this shift.</div></div>';
    }
    
    const allComments = generalComments.map(function(c) { return Object.assign({}, c, { type: 'general' }); })
        .concat(zoneECommentsList.map(function(c) { return Object.assign({}, c, { type: 'zone-e' }); }))
        .sort(function(a, b) { return b.timestamp - a.timestamp; });
    
    let commentsHTML = allComments.map(function(comment) {
        const time = new Date(comment.timestamp).toLocaleString('en-AU', { hour: '2-digit', minute: '2-digit', hour12: false, day: 'numeric', month: 'short' });
        const typeLabel = comment.type === 'zone-e' ? 'Zone E' : 'General';
        const boxClass = comment.type === 'zone-e' ? 'comment-box zone-e' : 'comment-box';
        return '<div class="' + boxClass + '"><div class="comment-time">' + time + ' - ' + typeLabel + '</div><div class="comment-text">' + comment.text + '</div></div>';
    }).join('');
    
    return '<div class="section"><div class="section-title"> SHIFT COMMENTS & NOTES</div><p class="context-paragraph">The following comments were logged by staff during this shift. These notes provide important context about operational issues, passenger situations, equipment status, and other relevant information for shift handover.</p>' + commentsHTML + '</div>';
}

function generateSecuritySection(securityAlerts) {
    if (!securityAlerts || securityAlerts.length === 0) {
        return '<div class="section"><div class="section-title"> ACCESS ALERTS</div><div class="no-data">No security alerts were recorded during this shift - all login attempts were successful.</div></div>';
    }
    
    let alertsHTML = securityAlerts.map(function(alert) {
        const time = new Date(alert.timestamp).toLocaleTimeString('en-AU', { hour: '2-digit', minute: '2-digit', hour12: false });
        return '<div class="alert-box"><span class="alert-icon"></span><div class="alert-text"><strong>' + (alert.type === 'incorrect_pin' ? 'Incorrect PIN Attempt' : 'Security Alert') + '</strong> - ' + time + '<br>' + (alert.details || 'Details not available') + '</div></div>';
    }).join('');
    
    return '<div class="section"><div class="section-title"> ACCESS ALERTS</div><p class="context-paragraph">The following security-related events were logged during this shift. These may include failed login attempts, unusual access patterns, or other security concerns that should be reviewed.</p>' + alertsHTML + '</div>';
}

function generateBusynessSection(busynessData) {
    if (!busynessData || !busynessData.entries || busynessData.entries.length === 0) {
        return '<div class="section"><div class="section-title" style="background: #000345;"> BUSYNESS TRACKING</div><div class="no-data">No busyness data was logged during this shift.</div></div>';
    }
    
    // Color mapping for levels
    const levelColors = {
        'quiet': '#22c55e',
        'moderate': '#eab308',
        'busy': '#f97316',
        'very-busy': '#ef4444',
        'chaos': '#1f2937'
    };
    
    const levelLabels = {
        'quiet': 'Quiet',
        'moderate': 'Moderate',
        'busy': 'Busy',
        'very-busy': 'Very Busy',
        'chaos': 'Chaos'
    };
    
    const levelMagnitude = {
        'quiet': 2,
        'moderate': 4,
        'busy': 6,
        'very-busy': 8,
        'chaos': 10
    };
    
    const locationIcons = {
        'Check-In Area': '',
        'Zone E': '',
        'ABDs': '',
        
        'Service Desk': ''
    };
    
    // Group entries by location
    const locationData = {};
    BUSYNESS_LOCATIONS.forEach(function(loc) {
        locationData[loc] = busynessData.entries.filter(function(e) { return e.location === loc; });
    });
    
    // Fixed time range: 04:00 to 22:30
    const today = busynessData.entries[0] ? new Date(busynessData.entries[0].timestamp) : new Date();
    const startTime = new Date(today);
    startTime.setHours(4, 0, 0, 0);
    const endTime = new Date(today);
    endTime.setHours(22, 30, 0, 0);
    const totalDuration = endTime.getTime() - startTime.getTime();
    
    // Chart dimensions for PDF
    const chartWidth = 280;
    const chartHeight = 70;
    const padding = { top: 8, bottom: 18, left: 8, right: 8 };
    const graphHeight = chartHeight - padding.top - padding.bottom;
    const graphWidth = chartWidth - padding.left - padding.right;
    
    // Generate INDIVIDUAL BAR GRAPHS for each location (2 per row)
    let chartsHtml = '<div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px; margin-top: 12px;">';
    
    BUSYNESS_LOCATIONS.forEach(function(location) {
        const entries = locationData[location];
        const shortName = location
            .replace('Check-In Area', 'Check-In')
            
            .replace('Service Desk', 'Svc Desk');
        const icon = locationIcons[location] || '';
        
        if (entries.length === 0) {
            chartsHtml += '<div style="background: #f8fafc; border: 1px solid #e5e7eb; border-radius: 8px; padding: 10px;">' +
                '<div style="font-weight: bold; color: #000345; font-size: 10px; margin-bottom: 6px;">' + icon + ' ' + shortName + '</div>' +
                '<div style="text-align: center; color: #9ca3af; font-size: 8px; padding: 15px 0;">No data logged</div>' +
            '</div>';
            return;
        }
        
        // Sort entries by timestamp
        const sortedEntries = entries.slice().sort(function(a, b) { return a.timestamp - b.timestamp; });
        
        // Calculate bar width
        const barWidth = Math.max(4, Math.min(12, graphWidth / (sortedEntries.length * 2)));
        
        // Build bars
        var barsHtml = '';
        sortedEntries.forEach(function(entry) {
            var x = padding.left + ((entry.timestamp - startTime.getTime()) / totalDuration) * graphWidth;
            var magnitude = levelMagnitude[entry.level] || 2;
            var barHeight = (magnitude / 10) * graphHeight;
            var y = padding.top + graphHeight - barHeight;
            var color = levelColors[entry.level] || '#9ca3af';
            
            barsHtml += '<rect x="' + (x - barWidth/2) + '" y="' + y + '" width="' + barWidth + '" height="' + barHeight + '" fill="' + color + '" rx="1"/>';
        });
        
        // Build smooth line connecting bars
        var linePath = '';
        if (sortedEntries.length > 1) {
            var linePoints = [];
            sortedEntries.forEach(function(entry) {
                var x = padding.left + ((entry.timestamp - startTime.getTime()) / totalDuration) * graphWidth;
                var magnitude = levelMagnitude[entry.level] || 2;
                var y = padding.top + graphHeight - (magnitude / 10) * graphHeight;
                linePoints.push({ x: x, y: y });
            });
            
            linePath = 'M ' + linePoints[0].x + ' ' + linePoints[0].y;
            for (var i = 0; i < linePoints.length - 1; i++) {
                var p0 = linePoints[Math.max(0, i - 1)];
                var p1 = linePoints[i];
                var p2 = linePoints[i + 1];
                var p3 = linePoints[Math.min(linePoints.length - 1, i + 2)];
                
                var cp1x = p1.x + (p2.x - p0.x) / 6;
                var cp1y = p1.y + (p2.y - p0.y) / 6;
                var cp2x = p2.x - (p3.x - p1.x) / 6;
                var cp2y = p2.y - (p3.y - p1.y) / 6;
                
                linePath += ' C ' + cp1x + ' ' + cp1y + ', ' + cp2x + ' ' + cp2y + ', ' + p2.x + ' ' + p2.y;
            }
        }
        
        // Build X-axis time labels
        var timeLabels = '';
        var tickMarks = '';
        [4, 8, 12, 16, 20].forEach(function(hour) {
            var labelTime = new Date(today);
            labelTime.setHours(hour, 0, 0, 0);
            var labelX = padding.left + ((labelTime.getTime() - startTime.getTime()) / totalDuration) * graphWidth;
            timeLabels += '<text x="' + labelX + '" y="' + (chartHeight - 3) + '" style="font-size: 6px; fill: #6b7280; text-anchor: middle; font-weight: 500;">' + (hour < 10 ? '0' : '') + hour + ':00</text>';
            tickMarks += '<line x1="' + labelX + '" y1="' + (padding.top + graphHeight) + '" x2="' + labelX + '" y2="' + (padding.top + graphHeight + 3) + '" stroke="#9ca3af" stroke-width="0.5"/>';
        });
        
        // Get last status
        var lastEntryData = sortedEntries[sortedEntries.length - 1];
        var currentStatus = levelLabels[lastEntryData.level] || lastEntryData.level;
        var statusColor = levelColors[lastEntryData.level] || '#9ca3af';
        
        chartsHtml += '<div style="background: #f8fafc; border: 1px solid #e5e7eb; border-radius: 8px; padding: 10px;">' +
            '<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 6px;">' +
                '<div style="font-weight: bold; color: #000345; font-size: 10px;">' + icon + ' ' + shortName + '</div>' +
                '<div style="font-size: 7px; padding: 2px 6px; border-radius: 10px; background: ' + statusColor + '20; color: ' + statusColor + '; font-weight: 600;">Last: ' + currentStatus + '</div>' +
            '</div>' +
            '<svg width="100%" height="' + chartHeight + '" viewBox="0 0 ' + chartWidth + ' ' + chartHeight + '" preserveAspectRatio="xMidYMid meet" style="display: block; overflow: visible;">' +
                '<line x1="' + padding.left + '" y1="' + (padding.top + graphHeight) + '" x2="' + (chartWidth - padding.right) + '" y2="' + (padding.top + graphHeight) + '" stroke="#d1d5db" stroke-width="1"/>' +
                tickMarks +
                barsHtml +
                (linePath ? '<path d="' + linePath + '" fill="none" stroke="rgba(0,3,69,0.4)" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" stroke-dasharray="3 2"/>' : '') +
                timeLabels +
            '</svg>' +
            '<div style="display: flex; justify-content: space-between; font-size: 7px; color: #6b7280; margin-top: 2px;">' +
                '<span>04:00</span>' +
                '<span style="color: #9ca3af; background: #f3f4f6; padding: 1px 4px; border-radius: 6px;">' + sortedEntries.length + ' entries</span>' +
                '<span>22:30</span>' +
            '</div>' +
        '</div>';
    });
    
    chartsHtml += '</div>';
    
    // Add legend
    let legendHtml = '<div style="display: flex; gap: 10px; justify-content: center; margin-top: 12px; flex-wrap: wrap; padding: 8px; background: #f8fafc; border-radius: 6px; border: 1px solid #e5e7eb;">';
    ['quiet', 'moderate', 'busy', 'very-busy', 'chaos'].forEach(function(level) {
        legendHtml += '<div style="display: flex; align-items: center; gap: 4px; font-size: 8px;">' +
            '<div style="width: 12px; height: 12px; background: ' + levelColors[level] + '; border-radius: 3px;"></div>' +
            '<span style="color: #374151;">' + levelLabels[level] + '</span>' +
        '</div>';
    });
    legendHtml += '</div>';
    
    return '<div class="section"><div class="section-title" style="background: #000345;"> BUSYNESS TRACKING</div><p class="context-paragraph">' + busynessData.summary + '</p>' + chartsHtml + legendHtml + '</div>';
}

function printReport(htmlContent) {
    // Create a modal overlay for the report (better for iPad - has close button)
    const overlay = document.createElement('div');
    overlay.id = 'pdf-report-overlay';
    overlay.style.cssText = 'position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0, 0, 0, 0.9); z-index: 10005; display: flex; flex-direction: column; padding: 10px;';
    
    // Close button - prominent for iPad
    const closeBtn = document.createElement('button');
    closeBtn.innerHTML = ' Close & Return';
    closeBtn.style.cssText = 'position: absolute; top: 15px; right: 15px; background: #dc2626; color: white; border: none; padding: 14px 28px; border-radius: 10px; font-weight: bold; cursor: pointer; font-size: 1.1rem; z-index: 10006; box-shadow: 0 4px 15px rgba(220, 38, 38, 0.5);';
    closeBtn.onclick = function() { overlay.remove(); };
    
    // Print button
    const printBtn = document.createElement('button');
    printBtn.innerHTML = ' Print / Save PDF';
    printBtn.style.cssText = 'position: absolute; top: 15px; left: 15px; background: #000345; color: white; border: none; padding: 14px 28px; border-radius: 10px; font-weight: bold; cursor: pointer; font-size: 1.1rem; z-index: 10006; box-shadow: 0 4px 15px rgba(0, 3, 69, 0.5);';
    printBtn.onclick = function() { iframe.contentWindow.print(); };

    
    // Check if device is iPad - show Share PDF button only on iPad
    const isIPad = /iPad/.test(navigator.userAgent) || 
                   (navigator.platform === 'MacIntel' && navigator.maxTouchPoints > 1);
    
    // Share PDF button (iPad only)
    let shareBtn = null;
    if (isIPad) {
        shareBtn = document.createElement('button');
        shareBtn.innerHTML = ' Share PDF';
        shareBtn.style.cssText = 'position: absolute; top: 15px; left: 220px; background: #059669; color: white; border: none; padding: 14px 28px; border-radius: 10px; font-weight: bold; cursor: pointer; font-size: 1.1rem; z-index: 10006; box-shadow: 0 4px 15px rgba(5, 150, 105, 0.5);';
        shareBtn.onclick = async function() {
            // Show loading state
            shareBtn.innerHTML = ' Generating...';
            shareBtn.disabled = true;
            
            try {
                // Generate filename with date
                const today = new Date();
                const dateStr = today.getDate().toString().padStart(2,'0') + '-' + 
                               (today.getMonth()+1).toString().padStart(2,'0') + '-' + 
                               today.getFullYear();
                const filename = 'TAM_Handover_Notes_' + dateStr + '.pdf';
                
                // Get the iframe content
                const iframeDoc = iframe.contentDocument || iframe.contentWindow.document;
                const reportContent = iframeDoc.body;
                
                // Generate PDF using html2pdf
                const opt = {
                    margin: [10, 10, 15, 10],
                    filename: filename,
                    image: { type: 'jpeg', quality: 0.98 },
                    html2canvas: { scale: 2, useCORS: true, logging: false },
                    jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' }
                };
                
                // Generate PDF blob
                const pdfBlob = await html2pdf().set(opt).from(reportContent).outputPdf('blob');
                
                // Create file for sharing
                const pdfFile = new File([pdfBlob], filename, { type: 'application/pdf' });
                
                // Check if Web Share API is available and can share files
                if (navigator.canShare && navigator.canShare({ files: [pdfFile] })) {
                    await navigator.share({
                        files: [pdfFile],
                        title: 'TAM Handover Notes',
                        text: 'TAM Handover Notes for ' + dateStr
                    });
                    console.log(' PDF shared successfully');
                } else {
                    // Fallback: download the file
                    const url = URL.createObjectURL(pdfBlob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = filename;
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    URL.revokeObjectURL(url);
                    console.log(' PDF downloaded (Share not available)');
                }
            } catch (error) {
                console.error('Error generating/sharing PDF:', error);
                alert('Error generating PDF. Please try the Print button instead.');
            } finally {
                // Reset button state
                shareBtn.innerHTML = ' Share PDF';
                shareBtn.disabled = false;
            }
        };
    }
    
        
    // Iframe for the report
    const iframe = document.createElement('iframe');
    iframe.style.cssText = 'flex: 1; width: 100%; border: none; border-radius: 10px; margin-top: 70px; background: white;';
    
    overlay.appendChild(closeBtn);
    overlay.appendChild(printBtn);
    if (shareBtn) overlay.appendChild(shareBtn);
    overlay.appendChild(iframe);
    document.body.appendChild(overlay);
    
    // Write content to iframe
    iframe.onload = function() {
        iframe.contentDocument.write(htmlContent);
        iframe.contentDocument.close();
    };
    iframe.src = 'about:blank';
    
    console.log(' Summary report generated with close button');
}

console.log(' Summary Report system initialized');

    </script>

<!-- Floating Busyness Tracker Button (Outside container so it's always visible) -->
<button class="busyness-float-btn" id="busyness-float-btn" onclick="openBusynessPanel()" title="Track Busyness" style="display: none;">
    
</button>


</div><div class="status-dropdown" style="display: none;"><div class="status-option">Automatic (Based on Time)</div><div class="status-option"> Check-in Open</div><div class="status-option"> Closing Soon</div><div class="status-option"> Urgent Closing</div><div class="status-option"> Extend Check-In</div><div class="status-option"> Closed</div><div class="status-option"> Cancelled</div></div><div class="status-dropdown" style="display: none;"><div class="status-option">Automatic (Based on Time)</div><div class="status-option"> Check-in Open</div><div class="status-option"> Closing Soon</div><div class="status-option"> Urgent Closing</div><div class="status-option"> Extend Check-In</div><div class="status-option"> Closed</div><div class="status-option"> Cancelled</div></div><div class="status-dropdown" style="display: none;"><div class="status-option">Automatic (Based on Time)</div><div class="status-option"> Check-in Open</div><div class="status-option"> Closing Soon</div><div class="status-option"> Urgent Closing</div><div class="status-option"> Extend Check-In</div><div class="status-option"> Closed</div><div class="status-option"> Cancelled</div></div><div class="status-dropdown" style="display: none;"><div class="status-option">Automatic (Based on Time)</div><div class="status-option"> Check-in Open</div><div class="status-option"> Closing Soon</div><div class="status-option"> Urgent Closing</div><div class="status-option"> Extend Check-In</div><div class="status-option"> Closed</div><div class="status-option"> Cancelled</div></div><div class="status-dropdown" style="display: none;"><div class="status-option">Automatic (Based on Time)</div><div class="status-option"> Check-in Open</div><div class="status-option"> Closing Soon</div><div class="status-option"> Urgent Closing</div><div class="status-option"> Extend Check-In</div><div class="status-option"> Closed</div><div class="status-option"> Cancelled</div></div><div class="status-dropdown" style="display: none;"><div class="status-option">Automatic (Based on Time)</div><div class="status-option"> Check-in Open</div><div class="status-option"> Closing Soon</div><div class="status-option"> Urgent Closing</div><div class="status-option"> Extend Check-In</div><div class="status-option"> Closed</div><div class="status-option"> Cancelled</div></div><div class="status-dropdown" style="display: none;"><div class="status-option">Automatic (Based on Time)</div><div class="status-option"> Check-in Open</div><div class="status-option"> Closing Soon</div><div class="status-option"> Urgent Closing</div><div class="status-option"> Extend Check-In</div><div class="status-option"> Closed</div><div class="status-option"> Cancelled</div></div><div class="status-dropdown" style="display: none;"><div class="status-option">Automatic (Based on Time)</div><div class="status-option"> Check-in Open</div><div class="status-option"> Closing Soon</div><div class="status-option"> Urgent Closing</div><div class="status-option"> Extend Check-In</div><div class="status-option"> Closed</div><div class="status-option"> Cancelled</div></div><div class="status-dropdown" style="display: none;"><div class="status-option">Automatic (Based on Time)</div><div class="status-option"> Check-in Open</div><div class="status-option"> Closing Soon</div><div class="status-option"> Urgent Closing</div><div class="status-option"> Extend Check-In</div><div class="status-option"> Closed</div><div class="status-option"> Cancelled</div></div><div class="status-dropdown" style="display: none;"><div class="status-option">Automatic (Based on Time)</div><div class="status-option"> Check-in Open</div><div class="status-option"> Closing Soon</div><div class="status-option"> Urgent Closing</div><div class="status-option"> Extend Check-In</div><div class="status-option"> Closed</div><div class="status-option"> Cancelled</div></div><div class="status-dropdown" style="display: none;"><div class="status-option">Automatic (Based on Time)</div><div class="status-option"> Check-in Open</div><div class="status-option"> Closing Soon</div><div class="status-option"> Urgent Closing</div><div class="status-option"> Extend Check-In</div><div class="status-option"> Closed</div><div class="status-option"> Cancelled</div></div><div class="status-dropdown" style="display: none;"><div class="status-option">Automatic (Based on Time)</div><div class="status-option"> Check-in Open</div><div class="status-option"> Closing Soon</div><div class="status-option"> Urgent Closing</div><div class="status-option"> Extend Check-In</div><div class="status-option"> Closed</div><div class="status-option"> Cancelled</div></div><div class="status-dropdown" style="display: none;"><div class="status-option">Automatic (Based on Time)</div><div class="status-option"> Check-in Open</div><div class="status-option"> Closing Soon</div><div class="status-option"> Urgent Closing</div><div class="status-option"> Extend Check-In</div><div class="status-option"> Closed</div><div class="status-option"> Cancelled</div></div><div class="status-dropdown" style="display: none;"><div class="status-option">Automatic (Based on Time)</div><div class="status-option"> Check-in Open</div><div class="status-option"> Closing Soon</div><div class="status-option"> Urgent Closing</div><div class="status-option"> Extend Check-In</div><div class="status-option"> Closed</div><div class="status-option"> Cancelled</div></div><div class="status-dropdown" style="display: none;"><div class="status-option">Automatic (Based on Time)</div><div class="status-option"> Check-in Open</div><div class="status-option"> Closing Soon</div><div class="status-option"> Urgent Closing</div><div class="status-option"> Extend Check-In</div><div class="status-option"> Closed</div><div class="status-option"> Cancelled</div></div><div class="status-dropdown" style="display: none;"><div class="status-option">Automatic (Based on Time)</div><div class="status-option"> Check-in Open</div><div class="status-option"> Closing Soon</div><div class="status-option"> Urgent Closing</div><div class="status-option"> Extend Check-In</div><div class="status-option"> Closed</div><div class="status-option"> Cancelled</div></div><div class="status-dropdown" style="display: none;"><div class="status-option">Automatic (Based on Time)</div><div class="status-option"> Check-in Open</div><div class="status-option"> Closing Soon</div><div class="status-option"> Urgent Closing</div><div class="status-option"> Extend Check-In</div><div class="status-option"> Closed</div><div class="status-option"> Cancelled</div></div><div class="status-dropdown" style="display: none;"><div class="status-option">Automatic (Based on Time)</div><div class="status-option"> Check-in Open</div><div class="status-option"> Closing Soon</div><div class="status-option"> Urgent Closing</div><div class="status-option"> Extend Check-In</div><div class="status-option"> Closed</div><div class="status-option"> Cancelled</div></div><div class="status-dropdown" style="display: none;"><div class="status-option">Automatic (Based on Time)</div><div class="status-option"> Check-in Open</div><div class="status-option"> Closing Soon</div><div class="status-option"> Urgent Closing</div><div class="status-option"> Extend Check-In</div><div class="status-option"> Closed</div><div class="status-option"> Cancelled</div></div><div class="status-dropdown" style="display: none;"><div class="status-option">Automatic (Based on Time)</div><div class="status-option"> Check-in Open</div><div class="status-option"> Closing Soon</div><div class="status-option"> Urgent Closing</div><div class="status-option"> Extend Check-In</div><div class="status-option"> Closed</div><div class="status-option"> Cancelled</div></div><div class="status-dropdown" style="display: none;"><div class="status-option">Automatic (Based on Time)</div><div class="status-option"> Check-in Open</div><div class="status-option"> Closing Soon</div><div class="status-option"> Urgent Closing</div><div class="status-option"> Extend Check-In</div><div class="status-option"> Closed</div><div class="status-option"> Cancelled</div></div><div class="status-dropdown" style="display: none;"><div class="status-option">Automatic (Based on Time)</div><div class="status-option"> Check-in Open</div><div class="status-option"> Closing Soon</div><div class="status-option"> Urgent Closing</div><div class="status-option"> Extend Check-In</div><div class="status-option"> Closed</div><div class="status-option"> Cancelled</div></div><div class="status-dropdown" style="display: none;"><div class="status-option">Automatic (Based on Time)</div><div class="status-option"> Check-in Open</div><div class="status-option"> Closing Soon</div><div class="status-option"> Urgent Closing</div><div class="status-option"> Extend Check-In</div><div class="status-option"> Closed</div><div class="status-option"> Cancelled</div></div><div class="status-dropdown" style="display: none;"><div class="status-option">Automatic (Based on Time)</div><div class="status-option"> Check-in Open</div><div class="status-option"> Closing Soon</div><div class="status-option"> Urgent Closing</div><div class="status-option"> Extend Check-In</div><div class="status-option"> Closed</div><div class="status-option"> Cancelled</div></div><div class="status-dropdown" style="display: none;"><div class="status-option">Automatic (Based on Time)</div><div class="status-option"> Check-in Open</div><div class="status-option"> Closing Soon</div><div class="status-option"> Urgent Closing</div><div class="status-option"> Extend Check-In</div><div class="status-option"> Closed</div><div class="status-option"> Cancelled</div></div><div class="status-dropdown" style="display: none;"><div class="status-option">Automatic (Based on Time)</div><div class="status-option"> Check-in Open</div><div class="status-option"> Closing Soon</div><div class="status-option"> Urgent Closing</div><div class="status-option"> Extend Check-In</div><div class="status-option"> Closed</div><div class="status-option"> Cancelled</div></div><div class="status-dropdown" style="display: none;"><div class="status-option">Automatic (Based on Time)</div><div class="status-option"> Check-in Open</div><div class="status-option"> Closing Soon</div><div class="status-option"> Urgent Closing</div><div class="status-option"> Extend Check-In</div><div class="status-option"> Closed</div><div class="status-option"> Cancelled</div></div><div class="status-dropdown" style="display: none;"><div class="status-option">Automatic (Based on Time)</div><div class="status-option"> Check-in Open</div><div class="status-option"> Closing Soon</div><div class="status-option"> Urgent Closing</div><div class="status-option"> Extend Check-In</div><div class="status-option"> Closed</div><div class="status-option"> Cancelled</div></div><div class="status-dropdown" style="display: none;"><div class="status-option">Automatic (Based on Time)</div><div class="status-option"> Check-in Open</div><div class="status-option"> Closing Soon</div><div class="status-option"> Urgent Closing</div><div class="status-option"> Extend Check-In</div><div class="status-option"> Closed</div><div class="status-option"> Cancelled</div></div><div class="status-dropdown" style="display: none;"><div class="status-option">Automatic (Based on Time)</div><div class="status-option"> Check-in Open</div><div class="status-option"> Closing Soon</div><div class="status-option"> Urgent Closing</div><div class="status-option"> Extend Check-In</div><div class="status-option"> Closed</div><div class="status-option"> Cancelled</div></div><div class="status-dropdown" style="display: none;"><div class="status-option">Automatic (Based on Time)</div><div class="status-option"> Check-in Open</div><div class="status-option"> Closing Soon</div><div class="status-option"> Urgent Closing</div><div class="status-option"> Extend Check-In</div><div class="status-option"> Closed</div><div class="status-option"> Cancelled</div></div><div class="status-dropdown" style="display: none;"><div class="status-option">Automatic (Based on Time)</div><div class="status-option"> Check-in Open</div><div class="status-option"> Closing Soon</div><div class="status-option"> Urgent Closing</div><div class="status-option"> Extend Check-In</div><div class="status-option"> Closed</div><div class="status-option"> Cancelled</div></div><div class="status-dropdown" style="display: none;"><div class="status-option">Automatic (Based on Time)</div><div class="status-option"> Check-in Open</div><div class="status-option"> Closing Soon</div><div class="status-option"> Urgent Closing</div><div class="status-option"> Extend Check-In</div><div class="status-option"> Closed</div><div class="status-option"> Cancelled</div></div><div class="status-dropdown" style="display: none;"><div class="status-option">Automatic (Based on Time)</div><div class="status-option"> Check-in Open</div><div class="status-option"> Closing Soon</div><div class="status-option"> Urgent Closing</div><div class="status-option"> Extend Check-In</div><div class="status-option"> Closed</div><div class="status-option"> Cancelled</div></div><div class="status-dropdown" style="display: none;"><div class="status-option">Automatic (Based on Time)</div><div class="status-option"> Check-in Open</div><div class="status-option"> Closing Soon</div><div class="status-option"> Urgent Closing</div><div class="status-option"> Extend Check-In</div><div class="status-option"> Closed</div><div class="status-option"> Cancelled</div></div><div class="status-dropdown" style="display: none;"><div class="status-option">Automatic (Based on Time)</div><div class="status-option"> Check-in Open</div><div class="status-option"> Closing Soon</div><div class="status-option"> Urgent Closing</div><div class="status-option"> Extend Check-In</div><div class="status-option"> Closed</div><div class="status-option"> Cancelled</div></div><div class="status-dropdown" style="display: none;"><div class="status-option">Automatic (Based on Time)</div><div class="status-option"> Check-in Open</div><div class="status-option"> Closing Soon</div><div class="status-option"> Urgent Closing</div><div class="status-option"> Extend Check-In</div><div class="status-option"> Closed</div><div class="status-option"> Cancelled</div></div><div class="status-dropdown" style="display: none;"><div class="status-option">Automatic (Based on Time)</div><div class="status-option"> Check-in Open</div><div class="status-option"> Closing Soon</div><div class="status-option"> Urgent Closing</div><div class="status-option"> Extend Check-In</div><div class="status-option"> Closed</div><div class="status-option"> Cancelled</div></div><div class="status-dropdown" style="display: none;"><div class="status-option">Automatic (Based on Time)</div><div class="status-option"> Check-in Open</div><div class="status-option"> Closing Soon</div><div class="status-option"> Urgent Closing</div><div class="status-option"> Extend Check-In</div><div class="status-option"> Closed</div><div class="status-option"> Cancelled</div></div><div class="status-dropdown" style="display: none;"><div class="status-option">Automatic (Based on Time)</div><div class="status-option"> Check-in Open</div><div class="status-option"> Closing Soon</div><div class="status-option"> Urgent Closing</div><div class="status-option"> Extend Check-In</div><div class="status-option"> Closed</div><div class="status-option"> Cancelled</div></div><div class="status-dropdown" style="display: none;"><div class="status-option">Automatic (Based on Time)</div><div class="status-option"> Check-in Open</div><div class="status-option"> Closing Soon</div><div class="status-option"> Urgent Closing</div><div class="status-option"> Extend Check-In</div><div class="status-option"> Closed</div><div class="status-option"> Cancelled</div></div><div class="status-dropdown" style="display: none;"><div class="status-option">Automatic (Based on Time)</div><div class="status-option"> Check-in Open</div><div class="status-option"> Closing Soon</div><div class="status-option"> Urgent Closing</div><div class="status-option"> Extend Check-In</div><div class="status-option"> Closed</div><div class="status-option"> Cancelled</div></div><div class="status-dropdown" style="display: none;"><div class="status-option">Automatic (Based on Time)</div><div class="status-option"> Check-in Open</div><div class="status-option"> Closing Soon</div><div class="status-option"> Urgent Closing</div><div class="status-option"> Extend Check-In</div><div class="status-option"> Closed</div><div class="status-option"> Cancelled</div></div><div class="status-dropdown" style="display: none;"><div class="status-option">Automatic (Based on Time)</div><div class="status-option"> Check-in Open</div><div class="status-option"> Closing Soon</div><div class="status-option"> Urgent Closing</div><div class="status-option"> Extend Check-In</div><div class="status-option"> Closed</div><div class="status-option"> Cancelled</div></div><div class="status-dropdown" style="display: none;"><div class="status-option">Automatic (Based on Time)</div><div class="status-option"> Check-in Open</div><div class="status-option"> Closing Soon</div><div class="status-option"> Urgent Closing</div><div class="status-option"> Extend Check-In</div><div class="status-option"> Closed</div><div class="status-option"> Cancelled</div></div><div class="status-dropdown" style="display: none;"><div class="status-option">Automatic (Based on Time)</div><div class="status-option"> Check-in Open</div><div class="status-option"> Closing Soon</div><div class="status-option"> Urgent Closing</div><div class="status-option"> Extend Check-In</div><div class="status-option"> Closed</div><div class="status-option"> Cancelled</div></div><div class="status-dropdown" style="display: none;"><div class="status-option">Automatic (Based on Time)</div><div class="status-option"> Check-in Open</div><div class="status-option"> Closing Soon</div><div class="status-option"> Urgent Closing</div><div class="status-option"> Extend Check-In</div><div class="status-option"> Closed</div><div class="status-option"> Cancelled</div></div><div class="status-dropdown" style="display: none;"><div class="status-option">Automatic (Based on Time)</div><div class="status-option"> Check-in Open</div><div class="status-option"> Closing Soon</div><div class="status-option"> Urgent Closing</div><div class="status-option"> Extend Check-In</div><div class="status-option"> Closed</div><div class="status-option"> Cancelled</div></div><div class="status-dropdown" style="display: none;"><div class="status-option">Automatic (Based on Time)</div><div class="status-option"> Check-in Open</div><div class="status-option"> Closing Soon</div><div class="status-option"> Urgent Closing</div><div class="status-option"> Extend Check-In</div><div class="status-option"> Closed</div><div class="status-option"> Cancelled</div></div><div class="status-dropdown" style="display: none;"><div class="status-option">Automatic (Based on Time)</div><div class="status-option"> Check-in Open</div><div class="status-option"> Closing Soon</div><div class="status-option"> Urgent Closing</div><div class="status-option"> Extend Check-In</div><div class="status-option"> Closed</div><div class="status-option"> Cancelled</div></div><div class="status-dropdown" style="display: none;"><div class="status-option">Automatic (Based on Time)</div><div class="status-option"> Check-in Open</div><div class="status-option"> Closing Soon</div><div class="status-option"> Urgent Closing</div><div class="status-option"> Extend Check-In</div><div class="status-option"> Closed</div><div class="status-option"> Cancelled</div></div><div class="status-dropdown" style="display: none;"><div class="status-option">Automatic (Based on Time)</div><div class="status-option"> Check-in Open</div><div class="status-option"> Closing Soon</div><div class="status-option"> Urgent Closing</div><div class="status-option"> Extend Check-In</div><div class="status-option"> Closed</div><div class="status-option"> Cancelled</div></div><div class="status-dropdown" style="display: none;"><div class="status-option">Automatic (Based on Time)</div><div class="status-option"> Check-in Open</div><div class="status-option"> Closing Soon</div><div class="status-option"> Urgent Closing</div><div class="status-option"> Extend Check-In</div><div class="status-option"> Closed</div><div class="status-option"> Cancelled</div></div><div class="status-dropdown" style="display: none;"><div class="status-option">Automatic (Based on Time)</div><div class="status-option"> Check-in Open</div><div class="status-option"> Closing Soon</div><div class="status-option"> Urgent Closing</div><div class="status-option"> Extend Check-In</div><div class="status-option"> Closed</div><div class="status-option"> Cancelled</div></div><div class="status-dropdown" style="display: none;"><div class="status-option">Automatic (Based on Time)</div><div class="status-option"> Check-in Open</div><div class="status-option"> Closing Soon</div><div class="status-option"> Urgent Closing</div><div class="status-option"> Extend Check-In</div><div class="status-option"> Closed</div><div class="status-option"> Cancelled</div></div><div class="status-dropdown" style="display: none;"><div class="status-option">Automatic (Based on Time)</div><div class="status-option"> Check-in Open</div><div class="status-option"> Closing Soon</div><div class="status-option"> Urgent Closing</div><div class="status-option"> Extend Check-In</div><div class="status-option"> Closed</div><div class="status-option"> Cancelled</div></div><div class="status-dropdown" style="display: none;"><div class="status-option">Automatic (Based on Time)</div><div class="status-option"> Check-in Open</div><div class="status-option"> Closing Soon</div><div class="status-option"> Urgent Closing</div><div class="status-option"> Extend Check-In</div><div class="status-option"> Closed</div><div class="status-option"> Cancelled</div></div></body></html>